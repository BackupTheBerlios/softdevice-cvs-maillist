<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Softdevice-cvs] softdevice CHANGELOG, 1.345, 1.346 mpeg2decoder.c,	1.86, 1.87 mpeg2decoder.h, 1.45, 1.46 setup-softdevice-menu.c,	1.15, 1.16 setup-softdevice.c, 1.56, 1.57 setup-softdevice.h,	1.46, 1.47 softdevice.c, 1.93, 1.94 video.c, 1.77,	1.78 video.h, 1.56, 1.57
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/softdevice-cvs/2009q1/index.html" >
   <LINK REL="made" HREF="mailto:softdevice-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSoftdevice-cvs%5D%20softdevice%20CHANGELOG%2C%201.345%2C%201.346%20mpeg2decoder.c%2C%0A%091.86%2C%201.87%20mpeg2decoder.h%2C%201.45%2C%201.46%20setup-softdevice-menu.c%2C%0A%091.15%2C%201.16%20setup-softdevice.c%2C%201.56%2C%201.57%20setup-softdevice.h%2C%0A%091.46%2C%201.47%20softdevice.c%2C%201.93%2C%201.94%20video.c%2C%201.77%2C%0A%091.78%20video.h%2C%201.56%2C%201.57&In-Reply-To=%3C20090219202800.DA79D135BBB%40mail.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000641.html">
   <LINK REL="Next"  HREF="000643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Softdevice-cvs] softdevice CHANGELOG, 1.345, 1.346 mpeg2decoder.c,	1.86, 1.87 mpeg2decoder.h, 1.45, 1.46 setup-softdevice-menu.c,	1.15, 1.16 setup-softdevice.c, 1.56, 1.57 setup-softdevice.h,	1.46, 1.47 softdevice.c, 1.93, 1.94 video.c, 1.77,	1.78 video.h, 1.56, 1.57</H1>
    <B>lucke</B> 
    <A HREF="mailto:softdevice-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSoftdevice-cvs%5D%20softdevice%20CHANGELOG%2C%201.345%2C%201.346%20mpeg2decoder.c%2C%0A%091.86%2C%201.87%20mpeg2decoder.h%2C%201.45%2C%201.46%20setup-softdevice-menu.c%2C%0A%091.15%2C%201.16%20setup-softdevice.c%2C%201.56%2C%201.57%20setup-softdevice.h%2C%0A%091.46%2C%201.47%20softdevice.c%2C%201.93%2C%201.94%20video.c%2C%201.77%2C%0A%091.78%20video.h%2C%201.56%2C%201.57&In-Reply-To=%3C20090219202800.DA79D135BBB%40mail.berlios.de%3E"
       TITLE="[Softdevice-cvs] softdevice CHANGELOG, 1.345, 1.346 mpeg2decoder.c,	1.86, 1.87 mpeg2decoder.h, 1.45, 1.46 setup-softdevice-menu.c,	1.15, 1.16 setup-softdevice.c, 1.56, 1.57 setup-softdevice.h,	1.46, 1.47 softdevice.c, 1.93, 1.94 video.c, 1.77,	1.78 video.h, 1.56, 1.57">nobody at sheep.berlios.de
       </A><BR>
    <I>Thu Feb 19 21:28:00 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000641.html">[Softdevice-cvs] softdevice CHANGELOG, 1.344, 1.345 mpeg2decoder.c,	1.85, 1.86
</A></li>
        <LI>Next message: <A HREF="000643.html">[Softdevice-cvs] softdevice utils.c,1.27,1.28 utils.h,1.18,1.19
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#642">[ date ]</a>
              <a href="thread.html#642">[ thread ]</a>
              <a href="subject.html#642">[ subject ]</a>
              <a href="author.html#642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20858

Modified Files:
	CHANGELOG mpeg2decoder.c mpeg2decoder.h 
	setup-softdevice-menu.c setup-softdevice.c setup-softdevice.h 
	softdevice.c video.c video.h 
Log Message:
- decoding: Enable selection between av_read_packet() and av_read_frame() via
            OSD. To take effect, vdr has to be restarted.
- still picture: Dependant on frame type (interlaced vs. progressive) show only
                 one half frame. This avoids still picture judder.
                 For demo an optional marker could be drawn when active.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.345
retrieving revision 1.346
diff -C2 -d -r1.345 -r1.346
*** CHANGELOG	18 Feb 2009 19:40:46 -0000	1.345
--- CHANGELOG	19 Feb 2009 20:27:58 -0000	1.346
***************
*** 1,3 ****
--- 1,9 ----
  Changelog
+ 2009-02-19:
+    - decoding: Enable selection between av_read_packet() and av_read_frame() via
+                OSD. To take effect, vdr has to be restarted.
+    - still picture: Dependant on frame type (interlaced vs. progressive) show only
+                     one half frame. This avoids still picture judder.
+                     For demo an optional marker could be drawn when active.
  2009-02-18:
     - build: Fix compiling with newer ffmpeg versions (r15634,r15799) (bug #14990).

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.86
retrieving revision 1.87
diff -C2 -d -r1.86 -r1.87
*** mpeg2decoder.c	18 Feb 2009 19:40:46 -0000	1.86
--- mpeg2decoder.c	19 Feb 2009 20:27:58 -0000	1.87
***************
*** 1063,1066 ****
--- 1063,1068 ----
    Speed=1;
    pb = NULL;
+ 
+   useAVReadFrame = setupStore-&gt;useAVReadFrame;
  }
  
***************
*** 1194,1206 ****
  
          BUFDEB(&quot;av_read_frame start\n&quot;);
!         ret = av_read_frame(ic, &amp;pkt);
!         //ret = av_read_packet(ic, &amp;pkt);
          if (ret &lt; 0) {
              BUFDEB(&quot;cMpeg2Decoder Stream Error!\n&quot;);
              if (ThreadActive)
! 		    usleep(10000);
              continue;
          }
!         av_dup_packet(&amp;pkt);
          PacketCount++;
          BUFDEB(&quot;got packet from av_read_frame!\n&quot;);
--- 1196,1214 ----
  
          BUFDEB(&quot;av_read_frame start\n&quot;);
! 
!         if (useAVReadFrame)
!             ret = av_read_frame(ic, &amp;pkt);
!         else
!             ret = av_read_packet(ic, &amp;pkt);
! 
          if (ret &lt; 0) {
              BUFDEB(&quot;cMpeg2Decoder Stream Error!\n&quot;);
              if (ThreadActive)
!                    usleep(10000);
              continue;
          }
!         if (useAVReadFrame)
!             av_dup_packet(&amp;pkt);
! 
          PacketCount++;
          BUFDEB(&quot;got packet from av_read_frame!\n&quot;);
***************
*** 1431,1434 ****
--- 1439,1443 ----
    CMDDEB(&quot;Play\n&quot;);
    freezeMode=false;
+   videoOut-&gt;SetStillPictureMode (Speed != 1);
    if (running)
    {
***************
*** 1451,1454 ****
--- 1460,1464 ----
    curPlayMode=playMode;
    this-&gt;packetMode=packetMode;
+   videoOut-&gt;SetStillPictureMode (false);
    switch (curPlayMode) {
      case PmAudioVideo:
***************
*** 1474,1477 ****
--- 1484,1490 ----
    if (Stream &amp; SOFTDEVICE_BOTH_STREAMS == SOFTDEVICE_BOTH_STREAMS )
      freezeMode=freeze;
+   if (freeze)
+     videoOut-&gt;SetStillPictureMode (true);
+ 
    // sleep a short while before putting the
    // audio and video stream decoders to sleep
***************
*** 1556,1563 ****
  /* ----------------------------------------------------------------------------
   */
- 
  static uint8_t pes_packet_header[] = {
       0x00,0x00,0x01, 0xe0,           0x00,0x00,   0x84, 0x00, 0x00,0x00};
       // startcode,  video-stream 0, packet length,      no pts
  int cMpeg2Decoder::StillPicture(uchar *Data, int Length)
  {
--- 1569,1578 ----
  /* ----------------------------------------------------------------------------
   */
  static uint8_t pes_packet_header[] = {
       0x00,0x00,0x01, 0xe0,           0x00,0x00,   0x84, 0x00, 0x00,0x00};
       // startcode,  video-stream 0, packet length,      no pts
+ 
+ /* ----------------------------------------------------------------------------
+  */
  int cMpeg2Decoder::StillPicture(uchar *Data, int Length)
  {
***************
*** 1582,1585 ****
--- 1597,1601 ----
    };
  
+   videoOut-&gt;SetStillPictureMode (true);
    for (int i=0; 4&gt;i;i++) {
      if (!has_pesheader) {

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** mpeg2decoder.h	25 Oct 2008 10:23:49 -0000	1.45
--- mpeg2decoder.h	19 Feb 2009 20:27:58 -0000	1.46
***************
*** 285,288 ****
--- 285,289 ----
      AVFormatContext *ic;
      ByteIOContext   *pb;
+     bool            useAVReadFrame;
      int LastSize;
      cMutex  mutex;

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** setup-softdevice-menu.c	20 Jul 2008 16:41:01 -0000	1.15
--- setup-softdevice-menu.c	19 Feb 2009 20:27:58 -0000	1.16
***************
*** 371,374 ****
--- 371,386 ----
                              fieldOrderNames));
  
+   Add(new cMenuEditStraItem(tr(&quot;Still Picture Field&quot;),
+                             (int *) &amp;data-&gt;prefField,
+                             (SETUP_PREF_FIELD_NAMES-1),
+                             prefFieldNames));
+ 
+   Add(new cMenuEditBoolItem(tr(&quot;Still Picture Field Marker&quot;),
+                             (int *) &amp;data-&gt;prefFieldMarker, tr(&quot;no&quot;), tr(&quot;yes&quot;)));
+ 
+   Add(new cMenuEditBoolItem(tr(&quot;Use av_read_frame()&quot;),
+                             (int *) &amp;data-&gt;useAVReadFrame, tr(&quot;no&quot;), tr(&quot;yes&quot;)));
+ 
+ 
  #if VDRVERSNUM &gt;= 10334
    Add(new cOsdItem(&quot; &quot;, osUnknown, false));
***************
*** 490,493 ****
--- 502,508 ----
    SetupStore (&quot;syncTimerMode&quot;,        setupStore-&gt;syncTimerMode);
    SetupStore (&quot;fieldOrderMode&quot;,       setupStore-&gt;fieldOrderMode);
+   SetupStore (&quot;preferredField&quot;,       setupStore-&gt;prefField);
+   SetupStore (&quot;preferredFieldMarker&quot;, setupStore-&gt;prefFieldMarker);
+   SetupStore (&quot;useAVReadFrame&quot;,       setupStore-&gt;useAVReadFrame);
    SetupStore (&quot;vidBrightness&quot;,        setupStore-&gt;vidBrightness);
    SetupStore (&quot;vidContrast&quot;,          setupStore-&gt;vidContrast);

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** setup-softdevice.c	20 Jul 2008 16:41:01 -0000	1.56
--- setup-softdevice.c	19 Feb 2009 20:27:58 -0000	1.57
***************
*** 75,78 ****
--- 75,80 ----
  const char *fieldOrderNames[SETUP_FIELD_ORDER_NAMES];
  
+ const char *prefFieldNames[SETUP_PREF_FIELD_NAMES];
+ 
  /* ----------------------------------------------------------------------------
   */
***************
*** 117,120 ****
--- 119,125 ----
    stretchBlitLocked = false;
    fieldOrderMode    = 2;
+   prefField         = bothFields;
+   prefFieldMarker   = 0;
+   useAVReadFrame    = true;
    bufferMode      = 0;
    mainMenu  = 1;
***************
*** 210,213 ****
--- 215,223 ----
    fieldOrderNames[2] = &quot;Auto&quot;;
    fieldOrderNames[3] = NULL;
+ 
+   prefFieldNames[0] = tr(&quot;Both Fields&quot;);
+   prefFieldNames[1] = tr(&quot;First Field&quot;);
+   prefFieldNames[2] = tr(&quot;Later Field&quot;);
+   prefFieldNames[3] = NULL;
  }
  
***************
*** 382,385 ****
--- 392,408 ----
      fprintf(stderr, &quot;[setup-softdevice] fieldOrderMode: %s\n&quot;,
              fieldOrderNames[fieldOrderMode]);
+   } else if (!strcasecmp(Name, &quot;preferredField&quot;)) {
+     prefField = (tPrefField) atoi (Value);
+     prefField = (tPrefField) clamp (bothFields, prefField, laterField);
+     fprintf(stderr, &quot;[setup-softdevice] preferredField: %s\n&quot;,
+             prefFieldNames[prefField]);
+   } else if (!strcasecmp(Name, &quot;preferredFieldMarker&quot;)) {
+     prefFieldMarker = atoi (Value);
+     prefFieldMarker = clamp (0, prefFieldMarker, 1);
+     fprintf(stderr, &quot;[setup-softdevice] preferredFieldMarker: %s\n&quot;,
+             (prefFieldMarker) ? &quot;On&quot; : &quot;Off&quot;);
+   } else if (!strcasecmp(Name, &quot;useAVReadFrame&quot;)) {
+     useAVReadFrame = (bool) atoi (Value);
+     fprintf(stderr, &quot;[setup-softdevice] useAVReadFrame: %s\n&quot;, (useAVReadFrame) ? &quot;yes&quot;: &quot;no&quot;);
    } else if (!strcasecmp(Name, &quot;vidBrightness&quot;)) {
      vidBrightness = atoi (Value);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** setup-softdevice.h	10 Sep 2008 17:15:38 -0000	1.46
--- setup-softdevice.h	19 Feb 2009 20:27:58 -0000	1.47
***************
*** 106,109 ****
--- 106,112 ----
  extern const char *fieldOrderNames[SETUP_FIELD_ORDER_NAMES];
  
+ #define SETUP_PREF_FIELD_NAMES  4
+ extern const char *prefFieldNames[SETUP_PREF_FIELD_NAMES];
+ 
  /* ----------------------------------------------------------------------------
   * allow changing of output pixfmt
***************
*** 117,120 ****
--- 120,131 ----
  extern const char *suspendVideo[SETUP_SUSPENDVIDEO];
  
+ /*-----------------------------------------------------------------------------
+  */
+ typedef enum prefField {
+         bothFields,
+         earlierField,
+         laterField
+ } tPrefField;
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 150,153 ****
--- 161,165 ----
      int   mirror;
      int   syncOnFrames;
+     bool  useAVReadFrame;
      int   avOffset;
      int   screenPixelAspect;
***************
*** 183,186 ****
--- 195,201 ----
  
      int   setupStoreShmid;
+ 
+     tPrefField   prefField;
+     int          prefFieldMarker;
  };
  

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.93
retrieving revision 1.94
diff -C2 -d -r1.93 -r1.94
*** softdevice.c	18 Apr 2008 15:15:41 -0000	1.93
--- softdevice.c	19 Feb 2009 20:27:58 -0000	1.94
***************
*** 498,504 ****
  {
      SOFTDEB(&quot;Freeze...\n&quot;);
-     cDevice::Freeze();
      if (decoder)
        decoder-&gt;Freeze();
      SOFTDEB(&quot;Freeze finished.\n&quot;);
  }
--- 498,504 ----
  {
      SOFTDEB(&quot;Freeze...\n&quot;);
      if (decoder)
        decoder-&gt;Freeze();
+     cDevice::Freeze();
      SOFTDEB(&quot;Freeze finished.\n&quot;);
  }

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.77
retrieving revision 1.78
diff -C2 -d -r1.77 -r1.78
*** video.c	20 Jul 2008 16:41:01 -0000	1.77
--- video.c	19 Feb 2009 20:27:58 -0000	1.78
***************
*** 462,465 ****
--- 462,533 ----
  /* ---------------------------------------------------------------------------
   */
+ void cVideoOut::SetStillPictureMode(bool on)
+ {
+     stillPictureMode = on;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::SelectField (sPicBuffer *pic)
+ {
+         unsigned char   *dest,
+                         *src;
+         int             i;
+ 
+     if (!pic-&gt;interlaced_frame)
+         return;
+     if (setupStore-&gt;prefField == bothFields)
+         return;
+ 
+     dest = src  = pic-&gt;pixel[0]
+                   + (pic-&gt;edge_height) * pic-&gt;stride[0]
+                   + pic-&gt;edge_width;
+ 
+     if (setupStore-&gt;prefField == earlierField) {
+ 
+         if (pic-&gt;top_field_first)
+             dest += pic-&gt;stride[0];
+         else
+             src  += pic-&gt;stride[0];
+ 
+     } else {
+ 
+         if (pic-&gt;top_field_first)
+             src  += pic-&gt;stride[0];
+         else
+             dest += pic-&gt;stride[0];
+     }
+ 
+     if (setupStore-&gt;prefFieldMarker) {
+             int     offset;
+ 
+         offset = pic-&gt;stride[0] / 4
+                  + pic-&gt;stride[0] / 4 * pic-&gt;stride[0];
+         for (i = 0; i &lt; pic-&gt;height / 32; i += 2) {
+ #if 0
+             // invert Y
+             for (int j = 0; j &lt; pic-&gt;stride[0] / 32; j++) {
+               dest [offset + j] = 255 - dest [offset + j];
+               src  [offset + j] = 255 - src  [offset + j];
+             }
+ #else
+             // set frame to very dark
+             memset (dest + offset, 0, pic-&gt;stride[0] / 32);
+             memset (src + offset, 0, pic-&gt;stride[0] / 32);
+ #endif
+             offset += 2 * pic-&gt;stride[0];
+         }
+     }
+ 
+     for (i = 0; i &lt; pic-&gt;height; i += 2) {
+         // copy part
+         memcpy (dest, src, pic-&gt;stride[0]);
+         dest += 2 * pic-&gt;stride[0];
+         src  += 2 * pic-&gt;stride[0];
+     }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cVideoOut::DrawVideo_420pl(cSyncTimer *syncTimer,
                                  sPicBuffer *pic)
***************
*** 473,476 ****
--- 541,548 ----
    }
  
+   if (stillPictureMode) {
+     SelectField (pic);
+   }
+ 
    sPicBuffer *scale_pic=NULL;
    if (scaleVid != 0) {
***************
*** 555,559 ****
  
    softlog-&gt;Log(SOFT_LOG_TRACE, 0,
!                   &quot;[VideoOut] A/V (%d - %d) off = %d avoff = %d\n&quot;,
                    aPTS, pts, offset, offsetAverage);
  
--- 627,631 ----
  
    softlog-&gt;Log(SOFT_LOG_TRACE, 0,
!                   &quot;[VideoOut] A/V (%lld - %lld) off = %d avoff = %d\n&quot;,
                    aPTS, pts, offset, offsetAverage);
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** video.h	20 Jul 2008 16:41:01 -0000	1.56
--- video.h	19 Feb 2009 20:27:58 -0000	1.57
***************
*** 67,70 ****
--- 67,71 ----
      sPicBuffer  *oldPicture;
      cMutex      oldPictureMutex;
+     bool        stillPictureMode;
      void        SetOldPicture(sPicBuffer *pic);
  
***************
*** 193,196 ****
--- 194,199 ----
      };
  
+     virtual void SetStillPictureMode (bool on);
+     virtual void SelectField (sPicBuffer *pic);
  
      virtual void Action(void);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000641.html">[Softdevice-cvs] softdevice CHANGELOG, 1.344, 1.345 mpeg2decoder.c,	1.85, 1.86
</A></li>
	<LI>Next message: <A HREF="000643.html">[Softdevice-cvs] softdevice utils.c,1.27,1.28 utils.h,1.18,1.19
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#642">[ date ]</a>
              <a href="thread.html#642">[ thread ]</a>
              <a href="subject.html#642">[ subject ]</a>
              <a href="author.html#642">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/softdevice-cvs">More information about the Softdevice-cvs
mailing list</a><br>
</body></html>
