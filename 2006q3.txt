From nobody at sheep.berlios.de  Mon Jul 10 19:47:03 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 10 Jul 2006 19:47:03 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.204,1.205 utils.c,1.16,1.17 utils.h,1.10,1.11
Message-ID: <200607101747.k6AHl3Y17961@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22765

Modified Files:
	CHANGELOG utils.c utils.h 
Log Message:
- change the parameters of yv12_to_yuy2_il_mmx() so that it can also be used
  for not interlaced pictures


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.204
retrieving revision 1.205
diff -C2 -d -r1.204 -r1.205
*** CHANGELOG	25 Jun 2006 13:46:12 -0000	1.204
--- CHANGELOG	10 Jul 2006 17:46:59 -0000	1.205
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-07-10:
+    - change the parameters of yv12_to_yuy2_il_mmx() so that it can also be used
+      for not interlaced pictures
  2006-06-25:
     - video pixelformat and stretchblit mode can be locked by output driver, so

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** utils.c	17 Jun 2006 20:42:58 -0000	1.16
--- utils.c	10 Jul 2006 17:46:59 -0000	1.17
***************
*** 104,119 ****
   * lang: MMX2
   */
! static inline void
! yv12_to_yuy2_il_mmx2_line (uint8_t *dest,
!                            const int destStride2,
!                            const int lumaStride2, const int chromaWidth,
!                            const uint8_t *yc, const uint8_t *uc, const uint8_t *vc)
  {
      int i;
  
!   for(i = 0; i < chromaWidth/4; i++)
    {
!     movq_m2r(*(yc              ), mm1);     // mm1 = y7 y6 y5 y4 y3 y2 y1 y0
!     movq_m2r(*(yc + lumaStride2), mm2);     // mm2 = y7 y6 y5 y4 y3 y2 y1 y0
      movq_r2r(mm1,mm5);                      // mm5 = y7 y6 y5 y4 y3 y2 y1 y0
      movd_m2r(*uc, mm3);                     // mm3 = 00 00 00 00 u3 u2 u1 u0
--- 104,119 ----
   * lang: MMX2
   */
! void
! yv12_to_yuy2_il_mmx2_line (uint8_t *dest1, uint8_t *dest2, 
!                            const int chromaWidth,
!                            const uint8_t *yc1, const uint8_t *yc2,
!                            const uint8_t *uc, const uint8_t *vc)
  {
      int i;
  
!   for(i = chromaWidth/4; i--; )
    {
!     movq_m2r(*(yc1), mm1);     // mm1 = y7 y6 y5 y4 y3 y2 y1 y0
!     movq_m2r(*(yc2), mm2);     // mm2 = y7 y6 y5 y4 y3 y2 y1 y0
      movq_r2r(mm1,mm5);                      // mm5 = y7 y6 y5 y4 y3 y2 y1 y0
      movd_m2r(*uc, mm3);                     // mm3 = 00 00 00 00 u3 u2 u1 u0
***************
*** 123,139 ****
      punpcklbw_r2r(mm3, mm1);                // mm1 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
  
!     movntq(mm1,*(dest + 0));
      punpckhbw_r2r(mm3, mm5);                // mm5 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
      punpcklbw_r2r(mm3, mm2);                // mm2 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
!     movntq(mm5,*(dest + 8));
      punpckhbw_r2r(mm3, mm6);                // mm6 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
  
!     movntq(mm2,*(dest + destStride2    ));
!     movntq(mm6,*(dest + destStride2 + 8));
  
!     yc += 8;
      uc += 4;
      vc += 4;
!     dest += 16;
    }
  }
--- 123,141 ----
      punpcklbw_r2r(mm3, mm1);                // mm1 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
  
!     movntq(mm1,*(dest1 + 0));
      punpckhbw_r2r(mm3, mm5);                // mm5 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
      punpcklbw_r2r(mm3, mm2);                // mm2 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
!     movntq(mm5,*(dest1 + 8));
      punpckhbw_r2r(mm3, mm6);                // mm6 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
  
!     movntq(mm2,*(dest2    ));
!     movntq(mm6,*(dest2 + 8));
  
!     yc1 += 8;
!     yc2 += 8;
      uc += 4;
      vc += 4;
!     dest1 += 16;
!     dest2 += 16;
    }
  }
***************
*** 146,150 ****
                            const uint8_t *pu, const uint8_t *pv,
                            uint8_t *dst, const int width, const int height,
!                           int lumStride, int chromStride, int dstStride)
  {
    for(int y=0; y<height/4; y++)
--- 148,153 ----
                            const uint8_t *pu, const uint8_t *pv,
                            uint8_t *dst, const int width, const int height,
!                           const int lumStride, const int chromStride, 
!                           const int dstStride)
  {
    for(int y=0; y<height/4; y++)
***************
*** 155,160 ****
       */
      yv12_to_yuy2_il_mmx2_line (dst,
!                                dstStride * 2, lumStride * 2, width >> 1,
!                                py,
                                 pu, pv);
      /* -----------------------------------------------------------------------
--- 158,163 ----
       */
      yv12_to_yuy2_il_mmx2_line (dst,
!                                dst + dstStride * 2, width >> 1,
!                                py, py + lumStride *2,
                                 pu, pv);
      /* -----------------------------------------------------------------------
***************
*** 163,168 ****
       */
      yv12_to_yuy2_il_mmx2_line (dst + dstStride,
!                                dstStride * 2, lumStride * 2, width >> 1,
!                                py + lumStride,
                                 pu + chromStride, pv + chromStride);
      py  += 4*lumStride;
--- 166,171 ----
       */
      yv12_to_yuy2_il_mmx2_line (dst + dstStride,
!                                dst + dstStride * 3, width >> 1,
!                                py + lumStride, py + lumStride * 3,
                                 pu + chromStride, pv + chromStride);
      py  += 4*lumStride;

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** utils.h	17 Jun 2006 20:42:58 -0000	1.10
--- utils.h	10 Jul 2006 17:46:59 -0000	1.11
***************
*** 43,47 ****
  #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
  
! #else
  //#warning Using MMX extensions
  #define PREFETCH(x)
--- 43,47 ----
  #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
  
! #elif defined ( USE_MMX )
  //#warning Using MMX extensions
  #define PREFETCH(x)
***************
*** 49,54 ****
--- 49,65 ----
  #define SFENCE
  #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
+ 
+ #else
+ //#warning Not using MMX extensions
+ #define PREFETCH(x)
+ #define MOVNTQ   
+ #define SFENCE
+ #define EMMS     
  #endif
  
+ void yv12_to_yuy2_il_mmx2_line (uint8_t *dest1, uint8_t *dest2, 
+                            const int chromaWidth,
+                            const uint8_t *yc1, const uint8_t *yc2,
+                            const uint8_t *uc, const uint8_t *vc);
  
  void yv12_to_yuy2_il_c(const uint8_t *py,



From nobody at sheep.berlios.de  Mon Jul 10 19:56:40 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 10 Jul 2006 19:56:40 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.205,1.206 PicBuffer.c,1.5,1.6 PicBuffer.h,1.2,1.3
Message-ID: <200607101756.k6AHueY18529@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28090

Modified Files:
	CHANGELOG PicBuffer.c PicBuffer.h 
Log Message:
- add support for yuy2 pixel format to alpha blend and copy pic buf code
- change return value of AllocPicBuffer()
      


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.205
retrieving revision 1.206
diff -C2 -d -r1.205 -r1.206
*** CHANGELOG	10 Jul 2006 17:46:59 -0000	1.205
--- CHANGELOG	10 Jul 2006 17:56:29 -0000	1.206
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2006-07-10:
+    - add support for yuy2 pixel format to alpha blend and copy pic buf code
+    - change return value of AllocPicBuffer()
     - change the parameters of yv12_to_yuy2_il_mmx() so that it can also be used
       for not interlaced pictures

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** PicBuffer.c	17 Jun 2006 16:27:34 -0000	1.5
--- PicBuffer.c	10 Jul 2006 17:56:29 -0000	1.6
***************
*** 14,17 ****
--- 14,18 ----
  #include "PicBuffer.h"
  #include "utils.h"
+ #include "video.h"
  
  //#define PICDEB(out...) {printf("vout_pic[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
***************
*** 140,144 ****
  #define EDGE_WIDTH 16
  
! void cPicBufferManager::AllocPicBuffer(int buf_num,PixelFormat pix_fmt, 
                  int w, int h)  {
          PICDEB("AllocPicBuffer buf_num %d pix_fmt %d (%d,%d)\n",
--- 141,145 ----
  #define EDGE_WIDTH 16
  
! bool cPicBufferManager::AllocPicBuffer(int buf_num,PixelFormat pix_fmt, 
                  int w, int h)  {
          PICDEB("AllocPicBuffer buf_num %d pix_fmt %d (%d,%d)\n",
***************
*** 163,166 ****
--- 164,168 ----
                      printf("could not allocate memory for picture buffer!\n") ;
                      exit(-1);
+                     return false;
              };
              
***************
*** 173,176 ****
--- 175,179 ----
          PICDEB("end AllocPicBuffer buf %p buf->pixel[0] %p\n",
                          buf,buf->pixel[0]);
+         return true;
  }
  
***************
*** 257,296 ****
  // end of code based on ffmpeg
  
  
  /*------------------------------------------------------------------------*/
! void CopyPicBuf(sPicBuffer *dst, sPicBuffer *src,
                  int width, int height,
                  int cutTop, int cutBottom, 
                  int cutLeft, int cutRight) {
         
!         //cutTop+=src->edge_height/2;
!         //cutLeft+=src->edge_width/2;
!         uint8_t *dst_ptr=dst->pixel[0];
          uint8_t *src_ptr=src->pixel[0]+
                  (2*cutTop+src->edge_height)*src->stride[0]+
                  2*cutLeft+src->edge_width;
!         for (int i = height - (cutBottom+cutTop) * 2; i>=0; i--) {
!                 fast_memcpy(dst_ptr,src_ptr,
!                             width - 2 * (cutLeft + cutRight));
                  dst_ptr+=dst->stride[0];
                  src_ptr+=src->stride[0];
          };
          
!         dst_ptr=dst->pixel[1];
          src_ptr=src->pixel[1]+(cutTop+src->edge_height/2)*src->stride[1]+
                  cutLeft+src->edge_width/2;
!         for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
!                 fast_memcpy (dst_ptr,src_ptr,
!                                 width / 2 - (cutLeft + cutRight));
                  dst_ptr+=dst->stride[1];
                  src_ptr+=src->stride[1];
          };
  
!         dst_ptr=dst->pixel[2];
          src_ptr=src->pixel[2]+(cutTop+src->edge_height/2)*src->stride[2]+
                  cutLeft+src->edge_width/2;
!         for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
!                 fast_memcpy (dst_ptr,src_ptr,
!                                 width / 2 - (cutLeft + cutRight));
                  dst_ptr+=dst->stride[2];
                  src_ptr+=src->stride[2];
--- 260,370 ----
  // end of code based on ffmpeg
  
+ /*------------------------------------------------------------------------*/
+ static void CopyPicBuf_YUV420P_YUY2(sPicBuffer *dst, sPicBuffer *src,
+                 int width, int height,
+                 int cutTop, int cutBottom, 
+                 int cutLeft, int cutRight) {
+         PICDEB("CopyPicBuf_YUV420P_YUY2 width %d height %d\n",width,height);
+ 
+         dst->interlaced_frame=src->interlaced_frame;
+         uint8_t *dst_ptr=dst->pixel[0]+
+                 (2*cutTop+dst->edge_height)*dst->stride[0]+
+                 2*cutLeft+dst->edge_width;// 4*cutLeft ??
+         
+         uint8_t *py=src->pixel[0]+
+                 (2*cutTop+src->edge_height)*src->stride[0]+
+                 2*cutLeft+src->edge_width;
+  
+         uint8_t *pu=src->pixel[1]+
+                 (cutTop+src->edge_height/2)*src->stride[1]+
+                 cutLeft+src->edge_width/2;
+ 
+         uint8_t *pv=src->pixel[2]+
+                 (cutTop+src->edge_height/2)*src->stride[2]+
+                 cutLeft+src->edge_width/2;
+        
+         int dstStride=dst->stride[0];
+         int lumStride=src->stride[0];
+         int chromStride=src->stride[1];
+         
+         if (src->interlaced_frame) {
+                 for(int y=height/4; y--; ) {
+                         /* ---------------------------------------------
+                          * take chroma line x (it's from field A) for packing 
+                          * with luma lines y * 2 and y * 2 + 2
+                          */
+                         yv12_to_yuy2_il_mmx2_line (dst_ptr,
+                                         dst_ptr + dstStride * 2, width >> 1,
+                                         py, py + lumStride *2,
+                                         pu, pv);
+                         /* ----------------------------------------------
+                          * take chroma line x+1 (it's from field B) for packing 
+                          * with luma lines y * 2 + 1 and y * 2 + 3
+                          */
+                         yv12_to_yuy2_il_mmx2_line (dst_ptr + dstStride,
+                                dst_ptr + dstStride * 3, width >> 1,
+                                py + lumStride, py + lumStride * 3,
+                                pu + chromStride, pv + chromStride);
+                         
+                         py  += 4*lumStride;
+                         pu  += 2*chromStride;
+                         pv  += 2*chromStride;
+                         dst_ptr += 4*dstStride;
+                 }
+         } else {
+                 for(int y=height/2; y--; ) {
+                         yv12_to_yuy2_il_mmx2_line (dst_ptr,
+                                         dst_ptr + dstStride , width >> 1,
+                                         py, py + lumStride ,
+                                         pu, pv);
+                         py  += 2*lumStride;
+                         pu  += chromStride;
+                         pv  += chromStride;
+                         dst_ptr += 2*dstStride;
+                 }
+         }
+         SFENCE;
+         EMMS;
+ }
  
  /*------------------------------------------------------------------------*/
! static void CopyPicBuf_YUV420P(sPicBuffer *dst, sPicBuffer *src,
                  int width, int height,
                  int cutTop, int cutBottom, 
                  int cutLeft, int cutRight) {
         
!         int copy_width = width - 2 * (cutLeft + cutRight);
!         int copy_height = height - 2 *  (cutBottom + cutTop) ;
!         
!         uint8_t *dst_ptr=dst->pixel[0]+
!                 (2*cutTop+dst->edge_height)*dst->stride[0]+
!                  2*cutLeft+dst->edge_width;
          uint8_t *src_ptr=src->pixel[0]+
                  (2*cutTop+src->edge_height)*src->stride[0]+
                  2*cutLeft+src->edge_width;
!         for (int i = copy_height; i>=0; i--) {
!                 fast_memcpy(dst_ptr,src_ptr,copy_width);
                  dst_ptr+=dst->stride[0];
                  src_ptr+=src->stride[0];
          };
          
!         dst_ptr=dst->pixel[1]+(cutTop+dst->edge_height/2)*dst->stride[1]+
!                 cutLeft+dst->edge_width/2;
          src_ptr=src->pixel[1]+(cutTop+src->edge_height/2)*src->stride[1]+
                  cutLeft+src->edge_width/2;
!         copy_width=width / 2 - (cutLeft + cutRight);
!         copy_height = height /2 - (cutBottom+cutTop);
!         for (int i = copy_height; i--; ) {
!                 fast_memcpy (dst_ptr,src_ptr,copy_width);
                  dst_ptr+=dst->stride[1];
                  src_ptr+=src->stride[1];
          };
  
!         dst_ptr=dst->pixel[2]+(cutTop+dst->edge_height/2)*dst->stride[1]+
!                 cutLeft+dst->edge_width/2;
          src_ptr=src->pixel[2]+(cutTop+src->edge_height/2)*src->stride[2]+
                  cutLeft+src->edge_width/2;
!         for (int i = copy_height; i--; ) {
!                 fast_memcpy (dst_ptr,src_ptr,copy_width);
                  dst_ptr+=dst->stride[2];
                  src_ptr+=src->stride[2];
***************
*** 299,303 ****
  
  /*------------------------------------------------------------------------*/
! void CopyPicBufAlphaBlend(sPicBuffer *dst, sPicBuffer *src,
                  uint8_t *OsdPy,
                  uint8_t *OsdPu, 
--- 373,414 ----
  
  /*------------------------------------------------------------------------*/
! void CopyPicBuf(sPicBuffer *dst, sPicBuffer *src,
!                 int cutTop, int cutBottom, 
!                 int cutLeft, int cutRight) {
!         int width=0;
!         int height=0;
!         dst->edge_width=0;
!         dst->edge_height=0;
!         
!         if ( src->width+src->edge_width <= dst->max_width) {
!                 dst->edge_width = src->edge_width;
!                 width = dst->width = src->width;
!         } else {
!                 width = dst->width = dst->max_width;
!                 dst->edge_width = 0;
!         };
!         
!         if ( src->height+src->edge_height <= dst->max_height) {
!                 dst->edge_height = src->edge_height;
!                 dst->height = height = src->height;
!         } else {
!                 height = dst->height = dst->max_height;
!                 dst->edge_height=0;
!         };
! 
!         if ( dst->format == PIX_FMT_YUV420P ) 
!                 CopyPicBuf_YUV420P(dst,src,width,height,
!                                 cutTop,cutBottom,
!                                 cutLeft,cutRight);
!         else if ( dst->format == PIX_FMT_YUV422 )
!                 CopyPicBuf_YUV420P_YUY2(dst,src,width,height,
!                                 cutTop,cutBottom,
!                                 cutLeft,cutRight);
!         else fprintf(stderr,"Unsupported format in CopyPicBuf!\n");
! }
! 
! /*------------------------------------------------------------------------*/
! void CopyPicBufAlphaBlend_YUV420P_YUY2(sPicBuffer *dst, sPicBuffer *src,
!                 int width, int height,
                  uint8_t *OsdPy,
                  uint8_t *OsdPu, 
***************
*** 306,316 ****
                  uint8_t *OsdPAlphaUV,
                  int OsdStride,
                  int width, int height,
                  int cutTop, int cutBottom, 
                  int cutLeft, int cutRight) {
!        
!         //cutTop+=src->edge_height/2;
!         //cutLeft+=src->edge_width/2;
!         uint8_t *dst_ptr=dst->pixel[0];
          uint8_t *src_ptr=src->pixel[0]+
                  (2*cutTop+src->edge_height)*src->stride[0]+
--- 417,568 ----
                  uint8_t *OsdPAlphaUV,
                  int OsdStride,
+                 int cutTop, int cutBottom, 
+                 int cutLeft, int cutRight) {
+         PICDEB("CopyPicBufAlphaBlend_YUV420P_YUY2 width %d height %d\n",
+                         width,height);
+ 
+         uint8_t tmp_y[2*width];
+         uint8_t tmp_u[width];
+         uint8_t tmp_v[width];
+ 
+         dst->interlaced_frame=src->interlaced_frame;
+         uint8_t *dst_ptr=dst->pixel[0]+
+                 (2*cutTop+dst->edge_height)*dst->stride[0]+
+                 2*cutLeft+dst->edge_width;// 4*cutLeft ??
+         
+         uint8_t *py=src->pixel[0]+
+                 (2*cutTop+src->edge_height)*src->stride[0]+
+                 2*cutLeft+src->edge_width;
+         uint8_t *osd_py=OsdPy+2*cutTop*OsdStride+2*cutLeft;  
+         uint8_t *alpha_py=OsdPAlphaY+2*cutTop*OsdStride+2*cutLeft;
+         
+         uint8_t *pu=src->pixel[1]+
+                 (cutTop+src->edge_height/2)*src->stride[1]+
+                 cutLeft+src->edge_width/2;
+         uint8_t *osd_pu=OsdPu+cutTop*OsdStride/2+cutLeft;
+ 
+         uint8_t *pv=src->pixel[2]+
+                 (cutTop+src->edge_height/2)*src->stride[2]+
+                 cutLeft+src->edge_width/2;
+         uint8_t *osd_pv=OsdPv+cutTop*OsdStride/2+cutLeft;
+         
+         uint8_t *alpha_puv=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
+         
+         int dstStride=dst->stride[0];
+         int lumStride=src->stride[0];
+         int chromStride=src->stride[1];
+       
+         if (src->interlaced_frame) {
+                 for(int y=height/4; y--; ) {
+                         /* ---------------------------------------------
+                          * take chroma line x (it's from field A) for packing 
+                          * with luma lines y * 2 and y * 2 + 2
+                          */
+                         AlphaBlend(tmp_y,osd_py,
+                                         py,alpha_py,width);
+                         AlphaBlend(&tmp_y[width],osd_py+2*OsdStride,
+                                         py+2*lumStride,
+                                         alpha_py+2*OsdStride,width);
+                         
+                         AlphaBlend(tmp_u,osd_pu,
+                                         pu,alpha_puv,width>>1);
+                         AlphaBlend(tmp_v,osd_pv,
+                                         pv,alpha_puv,width>>1);
+ 
+                         yv12_to_yuy2_il_mmx2_line (dst_ptr,
+                                         dst_ptr + dstStride * 2, width >> 1,
+                                         tmp_y, &tmp_y[width],
+                                         tmp_u, tmp_v);
+                         /* ----------------------------------------------
+                          * take chroma line x+1 (it's from field B) for packing 
+                          * with luma lines y * 2 + 1 and y * 2 + 3
+                          */
+                         AlphaBlend(tmp_y,osd_py+OsdStride,
+                                         py+lumStride,
+                                         alpha_py+OsdStride,width);
+                         AlphaBlend(&tmp_y[width],osd_py+3*OsdStride,
+                                         py+3*lumStride,
+                                         alpha_py+3*OsdStride,width);
+                         
+                         AlphaBlend(tmp_u,osd_pu+OsdStride/2,
+                                         pu+chromStride,
+                                         alpha_puv+OsdStride/2,width>>1);
+                         AlphaBlend(tmp_v,osd_pv+OsdStride/2,
+                                         pv+chromStride,
+                                         alpha_puv+OsdStride/2,width>>1);
+ 
+                         yv12_to_yuy2_il_mmx2_line (dst_ptr+dstStride,
+                                         dst_ptr + dstStride * 3, width >> 1,
+                                         tmp_y, &tmp_y[width],
+                                         tmp_u, tmp_v);
+                        
+                         osd_py += 4*OsdStride;
+                         alpha_py += 4*OsdStride;
+                         osd_pu += OsdStride;
+                         osd_pv += OsdStride;
+                         alpha_puv += OsdStride;
+                         
+                         py  += 4*lumStride;
+                         pu  += 2*chromStride;
+                         pv  += 2*chromStride;
+                         dst_ptr += 4*dstStride;
+                 }
+         } else {
+                 for(int y=height/2; y--; ) {
+                         /* ---------------------------------------------
+                          * take chroma line x (it's from field A) for packing 
+                          * with luma lines y * 2 and y * 2 + 2
+                          */
+                         AlphaBlend(tmp_y,osd_py,
+                                         py,alpha_py,width);
+                         AlphaBlend(&tmp_y[width],osd_py+OsdStride,
+                                         py+lumStride,
+                                         alpha_py+OsdStride,width);
+                         
+                         AlphaBlend(tmp_u,osd_pu,
+                                         pu,alpha_puv,width>>1);
+                         AlphaBlend(tmp_v,osd_pv,
+                                         pv,alpha_puv,width>>1);
+ 
+                         yv12_to_yuy2_il_mmx2_line (dst_ptr,
+                                         dst_ptr + dstStride , width >> 1,
+                                         tmp_y, &tmp_y[width],
+                                         tmp_u, tmp_v);
+ 
+                         osd_py += 2*OsdStride;
+                         alpha_py += 2*OsdStride;
+                         osd_pu += OsdStride/2;
+                         osd_pv += OsdStride/2;
+                         alpha_puv += OsdStride/2;
+                         
+                         py  += 2*lumStride;
+                         pu  += chromStride;
+                         pv  += chromStride;
+                         dst_ptr += 2*dstStride;
+                 }
+         }
+         SFENCE;
+         EMMS;
+ 
+ };
+ 
+ /*------------------------------------------------------------------------*/
+ void CopyPicBufAlphaBlend_YUV420P(sPicBuffer *dst, sPicBuffer *src,
                  int width, int height,
+                 uint8_t *OsdPy,
+                 uint8_t *OsdPu, 
+                 uint8_t *OsdPv,
+                 uint8_t *OsdPAlphaY,
+                 uint8_t *OsdPAlphaUV,
+                 int OsdStride,
                  int cutTop, int cutBottom, 
                  int cutLeft, int cutRight) {
! 
!         int copy_width = width - 2 * (cutLeft + cutRight);
!         int copy_height = height - 2 *  (cutBottom + cutTop) ;
!         
!         uint8_t *dst_ptr=dst->pixel[0]+
!                 (2*cutTop+dst->edge_height)*dst->stride[0]+
!                 2*cutLeft+dst->edge_width;
          uint8_t *src_ptr=src->pixel[0]+
                  (2*cutTop+src->edge_height)*src->stride[0]+
***************
*** 318,324 ****
          uint8_t *osd_ptr=OsdPy+2*cutTop*OsdStride+2*cutLeft;
          uint8_t *alpha_ptr=OsdPAlphaY+2*cutTop*OsdStride+2*cutLeft;
!         for (int i = height - (cutBottom+cutTop) * 2; i>=0; i--) {
!                 AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,
!                             width - 2 * (cutLeft + cutRight));
                  dst_ptr+=dst->stride[0];
                  src_ptr+=src->stride[0];
--- 570,575 ----
          uint8_t *osd_ptr=OsdPy+2*cutTop*OsdStride+2*cutLeft;
          uint8_t *alpha_ptr=OsdPAlphaY+2*cutTop*OsdStride+2*cutLeft;
!         for (int i = copy_height ; i--; ) {
!                 AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,copy_width);
                  dst_ptr+=dst->stride[0];
                  src_ptr+=src->stride[0];
***************
*** 327,338 ****
          };
          
!         dst_ptr=dst->pixel[1];
          src_ptr=src->pixel[1]+(cutTop+src->edge_height/2)*src->stride[1]+
                  cutLeft+src->edge_width/2;
          osd_ptr=OsdPu+cutTop*OsdStride/2+cutLeft;
          alpha_ptr=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
!         for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
!                 AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,
!                                 width / 2 - (cutLeft + cutRight));
                  dst_ptr+=dst->stride[1];
                  src_ptr+=src->stride[1];
--- 578,591 ----
          };
          
!         dst_ptr=dst->pixel[1]+(cutTop+dst->edge_height/2)*dst->stride[1]+
!                 cutLeft+dst->edge_width/2;
          src_ptr=src->pixel[1]+(cutTop+src->edge_height/2)*src->stride[1]+
                  cutLeft+src->edge_width/2;
          osd_ptr=OsdPu+cutTop*OsdStride/2+cutLeft;
          alpha_ptr=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
!         copy_width = width / 2 - (cutLeft + cutRight);
!         copy_height = height / 2 - (cutBottom+cutTop);
!         for (int i = copy_height; i--; ) {
!                 AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,copy_width);
                  dst_ptr+=dst->stride[1];
                  src_ptr+=src->stride[1];
***************
*** 341,352 ****
          };
  
!         dst_ptr=dst->pixel[2];
          src_ptr=src->pixel[2]+(cutTop+src->edge_height/2)*src->stride[2]+
                  cutLeft+src->edge_width/2;
          osd_ptr=OsdPv+cutTop*OsdStride/2+cutLeft;
          alpha_ptr=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
!         for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
!                 AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,
!                                 width / 2 - (cutLeft + cutRight));
                  dst_ptr+=dst->stride[2];
                  src_ptr+=src->stride[2];
--- 594,605 ----
          };
  
!         dst_ptr=dst->pixel[2]+(cutTop+dst->edge_height/2)*dst->stride[1]+
!                 cutLeft+dst->edge_width/2;
          src_ptr=src->pixel[2]+(cutTop+src->edge_height/2)*src->stride[2]+
                  cutLeft+src->edge_width/2;
          osd_ptr=OsdPv+cutTop*OsdStride/2+cutLeft;
          alpha_ptr=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
!         for (int i = copy_height; i--; ) {
!                 AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,copy_width);
                  dst_ptr+=dst->stride[2];
                  src_ptr+=src->stride[2];
***************
*** 354,363 ****
                  alpha_ptr+=OsdStride/2;
         };
!        /*
!         for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!                 fast_memcpy (pixels [2] + i * xvWidth / 2 + cutLeft,
!                                 Pu + i * UVstride + cutLeft,
!                                 fwidth / 2 - (cutLeft + cutRight));
!                                 */
  };
  
--- 607,663 ----
                  alpha_ptr+=OsdStride/2;
         };
! };
! 
! /*------------------------------------------------------------------------*/
! void CopyPicBufAlphaBlend(sPicBuffer *dst, sPicBuffer *src,
!                 uint8_t *OsdPy,
!                 uint8_t *OsdPu, 
!                 uint8_t *OsdPv,
!                 uint8_t *OsdPAlphaY,
!                 uint8_t *OsdPAlphaUV,
!                 int OsdStride,
!                 int cutTop, int cutBottom, 
!                 int cutLeft, int cutRight) {
!         
!         int width=0;
!         int height=0;
!         dst->edge_width=0;
!         dst->edge_height=0;
!         
!         if ( src->width+src->edge_width <= dst->max_width) {
!                 dst->edge_width = src->edge_width;
!                 width = dst->width = src->width;
!         } else {
!                 width = dst->width = dst->max_width;
!                 dst->edge_width = 0;
!         };
!         
!         if ( src->height+src->edge_height <= dst->max_height) {
!                 dst->edge_height = src->edge_height;
!                 dst->height = height = src->height;
!         } else {
!                 height = dst->height = dst->max_height;
!                 dst->edge_height=0;
!         };
! 
!         if ( width > OSD_FULL_WIDTH )
!                 width = OSD_FULL_WIDTH;
! 
!         if ( height > OSD_FULL_HEIGHT )
!                 height = OSD_FULL_HEIGHT;
!  
!         if ( dst->format == PIX_FMT_YUV420P ) 
!                 CopyPicBufAlphaBlend_YUV420P(dst,src,width,height,
!                                 OsdPy, OsdPu, OsdPv,
!                                 OsdPAlphaY, OsdPAlphaUV, OsdStride,
!                                 cutTop,cutBottom,
!                                 cutLeft,cutRight);
!         else if ( dst->format == PIX_FMT_YUV422 )
!                 CopyPicBufAlphaBlend_YUV420P_YUY2(dst,src,width,height,
!                                 OsdPy, OsdPu, OsdPv,
!                                 OsdPAlphaY, OsdPAlphaUV, OsdStride,
!                                 cutTop,cutBottom,
!                                 cutLeft,cutRight);
!         else fprintf(stderr,"Unsupported format in CopyPicBuf!\n");
  };
  

Index: PicBuffer.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** PicBuffer.h	17 Jun 2006 16:27:34 -0000	1.2
--- PicBuffer.h	10 Jul 2006 17:56:29 -0000	1.3
***************
*** 87,91 ****
                  int &vChromaShift);
  
!         virtual void AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                          int w, int h);
          // actually allocates memory for the buffer. Can be overloaded for 
--- 87,91 ----
                  int &vChromaShift);
  
!         virtual bool AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                          int w, int h);
          // actually allocates memory for the buffer. Can be overloaded for 
***************
*** 98,109 ****
  
  void CopyPicBuf(sPicBuffer *dest, sPicBuffer *src,
-                 int width, int height,
                  int cutTop, int cutBottom, int cutLeft, int cutRight);
  
  void CopyPicBufAlphaBlend(sPicBuffer *dst, 
                  sPicBuffer *src,
!                 uint8_t *OsdPy,uint8_t *OsdPu, 
!                 uint8_t *OsdPv,uint8_t *OsdPAlphaY,
!                 uint8_t *OsdPAlphaUV,int width, int height,
                  int cutTop, int cutBottom,int cutLeft, int cutRight); 
   
--- 98,107 ----
  
  void CopyPicBuf(sPicBuffer *dest, sPicBuffer *src,
                  int cutTop, int cutBottom, int cutLeft, int cutRight);
  
  void CopyPicBufAlphaBlend(sPicBuffer *dst, 
                  sPicBuffer *src,
!                 uint8_t *OsdPy,uint8_t *OsdPu, uint8_t *OsdPv,
!                 uint8_t *OsdPAlphaY, uint8_t *OsdPAlphaUV,int OsdStride,
                  int cutTop, int cutBottom,int cutLeft, int cutRight); 
   



From nobody at sheep.berlios.de  Mon Jul 10 20:23:31 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 10 Jul 2006 20:23:31 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.206,1.207 SoftOsd.c,1.15,1.16 SoftOsd.h,1.6,1.7
Message-ID: <200607101823.k6AINVY19844@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9040

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
 - fix possible endianness problems in SoftOsd.c


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.206
retrieving revision 1.207
diff -C2 -d -r1.206 -r1.207
*** CHANGELOG	10 Jul 2006 17:56:29 -0000	1.206
--- CHANGELOG	10 Jul 2006 18:23:28 -0000	1.207
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-07-10:
+    - fix possible endianness problems in SoftOsd.c
     - add support for yuy2 pixel format to alpha blend and copy pic buf code
     - change return value of AllocPicBuffer()

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** SoftOsd.c	15 Jun 2006 21:34:20 -0000	1.15
--- SoftOsd.c	10 Jul 2006 18:23:28 -0000	1.16
***************
*** 29,32 ****
--- 29,33 ----
  
  
+ //#undef USE_MMX
  //#undef USE_MMX2
  /* ---------------------------------------------------------------------------
***************
*** 274,278 ****
          // Handle YUV format
          if (bitmap_Format == PF_AYUV) {
! 		ARGB_to_AYUV((uint8_t*)palette,(color *)orig_palette,
                                  maxColors);
                  return;
--- 275,279 ----
          // Handle YUV format
          if (bitmap_Format == PF_AYUV) {
! 		ARGB_to_AYUV((uint32_t*)palette,(color *)orig_palette,
                                  maxColors);
                  return;
***************
*** 289,293 ****
  			};
  
!                         // replace transparent colors with color key
                          if ( IS_TRANSPARENT( (uint32_t)palette[i] >> 24  ) ) {
                          //if (((uint32_t)palette[i] & 0xFF000000) == 0x000000 ) {
--- 290,294 ----
  			};
  
!                        // replace transparent colors with color key
                          if ( IS_TRANSPARENT( (uint32_t)palette[i] >> 24  ) ) {
                          //if (((uint32_t)palette[i] & 0xFF000000) == 0x000000 ) {
***************
*** 297,301 ****
  	} else if ( bitmap_Format == PF_inverseAlpha_ARGB32 ) {
  		for (int i=0; i<maxColors; i++) {
!                         ((color*) palette)[i].a=0xFF-((color*) palette)[i].a;
                  };
  	};
--- 298,305 ----
  	} else if ( bitmap_Format == PF_inverseAlpha_ARGB32 ) {
  		for (int i=0; i<maxColors; i++) {
!                         int a=GET_A(((color*) palette)[i]);
!                         ((color*) palette)[i]&=~SET_A(0xFF);
!                         ((color*) palette)[i]|=SET_A(0xFF-a);
!                         //((color*) palette)[i].a=0xFF-((color*) palette)[i].a;
                  };
  	};
***************
*** 356,377 ****
  /*----------------------------------------------------------------------*/
  
! void cSoftOsd::ARGB_to_AYUV(uint8_t * dest, color * pixmap, int Pixel) {
          int Y;
          int U;
          int V;
          while (Pixel>0) {
!                 //printf("ARGB: %02x,%02x,%02x,%02x ",pixmap->a,pixmap->r,
!                 //                pixmap->g,pixmap->b);
                  // I got this formular from Wikipedia...
!                 Y = (( 66 * (int)pixmap->r + 129 * (int)pixmap->g 
!                                + 25 * (int)pixmap->b + 128 )  >> 8)+16;
!                 U = (( -38 * (int)pixmap->r - 74 * (int)pixmap->g 
!                                +112 * (int)pixmap->b + 128 )  >> 8)+128;
!                 V = (( 112 * (int)pixmap->r - 94 * (int)pixmap->g 
!                                - 18 * (int)pixmap->b + 128 )  >> 8)+128;
!                 *dest++=(uint8_t)V;
!                 *dest++=(uint8_t)U;
!                 *dest++=(uint8_t)Y;
!                 *dest++=pixmap->a;
                  //printf("->AYUV: %0x,%02x,%02x,%02x\n",pixmap->a,Y,U,V);
                  pixmap++;
--- 360,380 ----
  /*----------------------------------------------------------------------*/
  
! void cSoftOsd::ARGB_to_AYUV(uint32_t * dest, color * pixmap, int Pixel) {
          int Y;
          int U;
          int V;
+         int a,r,g,b;
+         int c;
          while (Pixel>0) {
!                 a=GET_A(*pixmap); r=GET_R(*pixmap);
!                 g=GET_G(*pixmap); b=GET_B(*pixmap);
!                 
!                 //printf("ARGB: %02x,%02x,%02x,%02x ",a,r,g,b);
                  // I got this formular from Wikipedia...
!                 Y = (( 66 * r + 129 * g + 25 * b + 128 )  >> 8)+16;
!                 U = (( -38 * r - 74 * g +112 * b + 128 )  >> 8)+128;
!                 V = (( 112 * r - 94 * g - 18 * b + 128 )  >> 8)+128;
!                 c = SET_A(a) | SET_R(Y) | SET_G(U) | SET_B(V);
!                 *dest++ = c;
                  //printf("->AYUV: %0x,%02x,%02x,%02x\n",pixmap->a,Y,U,V);
                  pixmap++;
***************
*** 443,455 ****
  	end_dest+=16;
  #endif
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)dest) & 0x4) ) {
                          dest[0] = 0; dest[1] = 0; dest[2] = 0; dest[3] = 0x00;
                          // color key!
                  } else {
!                         dest[0]=pixmap->b;
!                         dest[1]=pixmap->g;
!                         dest[2]=pixmap->r;
!                         dest[3]=pixmap->a;
                  }
                  dest+=4;
--- 446,460 ----
  	end_dest+=16;
  #endif
+         int c;
          while (end_dest>dest) {
!                 c=*pixmap;
!                 if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)dest) & 0x4) ) {
                          dest[0] = 0; dest[1] = 0; dest[2] = 0; dest[3] = 0x00;
                          // color key!
                  } else {
!                         dest[0]=GET_B(c);
!                         dest[1]=GET_G(c);
!                         dest[2]=GET_R(c);
!                         dest[3]=GET_A(c);
                  }
                  dest+=4;
***************
*** 650,671 ****
  	EMMS;
  #endif
  	while (Pixel>1) {
! 		*(PAlphaY1++)=pixmap1[0].a; *(PAlphaY1++)=pixmap1[1].a;
! 		*(PAlphaY2++)=pixmap2[0].a; *(PAlphaY2++)=pixmap2[1].a;
! 		*(PY1++)=pixmap1[0].r; *(PY1++)=pixmap1[1].r;
! 		*(PY2++)=pixmap2[0].r; *(PY2++)=pixmap2[1].r;
                  
! 		*(PU++)=(uint8_t)((uint16_t)
!                                 ((uint16_t)pixmap1[0].b+(uint16_t)pixmap1[1].b+
! 				  (uint16_t)pixmap2[0].b+(uint16_t)pixmap2[1].b)
! 			>>2);
! 		*(PV++)=(uint8_t)((uint16_t)(
!                                   (uint16_t)pixmap1[0].g+(uint16_t)pixmap1[1].g+
! 				  (uint16_t)pixmap2[0].g+(uint16_t)pixmap2[1].g)
! 			>>2);
! 		*(PAlphaUV++)=(uint8_t)((uint16_t)
! 			((uint16_t)pixmap1[0].a+(uint16_t)pixmap1[1].a+
! 			(uint16_t)pixmap2[0].a+(uint16_t)pixmap2[1].a)
! 			>>2);
                          
                  pixmap1+=2;
--- 655,679 ----
  	EMMS;
  #endif
+         int p10,p11;
+         int p20,p21;
  	while (Pixel>1) {
!                 p10=pixmap1[0]; p11=pixmap1[1];
!                 p20=pixmap2[0]; p21=pixmap2[1];
                  
! 		*(PAlphaY1++)=GET_A(p10); *(PAlphaY1++)=GET_A(p11);
! 		*(PAlphaY2++)=GET_A(p20); *(PAlphaY2++)=GET_A(p21);
! 		*(PAlphaUV++)=(uint8_t)((unsigned int)
! 			(GET_A(p10)+GET_A(p11)+
! 			 GET_A(p20)+GET_A(p21))>>2);
! 
!                 *(PY1++)=GET_R(p10); *(PY1++)=GET_R(p11);
! 		*(PY2++)=GET_R(p20); *(PY2++)=GET_R(p21);
!                 
! 		*(PU++)=(uint8_t)((unsigned int)
!                                 (GET_B(p10) + GET_B(p11) +
! 				  GET_B(p20)+ GET_B(p21))>>2);
! 		*(PV++)=(uint8_t)((unsigned int)
!                                   (GET_G(p10)+GET_G(p11)+
! 				   GET_G(p20)+GET_G(p21))>>2);
                          
                  pixmap1+=2;
***************
*** 678,688 ****
  
  void cSoftOsd::ARGB_to_RGB24(uint8_t * dest, color * pixmap, int Pixel) {
          while (Pixel) {
!                 if ( IS_BACKGROUND(pixmap->a) && (Pixel & 0x1) ) {
                          dest[0] = 0x0; dest[1] = 0x0; dest[1] = 0x0; // color key!
                  } else {
!                         dest[0]=pixmap->b;
!                         dest[1]=pixmap->g;
!                         dest[2]=pixmap->r;
                  }
                  dest+=3;
--- 686,698 ----
  
  void cSoftOsd::ARGB_to_RGB24(uint8_t * dest, color * pixmap, int Pixel) {
+         int c;
          while (Pixel) {
!                 c = *pixmap;
!                 if ( IS_BACKGROUND(GET_A(c)) && (Pixel & 0x1) ) {
                          dest[0] = 0x0; dest[1] = 0x0; dest[1] = 0x0; // color key!
                  } else {
!                         dest[0]=GET_B(c);
!                         dest[1]=GET_G(c);
!                         dest[2]=GET_R(c);
                  }
                  dest+=3;
***************
*** 777,787 ****
          end_dest+=8;
  #endif
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)dest) & 0x2) ) {
                          dest[0] = 0x0; dest[1] = 0x0; // color key!
                  } else {
!                         dest[0] = ((pixmap->b >> 3)& 0x1F) | 
!                                 ((pixmap->g & 0x1C) << 3);
!                         dest[1] = (pixmap->r & 0xF8) | (pixmap->g >> 5);
                  }
                  dest+=2;
--- 787,799 ----
          end_dest+=8;
  #endif
+         int c;
          while (end_dest>dest) {
!                 c = *pixmap;
!                 if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)dest) & 0x2) ) {
                          dest[0] = 0x0; dest[1] = 0x0; // color key!
                  } else {
!                         dest[0] = ((GET_B(c) >> 3)& 0x1F) | 
!                                 ((GET_G(c) & 0x1C) << 3);
!                         dest[1] = (GET_R(c) & 0xF8) | (GET_G(c) >> 5);
                  }
                  dest+=2;
***************
*** 795,808 ****
  	uint8_t *end_dest=dest+2*Pixel;
  	int PixelCount=0;
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)pixmap) & 0x4)
! 				|| IS_TRANSPARENT(pixmap->a) ) {
                          // transparent, don't draw anything !
                  } else {
                          // FIXME 15/16bit mode? Probably broken!
! 			dest[0] = ((pixmap->b >> 3)& 0x1F) | 
!                                 ((pixmap->g & 0x1C) << 3);
!                         dest[1] = ((pixmap->r ) & 0xF8) 
! 			 	| ((pixmap->g >> 5) );
                  }
                  dest+=2;
--- 807,822 ----
  	uint8_t *end_dest=dest+2*Pixel;
  	int PixelCount=0;
+         int c;
          while (end_dest>dest) {
!                 c=*pixmap;
!                 if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)pixmap) & 0x4)
! 				|| IS_TRANSPARENT(GET_A(c)) ) {
                          // transparent, don't draw anything !
                  } else {
                          // FIXME 15/16bit mode? Probably broken!
! 			dest[0] = ((GET_B(c) >> 3)& 0x1F) | 
!                                 ((GET_G(c) & 0x1C) << 3);
!                         dest[1] = ((GET_R(c) ) & 0xF8) 
! 			 	| ((GET_G(c) >> 5) );
                  }
                  dest+=2;
***************
*** 814,820 ****
  void cSoftOsd::CreatePixelMask(uint8_t * dest, color * pixmap, int Pixel) {
  	int CurrPixel=0;
          while (CurrPixel<Pixel) {
!                 if ( (IS_BACKGROUND(pixmap->a) && !(((intptr_t)pixmap) & 0x4)  )
!                                 || IS_OPAQUE(pixmap->a) ) 
                          dest[CurrPixel/8]|=(1<<CurrPixel%8);
                   else dest[CurrPixel/8]&=~(1<<CurrPixel%8);
--- 828,836 ----
  void cSoftOsd::CreatePixelMask(uint8_t * dest, color * pixmap, int Pixel) {
  	int CurrPixel=0;
+         int c;
          while (CurrPixel<Pixel) {
!                 c = *pixmap;
!                 if ( (IS_BACKGROUND(GET_A(c)) && !(((intptr_t)pixmap) & 0x4)  )
!                                 || IS_OPAQUE(GET_A(c)) ) 
                          dest[CurrPixel/8]|=(1<<CurrPixel%8);
                   else dest[CurrPixel/8]&=~(1<<CurrPixel%8);
***************
*** 857,861 ****
          uint8_t *pY;uint8_t *pU;uint8_t *pV;
          uint8_t *pAlphaY; uint8_t *pAlphaUV;
!  	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz = ( dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
                        ( dest_Width==OSD_WIDTH ? &cSoftOsd::NoScaleHoriz_MMX :
--- 873,877 ----
          uint8_t *pY;uint8_t *pU;uint8_t *pV;
          uint8_t *pAlphaY; uint8_t *pAlphaUV;
!  	void (cSoftOsd::*ScaleHoriz)(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz = ( dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
                        ( dest_Width==OSD_WIDTH ? &cSoftOsd::NoScaleHoriz_MMX :
***************
*** 877,883 ****
                  } else {
                          //printf("Horiz scaling line %d\n",start_row+i);
!                         (this->*ScaleHoriz)((uint8_t *)tmp_pixmap,dest_Width,
                                              &pixmap[y*OSD_STRIDE],OSD_WIDTH-1); 
!                         (this->*ScaleHoriz)((uint8_t *)&tmp_pixmap[dest_Stride],
                                              dest_Width,
                                              &pixmap[(y+1)*OSD_STRIDE],OSD_WIDTH-1); 
--- 893,899 ----
                  } else {
                          //printf("Horiz scaling line %d\n",start_row+i);
!                         (this->*ScaleHoriz)((uint32_t*)tmp_pixmap,dest_Width,
                                              &pixmap[y*OSD_STRIDE],OSD_WIDTH-1); 
!                         (this->*ScaleHoriz)((uint32_t*)&tmp_pixmap[dest_Stride],
                                              dest_Width,
                                              &pixmap[(y+1)*OSD_STRIDE],OSD_WIDTH-1); 
***************
*** 955,959 ****
                          if (scaleH_lines[SCALEH_IDX(i)]!=start_row+i){
                                  //printf("Horiz scaling line %d\n",start_row+i);
!                                 ScaleDownHoriz_MMX((uint8_t *)scaleH_Reference[i],dest_Width,
                                                  &pixmap[(start_row+i)*OSD_STRIDE],OSD_WIDTH-1); 
                                  scaleH_lines[SCALEH_IDX(i)]=start_row+i;
--- 971,975 ----
                          if (scaleH_lines[SCALEH_IDX(i)]!=start_row+i){
                                  //printf("Horiz scaling line %d\n",start_row+i);
!                                 ScaleDownHoriz_MMX((uint32_t*)scaleH_Reference[i],dest_Width,
                                                  &pixmap[(start_row+i)*OSD_STRIDE],OSD_WIDTH-1); 
                                  scaleH_lines[SCALEH_IDX(i)]=start_row+i;
***************
*** 967,971 ****
                   */ 
                  OSDDEB("start_pos %d start_row %d\n",start_pos,start_row);
!                 ScaleDownVert_MMX((uint8_t*) tmp_pixmap,0,
  				new_pixel_height,start_pos,
                                  scaleH_Reference,dest_Width);
--- 983,987 ----
                   */ 
                  OSDDEB("start_pos %d start_row %d\n",start_pos,start_row);
!                 ScaleDownVert_MMX((uint32_t*)tmp_pixmap,0,
  				new_pixel_height,start_pos,
                                  scaleH_Reference,dest_Width);
***************
*** 982,986 ****
                  
                  OSDDEB("start_pos %d new_start_row %d\n",start_pos,new_start_row);
!                 ScaleDownVert_MMX((uint8_t*) &tmp_pixmap[OSD_STRIDE],0,
  				new_pixel_height,start_pos,
                                  &scaleH_Reference[start_row_idx],
--- 998,1002 ----
                  
                  OSDDEB("start_pos %d new_start_row %d\n",start_pos,new_start_row);
!                 ScaleDownVert_MMX((uint32_t*)&tmp_pixmap[OSD_STRIDE],0,
  				new_pixel_height,start_pos,
                                  &scaleH_Reference[start_row_idx],
***************
*** 1036,1040 ****
  	cMutexLock dirty(&dirty_Mutex);
  	const int dest_stride=(dest_Width+32)&~0xF;
! 	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
  		&cSoftOsd::ScaleUpHoriz_MMX;
--- 1052,1056 ----
  	cMutexLock dirty(&dirty_Mutex);
  	const int dest_stride=(dest_Width+32)&~0xF;
! 	void (cSoftOsd::*ScaleHoriz)(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
  		&cSoftOsd::ScaleUpHoriz_MMX;
***************
*** 1078,1082 ****
  		if ( scaleH_lines[scaleH_strtIdx] != start_row ) {
  			(this->*ScaleHoriz)
! 				((uint8_t *)scaleH_Reference[0],dest_Width,
  				 &pixmap[(start_row+0)*OSD_STRIDE],OSD_WIDTH);
  			scaleH_lines[scaleH_strtIdx] = start_row;
--- 1094,1098 ----
  		if ( scaleH_lines[scaleH_strtIdx] != start_row ) {
  			(this->*ScaleHoriz)
! 				((uint32_t*)scaleH_Reference[0],dest_Width,
  				 &pixmap[(start_row+0)*OSD_STRIDE],OSD_WIDTH);
  			scaleH_lines[scaleH_strtIdx] = start_row;
***************
*** 1084,1092 ****
  		
  		(this->*ScaleHoriz)
! 			((uint8_t *)scaleH_Reference[1],dest_Width,
  			 &pixmap[(start_row+1)*OSD_STRIDE],OSD_WIDTH);
  	
  		scaleH_lines[!scaleH_strtIdx] = start_row+1;
! 		ScaleUpVert_MMX((uint8_t*) tmp_pixmap,dest_Width*4,
  				new_pixel_height,start_pos,
                                  scaleH_Reference,dest_Width);
--- 1100,1108 ----
  		
  		(this->*ScaleHoriz)
! 			((uint32_t*)scaleH_Reference[1],dest_Width,
  			 &pixmap[(start_row+1)*OSD_STRIDE],OSD_WIDTH);
  	
  		scaleH_lines[!scaleH_strtIdx] = start_row+1;
! 		ScaleUpVert_MMX((uint32_t*)tmp_pixmap,dest_Width,
  				new_pixel_height,start_pos,
                                  scaleH_Reference,dest_Width);
***************
*** 1143,1147 ****
          color tmp_pixmap[2*dest_stride];
  
!        void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
  		&cSoftOsd::ScaleUpHoriz_MMX;
--- 1159,1163 ----
          color tmp_pixmap[2*dest_stride];
  
!        void (cSoftOsd::*ScaleHoriz)(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
  		&cSoftOsd::ScaleUpHoriz_MMX;
***************
*** 1176,1185 ****
                          if (scaleH_lines[SCALEH_IDX(i)]!=start_row+i){
                                  //printf("Horiz scaling line %d\n",start_row+i);
!                                 (this->*ScaleHoriz)((uint8_t *)scaleH_Reference[i],dest_Width,
                                                  &pixmap[(start_row+i)*OSD_STRIDE],OSD_WIDTH-1); 
                                  scaleH_lines[SCALEH_IDX(i)]=start_row+i;
                          }
                  };
!                 ScaleDownVert_MMX((uint8_t*) tmp_pixmap,linesize,
  				new_pixel_height,start_pos,
                                  scaleH_Reference,dest_Width);
--- 1192,1201 ----
                          if (scaleH_lines[SCALEH_IDX(i)]!=start_row+i){
                                  //printf("Horiz scaling line %d\n",start_row+i);
!                                 (this->*ScaleHoriz)((uint32_t*)scaleH_Reference[i],dest_Width,
                                                  &pixmap[(start_row+i)*OSD_STRIDE],OSD_WIDTH-1); 
                                  scaleH_lines[SCALEH_IDX(i)]=start_row+i;
                          }
                  };
!                 ScaleDownVert_MMX((uint32_t*)tmp_pixmap,linesize,
  				new_pixel_height,start_pos,
                                  scaleH_Reference,dest_Width);
***************
*** 1204,1208 ****
  #define SCALEDEBV(out...) 
  
! void cSoftOsd::ScaleDownVert_MMX(uint8_t * dest, int linesize,
  		int32_t new_pixel_height, int start_pos,
                  color ** pixmap, int Pixel) {
--- 1220,1224 ----
  #define SCALEDEBV(out...) 
  
! void cSoftOsd::ScaleDownVert_MMX(uint32_t * dest, int linesize,
  		int32_t new_pixel_height, int start_pos,
                  color ** pixmap, int Pixel) {
***************
*** 1212,1219 ****
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
  #ifndef USE_MMX2
!         uint16_t a_sum=0;
!         uint16_t b_sum=0;
!         uint16_t g_sum=0;
!         uint16_t r_sum=0;
  #endif
  
--- 1228,1236 ----
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
  #ifndef USE_MMX2
!         unsigned int a_sum=0;
!         unsigned int b_sum=0;
!         unsigned int g_sum=0;
!         unsigned int r_sum=0;
!         unsigned int c;
  #endif
  
***************
*** 1246,1253 ****
  #ifndef USE_MMX2                       
                  a_sum=b_sum=g_sum=r_sum=0;
!                 a_sum=((int) pixmap[row][Pixel].a)*a_pos;
!                 b_sum=((int) pixmap[row][Pixel].b)*a_pos;
!                 g_sum=((int) pixmap[row][Pixel].g)*a_pos;
!                 r_sum=((int) pixmap[row][Pixel].r)*a_pos;
  #else
                  __asm__(
--- 1263,1271 ----
  #ifndef USE_MMX2                       
                  a_sum=b_sum=g_sum=r_sum=0;
!                 c = pixmap[row][Pixel];
!                 a_sum= GET_A(c)*a_pos;
!                 b_sum= GET_B(c)*a_pos;
!                 g_sum= GET_G(c)*a_pos;
!                 r_sum= GET_R(c)*a_pos;
  #else
                  __asm__(
***************
*** 1269,1277 ****
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b);
  
! #ifndef USE_MMX2                       
!                         a_sum+=((int) pixmap[row][Pixel].a)*ScaleFactor;
!                         b_sum+=((int) pixmap[row][Pixel].b)*ScaleFactor;
!                         g_sum+=((int) pixmap[row][Pixel].g)*ScaleFactor;
!                         r_sum+=((int) pixmap[row][Pixel].r)*ScaleFactor;
  #else
                          __asm__(
--- 1287,1296 ----
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b);
  
! #ifndef USE_MMX2               
!                         c=pixmap[row][Pixel];
!                         a_sum+=GET_A(c)*ScaleFactor;
!                         b_sum+=GET_B(c)*ScaleFactor;
!                         g_sum+=GET_G(c)*ScaleFactor;
!                         r_sum+=GET_R(c)*ScaleFactor;
  #else
                          __asm__(
***************
*** 1290,1297 ****
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b,pos);
  #ifndef USE_MMX2                       
!                 a_sum+=((int) pixmap[row][Pixel].a)*pos;
!                 b_sum+=((int) pixmap[row][Pixel].b)*pos;
!                 g_sum+=((int) pixmap[row][Pixel].g)*pos;
!                 r_sum+=((int) pixmap[row][Pixel].r)*pos;
  #else
                  __asm__(
--- 1309,1317 ----
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b,pos);
  #ifndef USE_MMX2                       
!                 c=pixmap[row][Pixel];
!                 a_sum+=GET_A(c)*pos;
!                 b_sum+=GET_B(c)*pos;
!                 g_sum+=GET_G(c)*pos;
!                 r_sum+=GET_R(c)*pos;
  #else
                  __asm__(
***************
*** 1315,1322 ****
                  r_sum=r_sum/ScaleFactor*new_pixel_height_rec/ScaleFactor;
                  
!                 dest[Pixel*4+0]=b_sum;
!                 dest[Pixel*4+1]=g_sum;
!                 dest[Pixel*4+2]=r_sum;
!                 dest[Pixel*4+3]=a_sum;
  #else
                  __asm__(
--- 1335,1340 ----
                  r_sum=r_sum/ScaleFactor*new_pixel_height_rec/ScaleFactor;
                  
!                 c = SET_B(b_sum) | SET_G(g_sum) | SET_R(r_sum) | SET_A(a_sum);
!                 dest[Pixel]=c;
  #else
                  __asm__(
***************
*** 1326,1330 ****
                        " packuswb %%mm0,%%mm0 \n"
                        " movd %%mm0,(%0) \n"
!                       : : "r"(&dest[Pixel*4]) );
  #endif
                  SCALEDEBV(", %d, %d, %d\n",r_sum,g_sum,b_sum);
--- 1344,1348 ----
                        " packuswb %%mm0,%%mm0 \n"
                        " movd %%mm0,(%0) \n"
!                       : : "r"(&dest[Pixel]) );
  #endif
                  SCALEDEBV(", %d, %d, %d\n",r_sum,g_sum,b_sum);
***************
*** 1336,1340 ****
  };
  
! void cSoftOsd::NoScaleHoriz_MMX(uint8_t * dest, int dest_Width, 
                  color * pixmap, int Pixel) {
          memcpy(dest,pixmap,Pixel*sizeof(color));
--- 1354,1358 ----
  };
  
! void cSoftOsd::NoScaleHoriz_MMX(uint32_t * dest, int dest_Width, 
                  color * pixmap, int Pixel) {
          memcpy(dest,pixmap,Pixel*sizeof(color));
***************
*** 1344,1348 ****
  #define SCALEDEBH(out...) 
  
! void cSoftOsd::ScaleDownHoriz_MMX(uint8_t * dest, int dest_Width, 
                  color * pixmap, int Pixel) {
  #define SHIFT_BITS "6"
--- 1362,1366 ----
  #define SCALEDEBH(out...) 
  
! void cSoftOsd::ScaleDownHoriz_MMX(uint32_t * dest, int dest_Width, 
                  color * pixmap, int Pixel) {
  #define SHIFT_BITS "6"
***************
*** 1350,1357 ****
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
  #ifndef USE_MMX2
!         uint16_t a_sum=0;
!         uint16_t b_sum=0;
!         uint16_t g_sum=0;
!         uint16_t r_sum=0;
  #endif
          uint32_t new_pixel_width=(OSD_WIDTH*ScaleFactor)/dest_Width;
--- 1368,1376 ----
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
  #ifndef USE_MMX2
!         unsigned int a_sum=0;
!         unsigned int b_sum=0;
!         unsigned int g_sum=0;
!         unsigned int r_sum=0;
!         unsigned int c;
  #endif
          uint32_t new_pixel_width=(OSD_WIDTH*ScaleFactor)/dest_Width;
***************
*** 1377,1385 ****
                                          pixmap->r,pixmap->g,pixmap->b);
  
! #ifndef USE_MMX2                       
!                         a_sum+=((int) pixmap->a)*ScaleFactor;
!                         b_sum+=((int) pixmap->b)*ScaleFactor;
!                         g_sum+=((int) pixmap->g)*ScaleFactor;
!                         r_sum+=((int) pixmap->r)*ScaleFactor;
  #else
                          __asm__ __volatile__(
--- 1396,1405 ----
                                          pixmap->r,pixmap->g,pixmap->b);
  
! #ifndef USE_MMX2               
!                         c=*pixmap;
!                         a_sum+=GET_A(c)*ScaleFactor;
!                         b_sum+=GET_B(c)*ScaleFactor;
!                         g_sum+=GET_G(c)*ScaleFactor;
!                         r_sum+=GET_R(c)*ScaleFactor;
  #else
                          __asm__ __volatile__(
***************
*** 1398,1405 ****
                                          pixmap->r,pixmap->g,pixmap->b,pos);
  #ifndef USE_MMX2                       
!                 a_sum+=((int) pixmap->a)*pos;
!                 b_sum+=((int) pixmap->b)*pos;
!                 g_sum+=((int) pixmap->g)*pos;
!                 r_sum+=((int) pixmap->r)*pos;
  #else
                  __asm__ __volatile__(
--- 1418,1426 ----
                                          pixmap->r,pixmap->g,pixmap->b,pos);
  #ifndef USE_MMX2                       
!                 c=*pixmap;
!                 a_sum+=GET_A(c)*pos;
!                 b_sum+=GET_B(c)*pos;
!                 g_sum+=GET_G(c)*pos;
!                 r_sum+=GET_R(c)*pos;
  #else
                  __asm__ __volatile__(
***************
*** 1423,1430 ****
                  r_sum=r_sum/ScaleFactor*new_pixel_width_rec/ScaleFactor;
                  
  		dest[0]=b_sum;
                  dest[1]=g_sum;
                  dest[2]=r_sum;
!                 dest[3]=a_sum;
                  a_sum=b_sum=g_sum=r_sum=0;
  #else
--- 1444,1454 ----
                  r_sum=r_sum/ScaleFactor*new_pixel_width_rec/ScaleFactor;
                  
+                 c = SET_B(b_sum) | SET_G(g_sum) | SET_R(r_sum) | SET_A(a_sum);
+                 *dest=c;
+                 /*
  		dest[0]=b_sum;
                  dest[1]=g_sum;
                  dest[2]=r_sum;
!                 dest[3]=a_sum;*/
                  a_sum=b_sum=g_sum=r_sum=0;
  #else
***************
*** 1439,1443 ****
  #endif
                  SCALEDEBH(", %d, %d, %d\n",r_sum,g_sum,b_sum);
!                 dest+=4;
  
                  pos-=ScaleFactor;
--- 1463,1467 ----
  #endif
                  SCALEDEBH(", %d, %d, %d\n",r_sum,g_sum,b_sum);
!                 dest++;
  
                  pos-=ScaleFactor;
***************
*** 1448,1456 ****
                  //uint32_t apos=-(pos);
                  uint32_t apos=abs(pos);
! #ifndef USE_MMX2                       
!                 a_sum=((int) pixmap->a)*apos;
!                 b_sum=((int) pixmap->b)*apos;
!                 g_sum=((int) pixmap->g)*apos;
!                 r_sum=((int) pixmap->r)*apos;
  #else
                  __asm__ __volatile__ (
--- 1472,1481 ----
                  //uint32_t apos=-(pos);
                  uint32_t apos=abs(pos);
! #ifndef USE_MMX2            
!                 c=*pixmap;
!                 a_sum=GET_A(c)*apos;
!                 b_sum=GET_B(c)*apos;
!                 g_sum=GET_G(c)*apos;
!                 r_sum=GET_R(c)*apos;
  #else
                  __asm__ __volatile__ (
***************
*** 1473,1477 ****
  #define SCALEUPDEBH(out...) 
  
! void cSoftOsd::ScaleUpHoriz_MMX(uint8_t * dest, int dest_Width, 
                  color * pixmap, int Pixel) {
  #define SHIFT_BITS "6"
--- 1498,1502 ----
  #define SCALEUPDEBH(out...) 
  
! void cSoftOsd::ScaleUpHoriz_MMX(uint32_t * dest, int dest_Width, 
                  color * pixmap, int Pixel) {
  #define SHIFT_BITS "6"
***************
*** 1481,1493 ****
          color *end_pixmap=pixmap+Pixel;
  #ifndef USE_MMX2
! 	uint16_t a1=pixmap->a;
! 	uint16_t b1=pixmap->b;
! 	uint16_t g1=pixmap->g;
! 	uint16_t r1=pixmap->r;
  	pixmap++;
! 	uint16_t a2=pixmap->a;
! 	uint16_t b2=pixmap->b;
! 	uint16_t g2=pixmap->g;
! 	uint16_t r2=pixmap->r;
  #else
  	__asm__(
--- 1506,1520 ----
          color *end_pixmap=pixmap+Pixel;
  #ifndef USE_MMX2
!         unsigned int c=*pixmap;
! 	unsigned int a1=GET_A(c);
! 	unsigned int b1=GET_B(c);
! 	unsigned int g1=GET_G(c);
! 	unsigned int r1=GET_R(c);
  	pixmap++;
!         c=*pixmap;
! 	unsigned int a2=GET_A(c);
! 	unsigned int b2=GET_B(c);
! 	unsigned int g2=GET_G(c);
! 	unsigned int r2=GET_R(c);
  #else
  	__asm__(
***************
*** 1516,1523 ****
  			// funny that's the same formula we use for
  			// alpha blending ;-)
! 			dest[0]=(uint8_t) (b1+(pos*(b2-b1)/ScaleFactor));
! 			dest[1]=(uint8_t) (g1+(pos*(g2-g1)/ScaleFactor));
! 			dest[2]=(uint8_t) (r1+(pos*(r2-r1)/ScaleFactor));
! 			dest[3]=(uint8_t) (a1+(pos*(a2-a1)/ScaleFactor));
  #else
  			__asm__(
--- 1543,1551 ----
  			// funny that's the same formula we use for
  			// alpha blending ;-)
!                         c  = SET_B(b1+(pos*(b2-b1)/ScaleFactor));
!                         c |= SET_G(g1+(pos*(g2-g1)/ScaleFactor));
!                         c |= SET_R(r1+(pos*(r2-r1)/ScaleFactor));
!                         c |= SET_A(a1+(pos*(a2-a1)/ScaleFactor));
!                         *dest=c;
  #else
  			__asm__(
***************
*** 1534,1538 ****
                         
                          pos +=new_pixel_width;
!                         dest+=4;
                  };
  		pixmap++;
--- 1562,1566 ----
                         
                          pos +=new_pixel_width;
!                         dest++;
                  };
  		pixmap++;
***************
*** 1543,1550 ****
  		g1=g2;
  		r1=r2;
! 		a2=pixmap->a;
! 		b2=pixmap->b;
! 		g2=pixmap->g;
! 		r2=pixmap->r;
  #else
  		__asm__(
--- 1571,1579 ----
  		g1=g2;
  		r1=r2;
!                 c=*pixmap;
! 		a2=GET_A(c);
! 		b2=GET_B(c);
! 		g2=GET_G(c);
! 		r2=GET_R(c);
  #else
  		__asm__(
***************
*** 1565,1569 ****
  #define SCALEUPDEBV(out...)  
  
! void cSoftOsd::ScaleUpVert_MMX(uint8_t *dest, int linesize, 
  		int32_t new_pixel_height, int start_pos,
                  color **pixmap, int Pixel) {
--- 1594,1598 ----
  #define SCALEUPDEBV(out...)  
  
! void cSoftOsd::ScaleUpVert_MMX(uint32_t *dest, int linesize, 
  		int32_t new_pixel_height, int start_pos,
                  color **pixmap, int Pixel) {
***************
*** 1573,1585 ****
          //const int ScaleFactor=100;
  #ifndef USE_MMX2
!         int16_t a1=0;
!         int16_t b1=0;
!         int16_t g1=0;
!         int16_t r1=0;
  
! 	int16_t a2=0;
!         int16_t b2=0;
!         int16_t g2=0;
!         int16_t r2=0;
  #else
          __asm__(
--- 1602,1615 ----
          //const int ScaleFactor=100;
  #ifndef USE_MMX2
!         int a1=0;
!         int b1=0;
!         int g1=0;
!         int r1=0;
  
! 	int a2=0;
!         int b2=0;
!         int g2=0;
!         int r2=0;
!         unsigned int c;
  #else
          __asm__(
***************
*** 1594,1606 ****
          while (currPixel<Pixel) {
  #ifndef USE_MMX2
! 		a1=pixmap[0][currPixel].a;
! 		b1=pixmap[0][currPixel].b;
! 		g1=pixmap[0][currPixel].g;
! 		r1=pixmap[0][currPixel].r;
  
! 		a2=pixmap[1][currPixel].a-a1;
! 		b2=pixmap[1][currPixel].b-b1;
! 		g2=pixmap[1][currPixel].g-g1;
! 		r2=pixmap[1][currPixel].r-r1;
  #else
                  __asm__(
--- 1624,1638 ----
          while (currPixel<Pixel) {
  #ifndef USE_MMX2
!                 c=pixmap[0][currPixel];
! 		a1=GET_A(c);
! 		b1=GET_B(c);
! 		g1=GET_G(c);
! 		r1=GET_R(c);
  
!                 c=pixmap[1][currPixel];
! 		a2=GET_A(c)-a1;
! 		b2=GET_B(c)-b1;
! 		g2=GET_G(c)-g1;
! 		r2=GET_R(c)-r1;
  #else
                  __asm__(
***************
*** 1619,1631 ****
                          //SCALEUPDEBV("while loop pixel: %d pos: %d, row %d\n",
  			//		currPixel,pos,ypos);
! #ifndef USE_MMX2                       
! 			dest[ypos*linesize+currPixel*4+0]=
! 				(uint8_t) (b1+(pos*(b2)/ScaleFactor));
! 			dest[ypos*linesize+currPixel*4+1]=
! 				(uint8_t) (g1+(pos*(g2)/ScaleFactor));
! 			dest[ypos*linesize+currPixel*4+2]=
! 				(uint8_t) (r1+(pos*(r2)/ScaleFactor));
! 			dest[ypos*linesize+currPixel*4+3]=
! 				(uint8_t) (a1+(pos*(a2)/ScaleFactor));
  #else
  			__asm__(
--- 1651,1660 ----
                          //SCALEUPDEBV("while loop pixel: %d pos: %d, row %d\n",
  			//		currPixel,pos,ypos);
! #ifndef USE_MMX2       
!                         c  = SET_B(b1+(pos*(b2)/ScaleFactor));
!                         c |= SET_G(g1+(pos*(g2)/ScaleFactor));
!                         c |= SET_R(r1+(pos*(r2)/ScaleFactor));
!                         c |= SET_A(a1+(pos*(a2)/ScaleFactor));
!                         dest[ypos*linesize+currPixel]=c;
  #else
  			__asm__(
***************
*** 1639,1643 ****
  				" movd %%mm0,(%1) \n"
  				: : "r" (pos),
! 				"r" (&dest[ypos*linesize+currPixel*4]) );
  #endif
                         
--- 1668,1672 ----
  				" movd %%mm0,(%1) \n"
  				: : "r" (pos),
! 				"r" (&dest[ypos*linesize+currPixel]) );
  #endif
                         

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** SoftOsd.h	1 Apr 2006 08:26:56 -0000	1.6
--- SoftOsd.h	10 Jul 2006 18:23:28 -0000	1.7
***************
*** 40,44 ****
--- 40,53 ----
  #define COLOR_RGB16(r,g,b) (((b >> 3)& 0x1F) | ((g & 0xF8) << 2)| ((r & 0xF8)<<10) )
  
+ #define GET_A(x) ((x) >> 24 & 0xFF)
+ #define GET_R(x) ((x) >> 16 & 0xFF)
+ #define GET_G(x) ((x) >>  8 & 0xFF)
+ #define GET_B(x) ((x) >>  0 & 0xFF)
  
+ #define SET_A(x) ((x) << 24 & 0xFF000000)
+ #define SET_R(x) ((x) << 16 & 0x00FF0000)
+ #define SET_G(x) ((x) <<  8 & 0x0000FF00)
+ #define SET_B(x) ((x) <<  0 & 0x000000FF)
+ /*
  struct color {
      unsigned char b;
***************
*** 47,50 ****
--- 56,61 ----
      unsigned char a;
  };
+ */
+ typedef uint32_t color;
  
  class cVideoOut;
***************
*** 95,99 ****
      virtual void Action();
      
!     static void ARGB_to_AYUV(uint8_t * dest, color * pixmap, int Pixel);
      static void ARGB_to_ARGB32(uint8_t * dest, color * pixmap, int Pixel);
      static void ARGB_to_RGB32(uint8_t * dest, color * pixmap, int Pixel);
--- 106,110 ----
      virtual void Action();
      
!     static void ARGB_to_AYUV(uint32_t * dest, color * pixmap, int Pixel);
      static void ARGB_to_ARGB32(uint8_t * dest, color * pixmap, int Pixel);
      static void ARGB_to_RGB32(uint8_t * dest, color * pixmap, int Pixel);
***************
*** 142,152 ****
      
   private:
!     void NoScaleHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
!     void ScaleUpHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
!     void ScaleDownHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
!     void ScaleDownVert_MMX(uint8_t * dest, int linesize, int32_t new_pixel_height, 
                  int start_pos,
                  color ** pixmap, int Pixel);
!     void ScaleUpVert_MMX(uint8_t *dest, int linesize, int32_t new_pixel_height, 
                  int start_pos,
                  color **pixmap, int Pixel);
--- 153,163 ----
      
   private:
!     void NoScaleHoriz_MMX(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
!     void ScaleUpHoriz_MMX(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
!     void ScaleDownHoriz_MMX(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
!     void ScaleDownVert_MMX(uint32_t * dest, int linesize, int32_t new_pixel_height, 
                  int start_pos,
                  color ** pixmap, int Pixel);
!     void ScaleUpVert_MMX(uint32_t *dest, int linesize, int32_t new_pixel_height, 
                  int start_pos,
                  color **pixmap, int Pixel);



From nobody at sheep.berlios.de  Mon Jul 10 20:50:48 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 10 Jul 2006 20:50:48 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.207,1.208 softdevice.c,1.61,1.62 video.c,1.58,1.59
Message-ID: <200607101850.k6AIomY20904@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18002

Modified Files:
	CHANGELOG softdevice.c video.c 
Log Message:
- remove uneeded include of "sys/mman.h" and "sys/ioctl.h" from video.c
- set max_width and max_height for temporary PicBuffer
- remove uneeded include of "linux/fb.h" from softdevice.c 


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.207
retrieving revision 1.208
diff -C2 -d -r1.207 -r1.208
*** CHANGELOG	10 Jul 2006 18:23:28 -0000	1.207
--- CHANGELOG	10 Jul 2006 18:50:45 -0000	1.208
***************
*** 1,4 ****
--- 1,7 ----
  Changelog
  2006-07-10:
+    - remove uneeded include of "sys/mman.h" and "sys/ioctl.h" from video.c
+    - set max_width and max_height for temporary PicBuffer
+    - remove uneeded include of "linux/fb.h" from softdevice.c 
     - fix possible endianness problems in SoftOsd.c
     - add support for yuy2 pixel format to alpha blend and copy pic buf code

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.61
retrieving revision 1.62
diff -C2 -d -r1.61 -r1.62
*** softdevice.c	17 Jun 2006 16:27:35 -0000	1.61
--- softdevice.c	10 Jul 2006 18:50:45 -0000	1.62
***************
*** 24,28 ****
  #include <sys/mman.h>
  #include <sys/ioctl.h>
- #include <linux/fb.h>
  #include "video-dummy.h"
  
--- 24,27 ----

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.58
retrieving revision 1.59
diff -C2 -d -r1.58 -r1.59
*** video.c	27 May 2006 19:12:41 -0000	1.58
--- video.c	10 Jul 2006 18:50:45 -0000	1.59
***************
*** 7,12 ****
   */
  
- #include <sys/mman.h>
- #include <sys/ioctl.h>
  #include <fcntl.h>
  #include <string.h>
--- 7,10 ----
***************
*** 125,130 ****
          tmpBuf.stride[0]=OSD_FULL_WIDTH;
          tmpBuf.stride[1]=tmpBuf.stride[2]=OSD_FULL_WIDTH/2;
!         tmpBuf.width=OSD_FULL_WIDTH;
!         tmpBuf.height=OSD_FULL_HEIGHT;
          tmpBuf.aspect_ratio=((float)OSD_FULL_HEIGHT)/((float)OSD_FULL_WIDTH);
          tmpBuf.aspect_ratio=((float)OSD_FULL_WIDTH)/((float)OSD_FULL_HEIGHT);
--- 123,128 ----
          tmpBuf.stride[0]=OSD_FULL_WIDTH;
          tmpBuf.stride[1]=tmpBuf.stride[2]=OSD_FULL_WIDTH/2;
!         tmpBuf.max_width=tmpBuf.width=OSD_FULL_WIDTH;
!         tmpBuf.max_height=tmpBuf.height=OSD_FULL_HEIGHT;
          tmpBuf.aspect_ratio=((float)OSD_FULL_HEIGHT)/((float)OSD_FULL_WIDTH);
          tmpBuf.aspect_ratio=((float)OSD_FULL_WIDTH)/((float)OSD_FULL_HEIGHT);



From nobody at sheep.berlios.de  Mon Jul 10 21:40:28 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 10 Jul 2006 21:40:28 +0200
Subject: [Softdevice-cvs] softdevice audio-alsa.c,NONE,1.1 audio-alsa.h,NONE,1.1 audio.c,1.25,1.26 audio.h,1.11,1.12 Makefile,1.32,1.33 configure,1.19,1.20 CHANGELOG,1.208,1.209
Message-ID: <200607101940.k6AJeSY23110@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23230

Modified Files:
	audio.c audio.h Makefile configure CHANGELOG 
Added Files:
	audio-alsa.c audio-alsa.h 
Log Message:
- move alsa related stuff into a separate file, enable build without alsa 
  support
     


--- NEW FILE: audio-alsa.c ---
/*
 * audio-alsa.c: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: audio-alsa.c,v 1.1 2006/07/10 19:40:25 wachm Exp $
 */
#include "audio-alsa.h"

#define ALSA_PCM_NEW_HW_PARAMS_API
#define ALSA_PCM_NEW_SW_PARAMS_API
#include <alsa/asoundlib.h>

#define PCM_FMT SND_PCM_FORMAT_S16_LE
#define NO_MIXER

//#define AUDIODEB(out...) {printf("AUDIO-ALSA[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}

#ifndef AUDIODEB
#define AUDIODEB(out...)
#endif


/*--------------------------------------------------------------------------
*/
cAlsaAudioOut::cAlsaAudioOut(cSetupStore *setupStore) {
    int err;

    if (strlen(setupStore->alsaDevice) == 0)
      strcpy (setupStore->alsaDevice, "default");
    dsyslog("[softdevice-audio] Opening alsa device %s",setupStore->alsaDevice);
    device = setupStore->alsaDevice;

    if (strlen(setupStore->alsaAC3Device) == 0)
      strcpy (setupStore->alsaAC3Device, "hw:0,1");
    dsyslog("[softdevice-audio] Using alsa AC3 device %s",
            setupStore->alsaAC3Device);
    ac3Device = setupStore->alsaAC3Device;

    paused=false;
    ac3PassThrough = false;
    ac3SpdifPro = false;

    if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
      esyslog("[softdevice-audio] Playback open error: %s, %s FATAL exiting",
              device, snd_strerror(err));
      exit(1);
    }
    oldContext.channels = currContext.channels=0;
    oldContext.samplerate = currContext.samplerate=48000;
    dsyslog("[softdevice-audio] Device opened! Ready to play");
    scale_Factor=0x7FFF;
}

/* ----------------------------------------------------------------------------
 */
cAlsaAudioOut::~cAlsaAudioOut()
{
  if (handle)
    snd_pcm_close(handle);
  handle = NULL;
}

/* ----------------------------------------------------------------------------
 */
void cAlsaAudioOut::Suspend()
{
  if (handle)
    snd_pcm_close(handle);
  handle = NULL;
}

/* ----------------------------------------------------------------------------
 */
bool cAlsaAudioOut::Resume() {
   int err;
   printf("Device %s\n",device);
   if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK,SND_PCM_NONBLOCK )) < 0) {
     esyslog("[softdevice-audio] Playback open error: %s, %s ",
             device, snd_strerror(err));
     return false;
   }
   //force setting of the parameters after resume 
   currContext.channels=0;
   return true;
};

/* ----------------------------------------------------------------------------
 */
  
void cAlsaAudioOut::Write(uchar *Data, int Length)
{
    int     err;
    size_t  size;

  AUDIODEB("Write %p %d\n",Data,Length);

  handleMutex.Lock();
  if (ac3PassThrough)
  {
    ac3PassThrough = false;
    SetAC3PassThroughMode(ac3PassThrough);
  }
  handleMutex.Unlock();

  if (!currContext.channels)
    size = Length / (2 * 2);
  else
    size = Length/(2*currContext.channels);

#ifdef NO_MIXER
  // change the volume
  Scale((int16_t*)Data,Length/2,scale_Factor);
#endif

  while (size) {
    while (paused) usleep(1000); // block
    AUDIODEB("pcm_mmap_writei  handle %p Data %p size %d\n",handle,Data,size);
    err = snd_pcm_mmap_writei(handle,Data, size);
    AUDIODEB("pcm_mmap_writeei return value %d Data %p size %d \n",
                   err,Data,size);
    if (err == -EAGAIN || (err >= 0 && (size_t)err < size)) {
      AUDIODEB("wait \n");
      snd_pcm_wait(handle, 1000);
    } else if (err == -EPIPE) {
      AUDIODEB("Xrun \n");
      Xrun();
      dsyslog("[softdevice-audio]: xrun");
    } else if (err == -ESTRPIPE) {
      //suspend();
      AUDIODEB("Suspend \n");
      dsyslog("[softdevice-audio]: Suspend");
    } else if (err == -EINTR) {
      dsyslog ("[softdevice-audio]: EINTR");
      AUDIODEB("EINTR \n");
      return;
    } else if (err < 0) {
      dsyslog("[softdevice-audio]: write error: %s FATAL exiting",
              snd_strerror(err));
      exit(EXIT_FAILURE);
    }

    if (err > 0 ) {
      if (!currContext.channels)
        Data += err * 2 * 2;
      else
        Data += err * 2 * currContext.channels;
      size -=err;
    };
  }
  AUDIODEB("Write end\n");
}

/* ----------------------------------------------------------------------------
 */
bool
cAlsaAudioOut::SetAC3PassThroughMode(bool on)
{
  if (on)
  {
    oldContext = currContext;

    if (handle)
      snd_pcm_close(handle);
    handle = NULL;

    // open S/P-DIF
    if (ac3pt.SpdifInitAC3(&handle, ac3Device, ac3SpdifPro) == 0)
    {
      currContext.channels = 0;
      return true;
    }
    currContext = oldContext;
    esyslog("[softdevice-audio] AC3 open error:");
  }
  return false;
}

/* ----------------------------------------------------------------------------
 */
void cAlsaAudioOut::WriteAC3(uchar *Data, int Length)
{
  handleMutex.Lock();
  if (!ac3PassThrough)
  {
    ac3PassThrough = true;
    SetAC3PassThroughMode(ac3PassThrough);
  }
  handleMutex.Unlock();

  ac3pt.SpdifBurstAC3 (&handle, Data, Length);
}

/* ----------------------------------------------------------------------------
 */
void cAlsaAudioOut::Pause(void) {
    //    snd_pcm_pause(handle,1);
    dsyslog("[softdevice-audio]: Should pause now");
    paused=true;
}

/* ----------------------------------------------------------------------------
 */
void cAlsaAudioOut::Play(void) {
//    snd_pcm_pause(handle,0);
    paused=false;
}

/* ----------------------------------------------------------------------------
 */
int cAlsaAudioOut::GetDelay(void) {
    int               res = 0;
    snd_pcm_sframes_t r;

  handleMutex.Lock();
  if (!handle) {
          handleMutex.Unlock();
          return 0;
  };

  if ( snd_pcm_state(handle) != SND_PCM_STATE_RUNNING ) {
          handleMutex.Unlock();
          return 0;
  };
          
  if (!snd_pcm_delay(handle, &r) &&
      currContext.samplerate) {
    // successfully got delay
    res = (long) r * 10000 / currContext.samplerate;
    AUDIODEB("GetDelay %d\n",res);
  }
  handleMutex.Unlock();
  return res;
}

/* ----------------------------------------------------------------------------
 * I/O error handler
 */
void cAlsaAudioOut::Xrun(void)
{
	snd_pcm_status_t *status;
	int res;
	snd_pcm_status_alloca(&status);
        //printf("alsa-audio: Xrun\n");
	if ((res = snd_pcm_status(handle, status))<0) {
    esyslog("[softdevice-audio]: Xrun status error: %s FATAL exiting",
            snd_strerror(res));
		exit(EXIT_FAILURE);
	}
	if (snd_pcm_status_get_state(status) == SND_PCM_STATE_XRUN) {
//		snd_pcm_status_get_trigger_tstamp(status, &tstamp);
		if ((res = snd_pcm_prepare(handle))<0) {
      esyslog("[softdevice-audio]: Xrun prepare error: %s FATAL exiting",
              snd_strerror(res));
			exit(EXIT_FAILURE);
		}
		return;		/* ok, data should be accepted again */
	}

//	error("read/write error, state = %s", snd_pcm_state_name(snd_pcm_status_get_state(status)));
  esyslog("[softdevice-audio]: read/write error FATAL exiting");
	exit(EXIT_FAILURE);
}

/* ----------------------------------------------------------------------------
 */
int cAlsaAudioOut::SetParams(SampleContext &context)
//int cAlsaAudioOut::SetParams(int channels, unsigned int samplerate)
{
      int err;

    // not needed to set again
    //if ((chn == channels) && (rate == samplerate)) return 0;
    if (currContext.samplerate == context.samplerate &&
        currContext.channels == context.channels ) {
      context=currContext;
      return 0;
    };
    //printf("alsa-audio: SetParams\n");
    currContext=context;
 
    handleMutex.Lock();
    snd_pcm_close(handle);
    if ((err = snd_pcm_open(&handle,
                            device,
                            SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
      esyslog("[softdevice-audio] Playback reopen error: %s, %s FATAL exiting",
              device, snd_strerror(err));
      exit(1);
    }

    dsyslog ("[softdevice-audio] samplerate: %dHz, channels: #%d",
             currContext.samplerate, currContext.channels);
    //rate=samplerate;
    //chn=channels;
    snd_pcm_hw_params_t *params;
    snd_pcm_sw_params_t *swparams;
    snd_pcm_uframes_t xfer_align;
    snd_pcm_hw_params_alloca(&params);
    snd_pcm_sw_params_alloca(&swparams);

    err = snd_pcm_hw_params_any(handle, params);
    if (err < 0) {
      esyslog("[softdevice-audio] Broken config for this PCM: no configurations available");
      exit(EXIT_FAILURE);
    }

    snd_pcm_access_mask_t *mask = (snd_pcm_access_mask_t *)alloca(snd_pcm_access_mask_sizeof());
    snd_pcm_access_mask_none(mask);
    snd_pcm_access_mask_set(mask, SND_PCM_ACCESS_MMAP_INTERLEAVED);
    snd_pcm_access_mask_set(mask, SND_PCM_ACCESS_MMAP_NONINTERLEAVED);
    snd_pcm_access_mask_set(mask, SND_PCM_ACCESS_MMAP_COMPLEX);
    err = snd_pcm_hw_params_set_access_mask(handle, params, mask);
    if (err < 0) {
      esyslog("[softdevice-audio] Access type not available FATAL exiting");
      exit(EXIT_FAILURE);
    }

    err = snd_pcm_hw_params_set_format(handle, params, PCM_FMT);
    if (err < 0) {
      esyslog("[softdevice-audio] Sample format non available FATAL exiting");
      exit(EXIT_FAILURE);
    }

    err = snd_pcm_hw_params_set_channels(handle, params,currContext.channels);
    if (err < 0) {
      esyslog("[softdevice-audio] Channels count non available FATAL exiting");
      exit(EXIT_FAILURE);
    }

    err = snd_pcm_hw_params_set_rate_near(handle, params, &currContext.samplerate, 0);
    assert(err >= 0);
    if (currContext.samplerate != context.samplerate ) {
      esyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",context.samplerate,currContext.samplerate);
      exit(1);
    }

    // set period size
    snd_pcm_uframes_t bufferSize;
    snd_pcm_uframes_t periodSize;
    //periodSize = 8;
    periodSize = 4608 / 4;
    err = snd_pcm_hw_params_set_period_size_near(handle, params, &periodSize, 0);
    if ( err < 0)  {
      esyslog("[softdevice-audio] Failed to set period size!");
      exit(1);
    }

    snd_pcm_uframes_t buffersize = 2 * 4608;

    err = snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffersize);
    if ( err < 0 ) {
      esyslog("[softdevice-audio] Failed to set buffer size!");
      exit(1);
    }

    err = snd_pcm_hw_params(handle, params);
    if (err < 0) {
      esyslog("[softdevice-audio] Unable to install hw params: FATAL exiting");
      exit(EXIT_FAILURE);
    }

    snd_pcm_hw_params_get_period_size(params, &periodSize, 0);
    snd_pcm_hw_params_get_buffer_size(params, &bufferSize);
    if (periodSize == bufferSize) {
      esyslog("[softdevice-audio] Can't use period equal to buffer size (%lu == %lu) FATAL exiting",
              periodSize, bufferSize);
      exit(EXIT_FAILURE);
    }
    dsyslog("[softdevice-audio] Period size %lu Buffer size %lu",
            periodSize, bufferSize);

    currContext.buffer_size=bufferSize;
    currContext.period_size=periodSize;

    snd_pcm_sw_params_current(handle, swparams);
    err = snd_pcm_sw_params_get_xfer_align(swparams, &xfer_align);
    if (err < 0) {
      esyslog("[softdevice-audio] Unable to obtain xfer align FATAL exiting");
      exit(EXIT_FAILURE);
    }
    dsyslog("[softdevice-audio] Hardware initialized");
    handleMutex.Unlock();

    context=currContext;
    return 0;
}

/* ----------------------------------------------------------------------------
 */
void cAlsaAudioOut::SetVolume (int vol)
{
#ifdef NO_MIXER
  scale_Factor = CalcScaleFactor(vol);
  //printf("vol %d scale_Factor 0x%04x\n",vol,scale_Factor);
  //scale_Factor = vol;
#else
    int                   err;
    long                  mixerMin, mixerMax,
                          setVol;
    double                mixerRange,
                          volPercent;
    char                  *mName = "PCM",
                          *cardName = "default";
    snd_mixer_t           *mHandle;
    snd_mixer_elem_t      *mElem;
    snd_mixer_selem_id_t  *sId;

  snd_mixer_selem_id_alloca(&sId);
  snd_mixer_selem_id_set_name(sId, mName);
  if ((err = snd_mixer_open(&mHandle, 0)) < 0) {
      static int once = 0;
    if (!once) {
      dsyslog("[softdevice-audio]: cannot open mixer: %s (%s)",
              mName,snd_strerror(err));
      once = 1;
    }
    return;
  }

  snd_mixer_attach(mHandle, cardName);
  snd_mixer_selem_register(mHandle, NULL, NULL);
  snd_mixer_load(mHandle);
  mElem = snd_mixer_find_selem(mHandle,sId);
  /* --------------------------------------------------------------------------
   * some cards don't have any master volume. so check return value
   */
  if (mElem)
  {
    snd_mixer_selem_get_playback_volume_range(mElem,&mixerMin,&mixerMax);
    mixerRange = mixerMax - mixerMin;
    volPercent = (double) vol / 255.0;
    setVol = (int) (((double)mixerMin+(mixerRange*volPercent))+0.5);
    snd_mixer_selem_set_playback_volume(mElem,SND_MIXER_SCHN_FRONT_LEFT,setVol);
    snd_mixer_selem_set_playback_volume(mElem,SND_MIXER_SCHN_FRONT_RIGHT,setVol);
    if (snd_mixer_selem_has_playback_switch(mElem))
    {
      snd_mixer_selem_set_playback_switch_all(mElem, (vol) ? 1 : 0);
    }
  }

  snd_mixer_close(mHandle);
#endif
}


--- NEW FILE: audio-alsa.h ---
/*
 * audio-alsa.h: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: audio-alsa.h,v 1.1 2006/07/10 19:40:25 wachm Exp $
 */
#ifndef __AUDIO_ALSA_H__
#define __AUDIO_ALSA_H__

#define ALSA_PCM_NEW_HW_PARAMS_API
#define ALSA_PCM_NEW_SW_PARAMS_API
#include <alsa/asoundlib.h>
#include <vdr/plugin.h>

#include "audio.h"
#include "audio-ac3pt.h"

/* ---------------------------------------------------------------------------
 */
class cAlsaAudioOut : public cAudioOut  {
private:
  cMutex            handleMutex;
  snd_pcm_t         *handle;
  char              *device,
                    *ac3Device;
  volatile bool     paused;
  bool              ac3PassThrough,
                    ac3SpdifPro;
  SampleContext     oldContext;
  cAlsaAC3pt        ac3pt;

  bool  SetAC3PassThroughMode(bool on);
  void  Xrun(void);
  int scale_Factor;

protected:
public:
  cAlsaAudioOut(cSetupStore *setupStore);
  virtual ~cAlsaAudioOut();

  virtual void  Write(uchar *Data, int Length);
  virtual void  WriteAC3(uchar *Data, int Length);
  //virtual int SetParams(int channels, unsigned int samplerate);
  virtual int   SetParams(SampleContext &context);
  virtual int   GetDelay(void);
  virtual void  Pause(void);
  virtual void  Play(void);
  virtual void  SetVolume(int vol);
  virtual void  Suspend(void);
  virtual bool  Resume(void);
};


#endif 

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** audio.c	27 Apr 2006 20:32:58 -0000	1.25
--- audio.c	10 Jul 2006 19:40:25 -0000	1.26
***************
*** 10,23 ****
  #include <stdlib.h>
  #include <stdio.h>
- #include <math.h>
  
- #define ALSA_PCM_NEW_HW_PARAMS_API
- #define ALSA_PCM_NEW_SW_PARAMS_API
- #include <alsa/asoundlib.h>
  #include "audio.h"
  #include "utils.h"
  
- #define PCM_FMT SND_PCM_FORMAT_S16_LE
- #define NO_MIXER
  
  //#define AUDIODEB(out...) {printf("AUDIO[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
--- 10,17 ----
***************
*** 30,95 ****
  }
  
- cAlsaAudioOut::cAlsaAudioOut(cSetupStore *setupStore) {
-     int err;
- 
-     if (strlen(setupStore->alsaDevice) == 0)
-       strcpy (setupStore->alsaDevice, "default");
-     dsyslog("[softdevice-audio] Opening alsa device %s",setupStore->alsaDevice);
-     device = setupStore->alsaDevice;
- 
-     if (strlen(setupStore->alsaAC3Device) == 0)
-       strcpy (setupStore->alsaAC3Device, "hw:0,1");
-     dsyslog("[softdevice-audio] Using alsa AC3 device %s",
-             setupStore->alsaAC3Device);
-     ac3Device = setupStore->alsaAC3Device;
- 
-     paused=false;
-     ac3PassThrough = false;
-     ac3SpdifPro = false;
- 
-     if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
-       esyslog("[softdevice-audio] Playback open error: %s, %s FATAL exiting",
-               device, snd_strerror(err));
-       exit(1);
-     }
-     oldContext.channels = currContext.channels=0;
-     oldContext.samplerate = currContext.samplerate=48000;
-     dsyslog("[softdevice-audio] Device opened! Ready to play");
-     scale_Factor=0x7FFF;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- cAlsaAudioOut::~cAlsaAudioOut()
- {
-   if (handle)
-     snd_pcm_close(handle);
-   handle = NULL;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- void cAlsaAudioOut::Suspend()
- {
-   if (handle)
-     snd_pcm_close(handle);
-   handle = NULL;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- bool cAlsaAudioOut::Resume() {
-    int err;
-    printf("Device %s\n",device);
-    if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK,SND_PCM_NONBLOCK )) < 0) {
-      esyslog("[softdevice-audio] Playback open error: %s, %s ",
-              device, snd_strerror(err));
-      return false;
-    }
-    //force setting of the parameters after resume 
-    currContext.channels=0;
-    return true;
- };
- 
  /* ----------------------------------------------------------------------------
   */
--- 24,27 ----
***************
*** 104,464 ****
    };
  };
-   
- void cAlsaAudioOut::Write(uchar *Data, int Length)
- {
-     int     err;
-     size_t  size;
- 
-   AUDIODEB("Write %p %d\n",Data,Length);
- 
-   handleMutex.Lock();
-   if (ac3PassThrough)
-   {
-     ac3PassThrough = false;
-     SetAC3PassThroughMode(ac3PassThrough);
-   }
-   handleMutex.Unlock();
- 
-   if (!currContext.channels)
-     size = Length / (2 * 2);
-   else
-     size = Length/(2*currContext.channels);
- 
- #ifdef NO_MIXER
-   // change the volume
-   Scale((int16_t*)Data,Length/2,scale_Factor);
- #endif
- 
-   while (size) {
-     while (paused) usleep(1000); // block
-     AUDIODEB("pcm_mmap_writei  handle %p Data %p size %d\n",handle,Data,size);
-     err = snd_pcm_mmap_writei(handle,Data, size);
-     AUDIODEB("pcm_mmap_writeei return value %d Data %p size %d \n",
-                    err,Data,size);
-     if (err == -EAGAIN || (err >= 0 && (size_t)err < size)) {
-       AUDIODEB("wait \n");
-       snd_pcm_wait(handle, 1000);
-     } else if (err == -EPIPE) {
-       AUDIODEB("Xrun \n");
-       Xrun();
-       dsyslog("[softdevice-audio]: xrun");
-     } else if (err == -ESTRPIPE) {
-       //suspend();
-       AUDIODEB("Suspend \n");
-       dsyslog("[softdevice-audio]: Suspend");
-     } else if (err == -EINTR) {
-       dsyslog ("[softdevice-audio]: EINTR");
-       AUDIODEB("EINTR \n");
-       return;
-     } else if (err < 0) {
-       dsyslog("[softdevice-audio]: write error: %s FATAL exiting",
-               snd_strerror(err));
-       exit(EXIT_FAILURE);
-     }
- 
-     if (err > 0 ) {
-       if (!currContext.channels)
-         Data += err * 2 * 2;
-       else
-         Data += err * 2 * currContext.channels;
-       size -=err;
-     };
-   }
-   AUDIODEB("Write end\n");
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- bool
- cAlsaAudioOut::SetAC3PassThroughMode(bool on)
- {
-   if (on)
-   {
-     oldContext = currContext;
- 
-     if (handle)
-       snd_pcm_close(handle);
-     handle = NULL;
- 
-     // open S/P-DIF
-     if (ac3pt.SpdifInitAC3(&handle, ac3Device, ac3SpdifPro) == 0)
-     {
-       currContext.channels = 0;
-       return true;
-     }
-     currContext = oldContext;
-     esyslog("[softdevice-audio] AC3 open error:");
-   }
-   return false;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- void cAlsaAudioOut::WriteAC3(uchar *Data, int Length)
- {
-   handleMutex.Lock();
-   if (!ac3PassThrough)
-   {
-     ac3PassThrough = true;
-     SetAC3PassThroughMode(ac3PassThrough);
-   }
-   handleMutex.Unlock();
- 
-   ac3pt.SpdifBurstAC3 (&handle, Data, Length);
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- void cAlsaAudioOut::Pause(void) {
-     //    snd_pcm_pause(handle,1);
-     dsyslog("[softdevice-audio]: Should pause now");
-     paused=true;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- void cAlsaAudioOut::Play(void) {
- //    snd_pcm_pause(handle,0);
-     paused=false;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- int cAlsaAudioOut::GetDelay(void) {
-     int               res = 0;
-     snd_pcm_sframes_t r;
- 
-   handleMutex.Lock();
-   if (!handle) {
-           handleMutex.Unlock();
-           return 0;
-   };
- 
-   if ( snd_pcm_state(handle) != SND_PCM_STATE_RUNNING ) {
-           handleMutex.Unlock();
-           return 0;
-   };
-           
-   if (!snd_pcm_delay(handle, &r) &&
-       currContext.samplerate) {
-     // successfully got delay
-     res = (long) r * 10000 / currContext.samplerate;
-     AUDIODEB("GetDelay %d\n",res);
-   }
-   handleMutex.Unlock();
-   return res;
- }
- 
- /* ----------------------------------------------------------------------------
-  * I/O error handler
-  */
- void cAlsaAudioOut::Xrun(void)
- {
- 	snd_pcm_status_t *status;
- 	int res;
- 	snd_pcm_status_alloca(&status);
-         //printf("alsa-audio: Xrun\n");
- 	if ((res = snd_pcm_status(handle, status))<0) {
-     esyslog("[softdevice-audio]: Xrun status error: %s FATAL exiting",
-             snd_strerror(res));
- 		exit(EXIT_FAILURE);
- 	}
- 	if (snd_pcm_status_get_state(status) == SND_PCM_STATE_XRUN) {
- //		snd_pcm_status_get_trigger_tstamp(status, &tstamp);
- 		if ((res = snd_pcm_prepare(handle))<0) {
-       esyslog("[softdevice-audio]: Xrun prepare error: %s FATAL exiting",
-               snd_strerror(res));
- 			exit(EXIT_FAILURE);
- 		}
- 		return;		/* ok, data should be accepted again */
- 	}
- 
- //	error("read/write error, state = %s", snd_pcm_state_name(snd_pcm_status_get_state(status)));
-   esyslog("[softdevice-audio]: read/write error FATAL exiting");
- 	exit(EXIT_FAILURE);
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- int cAlsaAudioOut::SetParams(SampleContext &context)
- //int cAlsaAudioOut::SetParams(int channels, unsigned int samplerate)
- {
-       int err;
- 
-     // not needed to set again
-     //if ((chn == channels) && (rate == samplerate)) return 0;
-     if (currContext.samplerate == context.samplerate &&
-         currContext.channels == context.channels ) {
-       context=currContext;
-       return 0;
-     };
-     //printf("alsa-audio: SetParams\n");
-     currContext=context;
-  
-     handleMutex.Lock();
-     snd_pcm_close(handle);
-     if ((err = snd_pcm_open(&handle,
-                             device,
-                             SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
-       esyslog("[softdevice-audio] Playback reopen error: %s, %s FATAL exiting",
-               device, snd_strerror(err));
-       exit(1);
-     }
- 
-     dsyslog ("[softdevice-audio] samplerate: %dHz, channels: #%d",
-              currContext.samplerate, currContext.channels);
-     //rate=samplerate;
-     //chn=channels;
-     snd_pcm_hw_params_t *params;
-     snd_pcm_sw_params_t *swparams;
-     snd_pcm_uframes_t xfer_align;
-     snd_pcm_hw_params_alloca(&params);
-     snd_pcm_sw_params_alloca(&swparams);
- 
-     err = snd_pcm_hw_params_any(handle, params);
-     if (err < 0) {
-       esyslog("[softdevice-audio] Broken config for this PCM: no configurations available");
-       exit(EXIT_FAILURE);
-     }
- 
-     snd_pcm_access_mask_t *mask = (snd_pcm_access_mask_t *)alloca(snd_pcm_access_mask_sizeof());
-     snd_pcm_access_mask_none(mask);
-     snd_pcm_access_mask_set(mask, SND_PCM_ACCESS_MMAP_INTERLEAVED);
-     snd_pcm_access_mask_set(mask, SND_PCM_ACCESS_MMAP_NONINTERLEAVED);
-     snd_pcm_access_mask_set(mask, SND_PCM_ACCESS_MMAP_COMPLEX);
-     err = snd_pcm_hw_params_set_access_mask(handle, params, mask);
-     if (err < 0) {
-       esyslog("[softdevice-audio] Access type not available FATAL exiting");
-       exit(EXIT_FAILURE);
-     }
- 
-     err = snd_pcm_hw_params_set_format(handle, params, PCM_FMT);
-     if (err < 0) {
-       esyslog("[softdevice-audio] Sample format non available FATAL exiting");
-       exit(EXIT_FAILURE);
-     }
- 
-     err = snd_pcm_hw_params_set_channels(handle, params,currContext.channels);
-     if (err < 0) {
-       esyslog("[softdevice-audio] Channels count non available FATAL exiting");
-       exit(EXIT_FAILURE);
-     }
- 
-     err = snd_pcm_hw_params_set_rate_near(handle, params, &currContext.samplerate, 0);
-     assert(err >= 0);
-     if (currContext.samplerate != context.samplerate ) {
-       esyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",context.samplerate,currContext.samplerate);
-       exit(1);
-     }
- 
-     // set period size
-     snd_pcm_uframes_t bufferSize;
-     snd_pcm_uframes_t periodSize;
-     //periodSize = 8;
-     periodSize = 4608 / 4;
-     err = snd_pcm_hw_params_set_period_size_near(handle, params, &periodSize, 0);
-     if ( err < 0)  {
-       esyslog("[softdevice-audio] Failed to set period size!");
-       exit(1);
-     }
- 
-     snd_pcm_uframes_t buffersize = 2 * 4608;
- 
-     err = snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffersize);
-     if ( err < 0 ) {
-       esyslog("[softdevice-audio] Failed to set buffer size!");
-       exit(1);
-     }
- 
-     err = snd_pcm_hw_params(handle, params);
-     if (err < 0) {
-       esyslog("[softdevice-audio] Unable to install hw params: FATAL exiting");
-       exit(EXIT_FAILURE);
-     }
- 
-     snd_pcm_hw_params_get_period_size(params, &periodSize, 0);
-     snd_pcm_hw_params_get_buffer_size(params, &bufferSize);
-     if (periodSize == bufferSize) {
-       esyslog("[softdevice-audio] Can't use period equal to buffer size (%lu == %lu) FATAL exiting",
-               periodSize, bufferSize);
-       exit(EXIT_FAILURE);
-     }
-     dsyslog("[softdevice-audio] Period size %lu Buffer size %lu",
-             periodSize, bufferSize);
- 
-     currContext.buffer_size=bufferSize;
-     currContext.period_size=periodSize;
- 
-     snd_pcm_sw_params_current(handle, swparams);
-     err = snd_pcm_sw_params_get_xfer_align(swparams, &xfer_align);
-     if (err < 0) {
-       esyslog("[softdevice-audio] Unable to obtain xfer align FATAL exiting");
-       exit(EXIT_FAILURE);
-     }
-     dsyslog("[softdevice-audio] Hardware initialized");
-     handleMutex.Unlock();
- 
-     context=currContext;
-     return 0;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
- void cAlsaAudioOut::SetVolume (int vol)
- {
- #ifdef NO_MIXER
-   if (vol>0)
-           scale_Factor = (int) (pow(10.0, -2.3+2.3*vol/256.0)*0x7FFF);
-   else scale_Factor = 0;
-   //printf("vol %d scale_Factor 0x%04x\n",vol,scale_Factor);
-   //scale_Factor = vol;
- #else
-     int                   err;
-     long                  mixerMin, mixerMax,
-                           setVol;
-     double                mixerRange,
-                           volPercent;
-     char                  *mName = "PCM",
-                           *cardName = "default";
-     snd_mixer_t           *mHandle;
-     snd_mixer_elem_t      *mElem;
-     snd_mixer_selem_id_t  *sId;
- 
-   snd_mixer_selem_id_alloca(&sId);
-   snd_mixer_selem_id_set_name(sId, mName);
-   if ((err = snd_mixer_open(&mHandle, 0)) < 0) {
-       static int once = 0;
-     if (!once) {
-       dsyslog("[softdevice-audio]: cannot open mixer: %s (%s)",
-               mName,snd_strerror(err));
-       once = 1;
-     }
-     return;
-   }
- 
-   snd_mixer_attach(mHandle, cardName);
-   snd_mixer_selem_register(mHandle, NULL, NULL);
-   snd_mixer_load(mHandle);
-   mElem = snd_mixer_find_selem(mHandle,sId);
-   /* --------------------------------------------------------------------------
-    * some cards don't have any master volume. so check return value
-    */
-   if (mElem)
-   {
-     snd_mixer_selem_get_playback_volume_range(mElem,&mixerMin,&mixerMax);
-     mixerRange = mixerMax - mixerMin;
-     volPercent = (double) vol / 255.0;
-     setVol = (int) (((double)mixerMin+(mixerRange*volPercent))+0.5);
-     snd_mixer_selem_set_playback_volume(mElem,SND_MIXER_SCHN_FRONT_LEFT,setVol);
-     snd_mixer_selem_set_playback_volume(mElem,SND_MIXER_SCHN_FRONT_RIGHT,setVol);
-     if (snd_mixer_selem_has_playback_switch(mElem))
-     {
-       snd_mixer_selem_set_playback_switch_all(mElem, (vol) ? 1 : 0);
-     }
-   }
- 
-   snd_mixer_close(mHandle);
- #endif
- }
  
  /* ---------------------------------------------------------------------------
--- 36,39 ----
***************
*** 467,471 ****
  {
    paused=false;
!   dsyslog("[softdevice-audio-dummy] Device opened! Ready to play");
  }
  
--- 42,46 ----
  {
    paused=false;
!   dsyslog("[softdevice-audio-dummy] Device opened! Using dummy device -> no audio!");
  }
  
***************
*** 501,505 ****
  int cDummyAudioOut::GetDelay(void)
  {
!   return 0;
  }
  
--- 76,80 ----
  int cDummyAudioOut::GetDelay(void)
  {
!   return -1;
  }
  

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** audio.h	27 Apr 2006 20:32:58 -0000	1.11
--- audio.h	10 Jul 2006 19:40:25 -0000	1.12
***************
*** 9,18 ****
  #define AUDIO_H
  
! #define ALSA_PCM_NEW_HW_PARAMS_API
! #define ALSA_PCM_NEW_SW_PARAMS_API
! #include <alsa/asoundlib.h>
  #include <vdr/plugin.h>
  #include "setup-softdevice.h"
- #include "audio-ac3pt.h"
  
  struct SampleContext {
--- 9,16 ----
  #define AUDIO_H
  
! #include <math.h>
! 
  #include <vdr/plugin.h>
  #include "setup-softdevice.h"
  
  struct SampleContext {
***************
*** 24,27 ****
--- 22,33 ----
  };
  
+ 
+ void Scale(int16_t *Data, int size,int scale_Factor);
+ // scaling of auido data (changing the volume)
+ 
+ static inline int CalcScaleFactor(int vol) 
+ { return (vol <= 0 ? 0 
+           : (int) (pow(10.0, -2.3+2.3*vol/256.0)*0x7FFF)); };
+ 
  /* ---------------------------------------------------------------------------
   * Abstract class for an audio device
***************
*** 45,84 ****
    virtual bool Resume(void)
    {return true;};
- };
- 
- 
- /* ---------------------------------------------------------------------------
-  */
- class cAlsaAudioOut : public cAudioOut  {
- private:
-   cMutex            handleMutex;
-   snd_pcm_t         *handle;
-   char              *device,
-                     *ac3Device;
-   volatile bool     paused;
-   bool              ac3PassThrough,
-                     ac3SpdifPro;
-   SampleContext     oldContext;
-   cAlsaAC3pt        ac3pt;
- 
-   bool  SetAC3PassThroughMode(bool on);
-   void  Xrun(void);
-   int scale_Factor;
- 
- protected:
- public:
-   cAlsaAudioOut(cSetupStore *setupStore);
-   virtual ~cAlsaAudioOut();
- 
-   virtual void  Write(uchar *Data, int Length);
-   virtual void  WriteAC3(uchar *Data, int Length);
-   //virtual int SetParams(int channels, unsigned int samplerate);
-   virtual int   SetParams(SampleContext &context);
-   virtual int   GetDelay(void);
-   virtual void  Pause(void);
-   virtual void  Play(void);
-   virtual void  SetVolume(int vol);
-   virtual void  Suspend(void);
-   virtual bool  Resume(void);
  };
  
--- 51,54 ----

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** Makefile	18 Jun 2006 07:16:06 -0000	1.32
--- Makefile	10 Jul 2006 19:40:25 -0000	1.33
***************
*** 58,61 ****
--- 58,64 ----
  LIBXDPMS_SUPPORT = 1
  
+ # Set this if you want to use alsa audio
+ ALSA_SUPPORT = 1
+ 
  # Set this if you want to be able to toggle suspend mode by keyboard (XV only)
  SUSPEND_BY_KEY = 1
***************
*** 174,177 ****
--- 177,184 ----
  endif
  
+ ifdef ALSA_SUPPORT
+   DEFINES += -DALSA_SUPPORT
+ endif
+ 
  # #############################################################################
  # end of section without configure
***************
*** 219,226 ****
  
  TARGETS = libvdr-$(PLUGIN).so
! LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o setup-softdevice-menu.o sync-timer.o SoftOsd.o PicBuffer.o VideoFilter.o
  ALL_OBJS = $(OBJS)
  
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
--- 226,238 ----
  
  TARGETS = libvdr-$(PLUGIN).so
! LIBS = $(FFMPEGLIBS)
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o setup-softdevice-menu.o sync-timer.o SoftOsd.o PicBuffer.o VideoFilter.o
  ALL_OBJS = $(OBJS)
  
+ ifdef ALSA_SUPPORT
+   LIBS += -lasound
+   OBJS += audio-alsa.o audio-ac3pt.o
+ endif
+   
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** configure	18 Jun 2006 07:16:06 -0000	1.19
--- configure	10 Jul 2006 19:40:25 -0000	1.20
***************
*** 36,39 ****
--- 36,40 ----
  with_mmx2="yes"
  cle266="yes"
+ alsa="yes"
  
  function help () {
***************
*** 48,51 ****
--- 49,53 ----
    echo "  --disable-mmx"
    echo "  --disable-mmx2"
+   echo "  --disable-alsa"
    echo "  --with-ffmpeg-path YOUR_FFMPEG_PATH"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
***************
*** 67,70 ****
--- 69,73 ----
      --disable-mmx) shift; with_mmx="no";;
      --disable-mmx2) shift; with_mmx2="no";;
+     --disable-alsa) shift; alsa="no";;
      --with-ffmpeg-path) shift;
        ffmpeg_path=$1 ;
***************
*** 148,151 ****
--- 151,180 ----
  
  echo "Ok."
+ ########################################################
+ # check for ALSA
+ echo -n "Checking for ALSA sound... "
+ echo "Checking for ALSA sound.------------------" >> config.log
+ 
+ if test "${alsa}" = "yes" ; then
+ cat > ${TMPC} << EOF
+ #define ALSA_PCM_NEW_HW_PARAMS_API
+ #define ALSA_PCM_NEW_SW_PARAMS_API
+ #include <alsa/asoundlib.h>
+ int main(void) {
+   snd_pcm_t         *handle;
+   char device[]="hw:0,1";
+   snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0); 
+   return 0;
+ }
+ EOF
+ $cc $CFLAGS -lasound -o $TMPE $TMPC >> config.log 2>&1 || alsa="no"
+ fi
+ 
+ if test "${alsa}" = "yes" ; then
+ echo "Enabled audio-alsa."
+ else
+ echo "Not Found."
+ fi
+ 
  #########################################################
  # start of DirectFB specific tests
***************
*** 405,408 ****
--- 434,444 ----
  fi
  
+ ###############################################################################
+ # alsa defines
+ #
+ if test "${alsa}" = "yes" ; then
+   echo "ALSA_SUPPORT = 1" >> $TMPM
+   echo "#define ALSA_SUPPORT 1" >> $TMPH
+ fi
  
  ###############################################################################

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.208
retrieving revision 1.209
diff -C2 -d -r1.208 -r1.209
*** CHANGELOG	10 Jul 2006 18:50:45 -0000	1.208
--- CHANGELOG	10 Jul 2006 19:40:25 -0000	1.209
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2006-07-10:
+    - move alsa related stuff into a separate file, enable build without alsa 
+      support
     - remove uneeded include of "sys/mman.h" and "sys/ioctl.h" from video.c
     - set max_width and max_height for temporary PicBuffer



From nobody at sheep.berlios.de  Mon Jul 10 21:54:36 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 10 Jul 2006 21:54:36 +0200
Subject: [Softdevice-cvs] softdevice softdevice.c,1.62,1.63
Message-ID: <200607101954.k6AJsaY23623@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24863

Modified Files:
	softdevice.c 
Log Message:
- move alsa related stuff into a separate file, enable build without alsa 
  support


Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.62
retrieving revision 1.63
diff -C2 -d -r1.62 -r1.63
*** softdevice.c	10 Jul 2006 18:50:45 -0000	1.62
--- softdevice.c	10 Jul 2006 19:54:34 -0000	1.63
***************
*** 73,76 ****
--- 73,80 ----
  #endif
  
+ #ifdef ALSA_SUPPORT
+ #include "audio-alsa.h"
+ #endif
+ 
  #include "audio.h"
  #include "mpeg2decoder.h"
***************
*** 278,283 ****
--- 282,291 ----
      switch (audioMethod) {
        case AOUT_ALSA:
+ #ifdef ALSA_SUPPORT
          audioOut=new cAlsaAudioOut(&setupStore);
          break;
+ #else
+         fprintf(stderr,"[softdevice] No alsa support compiled in. Using dummy-audio\n");
+ #endif
        case AOUT_DUMMY:
          audioOut=new cDummyAudioOut(&setupStore);
***************
*** 687,692 ****
--- 695,702 ----
    // Return a string that describes all known command line options.
    return
+ #ifdef ALSA_SUPPORT
    "  -ao alsa:pcm=dev_name#   alsa output device for analog and PCM out\n"
    "  -ao alsa:ac3=dev_name#   alsa output device for AC3 passthrough\n"
+ #endif
    "  -ao dummy:               dummy output device\n"
  #ifdef XV_SUPPORT



From nobody at sheep.berlios.de  Tue Jul 11 22:31:40 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 11 Jul 2006 22:31:40 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.209,1.210 softdevice.c,1.63,1.64
Message-ID: <200607112031.k6BKVeY17250@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3539

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
- remove the no longer in ffmpeg defined FFMPEG_VERSION



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.209
retrieving revision 1.210
diff -C2 -d -r1.209 -r1.210
*** CHANGELOG	10 Jul 2006 19:40:25 -0000	1.209
--- CHANGELOG	11 Jul 2006 20:31:37 -0000	1.210
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-07-11:
+    - remove no longer defined FFMPEG_VERSION string
  2006-07-10:
     - move alsa related stuff into a separate file, enable build without alsa 

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.63
retrieving revision 1.64
diff -C2 -d -r1.63 -r1.64
*** softdevice.c	10 Jul 2006 19:54:34 -0000	1.63
--- softdevice.c	11 Jul 2006 20:31:37 -0000	1.64
***************
*** 191,196 ****
      fprintf(stderr,"[softdevice] Initializing Video Out\n");
      fprintf(stderr,
!             "[softdevice] ffmpeg version(%s) build(%d)\n",
!             FFMPEG_VERSION, LIBAVCODEC_BUILD);
      setupStore.outputMethod = method;
  #ifdef USE_SUBPLUGINS
--- 191,196 ----
      fprintf(stderr,"[softdevice] Initializing Video Out\n");
      fprintf(stderr,
!             "[softdevice] ffmpeg build(%d)\n",
!              LIBAVCODEC_BUILD);
      setupStore.outputMethod = method;
  #ifdef USE_SUBPLUGINS



From nobody at sheep.berlios.de  Wed Jul 12 20:40:20 2006
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 12 Jul 2006 20:40:20 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.210,1.211 video.c,1.59,1.60
Message-ID: <200607121840.k6CIeKY30896@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2061

Modified Files:
	CHANGELOG video.c 
Log Message:
fix segfault in OSD refresher

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.210
retrieving revision 1.211
diff -C2 -d -r1.210 -r1.211
*** CHANGELOG	11 Jul 2006 20:31:37 -0000	1.210
--- CHANGELOG	12 Jul 2006 18:40:16 -0000	1.211
***************
*** 1,14 ****
  Changelog
! 2006-07-11:
!    - remove no longer defined FFMPEG_VERSION string
  2006-07-10:
!    - move alsa related stuff into a separate file, enable build without alsa 
!      support
!    - remove uneeded include of "sys/mman.h" and "sys/ioctl.h" from video.c
!    - set max_width and max_height for temporary PicBuffer
!    - remove uneeded include of "linux/fb.h" from softdevice.c 
!    - fix possible endianness problems in SoftOsd.c
!    - add support for yuy2 pixel format to alpha blend and copy pic buf code
!    - change return value of AllocPicBuffer()
     - change the parameters of yv12_to_yuy2_il_mmx() so that it can also be used
       for not interlaced pictures
--- 1,16 ----
  Changelog
! 2006-07-12:
!    - fix segfault in OSD refresher.
! 2006-07-11:
!    - remove no longer defined FFMPEG_VERSION string
  2006-07-10:
!    - move alsa related stuff into a separate file, enable build without alsa
!      support
!    - remove uneeded include of "sys/mman.h" and "sys/ioctl.h" from video.c
!    - set max_width and max_height for temporary PicBuffer
!    - remove uneeded include of "linux/fb.h" from softdevice.c
!    - fix possible endianness problems in SoftOsd.c
!    - add support for yuy2 pixel format to alpha blend and copy pic buf code
!    - change return value of AllocPicBuffer()
     - change the parameters of yv12_to_yuy2_il_mmx() so that it can also be used
       for not interlaced pictures

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.59
retrieving revision 1.60
diff -C2 -d -r1.59 -r1.60
*** video.c	10 Jul 2006 18:50:45 -0000	1.59
--- video.c	12 Jul 2006 18:40:16 -0000	1.60
***************
*** 118,121 ****
--- 118,123 ----
        {
          sPicBuffer tmpBuf;
+ 
+         memset (&tmpBuf, 0, sizeof (sPicBuffer));
          tmpBuf.pixel[0]=OsdPy;
          tmpBuf.pixel[1]=OsdPu;
***************
*** 148,152 ****
       old_picture=picture;
    } else old_picture = NULL;
!   
    //osdMutex.Unlock();
  }
--- 150,154 ----
       old_picture=picture;
    } else old_picture = NULL;
! 
    //osdMutex.Unlock();
  }
***************
*** 445,450 ****
    CheckAspectDimensions(pic);
    Sync(syncTimer, delay);
!   
!   // display picture 
    YUV(pic);
    SetOldPicture(pic);
--- 447,452 ----
    CheckAspectDimensions(pic);
    Sync(syncTimer, delay);
! 
!   // display picture
    YUV(pic);
    SetOldPicture(pic);



From nobody at sheep.berlios.de  Sun Jul 16 04:09:42 2006
From: nobody at sheep.berlios.de (iampivot)
Date: Sun, 16 Jul 2006 04:09:42 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-xv.c, 1.56, 1.57 CHANGELOG, 1.211,
	1.212
Message-ID: <20060716020942.79D985491E@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24396

Modified Files:
	video-xv.c CHANGELOG 
Log Message:
unconditionally set _NET_WM_FULLSCREEN Atom when going fullscreen (recent Metacity WM need it)


Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** video-xv.c	9 Jun 2006 16:24:34 -0000	1.56
--- video-xv.c	16 Jul 2006 02:09:22 -0000	1.57
***************
*** 408,415 ****
    if (net_wm_STATE_ABOVE)
      e.xclient.data.l[1] = net_wm_STATE_ABOVE;
-   else if (net_wm_STATE_FULLSCREEN)
-     e.xclient.data.l[1] = net_wm_STATE_FULLSCREEN;
    else //if (net_wm_STATE_STAYS_ON_TOP)
      e.xclient.data.l[1] = net_wm_STATE_STAYS_ON_TOP;
    XSendEvent(dpy, DefaultRootWindow(dpy), False, SubstructureRedirectMask, &e);
  
--- 408,415 ----
    if (net_wm_STATE_ABOVE)
      e.xclient.data.l[1] = net_wm_STATE_ABOVE;
    else //if (net_wm_STATE_STAYS_ON_TOP)
      e.xclient.data.l[1] = net_wm_STATE_STAYS_ON_TOP;
+   if (net_wm_STATE_FULLSCREEN)
+     e.xclient.data.l[1] = net_wm_STATE_FULLSCREEN;
    XSendEvent(dpy, DefaultRootWindow(dpy), False, SubstructureRedirectMask, &e);
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.211
retrieving revision 1.212
diff -C2 -d -r1.211 -r1.212
*** CHANGELOG	12 Jul 2006 18:40:16 -0000	1.211
--- CHANGELOG	16 Jul 2006 02:09:22 -0000	1.212
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-07-16:
+    - unconditionally set _NET_WM_FULLSCREEN Atom when going fullscreen (recent Metacity WM need it)
  2006-07-12:
     - fix segfault in OSD refresher.



From nobody at sheep.berlios.de  Sun Jul 16 13:22:06 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 16 Jul 2006 13:22:06 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.212, 1.213 configure, 1.20,
	1.21
Message-ID: <20060716112206.8E074555B2@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14288

Modified Files:
	CHANGELOG configure 
Log Message:
- check explicitly for pkg-config in configure
- configure: "--with-ffmpeg-path" overrides pkg-config


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.212
retrieving revision 1.213
diff -C2 -d -r1.212 -r1.213
*** CHANGELOG	16 Jul 2006 02:09:22 -0000	1.212
--- CHANGELOG	16 Jul 2006 11:22:00 -0000	1.213
***************
*** 1,4 ****
  Changelog
! 2006-07-16:
     - unconditionally set _NET_WM_FULLSCREEN Atom when going fullscreen (recent Metacity WM need it)
  2006-07-12:
--- 1,6 ----
  Changelog
! 2006-07-16:
!    - check explicitly for pkg-config in configure
!    - configure: "--with-ffmpeg-path" overrides pkg-config
     - unconditionally set _NET_WM_FULLSCREEN Atom when going fullscreen (recent Metacity WM need it)
  2006-07-12:

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** configure	10 Jul 2006 19:40:25 -0000	1.20
--- configure	16 Jul 2006 11:22:00 -0000	1.21
***************
*** 21,25 ****
--- 21,27 ----
  : ${CFLAGS=""}
  
+ use_pkgconfig="yes"
  ffmpeg="yes"
+ ffmpeg_use_path="no"
  dfb="yes"
  libpostproc="no"
***************
*** 72,75 ****
--- 74,78 ----
      --with-ffmpeg-path) shift;
        ffmpeg_path=$1 ;
+       ffmpeg_use_path="yes" ;
        echo "ffmpeg path set to: $ffmpeg_path" ;
        shift ;;
***************
*** 84,87 ****
--- 87,108 ----
  
  #########################################################
+ # start pkg-config test
+ #
+ if test "${use_pkgconfig}" = "yes" ; then
+   echo -n "Checking for pkg-config... "
+   echo  "Checking for pkg-config.-------------------------------" >> config.log
+         
+   pkg-config --version >> config.log 2>&1 || use_pkgconfig="no";
+   
+   if test "${use_pkgconfig}" = "no" ; then
+     echo "Not found."
+     echo "Please consider installing pkg-config. Many parts of this configure"
+     echo "rely on pkg-config to find the parameters of the needed libraries."
+   else
+     echo "Found."
+   fi
+ fi
+ 
+ #########################################################
  # start ffmpeg test
  #
***************
*** 112,115 ****
--- 133,140 ----
  };
  
+ ffmpeg="no" # = not yet configured 
+ if test "${use_pkgconfig}" = "yes" ; then
+   if test "${ffmpeg_use_path}" = "no" ; then
+ 
  echo "try to use pkg-config." >> config.log
  ffmpeg_l1="libavcodec libavformat"
***************
*** 123,126 ****
--- 148,154 ----
  test_ffmpeg
  
+   fi
+ fi
+ 
  if test "${ffmpeg}" = "no" ; then
    echo "pkg-config failed, try the default/parameter path." >> config.log
***************
*** 144,148 ****
      echo "No usable ffmpeg library found in ${ffmpeg_path}."
      echo "Specify the path to your ffmpeg installation using --with-ffmpeg-path"
!     echo "or use a more recent (cvs) version of ffmpeg with pkg-config."
      echo "For details check config.log."
      exit 8;
--- 172,176 ----
      echo "No usable ffmpeg library found in ${ffmpeg_path}."
      echo "Specify the path to your ffmpeg installation using --with-ffmpeg-path"
!     echo "or use a more recent (svn) version of ffmpeg and use/install pkg-config."
      echo "For details check config.log."
      exit 8;
***************
*** 151,154 ****
--- 179,183 ----
  
  echo "Ok."
+ 
  ########################################################
  # check for ALSA



From nobody at sheep.berlios.de  Sun Jul 16 13:35:41 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 16 Jul 2006 13:35:41 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.213, 1.214 configure, 1.21,
	1.22
Message-ID: <20060716113541.2845C5A59F@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18286

Modified Files:
	CHANGELOG configure 
Log Message:
- only link against libXi if necessary ( do we need libXi at all?)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.213
retrieving revision 1.214
diff -C2 -d -r1.213 -r1.214
*** CHANGELOG	16 Jul 2006 11:22:00 -0000	1.213
--- CHANGELOG	16 Jul 2006 11:35:36 -0000	1.214
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-07-16:
+    - only link against libXi if necessary ( do we need libXi at all?)
     - check explicitly for pkg-config in configure
     - configure: "--with-ffmpeg-path" overrides pkg-config

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** configure	16 Jul 2006 11:22:00 -0000	1.21
--- configure	16 Jul 2006 11:35:36 -0000	1.22
***************
*** 350,355 ****
  echo  "Checking for Xv.-----------------------------" >> config.log
  
! if test "${xv}" = "yes" ; then
!   xv_libs="-L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv"
    cat > ${TMPC} << EOF
  #include <stdio.h>
--- 350,356 ----
  echo  "Checking for Xv.-----------------------------" >> config.log
  
! test_xv()
! {
!   xv="yes"
    cat > ${TMPC} << EOF
  #include <stdio.h>
***************
*** 361,365 ****
  }
  EOF
! $cc $CFLAGS $xv_libs -o $TMPE $TMPC >> config.log 2>&1 || xv="no"
  fi
  
--- 362,378 ----
  }
  EOF
!   $cc $CFLAGS $xv_libs -o $TMPE $TMPC >> config.log 2>&1 || xv="no"
! };
! 
! if test "${xv}" = "yes" ; then
!   xv_libs="-L/usr/X11R6/lib -lXext -lX11 -lm -lXv"
!   test_xv();
! 
!   if test "${xv}" = "no" ; then
!     # do we need libXi at all?
!     echo "Xv test failed. Maybe -lXi is needed?" >> config.log
!     xv_libs+=" -lXi"
!     test_xv();
!   fi
  fi
  



From nobody at sheep.berlios.de  Sun Jul 16 15:04:20 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 16 Jul 2006 15:04:20 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice configure,1.22,1.23
Message-ID: <20060716130420.A746B598AC@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12542

Modified Files:
	configure 
Log Message:
- remove (); from bash script


Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** configure	16 Jul 2006 11:35:36 -0000	1.22
--- configure	16 Jul 2006 13:04:15 -0000	1.23
***************
*** 367,371 ****
  if test "${xv}" = "yes" ; then
    xv_libs="-L/usr/X11R6/lib -lXext -lX11 -lm -lXv"
!   test_xv();
  
    if test "${xv}" = "no" ; then
--- 367,371 ----
  if test "${xv}" = "yes" ; then
    xv_libs="-L/usr/X11R6/lib -lXext -lX11 -lm -lXv"
!   test_xv
  
    if test "${xv}" = "no" ; then
***************
*** 373,377 ****
      echo "Xv test failed. Maybe -lXi is needed?" >> config.log
      xv_libs+=" -lXi"
!     test_xv();
    fi
  fi
--- 373,377 ----
      echo "Xv test failed. Maybe -lXi is needed?" >> config.log
      xv_libs+=" -lXi"
!     test_xv
    fi
  fi



From nobody at sheep.berlios.de  Tue Jul 25 21:45:46 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 25 Jul 2006 21:45:46 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.214, 1.215 audio-alsa.c,
	1.1, 1.2
Message-ID: <20060725194546.D69C35CD75@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25151

Modified Files:
	CHANGELOG audio-alsa.c 
Log Message:
- no longer exit when a audio mode is not available, audio is only disabled.
- clean up audio-alsa
   


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.214
retrieving revision 1.215
diff -C2 -d -r1.214 -r1.215
*** CHANGELOG	16 Jul 2006 11:35:36 -0000	1.214
--- CHANGELOG	25 Jul 2006 19:45:37 -0000	1.215
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-07-25:
+    - no longer exit when a audio mode is not available, audio is only disabled.
+    - clean up audio-alsa
  2006-07-16:
     - only link against libXi if necessary ( do we need libXi at all?)

Index: audio-alsa.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-alsa.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** audio-alsa.c	10 Jul 2006 19:40:25 -0000	1.1
--- audio-alsa.c	25 Jul 2006 19:45:37 -0000	1.2
***************
*** 75,79 ****
  bool cAlsaAudioOut::Resume() {
     int err;
!    printf("Device %s\n",device);
     if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK,SND_PCM_NONBLOCK )) < 0) {
       esyslog("[softdevice-audio] Playback open error: %s, %s ",
--- 75,79 ----
  bool cAlsaAudioOut::Resume() {
     int err;
!    AUDIODEB("Device %s\n",device);
     if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK,SND_PCM_NONBLOCK )) < 0) {
       esyslog("[softdevice-audio] Playback open error: %s, %s ",
***************
*** 96,99 ****
--- 96,102 ----
    AUDIODEB("Write %p %d\n",Data,Length);
  
+   if (!handle)
+           return;
+ 
    handleMutex.Lock();
    if (ac3PassThrough)
***************
*** 265,275 ****
  /* ----------------------------------------------------------------------------
   */
! int cAlsaAudioOut::SetParams(SampleContext &context)
! //int cAlsaAudioOut::SetParams(int channels, unsigned int samplerate)
! {
        int err;
  
      // not needed to set again
-     //if ((chn == channels) && (rate == samplerate)) return 0;
      if (currContext.samplerate == context.samplerate &&
          currContext.channels == context.channels ) {
--- 268,275 ----
  /* ----------------------------------------------------------------------------
   */
! int cAlsaAudioOut::SetParams(SampleContext &context) {
        int err;
  
      // not needed to set again
      if (currContext.samplerate == context.samplerate &&
          currContext.channels == context.channels ) {
***************
*** 281,285 ****
   
      handleMutex.Lock();
!     snd_pcm_close(handle);
      if ((err = snd_pcm_open(&handle,
                              device,
--- 281,288 ----
   
      handleMutex.Lock();
!     
!     if (handle) 
!             snd_pcm_close(handle);
!     
      if ((err = snd_pcm_open(&handle,
                              device,
***************
*** 287,297 ****
        esyslog("[softdevice-audio] Playback reopen error: %s, %s FATAL exiting",
                device, snd_strerror(err));
!       exit(1);
      }
  
      dsyslog ("[softdevice-audio] samplerate: %dHz, channels: #%d",
               currContext.samplerate, currContext.channels);
-     //rate=samplerate;
-     //chn=channels;
      snd_pcm_hw_params_t *params;
      snd_pcm_sw_params_t *swparams;
--- 290,301 ----
        esyslog("[softdevice-audio] Playback reopen error: %s, %s FATAL exiting",
                device, snd_strerror(err));
!       // should we close handle?
!       handle = NULL;
!       handleMutex.Unlock();
!       return -1;
      }
  
      dsyslog ("[softdevice-audio] samplerate: %dHz, channels: #%d",
               currContext.samplerate, currContext.channels);
      snd_pcm_hw_params_t *params;
      snd_pcm_sw_params_t *swparams;
***************
*** 303,306 ****
--- 307,311 ----
      if (err < 0) {
        esyslog("[softdevice-audio] Broken config for this PCM: no configurations available");
+       handleMutex.Unlock();
        exit(EXIT_FAILURE);
      }
***************
*** 313,330 ****
      err = snd_pcm_hw_params_set_access_mask(handle, params, mask);
      if (err < 0) {
!       esyslog("[softdevice-audio] Access type not available FATAL exiting");
!       exit(EXIT_FAILURE);
      }
  
      err = snd_pcm_hw_params_set_format(handle, params, PCM_FMT);
      if (err < 0) {
!       esyslog("[softdevice-audio] Sample format non available FATAL exiting");
!       exit(EXIT_FAILURE);
      }
  
      err = snd_pcm_hw_params_set_channels(handle, params,currContext.channels);
      if (err < 0) {
!       esyslog("[softdevice-audio] Channels count non available FATAL exiting");
!       exit(EXIT_FAILURE);
      }
  
--- 318,341 ----
      err = snd_pcm_hw_params_set_access_mask(handle, params, mask);
      if (err < 0) {
!       esyslog("[softdevice-audio] Access type not available NO AUDIO!");
!       handleMutex.Unlock();
!       Suspend();
!       return -1;
      }
  
      err = snd_pcm_hw_params_set_format(handle, params, PCM_FMT);
      if (err < 0) {
!       esyslog("[softdevice-audio] Sample format non available NO AUDIO!");
!       handleMutex.Unlock();
!       Suspend();
!       return -1;
      }
  
      err = snd_pcm_hw_params_set_channels(handle, params,currContext.channels);
      if (err < 0) {
!       esyslog("[softdevice-audio] Channels count non available NO AUDIO");
!       handleMutex.Unlock();
!       Suspend();
!       return -1;
      }
  
***************
*** 332,337 ****
      assert(err >= 0);
      if (currContext.samplerate != context.samplerate ) {
!       esyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",context.samplerate,currContext.samplerate);
!       exit(1);
      }
  
--- 343,350 ----
      assert(err >= 0);
      if (currContext.samplerate != context.samplerate ) {
!       esyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) NO AUDIO!",context.samplerate,currContext.samplerate);
!       handleMutex.Unlock();
!       Suspend();
!       return -1;
      }
  
***************
*** 343,348 ****
      err = snd_pcm_hw_params_set_period_size_near(handle, params, &periodSize, 0);
      if ( err < 0)  {
!       esyslog("[softdevice-audio] Failed to set period size!");
!       exit(1);
      }
  
--- 356,363 ----
      err = snd_pcm_hw_params_set_period_size_near(handle, params, &periodSize, 0);
      if ( err < 0)  {
!       esyslog("[softdevice-audio] Failed to set period size! NO AUDIO!");
!       handleMutex.Unlock();
!       Suspend();
!       return -1;
      }
  
***************
*** 351,356 ****
      err = snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffersize);
      if ( err < 0 ) {
!       esyslog("[softdevice-audio] Failed to set buffer size!");
!       exit(1);
      }
  
--- 366,373 ----
      err = snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffersize);
      if ( err < 0 ) {
!       esyslog("[softdevice-audio] Failed to set buffer size! NO AUDIO");
!       handleMutex.Unlock();
!       Suspend();
!       return -1;
      }
  
***************
*** 358,361 ****
--- 375,379 ----
      if (err < 0) {
        esyslog("[softdevice-audio] Unable to install hw params: FATAL exiting");
+       handleMutex.Unlock();
        exit(EXIT_FAILURE);
      }
***************
*** 366,369 ****
--- 384,388 ----
        esyslog("[softdevice-audio] Can't use period equal to buffer size (%lu == %lu) FATAL exiting",
                periodSize, bufferSize);
+       handleMutex.Unlock();
        exit(EXIT_FAILURE);
      }
***************
*** 378,381 ****
--- 397,401 ----
      if (err < 0) {
        esyslog("[softdevice-audio] Unable to obtain xfer align FATAL exiting");
+       handleMutex.Unlock();
        exit(EXIT_FAILURE);
      }



From nobody at sheep.berlios.de  Tue Jul 25 21:47:52 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 25 Jul 2006 21:47:52 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.215, 1.216 video-dfb.c,
	1.68, 1.69
Message-ID: <20060725194752.1E9155B3BF@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25766

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
- init tmpOsdSurface and delete dirtyLines properly


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.215
retrieving revision 1.216
diff -C2 -d -r1.215 -r1.216
*** CHANGELOG	25 Jul 2006 19:45:37 -0000	1.215
--- CHANGELOG	25 Jul 2006 19:47:41 -0000	1.216
***************
*** 3,6 ****
--- 3,7 ----
     - no longer exit when a audio mode is not available, audio is only disabled.
     - clean up audio-alsa
+    - init tmpOsdSurface and delete dirtyLines properly
  2006-07-16:
     - only link against libXi if necessary ( do we need libXi at all?)

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.68
retrieving revision 1.69
diff -C2 -d -r1.68 -r1.69
*** video-dfb.c	25 Jun 2006 13:46:12 -0000	1.68
--- video-dfb.c	25 Jul 2006 19:47:41 -0000	1.69
***************
*** 277,280 ****
--- 277,281 ----
    sheight = fheight = 576;
  
+   tmpOsdSurface = NULL;
    screenPixelAspect = -1;
    currentPixelFormat = setupStore->pixelFormat;
***************
*** 1060,1063 ****
--- 1061,1065 ----
    osd = NULL;
    stride = 0;
+   tmpOsdSurface = NULL;
  
    if (!videoInitialized)
***************
*** 1071,1074 ****
--- 1073,1077 ----
      tmpOsdSurface = (useStretchBlit) ? osdSurface : scrSurface;
      tmpOsdSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
+     //printf("GetLockOsdSurface %p\n",tmpOsdSurface);fflush(stdout);
      osd=dst;stride=pitch;
    }
***************
*** 1128,1132 ****
    }
    //printf("CommitUnlockOsdSurface %p 4\n",tmpOsdSurface);fflush(stdout);
!   free(dirtyLines);
    dirtyLines=NULL;
    tmpOsdSurface=NULL;
--- 1131,1135 ----
    }
    //printf("CommitUnlockOsdSurface %p 4\n",tmpOsdSurface);fflush(stdout);
!   delete[] dirtyLines;
    dirtyLines=NULL;
    tmpOsdSurface=NULL;



From nobody at sheep.berlios.de  Tue Jul 25 21:58:20 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 25 Jul 2006 21:58:20 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.216,
	1.217 setup-softdevice.c, 1.45, 1.46 setup-softdevice.h, 1.32,
	1.33 softdevice.c, 1.64, 1.65 video-xv.c, 1.57,
	1.58 video-xv.h, 1.21, 1.22
Message-ID: <20060725195820.82D1F5C3E4@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28951

Modified Files:
	CHANGELOG setup-softdevice.c setup-softdevice.h softdevice.c 
	video-xv.c video-xv.h 
Log Message:
- try to use the XVideo default brightness, hue etc. values on first start
- new option: "-vo xv:use-defaults", can be used to reset the values
  of brightness, hue etc. to the default values. (Based on a patch
  by Matthias Schwarzott)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.216
retrieving revision 1.217
diff -C2 -d -r1.216 -r1.217
*** CHANGELOG	25 Jul 2006 19:47:41 -0000	1.216
--- CHANGELOG	25 Jul 2006 19:58:12 -0000	1.217
***************
*** 4,7 ****
--- 4,11 ----
     - clean up audio-alsa
     - init tmpOsdSurface and delete dirtyLines properly
+    - try to use the XVideo default brightness, hue etc. values on first start
+    - new option: "-vo xv:use-defaults", can be used to reset the values
+      of brightness, hue etc. to the default values. (Based on a patch
+      by Matthias Schwarzott)
  2006-07-16:
     - only link against libXi if necessary ( do we need libXi at all?)

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** setup-softdevice.c	25 Jun 2006 13:46:12 -0000	1.45
--- setup-softdevice.c	25 Jul 2006 19:58:12 -0000	1.46
***************
*** 92,95 ****
--- 92,97 ----
    xvAspect      = 1;   // XV_FORMAT_NORMAL;
    xvMaxArea     = 0;
+   xvFullscreen  = 0;
+   xvUseDefaults = 0;
    outputMethod  = 0;
    cropMode      = 0;
***************
*** 120,124 ****
    syncTimerMode = 2;
    vidCaps = 0;
!   vidBrightness = vidHue = vidContrast = vidSaturation = VID_MAX_PARM_VALUE / 2;
  
    /* --------------------------------------------------------------------------
--- 122,126 ----
    syncTimerMode = 2;
    vidCaps = 0;
!   vidBrightness = vidHue = vidContrast = vidSaturation = -1;
  
    /* --------------------------------------------------------------------------
***************
*** 361,377 ****
    } else if (!strcasecmp(Name, "vidBrightness")) {
      vidBrightness = atoi (Value);
!     vidBrightness = clamp (0, vidBrightness, 100);
      fprintf(stderr, "[setup-softdevice] vidBrightness: %d\n", vidBrightness);
    } else if (!strcasecmp(Name, "vidContrast")) {
      vidContrast = atoi (Value);
!     vidContrast = clamp (0, vidContrast, 100);
      fprintf(stderr, "[setup-softdevice] vidContrast: %d\n", vidContrast);
    } else if (!strcasecmp(Name, "vidHue")) {
      vidHue = atoi (Value);
!     vidHue = clamp (0, vidHue, 100);
      fprintf(stderr, "[setup-softdevice] vidHue: %d\n", vidHue);
    } else if (!strcasecmp(Name, "vidSaturation")) {
      vidSaturation = atoi (Value);
!     vidSaturation = clamp (0, vidSaturation, 100);
      fprintf(stderr, "[setup-softdevice] vidSaturation: %d\n", vidSaturation);
    }  else
--- 363,379 ----
    } else if (!strcasecmp(Name, "vidBrightness")) {
      vidBrightness = atoi (Value);
!     vidBrightness = clamp (-1, vidBrightness, 100);
      fprintf(stderr, "[setup-softdevice] vidBrightness: %d\n", vidBrightness);
    } else if (!strcasecmp(Name, "vidContrast")) {
      vidContrast = atoi (Value);
!     vidContrast = clamp (-1, vidContrast, 100);
      fprintf(stderr, "[setup-softdevice] vidContrast: %d\n", vidContrast);
    } else if (!strcasecmp(Name, "vidHue")) {
      vidHue = atoi (Value);
!     vidHue = clamp (-1, vidHue, 100);
      fprintf(stderr, "[setup-softdevice] vidHue: %d\n", vidHue);
    } else if (!strcasecmp(Name, "vidSaturation")) {
      vidSaturation = atoi (Value);
!     vidSaturation = clamp (-1, vidSaturation, 100);
      fprintf(stderr, "[setup-softdevice] vidSaturation: %d\n", vidSaturation);
    }  else

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** setup-softdevice.h	25 Jun 2006 13:46:12 -0000	1.32
--- setup-softdevice.h	25 Jul 2006 19:58:12 -0000	1.33
***************
*** 126,129 ****
--- 126,130 ----
      int   xvMaxArea;
      int   xvFullscreen;
+     int   xvUseDefaults;
      int   outputMethod;
      int   pixelFormat;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.64
retrieving revision 1.65
diff -C2 -d -r1.64 -r1.65
*** softdevice.c	11 Jul 2006 20:31:37 -0000	1.64
--- softdevice.c	25 Jul 2006 19:58:12 -0000	1.65
***************
*** 369,372 ****
--- 369,374 ----
      esyslog("[softdevice] could not load (%s)[%s] exiting\n",
              subPluginFileName, err);
+     fprintf(stderr,"[softdevice] could not load (%s)[%s] exiting\n",
+             subPluginFileName, err);
      exit(1);
    }
***************
*** 706,709 ****
--- 708,712 ----
    "  -vo xv:max-area          use maximum available area\n"
    "  -vo xv:full              startup fullscreen\n"
+   "  -vo xv:use-defaults      don't change brigtness etc on startup\n"
  #endif
  #ifdef FB_SUPPORT
***************
*** 783,786 ****
--- 786,794 ----
                         "[ProcessArgs] xv: start up fullscreen\n");
                vo_argv += 4;
+             } else if (!strncmp (vo_argv, "use-defaults", 12)) {
+               fprintf (stderr,
+                        "[ProcessArgs] xv: don't change brigtness etc on startup\n");
+               setupStore.xvUseDefaults=true;
+               vo_argv += 12;
              } else {
                      fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.57
retrieving revision 1.58
diff -C2 -d -r1.57 -r1.58
*** video-xv.c	16 Jul 2006 02:09:22 -0000	1.57
--- video-xv.c	25 Jul 2006 19:58:12 -0000	1.58
***************
*** 127,130 ****
--- 127,145 ----
  /* ---------------------------------------------------------------------------
   */
+ int cXvPortAttributeStore::GetValuePercent(int index)
+ {
+       int value = portAttributeCurrentValues[index];
+ 
+       value = (int) (((double) value - (double) portAttributes[index].min_value) * 100.0
+               / ((double) portAttributes[index].max_value - (double) portAttributes[index].min_value));
+ 
+       if (value <= 100 &&
+           value >= 0)
+         return value;
+       return 0;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cXvPortAttributeStore::SetValuePercent(char *name, int value)
  {
***************
*** 218,228 ****
--- 233,259 ----
        }
        if (!strcmp(portAttributes[i].name, "XV_BRIGHTNESS"))
+       {
          setupStore->vidCaps |= CAP_BRIGHTNESS;
+         if ( setupStore->xvUseDefaults || setupStore->vidBrightness<0 )
+                 setupStore->vidBrightness = currBrightness = GetValuePercent(i);
+       }
        if (!strcmp(portAttributes[i].name, "XV_CONTRAST"))
+       {
          setupStore->vidCaps |= CAP_CONTRAST;
+         if ( setupStore->xvUseDefaults || setupStore->vidContrast<0 )
+                 setupStore->vidContrast = currContrast = GetValuePercent(i);
+       }
        if (!strcmp(portAttributes[i].name, "XV_HUE"))
+       {
          setupStore->vidCaps |= CAP_HUE;
+         if ( setupStore->xvUseDefaults || setupStore->vidHue<0 )
+                 setupStore->vidHue = currHue = GetValuePercent(i);
+       }
        if (!strcmp(portAttributes[i].name, "XV_SATURATION"))
+       {
          setupStore->vidCaps |= CAP_SATURATION;
+         if ( setupStore->xvUseDefaults || setupStore->vidSaturation<0 )
+                 setupStore->vidSaturation = currSaturation = GetValuePercent(i);
+       }
  
        dsyslog("[XvVideoOut]:"

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** video-xv.h	27 May 2006 19:12:42 -0000	1.21
--- video-xv.h	25 Jul 2006 19:58:12 -0000	1.22
***************
*** 92,95 ****
--- 92,96 ----
    void SetValue(char *name, int value);
    void SetValuePercent(char *name, int value);
+   int GetValuePercent(int index);
    void SetColorkey(int value);
    void Increment(char *name);



From nobody at sheep.berlios.de  Tue Jul 25 22:03:41 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 25 Jul 2006 22:03:41 +0200 (CEST)
Subject: [Softdevice-cvs] softplay SoftPlayer.c, 1.14, 1.15 SoftPlayer.h, 1.6,
	1.7
Message-ID: <20060725200341.1E5ED5CFEC@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv30090

Modified Files:
	SoftPlayer.c SoftPlayer.h 
Log Message:
- update duration
- FlushDevice() waits longer for end of file.



Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** SoftPlayer.c	12 Mar 2006 20:28:52 -0000	1.14
--- SoftPlayer.c	25 Jul 2006 20:03:33 -0000	1.15
***************
*** 115,119 ****
          av_dup_packet(&pkt);
          // length = -2 : queue packet
!         PKTDBG("Queue Packet PTS: %lld\n",pkt.pts);
  #if VDRVERSNUM >= 10330
          SoftHandles.QueuePacket(SoftDevice,ic,pkt);
--- 115,119 ----
          av_dup_packet(&pkt);
          // length = -2 : queue packet
!         PKTDBG("Queue Packet index: %d PTS: %lld\n",pkt.stream_index,pkt.pts);
  #if VDRVERSNUM >= 10330
          SoftHandles.QueuePacket(SoftDevice,ic,pkt);
***************
*** 146,156 ****
  void cSoftPlayer::FlushDevice(int Streams) {
  #if VDRVERSNUM >= 10330
! 	PLDBG("FlushDevice BufferFilll(%d) at start: %d\n",
  			Streams,SoftHandles.BufferFill(SoftDevice,Streams,0));
          int count=0;        
          while ( SoftHandles.BufferFill(SoftDevice,Streams,0) > 0 
!                         && count++ < 100 )
                  usleep(50000);
! 	PLDBG("FlushDevice BufferFilll(%d) at end: %d\n",
  			Streams,SoftHandles.BufferFill(SoftDevice,Streams,0));
  #else
--- 146,156 ----
  void cSoftPlayer::FlushDevice(int Streams) {
  #if VDRVERSNUM >= 10330
! 	PLDBG("FlushDevice BufferFill(%d) at start: %d\n",
  			Streams,SoftHandles.BufferFill(SoftDevice,Streams,0));
          int count=0;        
          while ( SoftHandles.BufferFill(SoftDevice,Streams,0) > 0 
!                         && count++ < 200 )
                  usleep(50000);
! 	PLDBG("FlushDevice BufferFill(%d) at end: %d\n",
  			Streams,SoftHandles.BufferFill(SoftDevice,Streams,0));
  #else
***************
*** 292,295 ****
--- 292,301 ----
                  if (PacketCount == 200)
                          dump_format(ic, 0, "test", 0);
+ 
+                 // update duration (FIXME does that help?)
+                 duration=ic->duration;
+                 int currPos= SoftDevice->GetSTC()*AV_TIME_BASE/(9*10000);
+                 if (duration<currPos)
+                         duration=currPos;
          }
  	//if (running) 
***************
*** 412,417 ****
  };
  
- 
- 
  void cSoftPlayer::OpenFile(const char *filename) {
          int ret;
--- 418,421 ----
***************
*** 648,654 ****
                  newFile=true;
          };
  
!         if ( newFile ) {
!                 int TotalDuration=SoftPlayer->GetDuration();
                  char Title[80];
                  if ( *SoftPlayer->GetTitle() )
--- 652,660 ----
                  newFile=true;
          };
+         
+         int TotalDuration=SoftPlayer->GetDuration();
+         int CurrentPos=SoftPlayer->GetCurrPos();
  
!         if ( newFile || currFileDuration!=SoftPlayer->GetDuration()) {
                  char Title[80];
                  if ( *SoftPlayer->GetTitle() )
***************
*** 661,667 ****
                  };
                  displayReplay->SetTitle(Title);
  		
!                 displayReplay->SetProgress(SoftPlayer->GetCurrPos()
!                                 ,TotalDuration);
  		char str[60];
  		sprintf(str,"%02d:%02d:%02d",TotalDuration/3600,
--- 667,673 ----
                  };
                  displayReplay->SetTitle(Title);
+                 currFileDuration=TotalDuration;
  		
!                 displayReplay->SetProgress(CurrentPos,TotalDuration);
  		char str[60];
  		sprintf(str,"%02d:%02d:%02d",TotalDuration/3600,
***************
*** 671,675 ****
  		newFile=false;
          };
-         int CurrentPos=SoftPlayer->GetCurrPos();
          displayReplay->SetProgress(CurrentPos,
                          SoftPlayer->GetDuration());
--- 677,680 ----

Index: SoftPlayer.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** SoftPlayer.h	12 Mar 2006 20:28:52 -0000	1.6
--- SoftPlayer.h	25 Jul 2006 20:03:33 -0000	1.7
***************
*** 154,158 ****
  
        // to notice when the next file starts
!       bool newFile; 
    public:
       cSoftControl( const char * filename );
--- 154,159 ----
  
        // to notice when the next file starts
!       bool newFile;
!       int currFileDuration;
    public:
       cSoftControl( const char * filename );



From nobody at sheep.berlios.de  Tue Jul 25 22:05:30 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 25 Jul 2006 22:05:30 +0200 (CEST)
Subject: [Softdevice-cvs] softplay softplay.h,1.4,1.5
Message-ID: <20060725200530.E88255CF61@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv31121

Modified Files:
	softplay.h 
Log Message:
-don't modify pos if NULL in skipSpaces()



Index: softplay.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** softplay.h	12 Mar 2006 20:28:52 -0000	1.4
--- softplay.h	25 Jul 2006 20:05:20 -0000	1.5
***************
*** 119,122 ****
--- 119,124 ----
  
  static inline void skipSpaces(const char *&pos) {
+         if (!pos)
+                 return;
  	while ( *pos==' ' )
  		pos++;



From nobody at sheep.berlios.de  Sat Aug  5 19:51:40 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat,  5 Aug 2006 19:51:40 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.217, 1.218 video-dfb.c,
	1.69, 1.70
Message-ID: <20060805175140.3DC34609AF@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20957

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
disable reported failed flags in SetParams()

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.217
retrieving revision 1.218
diff -C2 -d -r1.217 -r1.218
*** CHANGELOG	25 Jul 2006 19:58:12 -0000	1.217
--- CHANGELOG	5 Aug 2006 17:51:25 -0000	1.218
***************
*** 1,15 ****
  Changelog
! 2006-07-25:
!    - no longer exit when a audio mode is not available, audio is only disabled.
!    - clean up audio-alsa
!    - init tmpOsdSurface and delete dirtyLines properly
!    - try to use the XVideo default brightness, hue etc. values on first start
!    - new option: "-vo xv:use-defaults", can be used to reset the values
!      of brightness, hue etc. to the default values. (Based on a patch
!      by Matthias Schwarzott)
! 2006-07-16:
!    - only link against libXi if necessary ( do we need libXi at all?)
!    - check explicitly for pkg-config in configure
!    - configure: "--with-ffmpeg-path" overrides pkg-config
     - unconditionally set _NET_WM_FULLSCREEN Atom when going fullscreen (recent Metacity WM need it)
  2006-07-12:
--- 1,17 ----
  Changelog
! 2006-08-05:
!    - video-dfb: disable reported failed flags in SetParams()
! 2006-07-25:
!    - no longer exit when a audio mode is not available, audio is only disabled.
!    - clean up audio-alsa
!    - init tmpOsdSurface and delete dirtyLines properly
!    - try to use the XVideo default brightness, hue etc. values on first start
!    - new option: "-vo xv:use-defaults", can be used to reset the values
!      of brightness, hue etc. to the default values. (Based on a patch
!      by Matthias Schwarzott)
! 2006-07-16:
!    - only link against libXi if necessary ( do we need libXi at all?)
!    - check explicitly for pkg-config in configure
!    - configure: "--with-ffmpeg-path" overrides pkg-config
     - unconditionally set _NET_WM_FULLSCREEN Atom when going fullscreen (recent Metacity WM need it)
  2006-07-12:

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.69
retrieving revision 1.70
diff -C2 -d -r1.69 -r1.70
*** video-dfb.c	25 Jul 2006 19:47:41 -0000	1.69
--- video-dfb.c	5 Aug 2006 17:51:25 -0000	1.70
***************
*** 868,871 ****
--- 868,877 ----
                        "to back video, reverting to normal\n");
                dlc.buffermode = DLBM_FRONTONLY;
+             } else {
+               fprintf(stderr,
+                       "[dfb]: Testconfiguration failed flags: %08x "
+                       "(disabling failed flags)\n",
+                       failed);
+               dlc.flags = (DFBDisplayLayerConfigFlags) (dlc.flags & ~failed);
              }
              delete ex;
***************
*** 905,909 ****
            catch (DFBException *ex)
            {
!             fprintf (stderr, "[dfb] SetParams: action=%s, result=%s\n",
                       ex->GetAction(), ex->GetResult());
              delete ex;
--- 911,917 ----
            catch (DFBException *ex)
            {
!             fprintf (stderr,
!                      "[dfb] SetParams() SetScreenLocation(): "
!                      "action=%s, result=%s\n",
                       ex->GetAction(), ex->GetResult());
              delete ex;



From nobody at sheep.berlios.de  Sun Aug 27 14:49:09 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 27 Aug 2006 14:49:09 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.218, 1.219 configure, 1.23,
	1.24
Message-ID: <20060827124909.A7745709C8@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25497

Modified Files:
	CHANGELOG configure 
Log Message:
-adjust ffmpeg library order in configure


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.218
retrieving revision 1.219
diff -C2 -d -r1.218 -r1.219
*** CHANGELOG	5 Aug 2006 17:51:25 -0000	1.218
--- CHANGELOG	27 Aug 2006 12:48:46 -0000	1.219
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-08-27:
+    - adjust ffmpeg library order in configure
  2006-08-05:
     - video-dfb: disable reported failed flags in SetParams()

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** configure	16 Jul 2006 13:04:15 -0000	1.23
--- configure	27 Aug 2006 12:48:46 -0000	1.24
***************
*** 130,134 ****
  }
  EOF
!   $cc $CFLAGS $ffmpeg_cflags $ffmpeg_libs -o $TMPE $TMPC $ffmpeg_libs  >> config.log 2>&1 || ffmpeg="no"
  };
  
--- 130,134 ----
  }
  EOF
!   $cc $CFLAGS $ffmpeg_cflags -o $TMPE $TMPC $ffmpeg_libs  >> config.log 2>&1 || ffmpeg="no"
  };
  
***************
*** 138,142 ****
  
  echo "try to use pkg-config." >> config.log
! ffmpeg_l1="libavcodec libavformat"
  
  pkg-config --libs libpostproc >> config.log 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
--- 138,142 ----
  
  echo "try to use pkg-config." >> config.log
! ffmpeg_l1="libavformat libavcodec"
  
  pkg-config --libs libpostproc >> config.log 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
***************
*** 154,158 ****
    echo "pkg-config failed, try the default/parameter path." >> config.log
    ffmpeg="yes"
!   ffmpeg_libs="-L${ffmpeg_path}/ -L${ffmpeg_path}/libavcodec/ -L${ffmpeg_path}/libavformat/ -lavformat -lz -lavcodec "
    ffmpeg_cflags="-I${ffmpeg_path}/ -I${ffmpeg_path}/libavcodec/ -I${ffmpeg_path}/libavformat/ "
  
--- 154,158 ----
    echo "pkg-config failed, try the default/parameter path." >> config.log
    ffmpeg="yes"
!   ffmpeg_libs="-L${ffmpeg_path}/ -L${ffmpeg_path}/libavcodec/ -L${ffmpeg_path}/libavformat/ -lavformat -lavcodec -lz"
    ffmpeg_cflags="-I${ffmpeg_path}/ -I${ffmpeg_path}/libavcodec/ -I${ffmpeg_path}/libavformat/ "
  



From nobody at sheep.berlios.de  Sun Aug 27 15:03:15 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 27 Aug 2006 15:03:15 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice ShmClient.c, 1.14,
	1.15 setup-softdevice-menu.c, 1.6, 1.7 softdevice.c, 1.65,
	1.66 softdevice.h, 1.10, 1.11 video-shm.c, 1.8,
	1.9 video-shm.h, 1.5, 1.6 video-xv.c, 1.58, 1.59 video-xv.h,
	1.22, 1.23 video.c, 1.60, 1.61 video.h, 1.40, 1.41
Message-ID: <20060827130315.15F8D71C1F@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29361

Modified Files:
	ShmClient.c setup-softdevice-menu.c softdevice.c softdevice.h 
	video-shm.c video-shm.h video-xv.c video-xv.h video.c video.h 
Log Message:
- enable different pixel formats in video-xv
- properly init ctl->key (reported by Matthias Schwarzott)
      


Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** ShmClient.c	27 May 2006 19:12:41 -0000	1.14
--- ShmClient.c	27 Aug 2006 13:02:50 -0000	1.15
***************
*** 94,102 ****
          };
  
!         if ( !vout->Initialize() || !vout->Reconfigure(FOURCC_YV12) ) {
                  fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
! 
          if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;
--- 94,106 ----
          };
  
!         if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
!         
!         while (!vout->Reconfigure(SetupStore.pixelFormat) 
!                         && SetupStore.pixelFormat < 3 )
!                 SetupStore.pixelFormat++;
!         
          if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;
***************
*** 111,114 ****
--- 115,120 ----
                  picture.stride[2]=ctl->stride1;
                  picture.edge_width=picture.edge_height=0;
+                 picture.max_width=ctl->max_width;
+                 picture.max_height=ctl->max_height;
          } else {
                  // create a picture in shm
***************
*** 142,145 ****
--- 148,153 ----
                  picture.pixel[2]=picture.pixel[1]+ctl->max_height/2*ctl->stride1;
                  picture.edge_width=picture.edge_height=0;
+                 picture.max_width=ctl->max_width;
+                 picture.max_height=ctl->max_height;
          }
          ctl->attached=1;
***************
*** 217,220 ****
--- 225,229 ----
                          ctl->new_osd=0;
                  };
+                 vout->ProcessEvents();
  
                  vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** setup-softdevice-menu.c	25 Jun 2006 13:46:12 -0000	1.6
--- setup-softdevice-menu.c	27 Aug 2006 13:02:50 -0000	1.7
***************
*** 357,361 ****
  #endif
  
!   if ((data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX) &&
        !data->pixelFormatLocked)
    {
--- 357,362 ----
  #endif
  
!   if ((data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX
!        || data->outputMethod == VOUT_XV ) &&
        !data->pixelFormatLocked)
    {

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.65
retrieving revision 1.66
diff -C2 -d -r1.65 -r1.66
*** softdevice.c	25 Jul 2006 19:58:12 -0000	1.65
--- softdevice.c	27 Aug 2006 13:02:50 -0000	1.66
***************
*** 198,202 ****
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         LoadSubPlugin ("xv", FOURCC_YV12, pluginPath);
          //LoadSubPlugin ("xv", FOURCC_YUY2, pluginPath);
  #endif
--- 198,202 ----
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         LoadSubPlugin ("xv", pluginPath);
          //LoadSubPlugin ("xv", FOURCC_YUY2, pluginPath);
  #endif
***************
*** 204,223 ****
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         LoadSubPlugin ("fb", 0, pluginPath);
  #endif
          break;
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         LoadSubPlugin ("dfb", 0, pluginPath);
  #endif
          break;
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         LoadSubPlugin ("vidix", 0, pluginPath);
  #endif
          break;
        case VOUT_SHM:
  #ifdef SHM_SUPPORT
!         LoadSubPlugin ("shm", 0, pluginPath);
  #endif
          break;
--- 204,223 ----
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         LoadSubPlugin ("fb", pluginPath);
  #endif
          break;
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         LoadSubPlugin ("dfb", pluginPath);
  #endif
          break;
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         LoadSubPlugin ("vidix", pluginPath);
  #endif
          break;
        case VOUT_SHM:
  #ifdef SHM_SUPPORT
!         LoadSubPlugin ("shm", pluginPath);
  #endif
          break;
***************
*** 235,240 ****
  #ifdef XV_SUPPORT
          videoOut = new cXvVideoOut (&setupStore);
!         if (videoOut->Initialize () && videoOut->Reconfigure (FOURCC_YV12)) {
!         //if (videoOut->Initialize () && videoOut->Reconfigure (FOURCC_YUY2)) {
            fprintf (stderr, "[softdevice] Xv out OK !\n");
          } else {
--- 235,251 ----
  #ifdef XV_SUPPORT
          videoOut = new cXvVideoOut (&setupStore);
!         if ( !videoOut->Initialize() ) {
!                 
!           if (!videoOut->Reconfigure()) {
!                   // XVideo intialization failed, try different pix formats
!                   setupStore.pixelFormat=0;
!                   while (!videoOut->Reconfigure(setupStore.pixelFormat)
!                                   && setupStore.pixelFormat < 3)
!                           setupStore.pixelFormat++;
!                   // reset to default if all failed...
!                   if (setupStore.pixelFormat == 3)
!                           setupStore.pixelFormat == 0;
!           };
!                   
            fprintf (stderr, "[softdevice] Xv out OK !\n");
          } else {
***************
*** 278,281 ****
--- 289,295 ----
      }
  #endif
+     // start OSD refresh thread
+     videoOut->Start();
+ 
      fprintf(stderr,"[softdevice] Video Out seems to be OK\n");
      fprintf(stderr,"[softdevice] Initializing Audio Out\n");
***************
*** 309,313 ****
   */
  void cSoftDevice::LoadSubPlugin(char *outMethodName,
-                                 int reconfigureArg,
                                  char *pluginPath)
  {
--- 323,326 ----
***************
*** 352,357 ****
        exit(1);
      }
!     if (videoOut->Initialize () && videoOut->Reconfigure (reconfigureArg))
      {
        fprintf(stderr,"[softdevice] Subplugin successfully opend\n");
        dsyslog("[softdevice] videoOut OK !\n");
--- 365,371 ----
        exit(1);
      }
!     if ( videoOut->Initialize() )
      {
+       videoOut->Reconfigure();
        fprintf(stderr,"[softdevice] Subplugin successfully opend\n");
        dsyslog("[softdevice] videoOut OK !\n");

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** softdevice.h	9 Jun 2006 16:45:13 -0000	1.10
--- softdevice.h	27 Aug 2006 13:02:50 -0000	1.11
***************
*** 93,97 ****
    { if (decoder) decoder->Freeze(Stream,Value); return 0;};
  
!   void LoadSubPlugin(char *outMethodName, int reconfigureArg, char *pluginPath);
  
    virtual bool HasDecoder(void) const;
--- 93,97 ----
    { if (decoder) decoder->Freeze(Stream,Value); return 0;};
  
!   void LoadSubPlugin(char *outMethodName, char *pluginPath);
  
    virtual bool HasDecoder(void) const;

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** video-shm.c	27 May 2006 19:12:41 -0000	1.8
--- video-shm.c	27 Aug 2006 13:02:50 -0000	1.9
***************
*** 18,21 ****
--- 18,27 ----
  #define SHMDEB(out...)
  #endif
+ 
+ //#define SIGDEB(out...) {printf("SIGSERV[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
+ 
+ #ifndef SIGDEB
+ #define SIGDEB(out...)
+ #endif
    
  cShmRemote::~cShmRemote(){
***************
*** 27,33 ****
  void cShmRemote::Action(void) {
          while (active) {
!                 SHMDEB("cShmRemote trying to get a lock\n");
                  sem_wait_lock(vout->ctl->semid,KEY_MUT);
!                 SHMDEB("cShmRemote got lock\n");
                  
                  if (!vout->ctl->attached) {
--- 33,39 ----
  void cShmRemote::Action(void) {
          while (active) {
!                 SIGDEB("cShmRemote trying to get a lock\n");
                  sem_wait_lock(vout->ctl->semid,KEY_MUT);
!                 SIGDEB("cShmRemote got lock\n");
                  
                  if (!vout->ctl->attached) {
***************
*** 47,51 ****
                  sem_sig_unlock(vout->ctl->semid,KEY_MUT);
  
!                 SHMDEB("wait for a new key\n");
                  sem_wait_lock(vout->ctl->semid,KEY_SIG);
          };
--- 53,57 ----
                  sem_sig_unlock(vout->ctl->semid,KEY_MUT);
  
!                 SIGDEB("wait for a new key\n");
                  sem_wait_lock(vout->ctl->semid,KEY_SIG);
          };
***************
*** 59,62 ****
--- 65,69 ----
          ctl_key = CTL_KEY;
          bool Clear_Ctl=false;
+         InitPicBuffer(&privBuf);
  
          // first try to get an existing ShmCltBlock
***************
*** 123,127 ****
          curr_pict=NULL;
          osd_surface=NULL;
!         ctl->key=kNone;
          remote = new cShmRemote("softdevice-xv",this);
  };
--- 130,134 ----
          curr_pict=NULL;
          osd_surface=NULL;
!         ctl->key=NO_KEY;
          remote = new cShmRemote("softdevice-xv",this);
  };
***************
*** 138,141 ****
--- 145,152 ----
          }
          ctl->semid=-1;
+                         
+         if (osd_surface)
+                 shmdt(osd_surface);
+         osd_surface=NULL;
          
          if (curr_pict)
***************
*** 252,255 ****
--- 263,288 ----
  };
  
+ void cShmVideoOut::ProcessEvents() {
+         // I don't know if there is a timeout mechanism (which would probably the better solution),
+         // so we just signal every once and a while so that the client processes its events.
+         SIGDEB("ProcessEvents sending signal\n");
+         sem_sig_unlock(ctl->semid,PICT_SIG);
+ }
+ 
+ void cShmVideoOut::Suspend() {
+         SHMDEB("Suspend shm server\n");
+         if (osd_surface) {
+                 shmdt(osd_surface);
+                 osd_surface=NULL;
+                 curr_osd_shmid=-1;
+         };
+         
+         if (curr_pict) {
+                 shmdt(curr_pict);
+                 curr_pict=NULL;
+                 curr_pict_shmid=-1;
+         }
+ };
+ 
  void cShmVideoOut::YUV(sPicBuffer *buf) {
          uint8_t *Py=buf->pixel[0]+(buf->edge_height)*buf->stride[0]
***************
*** 269,275 ****
          } else setupStore->shouldSuspend=0;
  
!         //SHMDEB("trying to get a lock\n");
          sem_wait_lock(ctl->semid,PICT_MUT);
!         //SHMDEB("got a lock\n");
          
          if ( ctl->pict_shmid != curr_pict_shmid ) {
--- 302,308 ----
          } else setupStore->shouldSuspend=0;
  
!         SIGDEB("YUV trying to get a lock\n");
          sem_wait_lock(ctl->semid,PICT_MUT);
!         SIGDEB("YUV got a lock\n");
          
          if ( ctl->pict_shmid != curr_pict_shmid ) {
***************
*** 282,286 ****
                         if ( (curr_pict = (uint8_t *)shmat(ctl->pict_shmid,NULL,0)) 
                                         == (uint8_t*) -1 ) {
!                                fprintf(stderr,"error attatching shm pict! Assumeing no client connected\n");
                                 ctl->pict_shmid = -1;
                                 ctl->attached = 0;
--- 315,319 ----
                         if ( (curr_pict = (uint8_t *)shmat(ctl->pict_shmid,NULL,0)) 
                                         == (uint8_t*) -1 ) {
!                                fprintf(stderr,"error attatching shm pict! Assuming no client connected\n");
                                 ctl->pict_shmid = -1;
                                 ctl->attached = 0;
***************
*** 288,296 ****
                                 sem_sig_unlock(ctl->semid,PICT_MUT);
                                 return;
!                        } 
!                        pixels[0]=curr_pict;
!                        pixels[1]=curr_pict+ctl->max_height*ctl->stride0;
!                        pixels[2]=pixels[1]+ctl->max_height/2*ctl->stride1;
                         curr_pict_shmid=ctl->pict_shmid;
                  };
          };
--- 321,347 ----
                                 sem_sig_unlock(ctl->semid,PICT_MUT);
                                 return;
!                        }
                         curr_pict_shmid=ctl->pict_shmid;
+                        privBuf.format=PIX_FMT_YUV420P;//ctl->format;
+                        privBuf.max_width=ctl->max_width;
+                        privBuf.max_height=ctl->max_height;
+                        switch (privBuf.format) {
+                         case PIX_FMT_YUV420P:  
+                                 SHMDEB("new format YUV420P\n");
+                                 pixels[0]=privBuf.pixel[0]=curr_pict;
+                                 pixels[2]=privBuf.pixel[2]=curr_pict+ctl->max_height*ctl->stride0;
+                                 pixels[1]=privBuf.pixel[1]=privBuf.pixel[2]+ctl->max_height/2*ctl->stride1;
+                                 privBuf.stride[0]=ctl->stride0;
+                                 privBuf.stride[1]=privBuf.stride[2]=ctl->stride1;
+                                 break;
+                         case PIX_FMT_YUV422:
+                                 SHMDEB("new format YUV422\n");
+                                 privBuf.pixel[0]=curr_pict;
+                                 privBuf.stride[0]=ctl->stride0;
+                                 break;
+                         default:
+                                 break;
+                        }
+                        SHMDEB("new pict %p shmid %d\n",curr_pict,curr_pict_shmid);
                  };
          };
***************
*** 312,317 ****
          ctl->new_asp=GetAspect_F();
          if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!                 
!                 for (int i = 0; i < height; i++)
                          AlphaBlend(pixels [0] + i * ctl->stride0,
                                         OsdPy+i*OSD_FULL_WIDTH,
--- 363,371 ----
          ctl->new_asp=GetAspect_F();
          if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
! 
!                 CopyPicBufAlphaBlend(&privBuf,buf,
!                                 OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV, OSD_FULL_WIDTH,
!                                 0,0,0,0);                
! /*                for (int i = 0; i < height; i++)
                          AlphaBlend(pixels [0] + i * ctl->stride0,
                                         OsdPy+i*OSD_FULL_WIDTH,
***************
*** 331,336 ****
                                          OsdPAlphaUV+i*OSD_FULL_WIDTH/2,
                                          width / 2);
!         } else {
!                 
                  for (int i = 0; i < height; i++)
                          fast_memcpy(pixels [0] + i * ctl->stride0,
--- 385,391 ----
                                          OsdPAlphaUV+i*OSD_FULL_WIDTH/2,
                                          width / 2);
!   */      } else {
!                 CopyPicBuf(&privBuf,buf,0,0,0,0);
!                /* 
                  for (int i = 0; i < height; i++)
                          fast_memcpy(pixels [0] + i * ctl->stride0,
***************
*** 345,358 ****
                                          Pv + i * UVstride,
                                          width / 2);
! 
          };
          ctl->new_pict++;
          if (ctl->new_pict>30) {
!                 printf("new_pict > 30; assueming client died!\n");
                  ctl->attached=0;
          };
          sem_sig_unlock(ctl->semid,PICT_MUT);
          sem_sig_unlock(ctl->semid,PICT_SIG);
!         //SHMDEB("send signal\n");
          
  };
--- 400,413 ----
                                          Pv + i * UVstride,
                                          width / 2);
! */
          };
          ctl->new_pict++;
          if (ctl->new_pict>30) {
!                 printf("new_pict > 30; assuming client died!\n");
                  ctl->attached=0;
          };
          sem_sig_unlock(ctl->semid,PICT_MUT);
          sem_sig_unlock(ctl->semid,PICT_SIG);
!         SIGDEB("send signal\n");
          
  };

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-shm.h	27 May 2006 19:12:41 -0000	1.5
--- video-shm.h	27 Aug 2006 13:02:50 -0000	1.6
***************
*** 36,39 ****
--- 36,40 ----
          uint8_t *curr_pict;
          uint8_t *pixels[4];
+         sPicBuffer privBuf;
  
          int curr_osd_shmid;
***************
*** 46,49 ****
--- 47,52 ----
          virtual void AdjustOSDMode();
  
+         virtual void ProcessEvents();
+ 
          virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                       int &xPan, int &yPan);
***************
*** 57,60 ****
--- 60,65 ----
          virtual void CommitUnlockOsdSurface();
          virtual void ClearOSD();
+ 
+         virtual void Suspend();
  };
  

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.58
retrieving revision 1.59
diff -C2 -d -r1.58 -r1.59
*** video-xv.c	25 Jul 2006 19:58:12 -0000	1.58
--- video-xv.c	27 Aug 2006 13:02:50 -0000	1.59
***************
*** 32,35 ****
--- 32,42 ----
  #define PATCH_VERSION "2006-04-24"
  
+ #define NO_DIRECT_RENDERING
+ 
+ int pixFormat[3]={
+         FOURCC_I420,
+         FOURCC_YV12,
+         FOURCC_YUY2};
+ 
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
  cSoftRemote        *xvRemote = NULL;
***************
*** 734,738 ****
        XClearArea (dpy, win, 0, 0, 0, 0, False);
        ShowOSD();
!       PutXvImage();
        XSync(dpy, False);
      }
--- 741,745 ----
        XClearArea (dpy, win, 0, 0, 0, 0, False);
        ShowOSD();
!       PutXvImage(xv_image,privBuf.edge_width,privBuf.edge_height);
        XSync(dpy, False);
      }
***************
*** 796,799 ****
--- 803,814 ----
      lwidth = dwidth = XV_DEST_WIDTH_16_9;
    }
+ 
+   for (int i=0; i<LAST_PICBUF; i++) {
+           dr_image[i]=NULL;
+           dr_shminfo[i].shmid=-1;
+           dr_shminfo[i].shmaddr=NULL;
+   };
+   
+   InitPicBuffer(&privBuf);
  }
  
***************
*** 1051,1055 ****
  /* ---------------------------------------------------------------------------
   */
! bool cXvVideoOut::Reconfigure(int format)
  {
      int                 fmt_cnt, k, rc,
--- 1066,1070 ----
  /* ---------------------------------------------------------------------------
   */
! bool cXvVideoOut::Reconfigure(int format, int width, int height)
  {
      int                 fmt_cnt, k, rc,
***************
*** 1059,1066 ****
      XvAdaptorInfo       *ad_info;
      XvImageFormatValues *fmt_info;
-     int                 len=0;
  
    pthread_mutex_lock(&xv_mutex);
  
    /*
     * So let's first check for an available adaptor and port
--- 1074,1092 ----
      XvAdaptorInfo       *ad_info;
      XvImageFormatValues *fmt_info;
  
+   if (format > 3) {
+           printf("XvVideoOut.Reconfigure format > 3!\n");
+           return false;
+   };
+   
+   currentPixelFormat=format;
+   format = pixFormat[currentPixelFormat];
+   //printf("Reconfigure %d %d %d %d\n",currentPixelFormat,format,width,height);fflush(stdout);
    pthread_mutex_lock(&xv_mutex);
  
+   xv_initialized = 0;
+   xvWidth=width;
+   xvHeight=height;
+ 
    /*
     * So let's first check for an available adaptor and port
***************
*** 1136,1155 ****
                        encodingInfo[n].width, encodingInfo[n].height);
  
!               if (setupStore->xvMaxArea) {
!                 /* ------------------------------------------------------------
!                  * adjust width to 8 byte boundary and height to an even
!                  * number of lines.
!                  */
!                 xvWidth  = (encodingInfo[n].width & ~7);
!                 xvHeight = (encodingInfo[n].height & ~1);
!               } else {
!                 xvWidth  = XV_SRC_WIDTH;
!                 xvHeight = XV_SRC_HEIGHT;
!               }
                fprintf(stderr, "[XvVideoOut]: using area size %d x %d\n",
                        xvWidth, xvHeight);
                dsyslog("[XvVideoOut]: using area size %d x %d",
                        xvWidth, xvHeight);
-               len = xvWidth * xvHeight * 2;
              }
            }
--- 1162,1177 ----
                        encodingInfo[n].width, encodingInfo[n].height);
  
!               /* ------------------------------------------------------------
!                * adjust width to 8 byte boundary and height to an even
!                * number of lines.
!                */
!               xv_max_width = (encodingInfo[n].width & ~7);
!               xv_max_height = (encodingInfo[n].height & ~1);
! 
!               //FIXME (re)move?
                fprintf(stderr, "[XvVideoOut]: using area size %d x %d\n",
                        xvWidth, xvHeight);
                dsyslog("[XvVideoOut]: using area size %d x %d",
                        xvWidth, xvHeight);
              }
            }
***************
*** 1165,1169 ****
      esyslog("[XvVideoOut]: (ERROR) no Xv extensions found! No video possible!");
      pthread_mutex_unlock(&xv_mutex);
!     return true;
    } /* else */
  
--- 1187,1191 ----
      esyslog("[XvVideoOut]: (ERROR) no Xv extensions found! No video possible!");
      pthread_mutex_unlock(&xv_mutex);
!     return false;
    } /* else */
  
***************
*** 1171,1180 ****
      esyslog("[XvVideoOut]: (ERROR) no adaptor found! No video possible!");
      pthread_mutex_unlock(&xv_mutex);
!     return true;
    }
    if(!got_port) {
      esyslog("[XvVideoOut]: (ERROR) could not grab any port! No video possible!");
      pthread_mutex_unlock(&xv_mutex);
!     return true;
    }
  
--- 1193,1202 ----
      esyslog("[XvVideoOut]: (ERROR) no adaptor found! No video possible!");
      pthread_mutex_unlock(&xv_mutex);
!     return false;
    }
    if(!got_port) {
      esyslog("[XvVideoOut]: (ERROR) could not grab any port! No video possible!");
      pthread_mutex_unlock(&xv_mutex);
!     return false;
    }
  
***************
*** 1199,1205 ****
--- 1221,1251 ----
        pixels[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
        pixels[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
+       
+       privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
+       if (format == FOURCC_YV12) {
+               privBuf.pixel[1] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
+               privBuf.pixel[2] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
+       } else {
+               privBuf.pixel[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
+               privBuf.pixel[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
+       };
+       privBuf.stride[0] = xv_image->pitches[0];
+       privBuf.stride[1] = xv_image->pitches[2];
+       privBuf.stride[2] = xv_image->pitches[1];
+ 
+       privBuf.format = PIX_FMT_YUV420P;
        break;
      case FOURCC_YUY2:
        pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
+         
+       privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
+       privBuf.pixel[1] = NULL;
+       privBuf.pixel[2] = NULL;
+ 
+       privBuf.stride[0] = xv_image->pitches[0];
+       privBuf.stride[1] = 0;
+       privBuf.stride[2] = 0;
+       
+       privBuf.format = PIX_FMT_YUV422;
        break;
      default:
***************
*** 1207,1214 ****
    }
  
    this->format = format;
  
    ClearXvArea (0, 128, 128);
!   rc = PutXvImage();
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
    rc = XSync(dpy, False);
--- 1253,1264 ----
    }
  
+   privBuf.max_height=xvHeight;
+   privBuf.max_width=xvWidth;
+   privBuf.owner=this;
+ 
    this->format = format;
  
    ClearXvArea (0, 128, 128);
!   rc = PutXvImage(xv_image,privBuf.edge_width,privBuf.edge_height);
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
    rc = XSync(dpy, False);
***************
*** 1217,1222 ****
    {
      got_error=0;retry++;
!     xvWidth=XV_SRC_WIDTH;
!     xvHeight = XV_SRC_HEIGHT;
      if (retry<2) {
              fprintf(stderr,"Error initializing Xv. Retry.\n");
--- 1267,1272 ----
    {
      got_error=0;retry++;
!     xv_max_width=xvWidth=XV_SRC_WIDTH;
!     xv_max_height=xvHeight = XV_SRC_HEIGHT;
      if (retry<2) {
              fprintf(stderr,"Error initializing Xv. Retry.\n");
***************
*** 1239,1242 ****
--- 1289,1324 ----
  }
  
+ void cXvVideoOut::DeInitXv() {
+   printf("DeinitXv\n");fflush(stdout);
+   pthread_mutex_lock(&xv_mutex);
+ 
+   XvStopVideo(dpy, port, win);
+   XvUngrabPort(dpy, port, CurrentTime);
+ 
+ 
+   if (xv_image->data) {
+     if(useShm && shminfo.shmaddr)
+     {
+       shmdt(shminfo.shmaddr);
+       shminfo.shmaddr = NULL;
+       XShmDetach(dpy, &shminfo);
+     }
+     if (!useShm) {
+       free(xv_image->data);
+     };
+     xv_image->data = NULL;
+   };
+   XSync(dpy, False);
+   pthread_mutex_unlock(&xv_mutex);
+ 
+   if (xv_image)
+   {
+     free(xv_image);
+     xv_image = NULL;
+   }
+ 
+   xv_initialized = 0;
+ };
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 1339,1351 ****
  };
  
  /*----------------------------------------------------------------------------
   */
  
! int cXvVideoOut::PutXvImage() {
    if (useShm)
      return XvShmPutImage(dpy, port,
                       win, gc,
                       xv_image,
!                      sxoff, syoff,      /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
--- 1421,1521 ----
  };
  
+ /*-------------------------------------------------------------------------*/
+ 
+ void cXvVideoOut::DestroyXvImage(Display *dpy,XvPortID port,
+                   XvImage *&xv_image,
+                   XShmSegmentInfo &shminfo ) {
+   if (!xv_image)
+           return;
+   
+   if (xv_image->data) {
+     if(useShm && shminfo.shmaddr)
+     {
+       shmdt(shminfo.shmaddr);
+       shminfo.shmaddr = NULL;
+       XShmDetach(dpy, &shminfo);
+       shminfo.shmid = -1;
+     }
+     if (!useShm) {
+       free(xv_image->data);
+     };
+     xv_image->data = NULL;
+   };
+ 
+   free(xv_image);
+   xv_image=NULL;
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ bool cXvVideoOut::AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
+                     int w, int h) {
+ 
+   if ( pix_fmt != PIX_FMT_YUV420P || format != FOURCC_YV12 ||
+        !xv_initialized 
+ #ifdef NO_DIRECT_RENDERING
+        || 1
+ #endif
+        ) {
+     // no direct rendering 
+     return cVideoOut::AllocPicBuffer(buf_num,pix_fmt,w,h);
+   };
+ 
+   pthread_mutex_lock(&xv_mutex);
+   CreateXvImage(dpy,port,dr_image[buf_num],dr_shminfo[buf_num],
+       format,w, h);
+   XSync(dpy, False);
+   pthread_mutex_unlock(&xv_mutex);
+ 
+   XvImage *image=dr_image[buf_num];
+   
+   sPicBuffer *buf=&PicBuffer[buf_num];
+ 
+   buf->pixel[0] = (uint8_t *) (image->data + image->offsets[0]);
+   buf->pixel[1] = (uint8_t *) (image->data + image->offsets[2]);
+   buf->pixel[2] = (uint8_t *) (image->data + image->offsets[1]);
+   
+   buf->stride[0] = image->pitches[0];
+   buf->stride[1] = image->pitches[2];
+   buf->stride[2] = image->pitches[1];
+ 
+   buf->max_height=h;
+   buf->max_width=w;
+   buf->format=pix_fmt;
+   return true;
+ };
+ 
+ void cXvVideoOut::ReleasePicBuffer(int buf_num) {
+ 
+   if ( !dr_image[buf_num] ) {
+     // no direct rendering
+     cVideoOut::ReleasePicBuffer(buf_num);
+     return;
+   };
+   
+   pthread_mutex_lock(&xv_mutex);
+   DestroyXvImage(dpy, port, dr_image[buf_num], dr_shminfo[buf_num] ); 
+   pthread_mutex_unlock(&xv_mutex);
+   
+   sPicBuffer *buf=&PicBuffer[buf_num];
+ 
+   for (int i=0; i<4; i++) {
+     buf->pixel[i]=NULL;
+   };
+   buf->max_height=0;
+   buf->max_width=0;
+   buf->format=PIX_FMT_NB;
+ };
+ 
  /*----------------------------------------------------------------------------
   */
  
! int cXvVideoOut::PutXvImage(XvImage *xv_image, 
!                             int edge_width, int edge_height) {
    if (useShm)
      return XvShmPutImage(dpy, port,
                       win, gc,
                       xv_image,
!                      sxoff+edge_width, syoff+edge_height,      /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
***************
*** 1356,1360 ****
                       win, gc,
                       xv_image,
!                      sxoff, syoff,      /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
--- 1526,1530 ----
                       win, gc,
                       xv_image,
!                      sxoff+edge_width, syoff+edge_height,      /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
***************
*** 1376,1406 ****
      return;
  
!   pthread_mutex_lock(&xv_mutex);
! 
!   XvStopVideo(dpy, port, win);
!   XvUngrabPort(dpy, port, CurrentTime);
! 
! 
!   if (xv_image->data) {
!     if(useShm && shminfo.shmaddr)
!     {
!       shmdt(shminfo.shmaddr);
!       shminfo.shmaddr = NULL;
!       XShmDetach(dpy, &shminfo);
!     }
!     if (!useShm) {
!       free(xv_image->data);
!     };
!     xv_image->data = NULL;
!   };
!   pthread_mutex_unlock(&xv_mutex);
! 
!   if (xv_image)
!   {
!     free(xv_image);
!     xv_image = NULL;
!   }
! 
!   xv_initialized = 0;
  }
  
--- 1546,1550 ----
      return;
  
!   DeInitXv();
  }
  
***************
*** 1409,1413 ****
  bool cXvVideoOut::Resume(void)
  {
!   return Reconfigure(format);
  }
  
--- 1553,1557 ----
  bool cXvVideoOut::Resume(void)
  {
!   return Reconfigure(currentPixelFormat);
  }
  
***************
*** 1618,1621 ****
--- 1762,1776 ----
  void cXvVideoOut::YUV(sPicBuffer *buf)
  {
+   if ( (xvWidth != buf->max_width && xv_max_width >= buf->max_width) ||
+        (xvHeight != buf->max_height && xv_max_height >= buf->max_height) ||
+        currentPixelFormat != setupStore->pixelFormat) {
+   
+           if (xv_initialized)
+                   DeInitXv();
+           if ( !Reconfigure(setupStore->pixelFormat,
+                                   buf->max_width,buf->max_height) )
+                   return;
+   };
+ 
    if (!videoInitialized || !xv_initialized)
      return;
***************
*** 1637,1640 ****
--- 1792,1811 ----
      ClearXvArea (0, 128, 128);
    }
+ 
+   if ( 0 && buf->owner == this ) {
+     int buf_num=0;
+     while ( &PicBuffer[buf_num]!= buf && buf_num<LAST_PICBUF)
+       buf_num++;
+ 
+     if ( buf_num<LAST_PICBUF && 
+         !(OSDpresent&& current_osdMode==OSDMODE_SOFTWARE) ) {
+       PutXvImage(dr_image[buf_num],buf->edge_width,buf->edge_height);
+       XSync(dpy, False);
+       pthread_mutex_unlock(&xv_mutex);
+       return;
+     };
+   };
+ 
+   
    uint8_t *Py=buf->pixel[0]
                  +(buf->edge_height)*buf->stride[0]
***************
*** 1660,1734 ****
    // if (0) {
    if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
!         {
!           AlphaBlend(pixels[0]+i*xvWidth+2*cutLeft,
!                      OsdPy+i*OSD_FULL_WIDTH+2*cutLeft,
!                      Py + i * Ystride+2*cutLeft,
!                      OsdPAlphaY+i*OSD_FULL_WIDTH+2*cutLeft,
!                      fwidth-2*(cutLeft+cutRight));
!         }
! 
!         for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!         {
!           AlphaBlend(pixels[1]+i*xvWidth/2+cutLeft,
!                      OsdPv+i*OSD_FULL_WIDTH/2+cutLeft,
!                      Pv+ i * UVstride+cutLeft,
!                      OsdPAlphaUV+i*OSD_FULL_WIDTH/2+cutLeft,
!                      fwidth/2-(cutLeft+cutRight));
!         }
! 
!         for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!         {
!           AlphaBlend(pixels[2]+i*xvWidth/2+cutLeft,
!                      OsdPu+i*OSD_FULL_WIDTH/2+cutLeft,
!                      Pu+i*UVstride+cutLeft,
!                      OsdPAlphaUV+i*OSD_FULL_WIDTH/2+cutLeft,
!                      fwidth/2-(cutLeft+cutRight));
!         }
! 
    }
      else
  #endif
      {
! 
!       switch (format) {
!         case FOURCC_YV12:
!         case FOURCC_I420:
!           for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
!              fast_memcpy(pixels [0] + i * xvWidth + 2 * cutLeft,
!                          Py + i * Ystride + 2 * cutLeft,
!                          fwidth - 2 * (cutLeft + cutRight));
!           for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!              fast_memcpy (pixels [1] + i * xvWidth / 2 + cutLeft,
!                           Pv + i * UVstride + cutLeft,
!                           fwidth / 2 - (cutLeft + cutRight));
!           for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!              fast_memcpy (pixels [2] + i * xvWidth / 2 + cutLeft,
!                           Pu + i * UVstride + cutLeft,
!                           fwidth / 2 - (cutLeft + cutRight));
!           break;
!         case FOURCC_YUY2:
!       if (interlaceMode) {
!           yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                pixels[0] + 2*xvWidth * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, 2*xvWidth);
!       } else {
!           yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                pixels[0] + 2*xvWidth * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, 2*xvWidth);
!       }
!           break;
!       }
      }
    }
!   PutXvImage();
    XSync(dpy, False);
    pthread_mutex_unlock(&xv_mutex);
--- 1831,1846 ----
    // if (0) {
    if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         CopyPicBufAlphaBlend(&privBuf,buf,
!                         OsdPy,OsdPu,OsdPv,
!                         OsdPAlphaY,OsdPAlphaUV,OSD_FULL_WIDTH,
!                         cutTop,cutBottom,cutLeft,cutRight);
    }
      else
  #endif
      {
!        CopyPicBuf(&privBuf,buf,cutTop,cutBottom,cutLeft,cutRight);
      }
    }
!   PutXvImage(xv_image,privBuf.edge_width,privBuf.edge_height);
    XSync(dpy, False);
    pthread_mutex_unlock(&xv_mutex);

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** video-xv.h	25 Jul 2006 19:58:12 -0000	1.22
--- video-xv.h	27 Aug 2006 13:02:50 -0000	1.23
***************
*** 144,147 ****
--- 144,153 ----
    XImage            *osd_image;
    int               osd_max_width,osd_max_height;
+   int               xv_max_width,xv_max_height;
+   sPicBuffer        privBuf;
+ 
+   XvImage           *dr_image[LAST_PICBUF];
+   XShmSegmentInfo   dr_shminfo[LAST_PICBUF];
+ 
  private:
    unsigned char     *osd_buffer,
***************
*** 167,170 ****
--- 173,180 ----
    virtual void ProcessEvents ();
    void ShowOSD ();
+  
+   virtual void ReleasePicBuffer(int buf_num);
+   virtual bool AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
+                         int w, int h);
  
  #if VDRVERSNUM >= 10307
***************
*** 184,191 ****
    virtual void CloseOSD();
    virtual bool Initialize (void);
!   virtual bool Reconfigure (int format = FOURCC_YUY2);
    void CreateXvImage(Display *dpy,XvPortID port,XvImage *&xv_image,
                    XShmSegmentInfo &shminfo,int format, int &width, int &height);
!   int PutXvImage();
    virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);
--- 194,206 ----
    virtual void CloseOSD();
    virtual bool Initialize (void);
!   virtual bool Reconfigure (int format = 0, 
!                   int width = XV_SRC_WIDTH, int height = XV_SRC_HEIGHT);
!   void DeInitXv();
    void CreateXvImage(Display *dpy,XvPortID port,XvImage *&xv_image,
                    XShmSegmentInfo &shminfo,int format, int &width, int &height);
!   void DestroyXvImage(Display *dpy,XvPortID port,
!                   XvImage *&xv_image,
!                   XShmSegmentInfo &shminfo ); 
!   int PutXvImage(XvImage *xv_image, int edge_width=0, int edge_height=0);
    virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.60
retrieving revision 1.61
diff -C2 -d -r1.60 -r1.61
*** video.c	12 Jul 2006 18:40:16 -0000	1.60
--- video.c	27 Aug 2006 13:02:50 -0000	1.61
***************
*** 19,23 ****
  #include "sync-timer.h"
  
! //#define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef OSDDEB
--- 19,23 ----
  #include "sync-timer.h"
  
! #define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef OSDDEB
***************
*** 59,63 ****
    //start osd thread
    active=true;
!   Start();
  }
  
--- 59,63 ----
    //start osd thread
    active=true;
!   //Start();
  }
  
***************
*** 112,116 ****
        if (old_picture)
        {
!         OSDDEB("redrawing old_picture\n");
          DrawStill_420pl(old_picture);
        }
--- 112,116 ----
        if (old_picture)
        {
!         OSDDEB("redrawing old_picture osd_changed %d\n",Osd_changed);
          DrawStill_420pl(old_picture);
        }
***************
*** 130,134 ****
          tmpBuf.aspect_ratio=((float)OSD_FULL_WIDTH)/((float)OSD_FULL_HEIGHT);
          tmpBuf.dtg_active_format=0;
!         OSDDEB("drawing osd_layer\n");
          DrawStill_420pl(&tmpBuf);
        }
--- 130,134 ----
          tmpBuf.aspect_ratio=((float)OSD_FULL_WIDTH)/((float)OSD_FULL_HEIGHT);
          tmpBuf.dtg_active_format=0;
!         OSDDEB("drawing osd_layer osd_changed %d\n",Osd_changed);
          DrawStill_420pl(&tmpBuf);
        }

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** video.h	27 May 2006 19:12:41 -0000	1.40
--- video.h	27 Aug 2006 13:02:50 -0000	1.41
***************
*** 32,35 ****
--- 32,38 ----
  #define OSD_FULL_HEIGHT   576
  
+ #define SRC_HEIGHT         576
+ #define SRC_WIDTH          736
+ 
  #if VDRVERSNUM < 10307
  
***************
*** 144,148 ****
      virtual void DrawStill_420pl(sPicBuffer *buf);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
!     virtual bool Reconfigure (int format) {return 1;};
  
      virtual void Suspend(void) { return;};
--- 147,153 ----
      virtual void DrawStill_420pl(sPicBuffer *buf);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
!     virtual bool Reconfigure (int format = 0,
!                     int width = SRC_WIDTH, int height = SRC_HEIGHT)
!     {return 1;};
  
      virtual void Suspend(void) { return;};



From nobody at sheep.berlios.de  Sun Aug 27 15:05:00 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 27 Aug 2006 15:05:00 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.219,1.220
Message-ID: <20060827130500.E6F0B71A8C@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29973

Modified Files:
	CHANGELOG 
Log Message:
- update changelog


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.219
retrieving revision 1.220
diff -C2 -d -r1.219 -r1.220
*** CHANGELOG	27 Aug 2006 12:48:46 -0000	1.219
--- CHANGELOG	27 Aug 2006 13:04:38 -0000	1.220
***************
*** 2,5 ****
--- 2,7 ----
  2006-08-27:
     - adjust ffmpeg library order in configure
+    - enable different pixel formats in video-xv
+    - properly init ctl->key (reported by Matthias Schwarzott)
  2006-08-05:
     - video-dfb: disable reported failed flags in SetParams()



From nobody at sheep.berlios.de  Mon Sep  4 22:25:41 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon,  4 Sep 2006 22:25:41 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice ShmClient.c, 1.15, 1.16 shm-common.h,
	1.5, 1.6 video-shm.c, 1.9, 1.10 video-shm.h, 1.6,
	1.7 video-xv.h, 1.23, 1.24
Message-ID: <20060904202541.9C17C75CD2@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22704

Modified Files:
	ShmClient.c shm-common.h video-shm.c video-shm.h video-xv.h 
Log Message:
- fix wrong colors when using ShmClient


Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** ShmClient.c	27 Aug 2006 13:02:50 -0000	1.15
--- ShmClient.c	4 Sep 2006 20:25:17 -0000	1.16
***************
*** 98,102 ****
                  exit(-1);
          };
!         
          while (!vout->Reconfigure(SetupStore.pixelFormat) 
                          && SetupStore.pixelFormat < 3 )
--- 98,102 ----
                  exit(-1);
          };
!        
          while (!vout->Reconfigure(SetupStore.pixelFormat) 
                          && SetupStore.pixelFormat < 3 )
***************
*** 107,117 ****
                  ctl->max_width=vout->xv_image->width;
                  ctl->max_height=vout->xv_image->height;
!                 ctl->stride0=vout->xv_image->pitches[0];
!                 ctl->stride1=vout->xv_image->pitches[1];
!                 ctl->stride2=vout->xv_image->pitches[2];
                  picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
!                 picture.stride[0]=ctl->stride0;
!                 picture.stride[1]=ctl->stride1;
!                 picture.stride[2]=ctl->stride1;
                  picture.edge_width=picture.edge_height=0;
                  picture.max_width=ctl->max_width;
--- 107,138 ----
                  ctl->max_width=vout->xv_image->width;
                  ctl->max_height=vout->xv_image->height;
!                 ctl->format=vout->privBuf.format;
!                 switch (vout->GetFormat()) {
!                         case FOURCC_I420:
!                                 ctl->offset0=vout->xv_image->offsets[0];
!                                 ctl->offset1=vout->xv_image->offsets[1];
!                                 ctl->offset2=vout->xv_image->offsets[2];
!                                 ctl->stride0=vout->xv_image->pitches[0];
!                                 ctl->stride1=vout->xv_image->pitches[1];
!                                 ctl->stride2=vout->xv_image->pitches[2];
!                                 break;
!                         case FOURCC_YV12:
!                                 ctl->offset0=vout->xv_image->offsets[0];
!                                 ctl->offset1=vout->xv_image->offsets[2];
!                                 ctl->offset2=vout->xv_image->offsets[1];
!                                 ctl->stride0=vout->xv_image->pitches[0];
!                                 ctl->stride1=vout->xv_image->pitches[2];
!                                 ctl->stride2=vout->xv_image->pitches[1];
!                                 break;
!                         case FOURCC_YUY2:
!                                 ctl->offset0=vout->xv_image->offsets[0];
!                                 ctl->offset1=ctl->offset2=0;
!                                 ctl->stride0=vout->xv_image->pitches[0];
!                                 ctl->stride1=ctl->stride2=0;
!                                 break;
!                 };
!                 
                  picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
!                 picture.stride[0]=picture.stride[1]=picture.stride[2]=0;
                  picture.edge_width=picture.edge_height=0;
                  picture.max_width=ctl->max_width;

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** shm-common.h	1 Apr 2006 08:26:56 -0000	1.5
--- shm-common.h	4 Sep 2006 20:25:17 -0000	1.6
***************
*** 19,23 ****
  
  
! #define CTL_KEY 5678 
  
  union semun {
--- 19,23 ----
  
  
! #define CTL_KEY 5679 
  
  union semun {
***************
*** 43,46 ****
--- 43,47 ----
          int pict_shmid;
          
+         PixelFormat format;
          int max_width;
          int max_height;        
***************
*** 49,52 ****
--- 50,56 ----
          int new_afd;
          double new_asp;
+         int offset0;
+         int offset1;
+         int offset2;
          int stride0;
          int stride1;

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-shm.c	27 Aug 2006 13:02:50 -0000	1.9
--- video-shm.c	4 Sep 2006 20:25:17 -0000	1.10
***************
*** 323,327 ****
                         }
                         curr_pict_shmid=ctl->pict_shmid;
!                        privBuf.format=PIX_FMT_YUV420P;//ctl->format;
                         privBuf.max_width=ctl->max_width;
                         privBuf.max_height=ctl->max_height;
--- 323,327 ----
                         }
                         curr_pict_shmid=ctl->pict_shmid;
!                        privBuf.format=ctl->format;
                         privBuf.max_width=ctl->max_width;
                         privBuf.max_height=ctl->max_height;
***************
*** 329,342 ****
                          case PIX_FMT_YUV420P:  
                                  SHMDEB("new format YUV420P\n");
!                                 pixels[0]=privBuf.pixel[0]=curr_pict;
!                                 pixels[2]=privBuf.pixel[2]=curr_pict+ctl->max_height*ctl->stride0;
!                                 pixels[1]=privBuf.pixel[1]=privBuf.pixel[2]+ctl->max_height/2*ctl->stride1;
                                  privBuf.stride[0]=ctl->stride0;
!                                 privBuf.stride[1]=privBuf.stride[2]=ctl->stride1;
                                  break;
                          case PIX_FMT_YUV422:
                                  SHMDEB("new format YUV422\n");
!                                 privBuf.pixel[0]=curr_pict;
                                  privBuf.stride[0]=ctl->stride0;
                                  break;
                          default:
--- 329,345 ----
                          case PIX_FMT_YUV420P:  
                                  SHMDEB("new format YUV420P\n");
!                                 privBuf.pixel[0]=curr_pict+ctl->offset0;
!                                 privBuf.pixel[1]=curr_pict+ctl->offset1;
!                                 privBuf.pixel[2]=curr_pict+ctl->offset2;
                                  privBuf.stride[0]=ctl->stride0;
!                                 privBuf.stride[1]=ctl->stride1;
!                                 privBuf.stride[2]=ctl->stride2;
                                  break;
                          case PIX_FMT_YUV422:
                                  SHMDEB("new format YUV422\n");
!                                 privBuf.pixel[0]=curr_pict+ctl->offset0;
!                                 privBuf.pixel[1]=privBuf.pixel[1]=NULL;
                                  privBuf.stride[0]=ctl->stride0;
+                                 privBuf.stride[1]=privBuf.stride[2]=0;
                                  break;
                          default:
***************
*** 346,350 ****
                  };
          };
- 
          
          if (!ctl->pict_shmid || !curr_pict) {
--- 349,352 ----
***************
*** 367,404 ****
                                  OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV, OSD_FULL_WIDTH,
                                  0,0,0,0);                
! /*                for (int i = 0; i < height; i++)
!                         AlphaBlend(pixels [0] + i * ctl->stride0,
!                                        OsdPy+i*OSD_FULL_WIDTH,
!                                        Py + i * Ystride,
!                                        OsdPAlphaY+i*OSD_FULL_WIDTH,
!                                        width );
!                 for (int i = 0; i < height / 2; i++)
!                         AlphaBlend(pixels [2] + i * ctl->stride1,
!                                         OsdPu+i*OSD_FULL_WIDTH/2,
!                                         Pu + i * UVstride ,
!                                         OsdPAlphaUV+i*OSD_FULL_WIDTH/2,
!                                         width/2);
!                 for (int i = 0; i < height / 2 ; i++)
!                         AlphaBlend(pixels [1] + i * ctl->stride2 ,
!                                         OsdPv+i*OSD_FULL_WIDTH/2,
!                                         Pv + i * UVstride,
!                                         OsdPAlphaUV+i*OSD_FULL_WIDTH/2,
!                                         width / 2);
!   */      } else {
                  CopyPicBuf(&privBuf,buf,0,0,0,0);
-                /* 
-                 for (int i = 0; i < height; i++)
-                         fast_memcpy(pixels [0] + i * ctl->stride0,
-                                         Py + i * Ystride,
-                                         width );
-                 for (int i = 0; i < height / 2; i++)
-                         fast_memcpy (pixels [2] + i * ctl->stride1,
-                                         Pu + i * UVstride,
-                                         width / 2);
-                 for (int i = 0; i < height / 2 ; i++)
-                         fast_memcpy (pixels [1] + i * ctl->stride2 ,
-                                         Pv + i * UVstride,
-                                         width / 2);
- */
          };
          ctl->new_pict++;
--- 369,374 ----
                                  OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV, OSD_FULL_WIDTH,
                                  0,0,0,0);                
!      } else {
                  CopyPicBuf(&privBuf,buf,0,0,0,0);
          };
          ctl->new_pict++;

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video-shm.h	27 Aug 2006 13:02:50 -0000	1.6
--- video-shm.h	4 Sep 2006 20:25:17 -0000	1.7
***************
*** 35,39 ****
          int curr_pict_shmid;
          uint8_t *curr_pict;
-         uint8_t *pixels[4];
          sPicBuffer privBuf;
  
--- 35,38 ----

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** video-xv.h	27 Aug 2006 13:02:50 -0000	1.23
--- video-xv.h	4 Sep 2006 20:25:17 -0000	1.24
***************
*** 196,199 ****
--- 196,201 ----
    virtual bool Reconfigure (int format = 0, 
                    int width = XV_SRC_WIDTH, int height = XV_SRC_HEIGHT);
+   int GetFormat() const
+   {return format;};
    void DeInitXv();
    void CreateXvImage(Display *dpy,XvPortID port,XvImage *&xv_image,



From nobody at sheep.berlios.de  Mon Sep  4 22:30:17 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon,  4 Sep 2006 22:30:17 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-xv.c, 1.59, 1.60 CHANGELOG, 1.220,
	1.221 video.c, 1.61, 1.62
Message-ID: <20060904203017.EAF86764A4@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23327

Modified Files:
	video-xv.c CHANGELOG video.c 
Log Message:
- disable debuging printouts
- cleanup


Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.59
retrieving revision 1.60
diff -C2 -d -r1.59 -r1.60
*** video-xv.c	27 Aug 2006 13:02:50 -0000	1.59
--- video-xv.c	4 Sep 2006 20:29:53 -0000	1.60
***************
*** 1223,1236 ****
        
        privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
        if (format == FOURCC_YV12) {
                privBuf.pixel[1] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
                privBuf.pixel[2] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
        } else {
-               privBuf.pixel[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
                privBuf.pixel[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
        };
-       privBuf.stride[0] = xv_image->pitches[0];
-       privBuf.stride[1] = xv_image->pitches[2];
-       privBuf.stride[2] = xv_image->pitches[1];
  
        privBuf.format = PIX_FMT_YUV420P;
--- 1223,1238 ----
        
        privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
+       privBuf.stride[0] = xv_image->pitches[0];
        if (format == FOURCC_YV12) {
                privBuf.pixel[1] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
                privBuf.pixel[2] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
+               privBuf.stride[1] = xv_image->pitches[2];
+               privBuf.stride[2] = xv_image->pitches[1];
        } else {
                privBuf.pixel[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
+               privBuf.pixel[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
+               privBuf.stride[1] = xv_image->pitches[1];
+               privBuf.stride[2] = xv_image->pitches[2];
        };
  
        privBuf.format = PIX_FMT_YUV420P;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.220
retrieving revision 1.221
diff -C2 -d -r1.220 -r1.221
*** CHANGELOG	27 Aug 2006 13:04:38 -0000	1.220
--- CHANGELOG	4 Sep 2006 20:29:53 -0000	1.221
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2006-09-04:
+    - fix wrong colors when using ShmClient (reported by Matthias Schwarzott
+      and derWolf at vdrportal)
+    - disable debuging printouts
+    - cleanup
  2006-08-27:
     - adjust ffmpeg library order in configure

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.61
retrieving revision 1.62
diff -C2 -d -r1.61 -r1.62
*** video.c	27 Aug 2006 13:02:50 -0000	1.61
--- video.c	4 Sep 2006 20:29:54 -0000	1.62
***************
*** 19,23 ****
  #include "sync-timer.h"
  
! #define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef OSDDEB
--- 19,23 ----
  #include "sync-timer.h"
  
! //#define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef OSDDEB



From nobody at sheep.berlios.de  Mon Sep  4 22:37:32 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon,  4 Sep 2006 22:37:32 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.221, 1.222 PicBuffer.c, 1.6,
	1.7
Message-ID: <20060904203732.2FF9476A51@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24751

Modified Files:
	CHANGELOG PicBuffer.c 
Log Message:
- set sPicBuffer completly to zero


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.221
retrieving revision 1.222
diff -C2 -d -r1.221 -r1.222
*** CHANGELOG	4 Sep 2006 20:29:53 -0000	1.221
--- CHANGELOG	4 Sep 2006 20:37:07 -0000	1.222
***************
*** 5,8 ****
--- 5,9 ----
     - disable debuging printouts
     - cleanup
+    - set sPicBuffer completly to zero
  2006-08-27:
     - adjust ffmpeg library order in configure

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** PicBuffer.c	10 Jul 2006 17:56:29 -0000	1.6
--- PicBuffer.c	4 Sep 2006 20:37:07 -0000	1.7
***************
*** 23,31 ****
  
  void InitPicBuffer(sPicBuffer *Pic) {
!         memset(Pic->pixel,0,sizeof(Pic->pixel));
!         Pic->use_count=0;
          Pic->pic_num=-256*256*256*64;
          Pic->format=PIX_FMT_NB;
-         Pic->max_width=Pic->max_height=0;
          Pic->buf_num=-1;
  };
--- 23,29 ----
  
  void InitPicBuffer(sPicBuffer *Pic) {
!         memset(Pic,0,sizeof(sPicBuffer));
          Pic->pic_num=-256*256*256*64;
          Pic->format=PIX_FMT_NB;
          Pic->buf_num=-1;
  };



From nobody at sheep.berlios.de  Fri Sep  8 06:59:38 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri,  8 Sep 2006 06:59:38 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video.c, 1.62, 1.63 CHANGELOG, 1.222,
	1.223
Message-ID: <20060908045938.90D2975527@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3819

Modified Files:
	video.c CHANGELOG 
Log Message:
limit destination video offsets to even values

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.62
retrieving revision 1.63
diff -C2 -d -r1.62 -r1.63
*** video.c	4 Sep 2006 20:29:54 -0000	1.62
--- video.c	8 Sep 2006 04:59:02 -0000	1.63
***************
*** 264,271 ****
  
    /* -------------------------------------------------------------------------
!    * center result on display
     */
!   lxoff = (dwidth - lwidth) / 2;
!   lyoff = (dheight - lheight) / 2;
  }
  
--- 264,271 ----
  
    /* -------------------------------------------------------------------------
!    * center result on display, and force offsets to be even.
     */
!   lxoff = ((dwidth - lwidth) / 2) & ~1;
!   lyoff = ((dheight - lheight) / 2) & ~1;
  }
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.222
retrieving revision 1.223
diff -C2 -d -r1.222 -r1.223
*** CHANGELOG	4 Sep 2006 20:37:07 -0000	1.222
--- CHANGELOG	8 Sep 2006 04:59:09 -0000	1.223
***************
*** 1,13 ****
  Changelog
! 2006-09-04:
!    - fix wrong colors when using ShmClient (reported by Matthias Schwarzott
!      and derWolf at vdrportal)
!    - disable debuging printouts
!    - cleanup
!    - set sPicBuffer completly to zero
! 2006-08-27:
!    - adjust ffmpeg library order in configure
!    - enable different pixel formats in video-xv
!    - properly init ctl->key (reported by Matthias Schwarzott)
  2006-08-05:
     - video-dfb: disable reported failed flags in SetParams()
--- 1,15 ----
  Changelog
! 2006-09-08:
!    - limit destination video offsets to even values
! 2006-09-04:
!    - fix wrong colors when using ShmClient (reported by Matthias Schwarzott
!      and derWolf at vdrportal)
!    - disable debuging printouts
!    - cleanup
!    - set sPicBuffer completly to zero
! 2006-08-27:
!    - adjust ffmpeg library order in configure
!    - enable different pixel formats in video-xv
!    - properly init ctl->key (reported by Matthias Schwarzott)
  2006-08-05:
     - video-dfb: disable reported failed flags in SetParams()



From nobody at sheep.berlios.de  Fri Sep  8 17:58:01 2006
From: nobody at sheep.berlios.de (wachm)
Date: Fri,  8 Sep 2006 17:58:01 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.223, 1.224 softdevice.c,
	1.66, 1.67
Message-ID: <20060908155801.0EAF577550@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9352

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
- fix typo in asignment


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.223
retrieving revision 1.224
diff -C2 -d -r1.223 -r1.224
*** CHANGELOG	8 Sep 2006 04:59:09 -0000	1.223
--- CHANGELOG	8 Sep 2006 15:57:35 -0000	1.224
***************
*** 2,5 ****
--- 2,6 ----
  2006-09-08:
     - limit destination video offsets to even values
+    - fix typo in asignment
  2006-09-04:
     - fix wrong colors when using ShmClient (reported by Matthias Schwarzott

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.66
retrieving revision 1.67
diff -C2 -d -r1.66 -r1.67
*** softdevice.c	27 Aug 2006 13:02:50 -0000	1.66
--- softdevice.c	8 Sep 2006 15:57:35 -0000	1.67
***************
*** 245,249 ****
                    // reset to default if all failed...
                    if (setupStore.pixelFormat == 3)
!                           setupStore.pixelFormat == 0;
            };
                    
--- 245,249 ----
                    // reset to default if all failed...
                    if (setupStore.pixelFormat == 3)
!                           setupStore.pixelFormat = 0;
            };
                    



From nobody at sheep.berlios.de  Fri Sep  8 19:05:18 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri,  8 Sep 2006 19:05:18 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice softdevice.c, 1.67, 1.68 CHANGELOG,
	1.224, 1.225
Message-ID: <20060908170518.0BCD677F21@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27917

Modified Files:
	softdevice.c CHANGELOG 
Log Message:
fix xv-out with subplugins disabled

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.67
retrieving revision 1.68
diff -C2 -d -r1.67 -r1.68
*** softdevice.c	8 Sep 2006 15:57:35 -0000	1.67
--- softdevice.c	8 Sep 2006 17:04:52 -0000	1.68
***************
*** 235,240 ****
  #ifdef XV_SUPPORT
          videoOut = new cXvVideoOut (&setupStore);
!         if ( !videoOut->Initialize() ) {
!                 
            if (!videoOut->Reconfigure()) {
                    // XVideo intialization failed, try different pix formats
--- 235,240 ----
  #ifdef XV_SUPPORT
          videoOut = new cXvVideoOut (&setupStore);
!         if ( videoOut->Initialize() ) {
! 
            if (!videoOut->Reconfigure()) {
                    // XVideo intialization failed, try different pix formats
***************
*** 247,251 ****
                            setupStore.pixelFormat = 0;
            };
!                   
            fprintf (stderr, "[softdevice] Xv out OK !\n");
          } else {
--- 247,251 ----
                            setupStore.pixelFormat = 0;
            };
! 
            fprintf (stderr, "[softdevice] Xv out OK !\n");
          } else {

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.224
retrieving revision 1.225
diff -C2 -d -r1.224 -r1.225
*** CHANGELOG	8 Sep 2006 15:57:35 -0000	1.224
--- CHANGELOG	8 Sep 2006 17:04:52 -0000	1.225
***************
*** 3,6 ****
--- 3,7 ----
     - limit destination video offsets to even values
     - fix typo in asignment
+    - fix xv-out with subplugins disabled
  2006-09-04:
     - fix wrong colors when using ShmClient (reported by Matthias Schwarzott



From nobody at sheep.berlios.de  Sat Sep  9 11:55:51 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat,  9 Sep 2006 11:55:51 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.225, 1.226 video-xv.c, 1.60,
	1.61
Message-ID: <20060909095551.BFD037860D@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19983

Modified Files:
	CHANGELOG video-xv.c 
Log Message:
silence some warnings

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.225
retrieving revision 1.226
diff -C2 -d -r1.225 -r1.226
*** CHANGELOG	8 Sep 2006 17:04:52 -0000	1.225
--- CHANGELOG	9 Sep 2006 09:55:25 -0000	1.226
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-09-09:
+    - video-xv.c: silence some warnings
  2006-09-08:
     - limit destination video offsets to even values

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.60
retrieving revision 1.61
diff -C2 -d -r1.60 -r1.61
*** video-xv.c	4 Sep 2006 20:29:53 -0000	1.60
--- video-xv.c	9 Sep 2006 09:55:25 -0000	1.61
***************
*** 809,813 ****
            dr_shminfo[i].shmaddr=NULL;
    };
!   
    InitPicBuffer(&privBuf);
  }
--- 809,813 ----
            dr_shminfo[i].shmaddr=NULL;
    };
! 
    InitPicBuffer(&privBuf);
  }
***************
*** 1079,1083 ****
            return false;
    };
!   
    currentPixelFormat=format;
    format = pixFormat[currentPixelFormat];
--- 1079,1083 ----
            return false;
    };
! 
    currentPixelFormat=format;
    format = pixFormat[currentPixelFormat];
***************
*** 1221,1225 ****
        pixels[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
        pixels[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
!       
        privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
        privBuf.stride[0] = xv_image->pitches[0];
--- 1221,1225 ----
        pixels[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
        pixels[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
! 
        privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
        privBuf.stride[0] = xv_image->pitches[0];
***************
*** 1240,1244 ****
      case FOURCC_YUY2:
        pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
!         
        privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
        privBuf.pixel[1] = NULL;
--- 1240,1244 ----
      case FOURCC_YUY2:
        pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
! 
        privBuf.pixel[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
        privBuf.pixel[1] = NULL;
***************
*** 1248,1252 ****
        privBuf.stride[1] = 0;
        privBuf.stride[2] = 0;
!       
        privBuf.format = PIX_FMT_YUV422;
        break;
--- 1248,1252 ----
        privBuf.stride[1] = 0;
        privBuf.stride[2] = 0;
! 
        privBuf.format = PIX_FMT_YUV422;
        break;
***************
*** 1430,1434 ****
    if (!xv_image)
            return;
!   
    if (xv_image->data) {
      if(useShm && shminfo.shmaddr)
--- 1430,1434 ----
    if (!xv_image)
            return;
! 
    if (xv_image->data) {
      if(useShm && shminfo.shmaddr)
***************
*** 1455,1464 ****
  
    if ( pix_fmt != PIX_FMT_YUV420P || format != FOURCC_YV12 ||
!        !xv_initialized 
  #ifdef NO_DIRECT_RENDERING
         || 1
  #endif
         ) {
!     // no direct rendering 
      return cVideoOut::AllocPicBuffer(buf_num,pix_fmt,w,h);
    };
--- 1455,1464 ----
  
    if ( pix_fmt != PIX_FMT_YUV420P || format != FOURCC_YV12 ||
!        !xv_initialized
  #ifdef NO_DIRECT_RENDERING
         || 1
  #endif
         ) {
!     // no direct rendering
      return cVideoOut::AllocPicBuffer(buf_num,pix_fmt,w,h);
    };
***************
*** 1471,1475 ****
  
    XvImage *image=dr_image[buf_num];
!   
    sPicBuffer *buf=&PicBuffer[buf_num];
  
--- 1471,1475 ----
  
    XvImage *image=dr_image[buf_num];
! 
    sPicBuffer *buf=&PicBuffer[buf_num];
  
***************
*** 1477,1481 ****
    buf->pixel[1] = (uint8_t *) (image->data + image->offsets[2]);
    buf->pixel[2] = (uint8_t *) (image->data + image->offsets[1]);
!   
    buf->stride[0] = image->pitches[0];
    buf->stride[1] = image->pitches[2];
--- 1477,1481 ----
    buf->pixel[1] = (uint8_t *) (image->data + image->offsets[2]);
    buf->pixel[2] = (uint8_t *) (image->data + image->offsets[1]);
! 
    buf->stride[0] = image->pitches[0];
    buf->stride[1] = image->pitches[2];
***************
*** 1495,1503 ****
      return;
    };
!   
    pthread_mutex_lock(&xv_mutex);
!   DestroyXvImage(dpy, port, dr_image[buf_num], dr_shminfo[buf_num] ); 
    pthread_mutex_unlock(&xv_mutex);
!   
    sPicBuffer *buf=&PicBuffer[buf_num];
  
--- 1495,1503 ----
      return;
    };
! 
    pthread_mutex_lock(&xv_mutex);
!   DestroyXvImage(dpy, port, dr_image[buf_num], dr_shminfo[buf_num] );
    pthread_mutex_unlock(&xv_mutex);
! 
    sPicBuffer *buf=&PicBuffer[buf_num];
  
***************
*** 1513,1517 ****
   */
  
! int cXvVideoOut::PutXvImage(XvImage *xv_image, 
                              int edge_width, int edge_height) {
    if (useShm)
--- 1513,1517 ----
   */
  
! int cXvVideoOut::PutXvImage(XvImage *xv_image,
                              int edge_width, int edge_height) {
    if (useShm)
***************
*** 1767,1771 ****
         (xvHeight != buf->max_height && xv_max_height >= buf->max_height) ||
         currentPixelFormat != setupStore->pixelFormat) {
!   
            if (xv_initialized)
                    DeInitXv();
--- 1767,1771 ----
         (xvHeight != buf->max_height && xv_max_height >= buf->max_height) ||
         currentPixelFormat != setupStore->pixelFormat) {
! 
            if (xv_initialized)
                    DeInitXv();
***************
*** 1800,1804 ****
        buf_num++;
  
!     if ( buf_num<LAST_PICBUF && 
          !(OSDpresent&& current_osdMode==OSDMODE_SOFTWARE) ) {
        PutXvImage(dr_image[buf_num],buf->edge_width,buf->edge_height);
--- 1800,1804 ----
        buf_num++;
  
!     if ( buf_num<LAST_PICBUF &&
          !(OSDpresent&& current_osdMode==OSDMODE_SOFTWARE) ) {
        PutXvImage(dr_image[buf_num],buf->edge_width,buf->edge_height);
***************
*** 1809,1813 ****
    };
  
!   
    uint8_t *Py=buf->pixel[0]
                  +(buf->edge_height)*buf->stride[0]
--- 1809,1813 ----
    };
  
! 
    uint8_t *Py=buf->pixel[0]
                  +(buf->edge_height)*buf->stride[0]
***************
*** 1817,1845 ****
    uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
                  +buf->edge_width/2;
-   int Ystride=buf->stride[0];
-   int UVstride=buf->stride[1];
-   int Width=buf->width;
-   int Height=buf->height;
  
    if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307
!   /* -------------------------------------------------------------------------
!    * don't know where those funny stride values (752,376) come from.
!    * therefor  we have to copy line by line :-( .
!    * Hmm .. for HDTV they should be larger anyway and for some other
!    * unusual resolutions they should be configurable swidth/sheight ?
!    */
! 
!   // if (0) {
!   if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         CopyPicBufAlphaBlend(&privBuf,buf,
!                         OsdPy,OsdPu,OsdPv,
!                         OsdPAlphaY,OsdPAlphaUV,OSD_FULL_WIDTH,
!                         cutTop,cutBottom,cutLeft,cutRight);
!   }
      else
  #endif
      {
!        CopyPicBuf(&privBuf,buf,cutTop,cutBottom,cutLeft,cutRight);
      }
    }
--- 1817,1839 ----
    uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
                  +buf->edge_width/2;
  
    if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307
!     /* -----------------------------------------------------------------------
!      * don't know where those funny stride values (752,376) come from.
!      * therefor  we have to copy line by line :-( .
!      * Hmm .. for HDTV they should be larger anyway and for some other
!      * unusual resolutions they should be configurable swidth/sheight ?
!      */
!     if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!       CopyPicBufAlphaBlend(&privBuf,buf,
!                            OsdPy,OsdPu,OsdPv,
!                            OsdPAlphaY,OsdPAlphaUV,OSD_FULL_WIDTH,
!                            cutTop,cutBottom,cutLeft,cutRight);
!     }
      else
  #endif
      {
!       CopyPicBuf(&privBuf,buf,cutTop,cutBottom,cutLeft,cutRight);
      }
    }



From nobody at sheep.berlios.de  Sat Sep  9 12:36:04 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat,  9 Sep 2006 12:36:04 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.226, 1.227 video-vidix.c,
	1.21, 1.22 video-vidix.h, 1.10, 1.11 setup-softdevice-menu.c,
	1.7, 1.8 setup-softdevice.h, 1.33, 1.34
Message-ID: <20060909103604.CFD6871482@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8038

Modified Files:
	CHANGELOG video-vidix.c video-vidix.h setup-softdevice-menu.c 
	setup-softdevice.h 
Log Message:
video-vidix: offer equalizer settings via OSD (brightness, hue,
             saturation and contrast)
             offer HW-deinetrlace via OSD when available
             (by Roland Praml)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.226
retrieving revision 1.227
diff -C2 -d -r1.226 -r1.227
*** CHANGELOG	9 Sep 2006 09:55:25 -0000	1.226
--- CHANGELOG	9 Sep 2006 10:35:37 -0000	1.227
***************
*** 2,5 ****
--- 2,9 ----
  2006-09-09:
     - video-xv.c: silence some warnings
+    - video-vidix: offer equalizer settings via OSD (brightness, hue,
+                   saturation and contrast)
+                   offer HW-deinetrlace via OSD when available
+                   (by Roland Praml)
  2006-09-08:
     - limit destination video offsets to even values

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** video-vidix.c	17 Jun 2006 20:42:58 -0000	1.21
--- video-vidix.c	9 Sep 2006 10:35:37 -0000	1.22
***************
*** 114,118 ****
      fwidth = lwidth = dwidth = Xres;
      fheight = lheight = dheight = Yres;
! 
      swidth = 720;
      sheight = 576;
--- 114,118 ----
      fwidth = lwidth = dwidth = Xres;
      fheight = lheight = dheight = Yres;
!     useVidixAlpha = false;
      swidth = 720;
      sheight = 576;
***************
*** 134,138 ****
      memset(fb,  0, fb_line_len * Yres );
  
- 
      vidix_version = vdlGetVersion();
  
--- 134,137 ----
***************
*** 196,199 ****
--- 195,249 ----
      printf("cVidixVideoOut: fourcc.flags:  0x%0x\n",vidix_fourcc.flags);
      AllocLayer();
+ 
+     /* -----------------------------------------------------------------------
+      * check presence of equalizer capability
+      */
+     vidix_video_eq_t tmpeq;
+     printf("cVidixVideoOut: capabilities  ", vidix_curr_eq.cap);
+ 
+     if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {
+         vidix_curr_eq=tmpeq;
+         printf("EQ cap: %x: ", vidix_curr_eq.cap);
+         if (vidix_curr_eq.cap & VEQ_CAP_BRIGHTNESS) {
+             printf("brightness (%d) ", vidix_curr_eq.brightness);
+             setupStore->vidCaps |= CAP_BRIGHTNESS;
+         }
+         if (vidix_curr_eq.cap & VEQ_CAP_CONTRAST) {
+             printf("contrast (%d) ", vidix_curr_eq.contrast);
+             setupStore->vidCaps |= CAP_CONTRAST;
+         }
+         if (vidix_curr_eq.cap & VEQ_CAP_SATURATION) {
+             printf("saturation (%d) ", vidix_curr_eq.saturation);
+             setupStore->vidCaps |= CAP_SATURATION;
+         }
+         if (vidix_curr_eq.cap & VEQ_CAP_HUE) {
+             printf("hue (%d) ", vidix_curr_eq.hue);
+             setupStore->vidCaps |= CAP_HUE;
+         }
+         if (vidix_curr_eq.cap & VEQ_CAP_RGB_INTENSITY) {
+             printf("RGB-intensity (%d, %d, %d) ",
+                    vidix_curr_eq.red_intensity,
+                    vidix_curr_eq.green_intensity,
+                    vidix_curr_eq.blue_intensity );
+         }
+     } else {
+        isyslog("[cVidixVideoOut] Couldn't get EQ capability\n");
+     }
+ 
+     /* -----------------------------------------------------------------------
+      * check presence of hw deinterlace capability
+      */
+     vidix_deinterlace_t vidix_deint;
+ 
+     if (!vdlPlaybackGetDeint(vidix_handler, &vidix_deint) &&
+         !vdlPlaybackSetDeint(vidix_handler, &vidix_deint)) {
+         printf("HW-deinterlace (%x,%x)",
+                vidix_deint.flags,
+                vidix_deint.deinterlace_pattern);
+ 
+         setupStore->vidCaps |= CAP_HWDEINTERLACE;
+     }
+ 
+     printf("\n");
  }
  
***************
*** 223,226 ****
--- 273,279 ----
  void cVidixVideoOut::SetParams(int Ystride, int UVstride)
  {
+     vidix_video_eq_t  vidix_video_eq;
+     int               err;
+ 
    if (aspect_changed || currentPixelFormat != setupStore->pixelFormat ||
        cutTop != setupStore->cropTopLines ||
***************
*** 302,305 ****
--- 355,428 ----
  #endif
    }
+ 
+   vidix_video_eq=vidix_curr_eq;
+ 
+   vidix_video_eq.brightness = (setupStore->vidBrightness - 50)*20;
+   vidix_video_eq.contrast = (setupStore->vidContrast - 50)*20;
+   vidix_video_eq.saturation = (setupStore->vidSaturation - 50)*20;
+   vidix_video_eq.hue = (setupStore->vidHue - 50)*20;
+ 
+   if (vidix_curr_eq.brightness != vidix_video_eq.brightness ||
+       vidix_curr_eq.contrast != vidix_video_eq.contrast ||
+       vidix_curr_eq.saturation != vidix_video_eq.saturation ||
+       vidix_curr_eq.hue != vidix_video_eq.hue ) {
+ 
+       printf("cVidixVideoOut : set eq values\n");
+       vidix_curr_eq = vidix_video_eq;
+       if( (err = vdlPlaybackSetEq(vidix_handler, &vidix_curr_eq)) != 0) {
+           isyslog("[cVidixVideoOut] Couldn't set EQ capability: %s\n",
+                   strerror(err) );
+           printf("FAILED!!!\n");
+       }
+   }
+ 
+   if (setupStore->vidDeinterlace > 10)
+       setupStore->vidDeinterlace = 10;
+ 
+   if (setupStore->vidDeinterlace != vidix_curr_deinterlace) {
+ 
+       vidix_deinterlace_t vidix_deint;
+ 
+       vidix_curr_deinterlace = setupStore->vidDeinterlace;
+       switch (vidix_curr_deinterlace)
+       {
+           case 0: // CFG_NON_INTERLACED
+               vidix_deint.flags = CFG_NON_INTERLACED;
+               break;
+           case 1: // CFG_INTERLACED
+           case 2: // CFG_EVEN_ODD_INTERLACING
+           case 3:
+               vidix_deint. flags = CFG_EVEN_ODD_INTERLACING;
+               break;
+           case 4: // CFG_ODD_EVEN_INTERLACING
+           case 5:
+           case 6:
+           case 7:
+               vidix_deint. flags = CFG_ODD_EVEN_INTERLACING;
+               break;
+           case 8: // CFG_UNIQUE_INTERLACING
+                   // xorg METHOD_BOB
+               vidix_deint. flags = CFG_UNIQUE_INTERLACING;
+               vidix_deint. deinterlace_pattern = 0xAAAAA;
+               break;
+           case 9: // CFG_UNIQUE_INTERLACING
+                   // xorg METHOD_SINGLE
+               vidix_deint. flags = CFG_UNIQUE_INTERLACING;
+               vidix_deint. deinterlace_pattern = 0xEEEEE | (9<<28);
+               break;
+           case 10: // xorg METHOD_WEAVE
+               vidix_deint. flags = CFG_UNIQUE_INTERLACING;
+               vidix_deint. deinterlace_pattern = 0;
+               break;
+           default:
+               vidix_deint.flags = CFG_NON_INTERLACED;
+               break;
+       }
+       vdlPlaybackSetDeint(vidix_handler, &vidix_deint);
+       vdlPlaybackGetDeint(vidix_handler, &vidix_deint);
+       printf("Deinterlacer: %x %x\n",
+              vidix_deint.flags,
+              vidix_deint.deinterlace_pattern);
+   }
  }
  
***************
*** 338,350 ****
    if (vidix_fourcc.flags & VID_CAP_COLORKEY)
    {
!     printf("cVidixVideoOut: set colorkey\n");
      vdlGetGrKeys(vidix_handler, &gr_key);
  
      gr_key.key_op = KEYS_PUT;
! 
      gr_key.ckey.op = CKEY_TRUE;
      gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
  
!     vdlSetGrKeys(vidix_handler, &gr_key);
    }
  
--- 461,491 ----
    if (vidix_fourcc.flags & VID_CAP_COLORKEY)
    {
!     int res = 0;
! 
!     printf("cVidixVideoOut: set colorkey ");
      vdlGetGrKeys(vidix_handler, &gr_key);
  
      gr_key.key_op = KEYS_PUT;
! #ifdef CKEY_ALPHA
!     if (vidix_fourcc.flags & VID_CAP_BLEND) {
!       useVidixAlpha = true;
!       gr_key.ckey.op = CKEY_ALPHA;
!     } else {
!       gr_key.ckey.op = CKEY_TRUE;
!     }
! #else
      gr_key.ckey.op = CKEY_TRUE;
+ #endif
      gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
+     res = vdlSetGrKeys(vidix_handler, &gr_key);
+     printf ("vdlSetGrKeys() = %d, ", res);
  
!     if (res) {
!       gr_key.ckey.op = CKEY_TRUE;
!       res = vdlSetGrKeys(vidix_handler, &gr_key);
!       printf (" - %d", res);
!       useVidixAlpha = false;
!     }
!     printf ("\n");
    }
  
***************
*** 596,599 ****
--- 737,752 ----
  {
    current_osdMode = setupStore->osdMode;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVidixVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
+                               bool &IsYUV, uint8_t *&PixelMask)
+ {
+   Depth         = Bpp;
+   HasAlpha      = useVidixAlpha;
+   AlphaInversed = false;
+   IsYUV         = (current_osdMode == OSDMODE_SOFTWARE);
+   PixelMask     = NULL;
  }
  

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-vidix.h	27 May 2006 19:12:41 -0000	1.10
--- video-vidix.h	9 Sep 2006 10:35:37 -0000	1.11
***************
*** 15,19 ****
  #include "fourcc.h"
  
- 
  class cVidixVideoOut : public cVideoOut {
  private:
--- 15,18 ----
***************
*** 38,42 ****
      vidix_grkey_t      gr_key;
      uint8_t            next_frame;
! 
      void SetParams(int Ystride, int UVstride);
  
--- 37,43 ----
      vidix_grkey_t      gr_key;
      uint8_t            next_frame;
!     bool               useVidixAlpha;
!     vidix_video_eq_t   vidix_curr_eq;
!     int                vidix_curr_deinterlace;
      void SetParams(int Ystride, int UVstride);
  
***************
*** 47,60 ****
  #if VDRVERSNUM >= 10307
    virtual void ClearOSD();
!   virtual void AdjustOSDMode();  
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                 int &xPan, int &yPan);
!   virtual void GetOSDMode(int &Depth,bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV,uint8_t *&PixelMask)
!   { Depth=Bpp; HasAlpha=false;AlphaInversed=false; 
! 	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
! 	  PixelMask=NULL;};
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
  #else
    virtual void Refresh();
--- 48,62 ----
  #if VDRVERSNUM >= 10307
    virtual void ClearOSD();
!   virtual void AdjustOSDMode();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                 int &xPan, int &yPan);
!   virtual void GetOSDMode(int &Depth,
!                           bool &HasAlpha,
!                           bool &AlphaInversed,
! 		                      bool &IsYUV,
! 		                      uint8_t *&PixelMask);
!   virtual void GetLockOsdSurface(uint8_t *&osd,
!                                  int &stride,
!                                  bool *&dirtyLines);
  #else
    virtual void Refresh();
***************
*** 62,66 ****
  
    virtual void CloseOSD();
! //  virtual void OpenOSD();  
    virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);
--- 64,68 ----
  
    virtual void CloseOSD();
! //  virtual void OpenOSD();
    virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** setup-softdevice-menu.c	27 Aug 2006 13:02:50 -0000	1.7
--- setup-softdevice-menu.c	9 Sep 2006 10:35:37 -0000	1.8
***************
*** 45,48 ****
--- 45,55 ----
                               VID_MAX_PARM_VALUE));
    }
+   if (data->vidCaps & CAP_HWDEINTERLACE)
+   {
+     Add(new cMenuEditIntItem(tr("HW-Deinterlace"),
+                              &data->vidDeinterlace,
+                              0,
+                              10));
+   }
  }
  

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** setup-softdevice.h	25 Jul 2006 19:58:12 -0000	1.33
--- setup-softdevice.h	9 Sep 2006 10:35:37 -0000	1.34
***************
*** 32,39 ****
  #define ALSA_DEVICE_NAME_LENGTH  64
  
! #define CAP_BRIGHTNESS  1
! #define CAP_CONTRAST    2
! #define CAP_HUE         4
! #define CAP_SATURATION  8
  
  #define VID_MAX_PARM_VALUE  100
--- 32,40 ----
  #define ALSA_DEVICE_NAME_LENGTH  64
  
! #define CAP_BRIGHTNESS       1
! #define CAP_CONTRAST         2
! #define CAP_HUE              4
! #define CAP_SATURATION       8
! #define CAP_HWDEINTERLACE   16
  
  #define VID_MAX_PARM_VALUE  100
***************
*** 165,168 ****
--- 166,170 ----
            vidHue,
            vidSaturation,
+           vidDeinterlace,
            vidCaps;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];



From nobody at sheep.berlios.de  Sat Sep  9 12:40:09 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat,  9 Sep 2006 12:40:09 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-vidix.c,1.22,1.23
Message-ID: <20060909104009.5BB2B76ED3@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18689

Modified Files:
	video-vidix.c 
Log Message:
fix waring

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** video-vidix.c	9 Sep 2006 10:35:37 -0000	1.22
--- video-vidix.c	9 Sep 2006 10:39:43 -0000	1.23
***************
*** 200,204 ****
       */
      vidix_video_eq_t tmpeq;
!     printf("cVidixVideoOut: capabilities  ", vidix_curr_eq.cap);
  
      if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {
--- 200,204 ----
       */
      vidix_video_eq_t tmpeq;
!     printf("cVidixVideoOut: capabilities  ");
  
      if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {



From nobody at sheep.berlios.de  Sun Sep 10 22:33:55 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 10 Sep 2006 22:33:55 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.227, 1.228 SoftOsd.c, 1.16,
	1.17
Message-ID: <20060910203355.5E79E78FEE@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4468

Modified Files:
	CHANGELOG SoftOsd.c 
Log Message:
- fix the "NVidia software alpha blending OSD" issue


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.227
retrieving revision 1.228
diff -C2 -d -r1.227 -r1.228
*** CHANGELOG	9 Sep 2006 10:35:37 -0000	1.227
--- CHANGELOG	10 Sep 2006 20:33:29 -0000	1.228
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2006-09-10:
+    - fix "NVidia software alpha blending OSD" issue, which turned out
+      to be a compiler problem with g++-4.1.1. (Many thanks to Prakash 
+      Punnoor, Matthias Schwarzott, Chris Elsworth and all the others
+      who helped to fix this)
  2006-09-09:
     - video-xv.c: silence some warnings

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** SoftOsd.c	10 Jul 2006 18:23:28 -0000	1.16
--- SoftOsd.c	10 Sep 2006 20:33:29 -0000	1.17
***************
*** 1382,1389 ****
          __asm__ __volatile__ (
                   " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
!                  " movd (%0),%%mm6  \n"
                   " pshufw $0,%%mm6,%%mm6 \n"// mm6: new_pixel_width_rec
                   " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
!                  : : "r" (&new_pixel_width_rec)  );
  #endif
          SCALEDEBH("OSD_WIDTH: %d dest_width: %d new_pixel_width: %d\n",
--- 1382,1389 ----
          __asm__ __volatile__ (
                   " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
!                  " movd %0,%%mm6  \n"
                   " pshufw $0,%%mm6,%%mm6 \n"// mm6: new_pixel_width_rec
                   " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
!                  : : "r" (new_pixel_width_rec)  );
  #endif
          SCALEDEBH("OSD_WIDTH: %d dest_width: %d new_pixel_width: %d\n",



From nobody at sheep.berlios.de  Mon Sep 11 23:30:51 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 11 Sep 2006 23:30:51 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.228, 1.229 softdevice.c,
	1.68, 1.69
Message-ID: <20060911213051.E4770797BA@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18730

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
catch unrecognized options for dfb-out (reported by Rolf Ahrenberg)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.228
retrieving revision 1.229
diff -C2 -d -r1.228 -r1.229
*** CHANGELOG	10 Sep 2006 20:33:29 -0000	1.228
--- CHANGELOG	11 Sep 2006 21:30:25 -0000	1.229
***************
*** 1,8 ****
  Changelog
! 2006-09-10:
!    - fix "NVidia software alpha blending OSD" issue, which turned out
!      to be a compiler problem with g++-4.1.1. (Many thanks to Prakash 
!      Punnoor, Matthias Schwarzott, Chris Elsworth and all the others
!      who helped to fix this)
  2006-09-09:
     - video-xv.c: silence some warnings
--- 1,10 ----
  Changelog
! 2006-09-11:
!    - catch unrecognized options for dfb-out (reported by Rolf Ahrenberg)
! 2006-09-10:
!    - fix "NVidia software alpha blending OSD" issue, which turned out
!      to be a compiler problem with g++-4.1.1. (Many thanks to Prakash
!      Punnoor, Matthias Schwarzott, Chris Elsworth and all the others
!      who helped to fix this)
  2006-09-09:
     - video-xv.c: silence some warnings

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.68
retrieving revision 1.69
diff -C2 -d -r1.68 -r1.69
*** softdevice.c	8 Sep 2006 17:04:52 -0000	1.68
--- softdevice.c	11 Sep 2006 21:30:25 -0000	1.69
***************
*** 856,859 ****
--- 856,863 ----
                vo_argv += 6;
                fprintf(stderr,"[softdevice] enabling triple buffering\n");
+             } else {
+               fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
+               esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
+               break;
              }
            }



From nobody at sheep.berlios.de  Tue Sep 12 07:45:25 2006
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 12 Sep 2006 07:45:25 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice softdevice.c, 1.69, 1.70 CHANGELOG,
	1.229, 1.230
Message-ID: <20060912054525.24B8778615@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18817

Modified Files:
	softdevice.c CHANGELOG 
Log Message:
don't continue on argument errors

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.69
retrieving revision 1.70
diff -C2 -d -r1.69 -r1.70
*** softdevice.c	11 Sep 2006 21:30:25 -0000	1.69
--- softdevice.c	12 Sep 2006 05:44:59 -0000	1.70
***************
*** 745,749 ****
  bool cPluginSoftDevice::ProcessArgs(int argc, char *argv[])
  {
!   int i = 0;
  
    // Implement command line argument processing here if applicable.
--- 745,750 ----
  bool cPluginSoftDevice::ProcessArgs(int argc, char *argv[])
  {
!   int   i = 0;
!   bool  ret = true;
  
    // Implement command line argument processing here if applicable.
***************
*** 788,791 ****
--- 789,793 ----
                           "[ProcessArgs] xv: illegal value for sub option aspect (%s)\n",
                           vo_argv);
+                 ret = false;
                  break;
                }
***************
*** 806,811 ****
                vo_argv += 12;
              } else {
!                     fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!                     esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
                break;
              }
--- 808,814 ----
                vo_argv += 12;
              } else {
!                fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!                esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!               ret = false;
                break;
              }
***************
*** 813,816 ****
--- 816,820 ----
  #else
            fprintf(stderr,"[softdevice] xv support not compiled in\n");
+           ret = false;
  #endif
          } else if (!strncmp (vo_argv, "fb:", 3)) {
***************
*** 857,862 ****
                fprintf(stderr,"[softdevice] enabling triple buffering\n");
              } else {
!               fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!               esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
                break;
              }
--- 861,867 ----
                fprintf(stderr,"[softdevice] enabling triple buffering\n");
              } else {
!               fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",vo_argv);
!               esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",vo_argv);
!               ret = false;
                break;
              }
***************
*** 864,867 ****
--- 869,873 ----
  #else
            fprintf(stderr,"[softdevice] dfb support not compiled in\n");
+           ret = false;
  #endif
          } else if (!strncmp (vo_argv, "vidix:", 6)) {
***************
*** 872,875 ****
--- 878,882 ----
  #else
            fprintf(stderr,"[softdevice] vidix support not compiled in\n");
+           ret = false;
  #endif
          } else if (!strncmp (vo_argv, "dummy:", 6)) {
***************
*** 879,885 ****
            fprintf(stderr,"[softdevice] using dummy video out\n");
          } else {
!                 fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!                 esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!         };
  
  
--- 886,893 ----
            fprintf(stderr,"[softdevice] using dummy video out\n");
          } else {
!           fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!           esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!           ret = false;
!         }
  
  
***************
*** 941,958 ****
            setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_DUMMY;
!         }     else {
!                 fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!                 esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!         };
  
        }
      } else {
!             fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!             esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!     };
      ++i;
      --argc;
    }
!   return true;
  }
  
--- 949,968 ----
            setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_DUMMY;
!         } else {
!           fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!           esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!           ret = false;
!       }
  
        }
      } else {
!       fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
!       esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
!       ret = false;
!     }
      ++i;
      --argc;
    }
!   return ret;
  }
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.229
retrieving revision 1.230
diff -C2 -d -r1.229 -r1.230
*** CHANGELOG	11 Sep 2006 21:30:25 -0000	1.229
--- CHANGELOG	12 Sep 2006 05:44:59 -0000	1.230
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-09-12:
+    - don't continue on argument errors
  2006-09-11:
     - catch unrecognized options for dfb-out (reported by Rolf Ahrenberg)



From nobody at sheep.berlios.de  Sat Sep 16 11:30:56 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 16 Sep 2006 11:30:56 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.230, 1.231 configure, 1.24,
	1.25 mpeg2decoder.c, 1.66, 1.67 video-dfb.c, 1.70,
	1.71 softdevice.c, 1.70, 1.71
Message-ID: <20060916093056.EFE077CE40@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2992

Modified Files:
	CHANGELOG configure mpeg2decoder.c video-dfb.c softdevice.c 
Log Message:
- added -vo shm: to help option
- added support new fields from libcle266mpegdec-0.4
- video-dfb: removed check and support for DSBLIT_INTERLACED as DirectFB
             has buildin support for this now.
- disable cle266 support if DirectFB is not patched for this


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.230
retrieving revision 1.231
diff -C2 -d -r1.230 -r1.231
*** CHANGELOG	12 Sep 2006 05:44:59 -0000	1.230
--- CHANGELOG	16 Sep 2006 09:30:19 -0000	1.231
***************
*** 1,3 ****
--- 1,9 ----
  Changelog
+ 2006-09-xx:
+    - added -vo shm: to help option
+    - added support new fields from libcle266mpegdec-0.4
+    - video-dfb: removed check and support for DSBLIT_INTERLACED as DirectFB
+                 has buildin support for this now.
+    - disable cle266 support if DirectFB is not patched for this
  2006-09-12:
     - don't continue on argument errors

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** configure	27 Aug 2006 12:48:46 -0000	1.24
--- configure	16 Sep 2006 09:30:19 -0000	1.25
***************
*** 46,49 ****
--- 46,50 ----
    echo "  --disable-fb"
    echo "  --disable-dfb"
+   echo "  --disable-cle266"
    echo "  --disable-xv"
    echo "  --disable-shm"
***************
*** 66,69 ****
--- 67,71 ----
      --disable-fb) shift; with_fb="no" ;;
      --disable-dfb) shift; dfb="no" ;;
+     --disable-cle266) shift; cle266="no" ;;
      --disable-xv) shift; xv="no" ;;
      --disable-shm) shift; with_shm="no" ;;
***************
*** 92,98 ****
    echo -n "Checking for pkg-config... "
    echo  "Checking for pkg-config.-------------------------------" >> config.log
!         
    pkg-config --version >> config.log 2>&1 || use_pkgconfig="no";
!   
    if test "${use_pkgconfig}" = "no" ; then
      echo "Not found."
--- 94,100 ----
    echo -n "Checking for pkg-config... "
    echo  "Checking for pkg-config.-------------------------------" >> config.log
! 
    pkg-config --version >> config.log 2>&1 || use_pkgconfig="no";
! 
    if test "${use_pkgconfig}" = "no" ; then
      echo "Not found."
***************
*** 133,137 ****
  };
  
! ffmpeg="no" # = not yet configured 
  if test "${use_pkgconfig}" = "yes" ; then
    if test "${ffmpeg_use_path}" = "no" ; then
--- 135,139 ----
  };
  
! ffmpeg="no" # = not yet configured
  if test "${use_pkgconfig}" = "yes" ; then
    if test "${ffmpeg_use_path}" = "no" ; then
***************
*** 193,197 ****
    snd_pcm_t         *handle;
    char device[]="hw:0,1";
!   snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0); 
    return 0;
  }
--- 195,199 ----
    snd_pcm_t         *handle;
    char device[]="hw:0,1";
!   snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0);
    return 0;
  }
***************
*** 224,228 ****
  dfb_dscaps_double="yes"
  dfb_dief_repeat="yes"
- dfb_blit_interlaced="yes"
  
  cat > ${TMPC} << EOF
--- 226,229 ----
***************
*** 281,289 ****
  #include <directfb.h>
  int main(void) {
!     DFBSurfaceBlittingFlags   flags = DSBLIT_INTERLACED;
    return 0;
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_blit_interlaced="no"
  
    fi
--- 282,292 ----
  #include <directfb.h>
  int main(void) {
!   IDirectFBSurface  *surf;
!   int               i;
!   surf->GetFramebufferOffset(&i);
    return 0;
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || cle266="no"
  
    fi
***************
*** 338,342 ****
      echo "Enabled cle266 hardware decoding."
    else
!     echo "Not found."
    fi
  else
--- 341,345 ----
      echo "Enabled cle266 hardware decoding."
    else
!     echo "Not found, not supported by DirectFB or disabled by argument."
    fi
  else
***************
*** 517,525 ****
    fi
  
-   if test "${dfb_blit_interlaced}" = "yes" ; then
-     echo "#define HAVE_DSBLIT_INTERLACED          1" >> $TMPH
-   else
-     echo "#define HAVE_DSBLIT_INTERLACED          0" >> $TMPH
-   fi
  fi
  
--- 520,523 ----

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.66
retrieving revision 1.67
diff -C2 -d -r1.66 -r1.67
*** mpeg2decoder.c	17 Jun 2006 16:27:34 -0000	1.66
--- mpeg2decoder.c	16 Sep 2006 09:30:19 -0000	1.67
***************
*** 515,519 ****
    avcodec_align_dimensions(c, &w, &h);
  #endif
!   
  #define EDGE_WIDTH 16
    bool EmuEdge=c->flags&CODEC_FLAG_EMU_EDGE;
--- 515,519 ----
    avcodec_align_dimensions(c, &w, &h);
  #endif
! 
  #define EDGE_WIDTH 16
    bool EmuEdge=c->flags&CODEC_FLAG_EMU_EDGE;
***************
*** 535,539 ****
      return 0;
    };
!   
    pic->type= FF_BUFFER_TYPE_USER;
    pic->opaque = (void*) buf;
--- 535,539 ----
      return 0;
    };
! 
    pic->type= FF_BUFFER_TYPE_USER;
    pic->opaque = (void*) buf;
***************
*** 569,573 ****
    if (!VideoOutPtr)
      return;
!   
    VideoOutPtr->ReleaseBuffer((sPicBuffer *)pic->opaque);
    for(int i=0; i<3; i++){
--- 569,573 ----
    if (!VideoOutPtr)
      return;
! 
    VideoOutPtr->ReleaseBuffer((sPicBuffer *)pic->opaque);
    for(int i=0; i<3; i++){
***************
*** 634,638 ****
                                uint8_t *data, int length, int64_t pkt_pts) {
    int len=0;
!   
    if ( context->width  > 2048 || context->height  > 2048 ) {
      fprintf(stderr,"Invalid width (%d) or height (%d), most likely a broken stream\n",
--- 634,638 ----
                                uint8_t *data, int length, int64_t pkt_pts) {
    int len=0;
! 
    if ( context->width  > 2048 || context->height  > 2048 ) {
      fprintf(stderr,"Invalid width (%d) or height (%d), most likely a broken stream\n",
***************
*** 686,691 ****
            pic->owner=NULL;
            pic->format=context->pix_fmt;
!   };      
!           
    pic->pts=AV_NOPTS_VALUE;
    // find decoded pictures pts value
--- 686,691 ----
            pic->owner=NULL;
            pic->format=context->pix_fmt;
!   };
! 
    pic->pts=AV_NOPTS_VALUE;
    // find decoded pictures pts value
***************
*** 745,751 ****
    else
    {
!     pic->aspect_ratio =(float) (context->width * 
          context->sample_aspect_ratio.num) /
!       (float) (context->height * 
                  context->sample_aspect_ratio.den);
    }
--- 745,751 ----
    else
    {
!     pic->aspect_ratio =(float) (context->width *
          context->sample_aspect_ratio.num) /
!       (float) (context->height *
                  context->sample_aspect_ratio.den);
    }
***************
*** 760,764 ****
  float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
  
! int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic, 
                  int &got_picture,uint8_t *data, int length, int64_t pkt_pts) {
    int cle266CurrentFB;
--- 760,764 ----
  float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
  
! int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic,
                  int &got_picture,uint8_t *data, int length, int64_t pkt_pts) {
    int cle266CurrentFB;
***************
*** 772,776 ****
    cle266CurrentFB = CLE266MPEGDecodeData(data, &length, &pkt_pts);
  
!   if ( cle266CurrentFB == -1 ) 
      // no new picture
      return length;
--- 772,776 ----
    cle266CurrentFB = CLE266MPEGDecodeData(data, &length, &pkt_pts);
  
!   if ( cle266CurrentFB == -1 )
      // no new picture
      return length;
***************
*** 792,798 ****
    pic->pts = pkt_pts;
    pic->edge_width=pic->edge_height=0;
    pic->dtg_active_format = 0; // currently not parsed
    pic->interlaced_frame = true; // FIXME Do we have that information?
!   pic->aspect_ratio = ( decoder.aspect_ratio_info >= 0 
      && decoder.aspect_ratio_info < 5 ) ?
      aspect_ratio_values[decoder.aspect_ratio_info] : 1.0;
--- 792,803 ----
    pic->pts = pkt_pts;
    pic->edge_width=pic->edge_height=0;
+ #if LIBCLE266MPEGDEC_VERSION_INT >= 4
+   pic->dtg_active_format = decoder.dtg_active_format;
+   pic->interlaced_frame = decoder.progressive_frame ? false : true;
+ #else
    pic->dtg_active_format = 0; // currently not parsed
    pic->interlaced_frame = true; // FIXME Do we have that information?
! #endif
!   pic->aspect_ratio = ( decoder.aspect_ratio_info >= 0
      && decoder.aspect_ratio_info < 5 ) ?
      aspect_ratio_values[decoder.aspect_ratio_info] : 1.0;
***************
*** 862,866 ****
      if (setupStore.mirror == 1)
        Mirror.Filter(pic,pic);
!    
      if (setupStore.deintMethod == 1)
        DeintLibav.Filter(pic,pic);
--- 867,871 ----
      if (setupStore.mirror == 1)
        Mirror.Filter(pic,pic);
! 
      if (setupStore.deintMethod == 1)
        DeintLibav.Filter(pic,pic);
***************
*** 874,878 ****
        LibAvPostProc.Filter(pic,pic);
  #endif //PP_LIBAVCODEC
!     
    if (pic->pts != AV_NOPTS_VALUE )
            pts=pic->pts;
--- 879,883 ----
        LibAvPostProc.Filter(pic,pic);
  #endif //PP_LIBAVCODEC
! 
    if (pic->pts != AV_NOPTS_VALUE )
            pts=pic->pts;

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.70
retrieving revision 1.71
diff -C2 -d -r1.70 -r1.71
*** video-dfb.c	5 Aug 2006 17:51:25 -0000	1.70
--- video-dfb.c	16 Sep 2006 09:30:19 -0000	1.71
***************
*** 19,23 ****
  #else
  # define HAVE_SetSourceLocation 0
- # define HAVE_DSBLIT_INTERLACED 0
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
  #   define HAVE_GraphicsDeviceDescription 0
--- 19,22 ----
***************
*** 170,176 ****
    if (caps.blitting_flags & DSBLIT_DEMULTIPLY ) fprintf(stderr,"Demultiply ");
    if (caps.blitting_flags & DSBLIT_DEINTERLACE ) fprintf(stderr,"Deinterlace ");
- #if HAVE_DSBLIT_INTERLACED
-   if (caps.blitting_flags & DSBLIT_INTERLACED ) fprintf(stderr,"Interlaced ");
- #endif
    fprintf(stderr,"\n");
  }
--- 169,172 ----
***************
*** 1279,1297 ****
        }
  
- #if HAVE_DSBLIT_INTERLACED
-       if (setupStore->useMGAtv)
-       {
-         scrSurface->SetBlittingFlags(DSBLIT_INTERLACED);
-         scrSurface->StretchBlit(videoSurface, &src, &dst);
-       }
-       else
-       {
-         scrSurface->SetBlittingFlags(DSBLIT_NOFX);
-         scrSurface->StretchBlit(videoSurface, &src, &dst);
-       }
- #else
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
- #endif
        if (OSDpresent)
        {
--- 1275,1280 ----
***************
*** 1466,1482 ****
        osdMutex.Unlock();
  
- #if HAVE_DSBLIT_INTERLACED
-       if (setupStore->useMGAtv)
-       {
-         scrSurface->SetBlittingFlags(DSBLIT_INTERLACED);
-         scrSurface->StretchBlit(videoSurface, &src, &dst);
-       } else {
-         scrSurface->SetBlittingFlags(DSBLIT_NOFX);
-         scrSurface->StretchBlit(videoSurface, &src, &dst);
-       }
- #else
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
- #endif
  
        if (OSDpresent)
--- 1449,1454 ----

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.70
retrieving revision 1.71
diff -C2 -d -r1.70 -r1.71
*** softdevice.c	12 Sep 2006 05:44:59 -0000	1.70
--- softdevice.c	16 Sep 2006 09:30:19 -0000	1.71
***************
*** 739,742 ****
--- 739,746 ----
    "  -vo vidix:               enable output via vidix driver\n"
  #endif
+ #ifdef SHM_SUPPORT
+   "  -vo shm:                 enable output via sharde memory.\n"
+   "                           Use ShmClient for displaying\n"
+ #endif
    "  -vo dummy:               enable output to dummy device\n"
    "\n";



From nobody at sheep.berlios.de  Sat Sep 16 22:26:53 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 16 Sep 2006 22:26:53 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.231, 1.232 configure, 1.25,
	1.26 mpeg2decoder.c, 1.67, 1.68
Message-ID: <20060916202653.706B779DC0@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23919

Modified Files:
	CHANGELOG configure mpeg2decoder.c 
Log Message:
cle266: fix one aspect ratio info and configure (by Rolf Ahrenberg)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.231
retrieving revision 1.232
diff -C2 -d -r1.231 -r1.232
*** CHANGELOG	16 Sep 2006 09:30:19 -0000	1.231
--- CHANGELOG	16 Sep 2006 20:26:24 -0000	1.232
***************
*** 6,9 ****
--- 6,10 ----
                  has buildin support for this now.
     - disable cle266 support if DirectFB is not patched for this
+    - cle266: fix one aspect ratio info and configure (by Rolf Ahrenberg)
  2006-09-12:
     - don't continue on argument errors

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** configure	16 Sep 2006 09:30:19 -0000	1.25
--- configure	16 Sep 2006 20:26:24 -0000	1.26
***************
*** 328,348 ****
  
  #########################################################
! # cle266mpegdec: check if present
  #
  if test "${dfb}" = "yes" ; then
    echo -n "Checking for libcle266mpegdec ... "
!   cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec 2>>config.log` || cle266="no"
    if test "${cle266}" = "yes" ; then
      cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
      cle266_opts="${cle266_cflags} ${cle266_libs}"
-   fi
- 
-   if test "${cle266}" = "yes" ; then
      echo "Enabled cle266 hardware decoding."
    else
      echo "Not found, not supported by DirectFB or disabled by argument."
    fi
- else
-   cle266="no"
  fi
  
--- 328,344 ----
  
  #########################################################
! # libcle266mpegdec: check if required version is present
  #
  if test "${dfb}" = "yes" ; then
    echo -n "Checking for libcle266mpegdec ... "
!   pkg-config --atleast-version=0.2 libcle266mpegdec 2>>config.log || cle266="no"
    if test "${cle266}" = "yes" ; then
+     cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec`
      cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
      cle266_opts="${cle266_cflags} ${cle266_libs}"
      echo "Enabled cle266 hardware decoding."
    else
      echo "Not found, not supported by DirectFB or disabled by argument."
    fi
  fi
  

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.67
retrieving revision 1.68
diff -C2 -d -r1.67 -r1.68
*** mpeg2decoder.c	16 Sep 2006 09:30:19 -0000	1.67
--- mpeg2decoder.c	16 Sep 2006 20:26:24 -0000	1.68
***************
*** 758,762 ****
  
  #ifdef HAVE_CLE266_MPEG_DECODER
! float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
  
  int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic,
--- 758,762 ----
  
  #ifdef HAVE_CLE266_MPEG_DECODER
! float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 2.21 };
  
  int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic,



From nobody at sheep.berlios.de  Sun Sep 17 13:55:01 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 13:55:01 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.232, 1.233 SoftOsd.c, 1.17,
	1.18
Message-ID: <20060917115501.8012A7449D@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11777

Modified Files:
	CHANGELOG SoftOsd.c 
Log Message:
- replace "pshufw" with MMX commands 


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.232
retrieving revision 1.233
diff -C2 -d -r1.232 -r1.233
*** CHANGELOG	16 Sep 2006 20:26:24 -0000	1.232
--- CHANGELOG	17 Sep 2006 11:54:32 -0000	1.233
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-09-17:
+    - replace "pshufw" with MMX commands to make scaling optimazations available
+      to processors without MMX2
  2006-09-xx:
     - added -vo shm: to help option

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** SoftOsd.c	10 Sep 2006 20:33:29 -0000	1.17
--- SoftOsd.c	17 Sep 2006 11:54:32 -0000	1.18
***************
*** 31,34 ****
--- 31,43 ----
  //#undef USE_MMX
  //#undef USE_MMX2
+ 
+ #undef SPLAT_U16
+ #ifdef USE_MMX2
+ #define SPLAT_U16(X)   " pshufw $0b0, " X ", " X " \n"
+ #else
+ #define SPLAT_U16(X)   " punpcklwd " X ", " X " \n"\
+                        " punpckldq " X ", " X " \n"
+ #endif
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 1227,1231 ****
          //const int ScaleFactor=100;
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
! #ifndef USE_MMX2
          unsigned int a_sum=0;
          unsigned int b_sum=0;
--- 1236,1240 ----
          //const int ScaleFactor=100;
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
! #ifndef USE_MMX
          unsigned int a_sum=0;
          unsigned int b_sum=0;
***************
*** 1242,1250 ****
  
          int row;
! #ifdef USE_MMX2
          __asm__(
                          " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
                          " movd %0,%%mm6  \n"
!                         " pshufw $0,%%mm6,%%mm6 \n"// mm6: new_pixel_height_rec
                          " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                          : : "r" (new_pixel_height_rec)  );
--- 1251,1259 ----
  
          int row;
! #ifdef USE_MMX
          __asm__(
                          " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
                          " movd %0,%%mm6  \n"
!                         SPLAT_U16( "%%mm6 " )
                          " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                          : : "r" (new_pixel_height_rec)  );
***************
*** 1261,1265 ****
                  int32_t a_pos=abs(pos);
                  //int32_t a_pos=-(pos);
! #ifndef USE_MMX2                       
                  a_sum=b_sum=g_sum=r_sum=0;
                  c = pixmap[row][Pixel];
--- 1270,1274 ----
                  int32_t a_pos=abs(pos);
                  //int32_t a_pos=-(pos);
! #ifndef USE_MMX                       
                  a_sum=b_sum=g_sum=r_sum=0;
                  c = pixmap[row][Pixel];
***************
*** 1274,1278 ****
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       " pshufw $0b0,%%mm2,%%mm2 \n"
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
--- 1283,1287 ----
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       SPLAT_U16( "%%mm2" )
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
***************
*** 1287,1291 ****
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b);
  
! #ifndef USE_MMX2               
                          c=pixmap[row][Pixel];
                          a_sum+=GET_A(c)*ScaleFactor;
--- 1296,1300 ----
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b);
  
! #ifndef USE_MMX               
                          c=pixmap[row][Pixel];
                          a_sum+=GET_A(c)*ScaleFactor;
***************
*** 1308,1312 ****
                                          a_sum,pixmap[row][Pixel].a,
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b,pos);
! #ifndef USE_MMX2                       
                  c=pixmap[row][Pixel];
                  a_sum+=GET_A(c)*pos;
--- 1317,1321 ----
                                          a_sum,pixmap[row][Pixel].a,
                                          pixmap[row][Pixel].r,pixmap[row][Pixel].g,pixmap[row][Pixel].b,pos);
! #ifndef USE_MMX                       
                  c=pixmap[row][Pixel];
                  a_sum+=GET_A(c)*pos;
***************
*** 1319,1323 ****
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       " pshufw $0b0,%%mm2,%%mm2 \n"
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
--- 1328,1332 ----
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       SPLAT_U16( "%%mm2" )
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
***************
*** 1329,1333 ****
                                  a_sum/ScaleFactor*
                                  new_pixel_height_rec/ScaleFactor);
! #ifndef USE_MMX2                       
                  a_sum=a_sum/ScaleFactor*new_pixel_height_rec/ScaleFactor;
                  b_sum=b_sum/ScaleFactor*new_pixel_height_rec/ScaleFactor;
--- 1338,1342 ----
                                  a_sum/ScaleFactor*
                                  new_pixel_height_rec/ScaleFactor);
! #ifndef USE_MMX                       
                  a_sum=a_sum/ScaleFactor*new_pixel_height_rec/ScaleFactor;
                  b_sum=b_sum/ScaleFactor*new_pixel_height_rec/ScaleFactor;
***************
*** 1367,1371 ****
  #define SHIFT_BITS_NUM 6
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
! #ifndef USE_MMX2
          unsigned int a_sum=0;
          unsigned int b_sum=0;
--- 1376,1380 ----
  #define SHIFT_BITS_NUM 6
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
! #ifndef USE_MMX
          unsigned int a_sum=0;
          unsigned int b_sum=0;
***************
*** 1379,1387 ****
          int32_t pos=new_pixel_width;
          
! #ifdef USE_MMX2
          __asm__ __volatile__ (
                   " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
                   " movd %0,%%mm6  \n"
!                  " pshufw $0,%%mm6,%%mm6 \n"// mm6: new_pixel_width_rec
                   " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                   : : "r" (new_pixel_width_rec)  );
--- 1388,1396 ----
          int32_t pos=new_pixel_width;
          
! #ifdef USE_MMX
          __asm__ __volatile__ (
                   " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
                   " movd %0,%%mm6  \n"
!                  SPLAT_U16( "%%mm6" )
                   " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                   : : "r" (new_pixel_width_rec)  );
***************
*** 1396,1400 ****
                                          pixmap->r,pixmap->g,pixmap->b);
  
! #ifndef USE_MMX2               
                          c=*pixmap;
                          a_sum+=GET_A(c)*ScaleFactor;
--- 1405,1409 ----
                                          pixmap->r,pixmap->g,pixmap->b);
  
! #ifndef USE_MMX               
                          c=*pixmap;
                          a_sum+=GET_A(c)*ScaleFactor;
***************
*** 1417,1421 ****
                                          a_sum,pixmap->a,
                                          pixmap->r,pixmap->g,pixmap->b,pos);
! #ifndef USE_MMX2                       
                  c=*pixmap;
                  a_sum+=GET_A(c)*pos;
--- 1426,1430 ----
                                          a_sum,pixmap->a,
                                          pixmap->r,pixmap->g,pixmap->b,pos);
! #ifndef USE_MMX                       
                  c=*pixmap;
                  a_sum+=GET_A(c)*pos;
***************
*** 1428,1432 ****
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       " pshufw $0b0,%%mm2,%%mm2 \n"
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
--- 1437,1441 ----
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       SPLAT_U16( "%%mm2" )
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
***************
*** 1438,1442 ****
                                  a_sum/ScaleFactor*
                                  new_pixel_width_rec/ScaleFactor);
! #ifndef USE_MMX2                       
                  a_sum=a_sum/ScaleFactor*new_pixel_width_rec/ScaleFactor;
                  b_sum=b_sum/ScaleFactor*new_pixel_width_rec/ScaleFactor;
--- 1447,1451 ----
                                  a_sum/ScaleFactor*
                                  new_pixel_width_rec/ScaleFactor);
! #ifndef USE_MMX                       
                  a_sum=a_sum/ScaleFactor*new_pixel_width_rec/ScaleFactor;
                  b_sum=b_sum/ScaleFactor*new_pixel_width_rec/ScaleFactor;
***************
*** 1472,1476 ****
                  //uint32_t apos=-(pos);
                  uint32_t apos=abs(pos);
! #ifndef USE_MMX2            
                  c=*pixmap;
                  a_sum=GET_A(c)*apos;
--- 1481,1485 ----
                  //uint32_t apos=-(pos);
                  uint32_t apos=abs(pos);
! #ifndef USE_MMX            
                  c=*pixmap;
                  a_sum=GET_A(c)*apos;
***************
*** 1483,1487 ****
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       " pshufw $0b0,%%mm2,%%mm2 \n"
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
--- 1492,1496 ----
                        " movd %1,%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"
!                       SPLAT_U16( "%%mm2" )
                        " pmullw %%mm2,%%mm1 \n"
                        " paddw %%mm1,%%mm0 \n"
***************
*** 1505,1509 ****
          //const int ScaleFactor=100;
          color *end_pixmap=pixmap+Pixel;
! #ifndef USE_MMX2
          unsigned int c=*pixmap;
  	unsigned int a1=GET_A(c);
--- 1514,1518 ----
          //const int ScaleFactor=100;
          color *end_pixmap=pixmap+Pixel;
! #ifndef USE_MMX
          unsigned int c=*pixmap;
  	unsigned int a1=GET_A(c);
***************
*** 1540,1544 ****
                                          pixmap->r,pixmap->g,pixmap->b);
  
! #ifndef USE_MMX2                       
  			// funny that's the same formula we use for
  			// alpha blending ;-)
--- 1549,1553 ----
                                          pixmap->r,pixmap->g,pixmap->b);
  
! #ifndef USE_MMX                       
  			// funny that's the same formula we use for
  			// alpha blending ;-)
***************
*** 1552,1556 ****
  				" movd %0,%%mm3 \n" //mm3 load pos
  				" movq %%mm2,%%mm0 \n" // mm0 pixel2-pixel1
! 				" pshufw $0b0,%%mm3,%%mm3 \n"
  				" pmullw %%mm3, %%mm0 \n" //mm0 *pos
  				" psraw $"SHIFT_BITS",%%mm0 \n"
--- 1561,1565 ----
  				" movd %0,%%mm3 \n" //mm3 load pos
  				" movq %%mm2,%%mm0 \n" // mm0 pixel2-pixel1
!                                 SPLAT_U16( "%%mm3" )
  				" pmullw %%mm3, %%mm0 \n" //mm0 *pos
  				" psraw $"SHIFT_BITS",%%mm0 \n"
***************
*** 1566,1570 ****
  		pixmap++;
                  pos -= ScaleFactor;
! #ifndef USE_MMX2                       
                  a1=a2;
  		b1=b2;
--- 1575,1579 ----
  		pixmap++;
                  pos -= ScaleFactor;
! #ifndef USE_MMX                       
                  a1=a2;
  		b1=b2;
***************
*** 1601,1605 ****
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
          //const int ScaleFactor=100;
! #ifndef USE_MMX2
          int a1=0;
          int b1=0;
--- 1610,1614 ----
          const int ScaleFactor=1<<SHIFT_BITS_NUM;
          //const int ScaleFactor=100;
! #ifndef USE_MMX
          int a1=0;
          int b1=0;
***************
*** 1623,1627 ****
                          OSD_HEIGHT,new_pixel_height);
          while (currPixel<Pixel) {
! #ifndef USE_MMX2
                  c=pixmap[0][currPixel];
  		a1=GET_A(c);
--- 1632,1636 ----
                          OSD_HEIGHT,new_pixel_height);
          while (currPixel<Pixel) {
! #ifndef USE_MMX
                  c=pixmap[0][currPixel];
  		a1=GET_A(c);
***************
*** 1651,1655 ****
                          //SCALEUPDEBV("while loop pixel: %d pos: %d, row %d\n",
  			//		currPixel,pos,ypos);
! #ifndef USE_MMX2       
                          c  = SET_B(b1+(pos*(b2)/ScaleFactor));
                          c |= SET_G(g1+(pos*(g2)/ScaleFactor));
--- 1660,1664 ----
                          //SCALEUPDEBV("while loop pixel: %d pos: %d, row %d\n",
  			//		currPixel,pos,ypos);
! #ifndef USE_MMX       
                          c  = SET_B(b1+(pos*(b2)/ScaleFactor));
                          c |= SET_G(g1+(pos*(g2)/ScaleFactor));
***************
*** 1661,1665 ****
  				" movd %0,%%mm3 \n"
  				" movq %%mm2,%%mm0 \n"
! 				" pshufw $0b0,%%mm3,%%mm3 \n"
  				" pmullw %%mm3, %%mm0 \n"
  				" psraw $"SHIFT_BITS",%%mm0 \n"
--- 1670,1674 ----
  				" movd %0,%%mm3 \n"
  				" movq %%mm2,%%mm0 \n"
!                                 SPLAT_U16( "%%mm2" )
  				" pmullw %%mm3, %%mm0 \n"
  				" psraw $"SHIFT_BITS",%%mm0 \n"



From nobody at sheep.berlios.de  Sun Sep 17 14:08:25 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 14:08:25 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.233, 1.234 PicBuffer.c, 1.7,
	1.8
Message-ID: <20060917120825.E7A1A79E23@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13066

Modified Files:
	CHANGELOG PicBuffer.c 
Log Message:
- cleanup PicBuffer.c, release PicBuffers in destructor,...


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.233
retrieving revision 1.234
diff -C2 -d -r1.233 -r1.234
*** CHANGELOG	17 Sep 2006 11:54:32 -0000	1.233
--- CHANGELOG	17 Sep 2006 12:07:57 -0000	1.234
***************
*** 3,6 ****
--- 3,7 ----
     - replace "pshufw" with MMX commands to make scaling optimazations available
       to processors without MMX2
+    - cleanup PicBuffer.c, release PicBuffers in destructor,...
  2006-09-xx:
     - added -vo shm: to help option

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** PicBuffer.c	4 Sep 2006 20:37:07 -0000	1.7
--- PicBuffer.c	17 Sep 2006 12:07:57 -0000	1.8
***************
*** 39,49 ****
  /*----------------------------------------------------------------------*/
  cPicBufferManager::cPicBufferManager() {
!   lastPicNum=0;
!   for (int i=0; i< LAST_PICBUF; i++) 
!           InitPicBuffer(&PicBuffer[i]);
  }
  
  cPicBufferManager::~cPicBufferManager() {
!         // FIXME release buffers
  };
  
--- 39,55 ----
  /*----------------------------------------------------------------------*/
  cPicBufferManager::cPicBufferManager() {
!         lastPicNum=0;
!         for (int i=0; i< LAST_PICBUF; i++) 
!                 InitPicBuffer(&PicBuffer[i]);
  }
  
  cPicBufferManager::~cPicBufferManager() {
!         for (int i=0; i<LAST_PICBUF; i++) 
!                 if ( PicBuffer[i].pixel[0] ) {
! //                        if ( PicBuffer[i].use_count > 0 ) 
! //                                fprintf(stderr,"Warning! Use_count of PicBuffer not zero in PicBufferManager destructor!\n");
!                         
!                         ReleasePicBuffer( i );
!                 };
  };
  
***************
*** 60,67 ****
  
  void cPicBufferManager::ReleasePicBuffer(int buf_num) {
!         PICDEB("ReleasePicBuffer %d\n",buf_num);
          sPicBuffer *buf=&PicBuffer[buf_num];
  
          for (int i=0; i<4; i++) {
                  free(buf->pixel[i]);
                  buf->pixel[i]=NULL;
--- 66,74 ----
  
  void cPicBufferManager::ReleasePicBuffer(int buf_num) {
!         PICDEB("ReleasePicBuffer %d pixel[0] %p\n",buf_num,PicBuffer[buf_num].pixel[0]);
          sPicBuffer *buf=&PicBuffer[buf_num];
  
          for (int i=0; i<4; i++) {
+                 //printf("release %d: %p\n",i,buf->pixel[i]);
                  free(buf->pixel[i]);
                  buf->pixel[i]=NULL;
***************
*** 85,89 ****
                        
                  default:
!                         fprintf(stderr,"warning unsupported pixel format(%d)! \n",pix_fmt);
                          hChromaShift=vChromaShift=1;
          };
--- 92,96 ----
                        
                  default:
!                         fprintf(stderr,"Warning unsupported pixel format(%d)! \n",pix_fmt);
                          hChromaShift=vChromaShift=1;
          };
***************
*** 91,104 ****
  
  void cPicBufferManager::LockBuffer(sPicBuffer *picture) {
          PicBufMutex.Lock();
          if (picture)
                  picture->use_count++;
          PicBufMutex.Unlock();
  };
  
  void cPicBufferManager::UnlockBuffer(sPicBuffer *picture) {
          PicBufMutex.Lock();
!         if (picture && picture->use_count>0)
                  picture->use_count--;
          PicBufMutex.Unlock();
  };
--- 98,121 ----
  
  void cPicBufferManager::LockBuffer(sPicBuffer *picture) {
+         PICDEB("LockBuffer buf->pixel[0] %p\n",picture->pixel[0]);
          PicBufMutex.Lock();
          if (picture)
                  picture->use_count++;
+         else fprintf(stderr,
+                     "Error! Trying to lock a nil picture... Ignoring.\n");
          PicBufMutex.Unlock();
  };
  
  void cPicBufferManager::UnlockBuffer(sPicBuffer *picture) {
+         if (!picture) {
+                 fprintf(stderr,
+                     "Error! Trying to unlock a nil picture... Ignoring.\n");
+                 return;
+         };
+         PICDEB("UnlockBuffer buf %p pixel[0] %p %p\n",picture,picture->pixel[0]);
          PicBufMutex.Lock();
!         if ( picture->use_count>0 )
                  picture->use_count--;
+         else fprintf(stderr,"Warning, trying to unlock buffer with use_count 0!\n");
          PicBufMutex.Unlock();
  };
***************
*** 180,185 ****
      PICDEB("GetBuffer pix_fmt %d (%d,%d)\n",pix_fmt,w,h);
  
-     //assert(pic->data[0]==NULL);
- 
      PicBufMutex.Lock();
      int buf_num=0;
--- 197,200 ----
***************
*** 190,194 ****
      };
  
-     //assert(buf_num<LAST_PICBUF);
      if (buf_num>=LAST_PICBUF) {
              printf("error finding PicBuffer!\n");
--- 205,208 ----
***************
*** 243,249 ****
              buf_num++;
  
-     //assert(buf_num<LAST_PICBUF);
      if (buf_num>=LAST_PICBUF)  {
!             printf("didn't find corresponding PicBuffer!\n");
              exit(-1);
      };
--- 257,262 ----
              buf_num++;
  
      if (buf_num>=LAST_PICBUF)  {
!             fprintf(stderr,"ReleaseBuffer din't find corresponding PicBuffer!\n");
              exit(-1);
      };
***************
*** 253,257 ****
      PicBuffer[buf_num].buf_num=-1;
      PicBufMutex.Unlock();
!     PICDEB("end ReleaseBuffer bufnum %d\n",buf_num);
  }
  
--- 266,270 ----
      PicBuffer[buf_num].buf_num=-1;
      PicBufMutex.Unlock();
!     PICDEB("end ReleaseBuffer bufnum %d use_count %d\n",buf_num,PicBuffer[buf_num].use_count);
  }
  



From nobody at sheep.berlios.de  Sun Sep 17 14:50:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 14:50:34 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.234, 1.235 configure, 1.26,
	1.27
Message-ID: <20060917125034.048E07D9A1@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30310

Modified Files:
	CHANGELOG configure 
Log Message:
- add linux framebuffer detection to configure


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.234
retrieving revision 1.235
diff -C2 -d -r1.234 -r1.235
*** CHANGELOG	17 Sep 2006 12:07:57 -0000	1.234
--- CHANGELOG	17 Sep 2006 12:50:04 -0000	1.235
***************
*** 4,7 ****
--- 4,8 ----
       to processors without MMX2
     - cleanup PicBuffer.c, release PicBuffers in destructor,...
+    - add linux framebuffer detection to configure
  2006-09-xx:
     - added -vo shm: to help option

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** configure	16 Sep 2006 20:26:24 -0000	1.26
--- configure	17 Sep 2006 12:50:04 -0000	1.27
***************
*** 208,211 ****
--- 208,255 ----
  fi
  
+ ########################################################
+ # check for linux fb
+ echo -n "Checking for linux frambuffer... "
+ echo "Checking for linux framebuffer.------------------" >> config.log
+ 
+ if test "${with_fb}" = "yes" ; then
+ cat > ${TMPC} << EOF
+ #include <linux/fb.h>
+ #include <sys/mman.h>
+ #include <sys/ioctl.h>
+ #include <fcntl.h>
+ #include <stdio.h>
+ #include <stdlib.h>
+ int main(void) {
+         int fbdev;
+         struct fb_fix_screeninfo fb_finfo;
+         struct fb_var_screeninfo fb_orig_vinfo;
+         struct fb_var_screeninfo fb_vinfo;
+         if ((fbdev = open("/dev/fb0", O_RDWR)) == -1) {
+                 printf("[video-fb] cant open framebuffer %s\n", "/dev/fb0");
+                 exit(1);
+         }
+ 
+         if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
+                 printf("[video-fb] Can't get VSCREENINFO\n");
+                 exit(1);
+         }
+         if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
+                 printf("[video-fb] Can't get FSCREENINFO\n");
+                 exit(1);
+         }
+ 
+         return 0;
+ }
+ EOF
+ $cc $CFLAGS  -o $TMPE $TMPC >> config.log 2>&1 || with_fb="no"
+ fi
+ 
+ if test "${with_fb}" = "yes" ; then
+ echo "Enabled video-fb."
+ else
+ echo "Not Found."
+ fi
+ 
  #########################################################
  # start of DirectFB specific tests



From nobody at sheep.berlios.de  Sun Sep 17 15:03:15 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 15:03:15 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.235, 1.236 configure, 1.27,
	1.28
Message-ID: <20060917130315.89E0C7A7F0@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32254

Modified Files:
	CHANGELOG configure 
Log Message:
- disable libcle266mpegdec if no DirectFB is found


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.235
retrieving revision 1.236
diff -C2 -d -r1.235 -r1.236
*** CHANGELOG	17 Sep 2006 12:50:04 -0000	1.235
--- CHANGELOG	17 Sep 2006 13:02:46 -0000	1.236
***************
*** 5,8 ****
--- 5,9 ----
     - cleanup PicBuffer.c, release PicBuffers in destructor,...
     - add linux framebuffer detection to configure
+    - disable libcle266mpegdec if no DirectFB is found
  2006-09-xx:
     - added -vo shm: to help option

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** configure	17 Sep 2006 12:50:04 -0000	1.27
--- configure	17 Sep 2006 13:02:46 -0000	1.28
***************
*** 385,388 ****
--- 385,390 ----
      echo "Not found, not supported by DirectFB or disabled by argument."
    fi
+ else 
+   cle266="no"
  fi
  



From nobody at sheep.berlios.de  Sun Sep 17 18:40:05 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 18:40:05 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.236, 1.237 utils.c, 1.17,
	1.18
Message-ID: <20060917164005.327DE7DB84@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6115

Modified Files:
	CHANGELOG utils.c 
Log Message:
- add altivec optimizations to some AlphaBlend() and 
  yv12_to_yuy2_il_mmx2_line()
- make utils.c compile on non MMX machines, cleanup some #ifdefs
	


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.236
retrieving revision 1.237
diff -C2 -d -r1.236 -r1.237
*** CHANGELOG	17 Sep 2006 13:02:46 -0000	1.236
--- CHANGELOG	17 Sep 2006 16:39:34 -0000	1.237
***************
*** 6,9 ****
--- 6,12 ----
     - add linux framebuffer detection to configure
     - disable libcle266mpegdec if no DirectFB is found
+    - add altivec optimizations to some AlphaBlend() and 
+      yv12_to_yuy2_il_mmx2_line()
+    - make utils.c compile on non MMX machines, cleanup some #ifdefs
  2006-09-xx:
     - added -vo shm: to help option

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** utils.c	10 Jul 2006 17:46:59 -0000	1.17
--- utils.c	17 Sep 2006 16:39:34 -0000	1.18
***************
*** 110,115 ****
                             const uint8_t *uc, const uint8_t *vc)
  {
!     int i;
! 
    for(i = chromaWidth/4; i--; )
    {
--- 110,116 ----
                             const uint8_t *uc, const uint8_t *vc)
  {
!   int i;
!   
! #ifdef USE_MMX 
    for(i = chromaWidth/4; i--; )
    {
***************
*** 139,142 ****
--- 140,186 ----
      dest2 += 16;
    }
+ #elif USE_ALTIVEC
+ 
+ /* This altivec optimization is based on vlc's i420_yuy2.c with the copyright notice:
+  * 
+  * Copyright (C) 2000, 2001 the VideoLAN team
+  *
+  * Authors: Samuel Hocevar <sam at zoy.org>
+  */
+   
+    vector unsigned char u_vec;
+    vector unsigned char v_vec; 
+    vector unsigned char uv_vec;
+    vector unsigned char y_vec;
+ 
+    for ( i=chromaWidth; i>=16; i-=16) {
+         u_vec = vec_ld(0,uc); uc+=16;
+         v_vec = vec_ld(0,vc); vc+=16;
+         uv_vec = vec_mergeh( u_vec, v_vec);
+         y_vec = vec_ld( 0, yc1); yc1+=16;
+         vec_st( vec_mergeh( y_vec, uv_vec), 0, dest1); dest1+=16;
+         vec_st( vec_mergel( y_vec, uv_vec), 0, dest1); dest1+=16;
+         y_vec = vec_ld( 0, yc2); yc2+=16;
+         vec_st( vec_mergeh( y_vec, uv_vec), 0, dest2); dest2+=16;        
+         vec_st( vec_mergel( y_vec, uv_vec), 0, dest2); dest2+=16;             
+         
+         uv_vec = vec_mergel( u_vec, v_vec);
+         y_vec = vec_ld( 0, yc1); yc1+=16;
+         vec_st( vec_mergeh( y_vec, uv_vec), 0, dest1); dest1+=16;
+         vec_st( vec_mergel( y_vec, uv_vec), 0, dest1); dest1+=16;
+         y_vec = vec_ld( 0, yc2); yc2+=16;
+         vec_st( vec_mergeh( y_vec, uv_vec), 0, dest2); dest2+=16;        
+         vec_st( vec_mergel( y_vec, uv_vec), 0, dest2); dest2+=16;        
+    }
+ #endif
+    for ( ; i>=1; i-=1 ) {
+       *((uint32_t *)dest1)++ = (yc1[0] << 24)+ (uc[0] << 16) + (yc1[1] << 8) + (vc[0] << 0);
+       *((uint32_t *)dest2)++ = (yc2[0] << 24)+ (uc[0] << 16) + (yc2[1] << 8) + (vc[0] << 0);
+       //*idst++ = (yc[0] << 0)+ (uc[0] << 8) + (yc[1] << 16) + (vc[0] << 24);
+       yc1 += 2;
+       yc2 += 2;
+       uc++;
+       vc++;
+     }
  }
  
***************
*** 222,225 ****
--- 266,270 ----
                            int lumStride, int chromStride, int dstStride)
  {
+ #ifdef USE_MMX 
    for (int i=0; i<height; i++)
    {
***************
*** 265,268 ****
--- 310,314 ----
    SFENCE;
    EMMS;
+ #endif
  }
  
***************
*** 343,346 ****
--- 389,394 ----
  }
  
+ #ifdef USE_MMX
+ 
  #define VERT_SCALING
  void (*mmx_unpack)(uint8_t * image, int lines, int stride);
***************
*** 422,427 ****
  }
  
- 
- 
  void mmx_unpack_16rgb (uint8_t * image, int lines, int stride)
  {
--- 470,473 ----
***************
*** 632,636 ****
    free(scaleV);
  }
! 
  
  void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
--- 678,682 ----
    free(scaleV);
  }
! #endif // USE_MMX
  
  void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
***************
*** 640,644 ****
  #ifdef USE_MMX
          __asm__(" pxor %%mm3,%%mm3\n"
- #ifdef USE_MMX2
                  PREFETCH("(%0)\n")
                  PREFETCH("(%1)\n")
--- 686,689 ----
***************
*** 650,654 ****
                  PREFETCH("128(%1)\n")
                  PREFETCH("128(%2)\n")
- #endif //USE_MMX2
                  : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
  
--- 695,698 ----
***************
*** 703,706 ****
--- 747,799 ----
  #endif //USE_MMX
  
+ #ifdef USE_ALTIVEC 
+        vector unsigned char zero = vec_splat_u8(0);
+        vector unsigned short one = vec_splat_u16(1);
+        vector unsigned short seven = vec_splat_u16(7);
+        vector short p1h;
+        vector short p1l;
+        vector short p2h;
+        vector short p2l;
+        vector short ah;
+        vector short al;
+        for (; count>15; count-=16) {
+                 p1h = (vector short) vec_ld(0,P1);
+                 p2h = (vector short) vec_ld(0,P2);
+                 p1l = (vector short) vec_mergel( zero, (vector unsigned char) p1h);
+                 p2l = (vector short) vec_mergel( zero, (vector unsigned char) p2h);
+                 ah  = (vector short) vec_ld(0,alpha);
+                 
+                 p1h = (vector short) vec_mergeh( zero, (vector unsigned char) p1h);
+                 p2h = (vector short) vec_mergeh( zero, (vector unsigned char) p2h);
+                 
+                 al = (vector short) vec_mergel( zero, (vector unsigned char) ah);
+                 ah = (vector short) vec_mergeh( zero, (vector unsigned char) ah);
+                 
+                 p1h = vec_subs(p1h,p2h);
+                 p1l = vec_subs(p1l,p2l);
+                 
+                 ah = vec_sr(ah, one);
+                 al = vec_sr(al, one);
+        
+                 p1h = vec_mladd( p1h, ah, (vector short) zero);
+                 p1l = vec_mladd( p1l, al, (vector short) zero);
+ 
+                 p1h = vec_sra(p1h, seven);
+                 p1l = vec_sra(p1l, seven);
+ 
+                 p1h = vec_adds(p1h, p2h);
+                 p1l = vec_adds(p1l, p2l);
+ 
+                 p1h = (vector short) vec_packsu(p1h,p1l);
+ 
+                 vec_st((vector unsigned char) p1h, 0, dest);
+                 
+                 P1+=16;
+                 P2+=16;
+                 alpha+=16;
+                 dest+=16;
+        }
+ #endif // USE_ALTIVEC
+        
         //fallback version and the last missing bytes...
         for (int i=0; i < count; i++){
***************
*** 745,748 ****
--- 838,850 ----
  /* taken from MPlayer's aclib */
  
+ 
+ #ifndef USE_MMX
+ 
+ void * fast_memcpy(void * to, const void * from, size_t len) {
+         memcpy(to,from,len);
+ }
+ 
+ #else
+ 
  #define MIN_LEN 0x40
  #define MMREG_SIZE 64
***************
*** 755,760 ****
  #endif
  
- #define CONFUSION_FACTOR 0
- 
  /* for small memory blocks (<256 bytes) this version is faster */
  #define small_memcpy(to,from,n)\
--- 857,860 ----
***************
*** 813,819 ****
  	{
  		__asm__ __volatile__ (
- #ifdef USE_MMX2
          	PREFETCH(" 320(%0)\n")
- #endif
  		"movq (%0), %%mm0\n"
  		"movq 8(%0), %%mm1\n"
--- 913,917 ----
***************
*** 836,912 ****
  		to=((unsigned char *)to)+64;
  	}
- #if 0
- //	printf(" %d %d\n", (int)from&1023, (int)to&1023);
- 	// Pure Assembly cuz gcc is a bit unpredictable ;)
- 	if(i>=BLOCK_SIZE/64)
- 		asm volatile(
- 			"xor %%"REG_a", %%"REG_a"	\n\t"
- 			".balign 16		\n\t"
- 			"1:			\n\t"
- 				"movl (%0, %%"REG_a"), %%ebx 	\n\t"
- 				"movl 32(%0, %%"REG_a"), %%ebx 	\n\t"
- 				"movl 64(%0, %%"REG_a"), %%ebx 	\n\t"
- 				"movl 96(%0, %%"REG_a"), %%ebx 	\n\t"
- 				"add $128, %%"REG_a"		\n\t"
- 				"cmp %3, %%"REG_a"		\n\t"
- 				" jb 1b				\n\t"
- 
- 			"xor %%"REG_a", %%"REG_a"	\n\t"
- 
- 				".balign 16		\n\t"
- 				"2:			\n\t"
- 				"movq (%0, %%"REG_a"), %%mm0\n"
- 				"movq 8(%0, %%"REG_a"), %%mm1\n"
- 				"movq 16(%0, %%"REG_a"), %%mm2\n"
- 				"movq 24(%0, %%"REG_a"), %%mm3\n"
- 				"movq 32(%0, %%"REG_a"), %%mm4\n"
- 				"movq 40(%0, %%"REG_a"), %%mm5\n"
- 				"movq 48(%0, %%"REG_a"), %%mm6\n"
- 				"movq 56(%0, %%"REG_a"), %%mm7\n"
- 				MOVNTQ" %%mm0, (%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm1, 8(%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm2, 16(%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm3, 24(%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm4, 32(%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm5, 40(%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm6, 48(%1, %%"REG_a")\n"
- 				MOVNTQ" %%mm7, 56(%1, %%"REG_a")\n"
- 				"add $64, %%"REG_a"		\n\t"
- 				"cmp %3, %%"REG_a"		\n\t"
- 				"jb 2b				\n\t"
  
! #if CONFUSION_FACTOR > 0
! 	// a few percent speedup on out of order executing CPUs
! 			"mov %5, %%"REG_a"		\n\t"
! 				"2:			\n\t"
! 				"movl (%0), %%ebx	\n\t"
! 				"movl (%0), %%ebx	\n\t"
! 				"movl (%0), %%ebx	\n\t"
! 				"movl (%0), %%ebx	\n\t"
! 				"dec %%"REG_a"		\n\t"
! 				" jnz 2b		\n\t"
! #endif
! 
! 			"xor %%"REG_a", %%"REG_a"	\n\t"
! 			"add %3, %0		\n\t"
! 			"add %3, %1		\n\t"
! 			"sub %4, %2		\n\t"
! 			"cmp %4, %2		\n\t"
! 			" jae 1b		\n\t"
! 				: "+r" (from), "+r" (to), "+r" (i)
! 				: "r" ((long)BLOCK_SIZE), "i" (BLOCK_SIZE/64), "i" ((long)CONFUSION_FACTOR)
! #if HAVE_BROKEN_GCC_CPP
! 				: "%eax", "%ebx"
! #else
! 				: "%"REG_a, "%ebx"
! #endif
! 		);
! #endif
! 	for(; i>0; i--)
  	{
  		__asm__ __volatile__ (
- #ifdef USE_MMX2
          	PREFETCH(" 320(%0)\n")
- #endif
  		"movq (%0), %%mm0\n"
  		"movq 8(%0), %%mm1\n"
--- 934,942 ----
  		to=((unsigned char *)to)+64;
  	}
  
!         for(; i>0; i--)
  	{
  		__asm__ __volatile__ (
          	PREFETCH(" 320(%0)\n")
  		"movq (%0), %%mm0\n"
  		"movq 8(%0), %%mm1\n"
***************
*** 930,942 ****
  	}
  
- #ifdef USE_MMX2
                  /* since movntq is weakly-ordered, a "sfence"
  		 * is needed to become ordered again. */
                   SFENCE;
- #endif
- #ifdef USE_MMX
  		/* enables to use FPU */
  		EMMS ;
- #endif
  	}
  	/*
--- 960,968 ----
***************
*** 946,947 ****
--- 972,975 ----
  	return retval;
  }
+ 
+ #endif // USE_MMX



From nobody at sheep.berlios.de  Sun Sep 17 18:49:41 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 18:49:41 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice utils.c,1.18,1.19
Message-ID: <20060917164941.3BA4F7DA72@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23533

Modified Files:
	utils.c 
Log Message:
- fix yv12_to_yuy2_il_mmx2_line() in case there are no optimizations enabled.



Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** utils.c	17 Sep 2006 16:39:34 -0000	1.18
--- utils.c	17 Sep 2006 16:49:12 -0000	1.19
***************
*** 110,114 ****
                             const uint8_t *uc, const uint8_t *vc)
  {
!   int i;
    
  #ifdef USE_MMX 
--- 110,114 ----
                             const uint8_t *uc, const uint8_t *vc)
  {
!   int i=chromaWidth;
    
  #ifdef USE_MMX 



From nobody at sheep.berlios.de  Sun Sep 17 20:41:56 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 20:41:56 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice utils.c, 1.19, 1.20 CHANGELOG, 1.237,
	1.238
Message-ID: <20060917184156.204547D87B@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32585

Modified Files:
	utils.c CHANGELOG 
Log Message:
- fix compile issue with g++-4.1.1


Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** utils.c	17 Sep 2006 16:49:12 -0000	1.19
--- utils.c	17 Sep 2006 18:41:27 -0000	1.20
***************
*** 175,181 ****
  #endif
     for ( ; i>=1; i-=1 ) {
!       *((uint32_t *)dest1)++ = (yc1[0] << 24)+ (uc[0] << 16) + (yc1[1] << 8) + (vc[0] << 0);
!       *((uint32_t *)dest2)++ = (yc2[0] << 24)+ (uc[0] << 16) + (yc2[1] << 8) + (vc[0] << 0);
        //*idst++ = (yc[0] << 0)+ (uc[0] << 8) + (yc[1] << 16) + (vc[0] << 24);
        yc1 += 2;
        yc2 += 2;
--- 175,183 ----
  #endif
     for ( ; i>=1; i-=1 ) {
!       *((uint32_t *)dest1) = (yc1[0] << 24)+ (uc[0] << 16) + (yc1[1] << 8) + (vc[0] << 0);
!       *((uint32_t *)dest2) = (yc2[0] << 24)+ (uc[0] << 16) + (yc2[1] << 8) + (vc[0] << 0);
        //*idst++ = (yc[0] << 0)+ (uc[0] << 8) + (yc[1] << 16) + (vc[0] << 24);
+       dest1+=4;
+       dest2+=4;
        yc1 += 2;
        yc2 += 2;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.237
retrieving revision 1.238
diff -C2 -d -r1.237 -r1.238
*** CHANGELOG	17 Sep 2006 16:39:34 -0000	1.237
--- CHANGELOG	17 Sep 2006 18:41:27 -0000	1.238
***************
*** 9,12 ****
--- 9,13 ----
       yv12_to_yuy2_il_mmx2_line()
     - make utils.c compile on non MMX machines, cleanup some #ifdefs
+    - fix compile issue with g++-4.1.1
  2006-09-xx:
     - added -vo shm: to help option



From nobody at sheep.berlios.de  Sun Sep 17 22:49:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Sep 2006 22:49:34 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.238, 1.239 SoftOsd.c, 1.18,
	1.19 SoftOsd.h, 1.7, 1.8
Message-ID: <20060917204934.4A4F57D5B9@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10081

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
- add NoVScaleCopyBitmap() for RGB modes


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.238
retrieving revision 1.239
diff -C2 -d -r1.238 -r1.239
*** CHANGELOG	17 Sep 2006 18:41:27 -0000	1.238
--- CHANGELOG	17 Sep 2006 20:49:04 -0000	1.239
***************
*** 10,13 ****
--- 10,14 ----
     - make utils.c compile on non MMX machines, cleanup some #ifdefs
     - fix compile issue with g++-4.1.1
+    - add NoVScaleCopyBitmap() for RGB modes
  2006-09-xx:
     - added -vo shm: to help option

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** SoftOsd.c	17 Sep 2006 11:54:32 -0000	1.18
--- SoftOsd.c	17 Sep 2006 20:49:05 -0000	1.19
***************
*** 1037,1041 ****
                  return;
  
! 	if (dest_Height>=OSD_HEIGHT)
  		ScaleVUpCopyToBitmap(dest,linesize,dest_Width,dest_Height,
                                  RefreshAll,dirtyLines);
--- 1037,1044 ----
                  return;
  
!         if ( dest_Height==OSD_HEIGHT )
!                 NoVScaleCopyToBitmap(dest,linesize,dest_Width,dest_Height,
!                                 RefreshAll,dirtyLines);
!         else if ( dest_Height>OSD_HEIGHT )
  		ScaleVUpCopyToBitmap(dest,linesize,dest_Width,dest_Height,
                                  RefreshAll,dirtyLines);
***************
*** 1147,1150 ****
--- 1150,1204 ----
  
  
+ //--------------------------- no vertical scale -----------------------------
+ void cSoftOsd::NoVScaleCopyToBitmap(uint8_t *dest, int linesize, 
+                 int dest_Width, int dest_Height, bool RefreshAll,
+                 bool *dest_dirtyLines) {
+ 	
+         OSDDEB("CopyToBitmap RGB down\n");
+ 	if ( bitmap_Format == PF_AYUV ) {
+                 fprintf(stderr,"cSoftOsd error did not call SetMode()!\n");
+ 		// convert bitmap to argb
+ 		bitmap_Format = PF_ARGB32;
+ 		Clear();
+ 		FlushBitmaps(false);
+ 	};
+ 
+ 	cMutexLock dirty(&dirty_Mutex);
+         uint8_t *buf;
+         color *pixmap=(color*) OSD_Bitmap;
+ 	const int dest_stride=(dest_Width+32)&~0xF;
+         color tmp_pixmap1[2*dest_stride];
+         color *tmp_pixmap=tmp_pixmap1;
+ 
+        void (cSoftOsd::*ScaleHoriz)(uint32_t * dest, int dest_Width, color * pixmap,int Pixel);
+ 	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
+ 		&cSoftOsd::ScaleUpHoriz_MMX;
+ 
+         for (int y=0; y<OSD_HEIGHT; y++) {
+ 
+                 if (!dirty_lines[y]) 
+                         continue;
+                 
+                 if (dest_Width==OSD_WIDTH) {
+                         tmp_pixmap=&pixmap[y*OSD_STRIDE];
+                 } else {
+                         (this->*ScaleHoriz)((uint32_t*)tmp_pixmap,dest_Width,
+                                       &pixmap[y*OSD_STRIDE],OSD_WIDTH-1);
+                 };
+                 
+                 buf=dest+y*linesize;
+                 //printf("copy to destination %d\n",y);
+                 (*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2);
+                 if (pixelMask)
+                         CreatePixelMask(pixelMask+y*linesize/16,
+                                         tmp_pixmap+1,dest_Width-2);
+                 if (dest_dirtyLines)
+                         dest_dirtyLines[y]=true;
+ 
+         };
+         memset(dirty_lines,false,sizeof(dirty_lines));
+         OSDDEB("CopyToBitmap RGB down end\n");
+ };
+ 
  //--------------------------- scale vertical down -----------------------------
  #define SCALEH_IDX(x) ((scaleH_strtIdx+(x))%lines_count)
***************
*** 1222,1227 ****
          OSDDEB("CopyToBitmap RGB down end\n");
  };
- 
- 
  
  //------------------------ lowlevel scaling functions ------------------------
--- 1276,1279 ----

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** SoftOsd.h	10 Jul 2006 18:23:28 -0000	1.7
--- SoftOsd.h	17 Sep 2006 20:49:05 -0000	1.8
***************
*** 143,146 ****
--- 143,149 ----
                      int dest_Width, int dest_Height, bool RefreshAll=false,
                      bool *dirtyLines=NULL);
+     void NoVScaleCopyToBitmap(uint8_t * dest, int linesize,
+                     int dest_Width, int dest_Height, bool RefreshAll=false,
+                     bool *dirtyLines=NULL);
      void ScaleVUpCopyToBitmap(uint8_t * dest, int linesize,
                      int dest_Width, int dest_Height, bool RefreshAll=false,



From nobody at sheep.berlios.de  Mon Sep 18 11:47:08 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 18 Sep 2006 11:47:08 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.239, 1.240 SoftOsd.c, 1.19,
	1.20
Message-ID: <20060918094708.6D01879610@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31002

Modified Files:
	CHANGELOG SoftOsd.c 
Log Message:
- fix RefreshAll for NoVScaleCopyToBitmap()


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.239
retrieving revision 1.240
diff -C2 -d -r1.239 -r1.240
*** CHANGELOG	17 Sep 2006 20:49:04 -0000	1.239
--- CHANGELOG	18 Sep 2006 09:46:38 -0000	1.240
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-09-18:
+    - fix RefreshAll for NoVScaleCopyToBitmap()
  2006-09-17:
     - replace "pshufw" with MMX commands to make scaling optimazations available
***************
*** 10,14 ****
     - make utils.c compile on non MMX machines, cleanup some #ifdefs
     - fix compile issue with g++-4.1.1
!    - add NoVScaleCopyBitmap() for RGB modes
  2006-09-xx:
     - added -vo shm: to help option
--- 12,16 ----
     - make utils.c compile on non MMX machines, cleanup some #ifdefs
     - fix compile issue with g++-4.1.1
!    - add NoVScaleCopyToBitmap() for RGB modes
  2006-09-xx:
     - added -vo shm: to help option

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** SoftOsd.c	17 Sep 2006 20:49:05 -0000	1.19
--- SoftOsd.c	18 Sep 2006 09:46:38 -0000	1.20
***************
*** 1177,1181 ****
          for (int y=0; y<OSD_HEIGHT; y++) {
  
!                 if (!dirty_lines[y]) 
                          continue;
                  
--- 1177,1181 ----
          for (int y=0; y<OSD_HEIGHT; y++) {
  
!                 if (!RefreshAll && !dirty_lines[y]) 
                          continue;
                  



From nobody at sheep.berlios.de  Mon Sep 18 12:07:08 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 18 Sep 2006 12:07:08 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice configure, 1.28, 1.29 Makefile, 1.33,
	1.34 CHANGELOG, 1.240, 1.241
Message-ID: <20060918100708.2F8EF77DE1@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv209

Modified Files:
	configure Makefile CHANGELOG 
Log Message:
- add a very simple cpu type and host system detection to configure


Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** configure	17 Sep 2006 13:02:46 -0000	1.28
--- configure	18 Sep 2006 10:06:38 -0000	1.29
***************
*** 21,24 ****
--- 21,26 ----
  : ${CFLAGS=""}
  
+ system="Linux"
+ cpu_arch="i386"
  use_pkgconfig="yes"
  ffmpeg="yes"
***************
*** 37,40 ****
--- 39,43 ----
  with_mmx="yes"
  with_mmx2="yes"
+ with_altivec="no"
  cle266="yes"
  alsa="yes"
***************
*** 89,92 ****
--- 92,130 ----
  
  #########################################################
+ # detect host system and cpu type
+ #
+ echo -n "Testing system and cpu type... "
+ echo "Testing system and cpu type.----------------------------" >> config.log
+ echo "uname -a: `uname -a`" >> config.log
+ echo "$cc -dumpmache: `$cc -dumpmachine `" >> config.log
+ 
+ system=`uname -s`
+ case "$system" in
+   Linux) system="Linux";;
+   Darwin) system="Darwin";;
+   *) system="unknown";;
+ esac
+ 
+ cpu_arch=`uname -m`
+ case "$cpu_arch" in
+   i[3-6]86*) 
+         cpu_arch="i386"
+         ;;
+   ppc|"Power Macintosh") 
+         cpu_arch="PowerPC"
+         with_mmx="no" 
+         with_mmx2="no"
+         with_altivec="yes"
+         ;;
+   *) 
+         cpu_arch="unknown"
+         with_mmx="no" 
+         with_mmx2="no"  
+         ;;
+ esac
+ 
+ echo "found $system on $cpu_arch cpu."
+ 
+ #########################################################
  # start pkg-config test
  #
***************
*** 519,522 ****
--- 557,565 ----
      echo "#define USE_MMX2 1" >> $TMPH
    fi
+ fi
+ 
+ if test "${with_altivec}" = "yes" ; then
+   echo "#define USE_ALTIVEC 1" >> $TMPH
+   echo "ADD_CXXFLAGS += -faltivec" >> $TMPM
  fi
  

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** Makefile	10 Jul 2006 19:40:25 -0000	1.33
--- Makefile	18 Sep 2006 10:06:38 -0000	1.34
***************
*** 197,201 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual
  
  ### The directory environment:
--- 197,201 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual $(ADD_CXXFLAGS)
  
  ### The directory environment:

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.240
retrieving revision 1.241
diff -C2 -d -r1.240 -r1.241
*** CHANGELOG	18 Sep 2006 09:46:38 -0000	1.240
--- CHANGELOG	18 Sep 2006 10:06:38 -0000	1.241
***************
*** 2,5 ****
--- 2,6 ----
  2006-09-18:
     - fix RefreshAll for NoVScaleCopyToBitmap()
+    - add a very simple cpu type and host system detection to configure
  2006-09-17:
     - replace "pshufw" with MMX commands to make scaling optimazations available



From nobody at sheep.berlios.de  Mon Sep 18 12:14:30 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 18 Sep 2006 12:14:30 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.241, 1.242 video-xv.c, 1.61,
	1.62
Message-ID: <20060918101430.DDD10794FB@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv907

Modified Files:
	CHANGELOG video-xv.c 
Log Message:
- fix changing from pseudo to software osd blending for video-xv


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.241
retrieving revision 1.242
diff -C2 -d -r1.241 -r1.242
*** CHANGELOG	18 Sep 2006 10:06:38 -0000	1.241
--- CHANGELOG	18 Sep 2006 10:14:01 -0000	1.242
***************
*** 3,6 ****
--- 3,7 ----
     - fix RefreshAll for NoVScaleCopyToBitmap()
     - add a very simple cpu type and host system detection to configure
+    - fix changing from pseudo to software osd blending for video-xv
  2006-09-17:
     - replace "pshufw" with MMX commands to make scaling optimazations available

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.61
retrieving revision 1.62
diff -C2 -d -r1.61 -r1.62
*** video-xv.c	9 Sep 2006 09:55:25 -0000	1.61
--- video-xv.c	18 Sep 2006 10:14:01 -0000	1.62
***************
*** 1593,1600 ****
  {
    cVideoOut::ClearOSD();
!   if (videoInitialized && current_osdMode==OSDMODE_PSEUDO) {
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     ShowOSD();
      XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
--- 1593,1600 ----
  {
    cVideoOut::ClearOSD();
!   if ( videoInitialized ) {
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     XClearArea (dpy, win, 0, 0, 0, 0, False);
      XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);



From nobody at sheep.berlios.de  Mon Sep 18 12:17:00 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 18 Sep 2006 12:17:00 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice configure,1.29,1.30
Message-ID: <20060918101700.B8664638F0@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1137

Modified Files:
	configure 
Log Message:
- remove no longer needed test for broken gcc compiler from configure


Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** configure	18 Sep 2006 10:06:38 -0000	1.29
--- configure	18 Sep 2006 10:16:31 -0000	1.30
***************
*** 496,538 ****
  fi
  
- #########################################################
- broken_gcc_cpp="no"
- cat > ${TMPC} << EOF
- 
- #include <stdio.h>
- #define BLOCK_SIZE 4096
- 
- #ifdef __x86_64__
- # define  REG_a "rax"
- #else
- # define  REG_a "eax"
- #endif
- 
- #define CONFUSION_FACTOR 0
- 
- int main(void) {
-     void    *to, *from;
-     size_t  i;
- 
-   asm volatile(
-     "xor %%"REG_a", %%"REG_a"	\n\t"
-     "xor %%"REG_a", %%"REG_a"	\n\t"
-     "add %3, %0		\n\t"
-     "add %3, %1		\n\t"
-     "sub %4, %2		\n\t"
-     "cmp %4, %2		\n\t"
-       : "+r" (from),
-         "+r" (to),
-         "+r" (i)
-       : "r" ((long)BLOCK_SIZE),
-         "i" (BLOCK_SIZE/64),
-         "i" ((long)CONFUSION_FACTOR)
-       : "%"REG_a,
-         "%ebx"
-     );
-   return 0;
- }
- EOF
- $cc $CFLAGS -o $TMPE $TMPC >> config.log 2>&1 || broken_gcc_cpp="yes"
  ###########
  
--- 496,499 ----
***************
*** 652,664 ****
    echo "FB_SUPPORT = 1" >> $TMPM
    echo "#define FB_SUPPORT  1" >> $TMPH
- fi
- 
- ###############################################################################
- # generating utils.c specific specific defines
- #
- if test "${broken_gcc_cpp}" = "yes" ; then
-   echo "#define HAVE_BROKEN_GCC_CPP  1" >> $TMPH
- else
-   echo "#define HAVE_BROKEN_GCC_CPP  0" >> $TMPH
  fi
  
--- 613,616 ----



From nobody at sheep.berlios.de  Mon Sep 18 12:51:04 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 18 Sep 2006 12:51:04 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.242, 1.243 video-shm.c,
	1.10, 1.11 video-shm.h, 1.7, 1.8
Message-ID: <20060918105104.4FD0B7BEC2@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15156

Modified Files:
	CHANGELOG video-shm.c video-shm.h 
Log Message:
- combine shared memory checks into CheckShmIDs()
- improve error messages in video-shm.c
   


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.242
retrieving revision 1.243
diff -C2 -d -r1.242 -r1.243
*** CHANGELOG	18 Sep 2006 10:14:01 -0000	1.242
--- CHANGELOG	18 Sep 2006 10:50:33 -0000	1.243
***************
*** 4,7 ****
--- 4,10 ----
     - add a very simple cpu type and host system detection to configure
     - fix changing from pseudo to software osd blending for video-xv
+    - remove no longer needed test for broken gcc compiler from configure
+    - combine shared memory checks into CheckShmIDs()
+    - improve error messages in video-shm.c
  2006-09-17:
     - replace "pshufw" with MMX commands to make scaling optimazations available

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-shm.c	4 Sep 2006 20:25:17 -0000	1.10
--- video-shm.c	18 Sep 2006 10:50:33 -0000	1.11
***************
*** 69,80 ****
          // first try to get an existing ShmCltBlock
          if  ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 0666)) >= 0 ) {
!                 fprintf(stderr,"got ctl_shmid %d shm ctl!\n",ctl_shmid);
          } else if ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 
                                          IPC_CREAT | 0666)) >= 0 ) {
!                 fprintf(stderr,"created ctl_shmid %d shm ctl!\n",ctl_shmid);
                  // created ShmCltBlock, clear it
                  Clear_Ctl=true;
          } else {
!                 fprintf(stderr,"error creating shm ctl!\n");
                  exit(-1);
          };
--- 69,80 ----
          // first try to get an existing ShmCltBlock
          if  ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 0666)) >= 0 ) {
!                 fprintf(stderr,"cShmVideoOut: Got ctl_shmid %d shm ctl!\n",ctl_shmid);
          } else if ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 
                                          IPC_CREAT | 0666)) >= 0 ) {
!                 fprintf(stderr,"cShmVideoOut: Created ctl_shmid %d shm ctl!\n",ctl_shmid);
                  // created ShmCltBlock, clear it
                  Clear_Ctl=true;
          } else {
!                 fprintf(stderr,"cShmVideoOut: Error creating shm ctl!\n");
                  exit(-1);
          };
***************
*** 83,87 ****
          if ( (ctl = (ShmCtlBlock*)shmat(ctl_shmid,NULL,0)) 
                          == (ShmCtlBlock*) -1 ) {
!                 fprintf(stderr,"error attatching shm ctl!\n");
                  exit(-1);
          };
--- 83,87 ----
          if ( (ctl = (ShmCtlBlock*)shmat(ctl_shmid,NULL,0)) 
                          == (ShmCtlBlock*) -1 ) {
!                 fprintf(stderr,"cShmVideoOut: Error attatching shm ctl!\n");
                  exit(-1);
          };
***************
*** 98,105 ****
                  if ( (ctl->semid = semget(IPC_PRIVATE, 4, 0666 | IPC_CREAT) )
                                  == -1) {
!                         fprintf(stderr,"error creating semaphore set!\n");
                          exit(-1);
                  };
!                 printf("created semaphores id %d\n",ctl->semid);
          };
  
--- 98,105 ----
                  if ( (ctl->semid = semget(IPC_PRIVATE, 4, 0666 | IPC_CREAT) )
                                  == -1) {
!                         fprintf(stderr,"cShmVideoOut: Error creating semaphore set!\n");
                          exit(-1);
                  };
!                 SHMDEB("created semaphores id %d\n",ctl->semid);
          };
  
***************
*** 107,115 ****
          sem_val.val = 0; // nothing available
          if ( semctl(ctl->semid,PICT_SIG, SETVAL, sem_val) == -1 ) {
!                 printf("error resetting semaphore PICT_SIG\n");
                  exit(-1);
          };
          if ( semctl(ctl->semid,KEY_SIG,SETVAL,sem_val) == -1 ) {
!                 printf("error resetting semaphore KEY_SIG\n");
                  exit(-1);
          };
--- 107,115 ----
          sem_val.val = 0; // nothing available
          if ( semctl(ctl->semid,PICT_SIG, SETVAL, sem_val) == -1 ) {
!                 fprintf(stderr,"cShmVideoOut: Error resetting semaphore PICT_SIG\n");
                  exit(-1);
          };
          if ( semctl(ctl->semid,KEY_SIG,SETVAL,sem_val) == -1 ) {
!                 fprintf(stderr,"cShmVideoOut: Error resetting semaphore KEY_SIG\n");
                  exit(-1);
          };
***************
*** 117,125 ****
          sem_val.val = 1; // not locked
          if ( semctl(ctl->semid,PICT_MUT, SETVAL, sem_val) == -1 ) {
!                 printf("error resetting semaphore PICT_MUT\n");
                  exit(-1);
          };
          if ( semctl(ctl->semid,KEY_MUT,SETVAL,sem_val) == -1 ) {
!                 printf("error resetting semaphore KEY_MUT\n");
                  exit(-1);
          };
--- 117,125 ----
          sem_val.val = 1; // not locked
          if ( semctl(ctl->semid,PICT_MUT, SETVAL, sem_val) == -1 ) {
!                 fprintf(stderr,"cShmVideoOut: Error resetting semaphore PICT_MUT\n");
                  exit(-1);
          };
          if ( semctl(ctl->semid,KEY_MUT,SETVAL,sem_val) == -1 ) {
!                 fprintf(stderr,"cShmVideoOut: Error resetting semaphore KEY_MUT\n");
                  exit(-1);
          };
***************
*** 141,145 ****
          // remove semaphore 
          if ( semctl(ctl->semid, 0, IPC_RMID, sem_val ) == -1) {
!             fprintf(stderr,"error removeing semaphore set!\n");
              exit(1);
          }
--- 141,145 ----
          // remove semaphore 
          if ( semctl(ctl->semid, 0, IPC_RMID, sem_val ) == -1) {
!             fprintf(stderr,"cShmVideoOut: Error removing semaphore set!\n");
              exit(1);
          }
***************
*** 196,207 ****
  };       
  
! void cShmVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines) {
! 	SHMDEB("GetLockOsdSurface osd_surface %p\n",osd_surface);
          if ( ctl->osd_shmid != curr_osd_shmid ) {
                  if (osd_surface) {
                          shmdt(osd_surface);
                          osd_surface=NULL;
-                         osd=NULL;
                  };
                  
--- 196,249 ----
  };       
  
! void cShmVideoOut::CheckShmIDs() {
! 
!         if ( ctl->pict_shmid != curr_pict_shmid ) {
!                 if (curr_pict) {
!                         shmdt(curr_pict);
!                         curr_pict=NULL;
!                 };
! 
!                 if ( ctl->pict_shmid != -1 ) {
!                         if ( (curr_pict = (uint8_t *)shmat(ctl->pict_shmid,NULL,0)) 
!                                         == (uint8_t*) -1 ) {
!                                 fprintf(stderr,"cShmVideoOut: Warning! Could not attatch to shm pict! Assuming no client connected.\n");
!                                 ctl->pict_shmid = -1;
!                                 ctl->attached = 0;
!                                 curr_pict=NULL;
!                                 sem_sig_unlock(ctl->semid,PICT_MUT);
!                                 return;
!                         }
!                         curr_pict_shmid=ctl->pict_shmid;
!                         privBuf.format=ctl->format;
!                         privBuf.max_width=ctl->max_width;
!                         privBuf.max_height=ctl->max_height;
!                         switch (privBuf.format) {
!                                 case PIX_FMT_YUV420P:  
!                                         SHMDEB("new format YUV420P\n");
!                                         privBuf.pixel[0]=curr_pict+ctl->offset0;
!                                         privBuf.pixel[1]=curr_pict+ctl->offset1;
!                                         privBuf.pixel[2]=curr_pict+ctl->offset2;
!                                         privBuf.stride[0]=ctl->stride0;
!                                         privBuf.stride[1]=ctl->stride1;
!                                         privBuf.stride[2]=ctl->stride2;
!                                         break;
!                                 case PIX_FMT_YUV422:
!                                         SHMDEB("new format YUV422\n");
!                                         privBuf.pixel[0]=curr_pict+ctl->offset0;
!                                         privBuf.pixel[1]=privBuf.pixel[1]=NULL;
!                                         privBuf.stride[0]=ctl->stride0;
!                                         privBuf.stride[1]=privBuf.stride[2]=0;
!                                         break;
!                                 default:
!                                         break;
!                         }
!                         SHMDEB("new pict %p shmid %d\n",curr_pict,curr_pict_shmid);
!                 };
!         };
!  
          if ( ctl->osd_shmid != curr_osd_shmid ) {
                  if (osd_surface) {
                          shmdt(osd_surface);
                          osd_surface=NULL;
                  };
                  
***************
*** 210,214 ****
                         if ( (osd_surface = (uint8_t *)shmat(ctl->osd_shmid,NULL,0)) 
                                         == (uint8_t*) -1 ) {
!                                fprintf(stderr,"error attatching osd pict(%d)! Assuming no client connected\n",
                                                 ctl->osd_shmid);
                                 ctl->pict_shmid = -1;
--- 252,256 ----
                         if ( (osd_surface = (uint8_t *)shmat(ctl->osd_shmid,NULL,0)) 
                                         == (uint8_t*) -1 ) {
!                                fprintf(stderr,"cShmVideoOut: Warning! Could not attatch to osd pict(%d)! Assuming no client connected.\n",
                                                 ctl->osd_shmid);
                                 ctl->pict_shmid = -1;
***************
*** 216,220 ****
                                 ctl->attached = 0;
                                 osd_surface=NULL;
-                                osd=NULL;
                                 return;
                         }
--- 258,261 ----
***************
*** 223,227 ****
--- 264,274 ----
  	        SHMDEB("got new osd_surface %p\n",osd_surface);
          };
+ }
+ 
+ void cShmVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
+                   bool *&dirtyLines) {
+ 	SHMDEB("GetLockOsdSurface osd_surface %p osd_shmid %d\n",osd_surface,ctl->osd_shmid);
  
+         CheckShmIDs();
          osd=osd_surface;
          stride=ctl->osd_stride;
***************
*** 229,258 ****
  };
  
! void cShmVideoOut::ClearOSD()
! {
!   SHMDEB("ClearOsd\n");
!   cVideoOut::ClearOSD();
!   if ( ctl->osd_shmid != curr_osd_shmid ) {
!           if (osd_surface) {
!                   shmdt(osd_surface);
!                   osd_surface=NULL;
!           };
  
!           if ( ctl->osd_shmid != -1 ) {
!                   if ( (osd_surface = (uint8_t *)shmat(ctl->osd_shmid,NULL,0)) 
!                                   == (uint8_t*) -1 ) {
!                           fprintf(stderr,"error attatching osd pict(%d)! Assuming no client connected\n",
!                                           ctl->osd_shmid);
!                           ctl->osd_shmid = -1;
!                           ctl->attached = 0;
!                           osd_surface=NULL;
!                           return;
!                   } 
!           };
!   };
!   if (osd_surface)
!           memset (osd_surface, 0, ctl->osd_stride *ctl->osd_max_height);
!   ctl->new_osd++;
!   sem_sig_unlock(ctl->semid,PICT_SIG);
  };
  
--- 276,290 ----
  };
  
! void cShmVideoOut::ClearOSD() {
!         SHMDEB("ClearOsd\n");
!         cVideoOut::ClearOSD();
!         if (current_osdMode == OSDMODE_SOFTWARE)
!                 return;
  
!         CheckShmIDs();
!         if (osd_surface)
!                 memset (osd_surface, 0, ctl->osd_stride *ctl->osd_max_height);
!         ctl->new_osd++;
!         sem_sig_unlock(ctl->semid,PICT_SIG);
  };
  
***************
*** 305,354 ****
          sem_wait_lock(ctl->semid,PICT_MUT);
          SIGDEB("YUV got a lock\n");
          
!         if ( ctl->pict_shmid != curr_pict_shmid ) {
!                 if (curr_pict) {
!                         shmdt(curr_pict);
!                         curr_pict=NULL;
!                 };
!                 
!                 if ( ctl->pict_shmid != -1 ) {
!                        if ( (curr_pict = (uint8_t *)shmat(ctl->pict_shmid,NULL,0)) 
!                                        == (uint8_t*) -1 ) {
!                                fprintf(stderr,"error attatching shm pict! Assuming no client connected\n");
!                                ctl->pict_shmid = -1;
!                                ctl->attached = 0;
!                                curr_pict=NULL;
!                                sem_sig_unlock(ctl->semid,PICT_MUT);
!                                return;
!                        }
!                        curr_pict_shmid=ctl->pict_shmid;
!                        privBuf.format=ctl->format;
!                        privBuf.max_width=ctl->max_width;
!                        privBuf.max_height=ctl->max_height;
!                        switch (privBuf.format) {
!                         case PIX_FMT_YUV420P:  
!                                 SHMDEB("new format YUV420P\n");
!                                 privBuf.pixel[0]=curr_pict+ctl->offset0;
!                                 privBuf.pixel[1]=curr_pict+ctl->offset1;
!                                 privBuf.pixel[2]=curr_pict+ctl->offset2;
!                                 privBuf.stride[0]=ctl->stride0;
!                                 privBuf.stride[1]=ctl->stride1;
!                                 privBuf.stride[2]=ctl->stride2;
!                                 break;
!                         case PIX_FMT_YUV422:
!                                 SHMDEB("new format YUV422\n");
!                                 privBuf.pixel[0]=curr_pict+ctl->offset0;
!                                 privBuf.pixel[1]=privBuf.pixel[1]=NULL;
!                                 privBuf.stride[0]=ctl->stride0;
!                                 privBuf.stride[1]=privBuf.stride[2]=0;
!                                 break;
!                         default:
!                                 break;
!                        }
!                        SHMDEB("new pict %p shmid %d\n",curr_pict,curr_pict_shmid);
!                 };
!         };
!         
!         if (!ctl->pict_shmid || !curr_pict) {
                  // unlock picture ctl
                  sem_sig_unlock(ctl->semid,PICT_MUT);
--- 337,344 ----
          sem_wait_lock(ctl->semid,PICT_MUT);
          SIGDEB("YUV got a lock\n");
+ 
+         CheckShmIDs();        
          
!         if ( ctl->pict_shmid==-1 || !curr_pict ) {
                  // unlock picture ctl
                  sem_sig_unlock(ctl->semid,PICT_MUT);

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video-shm.h	4 Sep 2006 20:25:17 -0000	1.7
--- video-shm.h	18 Sep 2006 10:50:33 -0000	1.8
***************
*** 61,64 ****
--- 61,66 ----
  
          virtual void Suspend();
+ 
+         void CheckShmIDs();
  };
  



From nobody at sheep.berlios.de  Tue Sep 19 15:24:21 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 19 Sep 2006 15:24:21 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.243, 1.244 video.c, 1.63,
	1.64
Message-ID: <20060919132421.991977E9F4@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13

Modified Files:
	CHANGELOG video.c 
Log Message:
- fix "Error! Trying to unlock a nil picture... Ignoring" error message.
- use current_OsdMode instead of setupStore.OsdMode


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.243
retrieving revision 1.244
diff -C2 -d -r1.243 -r1.244
*** CHANGELOG	18 Sep 2006 10:50:33 -0000	1.243
--- CHANGELOG	19 Sep 2006 13:23:51 -0000	1.244
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-09-19:
+    - fix "Error! Trying to unlock a nil picture... Ignoring" error message.
+    - use current_OsdMode instead of setupStore.OsdMode
  2006-09-18:
     - fix RefreshAll for NoVScaleCopyToBitmap()

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.63
retrieving revision 1.64
diff -C2 -d -r1.63 -r1.64
*** video.c	8 Sep 2006 04:59:02 -0000	1.63
--- video.c	19 Sep 2006 13:23:51 -0000	1.64
***************
*** 106,110 ****
      if (
          OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
!         (setupStore->osdMode == OSDMODE_SOFTWARE &&
           OsdRefreshCounter>5 && Osd_changed))
      {
--- 106,110 ----
      if (
          OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
!         (current_osdMode == OSDMODE_SOFTWARE &&
           OsdRefreshCounter>5 && Osd_changed))
      {
***************
*** 145,149 ****
    //osdMutex.Lock(); //protected by areaMutex osdMutex will cause deadlocks!
    //PICDEB("SetOldPicture pic->buf_num %d\n",picture->buf_num);
!   UnlockBuffer(old_picture);
    if (picture && picture->owner==this) {
       LockBuffer(picture);
--- 145,150 ----
    //osdMutex.Lock(); //protected by areaMutex osdMutex will cause deadlocks!
    //PICDEB("SetOldPicture pic->buf_num %d\n",picture->buf_num);
!   if (old_picture)
!           UnlockBuffer(old_picture);
    if (picture && picture->owner==this) {
       LockBuffer(picture);



From nobody at sheep.berlios.de  Thu Sep 21 12:36:23 2006
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 21 Sep 2006 12:36:23 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.244, 1.245 SoftOsd.c, 1.20,
	1.21 SoftOsd.h, 1.8, 1.9
Message-ID: <20060921103623.47804819D5@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1190

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
- introduce a mutex to protect calls to videoOut from SoftOsd
- initialize parameters for the vout->GetOSDMode() call


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.244
retrieving revision 1.245
diff -C2 -d -r1.244 -r1.245
*** CHANGELOG	19 Sep 2006 13:23:51 -0000	1.244
--- CHANGELOG	21 Sep 2006 10:35:51 -0000	1.245
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-09-21:
+    - introduce a mutex to protect calls to videoOut from SoftOsd
+    - initialize parameters for the vout->GetOSDMode() call
  2006-09-19:
     - fix "Error! Trying to unlock a nil picture... Ignoring" error message.

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** SoftOsd.c	18 Sep 2006 09:46:38 -0000	1.20
--- SoftOsd.c	21 Sep 2006 10:35:51 -0000	1.21
***************
*** 53,61 ****
          videoOut = VideoOut;
          xPan = yPan = 0;
  	videoOut->OpenOSD();
  	xOfs=X;yOfs=Y;
          ScreenOsdWidth=ScreenOsdHeight=0;
!         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
!         uint8_t *PixelMask;
          videoOut->AdjustOSDMode();
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
--- 53,62 ----
          videoOut = VideoOut;
          xPan = yPan = 0;
+         voutMutex.Lock();
  	videoOut->OpenOSD();
  	xOfs=X;yOfs=Y;
          ScreenOsdWidth=ScreenOsdHeight=0;
!         int Depth=16; bool HasAlpha=false; bool AlphaInversed=false; 
!         bool IsYUV=false; uint8_t *PixelMask=NULL;
          videoOut->AdjustOSDMode();
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
***************
*** 63,66 ****
--- 64,68 ----
          SetMode(Depth,HasAlpha,AlphaInversed,
                          IsYUV,PixelMask);
+         voutMutex.Unlock();
  };
  
***************
*** 87,92 ****
--- 89,96 ----
          Cancel(3);
          if (videoOut) {
+                 voutMutex.Lock();
                  videoOut->CloseOSD();
                  videoOut=0;
+                 voutMutex.Unlock();
          }
          delete[] OSD_Bitmap;
***************
*** 102,105 ****
--- 106,115 ----
                  int newXPan, newYPan;
  
+                 voutMutex.Lock();
+                 if (!videoOut) {
+                         voutMutex.Unlock();
+                         continue;
+                 };
+                 
                  videoOut->AdjustOSDMode();
                  videoOut->GetOSDDimension(newOsdWidth,newOsdHeight,newXPan,newYPan);
***************
*** 110,115 ****
                  }
  
!                 int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV;
!                 uint8_t *PixelMask;
                  videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
                                  IsYUV,PixelMask);
--- 120,125 ----
                  }
  
!                 int Depth=16; bool HasAlpha=false; bool AlphaInversed=false; 
!                 bool IsYUV=false; uint8_t *PixelMask=NULL;
                  videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
                                  IsYUV,PixelMask);
***************
*** 131,134 ****
--- 141,146 ----
                          OsdCommit();
                  }
+                 voutMutex.Unlock();
+ 
                  usleep(17000);
          }
***************
*** 156,161 ****
          };
  
!         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV;
!         uint8_t *PixelMask;
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
          bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
--- 168,173 ----
          };
  
!         int Depth=16; bool HasAlpha=false; bool AlphaInversed=false; 
!         bool IsYUV=false; uint8_t *PixelMask=NULL;
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
          bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
***************
*** 256,262 ****
          OSDDEB("SoftOsd::Flush \n");
  	bool OSD_changed=FlushBitmaps(true);
! 	
          if (OSD_changed)
                  OsdCommit();
  
  	// give priority to the other threads
--- 268,276 ----
          OSDDEB("SoftOsd::Flush \n");
  	bool OSD_changed=FlushBitmaps(true);
! 
!         voutMutex.Lock();
          if (OSD_changed)
                  OsdCommit();
+         voutMutex.Unlock();
  
  	// give priority to the other threads

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** SoftOsd.h	17 Sep 2006 20:49:05 -0000	1.8
--- SoftOsd.h	21 Sep 2006 10:35:51 -0000	1.9
***************
*** 65,68 ****
--- 65,69 ----
  class cSoftOsd : public cOsd,cThread {
  private:
+     cMutex voutMutex; // lock all operations on videoOut!
      cVideoOut *videoOut;
  protected:
***************
*** 94,98 ****
--- 95,101 ----
      cSoftOsd(cVideoOut *VideoOut, int XOfs, int XOfs);
      virtual ~cSoftOsd();
+     virtual void Flush(void);
  
+ protected:
      bool SetMode(int Depth, bool HasAlpha, bool AlphaInversed, 
                   bool IsYUV, uint8_t *PixelMask=NULL);
***************
*** 100,105 ****
      bool FlushBitmaps(bool OnlyDirty);
      bool DrawConvertBitmap(cBitmap *Bitmap, bool OnlyDirty);
!     virtual void Flush(void);
!     void OsdCommit();
      
      void Clear();
--- 103,109 ----
      bool FlushBitmaps(bool OnlyDirty);
      bool DrawConvertBitmap(cBitmap *Bitmap, bool OnlyDirty);
!     
!     void OsdCommit(); 
!     // may only be called if the caller holds voutMutex
      
      void Clear();
***************
*** 166,171 ****
                  color **pixmap, int Pixel);
  
-  public:
- 	    
  };
  
--- 170,173 ----



From nobody at sheep.berlios.de  Fri Sep 22 06:20:30 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 22 Sep 2006 06:20:30 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.245, 1.246 video.c, 1.64,
	1.65 video.h, 1.41, 1.42
Message-ID: <20060922042030.2A08281755@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28479

Modified Files:
	CHANGELOG video.c video.h 
Log Message:
protect locking for old picture by a separate mutex

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.245
retrieving revision 1.246
diff -C2 -d -r1.245 -r1.246
*** CHANGELOG	21 Sep 2006 10:35:51 -0000	1.245
--- CHANGELOG	22 Sep 2006 04:19:58 -0000	1.246
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-09-22:
+    - protect locking for old picture by a separate mutex
  2006-09-21:
     - introduce a mutex to protect calls to videoOut from SoftOsd
***************
*** 19,28 ****
     - add linux framebuffer detection to configure
     - disable libcle266mpegdec if no DirectFB is found
!    - add altivec optimizations to some AlphaBlend() and 
       yv12_to_yuy2_il_mmx2_line()
     - make utils.c compile on non MMX machines, cleanup some #ifdefs
     - fix compile issue with g++-4.1.1
     - add NoVScaleCopyToBitmap() for RGB modes
! 2006-09-xx:
     - added -vo shm: to help option
     - added support new fields from libcle266mpegdec-0.4
--- 21,30 ----
     - add linux framebuffer detection to configure
     - disable libcle266mpegdec if no DirectFB is found
!    - add altivec optimizations to some AlphaBlend() and
       yv12_to_yuy2_il_mmx2_line()
     - make utils.c compile on non MMX machines, cleanup some #ifdefs
     - fix compile issue with g++-4.1.1
     - add NoVScaleCopyToBitmap() for RGB modes
! 2006-09-16:
     - added -vo shm: to help option
     - added support new fields from libcle266mpegdec-0.4

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.64
retrieving revision 1.65
diff -C2 -d -r1.64 -r1.65
*** video.c	19 Sep 2006 13:23:51 -0000	1.64
--- video.c	22 Sep 2006 04:19:58 -0000	1.65
***************
*** 50,54 ****
    freezeMode=false;
    videoInitialized = false;
!   old_picture = NULL;
  
    for (int i = 0; i < SETUP_VIDEOASPECTNAMES_COUNT; ++i)
--- 50,54 ----
    freezeMode=false;
    videoInitialized = false;
!   oldPicture = NULL;
  
    for (int i = 0; i < SETUP_VIDEOASPECTNAMES_COUNT; ++i)
***************
*** 109,117 ****
           OsdRefreshCounter>5 && Osd_changed))
      {
!       osdMutex.Lock();
!       if (old_picture)
        {
!         OSDDEB("redrawing old_picture osd_changed %d\n",Osd_changed);
!         DrawStill_420pl(old_picture);
        }
        else
--- 109,117 ----
           OsdRefreshCounter>5 && Osd_changed))
      {
!       oldPictureMutex.Lock();
!       if (oldPicture)
        {
!         OSDDEB("redrawing oldPicture osd_changed %d\n",Osd_changed);
!         DrawStill_420pl(oldPicture);
        }
        else
***************
*** 133,137 ****
          DrawStill_420pl(&tmpBuf);
        }
!       osdMutex.Unlock();
      }
    }
--- 133,137 ----
          DrawStill_420pl(&tmpBuf);
        }
!       oldPictureMutex.Unlock();
      }
    }
***************
*** 143,156 ****
  void cVideoOut::SetOldPicture(sPicBuffer *picture)
  {
!   //osdMutex.Lock(); //protected by areaMutex osdMutex will cause deadlocks!
!   //PICDEB("SetOldPicture pic->buf_num %d\n",picture->buf_num);
!   if (old_picture)
!           UnlockBuffer(old_picture);
    if (picture && picture->owner==this) {
!      LockBuffer(picture);
!      old_picture=picture;
!   } else old_picture = NULL;
  
!   //osdMutex.Unlock();
  }
  
--- 143,157 ----
  void cVideoOut::SetOldPicture(sPicBuffer *picture)
  {
!   oldPictureMutex.Lock();
! 
!   if (oldPicture)
!     UnlockBuffer(oldPicture);
    if (picture && picture->owner==this) {
!     LockBuffer(picture);
!     oldPicture=picture;
!   } else
!     oldPicture = NULL;
  
!   oldPictureMutex.Unlock();
  }
  
***************
*** 451,457 ****
    // display picture
    YUV(pic);
-   SetOldPicture(pic);
- 
    areaMutex. Unlock();
    ProcessEvents();
  }
--- 452,458 ----
    // display picture
    YUV(pic);
    areaMutex. Unlock();
+ 
+   SetOldPicture(pic);
    ProcessEvents();
  }
***************
*** 469,472 ****
--- 470,474 ----
    YUV (buf);
    areaMutex. Unlock();
+ 
    ProcessEvents();
  }
***************
*** 477,496 ****
  {
    OSDDEB("ClearOSD\n");
    OSDpresent=false; // will automaticly be set to true on redraw ;-)
!   //if (current_osdMode==OSDMODE_SOFTWARE)
!   {
!     if (OsdPy)
!        memset(OsdPy,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
!     if (OsdPu)
!        memset(OsdPu,127,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
!     if (OsdPv)
!        memset(OsdPv,127,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
!     if (OsdPAlphaY)
!        memset(OsdPAlphaY,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
!     if (OsdPAlphaUV)
!        memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
!    };
    Osd_changed=1;
! };
  
  #if VDRVERSNUM >= 10307
--- 479,499 ----
  {
    OSDDEB("ClearOSD\n");
+   osdMutex.Lock();
+ 
    OSDpresent=false; // will automaticly be set to true on redraw ;-)
!   if (OsdPy)
!     memset(OsdPy,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
!   if (OsdPu)
!     memset(OsdPu,127,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
!   if (OsdPv)
!     memset(OsdPv,127,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
!   if (OsdPAlphaY)
!     memset(OsdPAlphaY,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
!   if (OsdPAlphaUV)
!     memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
    Osd_changed=1;
! 
!  osdMutex.Unlock();
! }
  
  #if VDRVERSNUM >= 10307

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** video.h	27 Aug 2006 13:02:50 -0000	1.41
--- video.h	22 Sep 2006 04:19:58 -0000	1.42
***************
*** 76,79 ****
--- 76,89 ----
              AdjustToDisplayGeometry(double afd_aspect);
  
+     // -----------------------------------------------------------------------
+     // oldPicture is a reference to a previous decoded frame. It is used
+     // when there is osd drawing activity in case of no video currently
+     // available. Access to this pointer must be protected by corresponding
+     // mutex: oldPictureMutex .
+     //
+     sPicBuffer  *oldPicture;
+     cMutex      oldPictureMutex;
+     void        SetOldPicture(sPicBuffer *pic);
+ 
  protected:
      inline double GetAspect_F()
***************
*** 81,84 ****
--- 91,100 ----
  
  protected:
+     // -----------------------------------------------------------------------
+     // State changes of OSD like on / off transitions, must be proteced by
+     // osdMutex. This are changes of variable OSDpresent, as the output method
+     // may need to take some longer actions e.g clearing background for one or
+     // mutiple output buffers (double, triple buffering).
+     //
      cMutex  osdMutex,
              areaMutex;
***************
*** 114,118 ****
      double  parValues[SETUP_VIDEOASPECTNAMES_COUNT];
  
-     sPicBuffer *old_picture;
      bool    videoInitialized;
  
--- 130,133 ----
***************
*** 120,125 ****
  
      bool active;
!     uint16_t OsdRefreshCounter;
!     // should be setted to null everytime OSD is shown
      // (software alpha blending mode).
  
--- 135,140 ----
  
      bool active;
!     volatile uint16_t OsdRefreshCounter;
!     // should be set to 0 everytime OSD is shown
      // (software alpha blending mode).
  
***************
*** 161,166 ****
      // activates fallback mode if the osd was not updated for a too long
      // time
- 
-     virtual void SetOldPicture(sPicBuffer *pic);
  
      uint8_t *PixelMask;
--- 176,179 ----



From nobody at sheep.berlios.de  Fri Sep 22 21:28:36 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 22 Sep 2006 21:28:36 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.246, 1.247 video.c, 1.65,
	1.66 video.h, 1.42, 1.43
Message-ID: <20060922192836.5A64382C7D@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16840

Modified Files:
	CHANGELOG video.c video.h 
Log Message:
fix possible lost picture update and dropped areaMutex.

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.246
retrieving revision 1.247
diff -C2 -d -r1.246 -r1.247
*** CHANGELOG	22 Sep 2006 04:19:58 -0000	1.246
--- CHANGELOG	22 Sep 2006 19:28:04 -0000	1.247
***************
*** 1,5 ****
  Changelog
  2006-09-22:
!    - protect locking for old picture by a separate mutex
  2006-09-21:
     - introduce a mutex to protect calls to videoOut from SoftOsd
--- 1,6 ----
  Changelog
  2006-09-22:
!    - protect locking for old picture by a separate mutex.
!    - fix possible lost picture update and dropped areaMutex.
  2006-09-21:
     - introduce a mutex to protect calls to videoOut from SoftOsd

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.65
retrieving revision 1.66
diff -C2 -d -r1.65 -r1.66
*** video.c	22 Sep 2006 04:19:58 -0000	1.65
--- video.c	22 Sep 2006 19:28:04 -0000	1.66
***************
*** 143,148 ****
  void cVideoOut::SetOldPicture(sPicBuffer *picture)
  {
-   oldPictureMutex.Lock();
- 
    if (oldPicture)
      UnlockBuffer(oldPicture);
--- 143,146 ----
***************
*** 152,157 ****
    } else
      oldPicture = NULL;
- 
-   oldPictureMutex.Unlock();
  }
  
--- 150,153 ----
***************
*** 444,448 ****
                                  sPicBuffer *pic)
  {
!   areaMutex. Lock();
    OsdRefreshCounter=0;
    Osd_changed=0;
--- 440,445 ----
                                  sPicBuffer *pic)
  {
!   oldPictureMutex.Lock();
! 
    OsdRefreshCounter=0;
    Osd_changed=0;
***************
*** 452,458 ****
    // display picture
    YUV(pic);
-   areaMutex. Unlock();
- 
    SetOldPicture(pic);
    ProcessEvents();
  }
--- 449,455 ----
    // display picture
    YUV(pic);
    SetOldPicture(pic);
+ 
+   oldPictureMutex.Unlock();
    ProcessEvents();
  }
***************
*** 462,466 ****
  void cVideoOut::DrawStill_420pl(sPicBuffer *buf)
  {
!   areaMutex. Lock();
    OsdRefreshCounter=0;
    Osd_changed=0;
--- 459,464 ----
  void cVideoOut::DrawStill_420pl(sPicBuffer *buf)
  {
!   oldPictureMutex.Lock();
! 
    OsdRefreshCounter=0;
    Osd_changed=0;
***************
*** 469,473 ****
    // display picture
    YUV (buf);
!   areaMutex. Unlock();
  
    ProcessEvents();
--- 467,471 ----
    // display picture
    YUV (buf);
!   oldPictureMutex.Unlock();
  
    ProcessEvents();

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** video.h	22 Sep 2006 04:19:58 -0000	1.42
--- video.h	22 Sep 2006 19:28:04 -0000	1.43
***************
*** 97,102 ****
      // mutiple output buffers (double, triple buffering).
      //
!     cMutex  osdMutex,
!             areaMutex;
      bool    OSDpresent,
              OSDpseudo_alpha;
--- 97,101 ----
      // mutiple output buffers (double, triple buffering).
      //
!     cMutex  osdMutex;
      bool    OSDpresent,
              OSDpseudo_alpha;



From nobody at sheep.berlios.de  Fri Sep 29 21:12:53 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 29 Sep 2006 21:12:53 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-shm.c,1.11,1.12
Message-ID: <20060929191253.374EE81D55@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5507

Modified Files:
	video-shm.c 
Log Message:
silence warnings

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-shm.c	18 Sep 2006 10:50:33 -0000	1.11
--- video-shm.c	29 Sep 2006 19:12:19 -0000	1.12
***************
*** 318,321 ****
--- 318,322 ----
  
  void cShmVideoOut::YUV(sPicBuffer *buf) {
+ #if 0	
          uint8_t *Py=buf->pixel[0]+(buf->edge_height)*buf->stride[0]
                  +buf->edge_width;
***************
*** 328,331 ****
--- 329,333 ----
          int Width=buf->width;
          int Height=buf->height;
+ #endif	
    
          if (!ctl->attached) {
***************
*** 347,352 ****
--- 349,356 ----
          };
        
+ #if 0	
          int width= ctl->max_width < Width ? ctl->max_width : Width;
          int height= ctl->max_height < Height ? ctl->max_height : Height;    
+ #endif	
          
          ctl->width=fwidth;



From nobody at sheep.berlios.de  Fri Sep 29 21:17:52 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 29 Sep 2006 21:17:52 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-xv.c,1.62,1.63
Message-ID: <20060929191752.A83E84F858@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6016

Modified Files:
	video-xv.c 
Log Message:
removed osdMutex

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.62
retrieving revision 1.63
diff -C2 -d -r1.62 -r1.63
*** video-xv.c	18 Sep 2006 10:14:01 -0000	1.62
--- video-xv.c	29 Sep 2006 19:17:18 -0000	1.63
***************
*** 1564,1578 ****
  {
    cVideoOut::CloseOSD();
-   osdMutex.Lock();
- #if VDRVERSNUM < 10307
-   for (int i = 0; i < MAXNUMWINDOWS; i++)
-   {
-     if (layer[i])
-     {
-       delete(layer[i]);
-       layer[i]=0;
-     }
-   }
- #endif
    if (videoInitialized)
    {
--- 1564,1567 ----
***************
*** 1584,1588 ****
      pthread_mutex_unlock(&xv_mutex);
    }
-   osdMutex.Unlock();
  }
  
--- 1573,1576 ----



From nobody at sheep.berlios.de  Fri Sep 29 21:25:31 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 29 Sep 2006 21:25:31 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.247, 1.248 video.c, 1.66,
	1.67 video.h, 1.43, 1.44 video-dfb.c, 1.71, 1.72 video-dfb.h,
	1.22, 1.23
Message-ID: <20060929192531.A867A828C5@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6653

Modified Files:
	CHANGELOG video.c video.h video-dfb.c video-dfb.h 
Log Message:
removed osdMutex
clear non video area when OSD is active to avoid fade effects


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.247
retrieving revision 1.248
diff -C2 -d -r1.247 -r1.248
*** CHANGELOG	22 Sep 2006 19:28:04 -0000	1.247
--- CHANGELOG	29 Sep 2006 19:24:57 -0000	1.248
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2006-09-29:
+    - video-shm: silence warnings.
+    - video-xv: removed osdMutex.
+    - video-dfb: removed osdMutex.
+                 clear non video area when OSD is active to avoid fade effects.
  2006-09-22:
     - protect locking for old picture by a separate mutex.

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.66
retrieving revision 1.67
diff -C2 -d -r1.66 -r1.67
*** video.c	22 Sep 2006 19:28:04 -0000	1.66
--- video.c	29 Sep 2006 19:24:57 -0000	1.67
***************
*** 106,110 ****
      if (
          OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
!         (current_osdMode == OSDMODE_SOFTWARE &&
           OsdRefreshCounter>5 && Osd_changed))
      {
--- 106,110 ----
      if (
          OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
!         (IsSoftOSDMode() &&
           OsdRefreshCounter>5 && Osd_changed))
      {
***************
*** 477,482 ****
  {
    OSDDEB("ClearOSD\n");
-   osdMutex.Lock();
- 
    OSDpresent=false; // will automaticly be set to true on redraw ;-)
    if (OsdPy)
--- 477,480 ----
***************
*** 491,496 ****
      memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
    Osd_changed=1;
  
!  osdMutex.Unlock();
  }
  
--- 489,499 ----
      memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
    Osd_changed=1;
+ }
  
! /* ---------------------------------------------------------------------------
!  */
! bool cVideoOut::IsSoftOSDMode()
! {
!   return current_osdMode == OSDMODE_SOFTWARE;
  }
  
***************
*** 504,511 ****
  void cVideoOut::CloseOSD()
  {
-   osdMutex.Lock();
    ClearOSD();
    OSDpresent=false;
-   osdMutex.Unlock();
    OSDDEB("CloseOSD\n");
  }
--- 507,512 ----

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** video.h	22 Sep 2006 19:28:04 -0000	1.43
--- video.h	29 Sep 2006 19:24:57 -0000	1.44
***************
*** 80,84 ****
      // when there is osd drawing activity in case of no video currently
      // available. Access to this pointer must be protected by corresponding
!     // mutex: oldPictureMutex .
      //
      sPicBuffer  *oldPicture;
--- 80,86 ----
      // when there is osd drawing activity in case of no video currently
      // available. Access to this pointer must be protected by corresponding
!     // mutex: oldPictureMutex . This includes changeing the contens e.g.
!     // when a decoded picture will be displayed and thus will be the reference
!     // for future operation on oldPicture.
      //
      sPicBuffer  *oldPicture;
***************
*** 90,101 ****
      { return aspect_F;};
  
! protected:
      // -----------------------------------------------------------------------
!     // State changes of OSD like on / off transitions, must be proteced by
!     // osdMutex. This are changes of variable OSDpresent, as the output method
!     // may need to take some longer actions e.g clearing background for one or
!     // mutiple output buffers (double, triple buffering).
      //
      cMutex  osdMutex;
      bool    OSDpresent,
              OSDpseudo_alpha;
--- 92,102 ----
      { return aspect_F;};
  
! #if VDRVERSNUM < 10307
      // -----------------------------------------------------------------------
!     // Artefakt of vdr-1.2.x OSD create/delete locking
      //
      cMutex  osdMutex;
+ #endif
+ 
      bool    OSDpresent,
              OSDpseudo_alpha;
***************
*** 139,142 ****
--- 140,148 ----
  
      virtual void RecalculateAspect(void);
+ 
+     /* -----------------------------------------------------------------------
+      * To be used in video thread only: Action()
+      */
+     virtual bool IsSoftOSDMode();
  
  public:

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.71
retrieving revision 1.72
diff -C2 -d -r1.71 -r1.72
*** video-dfb.c	16 Sep 2006 09:30:19 -0000	1.71
--- video-dfb.c	29 Sep 2006 19:24:57 -0000	1.72
***************
*** 661,667 ****
      }
    }
- 
-   if (OsdRefreshCounter && (OsdRefreshCounter % 3) == 0)
-     ShowOSD();
  }
  
--- 661,664 ----
***************
*** 1073,1077 ****
    {
      dirtyLines=DirtyLines=new bool[Yres];
!     memset(dirtyLines,false,sizeof(dirtyLines));
  
      tmpOsdSurface = (useStretchBlit) ? osdSurface : scrSurface;
--- 1070,1074 ----
    {
      dirtyLines=DirtyLines=new bool[Yres];
!     memset(dirtyLines,false,sizeof(bool)*Yres);
  
      tmpOsdSurface = (useStretchBlit) ? osdSurface : scrSurface;
***************
*** 1138,1141 ****
--- 1135,1139 ----
    dirtyLines=NULL;
    tmpOsdSurface=NULL;
+   clearBackground = 0;
    cVideoOut::CommitUnlockOsdSurface();
  }
***************
*** 1204,1207 ****
--- 1202,1213 ----
  /* ---------------------------------------------------------------------------
   */
+ bool cDFBVideoOut::IsSoftOSDMode()
+ {
+   return cVideoOut::IsSoftOSDMode() ||
+          useStretchBlit;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cDFBVideoOut::CloseOSD()
  {
***************
*** 1211,1224 ****
      return;
  
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
- 
    try
    {
      if (useStretchBlit)
      {
-       osdMutex.Lock();
        OSDpresent  = false;
!       osdClrBack = true;
!       osdMutex.Unlock();
        tmpSurface->Clear(COLORKEY,clearAlpha); //clear and
      }
--- 1217,1228 ----
      return;
  
+   cVideoOut::CloseOSD();
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
    try
    {
      if (useStretchBlit)
      {
        OSDpresent  = false;
!       clearBackground = clearBackCount;
        tmpSurface->Clear(COLORKEY,clearAlpha); //clear and
      }
***************
*** 1244,1297 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::ShowOSD ()
  {
!   if (!videoInitialized)
!     return;
! 
!   if (useStretchBlit && (OSDpresent || osdClrBack)) {
!     // do image and OSD mix here
!       DFBRectangle  src, dst, osdsrc;
  
!     src.x = sxoff;
!     src.y = syoff;
!     src.w = swidth;
!     src.h = sheight;
!     dst.x = lxoff;
!     dst.y = lyoff;
!     dst.w = lwidth;
!     dst.h = lheight;
  
!     osdMutex.Lock();
!     if (osdClrBack) {
!       clearBackground = clearBackCount;
!       osdClrBack = false;
      }
  
!     try
!     {
!       if (clearBackground) {
!         scrSurface->Clear(0,0,0,0);
!         clearBackground--;
!       }
! 
!       scrSurface->SetBlittingFlags(DSBLIT_NOFX);
!       scrSurface->StretchBlit(videoSurface, &src, &dst);
!       if (OSDpresent)
!       {
!         osdsrc.x = osdsrc.y = 0;
!         osdsrc.w = Xres;osdsrc.h=Yres;
!         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
!         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
!       }
!       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
! 
!     }
!     catch (DFBException *ex)
!     {
!       fprintf (stderr,"[dfb] ShowOSD: action=%s, result=%s\n",
!                ex->GetAction(), ex->GetResult());
!       delete ex;
      }
-     osdMutex.Unlock();
    }
  }
--- 1248,1280 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::ClearBorders()
  {
!   /* ---------------------------------------------------------------------
!    * clear parts of screen when OSD is present and which are not
!    * covered by video. This avoids fading effects when 16:9 video
!    * is shown on 4:3 screen (top & bottom) or when 4:3 video is shown
!    * on 16:9 screen (left & right).
!    */
!   if (OSDpresent || clearBackground > 0) {
!     scrSurface->SetColor(0,0,0,0);
  
!     if (clearBackground > 0)
!       clearBackground--;
  
!     /* -------------------------------------------------------------------
!      * clear top & bottom black bar area
!      */
!     if (lyoff) {
!       scrSurface->FillRectangle(0,0,            dwidth,lyoff);
!       scrSurface->FillRectangle(0,lyoff+lheight,dwidth,lyoff);
      }
  
!     /* -------------------------------------------------------------------
!      * clear left & right black bar area
!      */
!     if (lxoff) {
!       scrSurface->FillRectangle(0,0,           lxoff,dheight);
!       scrSurface->FillRectangle(lxoff+lwidth,0,lxoff,dheight);
      }
    }
  }
***************
*** 1301,1318 ****
  void cDFBVideoOut::YUV(sPicBuffer *buf)
  {
!   uint8_t *dst;
!   int pitch;
!   int hi;
!   uint8_t *Py=buf->pixel[0]
!                 +(buf->edge_height)*buf->stride[0]
!                 +buf->edge_width;
!   uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
!                 +buf->edge_width/2;
!   uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
!                 +buf->edge_width/2;
!   int Ystride=buf->stride[0];
!   int UVstride=buf->stride[1];
!   int Width=buf->width;
!   int Height=buf->height;
  
    if (!videoInitialized)
--- 1284,1306 ----
  void cDFBVideoOut::YUV(sPicBuffer *buf)
  {
!   DFBSurfaceFlipFlags   flipFlags;
!   IDirectFBSurface      *flipSurface;
! 
!   uint8_t               *dst;
!   int                   pitch;
!   int                   hi;
!   uint8_t               *Py = buf->pixel[0] +
!                               (buf->edge_height)*buf->stride[0] +
!                               buf->edge_width;
!   uint8_t               *Pu = buf->pixel[1] +
!                               (buf->edge_height/2)*buf->stride[1] +
!                               buf->edge_width/2;
!   uint8_t               *Pv = buf->pixel[2] +
!                               (buf->edge_height/2)*buf->stride[2] +
!                               buf->edge_width/2;
!   int                   Ystride  = buf->stride[0];
!   int                   UVstride = buf->stride[1];
!   int                   Width    = buf->width;
!   int                   Height   = buf->height;
  
    if (!videoInitialized)
***************
*** 1321,1324 ****
--- 1309,1315 ----
    SetParams();
  
+   flipSurface = videoSurface;
+   flipFlags = (setupStore->tripleBuffering) ? DSFLIP_NONE : DSFLIP_ONSYNC;
+ 
    //fprintf(stderr,"[dfb] draw frame (%d x %d) Y: %d UV: %d\n", Width, Height, Ystride, UVstride);
    try
***************
*** 1437,1487 ****
        //fprintf (stderr, "dst (%d,%d %dx%d)\n", lxoff,lyoff,lwidth,lheight);
  
!       osdMutex.Lock();
!       clearBackground = (aspect_changed || osdClrBack) ? clearBackCount: clearBackground;
!       osdClrBack = false;
! 
!       if (clearBackground)
!       {
!         scrSurface->Clear(0,0,0,0);
!         clearBackground--;
!       }
! 
!       osdMutex.Unlock();
! 
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
  
!       if (OSDpresent)
!       {
!           DFBRectangle  osdsrc;
!         osdsrc.x = osdsrc.y = 0;
!         osdsrc.w = Xres;osdsrc.h=Yres;
          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
! #if 0
!         /* --------------------------------------------------------------------
!          * test for OSD scaleinf to 4:3 aspect on a 16:9 tv
!          */
!           DFBRectangle  osddest;
!         osddest.x = 90; osddest.y = 0;
!         osddest.w = 540; osddest.h = Yres;
!         scrSurface->StretchBlit(osdSurface, &osdsrc, &osddest);
! #else
!         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
! #endif
! 
        }
!       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
!       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
!     }
!     else
!     {
!       if (setupStore->tripleBuffering)
!         videoSurface->Flip(/*NULL, DSFLIP_ONSYNC*/);
!       else
!         videoSurface->Flip(NULL, DSFLIP_ONSYNC);
      }
    }
!   catch (DFBException *ex)
!   {
      fprintf (stderr, "[dfb] YUV: action=%s, result=%s\n",
               ex->GetAction(), ex->GetResult());
--- 1428,1449 ----
        //fprintf (stderr, "dst (%d,%d %dx%d)\n", lxoff,lyoff,lwidth,lheight);
  
!       clearBackground = (aspect_changed) ? clearBackCount: clearBackground;
!       ClearBorders ();
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
  
!       if (OSDpresent) {
          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
!         scrSurface->Blit(osdSurface, NULL, 0, 0);
        }
! 
!       flipFlags = DSFLIP_WAITFORSYNC;
!       flipSurface = scrSurface;
      }
+ 
+     flipSurface->Flip (NULL, flipFlags);
+ 
    }
!   catch (DFBException *ex) {
      fprintf (stderr, "[dfb] YUV: action=%s, result=%s\n",
               ex->GetAction(), ex->GetResult());

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** video-dfb.h	17 Jun 2006 16:27:35 -0000	1.22
--- video-dfb.h	29 Sep 2006 19:24:57 -0000	1.23
***************
*** 56,59 ****
--- 56,65 ----
      bool SetupCle266Buffers(int, int);
  #endif // HAVE_CLE266_MPEG_DECODER
+ 
+     void ClearBorders();
+ 
+   protected:
+     virtual bool IsSoftOSDMode();
+ 
    public:
      IDirectFB	*dfb;
***************
*** 61,65 ****
      virtual ~cDFBVideoOut();
      void ProcessEvents ();
-     void ShowOSD ();
      void GetDisplayFrameTime();
  
--- 67,70 ----



