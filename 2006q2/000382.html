<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Softdevice-cvs] softdevice CHANGELOG,1.199,1.200 Makefile,1.30,1.31 PicBuffer.c,1.4,1.5 PicBuffer.h,1.1,1.2 configure,1.16,1.17 mpeg2decoder.c,1.65,1.66 mpeg2decoder.h,1.37,1.38 setup-softdevice.c,1.43,1.44 setup-softdevice.h,1.30,1.31 softdevice.c,1.60,1.61 video-dfb.c,1.64,1.65 video-dfb.h,1.21,1.22
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/softdevice-cvs/2006q2/index.html" >
   <LINK REL="made" HREF="mailto:softdevice-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSoftdevice-cvs%5D%20softdevice%20CHANGELOG%2C1.199%2C1.200%20Makefile%2C1.30%2C1.31%20PicBuffer.c%2C1.4%2C1.5%20PicBuffer.h%2C1.1%2C1.2%20configure%2C1.16%2C1.17%20mpeg2decoder.c%2C1.65%2C1.66%20mpeg2decoder.h%2C1.37%2C1.38%20setup-softdevice.c%2C1.43%2C1.44%20setup-softdevice.h%2C1.30%2C1.31%20softdevice.c%2C1.60%2C1.61%20video-dfb.c%2C1.64%2C1.65%20video-dfb.h%2C1.21%2C1.22&In-Reply-To=%3C200606171627.k5HGRcb20481%40bat.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000381.html">
   <LINK REL="Next"  HREF="000383.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Softdevice-cvs] softdevice CHANGELOG,1.199,1.200 Makefile,1.30,1.31 PicBuffer.c,1.4,1.5 PicBuffer.h,1.1,1.2 configure,1.16,1.17 mpeg2decoder.c,1.65,1.66 mpeg2decoder.h,1.37,1.38 setup-softdevice.c,1.43,1.44 setup-softdevice.h,1.30,1.31 softdevice.c,1.60,1.61 video-dfb.c,1.64,1.65 video-dfb.h,1.21,1.22</H1>
    <B>lucke</B> 
    <A HREF="mailto:softdevice-cvs%40lists.berlios.de?Subject=Re%3A%20%5BSoftdevice-cvs%5D%20softdevice%20CHANGELOG%2C1.199%2C1.200%20Makefile%2C1.30%2C1.31%20PicBuffer.c%2C1.4%2C1.5%20PicBuffer.h%2C1.1%2C1.2%20configure%2C1.16%2C1.17%20mpeg2decoder.c%2C1.65%2C1.66%20mpeg2decoder.h%2C1.37%2C1.38%20setup-softdevice.c%2C1.43%2C1.44%20setup-softdevice.h%2C1.30%2C1.31%20softdevice.c%2C1.60%2C1.61%20video-dfb.c%2C1.64%2C1.65%20video-dfb.h%2C1.21%2C1.22&In-Reply-To=%3C200606171627.k5HGRcb20481%40bat.berlios.de%3E"
       TITLE="[Softdevice-cvs] softdevice CHANGELOG,1.199,1.200 Makefile,1.30,1.31 PicBuffer.c,1.4,1.5 PicBuffer.h,1.1,1.2 configure,1.16,1.17 mpeg2decoder.c,1.65,1.66 mpeg2decoder.h,1.37,1.38 setup-softdevice.c,1.43,1.44 setup-softdevice.h,1.30,1.31 softdevice.c,1.60,1.61 video-dfb.c,1.64,1.65 video-dfb.h,1.21,1.22">nobody at sheep.berlios.de
       </A><BR>
    <I>Sat Jun 17 18:27:38 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000381.html">[Softdevice-cvs] softdevice CHANGELOG,1.198,1.199
</A></li>
        <LI>Next message: <A HREF="000383.html">[Softdevice-cvs] softdevice configure,1.17,1.18
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#382">[ date ]</a>
              <a href="thread.html#382">[ thread ]</a>
              <a href="subject.html#382">[ subject ]</a>
              <a href="author.html#382">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7558

Modified Files:
	CHANGELOG Makefile PicBuffer.c PicBuffer.h configure 
	mpeg2decoder.c mpeg2decoder.h setup-softdevice.c 
	setup-softdevice.h softdevice.c video-dfb.c video-dfb.h 
Log Message:
cle266, video-dfb: added HW-decoder support

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.199
retrieving revision 1.200
diff -C2 -d -r1.199 -r1.200
*** CHANGELOG	17 Jun 2006 13:43:54 -0000	1.199
--- CHANGELOG	17 Jun 2006 16:27:34 -0000	1.200
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-06-17:
+    - cle266, video-dfb: added HW-decoder support
  2006-06-16:
     - video-dfb: fix via aspect ratio handling

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** Makefile	9 Jun 2006 16:45:13 -0000	1.30
--- Makefile	17 Jun 2006 16:27:34 -0000	1.31
***************
*** 149,152 ****
--- 149,158 ----
  endif
  
+ ifdef CLE266_SUPPORT
+   CLE266_LIBS = -L/usr/local/lib -lcle266mpegdec
+   CLE266_CFLAGS = -I/usr/local/include
+   DEFINES  += -DHAVE_CLE266_MPEG_DECODER
+ endif
+ 
  ifdef XV_SUPPORT
    XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
***************
*** 230,239 ****
      DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += lib$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
!     LIBS     += $(DFB_LIBS)
    endif
!   INCLUDES += $(DFB_CFLAGS)
  endif
  
--- 236,247 ----
      DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
+     LIBS     += $(CLE266_LIBS)
+     DFB_LIBS += $(CLE266_LIBS)
      TARGETS  += lib$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
!     LIBS     += $(DFB_LIBS) $(CLE266_LIBS)
    endif
!   INCLUDES += $(DFB_CFLAGS) $(CLE266_CFLAGS)
  endif
  

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** PicBuffer.c	30 May 2006 18:57:21 -0000	1.4
--- PicBuffer.c	17 Jun 2006 16:27:34 -0000	1.5
***************
*** 38,41 ****
--- 38,42 ----
  };   
  
+ /*----------------------------------------------------------------------*/
  cPicBufferManager::cPicBufferManager() {
    lastPicNum=0;
***************
*** 48,51 ****
--- 49,63 ----
  };
  
+ int cPicBufferManager::GetBufNum(sPicBuffer *buf) {  
+         if ( !buf || buf-&gt;owner!=this )
+                 return -1;
+ 
+         int buf_num=0;
+         while ( buf != &amp;PicBuffer[buf_num]  &amp;&amp; buf_num &lt; LAST_PICBUF )
+                 buf_num++;
+ 
+         return (buf_num &lt; LAST_PICBUF ? buf_num : -1);
+ };
+ 
  void cPicBufferManager::ReleasePicBuffer(int buf_num) {
          PICDEB(&quot;ReleasePicBuffer %d\n&quot;,buf_num);
***************
*** 245,248 ****
--- 257,262 ----
  // end of code based on ffmpeg
  
+ 
+ /*------------------------------------------------------------------------*/
  void CopyPicBuf(sPicBuffer *dst, sPicBuffer *src,
                  int width, int height,
***************
*** 284,287 ****
--- 298,302 ----
  };
  
+ /*------------------------------------------------------------------------*/
  void CopyPicBufAlphaBlend(sPicBuffer *dst, sPicBuffer *src,
                  uint8_t *OsdPy,

Index: PicBuffer.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** PicBuffer.h	27 May 2006 19:12:41 -0000	1.1
--- PicBuffer.h	17 Jun 2006 16:27:34 -0000	1.2
***************
*** 27,35 ****
      uint8_t *pixel[4];
      int stride[4];
!     unsigned int use_count;
      int buf_num;
      int max_width; // maximal size of the picture edge + picture
      int max_height;
      
      int edge_width; // size of edges (needed by some ffmpeg codecs)
      int edge_height;
--- 27,37 ----
      uint8_t *pixel[4];
      int stride[4];
!     unsigned int use_count; // count the users of this buffer
      int buf_num;
      int max_width; // maximal size of the picture edge + picture
      int max_height;
+     cPicBufferManager *owner;
      
+     // picture context
      int edge_width; // size of edges (needed by some ffmpeg codecs)
      int edge_height;
***************
*** 41,49 ****
      bool interlaced_frame;
      int pict_type;
-    
-     cPicBufferManager *owner;
   
!     int pic_num;
!     int age;
      void *priv_data;
  };
--- 43,49 ----
      bool interlaced_frame;
      int pict_type;
   
!     int pic_num; // to calculate the age
!     int age; // needed by ffmpeg
      void *priv_data;
  };
***************
*** 54,61 ****
  class cPicBufferManager {
  public:
-         cPicBufferManager();
- 
-         virtual ~cPicBufferManager();
-       
          int lastPicNum;
  #define LAST_PICBUF 10
--- 54,57 ----
***************
*** 63,71 ****
--- 59,84 ----
          cMutex PicBufMutex;
  
+         cPicBufferManager();
+ 
+         virtual ~cPicBufferManager();
+ 
+         inline sPicBuffer *PicBuf(unsigned int buf_num)
+         { return ( buf_num&lt;LAST_PICBUF ? &amp;PicBuffer[buf_num] : NULL); };
+         // returns the address of the buffer buf_num
+         
+         int GetBufNum(sPicBuffer *PicBuf);
+         // returns the buffer number of the picture buffer PicBuf
+         // returns -1 if the buffer has not been found
+  
          sPicBuffer *GetBuffer(PixelFormat pix_fmt,int width, int height);
+         // get a picture buffer ( to be called from decoders of filters )
          void ReleaseBuffer(sPicBuffer *pic);
+         // release it again ( after use )
  
          void LockBuffer(sPicBuffer *picture);
+         // I want to keep this buffer ( not requested by me via GetBuffer() ) 
+         // longer
          void UnlockBuffer(sPicBuffer *picture);
+         // don't need it anymore
          
          int GetFormatBPP(PixelFormat fmt);
***************
*** 73,80 ****
                  int &amp;hChromaShift,
                  int &amp;vChromaShift);
!         virtual void ReleasePicBuffer(int buf_num);
          virtual void AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                          int w, int h);
! 
  };
  
--- 86,98 ----
                  int &amp;hChromaShift,
                  int &amp;vChromaShift);
! 
          virtual void AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                          int w, int h);
!         // actually allocates memory for the buffer. Can be overloaded for 
!         // direct rendering. 
!         // Has to set up max_width/max_height and format!
!         
!         virtual void ReleasePicBuffer(int buf_num);
!         // releases the memory of the buffer again
  };
  

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** configure	15 Jun 2006 21:27:08 -0000	1.16
--- configure	17 Jun 2006 16:27:34 -0000	1.17
***************
*** 36,39 ****
--- 36,40 ----
  with_mmx=&quot;yes&quot;
  with_mmx2=&quot;yes&quot;
+ cle266=&quot;yes&quot;
  
  function help () {
***************
*** 114,119 ****
  pkg-config --libs libpostproc &gt;&gt; config.log 2&gt;&amp;1 &amp;&amp; { ffmpeg_l1=&quot;$ffmpeg_l1 libpostproc&quot;;libpostproc=&quot;yes&quot;; }
  
! ffmpeg_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --libs $ffmpeg_l1 2&gt;&gt; config.log` || ffmpeg=&quot;no&quot;
! ffmpeg_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --cflags $ffmpeg_l1 2&gt;&gt; config.log`
  
  # test if it works..
--- 115,120 ----
  pkg-config --libs libpostproc &gt;&gt; config.log 2&gt;&amp;1 &amp;&amp; { ffmpeg_l1=&quot;$ffmpeg_l1 libpostproc&quot;;libpostproc=&quot;yes&quot;; }
  
! ffmpeg_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs $ffmpeg_l1 2&gt;&gt; config.log` || ffmpeg=&quot;no&quot;
! ffmpeg_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags $ffmpeg_l1 2&gt;&gt; config.log`
  
  # test if it works..
***************
*** 155,164 ****
  if test &quot;${dfb}&quot; = &quot;yes&quot; ; then
  
! dfb_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --cflags directfb dfb++ ` || dfb=&quot;no&quot;
  #dfb_cflags=`pkg-config --cflags directfb dfb++ 2&gt;&gt; config.log` || dfb=&quot;no&quot;
  
  if test &quot;${dfb}&quot; = &quot;yes&quot; ; then
  
! dfb_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --libs directfb dfb++`
  dfb_opts=&quot;${dfb_cflags} ${dfb_libs}&quot;
  dfb_device_desc=&quot;yes&quot;
--- 156,165 ----
  if test &quot;${dfb}&quot; = &quot;yes&quot; ; then
  
! dfb_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags directfb dfb++ 2&gt;&gt; config.log`|| dfb=&quot;no&quot;
  #dfb_cflags=`pkg-config --cflags directfb dfb++ 2&gt;&gt; config.log` || dfb=&quot;no&quot;
  
  if test &quot;${dfb}&quot; = &quot;yes&quot; ; then
  
! dfb_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs directfb dfb++ 2&gt;&gt; config.log`
  dfb_opts=&quot;${dfb_cflags} ${dfb_libs}&quot;
  dfb_device_desc=&quot;yes&quot;
***************
*** 267,270 ****
--- 268,292 ----
  
  #########################################################
+ # cle266mpegdec: check if present
+ #
+ if test &quot;${dfb}&quot; = &quot;yes&quot; ; then
+ echo -n &quot;Checking for cle266mpegdec... &quot;
+ cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags cle266mpegdec 2&gt;&gt;config.log` || cle266=&quot;no&quot;
+   if test &quot;${cle266}&quot; = &quot;yes&quot; ; then
+   cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs cle266mpegdec`
+   cle266_opts=&quot;${cle266_cflags} ${cle266_libs}&quot;
+   fi
+ 
+   if test &quot;${cle266}&quot; = &quot;yes&quot; ; then
+   echo &quot;Enabled cle266 hardware decoding.&quot;
+   else
+   echo &quot;Not found.&quot;
+ 
+ fi
+ else
+   cle266=&quot;no&quot;
+ fi
+ 
+ #########################################################
  # X11: check if X11 is present
  #
***************
*** 424,427 ****
--- 446,457 ----
      echo &quot;#define HAVE_DSBLIT_INTERLACED          0&quot; &gt;&gt; $TMPH
    fi
+ fi
+ 
+ ###############################################################################
+ # generating DirectFB specific defines
+ #
+ if test &quot;${cle266}&quot; = &quot;yes&quot; ; then
+   echo &quot;CLE266_LIBS = ${cle266_libs}&quot; &gt;&gt; $TMPM
+   echo &quot;CLE266_CFLAGS = -DHAVE_CLE266_MPEG_DECODER ${cle266_cflags}&quot; &gt;&gt; $TMPM
  fi
  

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.65
retrieving revision 1.66
diff -C2 -d -r1.65 -r1.66
*** mpeg2decoder.c	15 Jun 2006 21:34:20 -0000	1.65
--- mpeg2decoder.c	17 Jun 2006 16:27:34 -0000	1.66
***************
*** 17,20 ****
--- 17,23 ----
  #include &quot;setup-softdevice.h&quot;
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ #include &lt;cle266mpegdec.h&gt;
+ #endif // HAVE_CLE266_MPEG_DECODER
  
  //#define MPGDEB(out...) {printf(&quot;mpegdec[%04d]:&quot;,(int)(getTimeMilis() % 10000));printf(out);}
***************
*** 718,721 ****
--- 721,726 ----
  #if LIBAVCODEC_BUILD &gt; 4684
    pic-&gt;interlaced_frame=picture-&gt;interlaced_frame;
+ #else
+   pic-&gt;interlaced_frame=true;
  #endif
    pic-&gt;width=context-&gt;width;
***************
*** 752,755 ****
--- 757,805 ----
  };
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
+ 
+ int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&amp;pic, 
+                 int &amp;got_picture,uint8_t *data, int length, int64_t pkt_pts) {
+   int cle266CurrentFB;
+   got_picture=0;
+   pic = NULL;
+ 
+   /* Do HW decode!
+    * Hopefully sets len to number of bytes decoded!
+    * Returns number of buffer containing decoded frame
+    */
+   cle266CurrentFB = CLE266MPEGDecodeData(data, &amp;length, &amp;pkt_pts);
+ 
+   if ( cle266CurrentFB == -1 ) 
+     // no new picture
+     return length;
+ 
+   got_picture = 1;
+   pic = videoOut-&gt;PicBuf(cle266CurrentFB);
+   if ( pic == NULL ) {
+     fprintf(stderr,&quot;No picture buffer returned from cle266! %d\n&quot;,
+         cle266CurrentFB);
+     fflush(stderr);
+     got_picture = 0;
+     return length;
+   };
+ 
+   cle266_decoder_state_t decoder = CLE266MPEGGetDecoderState();
+   /* Fill up the necessary AVCodecContext information */
+   pic-&gt;width = decoder.width;
+   pic-&gt;height = decoder.height;
+   pic-&gt;pts = pkt_pts;
+   pic-&gt;edge_width=pic-&gt;edge_height=0;
+   pic-&gt;dtg_active_format = 0; // currently not parsed
+   pic-&gt;interlaced_frame = true; // FIXME Do we have that information?
+   pic-&gt;aspect_ratio = ( decoder.aspect_ratio_info &gt;= 0 
+     &amp;&amp; decoder.aspect_ratio_info &lt; 5 ) ?
+     aspect_ratio_values[decoder.aspect_ratio_info] : 1.0;
+ 
+   return length;
+ }
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
  int cVideoStreamDecoder::DecodePacket(AVPacket *pkt)
  {
***************
*** 764,769 ****
      BUFDEB(&quot;start decode video stream %d data: %p size: %d \n&quot;,
          pkt-&gt;stream_index,data,size);
!     len = DecodePicture_avcodec(pic, got_picture,
!                                 data, size, pkt-&gt;pts)
        //avcodec_decode_video(context, picture, &amp;got_picture,data, size);
      BUFDEB(&quot;end decode video got_picture %d, data %p, size %d\n&quot;,
--- 814,825 ----
      BUFDEB(&quot;start decode video stream %d data: %p size: %d \n&quot;,
          pkt-&gt;stream_index,data,size);
! #ifdef HAVE_CLE266_MPEG_DECODER
!     if (setupStore.cle266HWdecode &amp;&amp; context-&gt;codec_id == CODEC_ID_MPEG2VIDEO)
!             len = DecodePicture_cle266(pic, got_picture,
!                                 data, size, pkt-&gt;pts);
!     else
! #endif //HAVE_CLE266_MPEG_DECODER
!             len = DecodePicture_avcodec(pic, got_picture,
!                                 data, size, pkt-&gt;pts);
        //avcodec_decode_video(context, picture, &amp;got_picture,data, size);
      BUFDEB(&quot;end decode video got_picture %d, data %p, size %d\n&quot;,

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** mpeg2decoder.h	27 May 2006 19:12:41 -0000	1.37
--- mpeg2decoder.h	17 Jun 2006 16:27:35 -0000	1.38
***************
*** 253,256 ****
--- 253,260 ----
      int DecodePicture_avcodec(sPicBuffer *&amp;pic, int &amp;got_picture,
                                uint8_t *data, int length, int64_t pts);
+ #ifdef HAVE_CLE266_MPEG_DECODER
+     int DecodePicture_cle266(sPicBuffer *&amp;pic, int &amp;got_picture,
+                               uint8_t *data, int length, int64_t pts);
+ #endif //HAVE_CLE266_MPEG_DECODER
      virtual void      Freeze(bool freeze=true);
      virtual void      Play(void);

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** setup-softdevice.c	23 May 2006 21:11:37 -0000	1.43
--- setup-softdevice.c	17 Jun 2006 16:27:35 -0000	1.44
***************
*** 110,113 ****
--- 110,114 ----
    useMGAtv      = 0;
    viaTv         = 0;
+   cle266HWdecode  = 0;
    tripleBuffering = 0;
    useStretchBlit  = 0;

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** setup-softdevice.h	23 May 2006 21:11:37 -0000	1.30
--- setup-softdevice.h	17 Jun 2006 16:27:35 -0000	1.31
***************
*** 149,152 ****
--- 149,153 ----
      int   useMGAtv;
      int   viaTv;
+     int   cle266HWdecode;
      int   tripleBuffering;
      int   useStretchBlit;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.60
retrieving revision 1.61
diff -C2 -d -r1.60 -r1.61
*** softdevice.c	9 Jun 2006 16:45:13 -0000	1.60
--- softdevice.c	17 Jun 2006 16:27:35 -0000	1.61
***************
*** 705,708 ****
--- 705,711 ----
    &quot;  -vo dfb:mgatv                   output via MATROX TV-out\n&quot;
    &quot;  -vo dfb:viatv                   output via Unichrome TV-out\n&quot;
+ #ifdef HAVE_CLE266_MPEG_DECODER
+   &quot;  -vo dfb:cle266                  output via CLE266 accelerated decoding\n&quot;
+ #endif
    &quot;  -vo dfb:triple                  enables triple buffering on back end scaler\n&quot;
  #endif
***************
*** 801,812 ****
  #ifdef DFB_SUPPORT
            voutMethod = VOUT_DFB;
!           if (!strncmp (vo_argv, &quot;mgatv&quot;, 5))
!             setupStore.useMGAtv = 1;
!           else if (!strncmp (vo_argv, &quot;viatv&quot;, 5)) {
!             setupStore.viaTv = 1;
!             fprintf(stderr,&quot;[softdevice] enabling field parity\n&quot;);
!           } else if (!strncmp (vo_argv, &quot;triple&quot;, 6)) {
!             setupStore.tripleBuffering = 1;
!             fprintf(stderr,&quot;[softdevice] enabling triple buffering\n&quot;);
            }
  #else
--- 804,829 ----
  #ifdef DFB_SUPPORT
            voutMethod = VOUT_DFB;
!           while (strlen(vo_argv) &gt; 1) {
!             if (*vo_argv == ':')
!                ++vo_argv;
! 
!             if (!strncmp (vo_argv, &quot;mgatv&quot;, 5)) {
!               setupStore.useMGAtv = 1;
!               vo_argv += 5;
!             } else if (!strncmp (vo_argv, &quot;viatv&quot;, 5)) {
!               setupStore.viaTv = 1;
!               fprintf(stderr,&quot;[softdevice] enabling field parity\n&quot;);
!               vo_argv += 5;
! #ifdef HAVE_CLE266_MPEG_DECODER
!             } else if (!strncmp (vo_argv, &quot;cle266&quot;, 6)) {
!               setupStore.cle266HWdecode = 1;
!               vo_argv += 6;
!               fprintf(stderr,&quot;[softdevice] enabling CLE266 HW decoding\n&quot;);
! #endif // HAVE_CLE266_MPEG_DECODER
!             } else if (!strncmp (vo_argv, &quot;triple&quot;, 6)) {
!               setupStore.tripleBuffering = 1;
!               vo_argv += 6;
!               fprintf(stderr,&quot;[softdevice] enabling triple buffering\n&quot;);
!             }
            }
  #else

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.64
retrieving revision 1.65
diff -C2 -d -r1.64 -r1.65
*** video-dfb.c	16 Jun 2006 18:46:11 -0000	1.64
--- video-dfb.c	17 Jun 2006 16:27:35 -0000	1.65
***************
*** 15,19 ****
  #include &quot;setup-softdevice.h&quot;
  
- 
  #ifdef HAVE_CONFIG
  # include &quot;config.h&quot;
--- 15,18 ----
***************
*** 35,38 ****
--- 34,41 ----
  #endif
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ #include &lt;cle266mpegdec.h&gt;
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
  //#define COLORKEY 17,8,79
  #define COLORKEY 0,0,0
***************
*** 48,51 ****
--- 51,58 ----
       }
  
+ #define OLD_VERSION_01  1
+ #define OLD_VERSION_02  1
+ #define OLD_VERSION_03  1
+ 
  typedef struct
  {
***************
*** 361,364 ****
--- 368,386 ----
        isVIAUnichrome = true;
        clearAlpha = 0xff;
+ #ifdef HAVE_CLE266_MPEG_DECODER
+       if (setupStore-&gt;cle266HWdecode) {
+           if (!SetupCle266Buffers(swidth, sheight)) {
+               fprintf(stderr, &quot;Error allocating hardware buffers for CLE266 decoding: reverting to software decoding\n&quot;);
+               setupStore-&gt;cle266HWdecode = false;
+           } else {
+               // Need YV12 pixel format for blitting from harware buffer
+               // I420 == 0, YV12 == 1, YUY2 == 2
+               //currentPixelFormat = setupStore-&gt;pixelFormat = 0;
+               currentPixelFormat = setupStore-&gt;pixelFormat = 1;
+               setupStore-&gt;useStretchBlit = 0;
+               useStretchBlit = false;
+           }
+       }
+ #endif // HAVE_CLE266_MPEG_DECODER
  
        ReportLayerInfo(osdLayer, &quot;osdLayer&quot;);
***************
*** 475,479 ****
--- 497,505 ----
          videoLayer-&gt;SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
+ #if OLD_VERSION_01
          if (!setupStore-&gt;viaTv)
+ #else
+         if (!isVIAUnichrome)
+ #endif
            BESColorkeyState(videoLayer, true);
        }
***************
*** 502,506 ****
      }
  
!     GetDisplayFrameTime();
      /* create an event buffer with all devices attached */
      events = dfb-&gt;CreateInputEventBuffer(DICAPS_ALL,
--- 528,537 ----
      }
  
! #if OLD_VERSION_02
!     ;
! #else
!     if (setupStore-&gt;useMGAtv)
! #endif
!       GetDisplayFrameTime();
      /* create an event buffer with all devices attached */
      events = dfb-&gt;CreateInputEventBuffer(DICAPS_ALL,
***************
*** 1312,1397 ****
    try
    {
!     videoSurface-&gt;Lock(DSLF_WRITE, (void **)&amp;dst, &amp;pitch);
!     if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
!     {
  #if HAVE_SetSourceLocation
!       Py += Ystride  * cutTop * 2 + cutLeft * 2;
!       Pv += UVstride * cutTop + cutLeft;
!       Pu += UVstride * cutTop + cutLeft;
  
!       dst += pitch * cutTop * 2;
  
!       for(hi=cutTop*2; hi &lt; Height-cutBottom*2; hi++){
!         fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
!         Py  += Ystride;
!         dst += pitch;
!       }
  
!       dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi &lt; Height/2-cutBottom; hi++) {
!         fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
!         Pu  += UVstride;
!         dst += pitch / 2;
!       }
  
!       dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi &lt; Height/2-cutBottom; hi++) {
!         fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
!         Pv  += UVstride;
!         dst += pitch / 2;
!       }
  #else
!       Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
!       Pv += (UVstride * syoff/2) + UVstride * cutTop;
!       Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!       dst += pitch * cutTop * 2;
  
!       for(hi=cutTop*2; hi &lt; sheight-cutBottom*2; hi++){
!         fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
!         Py  += Ystride;
!         dst += pitch;
!       }
  
!       dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi &lt; sheight/2-cutBottom; hi++) {
!         fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!         Pu  += UVstride;
!         dst += pitch / 2;
!       }
  
!       dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi &lt; sheight/2-cutBottom; hi++) {
!         fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!         Pv  += UVstride;
!         dst += pitch / 2;
!       }
  #endif
!     } else if (pixelformat == DSPF_YUY2) {
  
!       if (interlaceMode) {
!         yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                              Pu + UVstride * cutTop + cutLeft,
!                              Pv + UVstride * cutTop + cutLeft,
!                              dst + pitch * cutTop * 2 + cutLeft * 4,
!                              Width - 2 * (cutLeft + cutRight),
!                              Height - 2 * (cutTop + cutBottom),
!                              Ystride, UVstride, pitch);
!       } else {
!         yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                              Pu + UVstride * cutTop + cutLeft,
!                              Pv + UVstride * cutTop + cutLeft,
!                              dst + pitch * cutTop * 2 + cutLeft * 4,
!                              Width - 2 * (cutLeft + cutRight),
!                              Height - 2 * (cutTop + cutBottom),
!                              Ystride, UVstride, pitch);
        }
!      }
  
!     videoSurface-&gt;Unlock();
  
      if (useStretchBlit)
--- 1343,1443 ----
    try
    {
! #ifdef HAVE_CLE266_MPEG_DECODER
!     int currentFB = -1;
!     if (setupStore-&gt;cle266HWdecode) {
!       // check if we use internal buffers
!       currentFB=GetBufNum(buf);
!     }
! 
!     if (setupStore-&gt;cle266HWdecode &amp;&amp; currentFB &lt; 4 &amp;&amp; currentFB &gt;= 0) {
!       // we use an internal buffer and CLE266 HW decoding
!       videoSurface-&gt;Blit(mpegfb[currentFB], NULL, 0, 0);
!     } else {
! #endif // HAVE_CLE266_MPEG_DECODER
!       videoSurface-&gt;Lock(DSLF_WRITE, (void **)&amp;dst, &amp;pitch);
!       if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
!       {
  #if HAVE_SetSourceLocation
!         Py += Ystride  * cutTop * 2 + cutLeft * 2;
!         Pv += UVstride * cutTop + cutLeft;
!         Pu += UVstride * cutTop + cutLeft;
  
!         dst += pitch * cutTop * 2;
  
!         for(hi=cutTop*2; hi &lt; Height-cutBottom*2; hi++){
!           fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
!           Py  += Ystride;
!           dst += pitch;
!         }
  
!         dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi &lt; Height/2-cutBottom; hi++) {
!           fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
!           Pu  += UVstride;
!           dst += pitch / 2;
!         }
  
!         dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi &lt; Height/2-cutBottom; hi++) {
!           fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
!           Pv  += UVstride;
!           dst += pitch / 2;
!         }
  #else
!         Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
!         Pv += (UVstride * syoff/2) + UVstride * cutTop;
!         Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!         dst += pitch * cutTop * 2;
  
!         for(hi=cutTop*2; hi &lt; sheight-cutBottom*2; hi++){
!           fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
!           Py  += Ystride;
!           dst += pitch;
!         }
  
!         dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi &lt; sheight/2-cutBottom; hi++) {
!           fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!           Pu  += UVstride;
!           dst += pitch / 2;
!         }
  
!         dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi &lt; sheight/2-cutBottom; hi++) {
!           fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!           Pv  += UVstride;
!           dst += pitch / 2;
!         }
  #endif
!       } else if (pixelformat == DSPF_YUY2) {
  
!         if (interlaceMode) {
!           yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                dst + pitch * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, pitch);
!         } else {
!           yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                dst + pitch * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, pitch);
!         }
        }
!       videoSurface-&gt;Unlock();
  
! #ifdef HAVE_CLE266_MPEG_DECODER
!     }
! #endif // HAVE_CLE266_MPEG_DECODER
  
      if (useStretchBlit)
***************
*** 1455,1460 ****
  
        }
!       //scrSurface-&gt;Flip(NULL, (setupStore-&gt;useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
        scrSurface-&gt;Flip(NULL, DSFLIP_WAITFORSYNC);
  
      }
--- 1501,1509 ----
  
        }
! #if OLD_VERSION_03
        scrSurface-&gt;Flip(NULL, DSFLIP_WAITFORSYNC);
+ #else
+       scrSurface-&gt;Flip(NULL, (setupStore-&gt;useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+ #endif
  
      }
***************
*** 1475,1478 ****
--- 1524,1615 ----
  }
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ 
+ bool cDFBVideoOut::SetupCle266Buffers(int width, int height)
+ {
+   DFBSurfaceDescription dsc;
+   int *buf;
+   int y_offset, u_offset, v_offset, i;
+   int mpegfb_stride;
+ 
+   fprintf(stderr, &quot;Initialising CLE266 decoder:&quot;);
+   if (!CLE266MPEGInitialise(FBDEV)) {
+       fprintf(stderr, &quot;failed!\n&quot;);
+       return false;
+   } else {
+       fprintf(stderr, &quot;success!\n&quot;);
+   }
+ 
+   dsc.flags = (DFBSurfaceDescriptionFlags)(DSDESC_WIDTH |
+                 DSDESC_HEIGHT |
+                 DSDESC_PIXELFORMAT |
+                 DSDESC_CAPS);
+   dsc.caps = DSCAPS_VIDEOONLY;
+   //dsc.pixelformat = DSPF_I420;
+   dsc.pixelformat = DSPF_YV12;
+   dsc.width = width;
+   dsc.height = height;
+ 
+ /* Create the 4 MPEG buffers for decoding */
+   fprintf(stderr, &quot;CLE266: Creating buffers for decoder\n&quot;);
+   for (int j=0; j &lt; LAST_PICBUF; j++)
+           mpegfb[j]=NULL;
+ 
+   try {
+     for (i = 0; i &lt; 4; i++) {
+       fprintf(stderr, &quot;CLE266: Creating buffer number %i\n&quot;, i);
+       mpegfb[i] = dfb-&gt;CreateSurface(dsc);
+ 
+       mpegfb[i]-&gt;Clear(0,0,0,0);
+       mpegfb[i]-&gt;Lock(DSLF_WRITE, (void**) &amp;buf, &amp;mpegfb_stride);
+       mpegfb[i]-&gt;GetFramebufferOffset(&amp;mpegfb_ofs[i]);
+ 
+       if ( PicBuffer[i].use_count&gt;0 ||
+            PicBuffer[i].max_width&gt;0 || PicBuffer[i].max_height&gt;0) {
+               esyslog(&quot;Fatal error setting up CLE266 buffers!&quot;);
+               fprintf(stderr,&quot;Fatal error setting up CLE266 buffers!\n&quot;);
+               exit(-1);
+       };
+ 
+       // at this point I know that the buffer is not already allocated
+       PicBuffer[i].pixel[0] = (uint8_t*) buf;
+       PicBuffer[i].pixel[2] = (uint8_t*) buf + height * mpegfb_stride;
+       PicBuffer[i].pixel[1] = (uint8_t*) PicBuffer[i].pixel[2]
+                                          +(height&gt;&gt;1)*(mpegfb_stride&gt;&gt;1);
+       PicBuffer[i].stride[0] = mpegfb_stride;
+       PicBuffer[i].stride[1] = PicBuffer[i].stride[2] = mpegfb_stride&gt;&gt;1;
+       PicBuffer[i].format = PIX_FMT_YUV420P;
+       PicBuffer[i].owner = this;
+       PicBuffer[i].max_width = width;
+       PicBuffer[i].max_height = height;
+       PicBuffer[i].use_count = 2; // should never be freed!!!
+     }
+   }
+   catch (DFBException *ex)
+   {
+     fprintf(stderr, &quot;CLE266: Error creating buffer: action=%s, result=%s\n&quot;,
+                   ex-&gt;GetAction(), ex-&gt;GetResult());
+     delete ex;
+     return false;
+   }
+ 
+   /* Pass info to the decoder...*/
+   fprintf(stderr, &quot;CLE266: passing mpegfb_stride\n&quot;);
+   CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride &gt;&gt; 1 );
+ 
+   height = (height + 15) &amp; ~15;
+   width  = (width  + 15) &amp; ~15;
+ 
+   fprintf(stderr, &quot;CLE266: passing buffers to decoder\n&quot;);
+   for (i = 0; i &lt; 4; i++) {
+     y_offset = mpegfb_ofs[i];
+     v_offset = y_offset + (mpegfb_stride * height);
+     u_offset = v_offset + (mpegfb_stride &gt;&gt; 1) * (height &gt;&gt; 1);
+     CLE266MPEGSetFrameBuffer(i,y_offset,v_offset,u_offset);
+   }
+   return true;
+ }
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 1488,1491 ****
--- 1625,1641 ----
    if (videoLayer)   videoLayer-&gt;Release ();
    if (osdLayer)     osdLayer-&gt;Release();
+ 
+ #ifdef HAVE_CLE266_MPEG_DECODER
+   if (setupStore-&gt;cle266HWdecode) {
+     CLE266MPEGClose();
+     for (int i = 0; i &lt; 4; ++i) {
+       if (mpegfb[i]) {
+         mpegfb[i]-&gt;Unlock();
+         mpegfb[i]-&gt;Release();
+       }
+     }
+   }
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
    if (dfb)          dfb-&gt;Release();
  }

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** video-dfb.h	27 May 2006 19:12:41 -0000	1.21
--- video-dfb.h	17 Jun 2006 16:27:35 -0000	1.22
***************
*** 51,54 ****
--- 51,59 ----
      void EnableFieldParity(IDirectFBDisplayLayer *layer);
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+     IDirectFBSurface* mpegfb[LAST_PICBUF];
+     int               mpegfb_ofs[4];
+     bool SetupCle266Buffers(int, int);
+ #endif // HAVE_CLE266_MPEG_DECODER
    public:
      IDirectFB	*dfb;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000381.html">[Softdevice-cvs] softdevice CHANGELOG,1.198,1.199
</A></li>
	<LI>Next message: <A HREF="000383.html">[Softdevice-cvs] softdevice configure,1.17,1.18
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#382">[ date ]</a>
              <a href="thread.html#382">[ thread ]</a>
              <a href="subject.html#382">[ subject ]</a>
              <a href="author.html#382">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/softdevice-cvs">More information about the Softdevice-cvs
mailing list</a><br>
</body></html>
