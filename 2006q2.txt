From nobody at sheep.berlios.de  Sat Apr  1 10:26:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 1 Apr 2006 10:26:34 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.164,1.165 ShmClient.c,1.8,1.9 SoftOsd.h,1.5,1.6 shm-common.h,1.4,1.5
Message-ID: <200604010826.k318QYt23545@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27760

Modified Files:
	CHANGELOG ShmClient.c SoftOsd.h shm-common.h 
Log Message:
- apply slightly modified patch by Thomas G??nter which fixes improper
  includes of vdr header files



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.164
retrieving revision 1.165
diff -C2 -d -r1.164 -r1.165
*** CHANGELOG	31 Mar 2006 20:40:31 -0000	1.164
--- CHANGELOG	1 Apr 2006 08:26:55 -0000	1.165
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-04-01:
+    - apply slightly modified patch by Thomas G?nter which fixes improper
+      includes of vdr header files
  2006-03-31:
     - Xinerama support (detection and build requires to run configure).

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** ShmClient.c	21 Mar 2006 18:45:14 -0000	1.8
--- ShmClient.c	1 Apr 2006 08:26:56 -0000	1.9
***************
*** 14,18 ****
  #include "video-xv.h"
  #include "shm-common.h"
- #include "vdr/keys.h"
  #include "utils.h"
  
--- 14,17 ----

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** SoftOsd.h	18 Feb 2006 22:20:29 -0000	1.5
--- SoftOsd.h	1 Apr 2006 08:26:56 -0000	1.6
***************
*** 25,34 ****
  #define IS_OPAQUE(a) ((a) > OPACITY_THRESHOLD)
  
! #include "vdr/config.h"
  
  #if VDRVERSNUM >= 10307 // only for the new osd interface...
  
! #include "vdr/osd.h"
! #include "vdr/thread.h"
  #include "video.h"
  
--- 25,34 ----
  #define IS_OPAQUE(a) ((a) > OPACITY_THRESHOLD)
  
! #include <vdr/config.h>
  
  #if VDRVERSNUM >= 10307 // only for the new osd interface...
  
! #include <vdr/osd.h>
! #include <vdr/thread.h>
  #include "video.h"
  

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** shm-common.h	19 Feb 2006 16:58:35 -0000	1.4
--- shm-common.h	1 Apr 2006 08:26:56 -0000	1.5
***************
*** 18,22 ****
  #include <sys/sem.h> 
  
- #include "vdr/keys.h"
  
  #define CTL_KEY 5678 
--- 18,21 ----



From nobody at sheep.berlios.de  Sat Apr  1 10:45:12 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 1 Apr 2006 10:45:12 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.165,1.166 video-xv.c,1.48,1.49
Message-ID: <200604010845.k318jCt23957@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2674

Modified Files:
	CHANGELOG video-xv.c 
Log Message:
- fix compilation without Xinerama support 


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.165
retrieving revision 1.166
diff -C2 -d -r1.165 -r1.166
*** CHANGELOG	1 Apr 2006 08:26:55 -0000	1.165
--- CHANGELOG	1 Apr 2006 08:45:35 -0000	1.166
***************
*** 3,6 ****
--- 3,7 ----
     - apply slightly modified patch by Thomas G?nter which fixes improper
       includes of vdr header files
+    - fix compilation without Xinerama support
  2006-03-31:
     - Xinerama support (detection and build requires to run configure).

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** video-xv.c	31 Mar 2006 20:40:31 -0000	1.48
--- video-xv.c	1 Apr 2006 08:45:35 -0000	1.49
***************
*** 408,411 ****
--- 408,412 ----
      old_dheight = dheight;
  
+ #if XINERAMA_SUPPORT
      if (xin_mode)
      {
***************
*** 419,422 ****
--- 420,424 ----
      }
      else
+ #endif
      {
        x = y = 0;



From nobody at sheep.berlios.de  Sat Apr  1 11:33:17 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 1 Apr 2006 11:33:17 +0200
Subject: [Softdevice-cvs] softdevice Makefile,1.24,1.25 CHANGELOG,1.166,1.167 README,1.14,1.15
Message-ID: <200604010933.k319XHt25417@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2413

Modified Files:
	Makefile CHANGELOG README 
Log Message:
- applied Makefile patch from Antti Sepp?l?

PS: My new kde Kate seems to modify more than intended.
    Hopefully harmless.


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** Makefile	6 Feb 2006 19:59:34 -0000	1.24
--- Makefile	1 Apr 2006 09:33:41 -0000	1.25
***************
*** 26,34 ****
  LIBDIR     = ../../lib
  TMPDIR     = /tmp
  
  -include config.mak
  
  # uncomment to build the shared memory video server
! # 
  #SHM_SUPPORT = 1
  
--- 26,35 ----
  LIBDIR     = ../../lib
  TMPDIR     = /tmp
+ PLUGINLIBDIR = ./PLUGINS/lib
  
  -include config.mak
  
  # uncomment to build the shared memory video server
! #
  #SHM_SUPPORT = 1
  
***************
*** 210,214 ****
  
  DEFINES += -DPLUGIN_NAME_I18N='"$(PLUGIN)"' -D_GNU_SOURCE
! DEFINES += -DPLUGINLIBDIR='"./PLUGINS/lib"'
  
  ### The object files (add further files here):
--- 211,215 ----
  
  DEFINES += -DPLUGIN_NAME_I18N='"$(PLUGIN)"' -D_GNU_SOURCE
! DEFINES += -DPLUGINLIBDIR='"$(PLUGINLIBDIR)"'
  
  ### The object files (add further files here):
***************
*** 221,225 ****
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o 
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
--- 222,226 ----
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
***************
*** 234,238 ****
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o 
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
--- 235,239 ----
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
***************
*** 244,248 ****
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o 
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
--- 245,249 ----
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
***************
*** 255,259 ****
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o 
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
--- 256,260 ----
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
***************
*** 267,271 ****
  ifdef SHM_SUPPORT
    ifdef USE_SUBPLUGINS
!     SHM_OBJS  = utils.o video.o video-shm.o 
      ALL_OBJS    += $(SHM_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-shm.so
--- 268,272 ----
  ifdef SHM_SUPPORT
    ifdef USE_SUBPLUGINS
!     SHM_OBJS  = utils.o video.o video-shm.o
      ALL_OBJS    += $(SHM_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-shm.so
***************
*** 342,346 ****
  		      ../../../sources.o
  SHM_CLIENT_OBJS  = video.o video-xv.o setup-softdevice.o xscreensaver.o \
! 		   utils.o 
  
  ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)
--- 343,347 ----
  		      ../../../sources.o
  SHM_CLIENT_OBJS  = video.o video-xv.o setup-softdevice.o xscreensaver.o \
! 		   utils.o
  
  ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.166
retrieving revision 1.167
diff -C2 -d -r1.166 -r1.167
*** CHANGELOG	1 Apr 2006 08:45:35 -0000	1.166
--- CHANGELOG	1 Apr 2006 09:33:41 -0000	1.167
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-04-01:
+    - applied Makefile patch from Antti Sepp?l?
     - apply slightly modified patch by Thomas G?nter which fixes improper
       includes of vdr header files
***************
*** 7,11 ****
     - Xinerama support (detection and build requires to run configure).
     - reactivate use of source x/y offsets for Xv*PutImage(..) operations.
-    - date fix of Changelog
  2006-03-21:
     - remove the image copy overhead from the ShmClient
--- 8,11 ----
***************
*** 13,17 ****
     - support for non-shared memory xv
  2006-03-12:
!    - Fix StillPicture handling when no PES header is sent 
       (for example streamdev-server-plugin)
     - redraw video layer on OSD close in software mode
--- 13,17 ----
     - support for non-shared memory xv
  2006-03-12:
!    - Fix StillPicture handling when no PES header is sent
       (for example streamdev-server-plugin)
     - redraw video layer on OSD close in software mode
***************
*** 115,119 ****
      - packet playback: assume we get complete frames via packet interface.
                         This fixes playing divx via softplay.
!     - fix frame dropping with IEEE1394 read.                       
  2005-10-26:
      - fix cropmode handling via OSD
--- 115,119 ----
      - packet playback: assume we get complete frames via packet interface.
                         This fixes playing divx via softplay.
!     - fix frame dropping with IEEE1394 read.
  2005-10-26:
      - fix cropmode handling via OSD
***************
*** 155,159 ****
      - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)
  2005-08-19:
!     - change #ifdefs to contain closing brackets 
          (stops my editor from complaining...)
      - fix possible segfault in ToYUV()
--- 155,159 ----
      - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)
  2005-08-19:
!     - change #ifdefs to contain closing brackets
          (stops my editor from complaining...)
      - fix possible segfault in ToYUV()
***************
*** 168,172 ****
      - introduce SOFTDEB, more checks agains NULL dereferences
      - call decoder->Clear in Clear
!     - return NULL in getPPValue when compiled without postproc lib 
        (suggested by Antonio)
  2005-07-29:
--- 168,172 ----
      - introduce SOFTDEB, more checks agains NULL dereferences
      - call decoder->Clear in Clear
!     - return NULL in getPPValue when compiled without postproc lib
        (suggested by Antonio)
  2005-07-29:
***************
*** 234,238 ****
      - provide error message on stderr when Xv plugin cannot connect to X server.
  2005-06-12:
!     - no new audio frame has been decoded when audio_size <= 0 
         (reported by Antonio O.)
      - introduce fast_memcpy (gives 20-30% speed increase on copying)
--- 234,238 ----
      - provide error message on stderr when Xv plugin cannot connect to X server.
  2005-06-12:
!     - no new audio frame has been decoded when audio_size <= 0
         (reported by Antonio O.)
      - introduce fast_memcpy (gives 20-30% speed increase on copying)
***************
*** 250,254 ****
      - changed screen aspect ratio selection (based on suggestion by Nicolas Huillard)
      - fix some segfaults on bad signal
!     - fix possible segfault when called without arguments 
        (thanks to Marko M?kel?)
      - buffering is now complety signal triggered
--- 250,254 ----
      - changed screen aspect ratio selection (based on suggestion by Nicolas Huillard)
      - fix some segfaults on bad signal
!     - fix possible segfault when called without arguments
        (thanks to Marko M?kel?)
      - buffering is now complety signal triggered
***************
*** 260,264 ****
      - fix pplib deinterlacing
      - check libavcodec build of library against header
!     - some more error messages 
  2005-05-18:
      - fix for aspect ratio calculation if sample_aspect_ratio.num == 0
--- 260,264 ----
      - fix pplib deinterlacing
      - check libavcodec build of library against header
!     - some more error messages
  2005-05-18:
      - fix for aspect ratio calculation if sample_aspect_ratio.num == 0
***************
*** 297,301 ****
      - replace unneeded usleep<10000usec with >=10000usec
      - add SIG_TIMING option (default: disabled, enable in mpeg2decoder.c)
!     - introduce meaningful return values in packet mode. 
      - disable debugging output.
  2005-04-09:
--- 297,301 ----
      - replace unneeded usleep<10000usec with >=10000usec
      - add SIG_TIMING option (default: disabled, enable in mpeg2decoder.c)
!     - introduce meaningful return values in packet mode.
      - disable debugging output.
  2005-04-09:
***************
*** 346,350 ****
   2005-03-02:
      - increased osd fallback timeout
!     - removed syoff and sxoff from Draw(...) 
   2005-02-27:
      - save "vo" and "ao" calling args in setup store.
--- 346,350 ----
   2005-03-02:
      - increased osd fallback timeout
!     - removed syoff and sxoff from Draw(...)
   2005-02-27:
      - save "vo" and "ao" calling args in setup store.
***************
*** 373,377 ****
      - xv-out: fix compile warnings on amd64 (reported by Konrad Naumann)
   2005-01-23:
!     - added suspend video playback patch. 
   2005-01-15:
      - fix OSD drawing when multiple areas are used (with text2skin plugin)
--- 373,377 ----
      - xv-out: fix compile warnings on amd64 (reported by Konrad Naumann)
   2005-01-23:
!     - added suspend video playback patch.
   2005-01-15:
      - fix OSD drawing when multiple areas are used (with text2skin plugin)
***************
*** 414,418 ****
    2004-11-14:
     - new A-V sync with linux RTC support
!    - changed audio buffering 
     - implemented serveral missing cDevice methods:
       TrickSpeed(),Clear(),Freeze()...
--- 414,418 ----
    2004-11-14:
     - new A-V sync with linux RTC support
!    - changed audio buffering
     - implemented serveral missing cDevice methods:
       TrickSpeed(),Clear(),Freeze()...
***************
*** 422,426 ****
    2004-11-04: softdevice-0.0.7
     - audio-out: don't exit when we get EINTR upon write
!   2004-10-30: softdevice-0.0.7pre4 
    2004-10-29:
     - xv-out: changed fullscreen mode. works now with more wms (bug: #2265)
--- 422,426 ----
    2004-11-04: softdevice-0.0.7
     - audio-out: don't exit when we get EINTR upon write
!   2004-10-30: softdevice-0.0.7pre4
    2004-10-29:
     - xv-out: changed fullscreen mode. works now with more wms (bug: #2265)
***************
*** 510,514 ****
    2004-05-20 : softdevice-0.0.6pre2
      - xv output now works with vdr-1.3.7 too
!     
    2004-05-19 : softdevice-0.0.6pre1
      - audio.c: dropped round() call
--- 510,514 ----
    2004-05-20 : softdevice-0.0.6pre2
      - xv output now works with vdr-1.3.7 too
! 
    2004-05-19 : softdevice-0.0.6pre1
      - audio.c: dropped round() call

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** README	6 Feb 2006 20:32:00 -0000	1.14
--- README	1 Apr 2006 09:33:41 -0000	1.15
***************
*** 87,92 ****
  Set the PrimaryDVB value to the last device if you own a FF-Card.
  
! Note that we strongly recommend to use Xv, DirectFB or Vidix for output. 
! Framebuffer mode is not well maintained and  _completly_ unaccelerated. 
  
  
--- 87,92 ----
  Set the PrimaryDVB value to the last device if you own a FF-Card.
  
! Note that we strongly recommend to use Xv, DirectFB or Vidix for output.
! Framebuffer mode is not well maintained and  _completly_ unaccelerated.
  
  
***************
*** 143,146 ****
--- 143,147 ----
  Many thanks to:
  - Andre Neumann
+ - Antti Sepp?l?
  - Colin Paton
  - Herbert Attenberger
***************
*** 157,160 ****
--- 158,162 ----
  - Rolf Ahrenberg
  - Stefan Lucke
+ - Thomas G?nter
  - Torgeir Veimo
  - Vadim Catana



From nobody at sheep.berlios.de  Sun Apr  2 22:18:49 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 2 Apr 2006 22:18:49 +0200
Subject: [Softdevice-cvs] softplay PlayListMenu.c,1.3,1.4 FileIndex.c,1.1,1.2 softplay.c,1.10,1.11
Message-ID: <200604022018.k32KInt06114@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv32352

Modified Files:
	PlayListMenu.c FileIndex.c softplay.c 
Log Message:
- apply modified patch by C.Y.M. to fix compiler warnings 


Index: PlayListMenu.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayListMenu.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** PlayListMenu.c	12 Mar 2006 20:28:52 -0000	1.3
--- PlayListMenu.c	2 Apr 2006 20:19:12 -0000	1.4
***************
*** 241,245 ****
                          && !hold ) {
                  MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
!                                 playList->GetCurrIdx(),time(NULL),lastActivity);
                  SetCurrent(Get(playList->GetCurrIdx()));
                  Display();
--- 241,245 ----
                          && !hold ) {
                  MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
!                                 playList->GetCurrIdx(),int(time(NULL)),int(lastActivity));
                  SetCurrent(Get(playList->GetCurrIdx()));
                  Display();

Index: FileIndex.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/FileIndex.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** FileIndex.c	12 Mar 2006 20:23:23 -0000	1.1
--- FileIndex.c	2 Apr 2006 20:19:12 -0000	1.2
***************
*** 12,16 ****
  #include "FileIndex.h"
  
! #define INDEXDEB(out...) printf("INDEXDEB: " out)
  
  
--- 12,20 ----
  #include "FileIndex.h"
  
! //#define INDEXDEB(out...) printf("INDEXDEB: " out)
! 
! #ifndef INDEXDEB
! #define INDEXDEB(out...)
! #endif
  
  
***************
*** 95,105 ****
  	
  	skipSpaces(pos);
!         printf("duration '%s' \n",pos);
!         if ( !*pos || sscanf(pos,"%100[0-9]%n",&tmp,&len) == 0 ) {
                  printf("EXTINF Could not parse duration \"%s\". Ignoring.\n",pos);
                  return;
          };
          duration=atoi(tmp);
!         printf("duration parsed '%s'= %d\n",tmp,duration);
          pos=pos + len;
  
--- 99,109 ----
  	
  	skipSpaces(pos);
!         //INDEXDEB("duration '%s' \n",pos);
!         if ( !*pos || sscanf(pos,"%100[0-9]%n",tmp,&len) == 0 ) {
                  printf("EXTINF Could not parse duration \"%s\". Ignoring.\n",pos);
                  return;
          };
          duration=atoi(tmp);
!         //INDEXDEB("duration parsed '%s'= %d\n",tmp,duration);
          pos=pos + len;
  

Index: softplay.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** softplay.c	12 Mar 2006 20:28:52 -0000	1.10
--- softplay.c	2 Apr 2006 20:19:12 -0000	1.11
***************
*** 512,517 ****
          struct dirent **namelist;
          int n;
!         char Name[60];
!         char Title[60];
  
  
--- 512,517 ----
          struct dirent **namelist;
          int n;
!         //char Name[60];
!         //char Title[60];
  
  



From nobody at sheep.berlios.de  Fri Apr 14 17:45:19 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 14 Apr 2006 17:45:19 +0200
Subject: [Softdevice-cvs] softdevice utils.h,1.5,1.6 utils.c,1.10,1.11
Message-ID: <200604141545.k3EFjJt20903@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25629

Modified Files:
	utils.h utils.c 
Log Message:
yv12 to yuy2 converter for field based chroma

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** utils.h	15 Jul 2005 20:42:16 -0000	1.5
--- utils.h	14 Apr 2006 15:45:43 -0000	1.6
***************
*** 20,23 ****
--- 20,47 ----
  #endif
  
+ void yv12_to_yuy2_il_c(const uint8_t *py,
+                        const uint8_t *pu,
+                        const uint8_t *pv,
+                        uint8_t *dst,
+                        int width,int height,
+                        int lumStride,int chromStride,
+                        int dstStride);
+ 
+ void yv12_to_yuy2_fr_c(const uint8_t *py,
+                        const uint8_t *pu,
+                        const uint8_t *pv,
+                        uint8_t *dst,
+                        int width,int height,
+                        int lumStride,int chromStride,
+                        int dstStride);
+ 
+ void yv12_to_yuy2_fr_mmx2(const uint8_t *py,
+                           const uint8_t *pu,
+                           const uint8_t *pv,
+                           uint8_t *dst,
+                           int width,int height,
+                           int lumStride,int chromStride,
+                           int dstStride);
+ 
  void yv12_to_yuy2( const uint8_t *ysrc,
                     const uint8_t *usrc,

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** utils.c	7 Jan 2006 13:26:43 -0000	1.10
--- utils.c	14 Apr 2006 15:45:43 -0000	1.11
***************
*** 27,30 ****
--- 27,188 ----
  #endif
  
+ /* ---------------------------------------------------------------------------
+  * chroma: field based
+  * lang: C
+  */
+ void yv12_to_yuy2_il_c(const uint8_t *py,
+                        const uint8_t *pu, const uint8_t *pv,
+                        uint8_t *dst, int width, int height,
+                        int lumStride, int chromStride, int dstStride)
+ {
+     const unsigned  chromWidth = width >> 1;
+     uint32_t        *idst1, *idst2;
+     const uint8_t   *yc1, *yc2, *uc, *vc;
+ 
+   for(int y=0; y<height/4; y++)
+   {
+     /* -----------------------------------------------------------------------
+      * take chroma line x (it's from field A) for packing with
+      * luma lines x * 2 and x * 2 + 2
+      */
+     idst1 = (uint32_t *) (dst + 0 * dstStride);
+     idst2 = (uint32_t *) (dst + 2 * dstStride);
+     yc1 = py;
+     yc2 = py + 2 * lumStride;
+     uc = pu;
+     vc = pv;
+ 
+     for(unsigned i = 0; i < chromWidth; i++)
+     {
+       *idst1++ = (yc1[0] << 0)+ (uc[0] << 8) + (yc1[1] << 16) + (vc[0] << 24);
+       *idst2++ = (yc2[0] << 0)+ (uc[0] << 8) + (yc2[1] << 16) + (vc[0] << 24);
+       yc1 += 2;
+       yc2 += 2;
+       uc++;
+       vc++;
+     }
+ 
+     /* -----------------------------------------------------------------------
+      * take chroma line x+1 (it's from field B) for packing with
+      * luma lines x * 2 + 1 and x * 2 + 3
+      */
+     py += lumStride;
+     pu += chromStride;
+     pv += chromStride;
+ 
+     yc1 = py;
+     yc2 = py + 2 * lumStride;
+     uc = pu;
+     vc = pv;
+     idst1 = (uint32_t *) (dst + 1 * dstStride);
+     idst2 = (uint32_t *) (dst + 3 * dstStride);
+ 
+     for(unsigned i = 0; i < chromWidth; i++)
+     {
+       *idst1++ = (yc1[0] << 0)+ (uc[0] << 8) + (yc1[1] << 16) + (vc[0] << 24);
+       *idst2++ = (yc2[0] << 0)+ (uc[0] << 8) + (yc2[1] << 16) + (vc[0] << 24);
+       yc1 += 2;
+       yc2 += 2;
+       uc++;
+       vc++;
+     }
+ 
+     py += 3*lumStride;
+     pu += chromStride;
+     pv += chromStride;
+ 
+     dst  += 4 * dstStride;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  * chroma: frame based
+  * lang: C
+  */
+ void yv12_to_yuy2_fr_c(const uint8_t *ysrc,
+                        const uint8_t *usrc, const uint8_t *vsrc,
+                        uint8_t *dst, int width, int height,
+                        int lumStride, int chromStride, int dstStride)
+ {
+     const unsigned chromWidth = width >> 1;
+ 
+   for(int y=0; y<height; y++)
+   {
+       uint32_t *idst = (uint32_t *) dst;
+       const uint8_t *yc = ysrc, *uc = usrc, *vc = vsrc;
+ 
+     for(unsigned i = 0; i < chromWidth; i++)
+     {
+       *idst++ = (yc[0] << 0)+ (uc[0] << 8) + (yc[1] << 16) + (vc[0] << 24);
+       yc += 2;
+       uc++;
+       vc++;
+     }
+ 
+     if( (y&1) == 1)
+     {
+       usrc += chromStride;
+       vsrc += chromStride;
+     }
+ 
+     ysrc += lumStride;
+     dst  += dstStride;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  * chroma: frame based
+  * lang: MMX2
+  */
+ void yv12_to_yuy2_fr_mmx2(const uint8_t *ysrc,
+                           const uint8_t *usrc, const uint8_t *vsrc,
+                           uint8_t *dst, int width, int height,
+                           int lumStride, int chromStride, int dstStride)
+ {
+   for (int i=0; i<height; i++)
+   {
+       const uint8_t *pu, *pv, *py;
+       uint8_t  *srfc;
+ 
+     pu = usrc;
+     pv = vsrc;
+     py = ysrc;
+ 
+     srfc = dst;
+ 
+     for (int j =0; j < width/8; j++)
+     {
+       movd_m2r(*pu, mm1);       // mm1 = 00 00 00 00 U3 U2 U1 U0
+       movd_m2r(*pv, mm2);       // mm2 = 00 00 00 00 V3 V2 V1 V0
+       movq_m2r(*py, mm0);       // mm0 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
+       punpcklbw_r2r(mm2, mm1);  // mm1 = V3 U3 V2 U2 V1 U1 V0 U0
+       movq_r2r(mm0,mm3);        // mm3 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
+       movq_r2r(mm1,mm4);        // mm4 = V3 U3 V2 U2 V1 U1 V0 U0
+       punpcklbw_r2r(mm1, mm0);  // mm0 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
+       punpckhbw_r2r(mm4, mm3);  // mm3 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
+ 
+       movntq(mm0,*srfc);        // Am Meisten brauchen die Speicherzugriffe
+       srfc+=8;
+       py+=8;
+       pu+=4;
+       pv+=4;
+       movntq(mm3,*srfc);      // wenn movntq nicht geht, dann movq verwenden
+       srfc+=8;
+     }
+ 
+     ysrc += lumStride;;
+ 
+     if (i % 2 == 1)
+     {
+       usrc += chromStride;
+       vsrc += chromStride;
+     }
+ 
+     dst += dstStride;
+   }
+   __asm__ __volatile__ ("sfence \n"
+ 		        "emms \n" : : : "memory");
+ }
+ 
  void yv12_to_yuy2(const uint8_t *ysrc, const uint8_t *usrc, const uint8_t *vsrc,
                    uint8_t *dst, int width, int height,
***************
*** 219,223 ****
      psllq_i2r (3, mm7);
  
!     
      // jetzt muss ich die an bestimmten Stellen verdoppeln.
      movntq (mm0, *(image));
--- 377,381 ----
      psllq_i2r (3, mm7);
  
! 
      // jetzt muss ich die an bestimmten Stellen verdoppeln.
      movntq (mm0, *(image));
***************
*** 225,229 ****
      punpckhbw_r2r (mm1, mm5);
      por_r2r (mm7, mm5);
!     
      movntq (mm5, *(image+8));
      while(--lines) { // write the same in the line above
--- 383,387 ----
      punpckhbw_r2r (mm1, mm5);
      por_r2r (mm7, mm5);
! 
      movntq (mm5, *(image+8));
      while(--lines) { // write the same in the line above
***************
*** 268,279 ****
  
      psllq_i2r (3, mm7);
!     
      // jetzt muss ich die an bestimmten Stellen verdoppeln.
!     psrlq_i2r(1,mm0);//MW 
      movntq (mm0, *(image));
  
      punpckhbw_r2r (mm1, mm5);
      por_r2r (mm7, mm5);
!     
      psrlq_i2r(1,mm5); //MW
      movntq (mm5, *(image+8));
--- 426,437 ----
  
      psllq_i2r (3, mm7);
! 
      // jetzt muss ich die an bestimmten Stellen verdoppeln.
!     psrlq_i2r(1,mm0);//MW
      movntq (mm0, *(image));
  
      punpckhbw_r2r (mm1, mm5);
      por_r2r (mm7, mm5);
! 
      psrlq_i2r(1,mm5); //MW
      movntq (mm5, *(image+8));



From nobody at sheep.berlios.de  Fri Apr 14 17:55:53 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 14 Apr 2006 17:55:53 +0200
Subject: [Softdevice-cvs] softdevice video-xv.h,1.17,1.18 video-xv.c,1.49,1.50
Message-ID: <200604141555.k3EFtrt21259@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26336

Modified Files:
	video-xv.h video-xv.c 
Log Message:
some preparations for some more XvImage formats (not yet selectable)

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-xv.h	31 Mar 2006 19:21:32 -0000	1.17
--- video-xv.h	14 Apr 2006 15:56:17 -0000	1.18
***************
*** 40,43 ****
--- 40,44 ----
  
  #define FOURCC_YV12       0x32315659   /* 4:2:0 Planar: Y + V + U  (3 planes) */
+ #define FOURCC_I420       0x30323449   /* 4:2:0 Planar: Y + U + V  (3 planes) */
  #define FOURCC_YUY2       0x32595559   /* 4:2:2 Packed: Y0+U0+Y1+V0 (1 plane) */
  
***************
*** 155,158 ****
--- 156,160 ----
    int   GetScreenWidth(void),
          GetScreenHeight();
+   void  ClearXvArea(uint8_t y, uint8_t u, uint8_t v);
  
  public:

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** video-xv.c	1 Apr 2006 08:45:35 -0000	1.49
--- video-xv.c	14 Apr 2006 15:56:17 -0000	1.50
***************
*** 1023,1027 ****
                            osd_max_width, osd_max_height,
                            osd_image->bytes_per_line);
!   }; 
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
  
--- 1023,1027 ----
                            osd_max_width, osd_max_height,
                            osd_image->bytes_per_line);
!   };
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
  
***************
*** 1064,1068 ****
    dsyslog("[XvVideoOut]: initialized OK");
  
!   if (setupStore->xvFullscreen) 
    {
      toggleFullScreen();
--- 1064,1068 ----
    dsyslog("[XvVideoOut]: initialized OK");
  
!   if (setupStore->xvFullscreen)
    {
      toggleFullScreen();
***************
*** 1219,1234 ****
                    format,xvWidth, xvHeight);
  
!   pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
!   pixels[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
!   pixels[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
  
!   memset (pixels [0], 0, xvWidth*xvHeight);
!   memset (pixels [1], 128, xvWidth*xvHeight/4);
!   memset (pixels [2], 128, xvWidth*xvHeight/4);
  
    rc = PutXvImage();
- 
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
- 
    rc = XSync(dpy, False);
  
--- 1219,1241 ----
                    format,xvWidth, xvHeight);
  
!   switch (format) {
!     case FOURCC_YV12:
!     case FOURCC_I420:
!       pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
!       pixels[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
!       pixels[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
!       break;
!     case FOURCC_YUY2:
!       pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
!       break;
!     default:
!       break;
!   }
  
!   this->format = format;
  
+   ClearXvArea (0, 128, 128);
    rc = PutXvImage();
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
    rc = XSync(dpy, False);
  
***************
*** 1253,1257 ****
    pthread_mutex_unlock(&xv_mutex);
  
-   this->format = format;
    initialized = 1;
    xv_initialized = 1;
--- 1260,1263 ----
***************
*** 1259,1262 ****
--- 1265,1304 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
+ void cXvVideoOut::ClearXvArea(uint8_t y, uint8_t u, uint8_t v)
+ {
+     uint8_t   tu;
+     uint32_t  tyuy2, *pyuy2;
+ 
+   switch (format) {
+     case FOURCC_I420:
+       tu = u;
+       u = v;
+       v = tu;
+     case FOURCC_YV12:
+       memset (pixels [0], y, xvWidth*xvHeight);
+       memset (pixels [1], u, xvWidth*xvHeight/4);
+       memset (pixels [2], v, xvWidth*xvHeight/4);
+       break;
+     case FOURCC_YUY2:
+       tyuy2 = y + (u << 8) + (y << 16) + (v << 24);
+       pyuy2 = (uint32_t *) pixels[0];
+ 
+       for (int i = 0; i < xvWidth / 2; ++i)
+         *pyuy2++ = tyuy2;
+ 
+       for (int i = 1; i < xvHeight; ++i, pyuy2 += xvWidth / 2)
+         fast_memcpy(pyuy2, pixels[0], xvWidth*2);
+ 
+       break;
+     default:
+       break;
+   }
+ 
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cXvVideoOut::CreateXvImage(Display *dpy,XvPortID port,
                    XvImage *&xv_image,
***************
*** 1306,1310 ****
      if (shminfo. shmid > 0)
        shmctl (shminfo. shmid, IPC_RMID, 0);
!   }else 
    {
      xv_image = XvCreateImage(dpy, port,format, NULL,
--- 1348,1352 ----
      if (shminfo. shmid > 0)
        shmctl (shminfo. shmid, IPC_RMID, 0);
!   }else
    {
      xv_image = XvCreateImage(dpy, port,format, NULL,
***************
*** 1314,1318 ****
        exit(-1);
      };
!       
      xv_image->data = (char*)malloc(xv_image->data_size);
      if (!xv_image->data) {
--- 1356,1360 ----
        exit(-1);
      };
! 
      xv_image->data = (char*)malloc(xv_image->data_size);
      if (!xv_image->data) {
***************
*** 1336,1340 ****
                       lwidth, lheight,   /* dw, dh */
                       False);
!   else 
      return XvPutImage(dpy, port,
                       win, gc,
--- 1378,1382 ----
                       lwidth, lheight,   /* dw, dh */
                       False);
!   else
      return XvPutImage(dpy, port,
                       win, gc,
***************
*** 1364,1368 ****
    XvStopVideo(dpy, port, win);
    XvUngrabPort(dpy, port, CurrentTime);
!   
  
    if (xv_image->data) {
--- 1406,1410 ----
    XvStopVideo(dpy, port, win);
    XvUngrabPort(dpy, port, CurrentTime);
! 
  
    if (xv_image->data) {
***************
*** 1385,1389 ****
      xv_image = NULL;
    }
!   
    xv_initialized = 0;
  }
--- 1427,1431 ----
      xv_image = NULL;
    }
! 
    xv_initialized = 0;
  }
***************
*** 1482,1486 ****
          HasAlpha=false;
          PixelMask=NULL;
! };       
  
  /* ---------------------------------------------------------------------------
--- 1524,1528 ----
          HasAlpha=false;
          PixelMask=NULL;
! };
  
  /* ---------------------------------------------------------------------------
***************
*** 1521,1525 ****
  			    OsdWidth,OsdHeight,RefreshAll);
  	    break;
!  
      }
      pthread_mutex_lock(&xv_mutex);
--- 1563,1567 ----
  			    OsdWidth,OsdHeight,RefreshAll);
  	    break;
! 
      }
      pthread_mutex_lock(&xv_mutex);
***************
*** 1638,1644 ****
      cutLeft = setupStore->cropLeftCols;
      cutRight = setupStore->cropRightCols;
!     memset (pixels [0], 0, xvWidth*xvHeight);
!     memset (pixels [1], 128, xvWidth*xvHeight/4);
!     memset (pixels [2], 128, xvWidth*xvHeight/4);
    }
  
--- 1680,1684 ----
      cutLeft = setupStore->cropLeftCols;
      cutRight = setupStore->cropRightCols;
!     ClearXvArea (0, 128, 128);
    }
  
***************
*** 1682,1689 ****
  
    }
!   else
  #endif
!  {
  
            for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
               fast_memcpy(pixels [0] + i * xvWidth + 2 * cutLeft,
--- 1722,1732 ----
  
    }
!     else
  #endif
!     {
  
+       switch (format) {
+         case FOURCC_YV12:
+         case FOURCC_I420:
            for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
               fast_memcpy(pixels [0] + i * xvWidth + 2 * cutLeft,
***************
*** 1698,1702 ****
                            Pu + i * UVstride + cutLeft,
                            fwidth / 2 - (cutLeft + cutRight));
!   }
    }
    PutXvImage();
--- 1741,1757 ----
                            Pu + i * UVstride + cutLeft,
                            fwidth / 2 - (cutLeft + cutRight));
!           break;
!         case FOURCC_YUY2:
!           //yv12_to_yuy2_il_c(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!           yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                        Pu + UVstride * cutTop + cutLeft,
!                        Pv + UVstride * cutTop + cutLeft,
!                        pixels[0] + 2*xvWidth * cutTop * 2 + cutLeft * 4,
!                        Width - 2 * (cutLeft + cutRight),
!                        Height - 2 * (cutTop + cutBottom),
!                        Ystride, UVstride, 2*xvWidth);
!           break;
!       }
!     }
    }
    PutXvImage();
***************
*** 1712,1716 ****
      return;
  
!   if (xv_initialized) 
    {
      pthread_mutex_lock(&xv_mutex);
--- 1767,1771 ----
      return;
  
!   if (xv_initialized)
    {
      pthread_mutex_lock(&xv_mutex);



From nobody at sheep.berlios.de  Fri Apr 14 20:56:10 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 14 Apr 2006 20:56:10 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.167,1.168 README,1.15,1.16 i18n.c,1.17,1.18 setup-softdevice-menu.c,1.1,1.2 setup-softdevice.c,1.40,1.41 setup-softdevice.h,1.25,1.26 softdevice.c,1.54,1.55 video-dfb.c,1.51,1.52 video.c,1.47,1.48 video.h,1.31,1.32
Message-ID: <200604141856.k3EIuAt29110@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4817

Modified Files:
	CHANGELOG README i18n.c setup-softdevice-menu.c 
	setup-softdevice.c setup-softdevice.h softdevice.c video-dfb.c 
	video.c video.h 
Log Message:
Expand top/bottom line and left/right coloumns (from vdr-portal).
Zoom feature, zoomed area may be shifted around.
remember interlaced mode of current frame.
Restricted OSD alpha blend option to XV and VIDIX out.
started some documentation of our various OSD options.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.167
retrieving revision 1.168
diff -C2 -d -r1.167 -r1.168
*** CHANGELOG	1 Apr 2006 09:33:41 -0000	1.167
--- CHANGELOG	14 Apr 2006 18:56:34 -0000	1.168
***************
*** 1,3 ****
--- 1,11 ----
  Changelog
+ 2006-04-14:
+    - Expand top/bottom line and left/right coloumns (from vdr-portal).
+    - Zoom feature, zoomed area may be shifted around.
+    - yv12 -> yuy2 converter for field based chroma.
+    - remember interlaced mode of current frame.
+    - some preparations for some more XvImage formats (not yet selectable).
+    - Restricted OSD alpha blend option to XV and VIDIX out.
+    - started some documentation of our various OSD options.
  2006-04-01:
     - applied Makefile patch from Antti Sepp?l?

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** README	1 Apr 2006 09:33:41 -0000	1.15
--- README	14 Apr 2006 18:56:34 -0000	1.16
***************
*** 130,133 ****
--- 130,182 ----
  are not available.
  
+ OSD setup options:
+ ------------------
+   Cropping:
+   Post processing:
+   Video out:
+ 
+   XV startup aspect
+     Possible values: 4:3 normal, 16:9 wide
+ 
+   Screen aspect
+     Possible values: default, 5:4, 4:3, 16:9, 16:10
+ 
+   OSD alpha blending
+     Possible values: pseudo, software
+ 
+   Buffer mode
+     Possible values: safe, good seeking, HDTV
+ 
+   Playback
+     Possible values: playing, suspended
+ 
+   A/V Delay
+     Possible values: 0 .. 250
+ 
+   AC3 Mode
+     Possible values: Stereo (2CH), 5.1 S/P-DIF,
+                      5.1 Analog (4CH), 5.1 Analog (6CH)
+     This specifies what should be done when we get AC3 audio frames.
+     When set to 5.1 S/P-DIF no software decoding is used. AC3 frames
+     are passed directly from your sound card to your audio processing
+     equipment.
+     If you choose any of (xCH) modes, it depends on the capabilities of
+     the decoding libary for getting any output. We request a 2, 4 or 6
+     channel downmix of the AC3 data. If your libary (ffmpeg) does not
+     support downmixing, you'll get silence. In such a situation you'll
+     have to select an other audio track/channel of your selected source.
+ 
+   Sync Mode
+     Possible values: usleep, rtc, sig
+     The method for syncing video output to audio output is determined by
+     this option.
+ 
+   Hide main menu entry
+     Possible values: yes, no .
+     When set to yes, softdevice setup menu is not shown in vdr's main
+     menu. Softdevice developers usually set this to no, normal end user
+     tend to set this to yes. If softdevice setup menu is hidden, it is
+     still accessible via vdr -> setup -> plugins -> softdevice .
+ 
  Problems/todo:
  --------------

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** i18n.c	19 Feb 2006 10:38:30 -0000	1.17
--- i18n.c	14 Apr 2006 18:56:34 -0000	1.18
***************
*** 37,41 ****
      "",             //  3 TODO
      "",             //  4 TODO
!     "",             //  5 TODO   
      "",             //  6 TODO
      "Affichage vid?o sur carte graphique", //  7
--- 37,41 ----
      "",             //  3 TODO
      "",             //  4 TODO
!     "",             //  5 TODO
      "",             //  6 TODO
      "Affichage vid?o sur carte graphique", //  7
***************
*** 43,48 ****
      "Ohjelmistopohjainen n?ytt?laite",  //  9
      "",             // 10 TODO
!     "",             // 11 TODO   
!     "",             // 12 TODO   
      "",             // 13 TODO
      "",             // 14 TODO
--- 43,48 ----
      "Ohjelmistopohjainen n?ytt?laite",  //  9
      "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
      "",             // 13 TODO
      "",             // 14 TODO
***************
*** 53,57 ****
      "",             // 18 TODO
      "",             // 19 TODO
!     "",             // 20 TODO   
  #endif
    },
--- 53,57 ----
      "",             // 18 TODO
      "",             // 19 TODO
!     "",             // 20 TODO
  #endif
    },
***************
*** 349,353 ****
      "",             // 16 TODO
  #if VDRVERSNUM >= 10316
!     "",             // 17 TODO 
      "",             // 18 TODO
      "",             // 19 TODO
--- 349,353 ----
      "",             // 16 TODO
  #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
***************
*** 487,491 ****
      "",             // 16 TODO
  #if VDRVERSNUM >= 10316
!     "",             // 17 TODO   
      "",             // 18 TODO
      "",             // 19 TODO
--- 487,491 ----
      "",             // 16 TODO
  #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
***************
*** 867,871 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO                                                              
      "",             //  8 TODO
      "Kuvan j?lkik?sittely", //  9
--- 867,871 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Kuvan j?lkik?sittely", //  9
***************
*** 1008,1011 ****
--- 1008,1126 ----
      "",             //  8 TODO
      "V?rikyll?isyys",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Zoom factor",   //  1
+     "Zoomfaktor",    //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Zoom area shift (left/right)",   //  1
+     "Zoomausschnitt (links/rechts)",  //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Zoom area shift (up/down)",   //  1
+     "Zoomausschnitt (oben/unten)", //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Expand top/bottom lines",   //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Expand left/right columns",   //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",//  9
      "",             // 10 TODO
      "",             // 11 TODO

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** setup-softdevice-menu.c	17 Jan 2006 20:45:46 -0000	1.1
--- setup-softdevice-menu.c	14 Apr 2006 18:56:34 -0000	1.2
***************
*** 94,97 ****
--- 94,115 ----
                              userKeyUsage));
  
+ #if VDRVERSNUM >= 10334
+   Add(new cOsdItem(" ", osUnknown, false));
+ #else
+   Add(new cOsdItem(" ", osUnknown));
+ #endif
+   Add(new cMenuEditIntItem(tr("Zoom factor"),
+                            &data->zoomFactor,
+                            0,
+                            128));
+   Add(new cMenuEditIntItem(tr("Zoom area shift (left/right)"),
+                            &data->zoomCenterX,
+                            -100,
+                            100));
+   Add(new cMenuEditIntItem(tr("Zoom area shift (up/down)"),
+                            &data->zoomCenterY,
+                            -100,
+                            100));
+ 
    if (data->outputMethod != VOUT_FB)
    {
***************
*** 124,127 ****
--- 142,160 ----
                               MAX_CROP_COLS));
    }
+ 
+ #if VDRVERSNUM >= 10334
+   Add(new cOsdItem(" ", osUnknown, false));
+ #else
+   Add(new cOsdItem(" ", osUnknown));
+ #endif
+ 
+   Add(new cMenuEditIntItem(tr("Expand top/bottom lines"),
+                            &data->expandTopBottomLines,
+                            0,
+                            MAX_CROP_LINES/2));
+   Add(new cMenuEditIntItem(tr("Expand left/right columns"),
+                            &data->expandLeftRightCols,
+                            0,
+                            MAX_CROP_COLS/2));
  }
  
***************
*** 268,277 ****
                              videoAspectNames));
  
!   osdModeNames[0] = tr("pseudo");
!   osdModeNames[1] = tr("software");
!   Add(new cMenuEditStraItem(tr("OSD alpha blending"),
!                             &data->osdMode,
!                             (SETUP_OSDMODES-1),
!                             osdModeNames));
  
  #if VDRVERSNUM >= 10334
--- 301,313 ----
                              videoAspectNames));
  
!   if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_VIDIX)
!   {
!     osdModeNames[0] = tr("pseudo");
!     osdModeNames[1] = tr("software");
!     Add(new cMenuEditStraItem(tr("OSD alpha blending"),
!                               &data->osdMode,
!                               (SETUP_OSDMODES-1),
!                               osdModeNames));
!   }
  
  #if VDRVERSNUM >= 10334

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** setup-softdevice.c	17 Jan 2006 20:45:46 -0000	1.40
--- setup-softdevice.c	14 Apr 2006 18:56:34 -0000	1.41
***************
*** 24,28 ****
  #ifdef FB_SUPPORT
          "FB-intern", // no need to translate
! #endif        
  #ifdef PP_LIBAVCODEC
          "linblend",  // no need to translate
--- 24,28 ----
  #ifdef FB_SUPPORT
          "FB-intern", // no need to translate
! #endif
  #ifdef PP_LIBAVCODEC
          "linblend",  // no need to translate
***************
*** 100,103 ****
--- 100,105 ----
    cropLeftCols      = 0;
    cropRightCols     = 0;
+   expandTopBottomLines = 0;
+   expandLeftRightCols = 0;
    deintMethod   = 0;
    ppMethod   = 0;
***************
*** 122,125 ****
--- 124,131 ----
     */
    screenPixelAspect   = 0;
+   zoom                = 0;
+   zoomFactor          = 0;
+   zoomCenterX         = 0;
+   zoomCenterY         = 0;
  
    strcpy (alsaDevice, "");
***************
*** 219,226 ****
  #ifdef PP_LIBAVCODEC
    else if (!strcasecmp(Name,"Postprocess Method")) {
!             ppMethod=atoi(Value); 
              ppMethod=clamp(0,ppMethod,2);
    }  else if (!strcasecmp(Name,"Postprocess Quality")) {
!             ppQuality=atoi(Value); 
              ppQuality=clamp(0,ppQuality,6);
    }
--- 225,232 ----
  #ifdef PP_LIBAVCODEC
    else if (!strcasecmp(Name,"Postprocess Method")) {
!             ppMethod=atoi(Value);
              ppMethod=clamp(0,ppMethod,2);
    }  else if (!strcasecmp(Name,"Postprocess Quality")) {
!             ppQuality=atoi(Value);
              ppQuality=clamp(0,ppQuality,6);
    }
***************
*** 263,266 ****
--- 269,282 ----
      fprintf(stderr,"[setup-softdevice] Cropping %d columns from right\n",
              cropRightCols);
+   } else if(!strcasecmp(Name,"ExpandTopBottomLines")) {
+     expandTopBottomLines = atoi(Value);
+     expandTopBottomLines = clamp (0, expandTopBottomLines, MAX_CROP_LINES/2);
+     fprintf(stderr,"[setup-softdevice] Expanding %d columns at top and bottom\n",
+             expandTopBottomLines);
+   } else if(!strcasecmp(Name,"ExpandLeftRightCols")) {
+     expandLeftRightCols = atoi(Value);
+     expandLeftRightCols = clamp (0, expandLeftRightCols, MAX_CROP_COLS/2);
+     fprintf(stderr,"[setup-softdevice] Expanding %d columns at left and right\n",
+             expandLeftRightCols);
    } else if (!strcasecmp(Name,"PixelFormat")) {
      pixelFormat = atoi(Value);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** setup-softdevice.h	17 Jan 2006 20:45:46 -0000	1.25
--- setup-softdevice.h	14 Apr 2006 18:56:34 -0000	1.26
***************
*** 119,122 ****
--- 119,124 ----
      int   cropLeftCols;
      int   cropRightCols;
+     int   expandTopBottomLines;
+     int   expandLeftRightCols;
      int   deintMethod;
      int   ppMethod;
***************
*** 126,129 ****
--- 128,135 ----
      int   avOffset;
      int   screenPixelAspect;
+     int   zoom;
+     int   zoomFactor;
+     int   zoomCenterX;
+     int   zoomCenterY;
      int   useMGAtv;
      int   viaTv;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.54
retrieving revision 1.55
diff -C2 -d -r1.54 -r1.55
*** softdevice.c	12 Feb 2006 17:59:12 -0000	1.54
--- softdevice.c	14 Apr 2006 18:56:34 -0000	1.55
***************
*** 193,196 ****
--- 193,197 ----
  #ifdef XV_SUPPORT
          LoadSubPlugin ("xv", FOURCC_YV12, pluginPath);
+         //LoadSubPlugin ("xv", FOURCC_YUY2, pluginPath);
  #endif
          break;
***************
*** 229,232 ****
--- 230,234 ----
          videoOut = new cXvVideoOut (&setupStore);
          if (videoOut->Initialize () && videoOut->Reconfigure (FOURCC_YV12)) {
+         //if (videoOut->Initialize () && videoOut->Reconfigure (FOURCC_YUY2)) {
            fprintf (stderr, "[softdevice] Xv out OK !\n");
          } else {
***************
*** 363,367 ****
  }
  
! cSpuDecoder *cSoftDevice::GetSpuDecoder(void) 
  {
    //printf("GetSpuDecoder %x\n",spuDecoder);
--- 365,369 ----
  }
  
! cSpuDecoder *cSoftDevice::GetSpuDecoder(void)
  {
    //printf("GetSpuDecoder %x\n",spuDecoder);
***************
*** 399,403 ****
      if (!decoder)
         return false;
!     
      packetMode=PlayMode < 0;
      PlayMode=(ePlayMode) abs(PlayMode);
--- 401,405 ----
      if (!decoder)
         return false;
! 
      packetMode=PlayMode < 0;
      PlayMode=(ePlayMode) abs(PlayMode);
***************
*** 441,445 ****
      if ( ! decoder )
        return;
!       
      if ( !packetMode ) {
        cDevice::Clear();
--- 443,447 ----
      if ( ! decoder )
        return;
! 
      if ( !packetMode ) {
        cDevice::Clear();
***************
*** 494,503 ****
       cRelTimer Timer;
       Timer.Reset();
!   
       while ( TimeoutUs > 0 ) {
         usleep(10000);
         TimeoutUs-=Timer.GetRelTime();
       };
!      
       return decoder->BufferFill() < 99;
    }
--- 496,505 ----
       cRelTimer Timer;
       Timer.Reset();
! 
       while ( TimeoutUs > 0 ) {
         usleep(10000);
         TimeoutUs-=Timer.GetRelTime();
       };
! 
       return decoder->BufferFill() < 99;
    }
***************
*** 511,520 ****
    cRelTimer Timer;
    Timer.Reset();
!   
    while ( TimeoutUs > 0 && decoder->BufferFill() > 0 ) {
         usleep(10000);
         TimeoutUs-=Timer.GetRelTime();
    };
!       
    return  decoder->BufferFill() == 0;
  };
--- 513,522 ----
    cRelTimer Timer;
    Timer.Reset();
! 
    while ( TimeoutUs > 0 && decoder->BufferFill() > 0 ) {
         usleep(10000);
         TimeoutUs-=Timer.GetRelTime();
    };
! 
    return  decoder->BufferFill() == 0;
  };
***************
*** 629,636 ****
  }
  
! const char *cPluginSoftDevice::Version(void) 
  { return VERSION; }
  
! const char *cPluginSoftDevice::Description(void) 
  { return tr(DESCRIPTION); }
  
--- 631,638 ----
  }
  
! const char *cPluginSoftDevice::Version(void)
  { return VERSION; }
  
! const char *cPluginSoftDevice::Description(void)
  { return tr(DESCRIPTION); }
  
***************
*** 730,734 ****
                         "[ProcessArgs] xv: start up fullscreen\n");
                vo_argv += 4;
!             } else {  
                      fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
                      esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
--- 732,736 ----
                         "[ProcessArgs] xv: start up fullscreen\n");
                vo_argv += 4;
!             } else {
                      fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
                      esyslog("[softdevice] ignoring unrecognized option \"%s\"\n",argv[i]);
***************
*** 904,908 ****
          return 0;
  };
!  
  bool cPluginSoftDevice::Service(const char *Id, void *Data ) {
          printf("Service '%s'\n",Id);
--- 906,910 ----
          return 0;
  };
! 
  bool cPluginSoftDevice::Service(const char *Id, void *Data ) {
          printf("Service '%s'\n",Id);

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** video-dfb.c	12 Mar 2006 09:43:28 -0000	1.51
--- video-dfb.c	14 Apr 2006 18:56:34 -0000	1.52
***************
*** 1146,1150 ****
  
        tmpSurface->Flip();
!               
        int miny=0;
        int maxy=0;
--- 1146,1150 ----
  
        tmpSurface->Flip();
! 
        int miny=0;
        int maxy=0;
***************
*** 1159,1163 ****
                while (dirtyLines[maxy] && maxy < Yres)
                        maxy++;
! 	      
                osdsrc.x = 0;
                osdsrc.y = miny;
--- 1159,1163 ----
                while (dirtyLines[maxy] && maxy < Yres)
                        maxy++;
! 
                osdsrc.x = 0;
                osdsrc.y = miny;
***************
*** 1165,1173 ****
                osdsrc.h = maxy-miny + 1;
                tmpSurface->Blit(tmpSurface,&osdsrc,0,miny);
!               
                miny=maxy;
!              
        } while ( miny<Yres);
!       
      }
      catch (DFBException *ex)
--- 1165,1173 ----
                osdsrc.h = maxy-miny + 1;
                tmpSurface->Blit(tmpSurface,&osdsrc,0,miny);
! 
                miny=maxy;
! 
        } while ( miny<Yres);
! 
      }
      catch (DFBException *ex)
***************
*** 1427,1430 ****
--- 1427,1431 ----
  
        yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
+       //yv12_to_yuy2_il_c(Py + Ystride  * cutTop * 2 + cutLeft * 2,
                     Pu + UVstride * cutTop + cutLeft,
                     Pv + UVstride * cutTop + cutLeft,

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.47
retrieving revision 1.48
diff -C2 -d -r1.47 -r1.48
*** video.c	12 Mar 2006 09:43:28 -0000	1.47
--- video.c	14 Apr 2006 18:56:34 -0000	1.48
***************
*** 39,42 ****
--- 39,45 ----
    aspect_I = 0;
    current_aspect = -1;
+   interlaceMode = -1;
+   prevZoomFactor = 0;
+   realZoomFactor = 1.0;
    PixelMask=NULL;
    OsdRefreshCounter=0;
***************
*** 69,73 ****
      if (!OsdPy)
         OsdPy=(uint8_t*)malloc(Ysize+8);
!     if (!OsdPAlphaY) 
      {
         OsdPAlphaY=(uint8_t*)malloc(Ysize+8);
--- 72,76 ----
      if (!OsdPy)
         OsdPy=(uint8_t*)malloc(Ysize+8);
!     if (!OsdPAlphaY)
      {
         OsdPAlphaY=(uint8_t*)malloc(Ysize+8);
***************
*** 157,164 ****
  /* ---------------------------------------------------------------------------
   */
  void cVideoOut::CheckAspect(int new_afd, double new_asp)
  {
!     int           new_aspect;
!     double        d_asp, afd_asp, p_asp;
  
    /* -------------------------------------------------------------------------
--- 160,273 ----
  /* ---------------------------------------------------------------------------
   */
+ void cVideoOut::AdjustToZoomFactor(int *tw, int *th)
+ {
+   if (prevZoomFactor != setupStore->zoomFactor ||
+       zoomCenterX != setupStore->zoomCenterX ||
+       zoomCenterY != setupStore->zoomCenterY ||
+       expandTopBottom != setupStore->expandTopBottomLines ||
+       expandLeftRight != setupStore->expandLeftRightCols)
+   {
+     prevZoomFactor = setupStore->zoomFactor;
+     zoomCenterX = setupStore->zoomCenterX;
+     zoomCenterY = setupStore->zoomCenterY;
+     realZoomFactor = (1.0 +
+                       (((double) prevZoomFactor * (double) prevZoomFactor) / 2)
+                         / 512.0);
+     expandTopBottom = setupStore->expandTopBottomLines;
+     expandLeftRight = setupStore->expandLeftRightCols;
+     /* -----------------------------------------------------------------------
+      * force recalculation for aspect ration handling
+      */
+     current_aspect = -1;
+   }
+ 
+   *th = (int) ((double) fheight / realZoomFactor);
+   *tw = (int) ((double) fwidth / realZoomFactor);
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::AdjustSourceArea(int tw, int th)
+ {
+     int dx, dy;
+ 
+   sxoff = (fwidth - swidth) / 2;
+   syoff = (fheight - sheight) / 2;
+ 
+   sxoff += (int) ((double) sxoff * ((double) zoomCenterX / 100.0));
+   syoff += (int) ((double) syoff * ((double) zoomCenterY / 100.0));
+ 
+   /* -------------------------------------------------------------------------
+    * handle user selected row/coloumn expansion
+    */
+   if ((dy = expandTopBottom * 2 - syoff) > 0) {
+     syoff += dy;
+     sheight -= 2 * dy;
+   }
+   if ((dx = expandLeftRight * 2 - sxoff) > 0) {
+     sxoff += dx;
+     swidth -= 2 * dx;
+   }
+ 
+   /* --------------------------------------------------------------------------
+    * adjust possible rounding errors. as we are in YV12 or similar mode,
+    * line offsets and coloumn offsets must be even.
+    */
+   if (syoff & 1) {
+     syoff--;
+     if ((th - sheight) > 1)
+       sheight += 2;
+   }
+ 
+   if (sxoff & 1) {
+     sxoff--;
+     if ((tw - swidth) > 1)
+       swidth += 2;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::AdjustToDisplayGeometry(double afd_aspect)
+ {
+     double        d_asp, p_asp;
+ 
+   /* --------------------------------------------------------------------------
+    * handle screen aspect support now
+    */
+   p_asp = parValues [screenPixelAspect];
+   d_asp = (double) dwidth / (double) dheight;
+ 
+   if ((d_asp * p_asp) > afd_aspect) {
+     /* ------------------------------------------------------------------------
+      * display aspect is wider than frame aspect
+      * so we have to pillar-box
+      */
+     lheight = dheight;
+     lwidth = (int) (0.5 + ((double) dheight * afd_aspect / p_asp));
+   } else {
+     /* ------------------------------------------------------------------------
+      * display aspect is taller or equal than frame aspect
+      * so we have to letter-box
+      */
+     lwidth = dwidth;
+     lheight = (int) (0.5 + ((double) dwidth * p_asp / afd_aspect));
+   }
+ 
+   /* -------------------------------------------------------------------------
+    * center result on display
+    */
+   lxoff = (dwidth - lwidth) / 2;
+   lyoff = (dheight - lheight) / 2;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cVideoOut::CheckAspect(int new_afd, double new_asp)
  {
!     int           new_aspect,
!                   tmpWidth,
!                   tmpHeight;
!     double        afd_asp;
  
    /* -------------------------------------------------------------------------
***************
*** 188,191 ****
--- 297,302 ----
    }
  
+   AdjustToZoomFactor(&tmpWidth, &tmpHeight);
+ 
    if (new_aspect == current_aspect && new_afd == current_afd )
    {
***************
*** 196,200 ****
    aspect_changed = 1;
  
-   d_asp = (double) dwidth / (double) dheight;
    switch (new_afd) {
    /* --------------------------------------------------------------------------
--- 307,310 ----
***************
*** 213,265 ****
    }
  
!   sheight = fheight;
!   swidth = fwidth;
!   if (afd_asp <= new_asp) {
!     swidth = (int) (0.5 + ((double) fwidth * afd_asp / new_asp));
!   } else {
!     sheight = (int) (0.5 + ((double) fheight * new_asp / afd_asp));
!   }
!   sxoff = (fwidth - swidth) / 2;
!   syoff = (fheight - sheight) / 2;
! 
!   /* --------------------------------------------------------------------------
!    * adjust possible rounding errors. as we are in YV12 or similar mode,
!    * line offsets and coloumn offsets must be even.
!    */
!   if (syoff & 1) {
!     syoff--;
!     if ((fheight - sheight) > 1)
!       sheight += 2;
!   }
! 
!   if (sxoff & 1) {
!     sxoff--;
!     if ((fwidth - swidth) > 1)
!       swidth += 2;
!   }
! 
!   /* --------------------------------------------------------------------------
!    * handle screen aspect support now
!    */
!   p_asp = parValues [screenPixelAspect];
  
!   if ((d_asp * p_asp) > afd_asp) {
!     /* ------------------------------------------------------------------------
!      * display aspect is wider than frame aspect
!      * so we have to pillar-box
!      */
!     lheight = dheight;
!     lwidth = (int) (0.5 + ((double) dheight * afd_asp / p_asp));
    } else {
!     /* ------------------------------------------------------------------------
!      * display aspect is taller or equal than frame aspect
!      * so we have to letter-box
!      */
!     lwidth = dwidth;
!     lheight = (int) (0.5 + ((double) dwidth * p_asp / afd_asp));
    }
  
!   lxoff = (dwidth - lwidth) / 2;
!   lyoff = (dheight - lheight) / 2;
  
    dsyslog("[VideoOut]: %dx%d [%d,%d %dx%d] -> %dx%d [%d,%d %dx%d]",
--- 323,337 ----
    }
  
!   sheight = tmpHeight;
!   swidth = tmpWidth;
  
!   if (afd_asp <= new_asp) {
!     swidth = (int) (0.5 + ((double) tmpWidth * afd_asp / new_asp));
    } else {
!     sheight = (int) (0.5 + ((double) tmpHeight * new_asp / afd_asp));
    }
  
!   AdjustSourceArea (tmpWidth, tmpHeight);
!   AdjustToDisplayGeometry (afd_asp);
  
    dsyslog("[VideoOut]: %dx%d [%d,%d %dx%d] -> %dx%d [%d,%d %dx%d]",
***************
*** 298,301 ****
--- 370,379 ----
    }
  
+   if (interlaceMode != picture->interlaced_frame)
+   {
+     dsyslog("[VideoOut]: interlaced mode now: %sinterlaced",
+             (picture->interlaced_frame) ? "" : "non-");
+     interlaceMode = picture->interlaced_frame;
+   }
  #if LIBAVCODEC_BUILD > 4686
    /* --------------------------------------------------------------------------
***************
*** 472,476 ****
            uint8_t *alpha,uint16_t count) {
       // printf("%x %x %x \n",P1,P2,alpha);
!  
  #ifdef USE_MMX
          __asm__(" pxor %%mm3,%%mm3\n"
--- 550,554 ----
            uint8_t *alpha,uint16_t count) {
       // printf("%x %x %x \n",P1,P2,alpha);
! 
  #ifdef USE_MMX
          __asm__(" pxor %%mm3,%%mm3\n"

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** video.h	12 Mar 2006 09:43:28 -0000	1.31
--- video.h	14 Apr 2006 18:56:34 -0000	1.32
***************
*** 80,83 ****
--- 80,88 ----
      int     aspect_I;
      double  aspect_F;
+ 
+     void    AdjustToZoomFactor(int *tw, int *th),
+             AdjustSourceArea(int tw, int th),
+             AdjustToDisplayGeometry(double afd_aspect);
+ 
  protected:
      inline double GetAspect_F()
***************
*** 91,98 ****
      int     current_osdMode;
      int     Xres, Yres, Bpp; // the child class MUST set these params (for OSD Drawing)
!     int     dx, dy, 
              dwidth, dheight,
              old_x, old_y, old_dwidth, old_dheight,
!             screenPixelAspect;
      volatile int        fwidth, fheight;
      int     swidth, sheight,
--- 96,107 ----
      int     current_osdMode;
      int     Xres, Yres, Bpp; // the child class MUST set these params (for OSD Drawing)
!     int     dx, dy,
              dwidth, dheight,
              old_x, old_y, old_dwidth, old_dheight,
!             screenPixelAspect,
!             prevZoomFactor,
!             zoomCenterX,
!             zoomCenterY;
!     double  realZoomFactor;
      volatile int        fwidth, fheight;
      int     swidth, sheight,
***************
*** 106,111 ****
--- 115,123 ----
              cutTop, cutBottom,
              cutLeft, cutRight,
+             expandTopBottom,
+             expandLeftRight,
              aspect_changed,
              current_afd,
+             interlaceMode,
              displayTimeUS;
      double  parValues[MAX_PAR];
***************
*** 123,127 ****
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
!     
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
      virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride) { return; };
--- 135,139 ----
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
! 
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
      virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride) { return; };
***************
*** 154,164 ****
      uint8_t *PixelMask;
      uint8_t *OsdPy;
!     uint8_t *OsdPu; 
      uint8_t *OsdPv;
!     uint8_t *OsdPAlphaY; 
      uint8_t *OsdPAlphaUV;
!     // buffers for software osd alpha blending 
      void init_OsdBuffers();
!     
      int OsdHeight;
      int OsdWidth;
--- 166,176 ----
      uint8_t *PixelMask;
      uint8_t *OsdPy;
!     uint8_t *OsdPu;
      uint8_t *OsdPv;
!     uint8_t *OsdPAlphaY;
      uint8_t *OsdPAlphaUV;
!     // buffers for software osd alpha blending
      void init_OsdBuffers();
! 
      int OsdHeight;
      int OsdWidth;
***************
*** 166,173 ****
  private:
      int     Osd_changed;
!    
      uint16_t OsdRefreshCounter;
!     // should be setted to null everytime OSD is shown 
!     // (software alpha blending mode).  
  public:
      virtual void ClearOSD();
--- 178,185 ----
  private:
      int     Osd_changed;
! 
      uint16_t OsdRefreshCounter;
!     // should be setted to null everytime OSD is shown
!     // (software alpha blending mode).
  public:
      virtual void ClearOSD();
***************
*** 186,198 ****
      // for scaling, if -1,-1 is returned no scaling is done.
      { OsdWidth=-1;OsdHeight=-1; xPan = yPan = 0;};
!      
!     virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                      bool &IsYUV, uint8_t *&PixelMask)
!     { Depth=32; HasAlpha=true; AlphaInversed=false; IsYUV=false; 
              PixelMask=NULL;};
      // should be implemented by all video out method to set the OSD pixel mode
  
      // RGB modes
!     virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
                      bool *&dirtyLines)
      { osd=NULL; stride=0; dirtyLines=NULL;};
--- 198,210 ----
      // for scaling, if -1,-1 is returned no scaling is done.
      { OsdWidth=-1;OsdHeight=-1; xPan = yPan = 0;};
! 
!     virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                      bool &IsYUV, uint8_t *&PixelMask)
!     { Depth=32; HasAlpha=true; AlphaInversed=false; IsYUV=false;
              PixelMask=NULL;};
      // should be implemented by all video out method to set the OSD pixel mode
  
      // RGB modes
!     virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
                      bool *&dirtyLines)
      { osd=NULL; stride=0; dirtyLines=NULL;};
***************
*** 211,215 ****
      virtual void CommitUnlockSoftOsdSurface( int osdwidth, int osdheight)
      { OSDpresent=true; OsdWidth=osdwidth; OsdHeight=osdheight; Osd_changed=1;};
!       
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
         uint8_t *alpha,uint16_t count);
--- 223,227 ----
      virtual void CommitUnlockSoftOsdSurface( int osdwidth, int osdheight)
      { OSDpresent=true; OsdWidth=osdwidth; OsdHeight=osdheight; Osd_changed=1;};
! 
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
         uint8_t *alpha,uint16_t count);



From nobody at sheep.berlios.de  Fri Apr 14 23:25:21 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 14 Apr 2006 23:25:21 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.168,1.169 mpeg2decoder.c,1.62,1.63 mpeg2decoder.h,1.35,1.36
Message-ID: <200604142125.k3ELPLt00865@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1876

Modified Files:
	CHANGELOG mpeg2decoder.c mpeg2decoder.h 
Log Message:
applied patch for mono upmix from Lucian Muresan

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.168
retrieving revision 1.169
diff -C2 -d -r1.168 -r1.169
*** CHANGELOG	14 Apr 2006 18:56:34 -0000	1.168
--- CHANGELOG	14 Apr 2006 21:25:44 -0000	1.169
***************
*** 8,11 ****
--- 8,12 ----
     - Restricted OSD alpha blend option to XV and VIDIX out.
     - started some documentation of our various OSD options.
+    - applied patch for mono upmix from Lucian Muresan
  2006-04-01:
     - applied Makefile patch from Antti Sepp?l?

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.62
retrieving revision 1.63
diff -C2 -d -r1.62 -r1.63
*** mpeg2decoder.c	12 Mar 2006 09:47:43 -0000	1.62
--- mpeg2decoder.c	14 Apr 2006 21:25:44 -0000	1.63
***************
*** 83,90 ****
        EnablePut.Signal();
    };
!   
    if (FirstPacket==LastPacket) {
         BUFDEB("PacketQueue.EnableGet.Sleep start pid: %d\n",getpid());
!        EnableGet.Sleep(10000);  
         BUFDEB("PacketQueue.EnableGet.Sleep stop pid: %d \n",getpid());
    };
--- 83,90 ----
        EnablePut.Signal();
    };
! 
    if (FirstPacket==LastPacket) {
         BUFDEB("PacketQueue.EnableGet.Sleep start pid: %d\n",getpid());
!        EnableGet.Sleep(10000);
         BUFDEB("PacketQueue.EnableGet.Sleep stop pid: %d \n",getpid());
    };
***************
*** 97,101 ****
  
  void cPacketQueue::FreeReadPacket(AVPacket *Packet) {
!   if (&queue[FirstPacket] == Packet ) 
       FirstPacket=Next(FirstPacket);
    else {
--- 97,101 ----
  
  void cPacketQueue::FreeReadPacket(AVPacket *Packet) {
!   if (&queue[FirstPacket] == Packet )
       FirstPacket=Next(FirstPacket);
    else {
***************
*** 156,160 ****
    active=false;
    Cancel(3);
!   if (codec && context)  
      avcodec_close(context);
    else fprintf(stderr,"Error not closing context %p, codec %p\n",context,codec);
--- 156,160 ----
    active=false;
    Cancel(3);
!   if (codec && context)
      avcodec_close(context);
    else fprintf(stderr,"Error not closing context %p, codec %p\n",context,codec);
***************
*** 170,174 ****
    AVPacket *pkt;
  
!   while ( PacketQueue.Available() < 7 && active) { 
      BUFDEB("wait while loop packets %d StreamDecoder  pid:%d type %d\n",
        PacketQueue.Available(),getpid(),context->codec_type );
--- 170,174 ----
    AVPacket *pkt;
  
!   while ( PacketQueue.Available() < 7 && active) {
      BUFDEB("wait while loop packets %d StreamDecoder  pid:%d type %d\n",
        PacketQueue.Available(),getpid(),context->codec_type );
***************
*** 187,191 ****
         BUFDEB("got packet PTS: %lld pid: %d type %d \n",
           pkt->pts,getpid(),context->codec_type);
!        if (codec && context) 
           DecodePacket(pkt);
         av_free_packet(pkt);
--- 187,191 ----
         BUFDEB("got packet PTS: %lld pid: %d type %d \n",
           pkt->pts,getpid(),context->codec_type);
!        if (codec && context)
           DecodePacket(pkt);
         av_free_packet(pkt);
***************
*** 197,201 ****
        usleep(10000);
      };
! #if 0 
      {
        static int count=0;
--- 197,201 ----
        usleep(10000);
      };
! #if 0
      {
        static int count=0;
***************
*** 249,253 ****
    bool oldfreezeMode=freezeMode;
    Freeze();
!   
    mutex.Lock();
    if (codec && context)
--- 249,253 ----
    bool oldfreezeMode=freezeMode;
    Freeze();
! 
    mutex.Lock();
    if (codec && context)
***************
*** 258,262 ****
    // restore old freezeMode
    freezeMode=oldfreezeMode;
!   
    CMDDEB("cStreamDecoder clear finished type: %d\n",context->codec_type);
  }
--- 258,262 ----
    // restore old freezeMode
    freezeMode=oldfreezeMode;
! 
    CMDDEB("cStreamDecoder clear finished type: %d\n",context->codec_type);
  }
***************
*** 319,323 ****
    audioMode=AudioMode;
    audiosamples=(uint8_t *)malloc(AVCODEC_MAX_AUDIO_FRAME_SIZE);
!   
    audioOutContext.period_size=2*1024;
    audioOutContext.samplerate=44100;
--- 319,323 ----
    audioMode=AudioMode;
    audiosamples=(uint8_t *)malloc(AVCODEC_MAX_AUDIO_FRAME_SIZE);
! 
    audioOutContext.period_size=2*1024;
    audioOutContext.samplerate=44100;
***************
*** 334,337 ****
--- 334,339 ----
  };
  
+ /* ---------------------------------------------------------------------------
+  */
  void cAudioStreamDecoder::OnlyLeft(uint8_t *samples,int Length) {
    for (int i=0; i < Length/2; i+=2)
***************
*** 339,342 ****
--- 341,346 ----
  };
  
+ /* ---------------------------------------------------------------------------
+  */
  void cAudioStreamDecoder::OnlyRight(uint8_t *samples,int Length) {
    for (int i=0; i < Length/2; i+=2)
***************
*** 346,350 ****
--- 350,366 ----
  /* ---------------------------------------------------------------------------
   */
+ bool cAudioStreamDecoder::UpmixMono(uint8_t *samples,int Length) {
+   if (Length > AVCODEC_MAX_AUDIO_FRAME_SIZE / 2)
+     return false;
+ 
+   for (int i = 2*Length -1; i >= 0; i--) {
+     ((uint16_t*)samples)[i]=((uint16_t*)samples)[i/2];
+     ((uint16_t*)samples)[i+1]=((uint16_t*)samples)[i/2];
+   }
+   return true;
+ }
  
+ /* ---------------------------------------------------------------------------
+  */
  int cAudioStreamDecoder::DecodePacket(AVPacket *pkt) {
      int     len=0;
***************
*** 428,435 ****
          continue;
      };
!     
      audioOutContext.channels=context->channels;
      audioOutContext.samplerate=context->sample_rate;
!     
      if (audioMode && audioOutContext.channels==2) {
        // respect mono left/right only channels
--- 444,451 ----
          continue;
      };
! 
      audioOutContext.channels=context->channels;
      audioOutContext.samplerate=context->sample_rate;
! 
      if (audioMode && audioOutContext.channels==2) {
        // respect mono left/right only channels
***************
*** 437,442 ****
          OnlyLeft(audiosamples,audio_size);
        else OnlyRight(audiosamples,audio_size);
!     };
!     
      audioOut->SetParams(audioOutContext);
      audioOut->Write(audiosamples,audio_size);
--- 453,465 ----
          OnlyLeft(audiosamples,audio_size);
        else OnlyRight(audiosamples,audio_size);
!     }
!     else if (!audioMode && audioOutContext.channels==1) {
!       // respect true "mono only" channels
!       if (UpmixMono(audiosamples, audio_size)) {
!         audioOutContext.channels = 2;
!         audio_size *= 2;
!       }
!     }
! 
      audioOut->SetParams(audioOutContext);
      audioOut->Write(audiosamples,audio_size);
***************
*** 795,799 ****
      return;
    }
!   
    avpicture_fill(&avpic_dest,pic_buf_lavc,
                      context->pix_fmt,context->width ,context->height);
--- 818,822 ----
      return;
    }
! 
    avpicture_fill(&avpic_dest,pic_buf_lavc,
                      context->pix_fmt,context->width ,context->height);
***************
*** 803,807 ****
  
    if (avpicture_deinterlace(&avpic_dest, &avpic_src, context->pix_fmt,
!                               context->width, context->height) < 0) 
    {
      fprintf(stderr,
--- 826,830 ----
  
    if (avpicture_deinterlace(&avpic_dest, &avpic_src, context->pix_fmt,
!                               context->width, context->height) < 0)
    {
      fprintf(stderr,
***************
*** 810,815 ****
      setupStore.deintMethod = 0;
      return;
!   } 
!     
    memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
    memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
--- 833,838 ----
      setupStore.deintMethod = 0;
      return;
!   }
! 
    memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
    memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
***************
*** 831,835 ****
       return;
    }
!  
    avpicture_fill(&avpic_dest,pic_buf_convert,
                      PIX_FMT_YUV420P,context->width ,context->height);
--- 854,858 ----
       return;
    }
! 
    avpicture_fill(&avpic_dest,pic_buf_convert,
                      PIX_FMT_YUV420P,context->width ,context->height);
***************
*** 837,841 ****
    memcpy(avpic_src.data,picture->data,sizeof(avpic_src.data));
    memcpy(avpic_src.linesize,picture->linesize,sizeof(avpic_src.linesize));
!   
    if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
  		  &avpic_src, context->pix_fmt,
--- 860,864 ----
    memcpy(avpic_src.data,picture->data,sizeof(avpic_src.data));
    memcpy(avpic_src.linesize,picture->linesize,sizeof(avpic_src.linesize));
! 
    if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
  		  &avpic_src, context->pix_fmt,
***************
*** 844,848 ****
                "[softdevice] error, libavcodec img_convert failure\n");
       return;
!   } 
  
    memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
--- 867,871 ----
                "[softdevice] error, libavcodec img_convert failure\n");
       return;
!   }
  
    memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
***************
*** 958,963 ****
  
    deintWork = setupStore.deintMethod;
!   if (currentDeintMethod != deintWork || ppmode == NULL 
!       || currentppMethod != setupStore.ppMethod 
        || currentppQuality != setupStore.ppQuality ) {
      // reallocate ppmode if method or quality changed
--- 981,986 ----
  
    deintWork = setupStore.deintMethod;
!   if (currentDeintMethod != deintWork || ppmode == NULL
!       || currentppMethod != setupStore.ppMethod
        || currentppQuality != setupStore.ppQuality ) {
      // reallocate ppmode if method or quality changed
***************
*** 977,981 ****
  
      ppmode = pp_get_mode_by_name_and_quality(mode, setupStore.ppQuality);
!     
      currentDeintMethod = deintWork;
      currentppMethod = setupStore.ppMethod;
--- 1000,1004 ----
  
      ppmode = pp_get_mode_by_name_and_quality(mode, setupStore.ppQuality);
! 
      currentDeintMethod = deintWork;
      currentppMethod = setupStore.ppMethod;
***************
*** 992,996 ****
    }
  
!   
    if ( !pic_buf_pp ) {
      fprintf(stderr,
--- 1015,1019 ----
    }
  
! 
    if ( !pic_buf_pp ) {
      fprintf(stderr,
***************
*** 1000,1004 ****
      return;
    }
!  
    avpicture_fill(&avpic_dest,pic_buf_pp,
                      context->pix_fmt,context->width ,context->height);
--- 1023,1027 ----
      return;
    }
! 
    avpicture_fill(&avpic_dest,pic_buf_pp,
                      context->pix_fmt,context->width ,context->height);
***************
*** 1049,1053 ****
        ppmode = NULL;
    }
! #endif  
  }
  
--- 1072,1076 ----
        ppmode = NULL;
    }
! #endif
  }
  
***************
*** 1055,1071 ****
  static int read_packet_RingBuffer(void *opaque, uint8_t *buf, int buf_size) {
       cMpeg2Decoder *Dec=(cMpeg2Decoder *)(opaque);
!      if (Dec) 
         return Dec->read_packet(buf,buf_size);
       return -1;
  };
!     
  #if LIBAVFORMAT_BUILD >4625
! static offset_t seek_RingBuffer(void *opaque, offset_t offset, int whence) 
  #else
! static int seek_RingBuffer(void *opaque, offset_t offset, int whence) 
  #endif
  {
       cMpeg2Decoder *Dec=(cMpeg2Decoder *)(opaque);
!      if (Dec) 
         return Dec->seek(offset, whence);
       return -1;
--- 1078,1094 ----
  static int read_packet_RingBuffer(void *opaque, uint8_t *buf, int buf_size) {
       cMpeg2Decoder *Dec=(cMpeg2Decoder *)(opaque);
!      if (Dec)
         return Dec->read_packet(buf,buf_size);
       return -1;
  };
! 
  #if LIBAVFORMAT_BUILD >4625
! static offset_t seek_RingBuffer(void *opaque, offset_t offset, int whence)
  #else
! static int seek_RingBuffer(void *opaque, offset_t offset, int whence)
  #endif
  {
       cMpeg2Decoder *Dec=(cMpeg2Decoder *)(opaque);
!      if (Dec)
         return Dec->seek(offset, whence);
       return -1;
***************
*** 1083,1094 ****
    avcodec_init();
    avcodec_register_all();
!  
    audioOut=AudioOut;
    videoOut=VideoOut;
    aout=NULL;
    vout=NULL;
!   
    StreamBuffer=NULL;
!   
    running=false;
    decoding=false;
--- 1106,1117 ----
    avcodec_init();
    avcodec_register_all();
! 
    audioOut=AudioOut;
    videoOut=VideoOut;
    aout=NULL;
    vout=NULL;
! 
    StreamBuffer=NULL;
! 
    running=false;
    decoding=false;
***************
*** 1104,1108 ****
    aout=0;
    aoutMutex.Unlock();
!   
    voutMutex.Lock();
    if (vout)
--- 1127,1131 ----
    aout=0;
    aoutMutex.Unlock();
! 
    voutMutex.Lock();
    if (vout)
***************
*** 1117,1121 ****
     BUFDEB("read_packet Del %d\n",LastSize);
      StreamBuffer->Del(LastSize);
!     int size=StreamBuffer->Available(); 
      if ( size < buf_size ) {
        BUFDEB("read_packet Available()%d < buf_size EnablePut.Signal\n",size);
--- 1140,1144 ----
     BUFDEB("read_packet Del %d\n",LastSize);
      StreamBuffer->Del(LastSize);
!     int size=StreamBuffer->Available();
      if ( size < buf_size ) {
        BUFDEB("read_packet Available()%d < buf_size EnablePut.Signal\n",size);
***************
*** 1124,1129 ****
  start:
      int count=0;
!     size=StreamBuffer->Available(); 
!     while ( size < buf_size && ThreadActive 
             && count <  1  ) {
        BUFDEB("read_packet EnableGet.Sleep start\n");
--- 1147,1152 ----
  start:
      int count=0;
!     size=StreamBuffer->Available();
!     while ( size < buf_size && ThreadActive
             && count <  1  ) {
        BUFDEB("read_packet EnableGet.Sleep start\n");
***************
*** 1136,1144 ****
        };
     };
!     
      // signal eof if thread should end...
!     if (!ThreadActive && size == 0) 
        return -1;
!       
      size = buf_size;
      uchar *u =StreamBuffer->Get(size);
--- 1159,1167 ----
        };
     };
! 
      // signal eof if thread should end...
!     if (!ThreadActive && size == 0)
        return -1;
! 
      size = buf_size;
      uchar *u =StreamBuffer->Get(size);
***************
*** 1148,1152 ****
         if (size>buf_size)
           size=buf_size;
!  
         ic->pb.buffer=u;
         LastSize=size;
--- 1171,1175 ----
         if (size>buf_size)
           size=buf_size;
! 
         ic->pb.buffer=u;
         LastSize=size;
***************
*** 1171,1175 ****
  void cMpeg2Decoder::initStream() {
     AVInputFormat *fmt;
!    
     LastSize=0;
     av_register_all();
--- 1194,1198 ----
  void cMpeg2Decoder::initStream() {
     AVInputFormat *fmt;
! 
     LastSize=0;
     av_register_all();
***************
*** 1199,1207 ****
  
    int nStreams=0;
!   
    while(ThreadActive) {
          while (freezeMode && ThreadActive)
            usleep(50000);
!         
          BUFDEB("av_read_frame start\n");
          //ret = av_read_frame(ic, &pkt);
--- 1222,1230 ----
  
    int nStreams=0;
! 
    while(ThreadActive) {
          while (freezeMode && ThreadActive)
            usleep(50000);
! 
          BUFDEB("av_read_frame start\n");
          //ret = av_read_frame(ic, &pkt);
***************
*** 1245,1249 ****
  {
    CMDDEB("ResetDecoder %d\n",Stream);
!   
    if (Stream & SOFTDEVICE_AUDIO_STREAM)  {
      aoutMutex.Lock();
--- 1268,1272 ----
  {
    CMDDEB("ResetDecoder %d\n",Stream);
! 
    if (Stream & SOFTDEVICE_AUDIO_STREAM)  {
      aoutMutex.Lock();
***************
*** 1257,1261 ****
      aoutMutex.Unlock();
    };
!     
    if (Stream & SOFTDEVICE_VIDEO_STREAM)  {
      voutMutex.Lock();
--- 1280,1284 ----
      aoutMutex.Unlock();
    };
! 
    if (Stream & SOFTDEVICE_VIDEO_STREAM)  {
      voutMutex.Lock();
***************
*** 1286,1300 ****
          av_free_packet(&pkt);
          return;
!   }; 
    int packet_type=CODEC_TYPE_UNKNOWN;
  
  #if LIBAVFORMAT_BUILD > 4628
!   if ( ic->streams[pkt.stream_index] 
                    && ic->streams[pkt.stream_index]->codec )
            packet_type = ic->streams[pkt.stream_index]->codec->codec_type;
  #else
!   if ( ic->streams[pkt.stream_index] ) 
            packet_type = ic->streams[pkt.stream_index]->codec.codec_type;
! #endif         
  
    if ( packet_type == CODEC_TYPE_UNKNOWN ) {
--- 1309,1323 ----
          av_free_packet(&pkt);
          return;
!   };
    int packet_type=CODEC_TYPE_UNKNOWN;
  
  #if LIBAVFORMAT_BUILD > 4628
!   if ( ic->streams[pkt.stream_index]
                    && ic->streams[pkt.stream_index]->codec )
            packet_type = ic->streams[pkt.stream_index]->codec->codec_type;
  #else
!   if ( ic->streams[pkt.stream_index] )
            packet_type = ic->streams[pkt.stream_index]->codec.codec_type;
! #endif
  
    if ( packet_type == CODEC_TYPE_UNKNOWN ) {
***************
*** 1302,1306 ****
            return;
    };
!   
    // check if there are new streams
    if ( AudioIdx != DONT_PLAY && packet_type == CODEC_TYPE_AUDIO
--- 1325,1329 ----
            return;
    };
! 
    // check if there are new streams
    if ( AudioIdx != DONT_PLAY && packet_type == CODEC_TYPE_AUDIO
***************
*** 1324,1328 ****
      aoutMutex.Unlock();
    } else
!   if (VideoIdx != DONT_PLAY && packet_type == CODEC_TYPE_VIDEO 
         && VideoIdx!=pkt.stream_index) {
      CMDDEB("new Video stream index.. old %d new %d\n",
--- 1347,1351 ----
      aoutMutex.Unlock();
    } else
!   if (VideoIdx != DONT_PLAY && packet_type == CODEC_TYPE_VIDEO
         && VideoIdx!=pkt.stream_index) {
      CMDDEB("new Video stream index.. old %d new %d\n",
***************
*** 1344,1349 ****
  #endif
    };
!   
!   // write streams 
    voutMutex.Lock();
    if ( packet_type == CODEC_TYPE_VIDEO && vout ) {
--- 1367,1372 ----
  #endif
    };
! 
!   // write streams
    voutMutex.Lock();
    if ( packet_type == CODEC_TYPE_VIDEO && vout ) {
***************
*** 1355,1359 ****
    } ;
    voutMutex.Unlock();
!   
    aoutMutex.Lock();
    if ( packet_type == CODEC_TYPE_AUDIO && aout ) {
--- 1378,1382 ----
    } ;
    voutMutex.Unlock();
! 
    aoutMutex.Lock();
    if ( packet_type == CODEC_TYPE_AUDIO && aout ) {
***************
*** 1365,1369 ****
    };
    aoutMutex.Unlock();
!   
    if ( packet_type != CODEC_TYPE_VIDEO && packet_type != CODEC_TYPE_AUDIO ) {
      //printf("Unknown packet or vout or aout not init!!\n");
--- 1388,1392 ----
    };
    aoutMutex.Unlock();
! 
    if ( packet_type != CODEC_TYPE_VIDEO && packet_type != CODEC_TYPE_AUDIO ) {
      //printf("Unknown packet or vout or aout not init!!\n");
***************
*** 1382,1389 ****
      // don't start if we are suspended
      return;
!  
    if (GetMutex)
      mutex.Lock();
!    
    if (StreamBuffer) {
    	delete StreamBuffer;
--- 1405,1412 ----
      // don't start if we are suspended
      return;
! 
    if (GetMutex)
      mutex.Lock();
! 
    if (StreamBuffer) {
    	delete StreamBuffer;
***************
*** 1442,1446 ****
    CMDDEB("Play\n");
    freezeMode=false;
!   if (running) 
    {
      aoutMutex.Lock();
--- 1465,1469 ----
    CMDDEB("Play\n");
    freezeMode=false;
!   if (running)
    {
      aoutMutex.Lock();
***************
*** 1448,1457 ****
        aout->Play();
      aoutMutex.Unlock();
!     
      voutMutex.Lock();
      if (vout)
        vout->Play();
      voutMutex.Unlock();
!     
      cClock::SetFreezeMode(false);
    };
--- 1471,1480 ----
        aout->Play();
      aoutMutex.Unlock();
! 
      voutMutex.Lock();
      if (vout)
        vout->Play();
      voutMutex.Unlock();
! 
      cClock::SetFreezeMode(false);
    };
***************
*** 1463,1467 ****
    this->packetMode=packetMode;
    switch (curPlayMode) {
!     case PmAudioVideo: 
        CMDDEB("SetPlayMode PmAudioVideo\n");
        PlayAudioVideo(true,true);
--- 1486,1490 ----
    this->packetMode=packetMode;
    switch (curPlayMode) {
!     case PmAudioVideo:
        CMDDEB("SetPlayMode PmAudioVideo\n");
        PlayAudioVideo(true,true);
***************
*** 1479,1483 ****
    };
  };
!       
  void cMpeg2Decoder::Freeze(int Stream, bool freeze)
  {
--- 1502,1506 ----
    };
  };
! 
  void cMpeg2Decoder::Freeze(int Stream, bool freeze)
  {
***************
*** 1488,1492 ****
    // audio and video stream decoders to sleep
    usleep(20000);
!   if (running) 
    {
      if (Stream & SOFTDEVICE_AUDIO_STREAM) {
--- 1511,1515 ----
    // audio and video stream decoders to sleep
    usleep(20000);
!   if (running)
    {
      if (Stream & SOFTDEVICE_AUDIO_STREAM) {
***************
*** 1496,1500 ****
        aoutMutex.Unlock();
      };
!     
      if (Stream & SOFTDEVICE_VIDEO_STREAM) {
        voutMutex.Lock();
--- 1519,1523 ----
        aoutMutex.Unlock();
      };
! 
      if (Stream & SOFTDEVICE_VIDEO_STREAM) {
        voutMutex.Lock();
***************
*** 1503,1507 ****
        voutMutex.Unlock();
      };
!     
      cClock::SetFreezeMode(true);
    };
--- 1526,1530 ----
        voutMutex.Unlock();
      };
! 
      cClock::SetFreezeMode(true);
    };
***************
*** 1524,1529 ****
      EnableGetSignal.Signal();
      Cancel(4);
!     
!     CMDDEB("stopping video\n"); 
      voutMutex.Lock();
      if (vout) {
--- 1547,1552 ----
      EnableGetSignal.Signal();
      Cancel(4);
! 
!     CMDDEB("stopping video\n");
      voutMutex.Lock();
      if (vout) {
***************
*** 1622,1626 ****
        aout->Clear();
      aoutMutex.Unlock();
!     
      AudioIdx=DONT_PLAY;
    } else if (AudioIdx==DONT_PLAY)
--- 1645,1649 ----
        aout->Clear();
      aoutMutex.Unlock();
! 
      AudioIdx=DONT_PLAY;
    } else if (AudioIdx==DONT_PLAY)
***************
*** 1640,1648 ****
    };
  }
! void cMpeg2Decoder::SetAudioMode(int AudioMode)  { 
    CMDDEB("SetAudioMode %d\n",AudioMode);
    audioMode=AudioMode;
    aoutMutex.Lock();
!   if (aout) 
      aout->SetAudioMode(audioMode);
    aoutMutex.Unlock();
--- 1663,1671 ----
    };
  }
! void cMpeg2Decoder::SetAudioMode(int AudioMode)  {
    CMDDEB("SetAudioMode %d\n",AudioMode);
    audioMode=AudioMode;
    aoutMutex.Lock();
!   if (aout)
      aout->SetAudioMode(audioMode);
    aoutMutex.Unlock();
***************
*** 1664,1672 ****
  };
  
! int cMpeg2Decoder::BufferFill(int Stream) 
  {
    if (freezeMode)
      return 100;
!   
    int video_Fill=0;
    int audio_Fill=0;
--- 1687,1695 ----
  };
  
! int cMpeg2Decoder::BufferFill(int Stream)
  {
    if (freezeMode)
      return 100;
! 
    int video_Fill=0;
    int audio_Fill=0;
***************
*** 1686,1690 ****
      aoutMutex.Unlock();
    };
!   
    BUFDEB("audio_Fill: %d video_Fill: %d\n",audio_Fill,video_Fill);
    return video_Fill>audio_Fill ? video_Fill : audio_Fill;
--- 1709,1713 ----
      aoutMutex.Unlock();
    };
! 
    BUFDEB("audio_Fill: %d video_Fill: %d\n",audio_Fill,video_Fill);
    return video_Fill>audio_Fill ? video_Fill : audio_Fill;
***************
*** 1696,1700 ****
  {
    BUFDEB("Decode %p, Length %d\n",Data,Length);
!   
    if (running && !IsSuspended && setupStore.shouldSuspend)
       // still running and should suspend
--- 1719,1723 ----
  {
    BUFDEB("Decode %p, Length %d\n",Data,Length);
! 
    if (running && !IsSuspended && setupStore.shouldSuspend)
       // still running and should suspend
***************
*** 1704,1708 ****
       // not running and should resume
       Resume();
!      
    if (!running) {
      BUFDEB("not running..\n");
--- 1727,1731 ----
       // not running and should resume
       Resume();
! 
    if (!running) {
      BUFDEB("not running..\n");
***************
*** 1734,1738 ****
    };
    BUFDEB("Decode finished\n");
!   
    return Length;
  }
--- 1757,1761 ----
    };
    BUFDEB("Decode finished\n");
! 
    return Length;
  }

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** mpeg2decoder.h	12 Nov 2005 15:49:33 -0000	1.35
--- mpeg2decoder.h	14 Apr 2006 21:25:44 -0000	1.36
***************
*** 29,44 ****
  
  #define DEFAULT_FRAMETIME 400   // for PAL in 0.1ms
! #define MIN_BUF_SIZE  (16*1024) 
  
  // this combination gives good results when seeking
! #define DVB_BUF_SIZE   (32*1024)  
  #define PACKET_BUF_SIZE 150
  
! // this combination is save 
! //#define DVB_BUF_SIZE   (64*1024)  
  //#define PACKET_BUF_SIZE 300
  
! // this combination works for HDTV 
! //#define DVB_BUF_SIZE   (64*1024)  
  //#define PACKET_BUF_SIZE 2000
  
--- 29,44 ----
  
  #define DEFAULT_FRAMETIME 400   // for PAL in 0.1ms
! #define MIN_BUF_SIZE  (16*1024)
  
  // this combination gives good results when seeking
! #define DVB_BUF_SIZE   (32*1024)
  #define PACKET_BUF_SIZE 150
  
! // this combination is save
! //#define DVB_BUF_SIZE   (64*1024)
  //#define PACKET_BUF_SIZE 300
  
! // this combination works for HDTV
! //#define DVB_BUF_SIZE   (64*1024)
  //#define PACKET_BUF_SIZE 2000
  
***************
*** 49,62 ****
  #define SOFTDEVICE_VIDEO_STREAM  1
  #define SOFTDEVICE_AUDIO_STREAM  2
! #define SOFTDEVICE_BOTH_STREAMS (SOFTDEVICE_VIDEO_STREAM | SOFTDEVICE_AUDIO_STREAM ) 
  
  
! class cAudioStreamDecoder; 
! class cVideoStreamDecoder; 
  
  // -----------------cClock --------------------------------------------
  class cClock {
  private:
!     
      static int64_t audioOffset;
      static int64_t audioPTS;
--- 49,62 ----
  #define SOFTDEVICE_VIDEO_STREAM  1
  #define SOFTDEVICE_AUDIO_STREAM  2
! #define SOFTDEVICE_BOTH_STREAMS (SOFTDEVICE_VIDEO_STREAM | SOFTDEVICE_AUDIO_STREAM )
  
  
! class cAudioStreamDecoder;
! class cVideoStreamDecoder;
  
  // -----------------cClock --------------------------------------------
  class cClock {
  private:
! 
      static int64_t audioOffset;
      static int64_t audioPTS;
***************
*** 71,75 ****
  
      static int64_t GetTime()
!     {  
        struct timeval tv;
        struct timezone tz;
--- 71,75 ----
  
      static int64_t GetTime()
!     {
        struct timeval tv;
        struct timezone tz;
***************
*** 77,88 ****
        return tv.tv_sec*10000+tv.tv_usec/100;
      };
!     
      static inline void AdjustAudioPTS(int64_t aPTS) {
!       if (aPTS) 
          audioOffset=aPTS-GetTime();
        else audioOffset=0;
        audioPTS=aPTS;
      };
!      
      static inline void AdjustVideoPTS(int64_t vPTS) {
        if (vPTS)
--- 77,88 ----
        return tv.tv_sec*10000+tv.tv_usec/100;
      };
! 
      static inline void AdjustAudioPTS(int64_t aPTS) {
!       if (aPTS)
          audioOffset=aPTS-GetTime();
        else audioOffset=0;
        audioPTS=aPTS;
      };
! 
      static inline void AdjustVideoPTS(int64_t vPTS) {
        if (vPTS)
***************
*** 91,95 ****
        videoPTS=vPTS;
      };
!    
      static inline void SetFreezeMode(bool FreezeMode) {
        freezeMode=FreezeMode;
--- 91,95 ----
        videoPTS=vPTS;
      };
! 
      static inline void SetFreezeMode(bool FreezeMode) {
        freezeMode=FreezeMode;
***************
*** 97,101 ****
  
      int64_t GetPTS();
! };	
  
  // -----------------cPacketQueue -----------------------------------------
--- 97,101 ----
  
      int64_t GetPTS();
! };
  
  // -----------------cPacketQueue -----------------------------------------
***************
*** 107,116 ****
      int FirstPacket,LastPacket;
  
!     inline int Next(int Packet) 
      { return (Packet+1)%MaxPackets; };
  
      cSigTimer EnablePut;
      cSigTimer EnableGet;
!     
  public:
      cPacketQueue(int maxPackets=PACKET_BUF_SIZE);
--- 107,116 ----
      int FirstPacket,LastPacket;
  
!     inline int Next(int Packet)
      { return (Packet+1)%MaxPackets; };
  
      cSigTimer EnablePut;
      cSigTimer EnableGet;
! 
  public:
      cPacketQueue(int maxPackets=PACKET_BUF_SIZE);
***************
*** 121,125 ****
      inline void EnablePutSignal()
      { EnablePut.Signal();};
!     
      AVPacket * GetReadPacket();
      void FreeReadPacket(AVPacket *Packet);
--- 121,125 ----
      inline void EnablePutSignal()
      { EnablePut.Signal();};
! 
      AVPacket * GetReadPacket();
      void FreeReadPacket(AVPacket *Packet);
***************
*** 136,140 ****
  class cSoftRingBufferLinear : public cRingBufferLinear {
  public:
!   cSoftRingBufferLinear(int Size, int Margin = 0, bool Statistics = false) 
       : cRingBufferLinear(Size,Margin,Statistics) {};
    ~cSoftRingBufferLinear() {};
--- 136,140 ----
  class cSoftRingBufferLinear : public cRingBufferLinear {
  public:
!   cSoftRingBufferLinear(int Size, int Margin = 0, bool Statistics = false)
       : cRingBufferLinear(Size,Margin,Statistics) {};
    ~cSoftRingBufferLinear() {};
***************
*** 164,168 ****
      volatile bool     active;
      bool              running;
!     
      virtual void      Action(void);
      virtual int       DecodePacket(AVPacket *pkt) = 0;
--- 164,168 ----
      volatile bool     active;
      bool              running;
! 
      virtual void      Action(void);
      virtual int       DecodePacket(AVPacket *pkt) = 0;
***************
*** 181,185 ****
      void              resetCodec(void);
      virtual uint64_t  GetPTS()  {return pts;};
!     
      cStreamDecoder(AVCodecContext * Context, bool packetMode);
      virtual ~cStreamDecoder();
--- 181,185 ----
      void              resetCodec(void);
      virtual uint64_t  GetPTS()  {return pts;};
! 
      cStreamDecoder(AVCodecContext * Context, bool packetMode);
      virtual ~cStreamDecoder();
***************
*** 201,204 ****
--- 201,207 ----
      // copy right data to left channel
  
+     bool UpmixMono(uint8_t *samples, int Length);
+     // upmix mono channel to stereo
+ 
  protected:
  public:
***************
*** 242,251 ****
  
      // A-V syncing stuff
!     int                hurry_up; 
      int                offset;
      int                delay;
      int                trickspeed;
      int                default_frametime;
!     inline int frametime() 
      {return trickspeed*default_frametime;};
  
--- 245,254 ----
  
      // A-V syncing stuff
!     int                hurry_up;
      int                offset;
      int                delay;
      int                trickspeed;
      int                default_frametime;
!     inline int frametime()
      {return trickspeed*default_frametime;};
  
***************
*** 284,288 ****
      bool decoding;
      bool freezeMode;
!     
      AVFormatContext *ic;
      int LastSize;
--- 287,291 ----
      bool decoding;
      bool freezeMode;
! 
      AVFormatContext *ic;
      int LastSize;
***************
*** 320,324 ****
      ~cMpeg2Decoder();
  
!     void QueuePacket(const AVFormatContext *ic,AVPacket &pkt, 
  		    bool PacketMode);
      void ResetDecoder( int Stream = SOFTDEVICE_BOTH_STREAMS );
--- 323,327 ----
      ~cMpeg2Decoder();
  
!     void QueuePacket(const AVFormatContext *ic,AVPacket &pkt,
  		    bool PacketMode);
      void ResetDecoder( int Stream = SOFTDEVICE_BOTH_STREAMS );
***************
*** 333,337 ****
      void Resume(void);
      void TrickSpeed(int Speed);
!    
      void SetPlayMode(softPlayMode playMode, bool packetMode);
      void PlayAudioVideo(bool playAudio,bool playVideo)
--- 336,340 ----
      void Resume(void);
      void TrickSpeed(int Speed);
! 
      void SetPlayMode(softPlayMode playMode, bool packetMode);
      void PlayAudioVideo(bool playAudio,bool playVideo)
***************
*** 339,349 ****
        VideoIdx=playVideo?NO_STREAM:DONT_PLAY;}
  
!     void SetAudioMode(int AudioMode); 
      inline int GetAudioMode()
      { return audioMode; };
!     
      int BufferFill( int Stream = SOFTDEVICE_BOTH_STREAMS );
!     // in percent 
!     
      int64_t GetSTC(void);
  };
--- 342,352 ----
        VideoIdx=playVideo?NO_STREAM:DONT_PLAY;}
  
!     void SetAudioMode(int AudioMode);
      inline int GetAudioMode()
      { return audioMode; };
! 
      int BufferFill( int Stream = SOFTDEVICE_BOTH_STREAMS );
!     // in percent
! 
      int64_t GetSTC(void);
  };



From nobody at sheep.berlios.de  Mon Apr 17 22:06:06 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 17 Apr 2006 22:06:06 +0200
Subject: [Softdevice-cvs] softdevice SoftOsd.c,1.11,1.12 CHANGELOG,1.169,1.170
Message-ID: <200604172006.k3HK66t32181@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14917

Modified Files:
	SoftOsd.c CHANGELOG 
Log Message:
- cut away left- and rightmost columns


Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** SoftOsd.c	12 Mar 2006 11:41:50 -0000	1.11
--- SoftOsd.c	17 Apr 2006 20:06:30 -0000	1.12
***************
*** 827,830 ****
--- 827,834 ----
                      int dest_Width, int dest_Height, bool RefreshAll) {
          OSDDEB("CopyToBitmap destsize: %d,%d\n",dest_Width,dest_Height);
+         if (dest_Height & 0x1 !=0) {
+                 printf("warning dest_Height not even!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
+                 dest_Height &= ~0x1;
+         };
          if (dest_Height==OSD_HEIGHT)
                  NoVScaleCopyToBitmap(PY,PU,PV,PAlphaY,PAlphaUV,Ystride,UVstride,
***************
*** 1074,1081 ****
  		//printf("Copy to destination y: %d\n",y);
  		buf=dest+y*linesize;
! 		(*OutputConvert)(buf,tmp_pixmap,dest_Width);
                  if (pixelMask)
                          CreatePixelMask(pixelMask+y*linesize/16,
!                                         tmp_pixmap,dest_Width);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
--- 1078,1085 ----
  		//printf("Copy to destination y: %d\n",y);
  		buf=dest+y*linesize;
! 		(*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2);
                  if (pixelMask)
                          CreatePixelMask(pixelMask+y*linesize/16,
!                                         tmp_pixmap+1,dest_Width-2);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
***************
*** 1087,1094 ****
  			y++;
  			buf=dest+y*linesize;
! 			(*OutputConvert)(buf,(color*)src,dest_Width);
                          if (pixelMask)
                                  CreatePixelMask(pixelMask+y*linesize/16,
!                                                 tmp_pixmap,dest_Width);
                          if (dest_dirtyLines)
                                  dest_dirtyLines[y]=true;
--- 1091,1098 ----
  			y++;
  			buf=dest+y*linesize;
! 			(*OutputConvert)(buf,((color*)src)+1,dest_Width-2);
                          if (pixelMask)
                                  CreatePixelMask(pixelMask+y*linesize/16,
!                                                 ((color*)src)+1,dest_Width-2);
                          if (dest_dirtyLines)
                                  dest_dirtyLines[y]=true;
***************
*** 1166,1173 ****
                  buf=dest+y*linesize;
                  //printf("copy to destination %d\n",y);
!                 (*OutputConvert)(buf,tmp_pixmap,dest_Width);
                  if (pixelMask)
                          CreatePixelMask(pixelMask+y*linesize/16,
!                                         tmp_pixmap,dest_Width);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
--- 1170,1177 ----
                  buf=dest+y*linesize;
                  //printf("copy to destination %d\n",y);
!                 (*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2);
                  if (pixelMask)
                          CreatePixelMask(pixelMask+y*linesize/16,
!                                         tmp_pixmap+1,dest_Width-2);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.169
retrieving revision 1.170
diff -C2 -d -r1.169 -r1.170
*** CHANGELOG	14 Apr 2006 21:25:44 -0000	1.169
--- CHANGELOG	17 Apr 2006 20:06:30 -0000	1.170
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-04-17:
+    - cut away the left- and rightmost column of the osd
  2006-04-14:
     - Expand top/bottom line and left/right coloumns (from vdr-portal).



From nobody at sheep.berlios.de  Fri Apr 21 07:47:04 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 21 Apr 2006 07:47:04 +0200
Subject: [Softdevice-cvs] softdevice i18n.c,1.18,1.19
Message-ID: <200604210547.k3L5l4t29477@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31226

Modified Files:
	i18n.c 
Log Message:
updated finnish translations (by Rolf Ahrenberg)

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** i18n.c	14 Apr 2006 18:56:34 -0000	1.18
--- i18n.c	21 Apr 2006 05:47:24 -0000	1.19
***************
*** 1030,1034 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",//  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 1030,1034 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Zoomauskerroin",//  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 1053,1057 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",//  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 1053,1057 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Zoomauksen siirto (vasen/oikea)",//  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 1076,1080 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",//  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 1076,1080 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Zoomauksen siirto (yl?s/alas)",//  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 1099,1103 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",//  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 1099,1103 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Levit? laitimmaiset rivit",//  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 1122,1126 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",//  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 1122,1126 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Levit? reunimmaiset sarakkeet",//  9
      "",             // 10 TODO
      "",             // 11 TODO



From nobody at sheep.berlios.de  Fri Apr 21 08:46:47 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 21 Apr 2006 08:46:47 +0200
Subject: [Softdevice-cvs] softdevice video.h,1.32,1.33 video.c,1.48,1.49 video-dfb.h,1.17,1.18 video-dfb.c,1.52,1.53
Message-ID: <200604210646.k3L6klt31208@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17466

Modified Files:
	video.h video.c video-dfb.h video-dfb.c 
Log Message:
video-dfb: fix for crash at startup when software OSD blending was active

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** video.h	14 Apr 2006 18:56:34 -0000	1.32
--- video.h	21 Apr 2006 06:47:10 -0000	1.33
***************
*** 123,126 ****
--- 123,128 ----
      double  parValues[MAX_PAR];
  
+     bool    videoInitialized;
+ 
      AVFrame *old_picture;
      int     old_width, old_height;

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** video.c	14 Apr 2006 18:56:34 -0000	1.48
--- video.c	21 Apr 2006 06:47:10 -0000	1.49
***************
*** 47,50 ****
--- 47,51 ----
    this->setupStore=setupStore;
    freezeMode=false;
+   videoInitialized = false;
    old_picture = NULL;
  

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-dfb.h	18 Feb 2006 22:20:29 -0000	1.17
--- video-dfb.h	21 Apr 2006 06:47:10 -0000	1.18
***************
*** 43,46 ****
--- 43,47 ----
            clearBackground,
            fieldParity;
+     int   prevOsdMode;
  
      void SetParams();

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** video-dfb.c	14 Apr 2006 18:56:34 -0000	1.52
--- video-dfb.c	21 Apr 2006 06:47:10 -0000	1.53
***************
*** 295,298 ****
--- 295,300 ----
    screenPixelAspect = -1;
    currentPixelFormat = setupStore->pixelFormat;
+   prevOsdMode = setupStore->osdMode;
+   setupStore->osdMode = 0;
    isVIAUnichrome = false;
    clearAlpha = 0x00;
***************
*** 626,629 ****
--- 628,633 ----
      dfbRemote->DFBRemoteStart();
    }
+   videoInitialized = true;
+ 
    return true;
  }
***************
*** 994,997 ****
--- 998,1004 ----
      IDirectFBSurface  *tmpSurface;
  
+   if (!videoInitialized)
+     return;
+ 
    cVideoOut::OpenOSD();
    try
***************
*** 1016,1019 ****
--- 1023,1029 ----
      IDirectFBSurface  *tmpSurface;
  
+   if (!videoInitialized)
+     return;
+ 
    try
    {
***************
*** 1032,1039 ****
   */
  void cDFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                                      bool *&DirtyLines) {
    int               pitch;
    uint8_t           *dst;
  
    try
    {
--- 1042,1057 ----
   */
  void cDFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                                      bool *&DirtyLines)
! {
    int               pitch;
    uint8_t           *dst;
  
+   dirtyLines = DirtyLines = NULL;
+   osd = NULL;
+   stride = 0;
+ 
+   if (!videoInitialized)
+     return;
+ 
    try
    {
***************
*** 1055,1060 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::CommitUnlockOsdSurface() {
!   if (!tmpOsdSurface)
      return;
  
--- 1073,1079 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::CommitUnlockOsdSurface()
! {
!   if (!videoInitialized || !dirtyLines || !tmpOsdSurface)
      return;
  
***************
*** 1233,1236 ****
--- 1252,1258 ----
      IDirectFBSurface  *tmpSurface;
  
+   if (!videoInitialized)
+     return;
+ 
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
***************
*** 1266,1269 ****
--- 1288,1294 ----
      IDirectFBSurface  *tmpSurface;
  
+   if (!videoInitialized)
+     return;
+ 
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
***************
*** 1301,1304 ****
--- 1326,1332 ----
  void cDFBVideoOut::ShowOSD ()
  {
+   if (!videoInitialized)
+     return;
+ 
    if (useStretchBlit && (OSDpresent || osdClrBack)) {
      // do image and OSD mix here
***************
*** 1358,1361 ****
--- 1386,1392 ----
      int hi;
  
+   if (!videoInitialized)
+     return;
+ 
    events_not_done = 0;
    SetParams();
***************
*** 1514,1517 ****
--- 1545,1550 ----
  {
    fprintf(stderr,"Releasing DFB\n");
+ 
+   setupStore->osdMode = prevOsdMode;
  
    if (videoSurface) videoSurface->Release();



From nobody at sheep.berlios.de  Fri Apr 21 08:48:34 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 21 Apr 2006 08:48:34 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.170,1.171
Message-ID: <200604210648.k3L6mYt31265@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18150

Modified Files:
	CHANGELOG 
Log Message:
update of CHANGELOG

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.170
retrieving revision 1.171
diff -C2 -d -r1.170 -r1.171
*** CHANGELOG	17 Apr 2006 20:06:30 -0000	1.170
--- CHANGELOG	21 Apr 2006 06:48:58 -0000	1.171
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-04-21:
+    - updated finnish translations (by Rolf Ahrenberg)
+    - video-dfb: fix for crash at startup when software OSD blending was active
  2006-04-17:
     - cut away the left- and rightmost column of the osd



From nobody at sheep.berlios.de  Fri Apr 21 20:14:22 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 21 Apr 2006 20:14:22 +0200
Subject: [Softdevice-cvs] softdevice README,1.16,1.17
Message-ID: <200604211814.k3LIEMt09966@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11969

Modified Files:
	README 
Log Message:
some more OSD comments

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** README	14 Apr 2006 18:56:34 -0000	1.16
--- README	21 Apr 2006 18:14:42 -0000	1.17
***************
*** 133,141 ****
  ------------------
    Cropping:
    Post processing:
    Video out:
  
!   XV startup aspect
      Possible values: 4:3 normal, 16:9 wide
  
    Screen aspect
--- 133,154 ----
  ------------------
    Cropping:
+ 
    Post processing:
+ 
    Video out:
+     Output methods : X11-XV
+     The following subselections are available if the driver of
+     current video card supports it:
  
!     Brightness, Contrast, Hue, Saturation:
!       Possible Values: 0 .. 100
!       Center and default value of all is 50.
! 
!   Xv startup aspect
!     Output methods : X11-XV
      Possible values: 4:3 normal, 16:9 wide
+     You may choose the startup window aspect for next time starting
+     vdr. It either in 4:3 format with video size of 768x576 or a
+     in 16:9 format with size of 1024x576 .
  
    Screen aspect
***************
*** 143,146 ****
--- 156,160 ----
  
    OSD alpha blending
+     Output methods : X11-XV, Vidix
      Possible values: pseudo, software
  
***************
*** 158,162 ****
                       5.1 Analog (4CH), 5.1 Analog (6CH)
      This specifies what should be done when we get AC3 audio frames.
!     When set to 5.1 S/P-DIF no software decoding is used. AC3 frames
      are passed directly from your sound card to your audio processing
      equipment.
--- 172,176 ----
                       5.1 Analog (4CH), 5.1 Analog (6CH)
      This specifies what should be done when we get AC3 audio frames.
!     When set to 5.1 S/P-DIF no software decoding is done. AC3 frames
      are passed directly from your sound card to your audio processing
      equipment.
***************
*** 172,177 ****
      this option.
  
    Hide main menu entry
!     Possible values: yes, no .
      When set to yes, softdevice setup menu is not shown in vdr's main
      menu. Softdevice developers usually set this to no, normal end user
--- 186,199 ----
      this option.
  
+   Pixel Format
+     Output methods : DirectFB, Vidix
+     Possible Values: YV12, I420, YUY2
+ 
+   Use StretchBlit
+     Output methods : DirectFB
+     Possible Values: off, on
+ 
    Hide main menu entry
!     Possible values: yes, no
      When set to yes, softdevice setup menu is not shown in vdr's main
      menu. Softdevice developers usually set this to no, normal end user



From nobody at sheep.berlios.de  Fri Apr 21 20:20:22 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 21 Apr 2006 20:20:22 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.171,1.172 video-xv.c,1.50,1.51 video-xv.h,1.18,1.19
Message-ID: <200604211820.k3LIKMt10350@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14182

Modified Files:
	CHANGELOG video-xv.c video-xv.h 
Log Message:
initialized => videoInitialized

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.171
retrieving revision 1.172
diff -C2 -d -r1.171 -r1.172
*** CHANGELOG	21 Apr 2006 06:48:58 -0000	1.171
--- CHANGELOG	21 Apr 2006 18:20:45 -0000	1.172
***************
*** 1,6 ****
  Changelog
  2006-04-21:
!    - updated finnish translations (by Rolf Ahrenberg)
!    - video-dfb: fix for crash at startup when software OSD blending was active
  2006-04-17:
     - cut away the left- and rightmost column of the osd
--- 1,7 ----
  Changelog
  2006-04-21:
!    - updated finnish translations (by Rolf Ahrenberg).
!    - video-dfb: fix for crash at startup when software OSD blending was active.
!    - video-xv: changed local flag initialized to videoInitialized of our super class.
  2006-04-17:
     - cut away the left- and rightmost column of the osd

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** video-xv.c	14 Apr 2006 15:56:17 -0000	1.50
--- video-xv.c	21 Apr 2006 18:20:45 -0000	1.51
***************
*** 29,33 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2006-02-05"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 29,33 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2006-04-21"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 728,732 ****
          EVDEB("MapNotify\n");
          map_count++;
!         if (initialized) {
            XSetInputFocus(dpy,
                     win,
--- 728,732 ----
          EVDEB("MapNotify\n");
          map_count++;
!         if (videoInitialized) {
            XSetInputFocus(dpy,
                     win,
***************
*** 781,785 ****
    OSDpresent = false;
    OSDpseudo_alpha = true;
-   initialized = 0;
    toggleInProgress = 0;
    xv_initialized=false;
--- 781,784 ----
***************
*** 1011,1018 ****
            if (osd_image) {
                    dsyslog("[XvVideoOut]: Initialize XGetImage Successful (%p)", osd_image);
! 		  osd_buffer = (unsigned char *) osd_image->data;
            } else {
                    dsyslog("[XvVideoOut]: Initialize ERROR: XGetImage FAILED !");
! 		  osd_buffer = NULL;
            }
    };
--- 1010,1017 ----
            if (osd_image) {
                    dsyslog("[XvVideoOut]: Initialize XGetImage Successful (%p)", osd_image);
! 		              osd_buffer = (unsigned char *) osd_image->data;
            } else {
                    dsyslog("[XvVideoOut]: Initialize ERROR: XGetImage FAILED !");
! 		              osd_buffer = NULL;
            }
    };
***************
*** 1071,1075 ****
  
    pthread_mutex_unlock(&xv_mutex);
!   initialized=true;
    return true;
  }
--- 1070,1074 ----
  
    pthread_mutex_unlock(&xv_mutex);
!   videoInitialized = true;
    return true;
  }
***************
*** 1260,1264 ****
    pthread_mutex_unlock(&xv_mutex);
  
!   initialized = 1;
    xv_initialized = 1;
    return true;
--- 1259,1263 ----
    pthread_mutex_unlock(&xv_mutex);
  
!   videoInitialized = true;
    xv_initialized = 1;
    return true;
***************
*** 1455,1459 ****
    }
  #endif
!   if (initialized)
    {
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
--- 1454,1458 ----
    }
  #endif
!   if (videoInitialized)
    {
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
***************
*** 1473,1477 ****
  {
    cVideoOut::ClearOSD();
!   if (initialized && current_osdMode==OSDMODE_PSEUDO) {
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
--- 1472,1476 ----
  {
    cVideoOut::ClearOSD();
!   if (videoInitialized && current_osdMode==OSDMODE_PSEUDO) {
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
***************
*** 1529,1541 ****
   */
  void cXvVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines) {
          osd=osd_buffer;
          stride=osd_image->bytes_per_line;
          dirtyLines=NULL;
! };
  
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::CommitUnlockOsdSurface() {
          cVideoOut::CommitUnlockOsdSurface();
          pthread_mutex_lock(&xv_mutex);
--- 1528,1550 ----
   */
  void cXvVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines)
! {
!         osd = NULL;
! 
!         if (!videoInitialized)
!                 return;
! 
          osd=osd_buffer;
          stride=osd_image->bytes_per_line;
          dirtyLines=NULL;
! }
  
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::CommitUnlockOsdSurface()
! {
!         if (!videoInitialized)
!                 return;
! 
          cVideoOut::CommitUnlockOsdSurface();
          pthread_mutex_lock(&xv_mutex);
***************
*** 1543,1547 ****
          XSync(dpy, False);
          pthread_mutex_unlock(&xv_mutex);
! };
  /*
  void cXvVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
--- 1552,1557 ----
          XSync(dpy, False);
          pthread_mutex_unlock(&xv_mutex);
! }
! 
  /*
  void cXvVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
***************
*** 1549,1553 ****
    // refreshes the screen
    // copy video Data
!   if (!initialized)
      return;
  //  if (OSDpresent)
--- 1559,1563 ----
    // refreshes the screen
    // copy video Data
!   if (!videoInitialized)
      return;
  //  if (OSDpresent)
***************
*** 1579,1583 ****
    // refreshes the screen
    // copy video Data
!   if (!initialized)
      return;
    //if (OSDpresent)
--- 1589,1593 ----
    // refreshes the screen
    // copy video Data
!   if (!videoInitialized)
      return;
    //if (OSDpresent)
***************
*** 1663,1667 ****
                        int Ystride, int UVstride)
  {
!   if (!initialized || !xv_initialized)
      return;
  
--- 1673,1677 ----
                        int Ystride, int UVstride)
  {
!   if (!videoInitialized || !xv_initialized)
      return;
  
***************
*** 1764,1768 ****
  cXvVideoOut::~cXvVideoOut()
  {
!   if (!initialized)
      return;
  
--- 1774,1778 ----
  cXvVideoOut::~cXvVideoOut()
  {
!   if (!videoInitialized)
      return;
  
***************
*** 1805,1809 ****
      osd_image = NULL;
    }
!   initialized = 0;
    pthread_mutex_unlock(&xv_mutex);
  
--- 1815,1819 ----
      osd_image = NULL;
    }
!   videoInitialized = false;
    pthread_mutex_unlock(&xv_mutex);
  

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-xv.h	14 Apr 2006 15:56:17 -0000	1.18
--- video-xv.h	21 Apr 2006 18:20:45 -0000	1.19
***************
*** 113,122 ****
                      net_wm_STATE_ABOVE,
                      net_wm_STATE;
!   int               initialized,
!                     toggleInProgress,
                      xv_initialized,
                      /* -------------------------------------------------------
!                         * could be specified via argv or parameters
!                         */
                      xvWidth, xvHeight,
                      width, height,
--- 113,121 ----
                      net_wm_STATE_ABOVE,
                      net_wm_STATE;
!   int               toggleInProgress,
                      xv_initialized,
                      /* -------------------------------------------------------
!                      * could be specified via argv or parameters
!                      */
                      xvWidth, xvHeight,
                      width, height,



From nobody at sheep.berlios.de  Sun Apr 23 17:58:24 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Apr 2006 17:58:24 +0200
Subject: [Softdevice-cvs] softdevice audio.c,1.23,1.24 audio.h,1.9,1.10 CHANGELOG,1.172,1.173
Message-ID: <200604231558.k3NFwOt21193@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19169

Modified Files:
	audio.c audio.h CHANGELOG 
Log Message:
- added volume changing with changing the mixer setting ( to use it add 
  -DNO_MIXER, currently experimental
	


Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** audio.c	7 Jan 2006 13:20:24 -0000	1.23
--- audio.c	23 Apr 2006 15:58:49 -0000	1.24
***************
*** 55,58 ****
--- 55,59 ----
      oldContext.samplerate = currContext.samplerate=48000;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
+     volume=255;
  }
  
***************
*** 92,95 ****
--- 93,107 ----
  /* ----------------------------------------------------------------------------
   */
+ 
+ void Scale(int16_t *Data, int size,int Volume) 
+ {
+   while (size>0) {
+     register int32_t tmp=(int32_t)(*Data) * Volume;
+     *Data=(int16_t) (tmp>>8);
+     Data++;
+     size--;
+   };
+ };
+   
  void cAlsaAudioOut::Write(uchar *Data, int Length)
  {
***************
*** 112,115 ****
--- 124,132 ----
      size = Length/(2*currContext.channels);
  
+ #ifdef NO_MIXER
+   // change the volume
+   Scale((int16_t*)Data,Length/2,volume);
+ #endif
+ 
    while (size) {
      while (paused) usleep(1000); // block
***************
*** 389,392 ****
--- 406,412 ----
  void cAlsaAudioOut::SetVolume (int vol)
  {
+ #ifdef NO_MIXER
+   volume = vol;
+ #else
      int                   err;
      long                  mixerMin, mixerMax,
***************
*** 434,437 ****
--- 454,458 ----
  
    snd_mixer_close(mHandle);
+ #endif
  }
  

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** audio.h	6 Oct 2005 21:28:11 -0000	1.9
--- audio.h	23 Apr 2006 15:58:49 -0000	1.10
***************
*** 64,67 ****
--- 64,68 ----
    bool  SetAC3PassThroughMode(bool on);
    void  Xrun(void);
+   int volume;
  
  protected:

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.172
retrieving revision 1.173
diff -C2 -d -r1.172 -r1.173
*** CHANGELOG	21 Apr 2006 18:20:45 -0000	1.172
--- CHANGELOG	23 Apr 2006 15:58:49 -0000	1.173
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-04-23:
+    - added volume changing with changing the  mixer control ( to use it add 
+      -DNO_MIXER, currently experimental
  2006-04-21:
     - updated finnish translations (by Rolf Ahrenberg).



From nobody at sheep.berlios.de  Sun Apr 23 19:55:48 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 23 Apr 2006 19:55:48 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.173,1.174 Makefile,1.25,1.26 softdevice.c,1.55,1.56
Message-ID: <200604231755.k3NHtmt27726@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30163

Modified Files:
	CHANGELOG Makefile softdevice.c 
Log Message:
fix for vdr-1.3.48

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.173
retrieving revision 1.174
diff -C2 -d -r1.173 -r1.174
*** CHANGELOG	23 Apr 2006 15:58:49 -0000	1.173
--- CHANGELOG	23 Apr 2006 17:56:09 -0000	1.174
***************
*** 1,6 ****
  Changelog
  2006-04-23:
!    - added volume changing with changing the  mixer control ( to use it add 
       -DNO_MIXER, currently experimental
  2006-04-21:
     - updated finnish translations (by Rolf Ahrenberg).
--- 1,7 ----
  Changelog
  2006-04-23:
!    - added volume changing with changing the  mixer control ( to use it add
       -DNO_MIXER, currently experimental
+    - fix for vdr-1.3.48
  2006-04-21:
     - updated finnish translations (by Rolf Ahrenberg).

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** Makefile	1 Apr 2006 09:33:41 -0000	1.25
--- Makefile	23 Apr 2006 17:56:12 -0000	1.26
***************
*** 200,203 ****
--- 200,212 ----
  
  VDRVERSION = $(shell grep 'define VDRVERSION ' $(VDRDIR)/config.h | awk '{ print $$3 }' | sed -e 's/"//g')
+ APIVERSION = $(shell sed -ne '/define APIVERSION/ { s/^.*"\(.*\)".*$$/\1/; p }' $(VDRDIR)/config.h)
+ 
+ INST_VERSION = $(APIVERSION)
+ 
+ ifeq ($(APIVERSION),)
+ 	INST_VERSION = $(VDRVERSION)
+ endif
+ 
+ #DUMMY=$(LIBDIR)/fake.vdr.Makefile.check.$(APIVERSION)
  
  ### The name of the distribution archive:
***************
*** 298,302 ****
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  ifdef USE_SUBPLUGINS
--- 307,311 ----
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  ifdef USE_SUBPLUGINS
***************
*** 304,324 ****
  libsubvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  libsubvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  libsubvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  libsubvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  libsubvdr-$(PLUGIN)-shm.so: $(SHM_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  endif
--- 313,333 ----
  libsubvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  libsubvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  libsubvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  libsubvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  libsubvdr-$(PLUGIN)-shm.so: $(SHM_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  endif

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.55
retrieving revision 1.56
diff -C2 -d -r1.55 -r1.56
*** softdevice.c	14 Apr 2006 18:56:34 -0000	1.55
--- softdevice.c	23 Apr 2006 17:56:12 -0000	1.56
***************
*** 298,301 ****
--- 298,309 ----
      char  *subPluginFileName = NULL;
  
+ #ifdef APIVERSION
+   asprintf (&subPluginFileName,
+             "%s/%s%s.so.%s",
+             pluginPath,
+             "libsubvdr-softdevice-",
+             outMethodName,
+             APIVERSION);
+ #else
    asprintf (&subPluginFileName,
              "%s/%s%s.so.%s",
***************
*** 304,307 ****
--- 312,316 ----
              outMethodName,
              VDRVERSION);
+ #endif
    void *handle = dlopen (subPluginFileName, RTLD_NOW);
    char *err = dlerror();



From nobody at sheep.berlios.de  Sun Apr 23 21:38:06 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Apr 2006 21:38:06 +0200
Subject: [Softdevice-cvs] softdevice video-xv.c,1.51,1.52 video-xv.h,1.19,1.20 video-dfb.c,1.53,1.54 video-dfb.h,1.18,1.19 video.c,1.49,1.50 video.h,1.33,1.34
Message-ID: <200604231938.k3NJc6t31264@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17358

Modified Files:
	video-xv.c video-xv.h video-dfb.c video-dfb.h video.c video.h 
Log Message:
- remove duplicate remote code, call ProcessEvents() from the video thread
  and remove the RC thread   


Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** video-xv.c	21 Apr 2006 18:20:45 -0000	1.51
--- video-xv.c	23 Apr 2006 19:38:29 -0000	1.52
***************
*** 20,27 ****
  #include <stdio.h>
  #include <math.h>
  #include <sys/mman.h>
  #include <sys/ioctl.h>
  #include <fcntl.h>
! #include <vdr/plugin.h>
  #include "video-xv.h"
  #include "xscreensaver.h"
--- 20,28 ----
  #include <stdio.h>
  #include <math.h>
+ #include <string.h>
  #include <sys/mman.h>
  #include <sys/ioctl.h>
  #include <fcntl.h>
! //#include <vdr/plugin.h>
  #include "video-xv.h"
  #include "xscreensaver.h"
***************
*** 32,38 ****
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
! cXvRemote        *xvRemote = NULL;
  static cScreensaver     *xScreensaver = NULL;
- static int              events_not_done = 0;
  
  static XErrorHandler old_handler = 0;
--- 33,38 ----
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
! cSoftRemote        *xvRemote = NULL;
  static cScreensaver     *xScreensaver = NULL;
  
  static XErrorHandler old_handler = 0;
***************
*** 312,374 ****
      XSync(dpy,False);
  }
- 
- /* ---------------------------------------------------------------------------
-  */
- cXvRemote::cXvRemote(const char *Name, cXvVideoOut *vout) : cRemote(Name)
- {
-   video_out = vout;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- cXvRemote::~cXvRemote()
- {
-   active = false;
-   Cancel(2);
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cXvRemote::PutKey(KeySym key)
- {
-   Put (key);
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cXvRemote::Action(void)
- {
-   dsyslog("Xv remote control thread started (pid=%d)", getpid());
-   active = true;
-   while (active)
-   {
-     usleep (25000);
-     pthread_mutex_lock(&xv_mutex);
-     if (events_not_done > 2) {
-       video_out->ProcessEvents ();
-       events_not_done = 0;
-     } else {
-       events_not_done++;
-     }
-     pthread_mutex_unlock(&xv_mutex);
-   }
-   dsyslog("Xv remote control thread ended (pid=%d)", getpid());
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cXvRemote::SetX11Info(Display *d, Window w)
- {
-   dpy = d;
-   win = w;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cXvRemote::XvRemoteStart(void)
- {
-   Start();
- }
- 
  /* ---------------------------------------------------------------------------
   */
--- 312,315 ----
***************
*** 587,590 ****
--- 528,537 ----
      struct timeval  current_time;
      XEvent            event;
+     
+   pthread_mutex_lock(&xv_mutex);
+   if (!videoInitialized) {
+           pthread_mutex_unlock(&xv_mutex);
+           return;
+   };
  
    while (XCheckMaskEvent (dpy, /* win, */
***************
*** 772,775 ****
--- 719,723 ----
    }
    xScreensaver->MaybeSendDeactivate();
+   pthread_mutex_unlock(&xv_mutex);  
  }
  
***************
*** 1056,1062 ****
    if (!xvRemote)
    {
!     xvRemote = new cXvRemote ("softdevice-xv", this);
!     xvRemote->SetX11Info(dpy,win);
!     xvRemote->XvRemoteStart();
    }
  
--- 1004,1008 ----
    if (!xvRemote)
    {
!     xvRemote = new cSoftRemote ("softdevice-xv");
    }
  
***************
*** 1766,1771 ****
    }
    PutXvImage();
!   ProcessEvents ();
!   events_not_done = 0;
    XSync(dpy, False);
    pthread_mutex_unlock(&xv_mutex);
--- 1712,1716 ----
    }
    PutXvImage();
!   //ProcessEvents ();
    XSync(dpy, False);
    pthread_mutex_unlock(&xv_mutex);

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** video-xv.h	21 Apr 2006 18:20:45 -0000	1.19
--- video-xv.h	23 Apr 2006 19:38:29 -0000	1.20
***************
*** 22,28 ****
  #include <pthread.h>
  
- // ?? remote.h thread.h why previous without include
- #include <vdr/remote.h>
- #include <vdr/thread.h>
  
  #include <sys/ipc.h>
--- 22,25 ----
***************
*** 39,42 ****
--- 36,46 ----
  #endif
  
+ #ifndef STAND_ALONE
+ #include <vdr/remote.h>
+ #include <vdr/thread.h>
+ #else
+ #include "VdrReplacements.h"
+ #endif
+ 
  #define FOURCC_YV12       0x32315659   /* 4:2:0 Planar: Y + V + U  (3 planes) */
  #define FOURCC_I420       0x30323449   /* 4:2:0 Planar: Y + U + V  (3 planes) */
***************
*** 160,164 ****
    cXvVideoOut(cSetupStore *setupStore);
    virtual ~cXvVideoOut();
!   void ProcessEvents ();
    void ShowOSD ();
  
--- 164,168 ----
    cXvVideoOut(cSetupStore *setupStore);
    virtual ~cXvVideoOut();
!   virtual void ProcessEvents ();
    void ShowOSD ();
  
***************
*** 190,212 ****
  };
  
! /* ---------------------------------------------------------------------------
!  */
! class cXvRemote : public cRemote, private cThread {
!   private:
!     bool        active;
!     Display     *dpy;
!     Window      win;
!     cXvVideoOut *video_out;
! 
!     virtual void  Action(void);
!   public:
!                   cXvRemote(const char *Name, cXvVideoOut *vout);
!                   ~cXvRemote();
!     void          SetX11Info (Display *d, Window w);
!     void          XvRemoteStart (void);
!     virtual void  PutKey (KeySym key);
! //    virtual bool  Initialize(void);
! };
! extern cXvRemote        *xvRemote;
  
  #endif // VIDEO_XV_H
--- 194,198 ----
  };
  
! extern cSoftRemote        *xvRemote;
  
  #endif // VIDEO_XV_H

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** video-dfb.c	21 Apr 2006 06:47:10 -0000	1.53
--- video-dfb.c	23 Apr 2006 19:38:29 -0000	1.54
***************
*** 70,125 ****
    };
  
- static int              events_not_done = 0;
- 
- // --- cDFBRemote ---------------------------------------------------
- /* ---------------------------------------------------------------------------
-  */
- cDFBRemote::cDFBRemote(const char *Name, cDFBVideoOut *vout) : cRemote(Name)
- {
-   video_out = vout;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- cDFBRemote::~cDFBRemote()
- {
-   active = false;
-   Cancel(2);
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cDFBRemote::PutKey(DFBInputDeviceKeySymbol key, bool repeat)
- {
-   Put ((int) key, repeat, false);
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cDFBRemote::Action(void)
- {
-   dsyslog("DFB remote control thread started (pid=%d)", getpid());
-   active = true;
-   while (active)
-   {
-     usleep (25000);
-     if (events_not_done > 1) {
-       video_out->ProcessEvents ();
-       video_out->ShowOSD ();
-       events_not_done = 0;
-     } else {
-       events_not_done++;
-     }
-   }
-   dsyslog("DFB remote control thread ended (pid=%d)", getpid());
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cDFBRemote::DFBRemoteStart(void)
- {
-   Start();
- }
- 
  // --- cDFBVideoOut -------------------------------------------------
  IDirectFB *DFBWrapper;
--- 70,73 ----
***************
*** 625,630 ****
    if (!dfbRemote)
    {
!     dfbRemote = new cDFBRemote ("softdevice-dfb", this);
!     dfbRemote->DFBRemoteStart();
    }
    videoInitialized = true;
--- 573,577 ----
    if (!dfbRemote)
    {
!     dfbRemote = new cSoftRemote ("softdevice-dfb");
    }
    videoInitialized = true;
***************
*** 1389,1393 ****
      return;
  
-   events_not_done = 0;
    SetParams();
  
--- 1336,1339 ----
***************
*** 1536,1541 ****
      delete ex;
    }
!   ProcessEvents ();
!   events_not_done = 0;
  }
  
--- 1482,1487 ----
      delete ex;
    }
!   //ProcessEvents ();
!   //events_not_done = 0;
  }
  

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-dfb.h	21 Apr 2006 06:47:10 -0000	1.18
--- video-dfb.h	23 Apr 2006 19:38:29 -0000	1.19
***************
*** 21,25 ****
  #include <vdr/thread.h>
  
- class cDFBRemote;
  
  class cDFBVideoOut : public cVideoOut {
--- 21,24 ----
***************
*** 30,34 ****
  
      DFBSurfacePixelFormat pixelformat;
!     cDFBRemote            *dfbRemote;
  
      IDirectFBEventBuffer  *events;
--- 29,33 ----
  
      DFBSurfacePixelFormat pixelformat;
!     cSoftRemote            *dfbRemote;
  
      IDirectFBEventBuffer  *events;

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** video.c	21 Apr 2006 06:47:10 -0000	1.49
--- video.c	23 Apr 2006 19:38:29 -0000	1.50
***************
*** 10,19 ****
  #include <sys/ioctl.h>
  #include <fcntl.h>
! #include <vdr/plugin.h>
  #include "video.h"
  #include "utils.h"
  #include "setup-softdevice.h"
  #include "sync-timer.h"
- #include "SoftOsd.h"
  
  //#define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
--- 10,22 ----
  #include <sys/ioctl.h>
  #include <fcntl.h>
! #include <string.h>
! #include <unistd.h>
! #include <stdlib.h>
! 
! //#include <vdr/plugin.h>
  #include "video.h"
  #include "utils.h"
  #include "setup-softdevice.h"
  #include "sync-timer.h"
  
  //#define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
***************
*** 97,105 ****
    {
      OsdRefreshCounter++;
!     usleep(50000);
      if (
!         OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>2 && Osd_changed))
      {
        osdMutex.Lock();
--- 100,109 ----
    {
      OsdRefreshCounter++;
!     usleep(20000);
!     ProcessEvents();
      if (
!         OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>5 && Osd_changed))
      {
        osdMutex.Lock();
***************
*** 486,489 ****
--- 490,494 ----
     */
    areaMutex. Unlock();
+   ProcessEvents();  
  }
  
***************
*** 501,504 ****
--- 506,510 ----
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);
    areaMutex. Unlock();
+   ProcessEvents();  
  }
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** video.h	21 Apr 2006 06:47:10 -0000	1.33
--- video.h	23 Apr 2006 19:38:29 -0000	1.34
***************
*** 10,14 ****
--- 10,19 ----
  #define VIDEO_H
  
+ #ifndef STAND_ALONE
  #include <vdr/plugin.h>
+ #include <vdr/remote.h>
+ #else
+ #include "VdrReplacements.h"
+ #endif
  
  #ifdef HAVE_CONFIG
***************
*** 19,22 ****
--- 24,28 ----
  #include "sync-timer.h"
  
+ 
  #include <avcodec.h>
  
***************
*** 74,78 ****
  #endif
  
! class cSoftOsd;
  
  class cVideoOut: public cThread {
--- 80,93 ----
  #endif
  
! #ifndef STAND_ALONE
! class cSoftRemote : public cRemote {
!   public:
!           cSoftRemote(const char *Name) : cRemote(Name) {};
!           virtual ~cSoftRemote() {};
!           virtual bool PutKey(uint64 Code, bool Repeat = false, 
!                           bool Release = false)
!           { return Put(Code,Repeat,Release); };
! };
! #endif
  
  class cVideoOut: public cThread {
***************
*** 137,140 ****
--- 152,160 ----
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
+      
+     virtual void ProcessEvents ()
+     {};
+     // will be called every xx ms, at a minimum after each frame.
+     // Can be used to process for example keypress events
  
      virtual void Sync(cSyncTimer *syncTimer, int *delay);



From nobody at sheep.berlios.de  Sun Apr 23 21:55:32 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Apr 2006 21:55:32 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice-menu.h,NONE,1.1 VdrReplacements.c,NONE,1.1 VdrReplacements.h,NONE,1.1 CHANGELOG,1.174,1.175 Makefile,1.26,1.27 ShmClient.c,1.9,1.10 setup-softdevice-menu.c,1.2,1.3 setup-softdevice.h,1.26,1.27 softdevice.c,1.56,1.57 softdevice.h,1.8,1.9 utils.c,1.11,1.12 utils.h,1.6,1.7 video-shm.c,1.6,1.7 xscreensaver.c,1.3,1.4
Message-ID: <200604231955.k3NJtWt31885@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8357

Modified Files:
	CHANGELOG Makefile ShmClient.c setup-softdevice-menu.c 
	setup-softdevice.h softdevice.c softdevice.h utils.c utils.h 
	video-shm.c xscreensaver.c 
Added Files:
	setup-softdevice-menu.h VdrReplacements.c VdrReplacements.h 
Log Message:
- no longer link ShmClient to vdr objects


--- NEW FILE: setup-softdevice-menu.h ---
/*
 * setup-softdevice-menu.h
 *
 * See the README file for copyright information and how to reach the authors.
 *
 * $Id: setup-softdevice-menu.h,v 1.1 2006/04/23 19:55:53 wachm Exp $
 */

#ifndef __SETUP_SOFTDEVICE_MENU_H
#define __SETUP_SOFTDEVICE_MENU_H

#include "setup-softdevice.h"

/* ---------------------------------------------------------------------------
 */
class cMenuSetupVideoParm : public cOsdMenu
{
  private:
    cSetupStore *data, copyData;

  protected:
    virtual eOSState ProcessKey(eKeys Key);

  public:
    cMenuSetupVideoParm(const char *name);
};

/* ---------------------------------------------------------------------------
 */
class cMenuSetupCropping : public cOsdMenu
{
  private:
    cSetupStore *data, copyData;

  protected:
    virtual eOSState ProcessKey(eKeys Key);

  public:
    cMenuSetupCropping(const char *name);
};

/* ---------------------------------------------------------------------------
 */
class cMenuSetupPostproc : public cOsdMenu
{
  private:
    cSetupStore *data, copyData;

  protected:
    virtual eOSState ProcessKey(eKeys Key);

  public:
    cMenuSetupPostproc(const char *name);
};

/* ---------------------------------------------------------------------------
 */
class cMenuSetupSoftdevice : public cMenuSetupPage {
  private:
    cSetupStore *data, copyData;

  protected:
    virtual eOSState ProcessKey(eKeys Key);
    virtual void Store(void);

  public:
    cMenuSetupSoftdevice(cPlugin *plugin = NULL);
};
#endif


--- NEW FILE: VdrReplacements.c ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: VdrReplacements.c,v 1.1 2006/04/23 19:55:53 wachm Exp $
 */

#include "VdrReplacements.h"
#include <stdio.h>
#include <unistd.h>

cMutex::cMutex() {
        pthread_mutexattr_t attr;
        pthread_mutexattr_init(&attr);
        pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_ERRORCHECK_NP);
        pthread_mutex_init(&mutex, &attr);
};

cMutex::~cMutex() {
        pthread_mutex_destroy(&mutex);
};

void cMutex::Lock() {
        pthread_mutex_lock(&mutex);
};

void cMutex::Unlock() {
        pthread_mutex_unlock(&mutex);
};

//-------------------------------------------------------------------------

void StartThread(cThread *thread) {
        thread->active=true;
        thread->Action();
        thread->active=false;
};

cThread::cThread() {
        active=false;
};

cThread::~cThread() {
        Cancel();
}; 

bool cThread::Start() {
        if (active)
                return false;

        active=true;
        if ( pthread_create(&childTid, NULL, (void *(*) (void*))&StartThread,
                                        (void *)this)!=0 ) {
                fprintf(stderr,"Error starting thread\n");
                active=false;
                return false;
        };

        pthread_detach(childTid);
        return true;
};

void cThread::Cancel(int TimeOut) {
        int timeoutms=TimeOut*1000;
        while (active && TimeOut>0) {
                usleep(5000);
                timeoutms-=5000;
        };

        if (active) {
                pthread_cancel(childTid);
                childTid=0;
                active=false;
        };
};


--- NEW FILE: VdrReplacements.h ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: VdrReplacements.h,v 1.1 2006/04/23 19:55:53 wachm Exp $
 */

#ifndef __VDRREPLACEMENTS_H__
#define __VDRREPLACEMENTS_H__

#include <pthread.h>
#include <stdio.h>
#include <stdint.h>

#define VDRVERSNUM 10308

#define esyslog(out...) while (0) { fprintf(stderr,"esyslog:"); \
                                    fprintf(stderr,out);\
                                    fprintf(stderr,"\n"); }
#define dsyslog(out...) while (0) { fprintf(stderr,"dsyslog:"); \
                                    fprintf(stderr,out);\
                                    fprintf(stderr,"\n"); }
#define isyslog(out...) while (0) { fprintf(stdout,"isyslog:"); \
                                    fprintf(stdout,out);\
                                    fprintf(stdout,"\n"); }

#define tr(out) out

typedef unsigned long long int uint64;
typedef int eKeys;

class cSoftRemote {
  public: 
          cSoftRemote(const char *Name) {};
          virtual ~cSoftRemote()
          {};
          const char *Name() 
          {return NULL; };
          virtual bool PutKey(uint64_t Code, bool Repeat = false, 
                          bool Release = false)
          {return true;};
};

class cMutex {
        private:
                pthread_mutex_t mutex;

        public:
                cMutex();
                ~cMutex();

                void Lock();
                void Unlock();

};

class cThread {
        friend void StartThread(cThread *);
        private:
                bool active;
                pthread_t childTid;
        public:
                cThread();
                virtual ~cThread();

                bool Start();
                void Cancel( int Timeout = 0 );

                virtual void Action()
                {};
};

        

#endif

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.174
retrieving revision 1.175
diff -C2 -d -r1.174 -r1.175
*** CHANGELOG	23 Apr 2006 17:56:09 -0000	1.174
--- CHANGELOG	23 Apr 2006 19:55:53 -0000	1.175
***************
*** 4,7 ****
--- 4,11 ----
       -DNO_MIXER, currently experimental
     - fix for vdr-1.3.48
+    - remove duplicate remote code, call ProcessEvents() from the video thread
+      and remove the RC thread
+    - no longer link ShmClient to vdr objects
+    - fix some includes
  2006-04-21:
     - updated finnish translations (by Rolf Ahrenberg).

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** Makefile	23 Apr 2006 17:56:12 -0000	1.26
--- Makefile	23 Apr 2006 19:55:53 -0000	1.27
***************
*** 351,357 ****
  		      ../../../config.o ../../../plugin.o\
  		      ../../../sources.o
! SHM_CLIENT_OBJS  = video.o video-xv.o setup-softdevice.o xscreensaver.o \
! 		   utils.o
  
! ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)
! 	$(CXX) $(CXXFLAGS) $(XV_LIBS) $(VDR_SHM_CLIENT_OBJS) $(SHM_CLIENT_OBJS) -lpthread -ljpeg $< -o $@
--- 351,361 ----
  		      ../../../config.o ../../../plugin.o\
  		      ../../../sources.o
! SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o setup-softdevice_shm.o\
! 		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
! 		   ShmClient_shm.o
  
! %_shm.o: %.c
! 	$(CXX) $(CXXFLAGS) -c $(DEFINES) -DSTAND_ALONE $(INCLUDES) $< -o $@
! 		   
! ShmClient: $(SHM_CLIENT_OBJS)
! 	$(CXX) $(CXXFLAGS) $(XV_LIBS)  $(SHM_CLIENT_OBJS) -lpthread -o $@

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** ShmClient.c	1 Apr 2006 08:26:56 -0000	1.9
--- ShmClient.c	23 Apr 2006 19:55:53 -0000	1.10
***************
*** 11,14 ****
--- 11,17 ----
  
  #include <signal.h>
+ #include <string.h>
+ #include <unistd.h>
+ #include <stdlib.h>
  
  #include "video-xv.h"
***************
*** 16,20 ****
  #include "utils.h"
  
! #define SHMDEB(out...) {printf("SHMCLIENT[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef SHMDEB
--- 19,23 ----
  #include "utils.h"
  
! //#define SHMDEB(out...) {printf("SHMCLIENT[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef SHMDEB
***************
*** 30,46 ****
  };
  
! class cShmXvRemote : public cXvRemote {
          public:  
!                 cShmXvRemote(const char *Name, cXvVideoOut *vout)
!                         : cXvRemote(Name,vout) 
                          {};
                          
!                 ~cShmXvRemote()
                  {};
  
!                 virtual void   PutKey (KeySym key);
  };
  
! void cShmXvRemote::PutKey(KeySym key) {
          if (ctl) 
          {
--- 33,51 ----
  };
  
! class cShmRemote : public cSoftRemote {
          public:  
!                 cShmRemote(const char *Name)
!                         : cSoftRemote(Name) 
                          {};
                          
!                 ~cShmRemote()
                  {};
  
!                 virtual bool PutKey(uint64 Code, bool Repeat = false, 
!                                 bool Release = false);
  };
  
! bool cShmRemote::PutKey(uint64 Code, bool Repeat, 
!                                 bool Release) {
          if (ctl) 
          {
***************
*** 49,53 ****
                  SHMDEB("got lock for the key\n");
                  
!                 ctl->key=(uint64_t) key;
  
                  // release lock
--- 54,58 ----
                  SHMDEB("got lock for the key\n");
                  
!                 ctl->key=Code;
  
                  // release lock
***************
*** 57,61 ****
                  SHMDEB("signal new key\n");
          };
! 
  };
  
--- 62,66 ----
                  SHMDEB("signal new key\n");
          };
!         return true;
  };
  
***************
*** 64,68 ****
          SetupStore.xvFullscreen=0;
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
!         xvRemote= new cShmXvRemote ("softdevice-xv",vout);
          
          signal(SIGINT,sig_handler);
--- 69,73 ----
          SetupStore.xvFullscreen=0;
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
!         xvRemote= new cShmRemote("softdevice-xv");
          
          signal(SIGINT,sig_handler);
***************
*** 92,98 ****
                  exit(-1);
          };
!         xvRemote->XvRemoteStart();
!         
!         if (vout->useShm) {
                  ctl->pict_shmid= vout->shminfo.shmid;  
                  ctl->max_width=vout->xv_image->width;
--- 97,102 ----
                  exit(-1);
          };
!        
!         if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;  
                  ctl->max_width=vout->xv_image->width;

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** setup-softdevice-menu.c	14 Apr 2006 18:56:34 -0000	1.2
--- setup-softdevice-menu.c	23 Apr 2006 19:55:53 -0000	1.3
***************
*** 7,12 ****
   */
  
! #include "video.h"
! #include "setup-softdevice.h"
  
  /* ---------------------------------------------------------------------------
--- 7,12 ----
   */
  
! //#include "video.h"
! #include "setup-softdevice-menu.h"
  
  /* ---------------------------------------------------------------------------

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** setup-softdevice.h	14 Apr 2006 18:56:34 -0000	1.26
--- setup-softdevice.h	23 Apr 2006 19:55:53 -0000	1.27
***************
*** 9,12 ****
--- 9,19 ----
  #ifndef __SETUP_SOFTDEVICE_H
  #define __SETUP_SOFTDEVICE_H
+ #include <stdint.h>
+ 
+ #ifndef STAND_ALONE
+ #include <vdr/menu.h>
+ #else
+ #include "VdrReplacements.h"
+ #endif
  
  #define VOUT_XV       1
***************
*** 106,110 ****
      void          CropModeNext(void);
  
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64 key);
  
      int   xvAspect;
--- 113,117 ----
      void          CropModeNext(void);
  
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64_t key);
  
      int   xvAspect;
***************
*** 155,214 ****
  #define OSDMODE_PSEUDO    0
  #define OSDMODE_SOFTWARE  1
- 
- /* ---------------------------------------------------------------------------
-  */
- class cMenuSetupVideoParm : public cOsdMenu
- {
-   private:
-     cSetupStore *data, copyData;
- 
-   protected:
-     virtual eOSState ProcessKey(eKeys Key);
- 
-   public:
-     cMenuSetupVideoParm(const char *name);
- };
- 
- /* ---------------------------------------------------------------------------
-  */
- class cMenuSetupCropping : public cOsdMenu
- {
-   private:
-     cSetupStore *data, copyData;
- 
-   protected:
-     virtual eOSState ProcessKey(eKeys Key);
- 
-   public:
-     cMenuSetupCropping(const char *name);
- };
- 
- /* ---------------------------------------------------------------------------
-  */
- class cMenuSetupPostproc : public cOsdMenu
- {
-   private:
-     cSetupStore *data, copyData;
- 
-   protected:
-     virtual eOSState ProcessKey(eKeys Key);
- 
-   public:
-     cMenuSetupPostproc(const char *name);
- };
- 
- /* ---------------------------------------------------------------------------
-  */
- class cMenuSetupSoftdevice : public cMenuSetupPage {
-   private:
-     cSetupStore *data, copyData;
- 
-   protected:
-     virtual eOSState ProcessKey(eKeys Key);
-     virtual void Store(void);
- 
-   public:
-     cMenuSetupSoftdevice(cPlugin *plugin = NULL);
- };
  
  extern cSetupStore setupStore;
--- 162,165 ----

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** softdevice.c	23 Apr 2006 17:56:12 -0000	1.56
--- softdevice.c	23 Apr 2006 19:55:53 -0000	1.57
***************
*** 77,80 ****
--- 77,83 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
+ #include "setup-softdevice.h"
+ #include "setup-softdevice-menu.h"
+ 
  static const char *VERSION        = "0.2.2";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** softdevice.h	6 Feb 2006 06:58:49 -0000	1.8
--- softdevice.h	23 Apr 2006 19:55:53 -0000	1.9
***************
*** 14,21 ****
  
  #include "i18n.h"
- #include "setup-softdevice.h"
  #include "audio.h"
  #include "mpeg2decoder.h"
! #include "utils.h"
  
  // ---- Service interface ----------------------------------------------------
--- 14,20 ----
  
  #include "i18n.h"
  #include "audio.h"
  #include "mpeg2decoder.h"
! //#include "utils.h"
  
  // ---- Service interface ----------------------------------------------------

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** utils.c	14 Apr 2006 15:45:43 -0000	1.11
--- utils.c	23 Apr 2006 19:55:53 -0000	1.12
***************
*** 17,20 ****
--- 17,21 ----
   * Author: Olie Lho <ollie at sis.com.tw>
  */
+ #include <stdlib.h>
  
  #include "utils.h"

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** utils.h	14 Apr 2006 15:45:43 -0000	1.6
--- utils.h	23 Apr 2006 19:55:53 -0000	1.7
***************
*** 8,12 ****
  #ifndef UTILS_H
  #define UTILS_H
! #include <vdr/plugin.h>
  #include <sys/time.h>
  #include "mmx.h"
--- 8,13 ----
  #ifndef UTILS_H
  #define UTILS_H
! //#include <vdr/plugin.h>
! #include <stdint.h>
  #include <sys/time.h>
  #include "mmx.h"

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video-shm.c	21 Mar 2006 18:45:14 -0000	1.6
--- video-shm.c	23 Apr 2006 19:55:53 -0000	1.7
***************
*** 13,17 ****
  #include "utils.h"
  
! #define SHMDEB(out...) {printf("SHMSERV[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef SHMDEB
--- 13,17 ----
  #include "utils.h"
  
! //#define SHMDEB(out...) {printf("SHMSERV[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef SHMDEB

Index: xscreensaver.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/xscreensaver.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** xscreensaver.c	25 Oct 2004 02:36:18 -0000	1.3
--- xscreensaver.c	23 Apr 2006 19:55:53 -0000	1.4
***************
*** 22,26 ****
--- 22,32 ----
   */
  
+ #ifndef STAND_ALONE
  #include <vdr/plugin.h>
+ #else
+ #include "VdrReplacements.h"
+ #endif
+ 
+ #include <string.h>
  #include "xscreensaver.h"
  #include "utils.h"



From nobody at sheep.berlios.de  Sun Apr 23 22:21:02 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Apr 2006 22:21:02 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.41,1.42
Message-ID: <200604232021.k3NKL2t00119@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19554

Modified Files:
	setup-softdevice.c 
Log Message:
- no longer link ShmClient to vdr objects


Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** setup-softdevice.c	14 Apr 2006 18:56:34 -0000	1.41
--- setup-softdevice.c	23 Apr 2006 20:21:27 -0000	1.42
***************
*** 7,14 ****
   */
  
! #include "video.h"
  #include "setup-softdevice.h"
- #include "mpeg2decoder.h"
- 
  
  /* ----------------------------------------------------------------------------
--- 7,13 ----
   */
  
! #include <string.h>
! #include <stdlib.h>
  #include "setup-softdevice.h"
  
  /* ----------------------------------------------------------------------------
***************
*** 412,415 ****
--- 411,415 ----
  bool cSetupStore::CatchRemoteKey(const char *remoteName, uint64 key)
  {
+ #ifndef STAND_ALONE
      char  buffer[32];
      eKeys keySym;
***************
*** 426,429 ****
--- 426,430 ----
      }
    }
+ #endif
    return false;
  }



From nobody at sheep.berlios.de  Sun Apr 23 22:32:20 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Apr 2006 22:32:20 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.175,1.176 utils.c,1.12,1.13
Message-ID: <200604232032.k3NKWKt00619@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20462

Modified Files:
	CHANGELOG utils.c 
Log Message:
 - probably fix for processors not supporting mmx2


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.175
retrieving revision 1.176
diff -C2 -d -r1.175 -r1.176
*** CHANGELOG	23 Apr 2006 19:55:53 -0000	1.175
--- CHANGELOG	23 Apr 2006 20:32:45 -0000	1.176
***************
*** 8,11 ****
--- 8,12 ----
     - no longer link ShmClient to vdr objects
     - fix some includes
+    - probably fix for processors not supporting mmx2
  2006-04-21:
     - updated finnish translations (by Rolf Ahrenberg).

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** utils.c	23 Apr 2006 19:55:53 -0000	1.12
--- utils.c	23 Apr 2006 20:32:45 -0000	1.13
***************
*** 564,568 ****
--- 564,572 ----
  #define PREFETCH "prefetchnta"
  #define EMMS     "emms"
+ #ifdef USE_MMX2
  #define MOVNTQ "movntq"
+ #else
+ #define MOVNTQ "movq"
+ #endif
  #define MMREG_SIZE 64
  #define BLOCK_SIZE 4096



From nobody at sheep.berlios.de  Sun Apr 23 22:35:29 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Apr 2006 22:35:29 +0200
Subject: [Softdevice-cvs] softdevice SoftOsd.c,1.12,1.13
Message-ID: <200604232035.k3NKZTt00742@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20732

Modified Files:
	SoftOsd.c 
Log Message:
 - probably fix for processors not supporting mmx2


Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** SoftOsd.c	17 Apr 2006 20:06:30 -0000	1.12
--- SoftOsd.c	23 Apr 2006 20:35:53 -0000	1.13
***************
*** 387,391 ****
  void cSoftOsd::ARGB_to_RGB32(uint8_t * dest, color * pixmap, int Pixel) {
  	uint8_t *end_dest=dest+4*Pixel;
! #ifdef USE_MMX 
  	end_dest-=16;
          __asm__( 
--- 387,391 ----
  void cSoftOsd::ARGB_to_RGB32(uint8_t * dest, color * pixmap, int Pixel) {
  	uint8_t *end_dest=dest+4*Pixel;
! #ifdef USE_MMX2 
  	end_dest-=16;
          __asm__( 



From nobody at sheep.berlios.de  Sun Apr 23 23:22:56 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 23 Apr 2006 23:22:56 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.54,1.55
Message-ID: <200604232122.k3NLMut02403@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24805

Modified Files:
	video-dfb.c 
Log Message:
dfb-out: fix for recent remote change

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.54
retrieving revision 1.55
diff -C2 -d -r1.54 -r1.55
*** video-dfb.c	23 Apr 2006 19:38:29 -0000	1.54
--- video-dfb.c	23 Apr 2006 21:23:21 -0000	1.55
***************
*** 586,589 ****
--- 586,592 ----
      DFBInputEvent event;
  
+   if (!videoInitialized)
+     return;
+ 
    while (events->GetEvent( DFB_EVENT(&event) ))
    {



From nobody at sheep.berlios.de  Mon Apr 24 20:52:31 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 24 Apr 2006 20:52:31 +0200
Subject: [Softdevice-cvs] softdevice video-xv.c,1.52,1.53 video-dfb.c,1.55,1.56
Message-ID: <200604241852.k3OIqVt32650@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25317

Modified Files:
	video-xv.c video-dfb.c 
Log Message:
xv + dfb: removed some unused code

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** video-xv.c	23 Apr 2006 19:38:29 -0000	1.52
--- video-xv.c	24 Apr 2006 18:52:53 -0000	1.53
***************
*** 528,532 ****
      struct timeval  current_time;
      XEvent            event;
!     
    pthread_mutex_lock(&xv_mutex);
    if (!videoInitialized) {
--- 528,532 ----
      struct timeval  current_time;
      XEvent            event;
! 
    pthread_mutex_lock(&xv_mutex);
    if (!videoInitialized) {
***************
*** 719,723 ****
    }
    xScreensaver->MaybeSendDeactivate();
!   pthread_mutex_unlock(&xv_mutex);  
  }
  
--- 719,723 ----
    }
    xScreensaver->MaybeSendDeactivate();
!   pthread_mutex_unlock(&xv_mutex);
  }
  
***************
*** 1500,1531 ****
  }
  
- /*
- void cXvVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
- {
-   // refreshes the screen
-   // copy video Data
-   if (!videoInitialized)
-     return;
- //  if (OSDpresent)
-   {
-     switch (current_osdMode) {
-       case OSDMODE_PSEUDO :
-               Osd->CopyToBitmap(osd_buffer, osd_image->bytes_per_line,
-                               OsdWidth,OsdHeight,RefreshAll);
-             break;
-       case OSDMODE_SOFTWARE:
- 	    Osd->CopyToBitmap(OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
-                             OSD_FULL_WIDTH,OSD_FULL_WIDTH/2,
- 			    OsdWidth,OsdHeight,RefreshAll);
- 	    break;
- 
-     }
-     pthread_mutex_lock(&xv_mutex);
-     ShowOSD(0,1);
-     //OSDpresent=true;
-     pthread_mutex_unlock(&xv_mutex);
-   };
- };
- */
  #else
  /* ---------------------------------------------------------------------------
--- 1500,1503 ----
***************
*** 1712,1716 ****
    }
    PutXvImage();
-   //ProcessEvents ();
    XSync(dpy, False);
    pthread_mutex_unlock(&xv_mutex);
--- 1684,1687 ----

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.55
retrieving revision 1.56
diff -C2 -d -r1.55 -r1.56
*** video-dfb.c	23 Apr 2006 21:23:21 -0000	1.55
--- video-dfb.c	24 Apr 2006 18:52:53 -0000	1.56
***************
*** 363,372 ****
                 fmt, DFB_BITS_PER_PIXEL(fmt));
        Bpp = DFB_BITS_PER_PIXEL(fmt);
! /*
!       if (Xres > OSD_FULL_WIDTH)
!         Xres = OSD_FULL_WIDTH;
!       if (Yres > OSD_FULL_HEIGHT)
!         Yres = OSD_FULL_HEIGHT;
! */
        /* ------------------------------------------------------------------------
         * clear screen surface at startup
--- 363,367 ----
                 fmt, DFB_BITS_PER_PIXEL(fmt));
        Bpp = DFB_BITS_PER_PIXEL(fmt);
! 
        /* ------------------------------------------------------------------------
         * clear screen surface at startup
***************
*** 1095,1195 ****
  }
  
- /*
- void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll)
- {
-     int               pitch;
-     uint8_t           *dst;
-     IDirectFBSurface  *tmpSurface;
-     DFBRectangle      osdsrc;
- 
-     try
-     {
-       bool dirtyLines[Yres];
-       memset(dirtyLines,false,sizeof(dirtyLines));
- 
-       tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
-       tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
-       Osd->CopyToBitmap(dst, pitch,
-                               Xres,Yres,RefreshAll,dirtyLines);
-       tmpSurface->Unlock();
- 
-       tmpSurface->Flip();
- 
-       int miny=0;
-       int maxy=0;
-       do {
-               while (!dirtyLines[miny] && miny < Yres)
-                       miny++;
- 
- 	      if (miny >= Yres)
- 		      break;
- 
-               maxy=miny;
-               while (dirtyLines[maxy] && maxy < Yres)
-                       maxy++;
- 
-               osdsrc.x = 0;
-               osdsrc.y = miny;
-               osdsrc.w = Xres;
-               osdsrc.h = maxy-miny + 1;
-               tmpSurface->Blit(tmpSurface,&osdsrc,0,miny);
- 
-               miny=maxy;
- 
-       } while ( miny<Yres);
- 
-     }
-     catch (DFBException *ex)
-     {
-       fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
-                ex->GetAction(), ex->GetResult());
-       delete ex;
-     }
- 
- }
- 	*/
- /* ---------------------------------------------------------------------------
-  */
- /*
- void cDFBVideoOut::Refresh(cBitmap *Bitmap)
- {
-     int               pitch;
-     uint8_t           *dst;
-     IDirectFBSurface  *tmpSurface;
-     DFBRegion         modArea;
-     DFBRectangle      osdsrc;
- 
-   if (Bitmap->Dirty(modArea.x1,modArea.y1,modArea.x2,modArea.y2))
-   {
-     try
-     {
-       tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
-       tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
-       Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
-       tmpSurface->Unlock();
- 
-       modArea.x1 += OSDxOfs + Bitmap->X0();
-       modArea.y1 += OSDyOfs + Bitmap->Y0();
-       modArea.x2 += OSDxOfs + Bitmap->X0();
-       modArea.y2 += OSDyOfs + Bitmap->Y0();
- 
-       tmpSurface->Flip(&modArea,DSFLIP_WAIT);
-       osdsrc.x = modArea.x1;
-       osdsrc.y = modArea.y1;
-       osdsrc.w = modArea.x2 - modArea.x1 + 1;
-       osdsrc.h = modArea.y2 - modArea.y1 + 1;
-       tmpSurface->Blit(tmpSurface, &osdsrc, modArea.x1, modArea.y1);
-     }
-     catch (DFBException *ex)
-     {
-       fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
-                ex->GetAction(), ex->GetResult());
-       delete ex;
-     }
- 
-     Bitmap->Clean();
-   }
- }
- */
  #else
  
--- 1090,1093 ----
***************
*** 1485,1490 ****
      delete ex;
    }
-   //ProcessEvents ();
-   //events_not_done = 0;
  }
  
--- 1383,1386 ----



From nobody at sheep.berlios.de  Mon Apr 24 21:22:45 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 24 Apr 2006 21:22:45 +0200
Subject: [Softdevice-cvs] softdevice video.h,1.34,1.35
Message-ID: <200604241922.k3OJMjt00924@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3800

Modified Files:
	video.h 
Log Message:
Initialize(): set videoInitialized

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** video.h	23 Apr 2006 19:38:29 -0000	1.34
--- video.h	24 Apr 2006 19:23:09 -0000	1.35
***************
*** 85,89 ****
            cSoftRemote(const char *Name) : cRemote(Name) {};
            virtual ~cSoftRemote() {};
!           virtual bool PutKey(uint64 Code, bool Repeat = false, 
                            bool Release = false)
            { return Put(Code,Repeat,Release); };
--- 85,89 ----
            cSoftRemote(const char *Name) : cRemote(Name) {};
            virtual ~cSoftRemote() {};
!           virtual bool PutKey(uint64 Code, bool Repeat = false,
                            bool Release = false)
            { return Put(Code,Repeat,Release); };
***************
*** 152,156 ****
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
!      
      virtual void ProcessEvents ()
      {};
--- 152,156 ----
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
! 
      virtual void ProcessEvents ()
      {};
***************
*** 169,173 ****
      virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
                                    int w, int h, int yPitch, int uvPitch);
!     virtual bool Initialize(void) {return 1;};
      virtual bool Reconfigure (int format) {return 1;};
  
--- 169,173 ----
      virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
                                    int w, int h, int yPitch, int uvPitch);
!     virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format) {return 1;};
  



From nobody at sheep.berlios.de  Mon Apr 24 22:35:57 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 24 Apr 2006 22:35:57 +0200
Subject: [Softdevice-cvs] softdevice softdevice.c,1.57,1.58 video-fb.c,1.13,1.14 video-vidix.c,1.17,1.18
Message-ID: <200604242035.k3OKZvt03756@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21566

Modified Files:
	softdevice.c video-fb.c video-vidix.c 
Log Message:
vidix + fb: adjusted to use videoInitialized
call Initialize() after all video constructors


Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.57
retrieving revision 1.58
diff -C2 -d -r1.57 -r1.58
*** softdevice.c	23 Apr 2006 19:55:53 -0000	1.57
--- softdevice.c	24 Apr 2006 20:36:21 -0000	1.58
***************
*** 244,247 ****
--- 244,248 ----
  #ifdef FB_SUPPORT
          videoOut=new cFBVideoOut(&setupStore);
+         videoOut->Initialize();
  #endif
          break;
***************
*** 249,252 ****
--- 250,254 ----
  #ifdef SHM_SUPPORT
          videoOut=new cShmVideoOut(&setupStore);
+         videoOut->Initialize();
  #endif
          break;
***************
*** 260,267 ****
--- 262,271 ----
  #ifdef VIDIX_SUPPORT
          videoOut=new cVidixVideoOut(&setupStore);
+         videoOut->Initialize();
  #endif
          break;
        case VOUT_DUMMY:
          videoOut=new cDummyVideoOut(&setupStore);
+         videoOut->Initialize();
          break;
        default:

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-fb.c	18 Feb 2006 22:20:29 -0000	1.13
--- video-fb.c	24 Apr 2006 20:36:21 -0000	1.14
***************
*** 13,17 ****
  #include <sys/mman.h>
  #include <sys/ioctl.h>
! #include <fcntl.h> 
  #include <vdr/plugin.h>
  #include "video-fb.h"
--- 13,17 ----
  #include <sys/mman.h>
  #include <sys/ioctl.h>
! #include <fcntl.h>
  #include <vdr/plugin.h>
  #include "video-fb.h"
***************
*** 119,123 ****
      // set rgb unpack method
      mmx_unpack=mmx_unpack_16rgb;
!     if (fb_vinfo.red.length==5 && fb_vinfo.green.length==5 
           && fb_vinfo.blue.length==5 ) {
        mmx_unpack=mmx_unpack_15rgb;
--- 119,123 ----
      // set rgb unpack method
      mmx_unpack=mmx_unpack_16rgb;
!     if (fb_vinfo.red.length==5 && fb_vinfo.green.length==5
           && fb_vinfo.blue.length==5 ) {
        mmx_unpack=mmx_unpack_15rgb;
***************
*** 147,151 ****
  }
  
! void cFBVideoOut::Pause(void) 
  {
  }
--- 147,153 ----
  }
  
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::Pause(void)
  {
  }
***************
*** 166,170 ****
  {
    cVideoOut::ClearOSD();
!   if (PixelMask)
      memset(PixelMask, 0, Xres * Yres/8);
  };
--- 168,172 ----
  {
    cVideoOut::ClearOSD();
!   if (videoInitialized && PixelMask)
      memset(PixelMask, 0, Xres * Yres/8);
  };
***************
*** 183,201 ****
  }
  
! void cFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines) {
    pthread_mutex_lock(&fb_mutex);
!   osd=fb; 
    stride=line_len;
    dirtyLines=NULL;
! };
  
! void cFBVideoOut::CommitUnlockOsdSurface() {      
    pthread_mutex_unlock(&fb_mutex);
    cVideoOut::CommitUnlockOsdSurface();
! };
  
  #else
  
  void cFBVideoOut::Refresh()
  {
--- 185,217 ----
  }
  
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines)
! {
    pthread_mutex_lock(&fb_mutex);
! 
!   osd = NULL;
!   stride = 0;
!   if (!videoInitialized)
!     return;
! 
!   osd=fb;
    stride=line_len;
    dirtyLines=NULL;
! }
  
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::CommitUnlockOsdSurface()
! {
    pthread_mutex_unlock(&fb_mutex);
    cVideoOut::CommitUnlockOsdSurface();
! }
  
  #else
  
+ /* ---------------------------------------------------------------------------
+  */
  void cFBVideoOut::Refresh()
  {
***************
*** 220,225 ****
--- 236,246 ----
  #endif
  
+ /* ---------------------------------------------------------------------------
+  */
  void cFBVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride)
  {
+   if (!videoInitialized)
+     return;
+ 
    pthread_mutex_lock(&fb_mutex);
    if (OSDpresent) {
***************
*** 239,242 ****
--- 260,265 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
  cFBVideoOut::~cFBVideoOut()
  {

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-vidix.c	12 Mar 2006 09:43:28 -0000	1.17
--- video-vidix.c	24 Apr 2006 20:36:21 -0000	1.18
***************
*** 9,13 ****
  #include <sys/mman.h>
  #include <sys/ioctl.h>
! #include <fcntl.h> 
  #include <vdr/plugin.h>
  #include "video-vidix.h"
--- 9,13 ----
  #include <sys/mman.h>
  #include <sys/ioctl.h>
! #include <fcntl.h>
  #include <vdr/plugin.h>
  #include "video-vidix.h"
***************
*** 402,405 ****
--- 402,408 ----
      int hi, wi;
  
+   if (!videoInitialized)
+     return;
+ 
    START;
    TIMINGS("start...\n");
***************
*** 559,566 ****
  void cVidixVideoOut::ClearOSD()
  {
!   cVideoOut::ClearOSD();
!   if (current_osdMode==OSDMODE_PSEUDO)
!     memset(fb, 0, fb_line_len * Yres);
! };
  
  /* ---------------------------------------------------------------------------
--- 562,572 ----
  void cVidixVideoOut::ClearOSD()
  {
!     if (!videoInitialized)
!         return;
! 
!     cVideoOut::ClearOSD();
!     if (current_osdMode==OSDMODE_PSEUDO)
!         memset(fb, 0, fb_line_len * Yres);
! }
  
  /* ---------------------------------------------------------------------------
***************
*** 593,602 ****
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                 bool *&dirtyLines) {
!         osd=fb;
!         stride=fb_line_len;
!         dirtyLines=NULL;
! };
  
  #else
--- 599,615 ----
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                 bool *&dirtyLines)
! {
!     osd = NULL;
!     stride = 0;
! 
!     if (!videoInitialized)
!         return;
! 
!     osd=fb;
!     stride=fb_line_len;
!     dirtyLines=NULL;
! }
  
  #else
***************
*** 620,623 ****
--- 633,639 ----
  void cVidixVideoOut::CloseOSD()
  {
+     if (!videoInitialized)
+         return;
+ 
      cVideoOut::CloseOSD();
      memset(fb, 0, fb_line_len * Yres);



From nobody at sheep.berlios.de  Tue Apr 25 00:56:24 2006
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 25 Apr 2006 00:56:24 +0200
Subject: [Softdevice-cvs] softdevice video-xv.c,1.53,1.54
Message-ID: <200604242256.k3OMuOt09409@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17668

Modified Files:
	video-xv.c 
Log Message:
only X11 calls needs protection by xv_mutex

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** video-xv.c	24 Apr 2006 18:52:53 -0000	1.53
--- video-xv.c	24 Apr 2006 22:56:47 -0000	1.54
***************
*** 30,34 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2006-04-21"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 30,34 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2006-04-24"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 529,538 ****
      XEvent            event;
  
!   pthread_mutex_lock(&xv_mutex);
!   if (!videoInitialized) {
!           pthread_mutex_unlock(&xv_mutex);
!           return;
!   };
  
    while (XCheckMaskEvent (dpy, /* win, */
                                   PointerMotionMask |
--- 529,536 ----
      XEvent            event;
  
!   if (!videoInitialized)
!     return;
  
+   pthread_mutex_lock(&xv_mutex);
    while (XCheckMaskEvent (dpy, /* win, */
                                   PointerMotionMask |



From nobody at sheep.berlios.de  Tue Apr 25 00:59:00 2006
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 25 Apr 2006 00:59:00 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.176,1.177 video-dfb.c,1.56,1.57 video.c,1.50,1.51 video.h,1.35,1.36
Message-ID: <200604242259.k3OMwxt09521@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19382

Modified Files:
	CHANGELOG video-dfb.c video.c video.h 
Log Message:
dfb: OSD responsivness in paused mode

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.176
retrieving revision 1.177
diff -C2 -d -r1.176 -r1.177
*** CHANGELOG	23 Apr 2006 20:32:45 -0000	1.176
--- CHANGELOG	24 Apr 2006 22:59:23 -0000	1.177
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2006-04-24:
+    - xv + dfb: removed some unused code.
+    - vidix + fb: adjusted to use videoInitialized.
+    - call Initialize() after all video constructors.
+    - dfb: OSD responsivness in paused mode.
  2006-04-23:
     - added volume changing with changing the  mixer control ( to use it add

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** video-dfb.c	24 Apr 2006 18:52:53 -0000	1.56
--- video-dfb.c	24 Apr 2006 22:59:23 -0000	1.57
***************
*** 606,609 ****
--- 606,614 ----
      }
    }
+ 
+   if (OsdRefreshCounter > 2) {
+     ShowOSD();
+     OsdRefreshCounter = 0;
+   }
  }
  

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** video.c	23 Apr 2006 19:38:29 -0000	1.50
--- video.c	24 Apr 2006 22:59:23 -0000	1.51
***************
*** 101,105 ****
      OsdRefreshCounter++;
      usleep(20000);
!     ProcessEvents();
      if (
          OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
--- 101,108 ----
      OsdRefreshCounter++;
      usleep(20000);
! 
!     if (OsdRefreshCounter > 2)
!       ProcessEvents();
! 
      if (
          OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
***************
*** 490,494 ****
     */
    areaMutex. Unlock();
!   ProcessEvents();  
  }
  
--- 493,497 ----
     */
    areaMutex. Unlock();
!   ProcessEvents();
  }
  
***************
*** 506,510 ****
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);
    areaMutex. Unlock();
!   ProcessEvents();  
  }
  
--- 509,513 ----
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);
    areaMutex. Unlock();
!   ProcessEvents();
  }
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** video.h	24 Apr 2006 19:23:09 -0000	1.35
--- video.h	24 Apr 2006 22:59:23 -0000	1.36
***************
*** 146,149 ****
--- 146,152 ----
  
      bool active;
+     uint16_t OsdRefreshCounter;
+     // should be setted to null everytime OSD is shown
+     // (software alpha blending mode).
  
      virtual void RecalculateAspect(void);
***************
*** 201,207 ****
      int     Osd_changed;
  
-     uint16_t OsdRefreshCounter;
-     // should be setted to null everytime OSD is shown
-     // (software alpha blending mode).
  public:
      virtual void ClearOSD();
--- 204,207 ----



From nobody at sheep.berlios.de  Tue Apr 25 21:49:03 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 25 Apr 2006 21:49:03 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.177,1.178 video.c,1.51,1.52 ShmClient.c,1.10,1.11
Message-ID: <200604251949.k3PJn3t31108@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17252

Modified Files:
	CHANGELOG video.c ShmClient.c 
Log Message:
- fix ShmClient blank screen every 4s 


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.177
retrieving revision 1.178
diff -C2 -d -r1.177 -r1.178
*** CHANGELOG	24 Apr 2006 22:59:23 -0000	1.177
--- CHANGELOG	25 Apr 2006 19:49:20 -0000	1.178
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-04-25:
+    - fix ShmClient blank screen every 4s 
  2006-04-24:
     - xv + dfb: removed some unused code.

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** video.c	24 Apr 2006 22:59:23 -0000	1.51
--- video.c	25 Apr 2006 19:49:20 -0000	1.52
***************
*** 504,509 ****
    OsdRefreshCounter=0;
    Osd_changed=0;
-   RecalculateAspect();
    CheckArea(w, h);
    // display picture
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);
--- 504,509 ----
    OsdRefreshCounter=0;
    Osd_changed=0;
    CheckArea(w, h);
+   CheckAspect(current_afd, aspect_F);
    // display picture
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** ShmClient.c	23 Apr 2006 19:55:53 -0000	1.10
--- ShmClient.c	25 Apr 2006 19:49:20 -0000	1.11
***************
*** 183,191 ****
                          vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                          if ( vout->useShm ) {
!                                 vout->YUV(NULL,NULL,NULL,
                                                  width,height,
                                                  ctl->stride0,ctl->stride1);
                          } else {    
!                                 vout->YUV(pixel[0],pixel[2],pixel[1],
                                          width,height,
                                          ctl->stride0,ctl->stride1);
--- 183,191 ----
                          vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                          if ( vout->useShm ) {
!                                 vout->DrawStill_420pl(NULL,NULL,NULL,
                                                  width,height,
                                                  ctl->stride0,ctl->stride1);
                          } else {    
!                                 vout->DrawStill_420pl(pixel[0],pixel[2],pixel[1],
                                          width,height,
                                          ctl->stride0,ctl->stride1);



From nobody at sheep.berlios.de  Thu Apr 27 22:29:13 2006
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 27 Apr 2006 22:29:13 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.52,1.53 video.h,1.36,1.37 ShmClient.c,1.11,1.12 VdrReplacements.h,1.1,1.2 CHANGELOG,1.178,1.179
Message-ID: <200604272029.k3RKTDt04067@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26551

Modified Files:
	video.c video.h ShmClient.c VdrReplacements.h CHANGELOG 
Log Message:
- fix black screen for some aspect ratios using ShmClient



Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** video.c	25 Apr 2006 19:49:20 -0000	1.52
--- video.c	27 Apr 2006 20:29:29 -0000	1.53
***************
*** 499,503 ****
   */
  void cVideoOut::DrawStill_420pl(uint8_t *pY, uint8_t *pU, uint8_t *pV,
!                                 int w, int h, int yPitch, int uvPitch)
  {
    areaMutex. Lock();
--- 499,504 ----
   */
  void cVideoOut::DrawStill_420pl(uint8_t *pY, uint8_t *pU, uint8_t *pV,
!                                 int w, int h, int yPitch, int uvPitch,
!                                 int new_afd,double new_asp)
  {
    areaMutex. Lock();
***************
*** 505,509 ****
    Osd_changed=0;
    CheckArea(w, h);
!   CheckAspect(current_afd, aspect_F);
    // display picture
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);
--- 506,510 ----
    Osd_changed=0;
    CheckArea(w, h);
!   CheckAspect(new_afd==-1?current_afd:new_afd, new_asp==0?aspect_F:new_asp);
    // display picture
    YUV (pY, pU, pV, w, h, yPitch, uvPitch);

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** video.h	24 Apr 2006 22:59:23 -0000	1.36
--- video.h	27 Apr 2006 20:29:29 -0000	1.37
***************
*** 171,175 ****
                                    AVFrame *picture, AVCodecContext *context);
      virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
!                                   int w, int h, int yPitch, int uvPitch);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format) {return 1;};
--- 171,177 ----
                                    AVFrame *picture, AVCodecContext *context);
      virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
!                                   int w, int h, int yPitch, int uvPitch,
!                                   int new_afd=-1, 
!                                   double new_asp=0.0);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format) {return 1;};

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** ShmClient.c	25 Apr 2006 19:49:20 -0000	1.11
--- ShmClient.c	27 Apr 2006 20:29:30 -0000	1.12
***************
*** 181,193 ****
  
                          vout->CheckArea(width,height);
!                         vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                          if ( vout->useShm ) {
                                  vout->DrawStill_420pl(NULL,NULL,NULL,
                                                  width,height,
!                                                 ctl->stride0,ctl->stride1);
                          } else {    
                                  vout->DrawStill_420pl(pixel[0],pixel[2],pixel[1],
                                          width,height,
!                                         ctl->stride0,ctl->stride1);
                          };
                          ctl->new_pict=0;
--- 181,195 ----
  
                          vout->CheckArea(width,height);
!                         //vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                          if ( vout->useShm ) {
                                  vout->DrawStill_420pl(NULL,NULL,NULL,
                                                  width,height,
!                                                 ctl->stride0,ctl->stride1,
!                                                 ctl->new_afd,ctl->new_asp);
                          } else {    
                                  vout->DrawStill_420pl(pixel[0],pixel[2],pixel[1],
                                          width,height,
!                                         ctl->stride0,ctl->stride1,
!                                         ctl->new_afd,ctl->new_asp);
                          };
                          ctl->new_pict=0;

Index: VdrReplacements.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VdrReplacements.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** VdrReplacements.h	23 Apr 2006 19:55:53 -0000	1.1
--- VdrReplacements.h	27 Apr 2006 20:29:30 -0000	1.2
***************
*** 19,31 ****
  #define VDRVERSNUM 10308
  
! #define esyslog(out...) while (0) { fprintf(stderr,"esyslog:"); \
                                      fprintf(stderr,out);\
!                                     fprintf(stderr,"\n"); }
! #define dsyslog(out...) while (0) { fprintf(stderr,"dsyslog:"); \
                                      fprintf(stderr,out);\
!                                     fprintf(stderr,"\n"); }
! #define isyslog(out...) while (0) { fprintf(stdout,"isyslog:"); \
                                      fprintf(stdout,out);\
!                                     fprintf(stdout,"\n"); }
  
  #define tr(out) out
--- 19,31 ----
  #define VDRVERSNUM 10308
  
! #define esyslog(out...) do { fprintf(stderr,"esyslog:"); \
                                      fprintf(stderr,out);\
!                                     fprintf(stderr,"\n"); } while (0)
! #define dsyslog(out...) do { fprintf(stderr,"dsyslog:"); \
                                      fprintf(stderr,out);\
!                                     fprintf(stderr,"\n"); } while (0)
! #define isyslog(out...) do { fprintf(stdout,"isyslog:"); \
                                      fprintf(stdout,out);\
!                                     fprintf(stdout,"\n"); } while (0)
  
  #define tr(out) out

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.178
retrieving revision 1.179
diff -C2 -d -r1.178 -r1.179
*** CHANGELOG	25 Apr 2006 19:49:20 -0000	1.178
--- CHANGELOG	27 Apr 2006 20:29:30 -0000	1.179
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-04-27:
+    - fix black screen for some aspect ratios using ShmClient
  2006-04-25:
     - fix ShmClient blank screen every 4s 



From nobody at sheep.berlios.de  Thu Apr 27 22:32:35 2006
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 27 Apr 2006 22:32:35 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.179,1.180 audio.c,1.24,1.25 audio.h,1.10,1.11
Message-ID: <200604272032.k3RKWZt04213@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv781

Modified Files:
	CHANGELOG audio.c audio.h 
Log Message:
- change volume handling to no longer change the alsa-mixer settings



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.179
retrieving revision 1.180
diff -C2 -d -r1.179 -r1.180
*** CHANGELOG	27 Apr 2006 20:29:30 -0000	1.179
--- CHANGELOG	27 Apr 2006 20:32:58 -0000	1.180
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-04-27:
+    - change volume handling to no longer change the alsa-mixer settings
     - fix black screen for some aspect ratios using ShmClient
  2006-04-25:
***************
*** 10,15 ****
     - dfb: OSD responsivness in paused mode.
  2006-04-23:
!    - added volume changing with changing the  mixer control ( to use it add
!      -DNO_MIXER, currently experimental
     - fix for vdr-1.3.48
     - remove duplicate remote code, call ProcessEvents() from the video thread
--- 11,16 ----
     - dfb: OSD responsivness in paused mode.
  2006-04-23:
!    - added volume changing without changing the alsa-mixer control (to use it 
!      add -DNO_MIXER, currently experimental)
     - fix for vdr-1.3.48
     - remove duplicate remote code, call ProcessEvents() from the video thread

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** audio.c	23 Apr 2006 15:58:49 -0000	1.24
--- audio.c	27 Apr 2006 20:32:58 -0000	1.25
***************
*** 19,22 ****
--- 19,23 ----
  
  #define PCM_FMT SND_PCM_FORMAT_S16_LE
+ #define NO_MIXER
  
  //#define AUDIODEB(out...) {printf("AUDIO[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
***************
*** 55,59 ****
      oldContext.samplerate = currContext.samplerate=48000;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
!     volume=255;
  }
  
--- 56,60 ----
      oldContext.samplerate = currContext.samplerate=48000;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
!     scale_Factor=0x7FFF;
  }
  
***************
*** 94,102 ****
   */
  
! void Scale(int16_t *Data, int size,int Volume) 
  {
    while (size>0) {
!     register int32_t tmp=(int32_t)(*Data) * Volume;
!     *Data=(int16_t) (tmp>>8);
      Data++;
      size--;
--- 95,103 ----
   */
  
! void Scale(int16_t *Data, int size,int scale_Factor) 
  {
    while (size>0) {
!     register int32_t tmp=(int32_t)(*Data) * scale_Factor;
!     *Data=(int16_t) (tmp>>15);
      Data++;
      size--;
***************
*** 126,130 ****
  #ifdef NO_MIXER
    // change the volume
!   Scale((int16_t*)Data,Length/2,volume);
  #endif
  
--- 127,131 ----
  #ifdef NO_MIXER
    // change the volume
!   Scale((int16_t*)Data,Length/2,scale_Factor);
  #endif
  
***************
*** 407,411 ****
  {
  #ifdef NO_MIXER
!   volume = vol;
  #else
      int                   err;
--- 408,416 ----
  {
  #ifdef NO_MIXER
!   if (vol>0)
!           scale_Factor = (int) (pow(10.0, -2.3+2.3*vol/256.0)*0x7FFF);
!   else scale_Factor = 0;
!   //printf("vol %d scale_Factor 0x%04x\n",vol,scale_Factor);
!   //scale_Factor = vol;
  #else
      int                   err;

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** audio.h	23 Apr 2006 15:58:49 -0000	1.10
--- audio.h	27 Apr 2006 20:32:58 -0000	1.11
***************
*** 64,68 ****
    bool  SetAC3PassThroughMode(bool on);
    void  Xrun(void);
!   int volume;
  
  protected:
--- 64,68 ----
    bool  SetAC3PassThroughMode(bool on);
    void  Xrun(void);
!   int scale_Factor;
  
  protected:



From nobody at sheep.berlios.de  Sat Apr 29 08:18:37 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 08:18:37 +0200
Subject: [Softdevice-cvs] softdevice .cvsignore,1.1,1.2
Message-ID: <200604290618.k3T6Ibt28054@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2172

Modified Files:
	.cvsignore 
Log Message:
ignore ShmClient executable

Index: .cvsignore
===================================================================
RCS file: /cvsroot/softdevice/softdevice/.cvsignore,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** .cvsignore	5 Jun 2005 20:29:44 -0000	1.1
--- .cvsignore	29 Apr 2006 06:19:06 -0000	1.2
***************
*** 3,5 ****
  .#*.h.*
  config.mak
! config.h
\ No newline at end of file
--- 3,6 ----
  .#*.h.*
  config.mak
! config.h
! ShmClient
\ No newline at end of file



From nobody at sheep.berlios.de  Sat Apr 29 08:20:04 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 08:20:04 +0200
Subject: [Softdevice-cvs] softdevice configure,1.10,1.11 Makefile,1.27,1.28
Message-ID: <200604290620.k3T6K4t28094@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3089

Modified Files:
	configure Makefile 
Log Message:
build video-shm and ShmClient when possible

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** configure	31 Mar 2006 19:15:26 -0000	1.10
--- configure	29 Apr 2006 06:20:27 -0000	1.11
***************
*** 26,29 ****
--- 26,30 ----
  cc="g++"
  xv="yes"
+ with_shm="yes"
  xinerama="yes"
  vidix="yes"
***************
*** 42,45 ****
--- 43,47 ----
    echo "  --disable-dfb"
    echo "  --disable-xv"
+   echo "  --disable-shm"
    echo "  --disable-subplugins"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
***************
*** 54,57 ****
--- 56,60 ----
      --disable-dfb) shift; dfb="no" ;;
      --disable-xv) shift; xv="no" ;;
+     --disable-shm) shift; with_shm="no" ;;
      --disable-subplugins) shift; with_subplugins="no" ;;
      --with-vidix-path) shift;
***************
*** 85,89 ****
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
--- 88,92 ----
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++ >/dev/null 2>&1` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
***************
*** 322,325 ****
--- 325,331 ----
  if test "${xv}" = "yes" ; then
    echo "XV_SUPPORT       = 1" >> $TMPM
+   if test "${with_shm}" = "yes" ; then
+     echo "SHM_SUPPORT = 1" >> $TMPM
+   fi
    if test "${xinerama}" = "yes" ; then
      echo "XINERAMA_SUPPORT = 1" >> $TMPM

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** Makefile	23 Apr 2006 19:55:53 -0000	1.27
--- Makefile	29 Apr 2006 06:20:28 -0000	1.28
***************
*** 283,286 ****
--- 283,287 ----
      OBJS += video-shm.o
    endif
+   TARGETS += ShmClient
    DEFINES += -DSHM_SUPPORT
  endif
***************
*** 345,349 ****
  
  clean:
! 	@-rm -f $(OBJS) $(DEPFILE) *.so *.o *.tgz core* *~
  
  VDR_SHM_CLIENT_OBJS = ../../../tools.o ../../../thread.o \
--- 346,350 ----
  
  clean:
! 	@-rm -f $(OBJS) $(DEPFILE) ShmClient *.so *.o *.tgz core* *~
  
  VDR_SHM_CLIENT_OBJS = ../../../tools.o ../../../thread.o \
***************
*** 357,361 ****
  %_shm.o: %.c
  	$(CXX) $(CXXFLAGS) -c $(DEFINES) -DSTAND_ALONE $(INCLUDES) $< -o $@
! 		   
  ShmClient: $(SHM_CLIENT_OBJS)
  	$(CXX) $(CXXFLAGS) $(XV_LIBS)  $(SHM_CLIENT_OBJS) -lpthread -o $@
--- 358,362 ----
  %_shm.o: %.c
  	$(CXX) $(CXXFLAGS) -c $(DEFINES) -DSTAND_ALONE $(INCLUDES) $< -o $@
! 
  ShmClient: $(SHM_CLIENT_OBJS)
  	$(CXX) $(CXXFLAGS) $(XV_LIBS)  $(SHM_CLIENT_OBJS) -lpthread -o $@



From nobody at sheep.berlios.de  Sat Apr 29 08:22:59 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 08:22:59 +0200
Subject: [Softdevice-cvs] softdevice ShmClient.c,1.12,1.13
Message-ID: <200604290622.k3T6Mxt28170@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3930

Modified Files:
	ShmClient.c 
Log Message:
reduced warning

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** ShmClient.c	27 Apr 2006 20:29:30 -0000	1.12
--- ShmClient.c	29 Apr 2006 06:23:28 -0000	1.13
***************
*** 34,57 ****
  
  class cShmRemote : public cSoftRemote {
!         public:  
                  cShmRemote(const char *Name)
!                         : cSoftRemote(Name) 
                          {};
!                         
                  ~cShmRemote()
                  {};
  
!                 virtual bool PutKey(uint64 Code, bool Repeat = false, 
                                  bool Release = false);
  };
  
! bool cShmRemote::PutKey(uint64 Code, bool Repeat, 
                                  bool Release) {
!         if (ctl) 
          {
                  SHMDEB("get lock for the key\n");
                  sem_wait_lock(ctl->semid,KEY_MUT);
                  SHMDEB("got lock for the key\n");
!                 
                  ctl->key=Code;
  
--- 34,57 ----
  
  class cShmRemote : public cSoftRemote {
!         public:
                  cShmRemote(const char *Name)
!                         : cSoftRemote(Name)
                          {};
! 
                  ~cShmRemote()
                  {};
  
!                 virtual bool PutKey(uint64 Code, bool Repeat = false,
                                  bool Release = false);
  };
  
! bool cShmRemote::PutKey(uint64 Code, bool Repeat,
                                  bool Release) {
!         if (ctl)
          {
                  SHMDEB("get lock for the key\n");
                  sem_wait_lock(ctl->semid,KEY_MUT);
                  SHMDEB("got lock for the key\n");
! 
                  ctl->key=Code;
  
***************
*** 70,91 ****
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
          xvRemote= new cShmRemote("softdevice-xv");
!         
          signal(SIGINT,sig_handler);
          signal(SIGQUIT,sig_handler);
!         
          int ctl_shmid;
          key_t ctl_key=CTL_KEY;
!  
!         int curr_pict_shmid;
          uint8_t *curr_pict=0;
          uint8_t *curr_osd=0;
          uint8_t *pixel[4];
!        
          if ((ctl_shmid = shmget(ctl_key, sizeof( ShmCtlBlock ), 0666)) < 0) {
                  fprintf(stderr,"ctl_shmid error in shmget!\n");
                  exit(1);
          }
!         
!         if ( (ctl = (ShmCtlBlock *)shmat(ctl_shmid,NULL,0)) 
                          == (ShmCtlBlock *) -1 ) {
                  fprintf(stderr,"ctl_shmid error attatching shm ctl!\n");
--- 70,91 ----
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
          xvRemote= new cShmRemote("softdevice-xv");
! 
          signal(SIGINT,sig_handler);
          signal(SIGQUIT,sig_handler);
! 
          int ctl_shmid;
          key_t ctl_key=CTL_KEY;
! 
!         //int curr_pict_shmid;
          uint8_t *curr_pict=0;
          uint8_t *curr_osd=0;
          uint8_t *pixel[4];
! 
          if ((ctl_shmid = shmget(ctl_key, sizeof( ShmCtlBlock ), 0666)) < 0) {
                  fprintf(stderr,"ctl_shmid error in shmget!\n");
                  exit(1);
          }
! 
!         if ( (ctl = (ShmCtlBlock *)shmat(ctl_shmid,NULL,0))
                          == (ShmCtlBlock *) -1 ) {
                  fprintf(stderr,"ctl_shmid error attatching shm ctl!\n");
***************
*** 97,103 ****
                  exit(-1);
          };
!        
          if ( vout->useShm && vout->xv_image ) {
!                 ctl->pict_shmid= vout->shminfo.shmid;  
                  ctl->max_width=vout->xv_image->width;
                  ctl->max_height=vout->xv_image->height;
--- 97,103 ----
                  exit(-1);
          };
! 
          if ( vout->useShm && vout->xv_image ) {
!                 ctl->pict_shmid= vout->shminfo.shmid;
                  ctl->max_width=vout->xv_image->width;
                  ctl->max_height=vout->xv_image->height;
***************
*** 113,117 ****
  
                  if ( (ctl->pict_shmid = shmget(IPC_PRIVATE,
!                                   ctl->max_width*ctl->max_height*2, 
                                    IPC_CREAT | 0666)) < 0 ) {
                          fprintf(stderr,"error creating  pict_shm!\n");
--- 113,117 ----
  
                  if ( (ctl->pict_shmid = shmget(IPC_PRIVATE,
!                                   ctl->max_width*ctl->max_height*2,
                                    IPC_CREAT | 0666)) < 0 ) {
                          fprintf(stderr,"error creating  pict_shm!\n");
***************
*** 119,123 ****
                  };
  
!                 if ( (curr_pict = (uint8_t*)shmat(ctl->pict_shmid,NULL,0)) 
                                  == (uint8_t*) -1 ) {
                          fprintf(stderr,"error attatching shm ctl!\n");
--- 119,123 ----
                  };
  
!                 if ( (curr_pict = (uint8_t*)shmat(ctl->pict_shmid,NULL,0))
                                  == (uint8_t*) -1 ) {
                          fprintf(stderr,"error attatching shm ctl!\n");
***************
*** 143,147 ****
                  if ( (ctl->osd_shmid = shmget(IPC_PRIVATE,
                                   vout->osd_image->bytes_per_line*
!                                  vout->osd_max_width, 
                                                  IPC_CREAT | 0666)) < 0 ) {
                          fprintf(stderr,"error creating  osd_shm!\n");
--- 143,147 ----
                  if ( (ctl->osd_shmid = shmget(IPC_PRIVATE,
                                   vout->osd_image->bytes_per_line*
!                                  vout->osd_max_width,
                                                  IPC_CREAT | 0666)) < 0 ) {
                          fprintf(stderr,"error creating  osd_shm!\n");
***************
*** 149,153 ****
                  };
  
!                 if ( (curr_osd = (uint8_t*)shmat(ctl->osd_shmid,NULL,0)) 
                                  == (uint8_t*) -1 ) {
                          fprintf(stderr,"error attatching osd shm!\n");
--- 149,153 ----
                  };
  
!                 if ( (curr_osd = (uint8_t*)shmat(ctl->osd_shmid,NULL,0))
                                  == (uint8_t*) -1 ) {
                          fprintf(stderr,"error attatching osd shm!\n");
***************
*** 162,166 ****
                                ctl->osd_xPan,ctl->osd_yPan);
          //printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
!         
          ctl->key=NO_KEY;
          // wakeup remote thread to unsuspend video/audio
--- 162,166 ----
                                ctl->osd_xPan,ctl->osd_yPan);
          //printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
! 
          ctl->key=NO_KEY;
          // wakeup remote thread to unsuspend video/audio
***************
*** 173,177 ****
                  sem_wait_lock(ctl->semid,PICT_MUT,SEM_UNDO);
                  //SHMDEB("got lock\n");
!                
                  if (ctl->new_pict) {
                          int width=ctl->width>ctl->max_width?
--- 173,177 ----
                  sem_wait_lock(ctl->semid,PICT_MUT,SEM_UNDO);
                  //SHMDEB("got lock\n");
! 
                  if (ctl->new_pict) {
                          int width=ctl->width>ctl->max_width?
***************
*** 187,191 ****
                                                  ctl->stride0,ctl->stride1,
                                                  ctl->new_afd,ctl->new_asp);
!                         } else {    
                                  vout->DrawStill_420pl(pixel[0],pixel[2],pixel[1],
                                          width,height,
--- 187,191 ----
                                                  ctl->stride0,ctl->stride1,
                                                  ctl->new_afd,ctl->new_asp);
!                         } else {
                                  vout->DrawStill_420pl(pixel[0],pixel[2],pixel[1],
                                          width,height,
***************
*** 197,201 ****
                  if (ctl->new_osd) {
                          SHMDEB("new osd picture\n");
!                         if ( !vout->useShm ) { 
                                  uint8_t *dest_osd;
                                  int osd_stride;
--- 197,201 ----
                  if (ctl->new_osd) {
                          SHMDEB("new osd picture\n");
!                         if ( !vout->useShm ) {
                                  uint8_t *dest_osd;
                                  int osd_stride;
***************
*** 208,212 ****
                          ctl->new_osd=0;
                  };
!                 
                  vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
                                        ctl->osd_xPan,ctl->osd_yPan);
--- 208,212 ----
                          ctl->new_osd=0;
                  };
! 
                  vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
                                        ctl->osd_xPan,ctl->osd_yPan);
***************
*** 217,221 ****
                  //SHMDEB("released the lock\n");
                  // in case there are no semaphores (no vdr connected)
!                 usleep(13000); 
          };
          ctl->attached=0;
--- 217,221 ----
                  //SHMDEB("released the lock\n");
                  // in case there are no semaphores (no vdr connected)
!                 usleep(13000);
          };
          ctl->attached=0;



From nobody at sheep.berlios.de  Sat Apr 29 08:25:28 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 08:25:28 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.h,1.27,1.28 video.c,1.53,1.54
Message-ID: <200604290625.k3T6PSt28290@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4516

Modified Files:
	setup-softdevice.h video.c 
Log Message:
build for vdr-1.2.x

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** setup-softdevice.h	23 Apr 2006 19:55:53 -0000	1.27
--- setup-softdevice.h	29 Apr 2006 06:25:58 -0000	1.28
***************
*** 13,16 ****
--- 13,18 ----
  #ifndef STAND_ALONE
  #include <vdr/menu.h>
+ #include <vdr/plugin.h>
+ #include <vdr/i18n.h>
  #else
  #include "VdrReplacements.h"

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** video.c	27 Apr 2006 20:29:29 -0000	1.53
--- video.c	29 Apr 2006 06:25:58 -0000	1.54
***************
*** 636,639 ****
--- 636,641 ----
  #else
  
+ #include "SoftOsd.h"
+ 
  bool cVideoOut::OpenWindow(cWindow *Window) {
      layer[Window->Handle()]= new cWindowLayer(Window->X0()+OSDxOfs,



From nobody at sheep.berlios.de  Sat Apr 29 17:56:54 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 17:56:54 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.180,1.181 video.c,1.54,1.55
Message-ID: <200604291556.k3TFust18926@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25820

Modified Files:
	CHANGELOG video.c 
Log Message:
disable interlaced vs. not-interlaced (progressive) reporting

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.180
retrieving revision 1.181
diff -C2 -d -r1.180 -r1.181
*** CHANGELOG	27 Apr 2006 20:32:58 -0000	1.180
--- CHANGELOG	29 Apr 2006 15:57:27 -0000	1.181
***************
*** 1,8 ****
  Changelog
  2006-04-27:
     - change volume handling to no longer change the alsa-mixer settings
     - fix black screen for some aspect ratios using ShmClient
  2006-04-25:
!    - fix ShmClient blank screen every 4s 
  2006-04-24:
     - xv + dfb: removed some unused code.
--- 1,12 ----
  Changelog
+ 2006-04-29:
+    - enable build of ShmClient and video-shm when possible.
+    - disable interlaced vs. not-interlaced (progressive) reporting
+      via syslog. it's changing in seconds intervall for some stations.
  2006-04-27:
     - change volume handling to no longer change the alsa-mixer settings
     - fix black screen for some aspect ratios using ShmClient
  2006-04-25:
!    - fix ShmClient blank screen every 4s
  2006-04-24:
     - xv + dfb: removed some unused code.
***************
*** 11,15 ****
     - dfb: OSD responsivness in paused mode.
  2006-04-23:
!    - added volume changing without changing the alsa-mixer control (to use it 
       add -DNO_MIXER, currently experimental)
     - fix for vdr-1.3.48
--- 15,19 ----
     - dfb: OSD responsivness in paused mode.
  2006-04-23:
!    - added volume changing without changing the alsa-mixer control (to use it
       add -DNO_MIXER, currently experimental)
     - fix for vdr-1.3.48

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.54
retrieving revision 1.55
diff -C2 -d -r1.54 -r1.55
*** video.c	29 Apr 2006 06:25:58 -0000	1.54
--- video.c	29 Apr 2006 15:57:27 -0000	1.55
***************
*** 380,385 ****
    if (interlaceMode != picture->interlaced_frame)
    {
!     dsyslog("[VideoOut]: interlaced mode now: %sinterlaced",
!             (picture->interlaced_frame) ? "" : "non-");
      interlaceMode = picture->interlaced_frame;
    }
--- 380,385 ----
    if (interlaceMode != picture->interlaced_frame)
    {
!     //dsyslog("[VideoOut]: interlaced mode now: %sinterlaced",
!       //      (picture->interlaced_frame) ? "" : "non-");
      interlaceMode = picture->interlaced_frame;
    }



From nobody at sheep.berlios.de  Sat Apr 29 18:00:35 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 18:00:35 +0200
Subject: [Softdevice-cvs] softdevice README,1.17,1.18
Message-ID: <200604291600.k3TG0Zt19043@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26207

Modified Files:
	README 
Log Message:
some more OSD explanations ..

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** README	21 Apr 2006 18:14:42 -0000	1.17
--- README	29 Apr 2006 16:01:09 -0000	1.18
***************
*** 50,54 ****
  -------------
  
! This plugin is written for VDR 1.2.x and VDR 1.3.x
  
  As usual, unpack the plugin and make a link in the
--- 50,54 ----
  -------------
  
! This plugin is written for VDR 1.2.x, VDR 1.3.x and VDR 1.4.x
  
  As usual, unpack the plugin and make a link in the
***************
*** 59,62 ****
--- 59,65 ----
  Available parameters of configure are listed by "./configure --help" .
  
+ Users of vdr-1.2.x have to disable build of shm-out by:
+ ./configure --disable-shm
+ 
  To get rid of these generated files a "make dist-clean" should be done.
  
***************
*** 112,119 ****
  it compile the softdevice with SHM_SUPPORT enabled and start it using
  "-vo shm:". The softdevice will then start with the decoding suspended until
! a client connects to the shared memory. For now there is only an Xv client,
! to build it type "make ShmClient" in the plugin's source directory. To start
! the Xv client simply type "ShmClient", and a window will open from which you
! can use Vdr just like you are used to from the Xv-out will open up. When
  this window is closed the Softdevice will automatically suspend the decoding.
  It is possible to make a client for the other video-out methods too, but
--- 115,121 ----
  it compile the softdevice with SHM_SUPPORT enabled and start it using
  "-vo shm:". The softdevice will then start with the decoding suspended until
! a client connects to the shared memory. For now there is only an Xv client.
! To start the Xv client simply type "ShmClient", and a window will open
! from which you can use Vdr just like you are used to from the Xv-out will open up. When
  this window is closed the Softdevice will automatically suspend the decoding.
  It is possible to make a client for the other video-out methods too, but
***************
*** 133,136 ****
--- 135,178 ----
  ------------------
    Cropping:
+ 
+     CropMode:
+       Output methods: X11-XV, DirectFB, vidix
+       Possible Values: none, 4:3, 16:9, 14:9
+       This option selects either the 4:3, 16:9, 14:9 or no specific
+       area of current video stream. No specific area value will choose
+       the video stream as is.
+ 
+     CropModeToggleKey:
+       Output methods: X11-XV, DirectFB
+       Possible Values: USERx (x = 1 .. 9)
+       You may specify a vdr USERx key of your remote to cycle throu
+       CropModes.
+ 
+     Zoom factor:
+       Output methods: X11-XV, DirectFB, vidix
+       Possible Values: 0 .. 128
+       Zoom calculation: 1 + (value? / 1024) with maximum result 17
+ 
+     Zoom area shift:
+       Output methods: X11-XV, DirectFB, vidix
+       Possible Values: -100 .. 100
+       Value measured in %, shifts the zoomed out part left / up (with
+       negative numbers) or right / down (with positive numbers). All zoom
+       specific values are not stored in vdr's setup.conf file.
+ 
+     Crop lines / columns:
+       Output methods: X11-XV, DirectFB
+       By this you may replace video line from top, bottom, left and right
+       with black lines. It may be usfull, if there is some time code
+       information or some WSS information is present in the viewable
+       area (shown as white dots). Changing these values does not effect
+       displayed aspect ratio.
+ 
+     Expand lines /columns:
+       Output methods: X11-XV, DirectFB, vidix
+       Intention of this option is similar to crop lines. The advantage
+       is the you don't get black lines instead of unwanted content.
+       The disadvantage is that changing these values effects displayed
+       aspect ratio.
  
    Post processing:



From nobody at sheep.berlios.de  Sat Apr 29 22:25:09 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Apr 2006 22:25:09 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.181,1.182 video-dfb.c,1.57,1.58
Message-ID: <200604292025.k3TKP9t29429@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21027

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
fix screen not blanked with audio only stream

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.181
retrieving revision 1.182
diff -C2 -d -r1.181 -r1.182
*** CHANGELOG	29 Apr 2006 15:57:27 -0000	1.181
--- CHANGELOG	29 Apr 2006 20:25:43 -0000	1.182
***************
*** 4,7 ****
--- 4,8 ----
     - disable interlaced vs. not-interlaced (progressive) reporting
       via syslog. it's changing in seconds intervall for some stations.
+    - dfb: fix screen not blanked with audio only stream.
  2006-04-27:
     - change volume handling to no longer change the alsa-mixer settings

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.57
retrieving revision 1.58
diff -C2 -d -r1.57 -r1.58
*** video-dfb.c	24 Apr 2006 22:59:23 -0000	1.57
--- video-dfb.c	29 Apr 2006 20:25:43 -0000	1.58
***************
*** 607,614 ****
    }
  
!   if (OsdRefreshCounter > 2) {
      ShowOSD();
-     OsdRefreshCounter = 0;
-   }
  }
  
--- 607,612 ----
    }
  
!   if (OsdRefreshCounter && (OsdRefreshCount % 3) == 0)
      ShowOSD();
  }
  



From nobody at sheep.berlios.de  Sun Apr 30 15:49:45 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 30 Apr 2006 15:49:45 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.182,1.183 softdevice.c,1.58,1.59
Message-ID: <200604301349.k3UDnjt03161@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4353

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
softdevice-0.2.3

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.182
retrieving revision 1.183
diff -C2 -d -r1.182 -r1.183
*** CHANGELOG	29 Apr 2006 20:25:43 -0000	1.182
--- CHANGELOG	30 Apr 2006 13:50:10 -0000	1.183
***************
*** 1,3 ****
--- 1,4 ----
  Changelog
+ 2006-04-30: softdevice-0.2.3
  2006-04-29:
     - enable build of ShmClient and video-shm when possible.

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.58
retrieving revision 1.59
diff -C2 -d -r1.58 -r1.59
*** softdevice.c	24 Apr 2006 20:36:21 -0000	1.58
--- softdevice.c	30 Apr 2006 13:50:12 -0000	1.59
***************
*** 80,84 ****
  #include "setup-softdevice-menu.h"
  
! static const char *VERSION        = "0.2.2";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 80,84 ----
  #include "setup-softdevice-menu.h"
  
! static const char *VERSION        = "0.2.3";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";



From nobody at sheep.berlios.de  Sun Apr 30 21:28:10 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 30 Apr 2006 21:28:10 +0200
Subject: [Softdevice-cvs] softdevice configure,1.11,1.12
Message-ID: <200604301928.k3UJS9t18336@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25952

Modified Files:
	configure 
Log Message:
configure fix for DirectFB CFLAGS

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** configure	29 Apr 2006 06:20:27 -0000	1.11
--- configure	30 Apr 2006 19:28:47 -0000	1.12
***************
*** 88,92 ****
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++ >/dev/null 2>&1` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
--- 88,92 ----
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++ 2>/dev/null` || dfb="no"
  
  if test "${dfb}" = "yes" ; then



From nobody at sheep.berlios.de  Sun Apr 30 21:31:03 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 30 Apr 2006 21:31:03 +0200
Subject: [Softdevice-cvs] softdevice configure,1.11,1.11.2.1
Message-ID: <200604301931.k3UJV3t18446@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27814

Modified Files:
      Tag: v023_fix
	configure 
Log Message:
configure fix for DirectFB CFLAGS

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.11
retrieving revision 1.11.2.1
diff -C2 -d -r1.11 -r1.11.2.1
*** configure	29 Apr 2006 06:20:27 -0000	1.11
--- configure	30 Apr 2006 19:31:41 -0000	1.11.2.1
***************
*** 88,92 ****
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++ >/dev/null 2>&1` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
--- 88,92 ----
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++ 2>/dev/null` || dfb="no"
  
  if test "${dfb}" = "yes" ; then



From nobody at sheep.berlios.de  Mon May  1 01:48:40 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 1 May 2006 01:48:40 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.58,1.58.2.1
Message-ID: <200604302348.k3UNmet29148@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11192

Modified Files:
      Tag: v023_fix
	video-dfb.c 
Log Message:
compile fix

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.58
retrieving revision 1.58.2.1
diff -C2 -d -r1.58 -r1.58.2.1
*** video-dfb.c	29 Apr 2006 20:25:43 -0000	1.58
--- video-dfb.c	30 Apr 2006 23:49:18 -0000	1.58.2.1
***************
*** 607,611 ****
    }
  
!   if (OsdRefreshCounter && (OsdRefreshCount % 3) == 0)
      ShowOSD();
  }
--- 607,611 ----
    }
  
!   if (OsdRefreshCounter && (OsdRefreshCounter % 3) == 0)
      ShowOSD();
  }



From nobody at sheep.berlios.de  Mon May  1 01:55:37 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 1 May 2006 01:55:37 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.58,1.59
Message-ID: <200604302355.k3UNtbt29363@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12636

Modified Files:
	video-dfb.c 
Log Message:
compile fix

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.58
retrieving revision 1.59
diff -C2 -d -r1.58 -r1.59
*** video-dfb.c	29 Apr 2006 20:25:43 -0000	1.58
--- video-dfb.c	30 Apr 2006 23:56:13 -0000	1.59
***************
*** 607,611 ****
    }
  
!   if (OsdRefreshCounter && (OsdRefreshCount % 3) == 0)
      ShowOSD();
  }
--- 607,611 ----
    }
  
!   if (OsdRefreshCounter && (OsdRefreshCounter % 3) == 0)
      ShowOSD();
  }



From nobody at sheep.berlios.de  Mon May  1 14:15:25 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 1 May 2006 14:15:25 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.h,1.28,1.28.2.1
Message-ID: <200605011215.k41CFPt29903@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8786

Modified Files:
      Tag: v023_fix
	setup-softdevice.h 
Log Message:
64bit compile fix

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.28
retrieving revision 1.28.2.1
diff -C2 -d -r1.28 -r1.28.2.1
*** setup-softdevice.h	29 Apr 2006 06:25:58 -0000	1.28
--- setup-softdevice.h	1 May 2006 12:16:08 -0000	1.28.2.1
***************
*** 115,119 ****
      void          CropModeNext(void);
  
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64_t key);
  
      int   xvAspect;
--- 115,119 ----
      void          CropModeNext(void);
  
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64 key);
  
      int   xvAspect;



From mika.puska at saunalahti.fi  Tue May  2 12:56:03 2006
From: mika.puska at saunalahti.fi (Mika Puska)
Date: Tue, 02 May 2006 13:56:03 +0300
Subject: [Softdevice-cvs] How to change resolution
Message-ID: <44573AC3.7080807@saunalahti.fi>

Im using Directfb and matroxTVout.
How to change resolution from 720x576 to 768x576?
Adjusting directfbrc does?t work?!?




From nobody at sheep.berlios.de  Thu May  4 23:39:09 2006
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 4 May 2006 23:39:09 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.h,1.28,1.29
Message-ID: <200605042139.k44Ld9t26334@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv966

Modified Files:
	setup-softdevice.h 
Log Message:
64bit compile fix for HEAD

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** setup-softdevice.h	29 Apr 2006 06:25:58 -0000	1.28
--- setup-softdevice.h	4 May 2006 21:40:12 -0000	1.29
***************
*** 115,119 ****
      void          CropModeNext(void);
  
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64_t key);
  
      int   xvAspect;
--- 115,119 ----
      void          CropModeNext(void);
  
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64 key);
  
      int   xvAspect;



From nobody at sheep.berlios.de  Sun May  7 22:51:02 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 7 May 2006 22:51:02 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.183,1.184 configure,1.12,1.13 video-dfb.c,1.59,1.60
Message-ID: <200605072051.k47Kp2t15808@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5162

Modified Files:
	CHANGELOG configure video-dfb.c 
Log Message:
video-dfb: preparation for DSBLIT_INTERLACED which results
in better displaying of downscaled 16:9 on 4:3 TVs with matrox.
video-dfb: make YUY2 color info reordering dependant of
interlaced vs. progressive video.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.183
retrieving revision 1.184
diff -C2 -d -r1.183 -r1.184
*** CHANGELOG	30 Apr 2006 13:50:10 -0000	1.183
--- CHANGELOG	7 May 2006 20:52:23 -0000	1.184
***************
*** 1,3 ****
--- 1,10 ----
  Changelog
+ 2006-05-07:
+    - video-dfb: preparation for DSBLIT_INTERLACED which results
+      in better displaying of downscaled 16:9 on 4:3 TVs with matrox.
+    - video-dfb: make YUY2 color info reordering dependant of
+      interlaced vs. progressive video.
+ 2006-05-01:
+    - some fixes for DirectFB compile, configure & 64bit arch .
  2006-04-30: softdevice-0.2.3
  2006-04-29:

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** configure	30 Apr 2006 19:28:47 -0000	1.12
--- configure	7 May 2006 20:52:23 -0000	1.13
***************
*** 98,101 ****
--- 98,102 ----
  dfb_dscaps_double="yes"
  dfb_dief_repeat="yes"
+ dfb_blit_interlaced="yes"
  
  cat > ${TMPC} << EOF
***************
*** 149,152 ****
--- 150,164 ----
  $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dief_repeat="no"
  
+ cat > ${TMPC} << EOF
+ #include <stdio.h>
+ #include <dfb++.h>
+ #include <directfb.h>
+ int main(void) {
+     DFBSurfaceBlittingFlags   flags = DSBLIT_INTERLACED;
+   return 0;
+ }
+ EOF
+ $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_blit_interlaced="no"
+ 
    fi
  fi
***************
*** 304,307 ****
--- 316,325 ----
    else
      echo "#define HAVE_DIEF_REPEAT                0" >> $TMPH
+   fi
+ 
+   if test "${dfb_blit_interlaced}" = "yes" ; then
+     echo "#define HAVE_DSBLIT_INTERLACED          1" >> $TMPH
+   else
+     echo "#define HAVE_DSBLIT_INTERLACED          0" >> $TMPH
    fi
  fi

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.59
retrieving revision 1.60
diff -C2 -d -r1.59 -r1.60
*** video-dfb.c	30 Apr 2006 23:56:13 -0000	1.59
--- video-dfb.c	7 May 2006 20:52:23 -0000	1.60
***************
*** 20,23 ****
--- 20,24 ----
  #else
  # define HAVE_SetSourceLocation 0
+ # define HAVE_DSBLIT_INTERLACED 0
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
  #   define HAVE_GraphicsDeviceDescription 0
***************
*** 166,169 ****
--- 167,173 ----
    if (caps.blitting_flags & DSBLIT_DEMULTIPLY ) fprintf(stderr,"Demultiply ");
    if (caps.blitting_flags & DSBLIT_DEINTERLACE ) fprintf(stderr,"Deinterlace ");
+ #if HAVE_DSBLIT_INTERLACED
+   if (caps.blitting_flags & DSBLIT_INTERLACED ) fprintf(stderr,"Interlaced ");
+ #endif
    fprintf(stderr,"\n");
  }
***************
*** 890,893 ****
--- 894,903 ----
              videoSurface->Release();
            }
+ #if HAVE_DSBLIT_INTERLACED
+ 	  if (setupStore->useMGAtv)
+ 	  {
+ 	    vidDsc.caps = DFB_ADD_SURFACE_CAPS(vidDsc.caps, DSCAPS_INTERLACED);
+ 	  }
+ #endif	  
  
            videoSurface=dfb->CreateSurface(vidDsc);
***************
*** 1206,1211 ****
--- 1216,1234 ----
        }
  
+ #if HAVE_DSBLIT_INTERLACED
+       if (setupStore->useMGAtv)
+       {
+         scrSurface->SetBlittingFlags(DSBLIT_INTERLACED);
+         scrSurface->StretchBlit(videoSurface, &src, &dst);
+       }
+       else
+       {
+         scrSurface->SetBlittingFlags(DSBLIT_NOFX);
+         scrSurface->StretchBlit(videoSurface, &src, &dst);
+       }
+ #else
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
+ #endif      
        if (OSDpresent)
        {
***************
*** 1307,1318 ****
      } else if (pixelformat == DSPF_YUY2) {
  
!       yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!       //yv12_to_yuy2_il_c(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                    Pu + UVstride * cutTop + cutLeft,
!                    Pv + UVstride * cutTop + cutLeft,
!                    dst + pitch * cutTop * 2 + cutLeft * 4,
!                    Width - 2 * (cutLeft + cutRight),
!                    Height - 2 * (cutTop + cutBottom),
!                    Ystride, UVstride, pitch);
       }
  
--- 1330,1350 ----
      } else if (pixelformat == DSPF_YUY2) {
  
!       if (interlaceMode) {
!         yv12_to_yuy2_il_c(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                           Pu + UVstride * cutTop + cutLeft,
!                           Pv + UVstride * cutTop + cutLeft,
!                           dst + pitch * cutTop * 2 + cutLeft * 4,
!                           Width - 2 * (cutLeft + cutRight),
!                           Height - 2 * (cutTop + cutBottom),
!                           Ystride, UVstride, pitch);
!       } else {
!         yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                      Pu + UVstride * cutTop + cutLeft,
!                      Pv + UVstride * cutTop + cutLeft,
!                      dst + pitch * cutTop * 2 + cutLeft * 4,
!                      Width - 2 * (cutLeft + cutRight),
!                      Height - 2 * (cutTop + cutBottom),
!                      Ystride, UVstride, pitch);
!       }
       }
  
***************
*** 1346,1351 ****
--- 1378,1394 ----
        osdMutex.Unlock();
  
+ #if HAVE_DSBLIT_INTERLACED
+       if (setupStore->useMGAtv)
+       {
+         scrSurface->SetBlittingFlags(DSBLIT_INTERLACED);
+         scrSurface->StretchBlit(videoSurface, &src, &dst);
+       } else {
+         scrSurface->SetBlittingFlags(DSBLIT_NOFX);
+         scrSurface->StretchBlit(videoSurface, &src, &dst);
+       }
+ #else
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
+ #endif      
  
        if (OSDpresent)



From nobody at sheep.berlios.de  Tue May 23 21:26:02 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 23 May 2006 21:26:02 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.184,1.185 utils.c,1.13,1.14 utils.h,1.7,1.8 video.c,1.55,1.56 video.h,1.37,1.38
Message-ID: <200605231926.k4NJQ2T18297@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28472

Modified Files:
	CHANGELOG utils.c utils.h video.c video.h 
Log Message:
- move AlphaBlend into utils.c, clean up MMX defines


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.184
retrieving revision 1.185
diff -C2 -d -r1.184 -r1.185
*** CHANGELOG	7 May 2006 20:52:23 -0000	1.184
--- CHANGELOG	23 May 2006 19:30:42 -0000	1.185
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-05-23:
+    - move AlphaBlend into utils.c, clean up MMX defines
  2006-05-07:
     - video-dfb: preparation for DSBLIT_INTERLACED which results

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** utils.c	23 Apr 2006 20:32:45 -0000	1.13
--- utils.c	23 May 2006 19:30:42 -0000	1.14
***************
*** 182,187 ****
      dst += dstStride;
    }
!   __asm__ __volatile__ ("sfence \n"
! 		        "emms \n" : : : "memory");
  }
  
--- 182,187 ----
      dst += dstStride;
    }
!   SFENCE;
!   EMMS;
  }
  
***************
*** 257,263 ****
      dst += dstStride;
    }
!   __asm__ __volatile__ ("sfence \n"
! 		        "emms \n" : : : "memory");
! 
  #endif
  }
--- 257,262 ----
      dst += dstStride;
    }
!   SFENCE;
!   EMMS;
  #endif
  }
***************
*** 553,556 ****
--- 552,632 ----
  }
  
+ 
+ void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
+           uint8_t *alpha,uint16_t count) {
+      // printf("%x %x %x \n",P1,P2,alpha);
+ 
+ #ifdef USE_MMX
+         __asm__(" pxor %%mm3,%%mm3\n"
+ #ifdef USE_MMX2
+                 PREFETCH("(%0)\n")
+                 PREFETCH("(%1)\n")
+                 PREFETCH("(%2)\n")
+                 PREFETCH("64(%0)\n")
+                 PREFETCH("64(%1)\n")
+                 PREFETCH("64(%2)\n")
+                 PREFETCH("128(%0)\n")
+                 PREFETCH("128(%1)\n")
+                 PREFETCH("128(%2)\n")
+ #endif //USE_MMX2
+                 : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
+ 
+         // I guess this can be further improved...
+ 	// Useing prefetch makes it slower on Athlon64,
+ 	// but faster on the Athlon Tbird...
+ 	// Why is prefetching slower on Athlon64????
+         // Because the Athlon64 does automatic block prefetching...
+         while (count>8 ) {
+ #ifdef USE_MMX2
+           if (! (count%8 ) )
+                __asm__(
+                   PREFETCH(" 192(%0)\n")
+                   PREFETCH(" 192(%1)\n")
+                   PREFETCH(" 192(%2)\n")
+                   : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
+ 
+ #endif //USE_MMX2
+          __asm__(
+                 "  movq  (%0),%%mm0\n"
+                 "  movq  (%1),%%mm1\n"
+                 "  movq  (%2),%%mm2\n"
+                 "  movq  %%mm0,%%mm4\n"
+                 "  movq  %%mm1,%%mm5\n"
+                 "  movq  %%mm2,%%mm6\n"
+                 "  punpcklbw %%mm3, %%mm0\n"
+                 "  punpcklbw %%mm3, %%mm1\n"
+                 "  punpcklbw %%mm3, %%mm2\n"
+                 "  punpckhbw %%mm3, %%mm4\n"
+                 "  punpckhbw %%mm3, %%mm5\n"
+                 "  punpckhbw %%mm3, %%mm6\n"
+                 "  psubw %%mm1, %%mm0 \n"
+                 "  psubw %%mm5, %%mm4 \n"
+                 "  psraw $1,%%mm0\n"
+                 "  psraw $1,%%mm4\n"
+                 "  pmullw %%mm2, %%mm0 \n"
+                 "  pmullw %%mm6, %%mm4 \n"
+                 "  psraw $7,%%mm0\n"
+                 "  psraw $7,%%mm4\n"
+                 "  paddw %%mm1, %%mm0 \n"
+                 "  paddw %%mm5, %%mm4 \n"
+                 "  packuswb %%mm4, %%mm0 \n"
+                 MOVNTQ " %%mm0,(%3)\n"
+                 : : "r" (P1), "r" (P2), "r" (alpha),"r"(dest) : "memory");
+                 count-=8;
+                 P1+=8;
+                 P2+=8;
+                 alpha+=8;
+                 dest+=8;
+        }
+        EMMS;
+ #endif //USE_MMX
+ 
+        //fallback version and the last missing bytes...
+        for (int i=0; i < count; i++){
+           dest[i]=(((uint16_t) P1[i] *(uint16_t) alpha[i]) +
+              ((uint16_t) P2[i] *(256-(uint16_t) alpha[i])))  >>8 ;
+        }
+ }
+ 
  uint64_t getTimeMilis(void) {
      struct timeval tv;
***************
*** 562,572 ****
  
  #define MIN_LEN 0x40
- #define PREFETCH "prefetchnta"
- #define EMMS     "emms"
- #ifdef USE_MMX2
- #define MOVNTQ "movntq"
- #else
- #define MOVNTQ "movq"
- #endif
  #define MMREG_SIZE 64
  #define BLOCK_SIZE 4096
--- 638,641 ----
***************
*** 602,610 ****
          /* PREFETCH has effect even for MOVSB instruction ;) */
  	__asm__ __volatile__ (
! 	        PREFETCH" (%0)\n"
! 	        PREFETCH" 64(%0)\n"
! 	        PREFETCH" 128(%0)\n"
!         	PREFETCH" 192(%0)\n"
!         	PREFETCH" 256(%0)\n"
  		: : "r" (from) );
  #endif
--- 671,679 ----
          /* PREFETCH has effect even for MOVSB instruction ;) */
  	__asm__ __volatile__ (
! 	        PREFETCH(" (%0)\n")
! 	        PREFETCH(" 64(%0)\n")
! 	        PREFETCH(" 128(%0)\n")
!         	PREFETCH(" 192(%0)\n")
!         	PREFETCH(" 256(%0)\n")
  		: : "r" (from) );
  #endif
***************
*** 637,641 ****
  		__asm__ __volatile__ (
  #ifdef USE_MMX2
!         	PREFETCH" 320(%0)\n"
  #endif
  		"movq (%0), %%mm0\n"
--- 706,710 ----
  		__asm__ __volatile__ (
  #ifdef USE_MMX2
!         	PREFETCH(" 320(%0)\n")
  #endif
  		"movq (%0), %%mm0\n"
***************
*** 730,734 ****
  		__asm__ __volatile__ (
  #ifdef USE_MMX2
!         	PREFETCH" 320(%0)\n"
  #endif
  		"movq (%0), %%mm0\n"
--- 799,803 ----
  		__asm__ __volatile__ (
  #ifdef USE_MMX2
!         	PREFETCH(" 320(%0)\n")
  #endif
  		"movq (%0), %%mm0\n"
***************
*** 756,764 ****
                  /* since movntq is weakly-ordered, a "sfence"
  		 * is needed to become ordered again. */
! 		__asm__ __volatile__ ("sfence" : : : "memory");
  #endif
  #ifdef USE_MMX
  		/* enables to use FPU */
! 		__asm__ __volatile__ (EMMS : : :"memory");
  #endif
  	}
--- 825,833 ----
                  /* since movntq is weakly-ordered, a "sfence"
  		 * is needed to become ordered again. */
!                  SFENCE;
  #endif
  #ifdef USE_MMX
  		/* enables to use FPU */
! 		EMMS ;
  #endif
  	}

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** utils.h	23 Apr 2006 19:55:53 -0000	1.7
--- utils.h	23 May 2006 19:30:42 -0000	1.8
***************
*** 11,14 ****
--- 11,15 ----
  #include <stdint.h>
  #include <sys/time.h>
+ #include "config.h"
  #include "mmx.h"
  
***************
*** 21,24 ****
--- 22,55 ----
  #endif
  
+ // MMX - 3Dnow! defines
+ 
+ #undef PREFETCH
+ #undef MOVNTQ
+ #undef SFENCE
+ #undef EMMS
+ 
+ #ifdef USE_3DNOW
+ //#warning Using 3Dnow! extensions
+ #define PREFETCH(x) "prefetchnta " x
+ #define MOVNTQ   "movntq "
+ #define SFENCE   __asm__ __volatile__  (" sfence \n": : : "memory"  )
+ #define EMMS     __asm__ __volatile__  (" femms \n": : : "memory"  )
+ 
+ #elif defined ( USE_MMX2 )
+ //#warning Using MMX2 extensions
+ #define PREFETCH(x) "prefetchnta " x
+ #define MOVNTQ   "movntq "
+ #define SFENCE   __asm__ __volatile__  (" sfence \n": : : "memory"  )
+ #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
+ 
+ #else
+ //#warning Using MMX extensions
+ #define PREFETCH(x) 
+ #define MOVNTQ   "movq "
+ #define SFENCE  
+ #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
+ #endif
+ 
+ 
  void yv12_to_yuy2_il_c(const uint8_t *py,
                         const uint8_t *pu,
***************
*** 62,65 ****
--- 93,101 ----
                   int dstW, int dstH,
                   int depth, unsigned char * mask, int deintMethod);
+ 
+ void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
+        uint8_t *alpha,uint16_t count);
+    // performes alpha blending in software
+ 
  uint64_t getTimeMilis(void);
  

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.55
retrieving revision 1.56
diff -C2 -d -r1.55 -r1.56
*** video.c	29 Apr 2006 15:57:27 -0000	1.55
--- video.c	23 May 2006 19:30:42 -0000	1.56
***************
*** 558,637 ****
  }
  
- void cVideoOut::AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
-           uint8_t *alpha,uint16_t count) {
-      // printf("%x %x %x \n",P1,P2,alpha);
- 
- #ifdef USE_MMX
-         __asm__(" pxor %%mm3,%%mm3\n"
- #ifdef USE_MMX2
-                 PREFETCH"(%0)\n"
-                 PREFETCH"(%1)\n"
-                 PREFETCH"(%2)\n"
-                 PREFETCH"64(%0)\n"
-                 PREFETCH"64(%1)\n"
-                 PREFETCH"64(%2)\n"
-                 PREFETCH"128(%0)\n"
-                 PREFETCH"128(%1)\n"
-                 PREFETCH"128(%2)\n"
- #endif //USE_MMX2
-                 : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
- 
-         // I guess this can be further improved...
- 	// Useing prefetch makes it slower on Athlon64,
- 	// but faster on the Athlon Tbird...
- 	// Why is prefetching slower on Athlon64????
-         while (count>8 ) {
- #ifdef USE_MMX2
-           if (! (count%8 ) )
-                __asm__(
-                   PREFETCH" 192(%0)\n"
-                   PREFETCH" 192(%1)\n"
-                   PREFETCH" 192(%2)\n"
-                   : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
- 
- #endif //USE_MMX2
-          __asm__(
-                 "  movq  (%0),%%mm0\n"
-                 "  movq  (%1),%%mm1\n"
-                 "  movq  (%2),%%mm2\n"
-                 "  movq  %%mm0,%%mm4\n"
-                 "  movq  %%mm1,%%mm5\n"
-                 "  movq  %%mm2,%%mm6\n"
-                 "  punpcklbw %%mm3, %%mm0\n"
-                 "  punpcklbw %%mm3, %%mm1\n"
-                 "  punpcklbw %%mm3, %%mm2\n"
-                 "  punpckhbw %%mm3, %%mm4\n"
-                 "  punpckhbw %%mm3, %%mm5\n"
-                 "  punpckhbw %%mm3, %%mm6\n"
-                 "  psubw %%mm1, %%mm0 \n"
-                 "  psubw %%mm5, %%mm4 \n"
-                 "  psraw $1,%%mm0\n"
-                 "  psraw $1,%%mm4\n"
-                 "  pmullw %%mm2, %%mm0 \n"
-                 "  pmullw %%mm6, %%mm4 \n"
-                 "  psraw $7,%%mm0\n"
-                 "  psraw $7,%%mm4\n"
-                 "  paddw %%mm1, %%mm0 \n"
-                 "  paddw %%mm5, %%mm4 \n"
-                 "  packuswb %%mm4, %%mm0 \n"
-                 MOVQ " %%mm0,(%3)\n"
-                 : : "r" (P1), "r" (P2), "r" (alpha),"r"(dest) : "memory");
-                 count-=8;
-                 P1+=8;
-                 P2+=8;
-                 alpha+=8;
-                 dest+=8;
-        }
-        EMMS;
- #endif //USE_MMX
- 
-        //fallback version and the last missing bytes...
-        for (int i=0; i < count; i++){
-           dest[i]=(((uint16_t) P1[i] *(uint16_t) alpha[i]) +
-              ((uint16_t) P2[i] *(256-(uint16_t) alpha[i])))  >>8 ;
-        }
- }
- 
- 
  #else
  
--- 558,561 ----

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** video.h	27 Apr 2006 20:29:29 -0000	1.37
--- video.h	23 May 2006 19:30:42 -0000	1.38
***************
*** 36,62 ****
  #define MAX_PAR 5
  
- // MMX - 3Dnow! defines
- 
- #undef PREFETCH
- #undef EMMS
- 
- #ifdef USE_3DNOW
- //#warning Using 3Dnow! extensions
- #define PREFETCH "prefetch "
- #define MOVQ     "movntq "
- #define EMMS     __asm__ __volatile__  (" femms \n": : : "memory"  )
- #elif defined ( USE_MMX2 )
- //#warning Using MMX2 extensions
- #define PREFETCH "prefetchnta "
- #define MOVQ     "movntq "
- #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
- #else
- //#warning Using MMX extensions
- #define PREFETCH
- #define MOVQ     "movq "
- #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
- #endif
- 
- 
  #if VDRVERSNUM < 10307
  
--- 36,39 ----
***************
*** 247,254 ****
      virtual void CommitUnlockSoftOsdSurface( int osdwidth, int osdheight)
      { OSDpresent=true; OsdWidth=osdwidth; OsdHeight=osdheight; Osd_changed=1;};
- 
-    void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
-        uint8_t *alpha,uint16_t count);
-    // performes alpha blending in software
  
  #else
--- 224,227 ----



From nobody at sheep.berlios.de  Tue May 23 22:24:07 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 23 May 2006 22:24:07 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.185,1.186
Message-ID: <200605232024.k4NKO7T22248@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29956

Modified Files:
	CHANGELOG 
Log Message:
- reenable software alpha blending for video-shm



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.185
retrieving revision 1.186
diff -C2 -d -r1.185 -r1.186
*** CHANGELOG	23 May 2006 19:30:42 -0000	1.185
--- CHANGELOG	23 May 2006 20:28:48 -0000	1.186
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-05-23:
+    - reenable software alpha blending for video-shm
     - move AlphaBlend into utils.c, clean up MMX defines
  2006-05-07:



From nobody at sheep.berlios.de  Tue May 23 23:06:56 2006
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 23 May 2006 23:06:56 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.42,1.43 setup-softdevice.h,1.29,1.30 setup-softdevice-menu.c,1.3,1.4 video.c,1.56,1.57 video.h,1.38,1.39
Message-ID: <200605232106.k4NL6uT23599@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1381

Modified Files:
	setup-softdevice.c setup-softdevice.h setup-softdevice-menu.c 
	video.c video.h 
Log Message:
- merged some defines which belong together
- added 15:9 screen aspect
- fix postprocessing not offered via OSD even detected by configure



Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** setup-softdevice.c	23 Apr 2006 20:21:27 -0000	1.42
--- setup-softdevice.c	23 May 2006 21:11:37 -0000	1.43
***************
*** 176,180 ****
    videoAspectNames[3] = "16:9";  // no need to translate
    videoAspectNames[4] = "16:10"; // no need to translate
!   videoAspectNames[5] = NULL;
  
    suspendVideo[0] = tr("playing");
--- 176,181 ----
    videoAspectNames[3] = "16:9";  // no need to translate
    videoAspectNames[4] = "16:10"; // no need to translate
!   videoAspectNames[5] = "15:9";  // no need to translate
!   videoAspectNames[6] = NULL;
  
    suspendVideo[0] = tr("playing");
***************
*** 326,330 ****
    } else if (!strcasecmp(Name, "PixelAspect")) {
      screenPixelAspect = atoi (Value);
!     screenPixelAspect = clamp (0, screenPixelAspect, 4);
    } else if (!strcasecmp(Name, "OSDalphablend")) {
      osdMode = atoi (Value);
--- 327,331 ----
    } else if (!strcasecmp(Name, "PixelAspect")) {
      screenPixelAspect = atoi (Value);
!     screenPixelAspect = clamp (0, screenPixelAspect, SETUP_VIDEOASPECTNAMES_LAST);
    } else if (!strcasecmp(Name, "OSDalphablend")) {
      osdMode = atoi (Value);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** setup-softdevice.h	4 May 2006 21:40:12 -0000	1.29
--- setup-softdevice.h	23 May 2006 21:11:37 -0000	1.30
***************
*** 19,22 ****
--- 19,26 ----
  #endif
  
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif
+ 
  #define VOUT_XV       1
  #define VOUT_FB       2
***************
*** 75,79 ****
  /*-----------------------------------------------------------------------------
   */
! #define SETUP_VIDEOASPECTNAMES 6
  extern const char *videoAspectNames[SETUP_VIDEOASPECTNAMES];
  
--- 79,85 ----
  /*-----------------------------------------------------------------------------
   */
! #define SETUP_VIDEOASPECTNAMES        7
! #define SETUP_VIDEOASPECTNAMES_COUNT  (SETUP_VIDEOASPECTNAMES-1)
! #define SETUP_VIDEOASPECTNAMES_LAST   (SETUP_VIDEOASPECTNAMES_COUNT-1)
  extern const char *videoAspectNames[SETUP_VIDEOASPECTNAMES];
  

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** setup-softdevice-menu.c	23 Apr 2006 19:55:53 -0000	1.3
--- setup-softdevice-menu.c	23 May 2006 21:11:37 -0000	1.4
***************
*** 298,302 ****
    Add(new cMenuEditStraItem(tr("Screen Aspect"),
                              &data->screenPixelAspect,
!                             (SETUP_VIDEOASPECTNAMES-1),
                              videoAspectNames));
  
--- 298,302 ----
    Add(new cMenuEditStraItem(tr("Screen Aspect"),
                              &data->screenPixelAspect,
!                             SETUP_VIDEOASPECTNAMES_COUNT,
                              videoAspectNames));
  

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** video.c	23 May 2006 19:30:42 -0000	1.56
--- video.c	23 May 2006 21:11:37 -0000	1.57
***************
*** 53,57 ****
    old_picture = NULL;
  
!   for (int i = 0; i < MAX_PAR; ++i)
      parValues [i] = 1.0;
  
--- 53,57 ----
    old_picture = NULL;
  
!   for (int i = 0; i < SETUP_VIDEOASPECTNAMES_COUNT; ++i)
      parValues [i] = 1.0;
  
***************
*** 164,167 ****
--- 164,168 ----
    parValues [3] = (16.0 /  9.0) / displayRatio;
    parValues [4] = (16.0 / 10.0) / displayRatio;
+   parValues [5] = (15.0 /  9.0) / displayRatio;
  }
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** video.h	23 May 2006 19:30:42 -0000	1.38
--- video.h	23 May 2006 21:11:37 -0000	1.39
***************
*** 34,39 ****
  #define OSD_FULL_HEIGHT   576
  
- #define MAX_PAR 5
- 
  #if VDRVERSNUM < 10307
  
--- 34,37 ----
***************
*** 113,117 ****
              interlaceMode,
              displayTimeUS;
!     double  parValues[MAX_PAR];
  
      bool    videoInitialized;
--- 111,115 ----
              interlaceMode,
              displayTimeUS;
!     double  parValues[SETUP_VIDEOASPECTNAMES_COUNT];
  
      bool    videoInitialized;
***************
*** 149,153 ****
      virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
                                    int w, int h, int yPitch, int uvPitch,
!                                   int new_afd=-1, 
                                    double new_asp=0.0);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
--- 147,151 ----
      virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
                                    int w, int h, int yPitch, int uvPitch,
!                                   int new_afd=-1,
                                    double new_asp=0.0);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};



From nobody at sheep.berlios.de  Tue May 23 23:24:14 2006
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 23 May 2006 23:24:14 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.186,1.187 video-dfb.c,1.60,1.61 video-dfb.h,1.19,1.20
Message-ID: <200605232124.k4NLOET24154@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3661

Modified Files:
	CHANGELOG video-dfb.c video-dfb.h 
Log Message:
- fix VIA OSD transparency for newer DirectFB cvs versions


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.186
retrieving revision 1.187
diff -C2 -d -r1.186 -r1.187
*** CHANGELOG	23 May 2006 20:28:48 -0000	1.186
--- CHANGELOG	23 May 2006 21:28:54 -0000	1.187
***************
*** 1,4 ****
--- 1,8 ----
  Changelog
  2006-05-23:
+    - fix VIA OSD transparency for newer DirectFB cvs versions
+    - merged some defines which belong together
+    - added 15:9 screen aspect
+    - fix postprocessing not offered via OSD even detected by configure
     - reenable software alpha blending for video-shm
     - move AlphaBlend into utils.c, clean up MMX defines

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.60
retrieving revision 1.61
diff -C2 -d -r1.60 -r1.61
*** video-dfb.c	7 May 2006 20:52:23 -0000	1.60
--- video-dfb.c	23 May 2006 21:28:54 -0000	1.61
***************
*** 193,196 ****
--- 193,198 ----
    if (scaps & DSCAPS_STATIC_ALLOC) fprintf(stderr,"static-alloc ");
    if (scaps & DSCAPS_TRIPLE) fprintf(stderr,"triple-buffered ");
+ 
+   fprintf(stderr, "PixelFormat = 0x%08x ", surf->GetPixelFormat());
    fprintf(stderr,"\n");
  }
***************
*** 231,238 ****
  /* ---------------------------------------------------------------------------
   */
  cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore)
                : cVideoOut(setupStore)
  {
-     DFBDisplayLayerDescription    desc;
      tLayerSelectItem              *layerInfo;
  
--- 233,267 ----
  /* ---------------------------------------------------------------------------
   */
+ static void ReportLayerInfo(IDirectFBDisplayLayer *layer, char *name)
+ {
+       DFBDisplayLayerConfig layerConfiguration;
+ 
+   if (!layer)
+   {
+     fprintf (stderr, "[dfb] no layer info. layer == NULL\n");
+     return;
+   }
+ 
+   layer->GetConfiguration(&layerConfiguration);
+   {
+     fprintf(stderr,
+             "[dfb] (%s): flags, options, pixelformat: %08x, %08x %08x\n",
+             name,
+             layerConfiguration.flags,
+             layerConfiguration.options,
+             layerConfiguration.pixelformat);
+     fprintf(stderr,
+             "[dfb] (%s): width, height:               %d %d\n",
+             name,
+             layerConfiguration.width,
+             layerConfiguration.height);
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore)
                : cVideoOut(setupStore)
  {
      tLayerSelectItem              *layerInfo;
  
***************
*** 253,256 ****
--- 282,286 ----
    clearBackground = 0;
    clearBackCount = 2; // by default for double buffering;
+   videoLayerLevel = 1;
    OSDpresent = false;
    fieldParity = 0;    // 0 - top field first, 1 - bottom field first
***************
*** 284,287 ****
--- 314,328 ----
      }
  
+     if (!setupStore->useMGAtv)
+     {
+       fprintf(stderr,"[dfb] Configuring CooperativeLevel for OSD\n");
+       osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
+     }
+ 
+     osdLayerDescription = osdLayer->GetDescription();
+ 
+     osdLayer->GetConfiguration(&osdLayerConfiguration);
+     osdLayerConfiguration.flags = DLCONF_ALL;
+ 
      videoLayer = NULL;
      layerInfo = &layerList [ANY_LAYER];
***************
*** 305,334 ****
      }
  
-     scrDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
-                                                  DSDESC_PIXELFORMAT);
-     scrDsc.caps = DSCAPS_NONE;
-     DFB_ADD_SURFACE_CAPS(scrDsc.caps, DSCAPS_FLIPPING);
-     DFB_ADD_SURFACE_CAPS(scrDsc.caps, DSCAPS_PRIMARY);
-     DFB_ADD_SURFACE_CAPS(scrDsc.caps, DSCAPS_VIDEOONLY);
-     //DFB_ADD_SURFACE_CAPS(scrDsc.caps, DSCAPS_DOUBLE);
-     scrDsc.pixelformat = DSPF_ARGB;
- 
-     if (setupStore->useMGAtv)
-     {
-       EnableFieldParity(osdLayer);
-       scrSurface = osdLayer->GetSurface();
-     }
-     else
-     {
-       if (setupStore->viaTv)
-       {
-         EnableFieldParity(videoLayer);
-       }
- 
-       scrSurface = dfb->CreateSurface (scrDsc);
-     }
- 
-     reportSurfaceCapabilities ("scrSurface", scrSurface);
- 
      if (!videoLayer)
      {
--- 346,349 ----
***************
*** 337,350 ****
      }
  
      /* --------------------------------------------------------------------------
       * check for VIA Unichrome presence
       */
!     desc = videoLayer->GetDescription();
!     if (!strcmp (desc.name, "VIA Unichrome Video"))
      {
        isVIAUnichrome = true;
        clearAlpha = 0xff;
      }
  
      if (scrSurface)
      {
--- 352,391 ----
      }
  
+     videoLayerDescription = videoLayer->GetDescription();
+ 
      /* --------------------------------------------------------------------------
       * check for VIA Unichrome presence
       */
!     if (!strcmp (videoLayerDescription.name, "VIA Unichrome Video"))
      {
        isVIAUnichrome = true;
        clearAlpha = 0xff;
+ 
+       ReportLayerInfo(osdLayer, "osdLayer");
+       if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL)
+       {
+ 
+         fprintf(stderr, "[dfb] osdLayer has alpha channel\n");
+         osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
+         videoLayerLevel = -1;
+       }
+       else
+       {
+         fprintf(stderr, "[dfb] osdLayer without !! alpha channel\n");
+       }
      }
  
+     osdLayer->SetCooperativeLevel(DLSCL_EXCLUSIVE);
+     osdLayer->SetConfiguration(osdLayerConfiguration);
+ 
+     if (setupStore->useMGAtv)
+       EnableFieldParity(osdLayer);
+     if (setupStore->viaTv)
+       EnableFieldParity(videoLayer);
+ 
+     scrSurface = osdLayer->GetSurface();
+ 
+     reportSurfaceCapabilities ("scrSurface", scrSurface);
+ 
      if (scrSurface)
      {
***************
*** 413,420 ****
        osdSurface->Clear(0,0,0,clearAlpha); //clear and
  
-       desc = osdLayer->GetDescription();
        fprintf(stderr,
                "[dfb] Using this layer for OSD: (%s - [%dx%d])\n",
!               desc.name, osdSurface->GetWidth(), osdSurface->GetHeight());
  
        reportSurfaceCapabilities ("osdSurface", osdSurface);
--- 454,461 ----
        osdSurface->Clear(0,0,0,clearAlpha); //clear and
  
        fprintf(stderr,
                "[dfb] Using this layer for OSD: (%s - [%dx%d])\n",
!               osdLayerDescription.name,
!               osdSurface->GetWidth(), osdSurface->GetHeight());
  
        reportSurfaceCapabilities ("osdSurface", osdSurface);
***************
*** 452,466 ****
          if (!setupStore->viaTv)
            BESColorkeyState(videoLayer, true);
- 
-         fprintf(stderr,"[dfb] Configuring CooperativeLevel for OSD\n");
-         osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
        }
  
!       desc = osdLayer->GetDescription();
!       fprintf(stderr,"[dfb] Using this layer for OSD: %s\n", desc.name);
! 
!       desc = videoLayer->GetDescription();
!       fprintf(stderr,"[dfb] Using this layer for Video out: %s\n", desc.name);
! 
      }
  
--- 493,503 ----
          if (!setupStore->viaTv)
            BESColorkeyState(videoLayer, true);
        }
  
!       fprintf(stderr,
!               "[dfb] Using this layer for OSD:        %s\n"
!               "[dfb] Using this layer for Video out:  %s\n",
!               osdLayerDescription.name,
!               videoLayerDescription.name);
      }
  
***************
*** 620,624 ****
  {
      DFBDisplayLayerConfig       dlc;
-     DFBDisplayLayerDescription  desc;
      DFBDisplayLayerConfigFlags  failed;
  
--- 657,660 ----
***************
*** 712,717 ****
        pixelformat = dlc.pixelformat;
  
-       desc = videoLayer->GetDescription();
- 
        if (!useStretchBlit)
        {
--- 748,751 ----
***************
*** 725,729 ****
          dlc.options = (DFBDisplayLayerOptions)( DLOP_NONE );
  #if 0
!         if (desc.caps & DLCAPS_DEINTERLACING)
          {
            /* ------------------------------------------------------------------
--- 759,763 ----
          dlc.options = (DFBDisplayLayerOptions)( DLOP_NONE );
  #if 0
!         if (videoLayerDescription.caps & DLCAPS_DEINTERLACING)
          {
            /* ------------------------------------------------------------------
***************
*** 733,737 ****
          }
  #endif
!         if (desc.caps & DLCAPS_ALPHACHANNEL)
          {
            /* ------------------------------------------------------------------
--- 767,784 ----
          }
  #endif
!         if (isVIAUnichrome)
!         {
!           try
!           {
!             videoLayer->SetLevel(videoLayerLevel);
!           }
!           catch (DFBException *ex)
!           {
!             fprintf (stderr,"[dfb] SetParams: action=%s, result=%s Failed: SetLevel()\n",
!                      ex->GetAction(), ex->GetResult());
!             delete ex;
!           }
!         }
!         else if (videoLayerDescription.caps & DLCAPS_ALPHACHANNEL)
          {
            /* ------------------------------------------------------------------
***************
*** 743,747 ****
          else
          {
!           if (desc.caps & DLCAPS_DST_COLORKEY)
            {
              /* ----------------------------------------------------------------
--- 790,794 ----
          else
          {
!           if (videoLayerDescription.caps & DLCAPS_DST_COLORKEY)
            {
              /* ----------------------------------------------------------------
***************
*** 758,773 ****
            fprintf(stderr, "[dfb] SetParams: Enabling DLOP_FIELD_PARITY\n");
          }
-         try
-         {
-           if (isVIAUnichrome)
-             videoLayer->SetLevel(1);
-         }
-         catch (DFBException *ex)
-         {
-           fprintf (stderr,"[dfb] SetParams: action=%s, result=%s Failed: SetLevel()\n",
-                    ex->GetAction(), ex->GetResult());
-           delete ex;
-         }
- 
          /*
           * --------------------------------------------------------------------
--- 805,808 ----
***************
*** 832,837 ****
            delete ex;
          }
! 
!         if (desc.caps & DLCAPS_SCREEN_LOCATION)
          {
            /* ------------------------------------------------------------------
--- 867,871 ----
            delete ex;
          }
!         if (videoLayerDescription.caps & DLCAPS_SCREEN_LOCATION)
          {
            /* ------------------------------------------------------------------
***************
*** 865,869 ****
          try
          {
!           if (desc.caps & DLCAPS_DST_COLORKEY)
              videoLayer->SetDstColorKey(COLORKEY);
  
--- 899,903 ----
          try
          {
!           if (videoLayerDescription.caps & DLCAPS_DST_COLORKEY)
              videoLayer->SetDstColorKey(COLORKEY);
  
***************
*** 899,903 ****
  	    vidDsc.caps = DFB_ADD_SURFACE_CAPS(vidDsc.caps, DSCAPS_INTERLACED);
  	  }
! #endif	  
  
            videoSurface=dfb->CreateSurface(vidDsc);
--- 933,937 ----
  	    vidDsc.caps = DFB_ADD_SURFACE_CAPS(vidDsc.caps, DSCAPS_INTERLACED);
  	  }
! #endif
  
            videoSurface=dfb->CreateSurface(vidDsc);
***************
*** 1230,1234 ****
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
! #endif      
        if (OSDpresent)
        {
--- 1264,1268 ----
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
! #endif
        if (OSDpresent)
        {
***************
*** 1390,1394 ****
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
! #endif      
  
        if (OSDpresent)
--- 1424,1428 ----
        scrSurface->SetBlittingFlags(DSBLIT_NOFX);
        scrSurface->StretchBlit(videoSurface, &src, &dst);
! #endif
  
        if (OSDpresent)

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** video-dfb.h	23 Apr 2006 19:38:29 -0000	1.19
--- video-dfb.h	23 May 2006 21:28:54 -0000	1.20
***************
*** 24,30 ****
  class cDFBVideoOut : public cVideoOut {
    private:
!     IDirectFBDisplayLayer *osdLayer, *videoLayer;
!     DFBSurfaceDescription scrDsc, osdDsc, vidDsc;
!     IDirectFBSurface      *osdSurface, *videoSurface, *scrSurface;
  
      DFBSurfacePixelFormat pixelformat;
--- 24,33 ----
  class cDFBVideoOut : public cVideoOut {
    private:
!     IDirectFBDisplayLayer         *osdLayer, *videoLayer;
!     DFBSurfaceDescription         scrDsc, osdDsc, vidDsc;
!     DFBDisplayLayerDescription    osdLayerDescription,
!                                   videoLayerDescription;
!     DFBDisplayLayerConfig         osdLayerConfiguration;
!     IDirectFBSurface              *osdSurface, *videoSurface, *scrSurface;
  
      DFBSurfacePixelFormat pixelformat;
***************
*** 43,46 ****
--- 46,50 ----
            fieldParity;
      int   prevOsdMode;
+     int   videoLayerLevel;
  
      void SetParams();



From nobody at sheep.berlios.de  Tue May 23 23:26:58 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 23 May 2006 23:26:58 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice-menu.c,1.4,1.5
Message-ID: <200605232126.k4NLQwT24247@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3915

Modified Files:
	setup-softdevice-menu.c 
Log Message:
- reenable software alpha blending for video-shm


Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** setup-softdevice-menu.c	23 May 2006 21:11:37 -0000	1.4
--- setup-softdevice-menu.c	23 May 2006 21:31:40 -0000	1.5
***************
*** 301,305 ****
                              videoAspectNames));
  
!   if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_VIDIX)
    {
      osdModeNames[0] = tr("pseudo");
--- 301,306 ----
                              videoAspectNames));
  
!   if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_VIDIX
!       || data->outputMethod == VOUT_SHM )
    {
      osdModeNames[0] = tr("pseudo");



From nobody at sheep.berlios.de  Thu May 25 16:23:34 2006
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 25 May 2006 16:23:34 +0200
Subject: [Softdevice-cvs] softieee1394/patches libavc1394-0.5.3-read-mic-00.diff,NONE,1.1
Message-ID: <200605251423.k4PENYT11451@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394/patches
In directory sheep:/tmp/cvs-serv12773

Added Files:
	libavc1394-0.5.3-read-mic-00.diff 
Log Message:
include patch for libavc1394-0.5.3

--- NEW FILE: libavc1394-0.5.3-read-mic-00.diff ---
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394.h libavc1394-0.5.3.read-mic/libavc1394/avc1394.h
--- libavc1394-0.5.3.orig/libavc1394/avc1394.h	2006-05-22 02:11:14.000000000 +0200
+++ libavc1394-0.5.3.read-mic/libavc1394/avc1394.h	2006-05-24 18:53:17.000000000 +0200
@@ -329,6 +329,14 @@
 #define AVC1394_VCR_OPERAND_TRANSPORT_STATE 0x7F
 #define AVC1394_VCR_OPERAND_RECORDING_TIME_STATUS 0x71
 
+#define AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_SEEK    0x20
+#define AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_STATUS  0x71
+
+#define AVC1394_VCR_OPERAND_MIC_CLOSE       0x00
+#define AVC1394_VCR_OPERAND_MIC_READ_OPEN   0x01
+#define AVC1394_VCR_OPERAND_MIC_STATE       0xFF
+#define AVC1394_VCR_OPERAND_MIC_WRITE_OPEN  0x03
+
 /* recording speed */
 #define AVC1394_VCR_OPERAND_RECORDING_SPEED_STANDARD 0x6F
 
@@ -426,6 +434,34 @@
 #define AVC1394_PANEL_OPERATION_SUBPICTURE 0x51
 
 
+#define MAX_MIC_SIZE      (64*1024)
+#define MIC_HEADER_SIZE   16
+#define MIC_ADDINFO_SIZE  10
+#define MIC_ENTRY_SIZE    10
+
+#define MIC_TAG_ATN       0x0B
+#define MIC_TAG_NAME      0x18
+#define MIC_TAG_INFO      0x42
+
+#define MIC_TAG_INFO_DT         0x00
+#define MIC_TAG_INFO_TAPE_NAME  0x06
+#define MIC_TAG_INFO_NONE       0x07
+
+typedef struct {
+  int atn;
+  int year;
+  int day;
+  int hour;
+  int minute;
+} t_mic_jump_mark;
+
+typedef struct {
+  int uatn;
+  int eom_atn;
+  t_mic_jump_mark jump_mark[(MAX_MIC_SIZE-(MIC_HEADER_SIZE+MIC_ADDINFO_SIZE)) /
+                            MIC_ENTRY_SIZE];
+} t_mic_directory;
+
 enum avc1394_measurement_unit {
     AVC1394_VCR_MEASUREMENT_VIDEO_FRAME = 0,
     AVC1394_VCR_MEASUREMENT_VIDEO_SCENE,
@@ -459,6 +495,10 @@ quadlet_t *
 avc1394_transaction_block(raw1394handle_t handle, nodeid_t node,
 	quadlet_t *request, int len, int retry);
 
+quadlet_t *
+avc1394_transaction_block_byte(raw1394handle_t handle, nodeid_t node,
+  quadlet_t *buf, int len, int retry);
+
 void 
 avc1394_transaction_block_close(raw1394handle_t handle);
 
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_internal.c libavc1394-0.5.3.read-mic/libavc1394/avc1394_internal.c
--- libavc1394-0.5.3.orig/libavc1394/avc1394_internal.c	2006-04-13 18:16:41.000000000 +0200
+++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_internal.c	2006-05-24 22:15:47.000000000 +0200
@@ -90,10 +90,13 @@ int avc_fcp_handler(raw1394handle_t hand
 			raw1394_stop_fcp_listen(handle);
 
 		if (fr->length == 0) {
-			if ( *((quadlet_t*)data) != 0 )
+			if ( *((quadlet_t*)data) != 0 ) {
 				fr->length = (length + sizeof(quadlet_t) - 1) / sizeof(quadlet_t);
-			else
+				fr->length_byte = length;
+			} else {
 				fr->length = 0;
+				fr->length_byte = 0;
+		  }
 			memcpy(fr->data, data, length);
 		}
 	}
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_internal.h libavc1394-0.5.3.read-mic/libavc1394/avc1394_internal.h
--- libavc1394-0.5.3.orig/libavc1394/avc1394_internal.h	2006-04-13 18:16:41.000000000 +0200
+++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_internal.h	2006-05-25 16:00:09.000000000 +0200
@@ -14,6 +14,7 @@
 struct fcp_response {
 	quadlet_t data[MAX_RESPONSE_SIZE / sizeof(quadlet_t)];
 	unsigned int length;
+	unsigned int length_byte;
 };
 
 void htonl_block(quadlet_t *buf, int len);
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_simple.c libavc1394-0.5.3.read-mic/libavc1394/avc1394_simple.c
--- libavc1394-0.5.3.orig/libavc1394/avc1394_simple.c	2006-04-13 18:16:41.000000000 +0200
+++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_simple.c	2006-05-25 09:11:29.000000000 +0200
@@ -43,6 +43,7 @@
 #include <sys/poll.h>
 #include <unistd.h>
 #include <time.h>
+#include <ctype.h>
 #include <string.h>
 #include <netinet/in.h>
 #include <stdlib.h>
@@ -80,6 +81,26 @@ int avc1394_send_command_block(raw1394ha
 }
 
 
+int avc1394_send_command_block_byte(raw1394handle_t handle, nodeid_t node,
+                                    quadlet_t *command, int command_len)
+{
+	quadlet_t cmd[command_len];
+	int i;
+
+	for (i=0; i < command_len; i++) {
+		cmd[i] = htonl(command[i]);
+	}
+
+#ifdef DEBUG
+	fprintf(stderr, "avc1394_send_command_block_byte: ");
+	for (i=0; i < command_len; i++)
+		fprintf(stderr, " 0x%08X", htonl(command[i]));
+	fprintf(stderr, " (%s)\n", decode_ctype(command[0]));
+#endif
+	return cooked1394_write(handle, 0xffc0 | node, FCP_COMMAND_ADDR,
+	                        command_len, cmd);
+}
+
 /*
  * Send an AV/C request to a device, wait for the corresponding AV/C
  * response and return that. This version only uses quadlet transactions.
@@ -275,6 +296,91 @@ void avc1394_transaction_block_close(raw
 }
 
 
+quadlet_t *avc1394_transaction_block_byte(raw1394handle_t handle, nodeid_t node,
+                                          quadlet_t *buf, int len, int retry)
+{
+
+  quadlet_t           *response = NULL;
+  struct pollfd       raw1394_poll;
+	struct fcp_response *fr = NULL;
+
+  raw1394_poll.fd = raw1394_get_fd(handle);
+  raw1394_poll.events = POLLIN;
+	if (!(fr = calloc(1, sizeof(struct fcp_response))))
+		return NULL;
+
+  do {
+		response = NULL;
+		fr->length = 0;
+
+    init_avc_response_handler(handle, fr);
+    if (avc1394_send_command_block_byte(handle, node, buf, len) < 0) {
+         struct timespec ts = {0, AVC1394_SLEEP};
+      fprintf(stderr,"send oops\n");
+      nanosleep(&ts, NULL);
+      continue;
+    }
+
+		// Only poll if the receive handler hasn't been called yet.
+		// This can occur while waiting for command acknowledgement inside of
+		// raw1394_write.
+		if (fr->length==0) {
+      if ( poll( &raw1394_poll, 1, AVC1394_POLL_TIMEOUT) > 0 ) {
+        if (raw1394_poll.revents & POLLIN) {
+          raw1394_loop_iterate(handle);
+          response =  fr->data;
+          ntohl_block(response, 1);
+        }
+      }
+		} else {
+			response = fr->data;
+			ntohl_block(response, 1);
+		}
+
+    if (response != NULL) {
+      while (AVC1394_MASK_RESPONSE(response[0]) == AVC1394_RESPONSE_INTERIM) {
+#ifdef DEBUG
+        fprintf(stderr,"INTERIM\n");
+#endif
+				response = NULL;
+				fr->length = 0;
+
+        if ( poll( &raw1394_poll, 1, AVC1394_POLL_TIMEOUT) > 0 ) {
+          if (raw1394_poll.revents & POLLIN) {
+            raw1394_loop_iterate(handle);
+            response = fr->data;
+            ntohl_block(response, 1);
+          }
+        }
+      }
+    }
+		stop_avc_response_handler(handle);
+
+#ifdef DEBUG
+    if (response != NULL) {
+        int i;
+      fprintf(stderr, "avc1394_transaction_block_byte received response: \n");
+      for (i=0; i<fr->length_byte; i++)
+        fprintf(stderr, "%02X ", response[i]);
+
+      fprintf(stderr, " (%s)\n", decode_response(response[0]));
+
+      for (i=0; i<gfr->length_byte; i++)
+        fprintf(stderr, " %c ",
+        isprint(response[i]) ? gresponse[i]:'.');
+      fprintf(stderr, " (%s)\n", decode_response(response[0]));
+    }
+#endif
+
+    if (response != NULL)
+      return response;
+
+  } while (--retry >= 0);
+
+  stop_avc_response_handler(handle);
+  return NULL;
+}
+
 /*---------------------
  * HIGH-LEVEL-FUNCTIONS
  * --------------------
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.c libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.c
--- libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.c	2006-04-13 18:16:41.000000000 +0200
+++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.c	2006-05-25 16:03:40.000000000 +0200
@@ -22,6 +22,7 @@
 #include <unistd.h>
 #include <stdio.h>
 #include <stdlib.h>
+#include <string.h>
 #include "avc1394_vcr.h"
 #include "avc1394.h"
 
@@ -345,3 +346,325 @@ avc1394_vcr_seek_timecode(raw1394handle_
 	
 	avc1394_send_command_block( handle, node, request, 2);
 }
+
+
+/* ----------------------------------------------------------------------------
+ */
+void
+avc1394_vcr_seek_atn(raw1394handle_t handle, nodeid_t node,
+                     int atn, int mt, int mtd, int sfbf)
+{
+    quadlet_t request[2];
+    quadlet_t *response;
+
+  request[0] = CTLVCR0 |
+                AVC1394_VCR_COMMAND_ABSOLUTE_TRACK_NUMBER |
+                AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_SEEK;
+
+  if (mt == 0x1f) {
+    atn <<= 1;
+    atn |= (sfbf & 1);
+    request[1] = (atn << 24) |
+                 ((atn & 0x0000ff00) << 8) |
+                 ((atn & 0x00ff0000) >> 8) |
+                 (mt << 3) |
+                 (mtd & 7);
+  } else if (mt == 0x01) {
+    ;
+  } else {
+    return;
+  }
+  response = avc1394_transaction_block( handle, node, request, 2, AVC1394_RETRY);
+}
+
+/* ----------------------------------------------------------------------------
+ */
+int
+avc1394_vcr_get_atn(raw1394handle_t handle, nodeid_t node,
+                    int *atn, int *mt, int *mtd, int *sfbf)
+{
+    quadlet_t request[2];
+    quadlet_t *response;
+
+  request[0] = STATVCR0 |
+                AVC1394_VCR_COMMAND_ABSOLUTE_TRACK_NUMBER |
+                AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_STATUS;
+  request[1] = 0xFFFFFFFF;
+
+  response = avc1394_transaction_block( handle, node, request, 2, AVC1394_RETRY);
+  if (response == NULL)
+    return -1;
+
+  *mt = (response[1] & 0x000000F8) >> 3;
+  *mtd = response[1] & 0x00000007;
+  if (*mt == 0x1F) {
+    *atn = (response[1] & 0xff000000) >> 24 |
+           (response[1] & 0x00ff0000) >>  8 |
+           (response[1] & 0x0000ff00) <<  8;
+    *atn >>= 1; /* shift out bf flag */
+    *sfbf = (response[1] & 0x01000000) >> 24;
+    /* to get the real tape position in h:mm:ss:ff, calculation depends
+     * on PAL/NTSC
+     * for PAL: *atn /= 12; for NTSC *atn /= 10 (number of DIF sequences ?)
+     * *atn /= fps (25 or 30) to get the absolute frame number on tape
+     */
+  } else if (*mt == 0x01) {
+    *atn = (response[1] & 0x3f000000) >> 23 | /* ignore sf flag */
+           (response[1] & 0x00ff0000) >>  7 |
+           (response[1] & 0x0000ff00) >>  7;
+    *sfbf = (response[1] & 0xC0000000) >> 30;
+  } else {
+    return -2;
+  }
+
+  fprintf(stderr," ATN_raw = 0x%08x\n", response[1]);
+  return 0;
+}
+
+/* ----------------------------------------------------------------------------
+ */
+int
+avc1394_vcr_get_mic_status(raw1394handle_t handle, nodeid_t node)
+{
+    quadlet_t response;
+  /* --------------------------------------------------------------------------
+   * check current status of MIC
+   */
+  response = avc1394_transaction(handle, node,
+                                 STATVCR0 |
+                                    AVC1394_VCR_COMMAND_OPEN_MIC |
+                                    AVC1394_VCR_OPERAND_MIC_STATE,
+                                 AVC1394_RETRY);
+
+  fprintf (stderr, "MIC status = %02x \n", AVC1394_GET_OPERAND0(response));
+  return AVC1394_GET_OPERAND0(response);
+}
+
+int
+avc1394_vcr_mic_open_read(raw1394handle_t handle, nodeid_t node)
+{
+    quadlet_t response;
+  /* --------------------------------------------------------------------------
+   * open mic for read access
+   */
+  response = avc1394_transaction(handle, node,
+                                 CTLVCR0 |
+                                    AVC1394_VCR_COMMAND_OPEN_MIC |
+                                    AVC1394_VCR_OPERAND_MIC_READ_OPEN,
+                                 AVC1394_RETRY);
+
+  fprintf (stderr, "MIC open read status = %02x \n",
+           AVC1394_GET_OPERAND0(response));
+  return AVC1394_GET_OPERAND0(response);
+}
+
+int
+avc1394_vcr_mic_close(raw1394handle_t handle, nodeid_t node)
+{
+    quadlet_t response;
+  /* --------------------------------------------------------------------------
+   * close mic
+   */
+  response = avc1394_transaction(handle, node,
+                                 CTLVCR0 |
+                                    AVC1394_VCR_COMMAND_OPEN_MIC |
+                                    AVC1394_VCR_OPERAND_MIC_CLOSE,
+                                 AVC1394_RETRY);
+
+  fprintf (stderr, "MIC close status = %02x \n", AVC1394_GET_OPERAND0(response));
+  return AVC1394_GET_OPERAND0(response);
+}
+
+void
+avc1394_make_atn (unsigned char *p)
+{
+}
+
+void
+avc1394_mic_atn2str(unsigned char *p, char *strP, char *strN)
+{
+    int atn = 0;
+
+  if (*(p + 4) >> 3 == 0x1f) {
+    atn = (*(p+1) | *(p+2) << 8 | *(p+3) << 16) >> 1;
+  } else if (*(p + 4) >> 3 == 0x1f) {
+    atn = (*(p+3) << 1 | *(p+2) << 9 | (*(p+1) & 0x3f) << 17);
+  }
+  sprintf (strP,
+           "%02d:%02d:%02d.%02d",
+           (atn / (12 * 25 * 60 * 60)) % 24,
+           (atn / (12 * 25 * 60)) % 60,
+           (atn / (12 * 25)) % 60,
+           (atn / 12) % 25);
+  sprintf (strN,
+           "%02d:%02d:%02d.%02d",
+           (atn / (10 * 30 * 60 * 60)) % 24,
+           (atn / (10 * 30 * 60)) % 60 ,
+           (atn / (10 * 30) % 60),
+           (atn / 10) % 30);
+}
+
+void
+avc1394_mic_datetime2str(unsigned char *p, char *d, char *t)
+{
+  sprintf (d,
+           "%02d-%02d-%02d",
+           (*(p+3) & 0xE0) >> 1 | (*(p+4) & 0xF0) >> 4,
+           *(p+4) & 0x0f,
+           *(p+3) & 0x1f);
+  sprintf (t,
+           "%02d:%02d",
+           *(p+2) & 0x1F,
+           *(p+1) & 0x3F);
+}
+
+/*
+ */
+int
+avc1394_vcr_parse_mic_info (unsigned char *mic_data, int len, int prt)
+{
+    unsigned char *p;
+    int           l,
+                  marker;
+    char          buf1 [16],
+                  buf2 [16];
+
+
+  if (prt)
+    fprintf(stderr, "MIC info start\n");
+  p = mic_data;
+  l = len;
+  /* check header */
+
+  p += 11;
+  l -= 11;
+  /* get tape end ATN */
+  if (l < len && *p == 0x1F) {
+    if ((len - l) > 5) {
+      if (prt) {
+        avc1394_mic_atn2str (p, buf1, buf2);
+        fprintf (stderr, "  tape end : %s\n", buf1);
+      }
+    }
+    p += 5; l -= 5;
+  }
+
+  p += 5; l -= 5;
+
+  marker = 1;
+  while (l < len && *p == 0x0b) {
+    if ((len-l) > 10) {
+      if (prt) {
+        avc1394_mic_atn2str (p, buf1, buf2);
+        fprintf (stderr, "  %2d.      : %s ", marker, buf1);
+      }
+      p += 5; l -= 5;
+      if (*p == 0x42) {
+        if (prt) {
+          avc1394_mic_datetime2str(p, buf1, buf2);
+          fprintf (stderr, "%s %s\n", buf1, buf2);
+        }
+      } else {
+        if (prt) {
+          fprintf(stderr,"\n");
+        }
+      }
+      marker++;
+      p += 5; l -= 5;
+      continue;
+    }
+    p++; l--;
+  }
+  if (l < len && *p == 0x18) {
+    if (prt) {
+      fprintf (stderr,"  tape name: %*.*s\n", *(p+1),*(p+1), p+4);
+    }
+  }
+  if (prt)
+    fprintf(stderr, "MIC info done!\n");
+  return 0;
+}
+
+/* Get all data from mic */
+void
+avc1394_vcr_get_mic_info(raw1394handle_t handle, nodeid_t node,
+                         unsigned char **mic_data, int *datalen)
+{
+    int           i,
+                  addr,
+                  count;
+    unsigned char buf[MAX_MIC_SIZE],
+                  *p;
+    quadlet_t     request[512],
+                  *response;
+
+  if (mic_data) {
+    if (*mic_data) {
+      free(*mic_data);
+    }
+    *mic_data = NULL;
+  }
+  if (datalen) {
+    *datalen = 0;
+  }
+
+  count = 0;
+
+  avc1394_vcr_get_mic_status (handle, node);
+
+  /* --------------------------------------------------------------------------
+   * next steps are:
+   * - open mic for read only
+   * - read all mic data
+   * - close mic
+   */
+  avc1394_vcr_mic_open_read (handle, node);
+  avc1394_vcr_get_mic_status (handle, node);
+  for (i = 0, addr = 0; i < 34; i++) {
+    request[0] = CTLVCR0 | AVC1394_VCR_COMMAND_READ_MIC | 0x30;
+    request[1] = addr << 16;
+    response = avc1394_transaction_block_byte(handle, node,
+                                              request, 6, AVC1394_RETRY);
+    if (response) {
+      if (AVC1394_MASK_RESPONSE(*response) != AVC1394_RESPONSE_ACCEPTED)
+        break;
+      p = (unsigned char *) response;
+      memcpy (buf+addr, p+6, AVC1394_MASK_RESPONSE_OPERAND(*response,3));
+      count += AVC1394_MASK_RESPONSE_OPERAND(*response,3);
+      addr += AVC1394_MASK_RESPONSE_OPERAND(*response,3);
+    }
+  }
+  fprintf (stderr, " got %d bytes from MIC\n", count);
+  if (count) {
+    if (datalen) {
+      *datalen = count;
+    }
+    if (mic_data) {
+      if ((*mic_data = malloc (count))) {
+        memcpy (*mic_data, buf, count);
+      }
+    }
+  }
+
+  avc1394_vcr_mic_close (handle, node);
+  //avc1394_vcr_get_mic_status (handle, node);
+}
+
+void
+avc1394_vcr_medium_info(raw1394handle_t handle, nodeid_t node,
+                         unsigned char *medium_info, unsigned char *medium_type)
+{
+    unsigned char *p;
+    quadlet_t     request[2],
+                  *response;
+
+  request[0] = STATVCR0 | AVC1394_VCR_COMMAND_MEDIUM_INFO | 0x7F;
+  request[1] = 0x7F000000;
+  response = avc1394_transaction_block_byte(handle, node,
+                                            request, 5, AVC1394_RETRY);
+  if (response) {
+      p = (unsigned char *) response;
+
+    fprintf(stderr," -- type(%02x) grade(%02x)\n", p[0], p[4]);
+  }
+}
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.h libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.h
--- libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.h	2006-04-13 18:16:41.000000000 +0200
+++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.h	2006-05-24 19:04:46.000000000 +0200
@@ -114,6 +114,20 @@ avc1394_vcr_get_timecode2(raw1394handle_
 void
 avc1394_vcr_seek_timecode(raw1394handle_t handle, nodeid_t node, char *timecode);
 
+void
+avc1394_vcr_get_mic_info(raw1394handle_t handle, nodeid_t node,
+                         unsigned char **mic_data, int *datalen);
+int
+avc1394_vcr_parse_mic_info (unsigned char *mic_data, int len, int flag);
+
+int
+avc1394_vcr_get_atn(raw1394handle_t handle, nodeid_t node,
+                    int *atn, int *mt, int *mtd, int *sfbf);
+
+void
+avc1394_vcr_seek_atn(raw1394handle_t handle, nodeid_t node,
+                     int atn, int mt, int mtd, int sfbf);
+
 #ifdef __cplusplus
 }
 #endif
Only in libavc1394-0.5.3.orig: libavc1394.pc
Only in libavc1394-0.5.3.orig: libavc1394.spec
diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/test/dvcont.c libavc1394-0.5.3.read-mic/test/dvcont.c
--- libavc1394-0.5.3.orig/test/dvcont.c	2006-04-13 18:16:41.000000000 +0200
+++ libavc1394-0.5.3.read-mic/test/dvcont.c	2006-05-25 16:02:45.000000000 +0200
@@ -71,6 +71,9 @@ printf("\nversion - Tell the program to 
 printf("\nhelp - Tell the program to show you this screen");
 printf("\ndev <number> - Select device number on chain to use.");
 printf("\n               (use the dev command BEFORE any other commands)");
+printf("\nmic      - read out MIC eeprom of cassete if present");
+printf("\natn      - read out ATN Absolute Track Number (position of tape)");
+printf("\natn_seek - seek to given ATN");
 printf("\n\n");
 
 }
@@ -247,6 +250,47 @@ int main (int argc, char *argv[])
 #endif
 			}
 			avc1394_transaction_block_close(handle);
+		} else if (strcmp("mic", argv[i]) == 0) {
+				unsigned char *mic_data = NULL;
+				int           len = 0;
+
+			avc1394_vcr_get_mic_info (handle, device,
+			                          &mic_data, &len);
+			avc1394_vcr_parse_mic_info (mic_data, len, 1);
+		} else if (strcmp("atn", argv[i]) == 0) {
+				int atn, med, med_dep, sfbf;
+			if (avc1394_vcr_get_atn (handle, device, &atn, &med, &med_dep, &sfbf) == 0)
+			{
+				fprintf (stderr,
+				         "atn = %08x, "
+				          "(tape position [PAL/NTSC] = "
+				              "%02d:%02d:%02d:%02d/%02d:%02d:%02d:%02d) "
+				          "media = %s, (%sontigous numbers)\n",
+				         atn,
+				         (atn / (12 * 25 * 60 * 60)) % 24,
+				         (atn / (12 * 25 * 60)) % 60,
+				         (atn / (12 * 25)) % 60,
+				         (atn / 12) % 25,
+				         (atn / (10 * 30 * 60 * 60)) % 24,
+				         (atn / (10 * 30 * 60)) % 60 ,
+				         (atn / (10 * 30) % 60),
+				         (atn / 10) % 30,
+				         (med == 0x1f) ? "DVCR" :
+				            (med == 0x01) ? "D-VHS": "unknown",
+				         (!sfbf) ? "NOT C" : "C");
+			}
+		} else if (strcmp("atn_seek", argv[i]) == 0) {
+				int atn, mt, mtd, sfbf;
+			atn = 0x00005160;
+			mt  = 0x1f;
+			mtd = 7;
+			sfbf = 1;
+			avc1394_vcr_seek_atn (handle, device,
+			                      atn, mt, mtd, sfbf);
+		} else if (strcmp("medium", argv[i]) == 0) {
+				unsigned char m, g;
+			avc1394_vcr_medium_info (handle, device, &m, &g);
+      fprintf(stderr, "----\n");
 		}
 	}
 		



From nobody at sheep.berlios.de  Thu May 25 19:43:26 2006
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 25 May 2006 19:43:26 +0200
Subject: [Softdevice-cvs] softieee1394 HISTORY,1.3,1.4 Makefile,1.2,1.3 README,1.2,1.3 avc-handler.c,1.2,1.3
Message-ID: <200605251743.k4PHhQT26624@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394
In directory sheep:/tmp/cvs-serv22478

Modified Files:
	HISTORY Makefile README avc-handler.c 
Log Message:
- new patch for current libavc-0.5.3
- update for vdr-1.4.0
- some changes due to ffmpeg



Index: HISTORY
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/HISTORY,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** HISTORY	12 Sep 2005 12:17:07 -0000	1.3
--- HISTORY	25 May 2006 17:48:19 -0000	1.4
***************
*** 1,4 ****
--- 1,8 ----
  VDR Plugin 'softieee1394' Revision History
  ------------------------------------------
+ 2006-05-25:
+   - new patch for current libavc-0.5.3
+   - update for vdr-1.4.0
+   - some changes due to ffmpeg
  2005-09-12:
    - do not offer a mainmenu entry if there are no ieee1394 devices.

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/Makefile,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** Makefile	12 Sep 2005 12:17:07 -0000	1.2
--- Makefile	25 May 2006 17:48:19 -0000	1.3
***************
*** 19,23 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -Woverloaded-virtual
  
  ### The directory environment:
--- 19,23 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -fPIC -Woverloaded-virtual
  
  ### The directory environment:
***************
*** 35,38 ****
--- 35,43 ----
  
  VDRVERSION = $(shell grep 'define VDRVERSION ' $(VDRDIR)/config.h | awk '{ print $$3 }' | sed -e 's/"//g')
+ APIVERSION = $(shell sed -ne '/define APIVERSION/ { s/^.*"\(.*\)".*$$/\1/; p }' $(VDRDIR)/config.h)
+ 
+ ifeq ($(APIVERSION),)
+        APIVERSION = $(VDRVERSION)
+ endif
  
  ### The name of the distribution archive:
***************
*** 72,76 ****
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  dist: clean
--- 77,81 ----
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  dist: clean

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/README,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** README	12 Sep 2005 12:17:07 -0000	1.2
--- README	25 May 2006 17:48:19 -0000	1.3
***************
*** 23,30 ****
  Patches:
    You need to patch libavc1394. Therefore the only supported version
!   is 0.5.0. The patch required is in directory patches. The usual procedure
    for doing this is:
    1. cd to_your_libavc1394_directory
!   2. patch --dry-run <path_to_patch_directory/patch_file
    3. if that was succesfully (no rejects or failed messages)
       patch <path_to_patch_directory/patch_file
--- 23,30 ----
  Patches:
    You need to patch libavc1394. Therefore the only supported version
!   is 0.5.3. The patch required is in directory patches. The usual procedure
    for doing this is:
    1. cd to_your_libavc1394_directory
!   2. patch --dry-run -p 1 <path_to_patch_directory/patch_file
    3. if that was succesfully (no rejects or failed messages)
       patch <path_to_patch_directory/patch_file
***************
*** 37,41 ****
      http://softdevice.berlios.de
  
!   libavc1394-0.5.0
      http://sourceforge.net/projects/libavc1394
  
--- 37,41 ----
      http://softdevice.berlios.de
  
!   libavc1394-0.5.3
      http://sourceforge.net/projects/libavc1394
  

Index: avc-handler.c
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/avc-handler.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** avc-handler.c	12 Sep 2005 12:17:07 -0000	1.2
--- avc-handler.c	25 May 2006 17:48:19 -0000	1.3
***************
*** 110,114 ****
          Skins.Message(mtInfo,msg);
  #endif
!         avc1394_vcr_get_mic_info (handle, i, NULL, NULL);
        }
      }
--- 110,115 ----
          Skins.Message(mtInfo,msg);
  #endif
!         avc1394_vcr_get_mic_info (handle, i, &micData[i], &micSize[i]);
!         avc1394_vcr_parse_mic_info (micData[i], micSize[i], 1);
        }
      }
***************
*** 348,360 ****
      AVPacket          pkt;
      int               nStreams=0;
-     static int64_t    lastPTS=0;
- 
  
    dsyslog("[AVCPlayer-Action] started");
-   active = running = true;
    pDevice = (cSoftDevice *) cDevice::PrimaryDevice();
  
    fmt = av_find_input_format("dv1394");
!   rc = av_open_input_stream(&ic, NULL, "/dev/zero", fmt, ap);
  
    // limitation in cPlayer: we have to know the play mode at
--- 349,369 ----
      AVPacket          pkt;
      int               nStreams=0;
  
    dsyslog("[AVCPlayer-Action] started");
    pDevice = (cSoftDevice *) cDevice::PrimaryDevice();
  
    fmt = av_find_input_format("dv1394");
!   if (!fmt) {
!     esyslog("[AVCPlayer-Action] inputformat dv1394 "
!             "not supported by your ffmpeg version");
!     return;
!   }
! 
!   if ((rc = av_open_input_stream(&ic, NULL, "/dev/zero", fmt, ap)) < 0) {
!     esyslog("[AVCPlayer-Action] open input stream failed (%d)", rc);
!     return;
!   }
! 
!   active = running = true;
  
    // limitation in cPlayer: we have to know the play mode at
***************
*** 395,402 ****
      av_dup_packet(&pkt);
  
!     lastPTS=pkt.pts;
      if ( pkt.pts != (int64_t) AV_NOPTS_VALUE ) {
        pkt.pts/=100;
      }
  
      pDevice->PlayVideo((uchar *)&pkt,-2);
--- 404,432 ----
      av_dup_packet(&pkt);
  
! #if LIBAVFORMAT_BUILD > 4623
!       AVRational time_base;
! 
!     time_base = ic->streams[pkt.stream_index]->time_base;
!     if (pkt.pts != (int64_t) AV_NOPTS_VALUE) {
! #if 0
!       if (ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_AUDIO)
!         fprintf (stderr, "Au: %lld ->",pkt.pts);
!       else if (ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO)
!         fprintf (stderr, "Vi: %lld ->",pkt.pts);
!       else
!         fprintf (stderr, "??: %lld ->",pkt.pts);
! #endif
!       pkt.pts = av_rescale(pkt.pts,
!                            AV_TIME_BASE * (int64_t)time_base.num,
!                            time_base.den) / 100;
! #if 0
!       fprintf (stderr, " %lld\n",pkt.pts);
! #endif
!     }
! #else
      if ( pkt.pts != (int64_t) AV_NOPTS_VALUE ) {
        pkt.pts/=100;
      }
+ #endif
  
      pDevice->PlayVideo((uchar *)&pkt,-2);
***************
*** 407,411 ****
--- 437,445 ----
        fprintf(stderr,"Streams: %d\n",nStreams);
        for (int i=0; i <nStreams; i++ ) {
+ #if LIBAVFORMAT_BUILD > 4628
+           printf("Codec %d ID: %d\n",i,ic->streams[i]->codec->codec_id);
+ #else
            printf("Codec %d ID: %d\n",i,ic->streams[i]->codec.codec_id);
+ #endif
        }
      }



From nobody at sheep.berlios.de  Fri May 26 21:54:19 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 26 May 2006 21:54:19 +0200
Subject: [Softdevice-cvs] softieee1394 HISTORY,1.4,1.5 avc-handler.c,1.3,1.4 avc-handler.h,1.2,1.3
Message-ID: <200605261954.k4QJsJT02162@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394
In directory sheep:/tmp/cvs-serv13823

Modified Files:
	HISTORY avc-handler.c avc-handler.h 
Log Message:
- moved MIC interpretation code from libavc-0.5.3 patch to avc-handler.c

Index: HISTORY
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/HISTORY,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** HISTORY	25 May 2006 17:48:19 -0000	1.4
--- HISTORY	26 May 2006 19:59:21 -0000	1.5
***************
*** 1,4 ****
--- 1,6 ----
  VDR Plugin 'softieee1394' Revision History
  ------------------------------------------
+ 2006-05-26:
+   - moved MIC interpretation code from libavc-0.5.3 patch to avc-handler.c
  2006-05-25:
    - new patch for current libavc-0.5.3

Index: avc-handler.c
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/avc-handler.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** avc-handler.c	25 May 2006 17:48:19 -0000	1.3
--- avc-handler.c	26 May 2006 19:59:21 -0000	1.4
***************
*** 19,22 ****
--- 19,277 ----
  
  /* ---------------------------------------------------------------------------
+  * MIC helper functions. should be in libavc1394, but for easier development,
+  *
+  */
+ /* ---------------------------------------------------------------------------
+  */
+ static int
+ avc1394_mic_atn(unsigned char *p)
+ {
+     int atn = 0;
+ 
+   if (*(p + 4) >> 3 == 0x1f) {
+     atn = (*(p+1) | *(p+2) << 8 | *(p+3) << 16) >> 1;
+   } else if (*(p + 4) >> 3 == 0x1f) {
+     atn = (*(p+3) << 1 | *(p+2) << 9 | (*(p+1) & 0x3f) << 17);
+   }
+ 
+   return atn;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static void
+ avc1394_atn2str(int atn, char *strP, char *strN)
+ {
+   sprintf (strP,
+            "%02d:%02d:%02d.%02d",
+            (atn / (12 * 25 * 60 * 60)) % 24,
+            (atn / (12 * 25 * 60)) % 60,
+            (atn / (12 * 25)) % 60,
+            (atn / 12) % 25);
+   sprintf (strN,
+            "%02d:%02d:%02d.%02d",
+            (atn / (10 * 30 * 60 * 60)) % 24,
+            (atn / (10 * 30 * 60)) % 60 ,
+            (atn / (10 * 30) % 60),
+            (atn / 10) % 30);
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static void
+ avc1394_mic_atn2str(unsigned char *p, char *strP, char *strN)
+ {
+     int atn = 0;
+ 
+   if (*(p + 4) >> 3 == 0x1f) {
+     atn = (*(p+1) | *(p+2) << 8 | *(p+3) << 16) >> 1;
+   } else if (*(p + 4) >> 3 == 0x1f) {
+     atn = (*(p+3) << 1 | *(p+2) << 9 | (*(p+1) & 0x3f) << 17);
+   }
+   sprintf (strP,
+            "%02d:%02d:%02d.%02d",
+            (atn / (12 * 25 * 60 * 60)) % 24,
+            (atn / (12 * 25 * 60)) % 60,
+            (atn / (12 * 25)) % 60,
+            (atn / 12) % 25);
+   sprintf (strN,
+            "%02d:%02d:%02d.%02d",
+            (atn / (10 * 30 * 60 * 60)) % 24,
+            (atn / (10 * 30 * 60)) % 60 ,
+            (atn / (10 * 30) % 60),
+            (atn / 10) % 30);
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static void
+ avc1394_mic_datetime(t_mic_jump_mark *p_mark, unsigned char *p)
+ {
+   p_mark->year   = (*(p+3) & 0xE0) >> 1 | (*(p+4) & 0xF0) >> 4;
+   p_mark->month  = *(p+4) & 0x0f;
+   p_mark->day    = *(p+3) & 0x1f;
+   p_mark->hour   = *(p+2) & 0x1F;
+   p_mark->minute = *(p+1) & 0x3F;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static void
+ avc1394_mic_datetime2str(unsigned char *p, char *d, char *t)
+ {
+   sprintf (d,
+            "%02d-%02d-%02d",
+            (*(p+3) & 0xE0) >> 1 | (*(p+4) & 0xF0) >> 4,
+            *(p+4) & 0x0f,
+            *(p+3) & 0x1f);
+   sprintf (t,
+            "%02d:%02d",
+            *(p+2) & 0x1F,
+            *(p+1) & 0x3F);
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static void
+ avc1394_dump_micdirectoy(t_mic_directory *mic_dir)
+ {
+     int   i;
+     char  bufPAL[16],
+           bufNTSC[16];
+ 
+   if (!mic_dir)
+     return;
+ 
+   fprintf (stderr, "-- tape name:          (%s)\n", mic_dir->tape_name);
+   if (mic_dir->eom_atn) {
+     avc1394_atn2str(mic_dir->eom_atn, bufPAL, bufNTSC);
+     fprintf (stderr, "-- tape end position:  %s\n", bufPAL);
+   }
+   fprintf (stderr, "-- tape has # markers: %d\n", mic_dir->num_marks);
+   for (i = 0; i < mic_dir->num_marks; ++i) {
+     fprintf (stderr, "-- (%2d) ", i);
+     avc1394_atn2str(mic_dir->jump_mark[i]. atn, bufPAL, bufNTSC);
+     fprintf (stderr, "%s ", bufPAL);
+     fprintf (stderr,
+              "%02d-%02d-%02d %02d:%02d",
+              mic_dir->jump_mark[i]. year,
+              mic_dir->jump_mark[i]. month,
+              mic_dir->jump_mark[i]. day,
+              mic_dir->jump_mark[i]. hour,
+              mic_dir->jump_mark[i]. minute);
+     fprintf (stderr, "\n");
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static int
+ avc1394_micinfo2micdirectory (t_mic_directory **mic_dir,
+                               unsigned char *mic_data, int len)
+ {
+     unsigned char   *p;
+     int             l,
+                     marker;
+     t_mic_directory *tmp_dir = NULL;
+ 
+   if (!mic_dir || !mic_data || !len)
+     return 0;
+ 
+   if (*mic_dir) {
+     free (*mic_dir);
+     *mic_dir = NULL;
+   }
+ 
+   if (!(tmp_dir = (t_mic_directory *) calloc (1, sizeof (t_mic_directory))))
+     return 0;
+ 
+   p = mic_data;
+   l = len;
+   /* check header */
+ 
+   p += 11;
+   l -= 11;
+   /* get tape end ATN */
+   if (l < len && *p == MIC_TAG_TAPEEOM) {
+     if ((len - l) > 5)
+       tmp_dir->eom_atn = avc1394_mic_atn(p);
+ 
+     p += 5; l -= 5;
+   }
+ 
+   p += 5; l -= 5;
+   marker = 0;
+   while (l < len && *p == MIC_TAG_ATN) {
+     if ((len-l) > 10) {
+       tmp_dir->jump_mark[marker].atn = avc1394_mic_atn(p);
+ 
+       p += 5; l -= 5;
+       if (*p == MIC_TAG_DATETIME)
+         avc1394_mic_datetime(&tmp_dir->jump_mark[marker], p);
+ 
+       marker++;
+       tmp_dir->num_marks = marker;
+       p += 5; l -= 5;
+       continue;
+     }
+     p++; l--;
+   }
+   if (l < len && *p == MIC_TAG_TAPENAME)
+     memcpy(tmp_dir->tape_name, p+4, *(p+1));
+ 
+   *mic_dir = tmp_dir;
+   return 1;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ static int
+ avc1394_vcr_parse_mic_info (unsigned char *mic_data, int len, int prt)
+ {
+     unsigned char *p;
+     int           l,
+                   marker;
+     char          buf1 [16],
+                   buf2 [16];
+ 
+   if (prt)
+     fprintf(stderr, "[AVCHandler] MIC info start\n");
+   p = mic_data;
+   l = len;
+   /* check header */
+ 
+   p += 11;
+   l -= 11;
+   /* get tape end ATN */
+   if (l < len && *p == 0x1F) {
+     if ((len - l) > 5) {
+       if (prt) {
+         avc1394_mic_atn2str (p, buf1, buf2);
+         fprintf (stderr, "  tape end : %s\n", buf1);
+       }
+     }
+     p += 5; l -= 5;
+   }
+ 
+   p += 5; l -= 5;
+ 
+   marker = 1;
+   while (l < len && *p == 0x0b) {
+     if ((len-l) > 10) {
+       if (prt) {
+         avc1394_mic_atn2str (p, buf1, buf2);
+         fprintf (stderr, "  %2d.      : %s ", marker, buf1);
+       }
+       p += 5; l -= 5;
+       if (*p == 0x42) {
+         if (prt) {
+           avc1394_mic_datetime2str(p, buf1, buf2);
+           fprintf (stderr, "%s %s\n", buf1, buf2);
+         }
+       } else {
+         if (prt) {
+           fprintf(stderr,"\n");
+         }
+       }
+       marker++;
+       p += 5; l -= 5;
+       continue;
+     }
+     p++; l--;
+   }
+   if (l < len && *p == 0x18) {
+     if (prt) {
+       fprintf (stderr,"  tape name: %*.*s\n", *(p+1),*(p+1), p+4);
+     }
+   }
+   if (prt)
+     fprintf(stderr, "[AVCHandler] MIC info done!\n");
+   return 0;
+ }
+ /* ---------------------------------------------------------------------------
+  * MIC helper END
+  */
+ 
+ /* ---------------------------------------------------------------------------
   */
  cAVCHandler::cAVCHandler()
***************
*** 35,49 ****
  #endif
    numDevices = 0;
!   for (int i = 0; i < MAX_IEEE1394_DEVICES; ++i)
!   {
      deviceId[i] = 0;
      micSize[i] = 0;
      micData[i] = NULL;
    }
  
!   if (!handle)
!   {
!     if (!errno)
!     {
        esyslog("[AVCHandler]: Incompatible IEEE1394 subsystem!\n");
      } else {
--- 290,302 ----
  #endif
    numDevices = 0;
!   for (int i = 0; i < MAX_IEEE1394_DEVICES; ++i) {
      deviceId[i] = 0;
      micSize[i] = 0;
      micData[i] = NULL;
+     micDirectories[i] = NULL;
    }
  
!   if (!handle) {
!     if (!errno) {
        esyslog("[AVCHandler]: Incompatible IEEE1394 subsystem!\n");
      } else {
***************
*** 66,69 ****
--- 319,326 ----
    active=false;
    Cancel(3);
+   for (int i = 0; i < MAX_IEEE1394_DEVICES; ++i) {
+     free(micData[i]);
+     free(micDirectories[i]);
+   }
    raw1394_destroy_handle(handle);
    dsyslog("[AVCHandler]: Good bye");
***************
*** 101,108 ****
         */
        if (j >= numDevices) {
  #if 0
  // disabled since it may cause segfaults Skins.Message()
            char msg[100];
-           //static int once = 1;
  
          snprintf (msg, 100, "%s: %s",
--- 358,366 ----
         */
        if (j >= numDevices) {
+           unsigned char *tmpMicData = NULL;
+           int           tmpMicSize = 0;
  #if 0
  // disabled since it may cause segfaults Skins.Message()
            char msg[100];
  
          snprintf (msg, 100, "%s: %s",
***************
*** 110,115 ****
          Skins.Message(mtInfo,msg);
  #endif
!         avc1394_vcr_get_mic_info (handle, i, &micData[i], &micSize[i]);
!         avc1394_vcr_parse_mic_info (micData[i], micSize[i], 1);
        }
      }
--- 368,379 ----
          Skins.Message(mtInfo,msg);
  #endif
!         avc1394_vcr_get_mic_info (handle, i, &tmpMicData, &tmpMicSize);
! 
!         avcMutex.Lock();
!         micData[i] = tmpMicData;
!         micSize[i] = tmpMicSize;
!         avc1394_micinfo2micdirectory(&micDirectories[i], micData[i], micSize[i]);
!         avc1394_dump_micdirectoy(micDirectories[i]);
!         avcMutex.Unlock();
        }
      }

Index: avc-handler.h
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/avc-handler.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** avc-handler.h	12 Sep 2005 12:17:07 -0000	1.2
--- avc-handler.h	26 May 2006 19:59:21 -0000	1.3
***************
*** 27,30 ****
--- 27,69 ----
  
  /* ---------------------------------------------------------------------------
+  * MIC helper definitions START
+  */
+ #define MAX_MIC_SIZE      (64*1024)
+ #define MIC_HEADER_SIZE   16
+ #define MIC_ADDINFO_SIZE  10
+ #define MIC_ENTRY_SIZE    10
+ 
+ #define MIC_TAG_ATN       0x0B
+ #define MIC_TAG_TAPENAME  0x18
+ #define MIC_TAG_TAPEEOM   0x1F
+ #define MIC_TAG_DATETIME  0x42
+ 
+ #define MIC_TAG_INFO_DT         0x00
+ #define MIC_TAG_INFO_TAPE_NAME  0x06
+ #define MIC_TAG_INFO_NONE       0x07
+ 
+ typedef struct {
+   int atn;
+   int year,
+       month,
+       day;
+   int hour,
+       minute;
+ } t_mic_jump_mark;
+ 
+ typedef struct {
+   int             uatn;
+   int             eom_atn;
+   int             num_marks;
+   char            tape_name[256];
+   t_mic_jump_mark jump_mark[(MAX_MIC_SIZE-(MIC_HEADER_SIZE+MIC_ADDINFO_SIZE)) /
+                             MIC_ENTRY_SIZE];
+ } t_mic_directory;
+ 
+ /* ---------------------------------------------------------------------------
+  * MIC helper definitions END
+  */
+ 
+ /* ---------------------------------------------------------------------------
   */
  class cAVCHandler: public cThread {
***************
*** 36,39 ****
--- 75,79 ----
      int               micSize[MAX_IEEE1394_DEVICES];
      unsigned char     *micData[MAX_IEEE1394_DEVICES];
+     t_mic_directory   *micDirectories[MAX_IEEE1394_DEVICES];
      rom1394_directory romDirs[MAX_IEEE1394_DEVICES];
      raw1394handle_t   handle;
***************
*** 97,101 ****
  private:
    cAVCPlayer *player;
!   
  public:
    cAVCControl(octlet_t deviceId);
--- 137,141 ----
  private:
    cAVCPlayer *player;
! 
  public:
    cAVCControl(octlet_t deviceId);



From nobody at sheep.berlios.de  Fri May 26 21:54:20 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 26 May 2006 21:54:20 +0200
Subject: [Softdevice-cvs] softieee1394/patches libavc1394-0.5.3-read-mic-00.diff,1.1,1.2
Message-ID: <200605261954.k4QJsKT02166@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394/patches
In directory sheep:/tmp/cvs-serv13823/patches

Modified Files:
	libavc1394-0.5.3-read-mic-00.diff 
Log Message:
- moved MIC interpretation code from libavc-0.5.3 patch to avc-handler.c

Index: libavc1394-0.5.3-read-mic-00.diff
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/patches/libavc1394-0.5.3-read-mic-00.diff,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** libavc1394-0.5.3-read-mic-00.diff	25 May 2006 14:28:27 -0000	1.1
--- libavc1394-0.5.3-read-mic-00.diff	26 May 2006 19:59:22 -0000	1.2
***************
*** 1,5 ****
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394.h libavc1394-0.5.3.read-mic/libavc1394/avc1394.h
  --- libavc1394-0.5.3.orig/libavc1394/avc1394.h	2006-05-22 02:11:14.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/libavc1394/avc1394.h	2006-05-24 18:53:17.000000000 +0200
  @@ -329,6 +329,14 @@
   #define AVC1394_VCR_OPERAND_TRANSPORT_STATE 0x7F
--- 1,5 ----
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394.h libavc1394-0.5.3.read-mic/libavc1394/avc1394.h
  --- libavc1394-0.5.3.orig/libavc1394/avc1394.h	2006-05-22 02:11:14.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/libavc1394/avc1394.h	2006-05-26 08:50:35.000000000 +0200
  @@ -329,6 +329,14 @@
   #define AVC1394_VCR_OPERAND_TRANSPORT_STATE 0x7F
***************
*** 17,56 ****
   #define AVC1394_VCR_OPERAND_RECORDING_SPEED_STANDARD 0x6F
   
! @@ -426,6 +434,34 @@
!  #define AVC1394_PANEL_OPERATION_SUBPICTURE 0x51
!  
!  
! +#define MAX_MIC_SIZE      (64*1024)
! +#define MIC_HEADER_SIZE   16
! +#define MIC_ADDINFO_SIZE  10
! +#define MIC_ENTRY_SIZE    10
! +
! +#define MIC_TAG_ATN       0x0B
! +#define MIC_TAG_NAME      0x18
! +#define MIC_TAG_INFO      0x42
! +
! +#define MIC_TAG_INFO_DT         0x00
! +#define MIC_TAG_INFO_TAPE_NAME  0x06
! +#define MIC_TAG_INFO_NONE       0x07
! +
! +typedef struct {
! +  int atn;
! +  int year;
! +  int day;
! +  int hour;
! +  int minute;
! +} t_mic_jump_mark;
! +
! +typedef struct {
! +  int uatn;
! +  int eom_atn;
! +  t_mic_jump_mark jump_mark[(MAX_MIC_SIZE-(MIC_HEADER_SIZE+MIC_ADDINFO_SIZE)) /
! +                            MIC_ENTRY_SIZE];
! +} t_mic_directory;
! +
!  enum avc1394_measurement_unit {
!      AVC1394_VCR_MEASUREMENT_VIDEO_FRAME = 0,
!      AVC1394_VCR_MEASUREMENT_VIDEO_SCENE,
! @@ -459,6 +495,10 @@ quadlet_t *
   avc1394_transaction_block(raw1394handle_t handle, nodeid_t node,
   	quadlet_t *request, int len, int retry);
--- 17,21 ----
   #define AVC1394_VCR_OPERAND_RECORDING_SPEED_STANDARD 0x6F
   
! @@ -459,6 +467,10 @@ quadlet_t *
   avc1394_transaction_block(raw1394handle_t handle, nodeid_t node,
   	quadlet_t *request, int len, int retry);
***************
*** 225,229 ****
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.c libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.c
  --- libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.c	2006-04-13 18:16:41.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.c	2006-05-25 16:03:40.000000000 +0200
  @@ -22,6 +22,7 @@
   #include <unistd.h>
--- 190,194 ----
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.c libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.c
  --- libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.c	2006-04-13 18:16:41.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.c	2006-05-26 09:06:40.000000000 +0200
  @@ -22,6 +22,7 @@
   #include <unistd.h>
***************
*** 234,238 ****
   #include "avc1394.h"
   
! @@ -345,3 +346,325 @@ avc1394_vcr_seek_timecode(raw1394handle_
   	
   	avc1394_send_command_block( handle, node, request, 2);
--- 199,203 ----
   #include "avc1394.h"
   
! @@ -345,3 +346,216 @@ avc1394_vcr_seek_timecode(raw1394handle_
   	
   	avc1394_send_command_block( handle, node, request, 2);
***************
*** 309,313 ****
  +  }
  +
! +  fprintf(stderr," ATN_raw = 0x%08x\n", response[1]);
  +  return 0;
  +}
--- 274,278 ----
  +  }
  +
! +  //fprintf(stderr," ATN_raw = 0x%08x\n", response[1]);
  +  return 0;
  +}
***************
*** 328,332 ****
  +                                 AVC1394_RETRY);
  +
! +  fprintf (stderr, "MIC status = %02x \n", AVC1394_GET_OPERAND0(response));
  +  return AVC1394_GET_OPERAND0(response);
  +}
--- 293,297 ----
  +                                 AVC1394_RETRY);
  +
! +  //fprintf (stderr, "MIC status = %02x \n", AVC1394_GET_OPERAND0(response));
  +  return AVC1394_GET_OPERAND0(response);
  +}
***************
*** 345,350 ****
  +                                 AVC1394_RETRY);
  +
! +  fprintf (stderr, "MIC open read status = %02x \n",
! +           AVC1394_GET_OPERAND0(response));
  +  return AVC1394_GET_OPERAND0(response);
  +}
--- 310,315 ----
  +                                 AVC1394_RETRY);
  +
! +  //fprintf (stderr, "MIC open read status = %02x \n",
! +  //         AVC1394_GET_OPERAND0(response));
  +  return AVC1394_GET_OPERAND0(response);
  +}
***************
*** 363,480 ****
  +                                 AVC1394_RETRY);
  +
! +  fprintf (stderr, "MIC close status = %02x \n", AVC1394_GET_OPERAND0(response));
  +  return AVC1394_GET_OPERAND0(response);
  +}
  +
! +void
! +avc1394_make_atn (unsigned char *p)
! +{
! +}
! +
! +void
! +avc1394_mic_atn2str(unsigned char *p, char *strP, char *strN)
! +{
! +    int atn = 0;
! +
! +  if (*(p + 4) >> 3 == 0x1f) {
! +    atn = (*(p+1) | *(p+2) << 8 | *(p+3) << 16) >> 1;
! +  } else if (*(p + 4) >> 3 == 0x1f) {
! +    atn = (*(p+3) << 1 | *(p+2) << 9 | (*(p+1) & 0x3f) << 17);
! +  }
! +  sprintf (strP,
! +           "%02d:%02d:%02d.%02d",
! +           (atn / (12 * 25 * 60 * 60)) % 24,
! +           (atn / (12 * 25 * 60)) % 60,
! +           (atn / (12 * 25)) % 60,
! +           (atn / 12) % 25);
! +  sprintf (strN,
! +           "%02d:%02d:%02d.%02d",
! +           (atn / (10 * 30 * 60 * 60)) % 24,
! +           (atn / (10 * 30 * 60)) % 60 ,
! +           (atn / (10 * 30) % 60),
! +           (atn / 10) % 30);
! +}
! +
! +void
! +avc1394_mic_datetime2str(unsigned char *p, char *d, char *t)
! +{
! +  sprintf (d,
! +           "%02d-%02d-%02d",
! +           (*(p+3) & 0xE0) >> 1 | (*(p+4) & 0xF0) >> 4,
! +           *(p+4) & 0x0f,
! +           *(p+3) & 0x1f);
! +  sprintf (t,
! +           "%02d:%02d",
! +           *(p+2) & 0x1F,
! +           *(p+1) & 0x3F);
! +}
! +
! +/*
! + */
! +int
! +avc1394_vcr_parse_mic_info (unsigned char *mic_data, int len, int prt)
! +{
! +    unsigned char *p;
! +    int           l,
! +                  marker;
! +    char          buf1 [16],
! +                  buf2 [16];
! +
! +
! +  if (prt)
! +    fprintf(stderr, "MIC info start\n");
! +  p = mic_data;
! +  l = len;
! +  /* check header */
! +
! +  p += 11;
! +  l -= 11;
! +  /* get tape end ATN */
! +  if (l < len && *p == 0x1F) {
! +    if ((len - l) > 5) {
! +      if (prt) {
! +        avc1394_mic_atn2str (p, buf1, buf2);
! +        fprintf (stderr, "  tape end : %s\n", buf1);
! +      }
! +    }
! +    p += 5; l -= 5;
! +  }
! +
! +  p += 5; l -= 5;
! +
! +  marker = 1;
! +  while (l < len && *p == 0x0b) {
! +    if ((len-l) > 10) {
! +      if (prt) {
! +        avc1394_mic_atn2str (p, buf1, buf2);
! +        fprintf (stderr, "  %2d.      : %s ", marker, buf1);
! +      }
! +      p += 5; l -= 5;
! +      if (*p == 0x42) {
! +        if (prt) {
! +          avc1394_mic_datetime2str(p, buf1, buf2);
! +          fprintf (stderr, "%s %s\n", buf1, buf2);
! +        }
! +      } else {
! +        if (prt) {
! +          fprintf(stderr,"\n");
! +        }
! +      }
! +      marker++;
! +      p += 5; l -= 5;
! +      continue;
! +    }
! +    p++; l--;
! +  }
! +  if (l < len && *p == 0x18) {
! +    if (prt) {
! +      fprintf (stderr,"  tape name: %*.*s\n", *(p+1),*(p+1), p+4);
! +    }
! +  }
! +  if (prt)
! +    fprintf(stderr, "MIC info done!\n");
! +  return 0;
! +}
! +
  +/* Get all data from mic */
  +void
--- 328,336 ----
  +                                 AVC1394_RETRY);
  +
! +  //fprintf (stderr, "MIC close status = %02x \n", AVC1394_GET_OPERAND0(response));
  +  return AVC1394_GET_OPERAND0(response);
  +}
  +
! +#define MAX_MIC_SIZE      (64*1024)
  +/* Get all data from mic */
  +void
***************
*** 526,530 ****
  +    }
  +  }
! +  fprintf (stderr, " got %d bytes from MIC\n", count);
  +  if (count) {
  +    if (datalen) {
--- 382,386 ----
  +    }
  +  }
! +  //fprintf (stderr, " got %d bytes from MIC\n", count);
  +  if (count) {
  +    if (datalen) {
***************
*** 562,567 ****
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.h libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.h
  --- libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.h	2006-04-13 18:16:41.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.h	2006-05-24 19:04:46.000000000 +0200
! @@ -114,6 +114,20 @@ avc1394_vcr_get_timecode2(raw1394handle_
   void
   avc1394_vcr_seek_timecode(raw1394handle_t handle, nodeid_t node, char *timecode);
--- 418,423 ----
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.h libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.h
  --- libavc1394-0.5.3.orig/libavc1394/avc1394_vcr.h	2006-04-13 18:16:41.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/libavc1394/avc1394_vcr.h	2006-05-26 08:48:27.000000000 +0200
! @@ -114,6 +114,17 @@ avc1394_vcr_get_timecode2(raw1394handle_
   void
   avc1394_vcr_seek_timecode(raw1394handle_t handle, nodeid_t node, char *timecode);
***************
*** 571,577 ****
  +                         unsigned char **mic_data, int *datalen);
  +int
- +avc1394_vcr_parse_mic_info (unsigned char *mic_data, int len, int flag);
- +
- +int
  +avc1394_vcr_get_atn(raw1394handle_t handle, nodeid_t node,
  +                    int *atn, int *mt, int *mtd, int *sfbf);
--- 427,430 ----
***************
*** 588,592 ****
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/test/dvcont.c libavc1394-0.5.3.read-mic/test/dvcont.c
  --- libavc1394-0.5.3.orig/test/dvcont.c	2006-04-13 18:16:41.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/test/dvcont.c	2006-05-25 16:02:45.000000000 +0200
  @@ -71,6 +71,9 @@ printf("\nversion - Tell the program to 
   printf("\nhelp - Tell the program to show you this screen");
--- 441,445 ----
  diff -r -p -b -B -U 3 libavc1394-0.5.3.orig/test/dvcont.c libavc1394-0.5.3.read-mic/test/dvcont.c
  --- libavc1394-0.5.3.orig/test/dvcont.c	2006-04-13 18:16:41.000000000 +0200
! +++ libavc1394-0.5.3.read-mic/test/dvcont.c	2006-05-26 08:56:58.000000000 +0200
  @@ -71,6 +71,9 @@ printf("\nversion - Tell the program to 
   printf("\nhelp - Tell the program to show you this screen");
***************
*** 609,613 ****
  +			avc1394_vcr_get_mic_info (handle, device,
  +			                          &mic_data, &len);
! +			avc1394_vcr_parse_mic_info (mic_data, len, 1);
  +		} else if (strcmp("atn", argv[i]) == 0) {
  +				int atn, med, med_dep, sfbf;
--- 462,466 ----
  +			avc1394_vcr_get_mic_info (handle, device,
  +			                          &mic_data, &len);
! +			//avc1394_vcr_parse_mic_info (mic_data, len, 1);
  +		} else if (strcmp("atn", argv[i]) == 0) {
  +				int atn, med, med_dep, sfbf;



From nobody at sheep.berlios.de  Sat May 27 10:01:30 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 27 May 2006 10:01:30 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.187,1.188 SoftOsd.c,1.13,1.14
Message-ID: <200605270801.k4R81UT29856@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4408

Modified Files:
	CHANGELOG SoftOsd.c 
Log Message:
- fix possible segfaults in SoftOsd when using a zoom faktor



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.187
retrieving revision 1.188
diff -C2 -d -r1.187 -r1.188
*** CHANGELOG	23 May 2006 21:28:54 -0000	1.187
--- CHANGELOG	27 May 2006 08:06:34 -0000	1.188
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-05-27:
+    - fix possible segfaults in SoftOsd when using a zoom faktor
  2006-05-23:
     - fix VIA OSD transparency for newer DirectFB cvs versions

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** SoftOsd.c	23 Apr 2006 20:35:53 -0000	1.13
--- SoftOsd.c	27 May 2006 08:06:34 -0000	1.14
***************
*** 29,32 ****
--- 29,33 ----
  
  
+ //#undef USE_MMX2
  /* ---------------------------------------------------------------------------
   */
***************
*** 38,42 ****
          pixelMask=NULL;
  	bitmap_Format=PF_None; // forces a clear after first SetMode
!         OSD_Bitmap=new uint32_t[OSD_STRIDE*(OSD_HEIGHT+2)];
  
          videoOut = VideoOut;
--- 39,43 ----
          pixelMask=NULL;
  	bitmap_Format=PF_None; // forces a clear after first SetMode
!         OSD_Bitmap=new uint32_t[OSD_STRIDE*(OSD_HEIGHT+4)];
  
          videoOut = VideoOut;
***************
*** 827,834 ****
                      int dest_Width, int dest_Height, bool RefreshAll) {
          OSDDEB("CopyToBitmap destsize: %d,%d\n",dest_Width,dest_Height);
          if (dest_Height & 0x1 !=0) {
!                 printf("warning dest_Height not even!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
                  dest_Height &= ~0x1;
          };
          if (dest_Height==OSD_HEIGHT)
                  NoVScaleCopyToBitmap(PY,PU,PV,PAlphaY,PAlphaUV,Ystride,UVstride,
--- 828,839 ----
                      int dest_Width, int dest_Height, bool RefreshAll) {
          OSDDEB("CopyToBitmap destsize: %d,%d\n",dest_Width,dest_Height);
+         if (dest_Height < 40 || dest_Width < 40)
+                 return;
+ 
          if (dest_Height & 0x1 !=0) {
!                 //printf("warning dest_Height not even!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
                  dest_Height &= ~0x1;
          };
+ 
          if (dest_Height==OSD_HEIGHT)
                  NoVScaleCopyToBitmap(PY,PU,PV,PAlphaY,PAlphaUV,Ystride,UVstride,
***************
*** 899,903 ****
                      int dest_Width, int dest_Height, bool RefreshAll) {
  
!         OSDDEB("CopyToBitmap YUV down\n");
          // upscaleing is not supported for YUV modes
          if (dest_Width>OSD_WIDTH)
--- 904,908 ----
                      int dest_Width, int dest_Height, bool RefreshAll) {
  
!         OSDDEB("CopyToBitmap YUV down %d,%d\n",dest_Width,dest_Height);
          // upscaleing is not supported for YUV modes
          if (dest_Width>OSD_WIDTH)
***************
*** 922,926 ****
          const int ScaleFactor=1<<6;
          uint32_t new_pixel_height=(OSD_HEIGHT*ScaleFactor)/dest_Height;
!         int lines_count=(new_pixel_height/ScaleFactor*2+2);
          color scaleH_pixmap[lines_count*OSD_STRIDE];
          color *scaleH_Reference[lines_count];
--- 927,931 ----
          const int ScaleFactor=1<<6;
          uint32_t new_pixel_height=(OSD_HEIGHT*ScaleFactor)/dest_Height;
!         int lines_count=(new_pixel_height/ScaleFactor*2+4);
          color scaleH_pixmap[lines_count*OSD_STRIDE];
          color *scaleH_Reference[lines_count];
***************
*** 928,931 ****
--- 933,939 ----
          int scaleH_strtIdx=0;
          memset(scaleH_lines,-1,sizeof(scaleH_lines));
+         memset(scaleH_Reference,0,sizeof(scaleH_Reference));
+         OSDDEB("new_pixel_height %d lines_count %d\n",
+                         new_pixel_height,lines_count);
          
          for (int y=0; y<dest_Height; y+=2) {
***************
*** 951,963 ****
                          }
                  };
!                 /*
                     printf("strt_Idx %d scaleH_lines: ",scaleH_strtIdx);
                     for (int i=0; i<lines_count; i++)
                     printf("%d ",scaleH_lines[i]);
!                    printf("\n");
!                    */
                  ScaleDownVert_MMX((uint8_t*) tmp_pixmap,0,
  				new_pixel_height,start_pos,
!                                 scaleH_Reference,OSD_WIDTH-1);
                  int new_start_row=new_pixel_height*(y+1)/ScaleFactor;
                  int start_row_idx=new_start_row-start_row;
--- 959,973 ----
                          }
                  };
!                /* 
                     printf("strt_Idx %d scaleH_lines: ",scaleH_strtIdx);
                     for (int i=0; i<lines_count; i++)
                     printf("%d ",scaleH_lines[i]);
!                    printf("\n");fflush(stdout);
!                  */ 
!                 OSDDEB("start_pos %d start_row %d\n",start_pos,start_row);
                  ScaleDownVert_MMX((uint8_t*) tmp_pixmap,0,
  				new_pixel_height,start_pos,
!                                 scaleH_Reference,dest_Width);
!                                 //scaleH_Reference,OSD_WIDTH-1);
                  int new_start_row=new_pixel_height*(y+1)/ScaleFactor;
                  int start_row_idx=new_start_row-start_row;
***************
*** 970,977 ****
                                          scaleH_lines[SCALEH_IDX(start_row_idx)]);
                  
                  ScaleDownVert_MMX((uint8_t*) &tmp_pixmap[OSD_STRIDE],0,
  				new_pixel_height,start_pos,
                                  &scaleH_Reference[start_row_idx],
!                                 OSD_WIDTH-1);
  
                  // convert and copy to video out OSD layer
--- 980,989 ----
                                          scaleH_lines[SCALEH_IDX(start_row_idx)]);
                  
+                 OSDDEB("start_pos %d new_start_row %d\n",start_pos,new_start_row);
                  ScaleDownVert_MMX((uint8_t*) &tmp_pixmap[OSD_STRIDE],0,
  				new_pixel_height,start_pos,
                                  &scaleH_Reference[start_row_idx],
!                                 dest_Width);
!                                 //OSD_WIDTH-1);
  
                  // convert and copy to video out OSD layer
***************
*** 996,999 ****
--- 1008,1014 ----
                  int dest_Width, int dest_Height, bool RefreshAll,
                  bool *dirtyLines) {
+         if (dest_Height < 40 || dest_Width < 40)
+                 return;
+ 
  	if (dest_Height>=OSD_HEIGHT)
  		ScaleVUpCopyToBitmap(dest,linesize,dest_Width,dest_Height,
***************
*** 1186,1190 ****
  //------------------------ lowlevel scaling functions ------------------------
  //#define SCALEDEBV(out...) printf(out) 
! #define SCALEDEBV(out...)
  
  void cSoftOsd::ScaleDownVert_MMX(uint8_t * dest, int linesize,
--- 1201,1205 ----
  //------------------------ lowlevel scaling functions ------------------------
  //#define SCALEDEBV(out...) printf(out) 
! #define SCALEDEBV(out...) 
  
  void cSoftOsd::ScaleDownVert_MMX(uint8_t * dest, int linesize,



From nobody at sheep.berlios.de  Sat May 27 13:12:42 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 27 May 2006 13:12:42 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.188,1.189 configure,1.13,1.14
Message-ID: <200605271112.k4RBCgT03004@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18629

Modified Files:
	CHANGELOG configure 
Log Message:
- add "--disable-mmx" and "--disable-mmx2" to configure


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.188
retrieving revision 1.189
diff -C2 -d -r1.188 -r1.189
*** CHANGELOG	27 May 2006 08:06:34 -0000	1.188
--- CHANGELOG	27 May 2006 11:17:48 -0000	1.189
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-05-27:
+    - add "--disable-mmx" and "--disable-mmx2" to configure
     - fix possible segfaults in SoftOsd when using a zoom faktor
  2006-05-23:

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** configure	7 May 2006 20:52:23 -0000	1.13
--- configure	27 May 2006 11:17:48 -0000	1.14
***************
*** 45,48 ****
--- 45,50 ----
    echo "  --disable-shm"
    echo "  --disable-subplugins"
+   echo "  --disable-mmx"
+   echo "  --disable-mmx2"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
    echo "  --help"
***************
*** 58,61 ****
--- 60,65 ----
      --disable-shm) shift; with_shm="no" ;;
      --disable-subplugins) shift; with_subplugins="no" ;;
+     --disable-mmx) shift; with_mmx="no";;
+     --disable-mmx2) shift; with_mmx2="no";;
      --with-vidix-path) shift;
        vidix_path=$1 ;
***************
*** 277,286 ****
  if test "${with_mmx}" = "yes" ; then
    echo "#define USE_MMX 1" >> $TMPH
- fi
  
! if test "${with_mmx2}" = "yes" ; then
!   echo "#define USE_MMX2 1" >> $TMPH
  fi
- 
  
  
--- 281,289 ----
  if test "${with_mmx}" = "yes" ; then
    echo "#define USE_MMX 1" >> $TMPH
  
!   if test "${with_mmx2}" = "yes" ; then
!     echo "#define USE_MMX2 1" >> $TMPH
!   fi
  fi
  
  



From nobody at sheep.berlios.de  Sat May 27 14:55:04 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 27 May 2006 14:55:04 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.189,1.190 configure,1.14,1.15
Message-ID: <200605271255.k4RCt4T08829@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16503

Modified Files:
	CHANGELOG configure 
Log Message:
- add tests for older ffmpeg versions to configure


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.189
retrieving revision 1.190
diff -C2 -d -r1.189 -r1.190
*** CHANGELOG	27 May 2006 11:17:48 -0000	1.189
--- CHANGELOG	27 May 2006 13:00:07 -0000	1.190
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-05-27:
+    - add tests for older ffmpeg versions to configure
     - add "--disable-mmx" and "--disable-mmx2" to configure
     - fix possible segfaults in SoftOsd when using a zoom faktor

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** configure	27 May 2006 11:17:48 -0000	1.14
--- configure	27 May 2006 13:00:07 -0000	1.15
***************
*** 30,33 ****
--- 30,34 ----
  vidix="yes"
  vidix_path="/usr/local"
+ ffmpeg_path="/usr/local/include/ffmpeg"
  with_fb="yes"
  fb_dev_name="/dev/fb0"
***************
*** 47,50 ****
--- 48,52 ----
    echo "  --disable-mmx"
    echo "  --disable-mmx2"
+   echo "  --with-ffmpeg-path YOUR_FFMPEG_PATH"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
    echo "  --help"
***************
*** 62,65 ****
--- 64,71 ----
      --disable-mmx) shift; with_mmx="no";;
      --disable-mmx2) shift; with_mmx2="no";;
+     --with-ffmpeg-path) shift;
+       ffmpeg_path=$1 ;
+       echo "ffmpeg path set to: $ffmpeg_path" ;
+       shift ;;
      --with-vidix-path) shift;
        vidix_path=$1 ;
***************
*** 74,77 ****
--- 80,107 ----
  # start ffmpeg test
  #
+ test_ffmpeg() 
+ {
+   ffmpeg="yes";
+ cat > ${TMPC} << EOF
+ #include <stdlib.h>
+ #include <avcodec.h>
+ #include <avformat.h>
+ int main(void) {
+ /*  if ( avcodec_build() != LIBAVCODEC_BUILD ) {
+      fprintf(stderr,"Fatal Error! Libavcodec library build(%d) doesn't match avcodec.h build(%d)!!!\n",avcodec_build(),LIBAVCODEC_BUILD);
+      fprintf(stderr,"Check your ffmpeg installation / the pathes in the Makefile!!!\n");
+      exit(-1);
+   };
+ */
+   avcodec_init();
+   avcodec_register_all();
+ 
+  return 0;
+ }
+ EOF
+   $cc $CFLAGS $ffmpeg_cflags $ffmpeg_libs -o $TMPE $TMPC $ffmpeg_libs  > /dev/null 2>&1 || ffmpeg="no"
+ };
+ 
+ # try to use pkg-config
  ffmpeg_l1="libavcodec libavformat"
  
***************
*** 79,89 ****
  
  ffmpeg_libs=`pkg-config --libs $ffmpeg_l1` || ffmpeg="no"
  
  if test "${ffmpeg}" = "no" ; then
!   echo "A more recent (cvs) version of ffmpeg is required to run configure"
!   exit 8;
  fi
  
- ffmpeg_cflags=`pkg-config --cflags $ffmpeg_l1`
  
  #########################################################
--- 109,142 ----
  
  ffmpeg_libs=`pkg-config --libs $ffmpeg_l1` || ffmpeg="no"
+ ffmpeg_cflags=`pkg-config --cflags $ffmpeg_l1`
+ 
+ # test if it works..
+ test_ffmpeg
  
  if test "${ffmpeg}" = "no" ; then
!   #pkg-config failed, try the default/parameter path 
!   ffmpeg="yes"
!   ffmpeg_libs="-L${ffmpeg_path}/ -L${ffmpeg_path}/libavcodec/ -L${ffmpeg_path}/libavformat/ -lavformat -lz -lavcodec "
!   ffmpeg_cflags="-I${ffmpeg_path}/ -I${ffmpeg_path}/libavcodec/ -I${ffmpeg_path}/libavformat/ "
! 
!   test_ffmpeg
! 
!   if test "${ffmpeg}" = "no" ; then
!     #maybe avutils is needed?
!     echo "checking for avutils..."
!     ffmpeg_libs="$ffmpeg_libs -L${ffmpeg_path}/libavutil/ -lavutil"
!     ffmpeg_cflags="$ffmpeg_cflags -I${ffmpeg_path}/libavutil/"
! 
!     test_ffmpeg
!   fi    
! 
!   if test "${ffmpeg}" = "no" ; then
!     echo "No usable ffmpeg library found in ${ffmpeg_path}."
!     echo "Specify the path to your ffmpeg installation using --with-ffmpeg-path"
!     echo "or use a more recent (cvs) version of ffmpeg with pkg-config"
!     exit 8;
!   fi
  fi
  
  
  #########################################################



From nobody at sheep.berlios.de  Sat May 27 21:10:22 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 27 May 2006 21:10:22 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.190,1.191 Makefile,1.28,1.29
Message-ID: <200605271910.k4RJAMT25709@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3622

Modified Files:
	CHANGELOG Makefile 
Log Message:
- move postproc stuff into VideoFilter.[ch]
- apply patch to use direct rendering


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.190
retrieving revision 1.191
diff -C2 -d -r1.190 -r1.191
*** CHANGELOG	27 May 2006 13:00:07 -0000	1.190
--- CHANGELOG	27 May 2006 19:15:31 -0000	1.191
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2006-05-27:
+    - move postproc stuff into VideoFilter.[ch]
+    - apply patch to use direct rendering
     - add tests for older ffmpeg versions to configure
     - add "--disable-mmx" and "--disable-mmx2" to configure

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** Makefile	29 Apr 2006 06:20:28 -0000	1.28
--- Makefile	27 May 2006 19:15:31 -0000	1.29
***************
*** 164,167 ****
--- 164,168 ----
    DEFINES     += -DPP_LIBAVCODEC
    FFMPEGLIBS  += -lpostproc
+   INCLUDES    += -Ipostproc/
  endif
  
***************
*** 226,235 ****
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o setup-softdevice-menu.o sync-timer.o SoftOsd.o
  ALL_OBJS = $(OBJS)
  
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
--- 227,236 ----
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o setup-softdevice-menu.o sync-timer.o SoftOsd.o PicBuffer.o VideoFilter.o
  ALL_OBJS = $(OBJS)
  
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
***************
*** 244,248 ****
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
--- 245,249 ----
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o PicBuffer.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
***************
*** 254,258 ****
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
--- 255,259 ----
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o PicBuffer.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
***************
*** 265,269 ****
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
--- 266,270 ----
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o PicBuffer.o
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
***************
*** 277,281 ****
  ifdef SHM_SUPPORT
    ifdef USE_SUBPLUGINS
!     SHM_OBJS  = utils.o video.o video-shm.o
      ALL_OBJS    += $(SHM_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-shm.so
--- 278,282 ----
  ifdef SHM_SUPPORT
    ifdef USE_SUBPLUGINS
!     SHM_OBJS  = utils.o video.o video-shm.o PicBuffer.o
      ALL_OBJS    += $(SHM_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-shm.so
***************
*** 354,358 ****
  SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o setup-softdevice_shm.o\
  		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
! 		   ShmClient_shm.o
  
  %_shm.o: %.c
--- 355,359 ----
  SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o setup-softdevice_shm.o\
  		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
! 		   ShmClient_shm.o PicBuffer_shm.o 
  
  %_shm.o: %.c



From nobody at sheep.berlios.de  Sat May 27 21:07:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 27 May 2006 21:07:34 +0200
Subject: [Softdevice-cvs] softdevice VideoFilter.c,NONE,1.1 VideoFilter.h,NONE,1.1 PicBuffer.c,NONE,1.1 PicBuffer.h,NONE,1.1 video.c,1.57,1.58 video.h,1.39,1.40 ShmClient.c,1.13,1.14 mpeg2decoder.c,1.63,1.64 mpeg2decoder.h,1.36,1.37 video-dfb.c,1.61,1.62 video-dfb.h,1.20,1.21 video-dummy.c,1.2,1.3 video-dummy.h,1.2,1.3 video-fb.c,1.14,1.15 video-fb.h,1.7,1.8 video-shm.c,1.7,1.8 video-shm.h,1.4,1.5 video-vidix.c,1.18,1.19 video-vidix.h,1.9,1.10 video-xv.c,1.54,1.55 video-xv.h,1.20,1.21
Message-ID: <200605271907.k4RJ7YT25622@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3071

Modified Files:
	video.c video.h ShmClient.c mpeg2decoder.c mpeg2decoder.h 
	video-dfb.c video-dfb.h video-dummy.c video-dummy.h video-fb.c 
	video-fb.h video-shm.c video-shm.h video-vidix.c video-vidix.h 
	video-xv.c video-xv.h 
Added Files:
	VideoFilter.c VideoFilter.h PicBuffer.c PicBuffer.h 
Log Message:
- move postproc stuff into VideoFilter.[ch]
- apply patch to use direct rendering
   


--- NEW FILE: VideoFilter.c ---
/*
 * VideoFilter.c: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: VideoFilter.c,v 1.1 2006/05/27 19:12:40 wachm Exp $
 */
#include "VideoFilter.h"

cVideoFilter::cVideoFilter(cVideoOut *VideoOut)
        : vout(VideoOut) {
};

cVideoFilter::~cVideoFilter() {
};

bool cVideoFilter::AllocateCheckBuffer(sPicBuffer *&dest, sPicBuffer *orig) {
        if (!orig) {
                fprintf(stderr,"Error in AllocateCheckBuffer, orig==NULL!\n");
                return false;
        };
        
        if (!dest) 
                return AllocateBuffer(dest, orig);
        
        if ( dest->format != orig->format ||
             dest->max_width != orig->width ||
             dest->max_height != orig->height ) {
                fprintf(stderr,"reallocating buffer format %d-%d w: %d-%d h: %d-%d \n",
                      dest->format,orig->format,
                      dest->max_width, orig->width,
                      dest->max_height, orig->height);
                vout->ReleaseBuffer(dest);
                AllocateBuffer(dest, orig);
                if (!dest) 
                        return false;
        };
        return true;
};

bool cVideoFilter::AllocateBuffer(sPicBuffer *&dest, sPicBuffer *orig) {
        if (!orig) {
                fprintf(stderr,"Error in AllocateBuffer, orig==NULL!\n");
                return false;
        };
        
        dest=vout->GetBuffer(orig->format, orig->width, orig->height);
        
        dest->width = orig->width;
        dest->height = orig->height;
        dest->pts=orig->pts;
        dest->edge_width=dest->edge_height=0;
        dest->dtg_active_format=orig->dtg_active_format;
        dest->aspect_ratio=orig->aspect_ratio;
        dest->interlaced_frame=orig->interlaced_frame;

        return (dest!=NULL);
};

/*--------------------------------------------------------------------------*/

cVideoMirror::cVideoMirror(cVideoOut *vOut) 
        : cVideoFilter(vOut), outBuf(NULL) {
};

cVideoMirror::~cVideoMirror() {
        if (outBuf) {
                vout->ReleaseBuffer(outBuf);
        };
};

void cVideoMirror::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
    uchar *ptr_src1, *ptr_src2;
    uchar *ptr_dest1, *ptr_dest2;

    AllocateCheckBuffer(outBuf, orig);
    dest=outBuf;

    if ( !outBuf ) {
            fprintf(stderr,
                "[softdevice] no picture buffer is allocated for mirroring !\n"
                "[softdevice] switching mirroring off !\n");
            setupStore.mirror = 0;
            return;
    }

    // mirror luminance
    ptr_src1  = orig->pixel[0] + orig->edge_height * orig->stride[0]
            + orig->edge_width;

    for (int h = 0; h < dest->height; h++)
    {
            ptr_dest1 = dest->pixel[0] + h * dest->stride[0];
            for (int w = dest->width-1; w >=0; w--)
            {
                    *ptr_dest1 = ptr_src1[h * orig->stride[0] + w ];
                    ptr_dest1++;
            }
    }
    
    // mirror chrominance
    int h_shift;
    int v_shift;
    avcodec_get_chroma_sub_sample(dest->format,&h_shift,&v_shift);

    ptr_src1  = orig->pixel[1] + (orig->edge_height>>v_shift) * orig->stride[1]
            + (orig->edge_width >> h_shift);
    ptr_src2  = orig->pixel[2] + (orig->edge_height>>v_shift) * orig->stride[2]
            + (orig->edge_width >> h_shift);


    for (int h = 0; h < dest->height >> v_shift ; h++) {
            ptr_dest1 = dest->pixel[1] + h * dest->stride[1];
            ptr_dest2 = dest->pixel[2] + h * dest->stride[2];
            for (int w = (dest->width >> h_shift) - 1; w >= 0; w--)
            {
                    *ptr_dest1 = ptr_src1[h * orig->stride[1] + w ];
                    *ptr_dest2 = ptr_src2[h * orig->stride[2] + w ];
                    ptr_dest1++;
                    ptr_dest2++;
            }
    };

    CopyPicBufferContext(dest,orig);
}

/*--------------------------------------------------------------------------*/

cDeintLibav::cDeintLibav(cVideoOut *vOut) 
        : cVideoFilter(vOut), outBuf(NULL) {
};

cDeintLibav::~cDeintLibav() {
        if (outBuf) {
                vout->ReleaseBuffer(outBuf);
        };
};

void cDeintLibav::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
    AVPicture           avpic_src, avpic_dest;

    AllocateCheckBuffer(outBuf, orig);
    dest=outBuf;

    if ( !outBuf ) {
            fprintf(stderr,
                "[softdevice] no picture buffer is allocated for deinterlacing!\n"
                "[softdevice] switching deinterlacing off !\n");
            setupStore.mirror = 0;
            return;
    }

    int h_shift;
    int v_shift;
    avcodec_get_chroma_sub_sample(dest->format,&h_shift,&v_shift);

    avpic_src.data[0] = orig->pixel[0] 
            + orig->edge_height * orig->stride[0]
            + orig->edge_width;
    
    avpic_src.data[1] = orig->pixel[1] 
            + (orig->edge_height >> v_shift) * orig->stride[1]
            + (orig->edge_width >> h_shift);
    
    avpic_src.data[2] = orig->pixel[2] 
            + (orig->edge_height >> v_shift) * orig->stride[2]
            + (orig->edge_width >> h_shift);

    memcpy(avpic_src.linesize,orig->stride,sizeof(avpic_src.linesize));
    
    memcpy(avpic_dest.data,dest->pixel,sizeof(avpic_dest.data));
    memcpy(avpic_dest.linesize,dest->stride,sizeof(avpic_dest.linesize));

    if (avpicture_deinterlace(&avpic_dest, &avpic_src, orig->format,
                            orig->width, orig->height) < 0)
    {
            fprintf(stderr,
                            "[softdevice] error, libavcodec deinterlacer failure\n"
                            "[softdevice] switching deinterlacing off !\n");
            setupStore.deintMethod = 0;
            return;
    }
    CopyPicBufferContext(dest,orig);
    dest->interlaced_frame=false;
}

/*---------------------------cImageConvert---------------------------------*/

cImageConvert::cImageConvert(cVideoOut *vOut) 
        : cVideoFilter(vOut), outBuf(NULL) {
};

cImageConvert::~cImageConvert() {
        if (outBuf) {
                vout->ReleaseBuffer(outBuf);
        };
};

void cImageConvert::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
        AVPicture           avpic_src, avpic_dest;

        if ( !outBuf ||
                        outBuf->max_width != orig->width ||
                        outBuf->max_height != orig->height ) {

                if (outBuf)
                        vout->ReleaseBuffer(outBuf);

                outBuf=dest=vout->GetBuffer(PIX_FMT_YUV420P, 
                                orig->width, orig->height);

                dest->width = orig->width;
                dest->height = orig->height;
                dest->pts=orig->pts;
                dest->edge_width=dest->edge_height=0;
                dest->dtg_active_format=orig->dtg_active_format;
                dest->aspect_ratio=orig->aspect_ratio;
                dest->interlaced_frame=orig->interlaced_frame;
        };
        dest=outBuf;

        if ( !outBuf ) {
                fprintf(stderr,
                                "[softdevice] no picture buffer is allocated for image converting!\n"
                                "[softdevice] switching deinterlacing off !\n");
                setupStore.mirror = 0;
                return;
        }

        int h_shift;
        int v_shift;
        avcodec_get_chroma_sub_sample(orig->format,&h_shift,&v_shift);

        avpic_src.data[0] = orig->pixel[0] 
                + orig->edge_height * orig->stride[0]
                + orig->edge_width;

        avpic_src.data[1] = orig->pixel[1] 
                + (orig->edge_height >> v_shift) * orig->stride[1]
                + (orig->edge_width >> h_shift);

        avpic_src.data[2] = orig->pixel[2] 
                + (orig->edge_height >> v_shift) * orig->stride[2]
                + (orig->edge_width >> h_shift);

        memcpy(avpic_src.linesize,orig->stride,sizeof(avpic_src.linesize));

        memcpy(avpic_dest.data,dest->pixel,sizeof(avpic_dest.data));
        memcpy(avpic_dest.linesize,dest->stride,sizeof(avpic_dest.linesize));

        if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
                                &avpic_src, orig->format,
                                orig->width, orig->height) < 0) {
                fprintf(stderr,
                                "[softdevice] error, libavcodec img_convert failure\n");
                return;
        }
    CopyPicBufferContext(dest,orig);
}

/*---------------------------cLibAvPostProc---------------------------------*/
#ifdef PP_LIBAVCODEC
cLibAvPostProc::cLibAvPostProc(cVideoOut *vOut) 
        : cVideoFilter(vOut), width(-1), height(-1), pix_fmt(PIX_FMT_NB),
          ppmode(NULL), ppcontext(NULL), outBuf(NULL),
          currentDeintMethod(-1), currentppMethod(-1), currentppQuality(-1) {
};

cLibAvPostProc::~cLibAvPostProc() {
        if (ppcontext) {
                pp_free_context(ppcontext);
                ppcontext = NULL;
        }
        if (ppmode)  {
                pp_free_mode (ppmode);
                ppmode = NULL;
        }
        if (outBuf) {
                vout->ReleaseBuffer(outBuf);
        };
};

void cLibAvPostProc::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
        AVPicture           avpic_src, avpic_dest;

        AllocateCheckBuffer(outBuf, orig);
        dest=outBuf;

        if ( !outBuf ) {
                fprintf(stderr,
                                "[softdevice] no picture buffer is allocated for post processing!\n"
                                "[softdevice] switching post processing off !\n");
                setupStore.mirror = 0;
                return;
        }

        if (ppcontext == NULL ||
                        orig->width != width ||
                        orig->height != height||
                        orig->format != pix_fmt) {
                width=orig->width;height=orig->height;
                pix_fmt=orig->format;
                
                // reallocate ppcontext if format or size of picture changed
                if (ppcontext)
                {
                        pp_free_context(ppcontext);
                        ppcontext = NULL;
                }
                /* set one of this values instead of 0 in pp_get_context for
                 * processor-independent optimations:
                 PP_CPU_CAPS_MMX, PP_CPU_CAPS_MMX2, PP_CPU_CAPS_3DNOW
                 */
                int flags=0;
#ifdef USE_MMX
                flags|=PP_CPU_CAPS_MMX;
#endif
#ifdef USE_MMX2
                flags|=PP_CPU_CAPS_MMX2;
#endif
                if (pix_fmt == PIX_FMT_YUV420P)
                        flags|=PP_FORMAT_420;
                else if (pix_fmt == PIX_FMT_YUV422P)
                        flags|=PP_FORMAT_422;
                else if (pix_fmt == PIX_FMT_YUV444P)
                        flags|=PP_FORMAT_444;

                ppcontext = pp_get_context(width, height,flags);
        }
        
        if ( ppmode == NULL 
                        || currentDeintMethod != setupStore.deintMethod 
                        || currentppMethod != setupStore.ppMethod
                        || currentppQuality != setupStore.ppQuality ) {
                // reallocate ppmode if method or quality changed
                currentDeintMethod = setupStore.deintMethod;
                currentppMethod = setupStore.ppMethod;
                currentppQuality = setupStore.ppQuality;

                if (ppmode)  {
                        pp_free_mode (ppmode);
                        ppmode = NULL;
                }
                char mode[60]="";
                if (setupStore.getPPdeintValue() && setupStore.getPPValue())
                        sprintf(mode,"%s,%s",setupStore.getPPdeintValue(),
                                        setupStore.getPPValue());
                else if (setupStore.getPPdeintValue() )
                        sprintf(mode,"%s",setupStore.getPPdeintValue());
                else if (setupStore.getPPValue() )
                        sprintf(mode,"%s",setupStore.getPPValue());

                ppmode = pp_get_mode_by_name_and_quality(mode, currentppQuality);
        }
        if (ppmode == NULL || ppcontext == NULL) {
                fprintf(stderr,
                        "[softdevice] pp-filter %s couldn't be initialized,\n"
                        "[softdevice] switching postprocessing off !\n",
                        setupStore.getPPValue());
                setupStore.deintMethod = 0;
                return;
        }

        int h_shift;
        int v_shift;
        avcodec_get_chroma_sub_sample(orig->format,&h_shift,&v_shift);

        avpic_src.data[0] = orig->pixel[0] 
                + orig->edge_height * orig->stride[0]
                + orig->edge_width;

        avpic_src.data[1] = orig->pixel[1] 
                + (orig->edge_height >> v_shift) * orig->stride[1]
                + (orig->edge_width >> h_shift);

        avpic_src.data[2] = orig->pixel[2] 
                + (orig->edge_height >> v_shift) * orig->stride[2]
                + (orig->edge_width >> h_shift);

        memcpy(avpic_src.linesize,orig->stride,sizeof(avpic_src.linesize));

        memcpy(avpic_dest.data,dest->pixel,sizeof(avpic_dest.data));
        memcpy(avpic_dest.linesize,dest->stride,sizeof(avpic_dest.linesize));

        pp_postprocess(avpic_src.data,
                        avpic_src.linesize,
                        avpic_dest.data,
                        avpic_dest.linesize,
                        width,
                        height,
                        NULL,//picture->qscale_table,
                        0,//picture->qstride,
                        ppmode,
                        ppcontext,
                        orig->pict_type);
        CopyPicBufferContext(dest,orig);
}
#endif //PP_LIBAVCODEC


--- NEW FILE: VideoFilter.h ---
/*
 * VideoFilter.h: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: VideoFilter.h,v 1.1 2006/05/27 19:12:41 wachm Exp $
 */
#ifndef __VIDEOFILTER_H__
#define __VIDEOFILTER_H__

#ifdef HAVE_CONFIG
# include "config.h"
#endif

#ifdef PP_LIBAVCODEC
#include <stdint.h> //needed by postproc.h
  #include <postprocess.h>
  //#include <postproc/postprocess.h>
#endif //PP_LIBAVCODEC

#include "video.h"

class cVideoFilter {
protected:
        cVideoOut *vout;

public:
        cVideoFilter(cVideoOut *VideoOut);
        virtual ~cVideoFilter();

        virtual void Filter(sPicBuffer *&dest, sPicBuffer *orig)
        {};
        // Filter a Picture

        bool AllocateCheckBuffer(sPicBuffer *&dest, sPicBuffer *orig);
        // If dest is NULL or doesn't match the format of *orig
        // a picture buffer will be (re)allocated

        bool AllocateBuffer(sPicBuffer *&dest, sPicBuffer *orig);
        // Allocates a picture buffer in dest with the same
        // picture format and size as orig
};

class cVideoMirror : public cVideoFilter {
        sPicBuffer *outBuf;
public:
        cVideoMirror(cVideoOut *VideoOut);
        virtual ~cVideoMirror();
   
        virtual void Filter(sPicBuffer *&dest, sPicBuffer *orig);
};

class cDeintLibav : public cVideoFilter {
        sPicBuffer *outBuf;
public:
        cDeintLibav(cVideoOut *VideoOut);
        virtual ~cDeintLibav();
   
        virtual void Filter(sPicBuffer *&dest, sPicBuffer *orig);
};

class cImageConvert : public cVideoFilter {
        sPicBuffer *outBuf;
public:
        cImageConvert(cVideoOut *VideoOut);
        virtual ~cImageConvert();
   
        virtual void Filter(sPicBuffer *&dest, sPicBuffer *orig);
};

#ifdef PP_LIBAVCODEC
class cLibAvPostProc : public cVideoFilter {
        int width, height;
        PixelFormat pix_fmt;
        pp_mode_t *ppmode;
        pp_context_t *ppcontext;
        sPicBuffer *outBuf;
        int currentDeintMethod,currentppMethod,currentppQuality;
public:
        cLibAvPostProc(cVideoOut *VideoOut);
        virtual ~cLibAvPostProc();
   
        virtual void Filter(sPicBuffer *&dest, sPicBuffer *orig);
};
#endif //PP_LIBAVCODEC

#endif //__VIDEOFILTER_H__

--- NEW FILE: PicBuffer.c ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: PicBuffer.c,v 1.1 2006/05/27 19:12:41 wachm Exp $
 */
#include <stdlib.h>
#include <string.h>

#include "PicBuffer.h"
#include "utils.h"

//#define PICDEB(out...) {printf("vout_pic[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}

#ifndef PICDEB
#define PICDEB(out...)
#endif

void InitPicBuffer(sPicBuffer *Pic) {
        memset(Pic->pixel,0,sizeof(Pic->pixel));
        Pic->use_count=0;
        Pic->pic_num=-256*256*256*64;
};

void CopyPicBufferContext(sPicBuffer *dest,sPicBuffer *orig){
    dest->dtg_active_format=orig->dtg_active_format;
    dest->aspect_ratio=orig->aspect_ratio;
    dest->pts=orig->pts;
    dest->interlaced_frame=orig->interlaced_frame;
    dest->pict_type=orig->pict_type;
};   

cPicBufferManager::cPicBufferManager() {
  lastPicNum=0;
  for (int i=0; i< LAST_PICBUF; i++) 
          InitPicBuffer(&PicBuffer[i]);
  
}

cPicBufferManager::~cPicBufferManager() {
        // FIXME release buffers
};

void cPicBufferManager::ReleasePicBuffer(int buf_num) {
        PICDEB("ReleasePicBuffer %d",buf_num);
        sPicBuffer *buf=&PicBuffer[buf_num];

        for (int i=0; i<4; i++) {
                free(buf->pixel[i]);
                buf->pixel[i]=NULL;
        };
        buf->max_height=0;
        buf->max_width=0;
};

void cPicBufferManager::GetChromaSubSample(PixelFormat pix_fmt,
                int &hChromaShift,
                int &vChromaShift) {
        switch (pix_fmt) {
                case PIX_FMT_YUV420P:
                        hChromaShift=vChromaShift=1;
                        break;
                case PIX_FMT_YUV422P:
                        hChromaShift=1;vChromaShift=0;
                        break;
                case PIX_FMT_YUV444P:
                        hChromaShift=0;vChromaShift=0;
                        break;
                      
                default:
                        fprintf(stderr,"warning unsupported pixel format!\n");
                        hChromaShift=vChromaShift=0;
        };
};

void cPicBufferManager::LockBuffer(sPicBuffer *picture) {
        PicBufMutex.Lock();
        if (picture)
                picture->use_count++;
        PicBufMutex.Unlock();
};

void cPicBufferManager::UnlockBuffer(sPicBuffer *picture) {
        PicBufMutex.Lock();
        if (picture && picture->use_count>0)
                picture->use_count--;
        PicBufMutex.Unlock();
};

// the following methods are based on ffmpeg's get_buffer and release_buffer
// with the originial copyright notice
/*
 * utils for libavcodec
 * Copyright (c) 2001 Fabrice Bellard.
 * Copyright (c) 2003 Michel Bardiaux for the av_log API
 * Copyright (c) 2002-2004 Michael Niedermayer <michaelni at gmx.at>
 *
*/
int cPicBufferManager::GetFormatBPP(PixelFormat fmt) {
        int pixel_size=1;
        switch(fmt){
        case PIX_FMT_RGB555:
        case PIX_FMT_RGB565:
        case PIX_FMT_YUV422:
        //case PIX_FMT_UYVY422: // FIXME which ffmpeg version
            pixel_size=2;
            break;
        case PIX_FMT_RGB24:
        case PIX_FMT_BGR24:
            pixel_size=3;
            break;
        case PIX_FMT_RGBA32:
            pixel_size=4;
            break;
        default:
            pixel_size=1;
        }
        return pixel_size;
};

#define ALIGN(x, a) (((x)+(a)-1)&~((a)-1))
#define STRIDE_ALIGN 16
#define EDGE_WIDTH 16

void cPicBufferManager::AllocPicBuffer(int buf_num,PixelFormat pix_fmt, 
                int w, int h)  {
        PICDEB("AllocPicBuffer buf_num %d pix_fmt %d (%d,%d)\n",
                        buf_num,pix_fmt,w,h);
        sPicBuffer *buf=&PicBuffer[buf_num];
        int h_chroma_shift, v_chroma_shift;
        int pixel_size=GetFormatBPP(pix_fmt);
        
        GetChromaSubSample(pix_fmt, h_chroma_shift, v_chroma_shift);

        for(int i=0; i<3; i++){
            const int h_shift= i==0 ? 0 : h_chroma_shift;
            const int v_shift= i==0 ? 0 : v_chroma_shift;

            //FIXME next ensures that linesize= 2^x uvlinesize, thats needed because some MC code assumes it
            buf->stride[i]= ALIGN(pixel_size*w>>h_shift, 
                            STRIDE_ALIGN<<(h_chroma_shift-h_shift)); 

            buf->pixel[i]= (uint8_t*)malloc((buf->stride[i]*h>>v_shift)+16); //FIXME 16
            
            if(buf->pixel[i]==NULL) {
                    printf("could not allocate memory for picture buffer!\n") ;
                    exit(-1);
            };
            
            memset(buf->pixel[i], 128, buf->stride[i]*h>>v_shift);
       
        }
        buf->max_width=w;
        buf->max_height=h;
        PICDEB("end AllocPicBuffer buf->pixel[0] %p\n",buf->pixel[0]);
}

sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
                    int w, int h) {
    PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);

    //assert(pic->data[0]==NULL);

    PicBufMutex.Lock();
    int buf_num=0;
    while (buf_num<LAST_PICBUF && PicBuffer[buf_num].use_count!=0 ) {
            PICDEB("not using buffer %d: use_count=%d\n",buf_num,
                            PicBuffer[buf_num].use_count);
            buf_num++;
    };

    //assert(buf_num<LAST_PICBUF);
    if (buf_num>=LAST_PICBUF) {
            printf("error finding PicBuffer!\n");
            exit(-1);
    };

    // format change?
    if (PicBuffer[buf_num].pixel[0] &&
                    ( PicBuffer[buf_num].format != pix_fmt
                      || PicBuffer[buf_num].max_width != w
                      || PicBuffer[buf_num].max_height != h ) ) {
//                      || PicBuffer[buf_num].max_width < w
//                      || PicBuffer[buf_num].max_height < h ) ) {
            PICDEB("format change relasing old buf_num %d\n",buf_num);
            ReleasePicBuffer(buf_num);
            PicBuffer[buf_num].pixel[0]=NULL;
    };

    if (!PicBuffer[buf_num].pixel[0]) {
            PICDEB("allocating buf_num %d\n",buf_num);
            PicBuffer[buf_num].pic_num= -256*256*256*64;
            AllocPicBuffer(buf_num,pix_fmt,w,h);
    };
    
    // found or allocated a picture buffer
    lastPicNum++;
    PicBuffer[buf_num].use_count++;
    PicBuffer[buf_num].buf_num = buf_num;
    PicBuffer[buf_num].owner = this;
    PicBufMutex.Unlock();

    PicBuffer[buf_num].age= lastPicNum - PicBuffer[buf_num].pic_num;
    PicBuffer[buf_num].pic_num= lastPicNum;

    PICDEB("end GetBuffer: pic->data[0] %p buf_num %d\n",
                    pic->data[0],buf_num);
    return &PicBuffer[buf_num];
}

void cPicBufferManager::ReleaseBuffer( sPicBuffer *pic ){
    PICDEB("ReleaseBuffer frame %p, data[0] %p\n",
                    pic,pic->data[0]);

    int buf_num=0;
    PicBufMutex.Lock();
    while (buf_num<LAST_PICBUF && PicBuffer[buf_num].pixel[0]!=pic->pixel[0] ) 
            buf_num++;

    //assert(buf_num<LAST_PICBUF);
    if (buf_num>=LAST_PICBUF)  {
            printf("didn't find corresponding PicBuffer!\n");
            exit(-1);
    };
    
    // found PicBuffer
    PicBuffer[buf_num].use_count--;
    PicBuffer[buf_num].buf_num=-1;
    PicBufMutex.Unlock();
}

// end of code based on ffmpeg

void CopyPicBuf(sPicBuffer *dst, sPicBuffer *src,
                int width, int height,
                int cutTop, int cutBottom, 
                int cutLeft, int cutRight) {
       
        //cutTop+=src->edge_height/2;
        //cutLeft+=src->edge_width/2;
        uint8_t *dst_ptr=dst->pixel[0];
        uint8_t *src_ptr=src->pixel[0]+
                (2*cutTop+src->edge_height)*src->stride[0]+
                2*cutLeft+src->edge_width;
        for (int i = height - (cutBottom+cutTop) * 2; i>=0; i--) {
                fast_memcpy(dst_ptr,src_ptr,
                            width - 2 * (cutLeft + cutRight));
                dst_ptr+=dst->stride[0];
                src_ptr+=src->stride[0];
        };
        
        dst_ptr=dst->pixel[1];
        src_ptr=src->pixel[1]+(cutTop+src->edge_height/2)*src->stride[1]+
                cutLeft+src->edge_width/2;
        for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
                fast_memcpy (dst_ptr,src_ptr,
                                width / 2 - (cutLeft + cutRight));
                dst_ptr+=dst->stride[1];
                src_ptr+=src->stride[1];
        };

        dst_ptr=dst->pixel[2];
        src_ptr=src->pixel[2]+(cutTop+src->edge_height/2)*src->stride[2]+
                cutLeft+src->edge_width/2;
        for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
                fast_memcpy (dst_ptr,src_ptr,
                                width / 2 - (cutLeft + cutRight));
                dst_ptr+=dst->stride[2];
                src_ptr+=src->stride[2];
        };
};

void CopyPicBufAlphaBlend(sPicBuffer *dst, sPicBuffer *src,
                uint8_t *OsdPy,
                uint8_t *OsdPu, 
                uint8_t *OsdPv,
                uint8_t *OsdPAlphaY,
                uint8_t *OsdPAlphaUV,
                int OsdStride,
                int width, int height,
                int cutTop, int cutBottom, 
                int cutLeft, int cutRight) {
       
        //cutTop+=src->edge_height/2;
        //cutLeft+=src->edge_width/2;
        uint8_t *dst_ptr=dst->pixel[0];
        uint8_t *src_ptr=src->pixel[0]+
                (2*cutTop+src->edge_height)*src->stride[0]+
                2*cutLeft+src->edge_width;
        uint8_t *osd_ptr=OsdPy+2*cutTop*OsdStride+2*cutLeft;
        uint8_t *alpha_ptr=OsdPAlphaY+2*cutTop*OsdStride+2*cutLeft;
        for (int i = height - (cutBottom+cutTop) * 2; i>=0; i--) {
                AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,
                            width - 2 * (cutLeft + cutRight));
                dst_ptr+=dst->stride[0];
                src_ptr+=src->stride[0];
                osd_ptr+=OsdStride;
                alpha_ptr+=OsdStride;
        };
        
        dst_ptr=dst->pixel[1];
        src_ptr=src->pixel[1]+(cutTop+src->edge_height/2)*src->stride[1]+
                cutLeft+src->edge_width/2;
        osd_ptr=OsdPu+cutTop*OsdStride/2+cutLeft;
        alpha_ptr=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
        for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
                AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,
                                width / 2 - (cutLeft + cutRight));
                dst_ptr+=dst->stride[1];
                src_ptr+=src->stride[1];
                osd_ptr+=OsdStride/2;
                alpha_ptr+=OsdStride/2;
        };

        dst_ptr=dst->pixel[2];
        src_ptr=src->pixel[2]+(cutTop+src->edge_height/2)*src->stride[2]+
                cutLeft+src->edge_width/2;
        osd_ptr=OsdPv+cutTop*OsdStride/2+cutLeft;
        alpha_ptr=OsdPAlphaUV+cutTop*OsdStride/2+cutLeft;
        for (int i = height / 2 - (cutBottom+cutTop); i>=0; i--) {
                AlphaBlend(dst_ptr,osd_ptr,src_ptr,alpha_ptr,
                                width / 2 - (cutLeft + cutRight));
                dst_ptr+=dst->stride[2];
                src_ptr+=src->stride[2];
                osd_ptr+=OsdStride/2;
                alpha_ptr+=OsdStride/2;
       };
       /*
        for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
                fast_memcpy (pixels [2] + i * xvWidth / 2 + cutLeft,
                                Pu + i * UVstride + cutLeft,
                                fwidth / 2 - (cutLeft + cutRight));
                                */
};


--- NEW FILE: PicBuffer.h ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: PicBuffer.h,v 1.1 2006/05/27 19:12:41 wachm Exp $
 */
#ifndef __PIC_BUFFER_H__
#define __PIC_BUFFER_H__

#include <avcodec.h>

#ifndef STAND_ALONE
#include <vdr/plugin.h>
#include <vdr/remote.h>
#else
#include "VdrReplacements.h"
#endif

class cPicBufferManager;

typedef struct sPicBuffer {
    PixelFormat format;
    uint8_t *pixel[4];
    int stride[4];
    unsigned int use_count;
    int buf_num;
    int max_width; // maximal size of the picture edge + picture
    int max_height;
    
    int edge_width; // size of edges (needed by some ffmpeg codecs)
    int edge_height;
    int width;  // size of the actual picture (without edges)
    int height;
    int dtg_active_format;
    float aspect_ratio;
    uint64_t pts;
    bool interlaced_frame;
    int pict_type;
   
    cPicBufferManager *owner;
 
    int pic_num;
    int age;
    void *priv_data;
};

void InitPicBuffer(sPicBuffer *Pic);
void CopyPicBufferContext(sPicBuffer *dest,sPicBuffer *orig);

class cPicBufferManager {
public:
        cPicBufferManager();

        virtual ~cPicBufferManager();
      
        int lastPicNum;
#define LAST_PICBUF 10
        struct sPicBuffer PicBuffer[LAST_PICBUF];
        cMutex PicBufMutex;

        sPicBuffer *GetBuffer(PixelFormat pix_fmt,int width, int height);
        void ReleaseBuffer(sPicBuffer *pic);

        void LockBuffer(sPicBuffer *picture);
        void UnlockBuffer(sPicBuffer *picture);
        
        int GetFormatBPP(PixelFormat fmt);
        void GetChromaSubSample(PixelFormat pix_fmt,
                int &hChromaShift,
                int &vChromaShift);
        virtual void ReleasePicBuffer(int buf_num);
        virtual void AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                        int w, int h);

};

void CopyPicBuf(sPicBuffer *dest, sPicBuffer *src,
                int width, int height,
                int cutTop, int cutBottom, int cutLeft, int cutRight);

void CopyPicBufAlphaBlend(sPicBuffer *dst, 
                sPicBuffer *src,
                uint8_t *OsdPy,uint8_t *OsdPu, 
                uint8_t *OsdPv,uint8_t *OsdPAlphaY,
                uint8_t *OsdPAlphaUV,int width, int height,
                int cutTop, int cutBottom,int cutLeft, int cutRight); 
 
#endif

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.57
retrieving revision 1.58
diff -C2 -d -r1.57 -r1.58
*** video.c	23 May 2006 21:11:37 -0000	1.57
--- video.c	27 May 2006 19:12:41 -0000	1.58
***************
*** 13,16 ****
--- 13,17 ----
  #include <unistd.h>
  #include <stdlib.h>
+ #include <math.h>
  
  //#include <vdr/plugin.h>
***************
*** 33,38 ****
  #endif
    // set some reasonable defaults
!   old_width = fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
!   old_height = fheight = lheight = old_dheight = dheight = sheight = 536;
    sxoff = syoff = lxoff = lyoff = 0;
    cutTop = cutBottom = cutLeft = cutRight = 0;
--- 34,39 ----
  #endif
    // set some reasonable defaults
!   fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
!   fheight = lheight = old_dheight = dheight = sheight = 536;
    sxoff = syoff = lxoff = lyoff = 0;
    cutTop = cutBottom = cutLeft = cutRight = 0;
***************
*** 114,131 ****
        {
          OSDDEB("redrawing old_picture\n");
!         DrawStill_420pl (old_picture->data[0],
!                          old_picture->data[1],
!                          old_picture->data[2],
!                          old_width, old_height,
!                          old_picture->linesize[0],
!                          old_picture->linesize[1]);
        }
        else
        {
          OSDDEB("drawing osd_layer\n");
!         DrawStill_420pl (OsdPy,OsdPu, OsdPv,
!                         OsdWidth,OsdHeight,
!                         //OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
!                          OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
        osdMutex.Unlock();
--- 115,135 ----
        {
          OSDDEB("redrawing old_picture\n");
!         DrawStill_420pl(old_picture);
        }
        else
        {
+         sPicBuffer tmpBuf;
+         tmpBuf.pixel[0]=OsdPy;
+         tmpBuf.pixel[1]=OsdPu;
+         tmpBuf.pixel[2]=OsdPv;
+         tmpBuf.stride[0]=OSD_FULL_WIDTH;
+         tmpBuf.stride[1]=tmpBuf.stride[2]=OSD_FULL_WIDTH/2;
+         tmpBuf.width=OSD_FULL_WIDTH;
+         tmpBuf.height=OSD_FULL_HEIGHT;
+         tmpBuf.aspect_ratio=((float)OSD_FULL_HEIGHT)/((float)OSD_FULL_WIDTH);
+         tmpBuf.aspect_ratio=((float)OSD_FULL_WIDTH)/((float)OSD_FULL_HEIGHT);
+         tmpBuf.dtg_active_format=0;
          OSDDEB("drawing osd_layer\n");
!         DrawStill_420pl(&tmpBuf);
        }
        osdMutex.Unlock();
***************
*** 137,155 ****
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::InvalidateOldPicture(void)
! {
!   areaMutex.Lock();
!   old_picture = NULL;
!   areaMutex.Unlock();
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void cVideoOut::SetOldPicture(AVFrame *picture, int width, int height)
  {
    //osdMutex.Lock(); //protected by areaMutex osdMutex will cause deadlocks!
!   old_picture = picture;
!   old_width = width;
!   old_height = height;
    //osdMutex.Unlock();
  }
--- 141,154 ----
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::SetOldPicture(sPicBuffer *picture)
  {
    //osdMutex.Lock(); //protected by areaMutex osdMutex will cause deadlocks!
!   //PICDEB("SetOldPicture pic->buf_num %d\n",picture->buf_num);
!   UnlockBuffer(old_picture);
!   if (picture && picture->owner==this) {
!      LockBuffer(picture);
!      old_picture=picture;
!   } else old_picture = NULL;
!   
    //osdMutex.Unlock();
  }
***************
*** 363,427 ****
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::CheckAspectDimensions(AVFrame *picture,
!                                         AVCodecContext *context)
  {
-     volatile double new_asp;
- 
    /* --------------------------------------------------------------------------
     * check and handle changes of dimensions first
     */
!   if (fwidth != context->width || fheight != context->height)
    {
      dsyslog("[VideoOut]: resolution changed: W(%d -> %d); H(%d ->%d)\n",
!              fwidth, context->width, fheight, context->height);
!     fwidth = context->width; fheight = context->height;
      current_aspect = -1;
    }
! 
!   if (interlaceMode != picture->interlaced_frame)
    {
      //dsyslog("[VideoOut]: interlaced mode now: %sinterlaced",
        //      (picture->interlaced_frame) ? "" : "non-");
!     interlaceMode = picture->interlaced_frame;
!   }
! #if LIBAVCODEC_BUILD > 4686
!   /* --------------------------------------------------------------------------
!    * removed aspect ratio calculation based on picture->pan_scan->width
!    * as this value seems to be wrong on some dvds.
!    * reverted this removal as effect from above it is not reproducable.
!    */
!   if (!context->sample_aspect_ratio.num)
!   {
!     new_asp = (double) (context->width) / (double) (context->height);
!   }
!   else if (picture->pan_scan && picture->pan_scan->width)
!   {
!     new_asp = (double) (picture->pan_scan->width *
!                          context->sample_aspect_ratio.num) /
!                 (double) (picture->pan_scan->height *
!                            context->sample_aspect_ratio.den);
!   }
!   else
!   {
!     new_asp = (double) (context->width * context->sample_aspect_ratio.num) /
!                (double) (context->height * context->sample_aspect_ratio.den);
    }
- #else
-   new_asp = context->aspect_ratio;
- #endif
  
!   /* --------------------------------------------------------------------------
!    * aspect_F and new_asp are now static volatile float. Due to above
!    * code removal, gcc-3.3.1 from suse compiles comparison wrong.
!    * it compares the 32bit float value with it's temprary new_asp value
!    * from above calculation which has even a higher precision than double :-( ,
!    * and would result not_equal every time.
!    */
!   if (aspect_I != context->dtg_active_format ||
!       aspect_F != new_asp)
    {
      dsyslog("[VideoOut]: aspect changed (%d -> %d ; %f -> %f)",
!              aspect_I,context->dtg_active_format,
!              aspect_F,new_asp);
  #if LIBAVCODEC_BUILD > 4686
      if (picture->pan_scan && picture->pan_scan->width) {
--- 362,391 ----
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::CheckAspectDimensions(sPicBuffer *pic)
  {
    /* --------------------------------------------------------------------------
     * check and handle changes of dimensions first
     */
!   if (fwidth != pic->width || fheight != pic->height)
    {
      dsyslog("[VideoOut]: resolution changed: W(%d -> %d); H(%d ->%d)\n",
!              fwidth, pic->width, fheight, pic->height);
!     fwidth = pic->width; fheight = pic->height;
      current_aspect = -1;
    }
!   if (interlaceMode != pic->interlaced_frame)
    {
      //dsyslog("[VideoOut]: interlaced mode now: %sinterlaced",
        //      (picture->interlaced_frame) ? "" : "non-");
!     interlaceMode = pic->interlaced_frame;
    }
  
!   if (aspect_I != pic->dtg_active_format ||
!       fabs(aspect_F - pic->aspect_ratio ) > 0.0001 )
    {
      dsyslog("[VideoOut]: aspect changed (%d -> %d ; %f -> %f)",
!              aspect_I,pic->dtg_active_format,
!              aspect_F,pic->aspect_ratio);
! #if 0
  #if LIBAVCODEC_BUILD > 4686
      if (picture->pan_scan && picture->pan_scan->width) {
***************
*** 440,446 ****
      }
  #endif
  
!     aspect_I = context->dtg_active_format;
!     aspect_F = new_asp;
    }
  
--- 404,411 ----
      }
  #endif
+ #endif
  
!     aspect_I = pic->dtg_active_format;
!     aspect_F = pic->aspect_ratio;
    }
  
***************
*** 475,496 ****
   */
  void cVideoOut::DrawVideo_420pl(cSyncTimer *syncTimer, int *delay,
!                                 AVFrame *picture, AVCodecContext *context)
  {
    areaMutex. Lock();
    OsdRefreshCounter=0;
    Osd_changed=0;
!   CheckAspectDimensions(picture,context);
!   SetOldPicture(picture,context->width,context->height);
    Sync(syncTimer, delay);
!   // display picture
!   YUV(picture->data[0], picture->data[1],picture->data[2],
!       context->width,context->height,
!       picture->linesize[0],picture->linesize[1]);
  
-   /* --------------------------------------------------------------------------
-    * Unlocking could be done a bit earlier in YUV(), after video is displayed
-    * and before event processing starts. For now it is easier to do it here.
-    * Same applies for DrawStill_420pl() below.
-    */
    areaMutex. Unlock();
    ProcessEvents();
--- 440,455 ----
   */
  void cVideoOut::DrawVideo_420pl(cSyncTimer *syncTimer, int *delay,
!                                 sPicBuffer *pic)
  {
    areaMutex. Lock();
    OsdRefreshCounter=0;
    Osd_changed=0;
!   CheckAspectDimensions(pic);
    Sync(syncTimer, delay);
!   
!   // display picture 
!   YUV(pic);
!   SetOldPicture(pic);
  
    areaMutex. Unlock();
    ProcessEvents();
***************
*** 499,513 ****
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::DrawStill_420pl(uint8_t *pY, uint8_t *pU, uint8_t *pV,
!                                 int w, int h, int yPitch, int uvPitch,
!                                 int new_afd,double new_asp)
  {
    areaMutex. Lock();
    OsdRefreshCounter=0;
    Osd_changed=0;
!   CheckArea(w, h);
!   CheckAspect(new_afd==-1?current_afd:new_afd, new_asp==0?aspect_F:new_asp);
    // display picture
!   YUV (pY, pU, pV, w, h, yPitch, uvPitch);
    areaMutex. Unlock();
    ProcessEvents();
--- 458,470 ----
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::DrawStill_420pl(sPicBuffer *buf)
  {
    areaMutex. Lock();
    OsdRefreshCounter=0;
    Osd_changed=0;
!   CheckArea(buf->width, buf->height);
!   CheckAspect(buf->dtg_active_format,buf->aspect_ratio);
    // display picture
!   YUV (buf);
    areaMutex. Unlock();
    ProcessEvents();

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** video.h	23 May 2006 21:11:37 -0000	1.39
--- video.h	27 May 2006 19:12:41 -0000	1.40
***************
*** 23,29 ****
  #include "setup-softdevice.h"
  #include "sync-timer.h"
! 
! 
! #include <avcodec.h>
  
  #define DV_FORMAT_UNKNOWN -1
--- 23,27 ----
  #include "setup-softdevice.h"
  #include "sync-timer.h"
! #include "PicBuffer.h"
  
  #define DV_FORMAT_UNKNOWN -1
***************
*** 66,70 ****
  #endif
  
! class cVideoOut: public cThread {
  private:
      int     aspect_I;
--- 64,68 ----
  #endif
  
! class cVideoOut: public cPicBufferManager, public cThread {
  private:
      int     aspect_I;
***************
*** 113,121 ****
      double  parValues[SETUP_VIDEOASPECTNAMES_COUNT];
  
      bool    videoInitialized;
  
-     AVFrame *old_picture;
-     int     old_width, old_height;
- 
      cSetupStore *setupStore;
  
--- 111,117 ----
      double  parValues[SETUP_VIDEOASPECTNAMES_COUNT];
  
+     sPicBuffer *old_picture;
      bool    videoInitialized;
  
      cSetupStore *setupStore;
  
***************
*** 137,152 ****
  
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
!     virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride) { return; };
      virtual void Pause(void) {return;};
      virtual void SetParValues(double displayAspect, double displayRatio);
      virtual void CheckAspect(int new_afd, double new_asp);
!     virtual void CheckAspectDimensions (AVFrame *picture, AVCodecContext *context);
      virtual void CheckArea(int w, int h);
!     virtual void DrawVideo_420pl (cSyncTimer *syncTimer, int *delay,
!                                   AVFrame *picture, AVCodecContext *context);
!     virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
!                                   int w, int h, int yPitch, int uvPitch,
!                                   int new_afd=-1,
!                                   double new_asp=0.0);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format) {return 1;};
--- 133,146 ----
  
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
!     virtual void YUV(sPicBuffer *buf) { return; };
!     //virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride) { return; };
      virtual void Pause(void) {return;};
      virtual void SetParValues(double displayAspect, double displayRatio);
      virtual void CheckAspect(int new_afd, double new_asp);
!     virtual void CheckAspectDimensions (sPicBuffer *pic);
      virtual void CheckArea(int w, int h);
!     virtual void DrawVideo_420pl(cSyncTimer *syncTimer, int *delay,
!                                   sPicBuffer *pic);
!     virtual void DrawStill_420pl(sPicBuffer *buf);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format) {return 1;};
***************
*** 163,168 ****
      // time
  
!     virtual void InvalidateOldPicture(void);
!     virtual void SetOldPicture(AVFrame *picture, int width, int height);
  
      uint8_t *PixelMask;
--- 157,161 ----
      // time
  
!     virtual void SetOldPicture(sPicBuffer *pic);
  
      uint8_t *PixelMask;

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** ShmClient.c	29 Apr 2006 06:23:28 -0000	1.13
--- ShmClient.c	27 May 2006 19:12:41 -0000	1.14
***************
*** 80,84 ****
          uint8_t *curr_pict=0;
          uint8_t *curr_osd=0;
!         uint8_t *pixel[4];
  
          if ((ctl_shmid = shmget(ctl_key, sizeof( ShmCtlBlock ), 0666)) < 0) {
--- 80,85 ----
          uint8_t *curr_pict=0;
          uint8_t *curr_osd=0;
!         sPicBuffer picture;
!         //uint8_t *pixel[4];
  
          if ((ctl_shmid = shmget(ctl_key, sizeof( ShmCtlBlock ), 0666)) < 0) {
***************
*** 105,108 ****
--- 106,114 ----
                  ctl->stride1=vout->xv_image->pitches[1];
                  ctl->stride2=vout->xv_image->pitches[2];
+                 picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
+                 picture.stride[0]=ctl->stride0;
+                 picture.stride[1]=ctl->stride1;
+                 picture.stride[2]=ctl->stride1;
+                 picture.edge_width=picture.edge_height=0;
          } else {
                  // create a picture in shm
***************
*** 129,135 ****
                          shmctl (ctl->pict_shmid, IPC_RMID, 0);
  
!                 pixel[0]=curr_pict;
!                 pixel[1]=curr_pict+ctl->max_height*ctl->stride0;
!                 pixel[2]=pixel[1]+ctl->max_height/2*ctl->stride1;
          }
          ctl->attached=1;
--- 135,145 ----
                          shmctl (ctl->pict_shmid, IPC_RMID, 0);
  
!                 picture.stride[0]=ctl->stride0;
!                 picture.stride[1]=ctl->stride1;
!                 picture.stride[2]=ctl->stride1;
!                 picture.pixel[0]=curr_pict;
!                 picture.pixel[1]=curr_pict+ctl->max_height*ctl->stride0;
!                 picture.pixel[2]=picture.pixel[1]+ctl->max_height/2*ctl->stride1;
!                 picture.edge_width=picture.edge_height=0;
          }
          ctl->attached=1;
***************
*** 180,195 ****
                                  ctl->max_height:ctl->height;
  
                          vout->CheckArea(width,height);
                          //vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                          if ( vout->useShm ) {
!                                 vout->DrawStill_420pl(NULL,NULL,NULL,
!                                                 width,height,
!                                                 ctl->stride0,ctl->stride1,
!                                                 ctl->new_afd,ctl->new_asp);
                          } else {
!                                 vout->DrawStill_420pl(pixel[0],pixel[2],pixel[1],
!                                         width,height,
!                                         ctl->stride0,ctl->stride1,
!                                         ctl->new_afd,ctl->new_asp);
                          };
                          ctl->new_pict=0;
--- 190,204 ----
                                  ctl->max_height:ctl->height;
  
+                         picture.width=ctl->width;
+                         picture.height=ctl->height;
+                         picture.dtg_active_format=ctl->new_afd;
+                         picture.aspect_ratio=ctl->new_asp;
+ 
                          vout->CheckArea(width,height);
                          //vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                          if ( vout->useShm ) {
!                                 vout->DrawStill_420pl(&picture);
                          } else {
!                                 vout->DrawStill_420pl(&picture);
                          };
                          ctl->new_pict=0;

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.63
retrieving revision 1.64
diff -C2 -d -r1.63 -r1.64
*** mpeg2decoder.c	14 Apr 2006 21:25:44 -0000	1.63
--- mpeg2decoder.c	27 May 2006 19:12:41 -0000	1.64
***************
*** 41,44 ****
--- 41,46 ----
  
  //#define AV_STATS
+ 
+ 
  //------------------------------------cPacketBuffer------------------------
  
***************
*** 498,521 ****
  // --- VIDEO ------------------------------------------------------------------
  
  cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext *Context,
                                           cVideoOut *VideoOut, cClock *Clock,
                                           int Trickspeed,
                                           bool packetMode)
!                                          : cStreamDecoder(Context, packetMode)
  {
-   width = height = -1;
-   pix_fmt = PIX_FMT_NB;
-   pic_buf_lavc = pic_buf_mirror = pic_buf_pp = pic_buf_convert = NULL;
-   currentMirrorMode  = setupStore.mirror;
-   currentDeintMethod = setupStore.deintMethod;
-   currentppMethod = setupStore.ppMethod;
-   currentppQuality = setupStore.ppQuality;
- 
    memset(pts_values,-1,sizeof(pts_values));
    lastPTSidx=lastPTS=0;
    lastCodedPictNo=-1;
- #ifdef PP_LIBAVCODEC
-   ppmode = ppcontext = NULL;
- #endif //PP_LIBAVCODEC
    videoOut=VideoOut;
    clock = Clock;
--- 500,590 ----
  // --- VIDEO ------------------------------------------------------------------
  
+ int GetBuffer(struct AVCodecContext *c, AVFrame *pic) {
+   int w=c->width;
+   int h=c->height;
+ 
+ #if LIBAVCODEC_BUILD >  4737
+   if(avcodec_check_dimensions(c,w,h))
+     return -1;
+ #endif
+ 
+ #if LIBAVCODEC_BUILD >  4713
+   avcodec_align_dimensions(c, &w, &h);
+ #endif
+   
+ #define EDGE_WIDTH 16
+   bool EmuEdge=c->flags&CODEC_FLAG_EMU_EDGE;
+   if(!EmuEdge){
+     w+= EDGE_WIDTH*2;
+     h+= EDGE_WIDTH*2;
+   }
+   sPicBuffer *buf;
+ 
+   cVideoOut *VideoOutPtr=(cVideoOut *)c->opaque;
+   if (!VideoOutPtr) {
+     fprintf(stderr,"VideoOutPtr null!\n");
+     return 0;
+   };
+ 
+   buf=VideoOutPtr->GetBuffer(c->pix_fmt,w,h);
+   if (!buf || !buf->pixel[0]) {
+     fprintf(stderr,"buf or buf->pixel[0] null!\n");
+     return 0;
+   };
+   
+   pic->type= FF_BUFFER_TYPE_USER;
+   pic->opaque = (void*) buf;
+ 
+   int h_chroma_shift, v_chroma_shift;
+   VideoOutPtr->GetChromaSubSample(c->pix_fmt, h_chroma_shift, v_chroma_shift);
+ 
+   for(int i=0; i<4; i++){
+     const int h_shift= i==0 ? 0 : h_chroma_shift;
+     const int v_shift= i==0 ? 0 : v_chroma_shift;
+ 
+     pic->base[i]= buf->pixel[i];
+     if(EmuEdge) {
+       pic->data[i] = buf->pixel[i];
+       buf->edge_width=buf->edge_height=0;
+     } else {
+       buf->edge_width=buf->edge_height=EDGE_WIDTH;
+       pic->data[i] = buf->pixel[i] + (buf->stride[i]*
+           EDGE_WIDTH>>v_shift) + (EDGE_WIDTH>>h_shift);
+       //pic->data[i] = buf->pixel[i] + ALIGN((buf->stride[i]*
+       //              EDGE_WIDTH>>v_shift) + (EDGE_WIDTH>>h_shift),
+       //              STRIDE_ALIGN);
+     };
+     pic->linesize[i]= buf->stride[i];
+   }
+   pic->age=buf->age;
+ 
+   return 1;
+ };
+ 
+ void ReleaseBuffer(struct AVCodecContext *c, AVFrame *pic) {
+   cVideoOut *VideoOutPtr=(cVideoOut *)c->opaque;
+   if (!VideoOutPtr)
+     return;
+   
+   VideoOutPtr->ReleaseBuffer((sPicBuffer *)pic->opaque);
+   for(int i=0; i<3; i++){
+     pic->data[i]=NULL;
+   }
+   pic->opaque = (void*) NULL;
+ };
+ 
  cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext *Context,
                                           cVideoOut *VideoOut, cClock *Clock,
                                           int Trickspeed,
                                           bool packetMode)
!      : cStreamDecoder(Context, packetMode), Mirror(VideoOut),
!        DeintLibav(VideoOut)
! #ifdef PP_LIBAVCODEC
!        ,LibAvPostProc(VideoOut)
! #endif
  {
    memset(pts_values,-1,sizeof(pts_values));
    lastPTSidx=lastPTS=0;
    lastCodedPictNo=-1;
    videoOut=VideoOut;
    clock = Clock;
***************
*** 532,535 ****
--- 601,613 ----
  
    picture=avcodec_alloc_frame();
+ 
+   if (codec->capabilities&CODEC_CAP_DR1) {
+           context->get_buffer=GetBuffer;
+           context->release_buffer=ReleaseBuffer;
+           context->opaque=(void*)videoOut;
+   } else {
+           context->opaque=NULL;
+           printf("not using direct rendering\n");
+   };
  }
  
***************
*** 550,557 ****
--- 628,760 ----
  }
  
+ int cVideoStreamDecoder::DecodePicture_avcodec(sPicBuffer *&pic, int &got_picture,
+                               uint8_t *data, int length, int64_t pkt_pts) {
+   int len=0;
+   
+   if ( context->width  > 2048 || context->height  > 2048 ) {
+     fprintf(stderr,"Invalid width (%d) or height (%d), most likely a broken stream\n",
+         context->width,context->height);
+     context->width=0;
+     context->height=0;
+     return -1;
+   };
+ 
+   len = avcodec_decode_video(context, picture, &got_picture,data, length);
+   if (len < 0)
+     return len;
+ 
+   // save coded picture number together with corresponding pts
+   if (context->coded_frame  &&
+       context->coded_frame->coded_picture_number!=lastCodedPictNo
+       && lastPTS != (int64_t) AV_NOPTS_VALUE ) {
+   //  (*(sPicBuffer *)context->coded_frame->opaque).pts=lastPTS;
+     pts_values[lastPTSidx].pts = lastPTS;
+     pts_values[lastPTSidx].duration = lastDuration;
+     pts_values[lastPTSidx].coded_frame_no =
+       context->coded_frame->coded_picture_number;
+     lastPTSidx = (lastPTSidx+1)%NO_PTS_VALUES;
+     lastCodedPictNo = context->coded_frame->coded_picture_number;
+     MPGDEB("Got pts: pictno %d  pts: %lld lastIdx %d \n",
+         context->coded_frame->coded_picture_number,
+         lastPTS,
+         lastPTSidx);
+     lastPTS = AV_NOPTS_VALUE;
+   }
+ 
+   if (pkt_pts != (int64_t)AV_NOPTS_VALUE) {
+           lastPTS = pkt_pts;
+           // FIXME duration?
+   };
+ 
+   if (!got_picture)
+     return len;
+ 
+   // we got a picture
+   if ( picture->opaque && context->opaque ) {
+           pic=(sPicBuffer *) picture->opaque;
+   } else {
+           // no direct rendering
+           pic=&privBuffer;
+           pic->edge_width=pic->edge_height=0;
+           for (int i=0; i<4; i++) {
+                   pic->pixel[i]=picture->data[i];
+                   pic->stride[i]=picture->linesize[i];
+           };
+           pic->owner=NULL;
+           pic->format=context->pix_fmt;
+   };      
+           
+   pic->pts=AV_NOPTS_VALUE;
+   // find decoded pictures pts value
+   int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
+   while ( picture->coded_picture_number !=
+       pts_values[findPTS].coded_frame_no &&
+       findPTS != lastPTSidx)
+     findPTS=(findPTS+1)%NO_PTS_VALUES;
+ 
+   // found corresponding pts value
+   if (picture->coded_picture_number==pts_values[findPTS].coded_frame_no) {
+      MPGDEB("video pts: %lld, values.pkt : %lld pts - valid PTS: %lld pictno: %d idx: %d\n",
+         pts,pts_values[findPTS].pts,(int) pts - pts_values[findPTS].pts,
+         picture->coded_picture_number,findPTS);
+      pic->pts = pts_values[findPTS].pts;
+   }
+ 
+   /* ------------------------------------------------------------------------
+    * DV read via dv1394 seems to have
+    * context->coded_frame->coded_picture_number
+    * always set to zero. Therefor lets do the following guess upon current
+    * PTS value. Don't know if there are other codecs which deliver
+    * codec_picture_number as zero.
+    * Hopefully noone else will see '#' chars printed.
+    */
+   if (!pic->pts && lastPTS != (int64_t) AV_NOPTS_VALUE)
+   {
+     fprintf(stderr,"#");
+     pic->pts = lastPTS;
+   }
+ 
+   // save the picture's properties
+ #if LIBAVCODEC_BUILD > 4684
+   pic->interlaced_frame=picture->interlaced_frame;
+ #endif
+   pic->width=context->width;
+   pic->height=context->height;
+ #if LIBAVCODEC_BUILD > 4686
+   /* --------------------------------------------------------------------------
+    * removed aspect ratio calculation based on picture->pan_scan->width
+    * as this value seems to be wrong on some dvds.
+    * reverted this removal as effect from above it is not reproducable.
+    */
+   if (!context->sample_aspect_ratio.num)
+   {
+     pic->aspect_ratio = (float) (context->width) / (float) (context->height);
+   }
+   else if (picture->pan_scan && picture->pan_scan->width)
+   {
+     pic->aspect_ratio = (float) (picture->pan_scan->width *
+         context->sample_aspect_ratio.num) /
+       (float) (picture->pan_scan->height *
+                 context->sample_aspect_ratio.den);
+   }
+   else
+   {
+     pic->aspect_ratio =(float) (context->width * 
+         context->sample_aspect_ratio.num) /
+       (float) (context->height * 
+                 context->sample_aspect_ratio.den);
+   }
+ #else
+   pic->aspect_ratio = context->aspect_ratio;
+ #endif
+   pic->dtg_active_format= context->dtg_active_format;
+   return len;
+ };
+ 
  int cVideoStreamDecoder::DecodePacket(AVPacket *pkt)
  {
    int len=0;
    int got_picture=0;
+   sPicBuffer *pic;
  
    uint8_t *data=pkt->data;
***************
*** 559,572 ****
    //MPGDEB("got video packet\n");
    while ( size > 0 ) {
-     if ( context->width  > 2048 || context->height  > 2048 ) {
-       fprintf(stderr,"Invalid width (%d) or height (%d), most likely a broken stream\n",
-           context->width,context->height);
-       resetCodec();
-       return len;
-     };
- 
      BUFDEB("start decode video stream %d data: %p size: %d \n",
          pkt->stream_index,data,size);
!     len = avcodec_decode_video(context, picture, &got_picture,data, size);
      BUFDEB("end decode video got_picture %d, data %p, size %d\n",
          got_picture,data,size);
--- 762,770 ----
    //MPGDEB("got video packet\n");
    while ( size > 0 ) {
      BUFDEB("start decode video stream %d data: %p size: %d \n",
          pkt->stream_index,data,size);
!     len = DecodePicture_avcodec(pic, got_picture,
!                                 data, size, pkt->pts)
!       //avcodec_decode_video(context, picture, &got_picture,data, size);
      BUFDEB("end decode video got_picture %d, data %p, size %d\n",
          got_picture,data,size);
***************
*** 579,601 ****
      data+=len;
  
-     // save coded picture number together with corresponding pts
-     if (context->coded_frame  &&
-         context->coded_frame->coded_picture_number!=lastCodedPictNo
-         && lastPTS != (int64_t) AV_NOPTS_VALUE ) {
-       pts_values[lastPTSidx].pts = lastPTS;
-       pts_values[lastPTSidx].duration = lastDuration;
-       pts_values[lastPTSidx].coded_frame_no =
-         context->coded_frame->coded_picture_number;
-       lastPTSidx = (lastPTSidx+1)%NO_PTS_VALUES;
-       lastCodedPictNo = context->coded_frame->coded_picture_number;
-       MPGDEB("Got pts: pictno %d  pts: %lld lastIdx %d \n",
-         context->coded_frame->coded_picture_number,
-         lastPTS,
-         lastPTSidx);
-       lastPTS = AV_NOPTS_VALUE;
-     }
  
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
-          lastPTS=pkt->pts;
           lastDuration=pkt->duration;
  
--- 777,783 ----
      data+=len;
  
  
+     // FIXME check this again...
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
           lastDuration=pkt->duration;
  
***************
*** 623,630 ****
      // postproc stuff....
      if (setupStore.mirror == 1)
!       Mirror();
! 
      if (setupStore.deintMethod == 1)
!       deintLibavcodec();
  #ifdef PP_LIBAVCODEC
  #ifdef FB_SUPPORT
--- 805,813 ----
      // postproc stuff....
      if (setupStore.mirror == 1)
!       Mirror.Filter(pic,pic);
!    
      if (setupStore.deintMethod == 1)
!       DeintLibav.Filter(pic,pic);
! 
  #ifdef PP_LIBAVCODEC
  #ifdef FB_SUPPORT
***************
*** 633,679 ****
      if (setupStore.deintMethod > 1 || setupStore.ppMethod!=0 )
  #endif //FB_SUPPORT
!       ppLibavcodec();
  #endif //PP_LIBAVCODEC
! 
!     // do format conversions if necessary
!     if (context->pix_fmt!=PIX_FMT_YUV420P)
!       libavcodec_img_convert();
! 
!     width  = context->width;
!     height = context->height;
!     pix_fmt = context->pix_fmt;
! 
!     // find decoded pictures pts value
!     int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
!     while ( picture->coded_picture_number !=
!                 pts_values[findPTS].coded_frame_no &&
!                 findPTS != lastPTSidx)
!          findPTS=(findPTS+1)%NO_PTS_VALUES;
! 
!     // found corresponding pts value
!     if (picture->coded_picture_number==pts_values[findPTS].coded_frame_no) {
!       MPGDEB("video pts: %lld, values.pkt : %lld pts - valid PTS: %lld pictno: %d idx: %d\n",
!              pts,pts_values[findPTS].pts,(int) pts - pts_values[findPTS].pts,
!              picture->coded_picture_number,findPTS);
!       pts = pts_values[findPTS].pts;
!     }
! 
!     /* ------------------------------------------------------------------------
!      * DV read via dv1394 seems to have
!      * context->coded_frame->coded_picture_number
!      * always set to zero. Therefor lets do the following guess upon current
!      * PTS value. Don't know if there are other codecs which deliver
!      * codec_picture_number as zero.
!      * Hopefully noone else will see '#' chars printed.
!      */
!     if (!pts && lastPTS != (int64_t) AV_NOPTS_VALUE)
!     {
!        fprintf(stderr,"#");
!        pts = lastPTS;
!     }
  
    if (!hurry_up || frame % 2 ) {
      MPGDEB("DrawVideo...delay : %d\n",delay);
!     videoOut->DrawVideo_420pl(syncTimer, &delay, picture,context);
      MPGDEB("end DrawVideo\n");
    } else
--- 816,828 ----
      if (setupStore.deintMethod > 1 || setupStore.ppMethod!=0 )
  #endif //FB_SUPPORT
!       LibAvPostProc.Filter(pic,pic);
  #endif //PP_LIBAVCODEC
!     
!   if (pic->pts != AV_NOPTS_VALUE )
!           pts=pic->pts;
  
    if (!hurry_up || frame % 2 ) {
      MPGDEB("DrawVideo...delay : %d\n",delay);
!     videoOut->DrawVideo_420pl(syncTimer, &delay, pic);
      MPGDEB("end DrawVideo\n");
    } else
***************
*** 771,1076 ****
  }
  
- //------------------------------------ postproc stuff -------------------------
- uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt)
- {
-   // (re)allocate picture buffer for deinterlaced/mirrored picture
-   if (pic_buf == NULL)
-     fprintf(stderr,
-             "[softdevice] allocating picture buffer for resolution %dx%d "
- 	    "format %d\n",
-             context->width, context->height, pix_fmt);
-   else
-     fprintf(stderr,
-             "[softdevice] resolution changed to %dx%d, format %d - "
-             "reallocating picture buffer\n",
-             context->width, context->height, pix_fmt);
- 
-   pic_buf = (uchar *) realloc(pic_buf,
-       avpicture_get_size(pix_fmt, context->width, context->height));
- 
-   return pic_buf;
- }
- 
- uchar *cVideoStreamDecoder::freePicBuf(uchar *pic_buf)
- {
-   if (pic_buf)
-   {
-     free (pic_buf);
-     fprintf(stderr,"[softdevice] picture buffer released\n");
-   }
- 
-   return NULL;
- }
- 
- void cVideoStreamDecoder::deintLibavcodec(void)
- {
-   if (pic_buf_lavc == NULL ||
-       context->width != width ||
-       context->height != height ||
-       context->pix_fmt != pix_fmt)
-     pic_buf_lavc = allocatePicBuf(pic_buf_lavc,context->pix_fmt);
- 
-   if ( !pic_buf_lavc ) {
-     fprintf(stderr,
-             "[softdevice] no picture buffer is allocated for deinterlacing !\n"
-             "[softdevice] switching deinterlacing off !\n");
-     setupStore.deintMethod = 0;
-     return;
-   }
- 
-   avpicture_fill(&avpic_dest,pic_buf_lavc,
-                     context->pix_fmt,context->width ,context->height);
- 
-   memcpy(avpic_src.data,picture->data,sizeof(avpic_src.data));
-   memcpy(avpic_src.linesize,picture->linesize,sizeof(avpic_src.linesize));
- 
-   if (avpicture_deinterlace(&avpic_dest, &avpic_src, context->pix_fmt,
-                               context->width, context->height) < 0)
-   {
-     fprintf(stderr,
-             "[softdevice] error, libavcodec deinterlacer failure\n"
-             "[softdevice] switching deinterlacing off !\n");
-     setupStore.deintMethod = 0;
-     return;
-   }
- 
-   memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
-   memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
- }
- 
- void cVideoStreamDecoder::libavcodec_img_convert(void)
- {
-   if (pic_buf_convert == NULL ||
-       context->width != width ||
-       context->height != height) {
-     pic_buf_convert = allocatePicBuf(pic_buf_convert,PIX_FMT_YUV420P);
-     fprintf(stderr,"allocated convert buf\n");
-   }
- 
-   if ( !pic_buf_convert ) {
-      fprintf(stderr,
-             "[softdevice] no picture buffer is allocated for img_convert !\n"
-             "[softdevice] switching img_convert off !\n");
-      return;
-   }
- 
-   avpicture_fill(&avpic_dest,pic_buf_convert,
-                     PIX_FMT_YUV420P,context->width ,context->height);
- 
-   memcpy(avpic_src.data,picture->data,sizeof(avpic_src.data));
-   memcpy(avpic_src.linesize,picture->linesize,sizeof(avpic_src.linesize));
- 
-   if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
- 		  &avpic_src, context->pix_fmt,
-                               context->width, context->height) < 0) {
-      fprintf(stderr,
-               "[softdevice] error, libavcodec img_convert failure\n");
-      return;
-   }
- 
-   memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
-   memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
- }
- 
- void cVideoStreamDecoder::Mirror(void)
- {
-     uchar *ptr_src1, *ptr_src2;
-     uchar *ptr_dest1, *ptr_dest2;
- 
-   if (pic_buf_mirror == NULL ||
-       context->width != width ||
-       context->height != height ||
-       context->pix_fmt != pix_fmt)
-     pic_buf_mirror = allocatePicBuf(pic_buf_mirror,context->pix_fmt);
- 
-   if ( !pic_buf_mirror ) {
-     fprintf(stderr,
-             "[softdevice] no picture buffer is allocated for mirroring !\n"
-             "[softdevice] switching mirroring off !\n");
-     setupStore.mirror = 0;
-     return;
-   }
- 
-   avpicture_fill(&avpic_dest,pic_buf_mirror,
-       context->pix_fmt,context->width ,context->height);
- 
-   // mirror luminance
-   ptr_src1  = picture->data[0];
-   ptr_dest1 = avpic_dest.data[0];
- 
-   for (int h = 0; h < context->height; h++)
-   {
-     for (int w = context->width; w > 0; w--)
-     {
-       *ptr_dest1 = ptr_src1[h * picture->linesize[0] + w - 1];
-       ptr_dest1++;
-     }
-   }
- 
-   // mirror chrominance
-   ptr_src1  = picture->data[1];
-   ptr_src2  = picture->data[2];
-   ptr_dest1 = avpic_dest.data[1];
-   ptr_dest2 = avpic_dest.data[2];
- 
-   int h_shift;
-   int v_shift;
-   avcodec_get_chroma_sub_sample(context->pix_fmt,&h_shift,&v_shift);
- 
-   for (int h = 0; h < context->height >> v_shift ; h++)
-   {
-     for (int w = context->width >> h_shift; w > 0; w--)
-     {
-       *ptr_dest1 = ptr_src1[h * picture->linesize[1] + w - 1];
-       *ptr_dest2 = ptr_src2[h * picture->linesize[2] + w - 1];
-       ptr_dest1++;
-       ptr_dest2++;
-     }
-   }
- 
-   picture->data[0]     = avpic_dest.data[0];
-   picture->data[1]     = avpic_dest.data[1];
-   picture->data[2]     = avpic_dest.data[2];
- 
-   picture->linesize[0] = context->width;
-   picture->linesize[1] = context->width >> h_shift ;
-   picture->linesize[2] = context->width >> h_shift ;
- }
- 
- #ifdef PP_LIBAVCODEC
- void cVideoStreamDecoder::ppLibavcodec(void)
- {
-     int deintWork;
- 
-   if (pic_buf_pp == NULL ||
-       context->width != width ||
-       context->height != height ||
-       context->pix_fmt != pix_fmt)
-     pic_buf_pp = allocatePicBuf(pic_buf_pp,context->pix_fmt);
- 
-   if (ppcontext == NULL ||
-       context->width != width ||
-       context->height != height||
-       context->pix_fmt != pix_fmt) {
-           // reallocate ppcontext if format or size of picture changed
-     if (ppcontext)
-     {
-       pp_free_context(ppcontext);
-       ppcontext = NULL;
-     }
-     /* set one of this values instead of 0 in pp_get_context for
-      * processor-independent optimations:
-        PP_CPU_CAPS_MMX, PP_CPU_CAPS_MMX2, PP_CPU_CAPS_3DNOW
-      */
-     int flags=0;
- #ifdef USE_MMX
-     flags|=PP_CPU_CAPS_MMX;
- #endif
- #ifdef USE_MMX2
-     flags|=PP_CPU_CAPS_MMX2;
- #endif
-     if (context->pix_fmt == PIX_FMT_YUV420P)
-       flags|=PP_FORMAT_420;
-     else if (context->pix_fmt == PIX_FMT_YUV422P)
-       flags|=PP_FORMAT_422;
-     else if (context->pix_fmt == PIX_FMT_YUV444P)
-       flags|=PP_FORMAT_444;
- 
-     ppcontext = pp_get_context(context->width, context->height,flags);
-   }
- 
-   deintWork = setupStore.deintMethod;
-   if (currentDeintMethod != deintWork || ppmode == NULL
-       || currentppMethod != setupStore.ppMethod
-       || currentppQuality != setupStore.ppQuality ) {
-     // reallocate ppmode if method or quality changed
- 
-     if (ppmode)  {
-       pp_free_mode (ppmode);
-       ppmode = NULL;
-     }
-     char mode[60]="";
-     if (setupStore.getPPdeintValue() && setupStore.getPPValue())
-       sprintf(mode,"%s,%s",setupStore.getPPdeintValue(),
-           setupStore.getPPValue());
-     else if (setupStore.getPPdeintValue() )
-       sprintf(mode,"%s",setupStore.getPPdeintValue());
-     else if (setupStore.getPPValue() )
-       sprintf(mode,"%s",setupStore.getPPValue());
- 
-     ppmode = pp_get_mode_by_name_and_quality(mode, setupStore.ppQuality);
- 
-     currentDeintMethod = deintWork;
-     currentppMethod = setupStore.ppMethod;
-     currentppQuality = setupStore.ppQuality;
-   }
- 
-   if (ppmode == NULL || ppcontext == NULL) {
-     fprintf(stderr,
-             "[softdevice] pp-filter %s couldn't be initialized,\n"
-             "[softdevice] switching postprocessing off !\n",
-             setupStore.getPPValue());
-     setupStore.deintMethod = 0;
-     return;
-   }
- 
- 
-   if ( !pic_buf_pp ) {
-     fprintf(stderr,
-             "[softdevice] no picture buffer is allocated for postprocessing !\n"
-             "[softdevice] switching postprocessing off !\n");
-     setupStore.deintMethod = 0;
-     return;
-   }
- 
-   avpicture_fill(&avpic_dest,pic_buf_pp,
-                     context->pix_fmt,context->width ,context->height);
- 
-   pp_postprocess(picture->data,
-       picture->linesize,
-       (uchar **)&avpic_dest.data,
-       (int *)&avpic_dest.linesize,
-       context->width,
-       context->height,
-       picture->qscale_table,
-       picture->qstride,
-       ppmode,
-       ppcontext,
-       picture->pict_type);
- 
-   memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
-   memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
- }
- #endif //PP_LIBAVCODEC
- 
- //----------------------------- end of postproc stuff ----------------------
- 
  cVideoStreamDecoder::~cVideoStreamDecoder()
  {
    cClock::AdjustVideoPTS(0);
-   videoOut->InvalidateOldPicture();
    delete(syncTimer);
    syncTimer=NULL;
    free(picture);
-   if (pic_buf_lavc)
-      pic_buf_lavc = freePicBuf(pic_buf_lavc);
-   if (pic_buf_pp)
-      pic_buf_pp = freePicBuf(pic_buf_pp);
-   if (pic_buf_convert)
-      pic_buf_convert = freePicBuf(pic_buf_convert);
-   if (pic_buf_mirror)
-      pic_buf_mirror = freePicBuf(pic_buf_mirror);
- 
- #ifdef PP_LIBAVCODEC
-   if (ppcontext) {
-      pp_free_context(ppcontext);
-      ppcontext = NULL;
-   }
- 
-   if (ppmode)  {
-       pp_free_mode (ppmode);
-       ppmode = NULL;
-   }
- #endif
  }
  
--- 920,929 ----

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** mpeg2decoder.h	14 Apr 2006 21:25:44 -0000	1.36
--- mpeg2decoder.h	27 May 2006 19:12:41 -0000	1.37
***************
*** 13,30 ****
  #endif
  
  #include <avcodec.h>
  
! #ifdef PP_LIBAVCODEC
!   #include <postproc/postprocess.h>
! #endif //PP_LIBAVCODEC
  
  #include "sync-timer.h"
  #include "video.h"
  #include "audio.h"
! 
! #include <avformat.h>
! #include <sys/time.h>
! #include <vdr/plugin.h>
! #include <vdr/ringbuffer.h>
  
  #define DEFAULT_FRAMETIME 400   // for PAL in 0.1ms
--- 13,27 ----
  #endif
  
+ #include <sys/time.h>
  #include <avcodec.h>
+ #include <avformat.h>
  
! #include <vdr/plugin.h>
! #include <vdr/ringbuffer.h>
  
  #include "sync-timer.h"
  #include "video.h"
  #include "audio.h"
! #include "VideoFilter.h"
  
  #define DEFAULT_FRAMETIME 400   // for PAL in 0.1ms
***************
*** 230,243 ****
      int lastDuration;
      AVFrame             *picture;
!     AVPicture           avpic_src, avpic_dest;
  
!     int                 width, height;
!     PixelFormat         pix_fmt;
!     int                 currentDeintMethod, currentMirrorMode;
!     int                 currentppMethod, currentppQuality;
!     uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror, *pic_buf_convert;
  #ifdef PP_LIBAVCODEC
!     pp_mode_t           *ppmode;
!     pp_context_t        *ppcontext;
  #endif //PP_LIBAVCODEC
  
--- 227,236 ----
      int lastDuration;
      AVFrame             *picture;
!     sPicBuffer          privBuffer;
  
!     cVideoMirror        Mirror;
!     cDeintLibav         DeintLibav;
  #ifdef PP_LIBAVCODEC
!     cLibAvPostProc      LibAvPostProc;
  #endif //PP_LIBAVCODEC
  
***************
*** 253,265 ****
      {return trickspeed*default_frametime;};
  
-     uchar   *allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt);
-     void    deintLibavcodec(void);
-     void    libavcodec_img_convert(void);
-     uchar   *freePicBuf(uchar *pic_buf);
- #ifdef PP_LIBAVCODEC
-     void    ppLibavcodec(void);
- #endif //PP_LIBAVCODEC
-     void    Mirror(void);
- 
    public:
      cVideoStreamDecoder(AVCodecContext *Context, cVideoOut *VideoOut,
--- 246,249 ----
***************
*** 267,270 ****
--- 251,256 ----
      ~cVideoStreamDecoder();
  
+     int DecodePicture_avcodec(sPicBuffer *&pic, int &got_picture,
+                               uint8_t *data, int length, int64_t pts);
      virtual void      Freeze(bool freeze=true);
      virtual void      Play(void);

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.61
retrieving revision 1.62
diff -C2 -d -r1.61 -r1.62
*** video-dfb.c	23 May 2006 21:28:54 -0000	1.61
--- video-dfb.c	27 May 2006 19:12:41 -0000	1.62
***************
*** 1287,1297 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                        int Width, int Height, int Ystride, int UVstride)
  {
!     uint8_t *dst;
!     int pitch;
!     int hi;
! 
    if (!videoInitialized)
      return;
--- 1287,1307 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::YUV(sPicBuffer *buf)
  {
!   uint8_t *dst;
!   int pitch;
!   int hi;
!   uint8_t *Py=buf->pixel[0]
!                 +(buf->edge_height)*buf->stride[0]
!                 +buf->edge_width;
!   uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
!                 +buf->edge_width/2;
!   uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
!                 +buf->edge_width/2;
!   int Ystride=buf->stride[0];
!   int UVstride=buf->stride[1];
!   int Width=buf->width;
!   int Height=buf->height;
!   
    if (!videoInitialized)
      return;

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** video-dfb.h	23 May 2006 21:28:54 -0000	1.20
--- video-dfb.h	27 May 2006 19:12:41 -0000	1.21
***************
*** 75,80 ****
  #endif
  
!     virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                      int Width, int Height, int Ystride, int UVstride);
      virtual void Pause(void);
      virtual void CloseOSD();
--- 75,79 ----
  #endif
  
!     virtual void YUV(sPicBuffer *Pic);
      virtual void Pause(void);
      virtual void CloseOSD();

Index: video-dummy.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dummy.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-dummy.c	24 Feb 2005 22:35:51 -0000	1.2
--- video-dummy.c	27 May 2006 19:12:41 -0000	1.3
***************
*** 33,37 ****
  #endif
  
! void cDummyVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride)
  {
  }
--- 33,37 ----
  #endif
  
! void cDummyVideoOut::YUV(sPicBuffer *buf)
  {
  }

Index: video-dummy.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dummy.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-dummy.h	24 Feb 2005 22:35:51 -0000	1.2
--- video-dummy.h	27 May 2006 19:12:41 -0000	1.3
***************
*** 23,27 ****
  #endif
  
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);
  };
--- 23,27 ----
  #endif
  
!   virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);
  };

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** video-fb.c	24 Apr 2006 20:36:21 -0000	1.14
--- video-fb.c	27 May 2006 19:12:41 -0000	1.15
***************
*** 238,243 ****
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride)
  {
    if (!videoInitialized)
      return;
--- 238,255 ----
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::YUV(sPicBuffer *buf)
  {
+   uint8_t *Py=buf->pixel[0]
+                 +(buf->edge_height)*buf->stride[0]
+                 +buf->edge_width;
+   uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
+                 +buf->edge_width/2;
+   uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
+                 +buf->edge_width/2;
+   int Ystride=buf->stride[0];
+   int UVstride=buf->stride[1];
+   int Width=buf->width;
+   int Height=buf->height;
+  
    if (!videoInitialized)
      return;

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video-fb.h	18 Feb 2006 22:20:29 -0000	1.7
--- video-fb.h	27 May 2006 19:12:41 -0000	1.8
***************
*** 43,47 ****
    virtual void Refresh();
  #endif
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);
  };
--- 43,47 ----
    virtual void Refresh();
  #endif
!   virtual void YUV(sPicBuffer *Pic);
    virtual void Pause(void);
  };

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video-shm.c	23 Apr 2006 19:55:53 -0000	1.7
--- video-shm.c	27 May 2006 19:12:41 -0000	1.8
***************
*** 252,258 ****
  };
  
! void cShmVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                      int Width, int Height, int Ystride, int UVstride) {
! 
          if (!ctl->attached) {
                  setupStore->shouldSuspend=1;
--- 252,267 ----
  };
  
! void cShmVideoOut::YUV(sPicBuffer *buf) {
!         uint8_t *Py=buf->pixel[0]+(buf->edge_height)*buf->stride[0]
!                 +buf->edge_width;
!         uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
!                 +buf->edge_width/2;
!         uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
!                 +buf->edge_width/2;
!         int Ystride=buf->stride[0];
!         int UVstride=buf->stride[1];
!         int Width=buf->width;
!         int Height=buf->height;
!   
          if (!ctl->attached) {
                  setupStore->shouldSuspend=1;

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-shm.h	19 Feb 2006 18:40:28 -0000	1.4
--- video-shm.h	27 May 2006 19:12:41 -0000	1.5
***************
*** 52,57 ****
                      bool &IsYUV, uint8_t *&PixelMask);
  
!         virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                      int Width, int Height, int Ystride, int UVstride);
          virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
                          bool *&dirtyLines);
--- 52,56 ----
                      bool &IsYUV, uint8_t *&PixelMask);
  
!         virtual void YUV(sPicBuffer* buf);
          virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
                          bool *&dirtyLines);

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-vidix.c	24 Apr 2006 20:36:21 -0000	1.18
--- video-vidix.c	27 May 2006 19:12:41 -0000	1.19
***************
*** 395,404 ****
  /* ----------------------------------------------------------------------------
   */
! void cVidixVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                          int Width, int Height,
!                          int Ystride, int UVstride)
  {
!     uint8_t *dst;
!     int hi, wi;
  
    if (!videoInitialized)
--- 395,413 ----
  /* ----------------------------------------------------------------------------
   */
! void cVidixVideoOut::YUV(sPicBuffer *buf)
  {
!   uint8_t *dst;
!   int hi, wi;
!   uint8_t *Py=buf->pixel[0]
!                 +(buf->edge_height)*buf->stride[0]
!                 +buf->edge_width;
!   uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
!                 +buf->edge_width/2;
!   uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
!                 +buf->edge_width/2;
!   int Ystride=buf->stride[0];
!   int UVstride=buf->stride[1];
!   int Width=buf->width;
!   int Height=buf->height;
  
    if (!videoInitialized)

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-vidix.h	18 Feb 2006 22:20:30 -0000	1.9
--- video-vidix.h	27 May 2006 19:12:41 -0000	1.10
***************
*** 63,67 ****
    virtual void CloseOSD();
  //  virtual void OpenOSD();  
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);
  
--- 63,67 ----
    virtual void CloseOSD();
  //  virtual void OpenOSD();  
!   virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);
  

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.54
retrieving revision 1.55
diff -C2 -d -r1.54 -r1.55
*** video-xv.c	24 Apr 2006 22:56:47 -0000	1.54
--- video-xv.c	27 May 2006 19:12:42 -0000	1.55
***************
*** 1585,1591 ****
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                       int Width, int Height,
!                       int Ystride, int UVstride)
  {
    if (!videoInitialized || !xv_initialized)
--- 1585,1589 ----
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::YUV(sPicBuffer *buf)
  {
    if (!videoInitialized || !xv_initialized)
***************
*** 1608,1612 ****
      ClearXvArea (0, 128, 128);
    }
! 
    if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307
--- 1606,1621 ----
      ClearXvArea (0, 128, 128);
    }
!   uint8_t *Py=buf->pixel[0]
!                 +(buf->edge_height)*buf->stride[0]
!                 +buf->edge_width;
!   uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
!                 +buf->edge_width/2;
!   uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
!                 +buf->edge_width/2;
!   int Ystride=buf->stride[0];
!   int UVstride=buf->stride[1];
!   int Width=buf->width;
!   int Height=buf->height;
!   
    if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** video-xv.h	23 Apr 2006 19:38:29 -0000	1.20
--- video-xv.h	27 May 2006 19:12:42 -0000	1.21
***************
*** 187,191 ****
                    XShmSegmentInfo &shminfo,int format, int &width, int &height);
    int PutXvImage();
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);
  
--- 187,191 ----
                    XShmSegmentInfo &shminfo,int format, int &width, int &height);
    int PutXvImage();
!   virtual void YUV(sPicBuffer *buf);
    virtual void Pause(void);
  



From nobody at sheep.berlios.de  Mon May 29 21:20:30 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 29 May 2006 21:20:30 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.191,1.192 PicBuffer.c,1.1,1.2 VideoFilter.c,1.1,1.2
Message-ID: <200605291920.k4TJKUT21508@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8054

Modified Files:
	CHANGELOG PicBuffer.c VideoFilter.c 
Log Message:
- fix a few stupid errors in VideoFilter.c, initialise more 
  variables in PicFilter.c


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.191
retrieving revision 1.192
diff -C2 -d -r1.191 -r1.192
*** CHANGELOG	27 May 2006 19:15:31 -0000	1.191
--- CHANGELOG	29 May 2006 19:25:52 -0000	1.192
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-05-29:
+    - fix a few stupid errors in VideoFilter.c, initialise more 
+      variables in PicFilter.c
  2006-05-27:
     - move postproc stuff into VideoFilter.[ch]

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** PicBuffer.c	27 May 2006 19:12:41 -0000	1.1
--- PicBuffer.c	29 May 2006 19:25:52 -0000	1.2
***************
*** 25,28 ****
--- 25,30 ----
          Pic->use_count=0;
          Pic->pic_num=-256*256*256*64;
+         Pic->format=PIX_FMT_NB;
+         Pic->max_width=Pic->max_height=0;
  };
  
***************
*** 39,43 ****
    for (int i=0; i< LAST_PICBUF; i++) 
            InitPicBuffer(&PicBuffer[i]);
-   
  }
  
--- 41,44 ----
***************
*** 73,78 ****
                        
                  default:
!                         fprintf(stderr,"warning unsupported pixel format!\n");
!                         hChromaShift=vChromaShift=0;
          };
  };
--- 74,79 ----
                        
                  default:
!                         fprintf(stderr,"warning unsupported pixel format(%d)! \n",pix_fmt);
!                         hChromaShift=vChromaShift=1;
          };
  };

Index: VideoFilter.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** VideoFilter.c	27 May 2006 19:12:40 -0000	1.1
--- VideoFilter.c	29 May 2006 19:25:52 -0000	1.2
***************
*** 8,11 ****
--- 8,17 ----
  #include "VideoFilter.h"
  
+ //#define FILDEB(out...) printf(out)
+ 
+ #ifndef FILDEB
+ #define FILDEB(out...)
+ #endif
+ 
  cVideoFilter::cVideoFilter(cVideoOut *VideoOut)
          : vout(VideoOut) {
***************
*** 71,74 ****
--- 77,81 ----
  
  void cVideoMirror::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
+     FILDEB("cVideoMirror::Filtern");
      uchar *ptr_src1, *ptr_src2;
      uchar *ptr_dest1, *ptr_dest2;
***************
*** 78,81 ****
--- 85,89 ----
  
      if ( !outBuf ) {
+             dest=orig;
              fprintf(stderr,
                  "[softdevice] no picture buffer is allocated for mirroring !\n"
***************
*** 144,151 ****
  
      if ( !outBuf ) {
              fprintf(stderr,
                  "[softdevice] no picture buffer is allocated for deinterlacing!\n"
                  "[softdevice] switching deinterlacing off !\n");
!             setupStore.mirror = 0;
              return;
      }
--- 152,160 ----
  
      if ( !outBuf ) {
+             dest=orig;
              fprintf(stderr,
                  "[softdevice] no picture buffer is allocated for deinterlacing!\n"
                  "[softdevice] switching deinterlacing off !\n");
!             setupStore.deintMethod = 0;
              return;
      }
***************
*** 173,178 ****
  
      if (avpicture_deinterlace(&avpic_dest, &avpic_src, orig->format,
!                             orig->width, orig->height) < 0)
!     {
              fprintf(stderr,
                              "[softdevice] error, libavcodec deinterlacer failure\n"
--- 182,187 ----
  
      if (avpicture_deinterlace(&avpic_dest, &avpic_src, orig->format,
!                             orig->width, orig->height) < 0) {
!             dest=orig;
              fprintf(stderr,
                              "[softdevice] error, libavcodec deinterlacer failure\n"
***************
*** 198,201 ****
--- 207,211 ----
  
  void cImageConvert::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
+         FILDEB("cImageConvert::Filtern");
          AVPicture           avpic_src, avpic_dest;
  
***************
*** 221,228 ****
  
          if ( !outBuf ) {
!                 fprintf(stderr,
!                                 "[softdevice] no picture buffer is allocated for image converting!\n"
!                                 "[softdevice] switching deinterlacing off !\n");
!                 setupStore.mirror = 0;
                  return;
          }
--- 231,236 ----
  
          if ( !outBuf ) {
! 		dest=orig;
!                 fprintf(stderr,"[softdevice] no picture buffer is allocated for image converting!\n");
                  return;
          }
***************
*** 252,255 ****
--- 260,264 ----
                                  &avpic_src, orig->format,
                                  orig->width, orig->height) < 0) {
+                 dest=orig;
                  fprintf(stderr,
                                  "[softdevice] error, libavcodec img_convert failure\n");
***************
*** 288,295 ****
  
          if ( !outBuf ) {
                  fprintf(stderr,
                                  "[softdevice] no picture buffer is allocated for post processing!\n"
                                  "[softdevice] switching post processing off !\n");
!                 setupStore.mirror = 0;
                  return;
          }
--- 297,305 ----
  
          if ( !outBuf ) {
+                 dest=orig;
                  fprintf(stderr,
                                  "[softdevice] no picture buffer is allocated for post processing!\n"
                                  "[softdevice] switching post processing off !\n");
!                 setupStore.deintMethod = setupStore.ppMethod = 0;
                  return;
          }
***************
*** 354,362 ****
          }
          if (ppmode == NULL || ppcontext == NULL) {
                  fprintf(stderr,
                          "[softdevice] pp-filter %s couldn't be initialized,\n"
                          "[softdevice] switching postprocessing off !\n",
                          setupStore.getPPValue());
!                 setupStore.deintMethod = 0;
                  return;
          }
--- 364,373 ----
          }
          if (ppmode == NULL || ppcontext == NULL) {
+                 dest=orig;
                  fprintf(stderr,
                          "[softdevice] pp-filter %s couldn't be initialized,\n"
                          "[softdevice] switching postprocessing off !\n",
                          setupStore.getPPValue());
!                 setupStore.deintMethod = setupStore.ppMethod = 0;
                  return;
          }



From nobody at sheep.berlios.de  Mon May 29 22:11:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 29 May 2006 22:11:34 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.192,1.193 PicBuffer.c,1.2,1.3
Message-ID: <200605292011.k4TKBYT23296@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9675

Modified Files:
	CHANGELOG PicBuffer.c 
Log Message:
- fix PICDEB


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.192
retrieving revision 1.193
diff -C2 -d -r1.192 -r1.193
*** CHANGELOG	29 May 2006 19:25:52 -0000	1.192
--- CHANGELOG	29 May 2006 20:16:58 -0000	1.193
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-05-29:
+    - fix PICDEB
     - fix a few stupid errors in VideoFilter.c, initialise more 
       variables in PicFilter.c

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** PicBuffer.c	29 May 2006 19:25:52 -0000	1.2
--- PicBuffer.c	29 May 2006 20:16:58 -0000	1.3
***************
*** 163,167 ****
  sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
                      int w, int h) {
!     PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);
  
      //assert(pic->data[0]==NULL);
--- 163,167 ----
  sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
                      int w, int h) {
!     PICDEB("GetBuffer pix_fmt %d (%d,%d)\n",pix_fmt,w,h);
  
      //assert(pic->data[0]==NULL);
***************
*** 209,220 ****
      PicBuffer[buf_num].pic_num= lastPicNum;
  
!     PICDEB("end GetBuffer: pic->data[0] %p buf_num %d\n",
!                     pic->data[0],buf_num);
      return &PicBuffer[buf_num];
  }
  
  void cPicBufferManager::ReleaseBuffer( sPicBuffer *pic ){
!     PICDEB("ReleaseBuffer frame %p, data[0] %p\n",
!                     pic,pic->data[0]);
  
      int buf_num=0;
--- 209,220 ----
      PicBuffer[buf_num].pic_num= lastPicNum;
  
!     PICDEB("end GetBuffer: PicBuffer.pixel[0] %p buf_num %d\n",
!                     PicBuffer[buf_num].pixel[0],buf_num);
      return &PicBuffer[buf_num];
  }
  
  void cPicBufferManager::ReleaseBuffer( sPicBuffer *pic ){
!     PICDEB("ReleaseBuffer frame %p, pixel[0] %p\n",
!                     pic,pic->pixel[0]);
  
      int buf_num=0;



From nobody at sheep.berlios.de  Tue May 30 20:57:24 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 30 May 2006 20:57:24 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.193,1.194 PicBuffer.c,1.3,1.4 VideoFilter.c,1.2,1.3
Message-ID: <200605301857.k4UIvOb19970@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9820

Modified Files:
	CHANGELOG PicBuffer.c VideoFilter.c 
Log Message:
- set pic->format in AllocPicBuffer()
- more debug messages
   


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.193
retrieving revision 1.194
diff -C2 -d -r1.193 -r1.194
*** CHANGELOG	29 May 2006 20:16:58 -0000	1.193
--- CHANGELOG	30 May 2006 18:57:21 -0000	1.194
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-05-30:
+    - set pic->format in AllocPicBuffer()
+    - more debug messages
  2006-05-29:
     - fix PICDEB

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** PicBuffer.c	29 May 2006 20:16:58 -0000	1.3
--- PicBuffer.c	30 May 2006 18:57:21 -0000	1.4
***************
*** 27,30 ****
--- 27,31 ----
          Pic->format=PIX_FMT_NB;
          Pic->max_width=Pic->max_height=0;
+         Pic->buf_num=-1;
  };
  
***************
*** 48,52 ****
  
  void cPicBufferManager::ReleasePicBuffer(int buf_num) {
!         PICDEB("ReleasePicBuffer %d",buf_num);
          sPicBuffer *buf=&PicBuffer[buf_num];
  
--- 49,53 ----
  
  void cPicBufferManager::ReleasePicBuffer(int buf_num) {
!         PICDEB("ReleasePicBuffer %d\n",buf_num);
          sPicBuffer *buf=&PicBuffer[buf_num];
  
***************
*** 55,60 ****
                  buf->pixel[i]=NULL;
          };
!         buf->max_height=0;
!         buf->max_width=0;
  };
  
--- 56,60 ----
                  buf->pixel[i]=NULL;
          };
!         InitPicBuffer(buf);
  };
  
***************
*** 158,162 ****
          buf->max_width=w;
          buf->max_height=h;
!         PICDEB("end AllocPicBuffer buf->pixel[0] %p\n",buf->pixel[0]);
  }
  
--- 158,164 ----
          buf->max_width=w;
          buf->max_height=h;
!         buf->format=pix_fmt;
!         PICDEB("end AllocPicBuffer buf %p buf->pixel[0] %p\n",
!                         buf,buf->pixel[0]);
  }
  
***************
*** 189,192 ****
--- 191,199 ----
  //                      || PicBuffer[buf_num].max_height < h ) ) {
              PICDEB("format change relasing old buf_num %d\n",buf_num);
+             PICDEB("format %d-%d width %d-%d height %d-%d\n",
+                      PicBuffer[buf_num].format, pix_fmt,
+                      PicBuffer[buf_num].max_width, w,
+                      PicBuffer[buf_num].max_height, h);
+ 
              ReleasePicBuffer(buf_num);
              PicBuffer[buf_num].pixel[0]=NULL;
***************
*** 233,236 ****
--- 240,244 ----
      PicBuffer[buf_num].buf_num=-1;
      PicBufMutex.Unlock();
+     PICDEB("end ReleaseBuffer bufnum %d\n",buf_num);
  }
  

Index: VideoFilter.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** VideoFilter.c	29 May 2006 19:25:52 -0000	1.2
--- VideoFilter.c	30 May 2006 18:57:21 -0000	1.3
***************
*** 50,54 ****
                  return false;
          };
!         
          dest=vout->GetBuffer(orig->format, orig->width, orig->height);
          
--- 50,55 ----
                  return false;
          };
!        
!         printf("allocating buffer format orig->format %d\n",orig->format);
          dest=vout->GetBuffer(orig->format, orig->width, orig->height);
          
***************
*** 77,81 ****
  
  void cVideoMirror::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
!     FILDEB("cVideoMirror::Filtern");
      uchar *ptr_src1, *ptr_src2;
      uchar *ptr_dest1, *ptr_dest2;
--- 78,82 ----
  
  void cVideoMirror::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
!     FILDEB("cVideoMirror::Filter\n");
      uchar *ptr_src1, *ptr_src2;
      uchar *ptr_dest1, *ptr_dest2;
***************
*** 147,150 ****
--- 148,153 ----
  void cDeintLibav::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
      AVPicture           avpic_src, avpic_dest;
+     FILDEB("cDeintLibav::Filter orig %p format %d (%d,%d) buf_num %d\n",orig,
+                     orig->format,orig->max_width,orig->max_height,orig->buf_num);
  
      AllocateCheckBuffer(outBuf, orig);
***************
*** 207,211 ****
  
  void cImageConvert::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
!         FILDEB("cImageConvert::Filtern");
          AVPicture           avpic_src, avpic_dest;
  
--- 210,214 ----
  
  void cImageConvert::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
!         FILDEB("cImageConvert::Filter\n");
          AVPicture           avpic_src, avpic_dest;
  



From nobody at sheep.berlios.de  Tue Jun  6 22:55:21 2006
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 6 Jun 2006 22:55:21 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.194,1.195 utils.c,1.14,1.15 utils.h,1.8,1.9
Message-ID: <200606062055.k56KtLb22865@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32002

Modified Files:
	CHANGELOG utils.c utils.h 
Log Message:
mmx version of yv12_to_yuy2_il_c(): yv12_to_yuy2_il_mmx2(). not yet called.

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.194
retrieving revision 1.195
diff -C2 -d -r1.194 -r1.195
*** CHANGELOG	30 May 2006 18:57:21 -0000	1.194
--- CHANGELOG	6 Jun 2006 20:55:19 -0000	1.195
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-06-06:
+    - mmx version of yv12_to_yuy2_il_c(): yv12_to_yuy2_il_mmx2(). not yet called.
  2006-05-30:
     - set pic->format in AllocPicBuffer()
***************
*** 5,9 ****
  2006-05-29:
     - fix PICDEB
!    - fix a few stupid errors in VideoFilter.c, initialise more 
       variables in PicFilter.c
  2006-05-27:
--- 7,11 ----
  2006-05-29:
     - fix PICDEB
!    - fix a few stupid errors in VideoFilter.c, initialise more
       variables in PicFilter.c
  2006-05-27:

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** utils.c	23 May 2006 19:30:42 -0000	1.14
--- utils.c	6 Jun 2006 20:55:19 -0000	1.15
***************
*** 98,101 ****
--- 98,176 ----
  
  /* ---------------------------------------------------------------------------
+  * convert to lines luma and one line chroma
+  * lang: MMX2
+  */
+ static inline void
+ yv12_to_yuy2_il_mmx2_line (uint8_t *dest,
+                            const int destStride2,
+                            const int lumaStride2, const int chromaWidth,
+                            const uint8_t *yc, const uint8_t *uc, const uint8_t *vc)
+ {
+     int i;
+ 
+   for(i = 0; i < chromaWidth/4; i++)
+   {
+     movq_m2r(*(yc              ), mm1);     // mm1 = y7 y6 y5 y4 y3 y2 y1 y0
+     movq_m2r(*(yc + lumaStride2), mm2);     // mm2 = y7 y6 y5 y4 y3 y2 y1 y0
+     movq_r2r(mm1,mm5);                      // mm5 = y7 y6 y5 y4 y3 y2 y1 y0
+     movd_m2r(*uc, mm3);                     // mm3 = 00 00 00 00 u3 u2 u1 u0
+     movq_r2r(mm2,mm6);                      // mm5 = y7 y6 y5 y4 y3 y2 y1 y0
+     movd_m2r(*vc, mm4);                     // mm3 = 00 00 00 00 v3 v2 v1 v0
+     punpcklbw_r2r(mm4, mm3);                // mm3 = v3 u3 v2 u2 v1 u1 v0 u0
+     punpcklbw_r2r(mm3, mm1);                // mm1 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
+ 
+     movntq(mm1,*(dest + 0));
+     punpckhbw_r2r(mm3, mm5);                // mm5 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
+     punpcklbw_r2r(mm3, mm2);                // mm2 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
+     movntq(mm5,*(dest + 8));
+     punpckhbw_r2r(mm3, mm6);                // mm6 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
+ 
+     movntq(mm2,*(dest + destStride2    ));
+     movntq(mm6,*(dest + destStride2 + 8));
+ 
+     yc += 8;
+     uc += 4;
+     vc += 4;
+     dest += 16;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  * chroma: field based
+  * lang: MMX2
+  */
+ void yv12_to_yuy2_il_mmx2(const uint8_t *py,
+                           const uint8_t *pu, const uint8_t *pv,
+                           uint8_t *dst, const int width, const int height,
+                           int lumStride, int chromStride, int dstStride)
+ {
+   for(int y=0; y<height/4; y++)
+   {
+     /* -----------------------------------------------------------------------
+      * take chroma line x (it's from field A) for packing with
+      * luma lines y * 2 and y * 2 + 2
+      */
+     yv12_to_yuy2_il_mmx2_line (dst,
+                                dstStride * 2, lumStride * 2, width >> 1,
+                                py,
+                                pu, pv);
+     /* -----------------------------------------------------------------------
+      * take chroma line x+1 (it's from field B) for packing with
+      * luma lines y * 2 + 1 and y * 2 + 3
+      */
+     yv12_to_yuy2_il_mmx2_line (dst + dstStride,
+                                dstStride * 2, lumStride * 2, width >> 1,
+                                py + lumStride,
+                                pu + chromStride, pv + chromStride);
+     py  += 4*lumStride;
+     pu  += 2*chromStride;
+     pv  += 2*chromStride;
+     dst += 4*dstStride;
+   }
+   SFENCE;
+   EMMS;
+ }
+ 
+ /* ---------------------------------------------------------------------------
   * chroma: frame based
   * lang: C

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** utils.h	23 May 2006 19:30:42 -0000	1.8
--- utils.h	6 Jun 2006 20:55:19 -0000	1.9
***************
*** 60,63 ****
--- 60,71 ----
                         int dstStride);
  
+ void yv12_to_yuy2_il_mmx2(const uint8_t *py,
+                           const uint8_t *pu,
+                           const uint8_t *pv,
+                           uint8_t *dst,
+                           int width,int height,
+                           int lumStride,int chromStride,
+                           int dstStride);
+ 
  void yv12_to_yuy2_fr_c(const uint8_t *py,
                         const uint8_t *pu,



From nobody at sheep.berlios.de  Fri Jun  9 18:24:37 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 9 Jun 2006 18:24:37 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.62,1.63 video-xv.c,1.55,1.56 video-vidix.c,1.19,1.20
Message-ID: <200606091624.k59GObb19580@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30684

Modified Files:
	video-dfb.c video-xv.c video-vidix.c 
Log Message:
activate mmx version of yv12_to_yuy2_il_ () for dfb, xv and vidix

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.62
retrieving revision 1.63
diff -C2 -d -r1.62 -r1.63
*** video-dfb.c	27 May 2006 19:12:41 -0000	1.62
--- video-dfb.c	9 Jun 2006 16:24:34 -0000	1.63
***************
*** 1303,1307 ****
    int Width=buf->width;
    int Height=buf->height;
!   
    if (!videoInitialized)
      return;
--- 1303,1307 ----
    int Width=buf->width;
    int Height=buf->height;
! 
    if (!videoInitialized)
      return;
***************
*** 1375,1393 ****
  
        if (interlaceMode) {
!         yv12_to_yuy2_il_c(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                           Pu + UVstride * cutTop + cutLeft,
!                           Pv + UVstride * cutTop + cutLeft,
!                           dst + pitch * cutTop * 2 + cutLeft * 4,
!                           Width - 2 * (cutLeft + cutRight),
!                           Height - 2 * (cutTop + cutBottom),
!                           Ystride, UVstride, pitch);
        } else {
!         yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                      Pu + UVstride * cutTop + cutLeft,
!                      Pv + UVstride * cutTop + cutLeft,
!                      dst + pitch * cutTop * 2 + cutLeft * 4,
!                      Width - 2 * (cutLeft + cutRight),
!                      Height - 2 * (cutTop + cutBottom),
!                      Ystride, UVstride, pitch);
        }
       }
--- 1375,1393 ----
  
        if (interlaceMode) {
!         yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                              Pu + UVstride * cutTop + cutLeft,
!                              Pv + UVstride * cutTop + cutLeft,
!                              dst + pitch * cutTop * 2 + cutLeft * 4,
!                              Width - 2 * (cutLeft + cutRight),
!                              Height - 2 * (cutTop + cutBottom),
!                              Ystride, UVstride, pitch);
        } else {
!         yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                              Pu + UVstride * cutTop + cutLeft,
!                              Pv + UVstride * cutTop + cutLeft,
!                              dst + pitch * cutTop * 2 + cutLeft * 4,
!                              Width - 2 * (cutLeft + cutRight),
!                              Height - 2 * (cutTop + cutBottom),
!                              Ystride, UVstride, pitch);
        }
       }

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.55
retrieving revision 1.56
diff -C2 -d -r1.55 -r1.56
*** video-xv.c	27 May 2006 19:12:42 -0000	1.55
--- video-xv.c	9 Jun 2006 16:24:34 -0000	1.56
***************
*** 1617,1621 ****
    int Width=buf->width;
    int Height=buf->height;
!   
    if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307
--- 1617,1621 ----
    int Width=buf->width;
    int Height=buf->height;
! 
    if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307
***************
*** 1678,1689 ****
            break;
          case FOURCC_YUY2:
!           //yv12_to_yuy2_il_c(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!           yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                        Pu + UVstride * cutTop + cutLeft,
!                        Pv + UVstride * cutTop + cutLeft,
!                        pixels[0] + 2*xvWidth * cutTop * 2 + cutLeft * 4,
!                        Width - 2 * (cutLeft + cutRight),
!                        Height - 2 * (cutTop + cutBottom),
!                        Ystride, UVstride, 2*xvWidth);
            break;
        }
--- 1678,1698 ----
            break;
          case FOURCC_YUY2:
!       if (interlaceMode) {
!           yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                pixels[0] + 2*xvWidth * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, 2*xvWidth);
!       } else {
!           yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                pixels[0] + 2*xvWidth * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, 2*xvWidth);
!       }
            break;
        }

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** video-vidix.c	27 May 2006 19:12:41 -0000	1.19
--- video-vidix.c	9 Jun 2006 16:24:35 -0000	1.20
***************
*** 551,560 ****
    } else if (currentPixelFormat == 2) {
      current_osdMode = setupStore->osdMode = OSDMODE_PSEUDO;
!     yv12_to_yuy2(Py + Ystride  * cutTop * 2,
!                  Pu + UVstride * cutTop,
!                  Pv + UVstride * cutTop,
!                  dst + dstrides.y*2 * cutTop * 2,
!                  Width, Height - 2 * (cutTop + cutBottom),
!                  Ystride, UVstride, dstrides.y*2);
    }
  
--- 551,569 ----
    } else if (currentPixelFormat == 2) {
      current_osdMode = setupStore->osdMode = OSDMODE_PSEUDO;
!     if (interlaceMode) {
!       yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2,
!                         Pu + UVstride * cutTop,
!                         Pv + UVstride * cutTop,
!                         dst + dstrides.y*2 * cutTop * 2,
!                         Width, Height - 2 * (cutTop + cutBottom),
!                         Ystride, UVstride, dstrides.y*2);
!     } else {
!       yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2,
!                            Pu + UVstride * cutTop,
!                            Pv + UVstride * cutTop,
!                            dst + dstrides.y*2 * cutTop * 2,
!                            Width, Height - 2 * (cutTop + cutBottom),
!                            Ystride, UVstride, dstrides.y*2);
!     }
    }
  



From nobody at sheep.berlios.de  Fri Jun  9 18:45:18 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 9 Jun 2006 18:45:18 +0200
Subject: [Softdevice-cvs] softdevice softdevice.h,1.9,1.10 softdevice.c,1.59,1.60 Makefile,1.29,1.30 CHANGELOG,1.195,1.196 README,1.18,1.19
Message-ID: <200606091645.k59GjHb20417@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1914

Modified Files:
	softdevice.h softdevice.c Makefile CHANGELOG README 
Log Message:
activate mmx version of yv12_to_yuy2_il_ () for dfb, xv and vidix.
name change libsubvdr-softdevice-METHOD.so.?? -> libsoftdevice-METHOD.so.?? .
removed option -L . is obsolete since we can get the path we are loaded from,
at runtime (thanks to Petri Hintukainen).



Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** softdevice.h	23 Apr 2006 19:55:53 -0000	1.9
--- softdevice.h	9 Jun 2006 16:45:13 -0000	1.10
***************
*** 32,39 ****
          // value = 0 Play, value = 1 Pause
  };
!         
  
  static const char *const GET_PACKET_HANDEL_IDV100="softdevice-GetPacketHandles-v1.0";
! // 
  
  // --- cSoftDevice ------------------------------------------------------------
--- 32,39 ----
          // value = 0 Play, value = 1 Pause
  };
! 
  
  static const char *const GET_PACKET_HANDEL_IDV100="softdevice-GetPacketHandles-v1.0";
! //
  
  // --- cSoftDevice ------------------------------------------------------------
***************
*** 42,51 ****
    int   voutMethod;
    int   aoutMethod;
!   char  *pluginPath;
  
  public:
    cPluginSoftDevice(void);
    virtual ~cPluginSoftDevice();
!   virtual const char *Version(void); 
    virtual const char *Description(void);
    virtual const char *CommandLineHelp(void);
--- 42,52 ----
    int   voutMethod;
    int   aoutMethod;
!   char  *pluginPath,
!         *runtimePluginPath;
  
  public:
    cPluginSoftDevice(void);
    virtual ~cPluginSoftDevice();
!   virtual const char *Version(void);
    virtual const char *Description(void);
    virtual const char *CommandLineHelp(void);
***************
*** 82,89 ****
    cSoftDevice(int method, int audioMethod, char *pluginPath);
    ~cSoftDevice();
!   
!   inline void QueuePacket(AVFormatContext *ic, AVPacket &pkt) 
    { if (decoder) decoder->QueuePacket(ic,pkt,true); };
!   inline int ResetDecoder(int Stream) 
    { if (decoder) decoder->ResetDecoder(Stream); return 0;};
    inline int BufferFill(int Stream)
--- 83,90 ----
    cSoftDevice(int method, int audioMethod, char *pluginPath);
    ~cSoftDevice();
! 
!   inline void QueuePacket(AVFormatContext *ic, AVPacket &pkt)
    { if (decoder) decoder->QueuePacket(ic,pkt,true); };
!   inline int ResetDecoder(int Stream)
    { if (decoder) decoder->ResetDecoder(Stream); return 0;};
    inline int BufferFill(int Stream)

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.59
retrieving revision 1.60
diff -C2 -d -r1.59 -r1.60
*** softdevice.c	30 Apr 2006 13:50:12 -0000	1.59
--- softdevice.c	9 Jun 2006 16:45:13 -0000	1.60
***************
*** 290,293 ****
--- 290,295 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  cSoftDevice::~cSoftDevice()
  {
***************
*** 309,313 ****
              "%s/%s%s.so.%s",
              pluginPath,
!             "libsubvdr-softdevice-",
              outMethodName,
              APIVERSION);
--- 311,315 ----
              "%s/%s%s.so.%s",
              pluginPath,
!             "libsoftdevice-",
              outMethodName,
              APIVERSION);
***************
*** 316,323 ****
              "%s/%s%s.so.%s",
              pluginPath,
!             "libsubvdr-softdevice-",
              outMethodName,
              VDRVERSION);
  #endif
    void *handle = dlopen (subPluginFileName, RTLD_NOW);
    char *err = dlerror();
--- 318,326 ----
              "%s/%s%s.so.%s",
              pluginPath,
!             "libsoftdevice-",
              outMethodName,
              VDRVERSION);
  #endif
+ 
    void *handle = dlopen (subPluginFileName, RTLD_NOW);
    char *err = dlerror();
***************
*** 628,631 ****
--- 631,654 ----
  // --- cPluginSoftDevice ----------------------------------------------------------
  
+ /* ----------------------------------------------------------------------------
+  */
+ static char *GetLibPath(void)
+ {
+     Dl_info info;
+     char *libpath, *pt;
+     static int my_marker = 0;
+ 
+   if(!dladdr((void *)&my_marker, &info)) {
+     fprintf(stderr, "Error: dladdr() returned false (%s)", dlerror());
+     return NULL;
+   }
+ 
+   libpath = strdup(info.dli_fname);
+   if(NULL != (pt=strrchr(libpath, '/')))
+     *(pt+1) = 0;
+ 
+   return libpath;
+ }
+ 
  cPluginSoftDevice::cPluginSoftDevice(void)
  {
***************
*** 640,643 ****
--- 663,667 ----
    aoutMethod = AOUT_ALSA;
    pluginPath = PLUGINLIBDIR;
+   runtimePluginPath = GetLibPath();
  }
  
***************
*** 687,691 ****
  #endif
    "  -vo dummy:               enable output to dummy device\n"
-   "  -L <plugin_path_name>    search path for loading subplugins\n"
    "\n";
  }
--- 711,714 ----
***************
*** 872,880 ****
  
        }
-     } else if (!strcmp (argv[i], "-L")) {
-       ++i; --argc;
-       if (argc > 0) {
-         pluginPath = argv[i];
-       }
      } else {
              fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);
--- 895,898 ----
***************
*** 951,955 ****
    // Start any background activities the plugin shall perform.
    fprintf(stderr,"[softdevice] initializing Plugin\n");
!   new cSoftDevice(voutMethod,aoutMethod,pluginPath);
    return true;
  }
--- 969,975 ----
    // Start any background activities the plugin shall perform.
    fprintf(stderr,"[softdevice] initializing Plugin\n");
!   new cSoftDevice(voutMethod,
!                   aoutMethod,
!                   (runtimePluginPath) ? runtimePluginPath : pluginPath);
    return true;
  }

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** Makefile	27 May 2006 19:15:31 -0000	1.29
--- Makefile	9 Jun 2006 16:45:13 -0000	1.30
***************
*** 203,214 ****
  APIVERSION = $(shell sed -ne '/define APIVERSION/ { s/^.*"\(.*\)".*$$/\1/; p }' $(VDRDIR)/config.h)
  
- INST_VERSION = $(APIVERSION)
- 
  ifeq ($(APIVERSION),)
! 	INST_VERSION = $(VDRVERSION)
  endif
  
- #DUMMY=$(LIBDIR)/fake.vdr.Makefile.check.$(APIVERSION)
- 
  ### The name of the distribution archive:
  
--- 203,210 ----
  APIVERSION = $(shell sed -ne '/define APIVERSION/ { s/^.*"\(.*\)".*$$/\1/; p }' $(VDRDIR)/config.h)
  
  ifeq ($(APIVERSION),)
! 	APIVERSION = $(VDRVERSION)
  endif
  
  ### The name of the distribution archive:
  
***************
*** 234,238 ****
      DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
!     TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
--- 230,234 ----
      DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
!     TARGETS  += lib$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
***************
*** 247,251 ****
      FB_OBJS   = utils.o video.o video-fb.o PicBuffer.o
      ALL_OBJS  += $(FB_OBJS)
!     TARGETS   += libsubvdr-$(PLUGIN)-fb.so
    else
      OBJS 	+= video-fb.o
--- 243,247 ----
      FB_OBJS   = utils.o video.o video-fb.o PicBuffer.o
      ALL_OBJS  += $(FB_OBJS)
!     TARGETS   += lib$(PLUGIN)-fb.so
    else
      OBJS 	+= video-fb.o
***************
*** 257,261 ****
      XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o PicBuffer.o
      ALL_OBJS  += $(XV_OBJS)
!     TARGETS   += libsubvdr-$(PLUGIN)-xv.so
    else
      OBJS 	+= video-xv.o xscreensaver.o
--- 253,257 ----
      XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o PicBuffer.o
      ALL_OBJS  += $(XV_OBJS)
!     TARGETS   += lib$(PLUGIN)-xv.so
    else
      OBJS 	+= video-xv.o xscreensaver.o
***************
*** 268,272 ****
      VIDIX_OBJS  = utils.o video.o video-vidix.o PicBuffer.o
      ALL_OBJS    += $(VIDIX_OBJS)
!     TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
    else
      OBJS        += video-vidix.o
--- 264,268 ----
      VIDIX_OBJS  = utils.o video.o video-vidix.o PicBuffer.o
      ALL_OBJS    += $(VIDIX_OBJS)
!     TARGETS     += lib$(PLUGIN)-vidix.so
    else
      OBJS        += video-vidix.o
***************
*** 280,284 ****
      SHM_OBJS  = utils.o video.o video-shm.o PicBuffer.o
      ALL_OBJS    += $(SHM_OBJS)
!     TARGETS     += libsubvdr-$(PLUGIN)-shm.so
    else
      OBJS += video-shm.o
--- 276,280 ----
      SHM_OBJS  = utils.o video.o video-shm.o PicBuffer.o
      ALL_OBJS    += $(SHM_OBJS)
!     TARGETS     += lib$(PLUGIN)-shm.so
    else
      OBJS += video-shm.o
***************
*** 309,335 ****
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  ifdef USE_SUBPLUGINS
  
! libsubvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
! libsubvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
! libsubvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
! libsubvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
! libsubvdr-$(PLUGIN)-shm.so: $(SHM_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(INST_VERSION)
  
  endif
--- 305,331 ----
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  ifdef USE_SUBPLUGINS
  
! lib$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
! lib$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
! lib$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
! lib$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
! lib$(PLUGIN)-shm.so: $(SHM_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  endif
***************
*** 355,359 ****
  SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o setup-softdevice_shm.o\
  		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
! 		   ShmClient_shm.o PicBuffer_shm.o 
  
  %_shm.o: %.c
--- 351,355 ----
  SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o setup-softdevice_shm.o\
  		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
! 		   ShmClient_shm.o PicBuffer_shm.o
  
  %_shm.o: %.c

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.195
retrieving revision 1.196
diff -C2 -d -r1.195 -r1.196
*** CHANGELOG	6 Jun 2006 20:55:19 -0000	1.195
--- CHANGELOG	9 Jun 2006 16:45:13 -0000	1.196
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2006-06-09:
+    - activate mmx version of yv12_to_yuy2_il_ () for dfb, xv and vidix.
+    - name change libsubvdr-softdevice-METHOD.so.?? -> libsoftdevice-METHOD.so.?? .
+    - removed option -L . is obsolete since we can get the path we are loaded from,
+      at runtime (thanks to Petri Hintukainen).
  2006-06-06:
     - mmx version of yv12_to_yuy2_il_c(): yv12_to_yuy2_il_mmx2(). not yet called.

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** README	29 Apr 2006 16:01:09 -0000	1.18
--- README	9 Jun 2006 16:45:13 -0000	1.19
***************
*** 81,89 ****
  
  
- If you compiled softdevice with option USE_SUBPLUGINS (the default from
- Makefile) and you start vdr with option -L PATH or --lib=PATH , you'll have to
- specify that pathname to softdevice too via option -L PATH.
- 
- 
  To get a full list of options try "vdr -h"
  
--- 81,84 ----
***************
*** 268,271 ****
--- 263,267 ----
  - Martin Wache
  - Nicolas Huillard
+ - Petri Hintukainen
  - Roland Praml
  - Rolf Ahrenberg
***************
*** 274,276 ****
  - Torgeir Veimo
  - Vadim Catana
- 
--- 270,271 ----



From nobody at sheep.berlios.de  Thu Jun 15 23:27:11 2006
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 15 Jun 2006 23:27:11 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.196,1.197 configure,1.15,1.16
Message-ID: <200606152127.k5FLRBb24934@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29790

Modified Files:
	CHANGELOG configure 
Log Message:
- make configure more verbose


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.196
retrieving revision 1.197
diff -C2 -d -r1.196 -r1.197
*** CHANGELOG	9 Jun 2006 16:45:13 -0000	1.196
--- CHANGELOG	15 Jun 2006 21:27:08 -0000	1.197
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-06-15:
+    - make configure a bit more verbose. A complete log is now saved in 
+      config.log.
  2006-06-09:
     - activate mmx version of yv12_to_yuy2_il_ () for dfb, xv and vidix.

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** configure	27 May 2006 13:00:07 -0000	1.15
--- configure	15 Jun 2006 21:27:08 -0000	1.16
***************
*** 53,56 ****
--- 53,59 ----
  }
  
+ echo "Parameters '$@'" >config.log
+ echo "PKG_CONFIG_PATH '$PKG_CONFIG_PATH'" >> config.log 
+ 
  while [ $# -gt 0 ]
  do
***************
*** 80,83 ****
--- 83,89 ----
  # start ffmpeg test
  #
+ echo -n "Checking for ffmpeg... "
+ echo  "Checking for ffmpeg.------------------------------------" >> config.log
+ 
  test_ffmpeg() 
  {
***************
*** 100,113 ****
  }
  EOF
!   $cc $CFLAGS $ffmpeg_cflags $ffmpeg_libs -o $TMPE $TMPC $ffmpeg_libs  > /dev/null 2>&1 || ffmpeg="no"
  };
  
! # try to use pkg-config
  ffmpeg_l1="libavcodec libavformat"
  
! pkg-config --libs libpostproc >/dev/null 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
! ffmpeg_libs=`pkg-config --libs $ffmpeg_l1` || ffmpeg="no"
! ffmpeg_cflags=`pkg-config --cflags $ffmpeg_l1`
  
  # test if it works..
--- 106,119 ----
  }
  EOF
!   $cc $CFLAGS $ffmpeg_cflags $ffmpeg_libs -o $TMPE $TMPC $ffmpeg_libs  >> config.log 2>&1 || ffmpeg="no"
  };
  
! echo "try to use pkg-config." >> config.log
  ffmpeg_l1="libavcodec libavformat"
  
! pkg-config --libs libpostproc >> config.log 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
! ffmpeg_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --libs $ffmpeg_l1 2>> config.log` || ffmpeg="no"
! ffmpeg_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --cflags $ffmpeg_l1 2>> config.log`
  
  # test if it works..
***************
*** 115,119 ****
  
  if test "${ffmpeg}" = "no" ; then
!   #pkg-config failed, try the default/parameter path 
    ffmpeg="yes"
    ffmpeg_libs="-L${ffmpeg_path}/ -L${ffmpeg_path}/libavcodec/ -L${ffmpeg_path}/libavformat/ -lavformat -lz -lavcodec "
--- 121,125 ----
  
  if test "${ffmpeg}" = "no" ; then
!   echo "pkg-config failed, try the default/parameter path." >> config.log
    ffmpeg="yes"
    ffmpeg_libs="-L${ffmpeg_path}/ -L${ffmpeg_path}/libavcodec/ -L${ffmpeg_path}/libavformat/ -lavformat -lz -lavcodec "
***************
*** 123,128 ****
  
    if test "${ffmpeg}" = "no" ; then
!     #maybe avutils is needed?
!     echo "checking for avutils..."
      ffmpeg_libs="$ffmpeg_libs -L${ffmpeg_path}/libavutil/ -lavutil"
      ffmpeg_cflags="$ffmpeg_cflags -I${ffmpeg_path}/libavutil/"
--- 129,133 ----
  
    if test "${ffmpeg}" = "no" ; then
!     echo "Still failed. Maybe avutils is needed?" >> config.log
      ffmpeg_libs="$ffmpeg_libs -L${ffmpeg_path}/libavutil/ -lavutil"
      ffmpeg_cflags="$ffmpeg_cflags -I${ffmpeg_path}/libavutil/"
***************
*** 132,153 ****
  
    if test "${ffmpeg}" = "no" ; then
      echo "No usable ffmpeg library found in ${ffmpeg_path}."
      echo "Specify the path to your ffmpeg installation using --with-ffmpeg-path"
!     echo "or use a more recent (cvs) version of ffmpeg with pkg-config"
      exit 8;
    fi
  fi
  
! 
  #########################################################
  # start of DirectFB specific tests
  #
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`pkg-config --cflags directfb dfb++ 2>/dev/null` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
  
! dfb_libs=`pkg-config --libs directfb dfb++`
  dfb_opts="${dfb_cflags} ${dfb_libs}"
  dfb_device_desc="yes"
--- 137,164 ----
  
    if test "${ffmpeg}" = "no" ; then
+     echo "No. Sorry giving up." >> config.log
+     echo " Not found."
      echo "No usable ffmpeg library found in ${ffmpeg_path}."
      echo "Specify the path to your ffmpeg installation using --with-ffmpeg-path"
!     echo "or use a more recent (cvs) version of ffmpeg with pkg-config."
!     echo "For details check config.log."
      exit 8;
    fi
  fi
  
! echo "Ok."
  #########################################################
  # start of DirectFB specific tests
  #
+ echo -n "Checking for DirectFB and DFB++... "
+ echo "Checking for DirectFB and DFB++.------------------" >> config.log
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --cflags directfb dfb++ ` || dfb="no"
! #dfb_cflags=`pkg-config --cflags directfb dfb++ 2>> config.log` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
  
! dfb_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --libs directfb dfb++`
  dfb_opts="${dfb_cflags} ${dfb_libs}"
  dfb_device_desc="yes"
***************
*** 164,168 ****
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_device_desc="no"
  
  cat > ${TMPC} << EOF
--- 175,179 ----
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_device_desc="no"
  
  cat > ${TMPC} << EOF
***************
*** 176,180 ****
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_sourcelocation="no"
  
  cat > ${TMPC} << EOF
--- 187,191 ----
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_sourcelocation="no"
  
  cat > ${TMPC} << EOF
***************
*** 193,197 ****
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dscaps_double="no"
  
  cat > ${TMPC} << EOF
--- 204,208 ----
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_dscaps_double="no"
  
  cat > ${TMPC} << EOF
***************
*** 205,209 ****
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dief_repeat="no"
  
  cat > ${TMPC} << EOF
--- 216,220 ----
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_dief_repeat="no"
  
  cat > ${TMPC} << EOF
***************
*** 216,223 ****
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_blit_interlaced="no"
  
    fi
  fi
  # end of DirectFB specific tests
  
--- 227,241 ----
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_blit_interlaced="no"
  
    fi
  fi
+ 
+ if test "${dfb}" = "yes" ; then
+ echo "Enabled video-dfb."
+ else
+ echo "Not Found."
+ fi
+ 
  # end of DirectFB specific tests
  
***************
*** 225,228 ****
--- 243,249 ----
  # vidix: check if we could compile with specified options
  #
+ echo -n "Checking for vidix... "
+ echo "Checking for vidix.------------------------" >> config.log
+ 
  if test "${vidix}" = "yes" ; then
    vidix_cflags="-I${vidix_path}/include/vidix"
***************
*** 236,240 ****
  }
  EOF
! $cc $CFLAGS $vidix_cflags $vidix_libs -o $TMPE $TMPC > /dev/null 2>&1 || vidix="no"
  fi
  
--- 257,267 ----
  }
  EOF
! $cc $CFLAGS $vidix_cflags $vidix_libs -o $TMPE $TMPC >> config.log 2>&1 || vidix="no"
! fi
! 
! if test "${vidix}" = "yes" ; then
! echo "Enabled video-out vidix."
! else
! echo "Not found."
  fi
  
***************
*** 242,245 ****
--- 269,275 ----
  # X11: check if X11 is present
  #
+ echo -n "Checking for Xv... "
+ echo  "Checking for Xv.-----------------------------" >> config.log
+ 
  if test "${xv}" = "yes" ; then
    xv_libs="-L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv"
***************
*** 253,257 ****
  }
  EOF
! $cc $CFLAGS $xv_libs -o $TMPE $TMPC > /dev/null 2>&1 || xv="no"
  fi
  
--- 283,293 ----
  }
  EOF
! $cc $CFLAGS $xv_libs -o $TMPE $TMPC >> config.log 2>&1 || xv="no"
! fi
! 
! if test "${xv}" = "yes" ; then
! echo "Enabled video-xv."
! else
! echo "Not found."
  fi
  
***************
*** 259,262 ****
--- 295,301 ----
  # X11: check if we can use Xinerama extension
  #
+ echo -n "Checking for Xinerama... "
+ echo "Checking for Xinerama.-----------------------------" >> config.log
+ 
  if test "${xv}" = "yes" -a "${xinerama}" = "yes" ; then
    xinerama_libs="-lXinerama"
***************
*** 274,278 ****
  }
  EOF
! $cc $CFLAGS $xv_libs $xinerama_libs -o $TMPE $TMPC > /dev/null 2>&1 || xinerama="no"
  fi
  
--- 313,323 ----
  }
  EOF
! $cc $CFLAGS $xv_libs $xinerama_libs -o $TMPE $TMPC >> config.log 2>&1 || xinerama="no"
! fi
! 
! if test "${xv}" = "yes" -a "${xinerama}" = "yes" ; then
! echo "Enabled Xinerama."
! else
! echo "Not found."
  fi
  
***************
*** 315,319 ****
  }
  EOF
! $cc $CFLAGS -o $TMPE $TMPC > /dev/null 2>&1 || broken_gcc_cpp="yes"
  ###########
  
--- 360,364 ----
  }
  EOF
! $cc $CFLAGS -o $TMPE $TMPC >> config.log 2>&1 || broken_gcc_cpp="yes"
  ###########
  
***************
*** 463,466 ****
--- 508,513 ----
    echo "config.mak is unchanged"
  fi
+ 
+ echo "Configure is finished. Please check config.log in case of problems."
  
  rm -f $TMPC $TMPE $TMPH $TMPM



From nobody at sheep.berlios.de  Thu Jun 15 23:34:22 2006
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 15 Jun 2006 23:34:22 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.197,1.198 mpeg2decoder.c,1.64,1.65 SoftOsd.c,1.14,1.15
Message-ID: <200606152134.k5FLYMb25301@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30508

Modified Files:
	CHANGELOG mpeg2decoder.c SoftOsd.c 
Log Message:
- fix delete <-> delete[] mismatch



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.197
retrieving revision 1.198
diff -C2 -d -r1.197 -r1.198
*** CHANGELOG	15 Jun 2006 21:27:08 -0000	1.197
--- CHANGELOG	15 Jun 2006 21:34:20 -0000	1.198
***************
*** 3,6 ****
--- 3,7 ----
     - make configure a bit more verbose. A complete log is now saved in 
       config.log.
+    - fix delete <-> delete[] mismatch reported by Prakash Punnoor.
  2006-06-09:
     - activate mmx version of yv12_to_yuy2_il_ () for dfb, xv and vidix.

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.64
retrieving revision 1.65
diff -C2 -d -r1.64 -r1.65
*** mpeg2decoder.c	27 May 2006 19:12:41 -0000	1.64
--- mpeg2decoder.c	15 Jun 2006 21:34:20 -0000	1.65
***************
*** 54,58 ****
  cPacketQueue::~cPacketQueue() {
    Clear();
!   delete queue;
  };
  
--- 54,58 ----
  cPacketQueue::~cPacketQueue() {
    Clear();
!   delete[] queue;
  };
  

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** SoftOsd.c	27 May 2006 08:06:34 -0000	1.14
--- SoftOsd.c	15 Jun 2006 21:34:20 -0000	1.15
***************
*** 45,48 ****
--- 45,49 ----
  	videoOut->OpenOSD();
  	xOfs=X;yOfs=Y;
+         ScreenOsdWidth=ScreenOsdHeight=0;
          int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
          uint8_t *PixelMask;
***************
*** 79,83 ****
                  videoOut=0;
          }
!         delete OSD_Bitmap;
  }
  
--- 80,84 ----
                  videoOut=0;
          }
!         delete[] OSD_Bitmap;
  }
  



From nobody at sheep.berlios.de  Fri Jun 16 20:46:14 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 16 Jun 2006 20:46:14 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.63,1.64
Message-ID: <200606161846.k5GIkEb26681@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14075

Modified Files:
	video-dfb.c 
Log Message:
fix via aspect ratio handling

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.63
retrieving revision 1.64
diff -C2 -d -r1.63 -r1.64
*** video-dfb.c	9 Jun 2006 16:24:34 -0000	1.63
--- video-dfb.c	16 Jun 2006 18:46:11 -0000	1.64
***************
*** 470,473 ****
--- 470,482 ----
  
  
+       if (!setupStore->useMGAtv)
+       {
+         fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
+         videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
+ 
+         if (!setupStore->viaTv)
+           BESColorkeyState(videoLayer, true);
+       }
+ 
        if (useStretchBlit)
        {
***************
*** 485,497 ****
  
        reportSurfaceCapabilities ("videoSurface", videoSurface);
- 
-       if (!setupStore->useMGAtv)
-       {
-         fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
-         videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
- 
-         if (!setupStore->viaTv)
-           BESColorkeyState(videoLayer, true);
-       }
  
        fprintf(stderr,
--- 494,497 ----



From nobody at sheep.berlios.de  Sat Jun 17 15:43:57 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 17 Jun 2006 15:43:57 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.198,1.199
Message-ID: <200606171343.k5HDhvb12286@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17736

Modified Files:
	CHANGELOG 
Log Message:
fix via aspect ratio handling

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.198
retrieving revision 1.199
diff -C2 -d -r1.198 -r1.199
*** CHANGELOG	15 Jun 2006 21:34:20 -0000	1.198
--- CHANGELOG	17 Jun 2006 13:43:54 -0000	1.199
***************
*** 1,5 ****
  Changelog
  2006-06-15:
!    - make configure a bit more verbose. A complete log is now saved in 
       config.log.
     - fix delete <-> delete[] mismatch reported by Prakash Punnoor.
--- 1,7 ----
  Changelog
+ 2006-06-16:
+    - video-dfb: fix via aspect ratio handling
  2006-06-15:
!    - make configure a bit more verbose. A complete log is now saved in
       config.log.
     - fix delete <-> delete[] mismatch reported by Prakash Punnoor.



From nobody at sheep.berlios.de  Sat Jun 17 18:27:38 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 17 Jun 2006 18:27:38 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.199,1.200 Makefile,1.30,1.31 PicBuffer.c,1.4,1.5 PicBuffer.h,1.1,1.2 configure,1.16,1.17 mpeg2decoder.c,1.65,1.66 mpeg2decoder.h,1.37,1.38 setup-softdevice.c,1.43,1.44 setup-softdevice.h,1.30,1.31 softdevice.c,1.60,1.61 video-dfb.c,1.64,1.65 video-dfb.h,1.21,1.22
Message-ID: <200606171627.k5HGRcb20481@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7558

Modified Files:
	CHANGELOG Makefile PicBuffer.c PicBuffer.h configure 
	mpeg2decoder.c mpeg2decoder.h setup-softdevice.c 
	setup-softdevice.h softdevice.c video-dfb.c video-dfb.h 
Log Message:
cle266, video-dfb: added HW-decoder support

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.199
retrieving revision 1.200
diff -C2 -d -r1.199 -r1.200
*** CHANGELOG	17 Jun 2006 13:43:54 -0000	1.199
--- CHANGELOG	17 Jun 2006 16:27:34 -0000	1.200
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-06-17:
+    - cle266, video-dfb: added HW-decoder support
  2006-06-16:
     - video-dfb: fix via aspect ratio handling

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** Makefile	9 Jun 2006 16:45:13 -0000	1.30
--- Makefile	17 Jun 2006 16:27:34 -0000	1.31
***************
*** 149,152 ****
--- 149,158 ----
  endif
  
+ ifdef CLE266_SUPPORT
+   CLE266_LIBS = -L/usr/local/lib -lcle266mpegdec
+   CLE266_CFLAGS = -I/usr/local/include
+   DEFINES  += -DHAVE_CLE266_MPEG_DECODER
+ endif
+ 
  ifdef XV_SUPPORT
    XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
***************
*** 230,239 ****
      DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += lib$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
!     LIBS     += $(DFB_LIBS)
    endif
!   INCLUDES += $(DFB_CFLAGS)
  endif
  
--- 236,247 ----
      DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
      ALL_OBJS += $(DFB_OBJS)
+     LIBS     += $(CLE266_LIBS)
+     DFB_LIBS += $(CLE266_LIBS)
      TARGETS  += lib$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
!     LIBS     += $(DFB_LIBS) $(CLE266_LIBS)
    endif
!   INCLUDES += $(DFB_CFLAGS) $(CLE266_CFLAGS)
  endif
  

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** PicBuffer.c	30 May 2006 18:57:21 -0000	1.4
--- PicBuffer.c	17 Jun 2006 16:27:34 -0000	1.5
***************
*** 38,41 ****
--- 38,42 ----
  };   
  
+ /*----------------------------------------------------------------------*/
  cPicBufferManager::cPicBufferManager() {
    lastPicNum=0;
***************
*** 48,51 ****
--- 49,63 ----
  };
  
+ int cPicBufferManager::GetBufNum(sPicBuffer *buf) {  
+         if ( !buf || buf->owner!=this )
+                 return -1;
+ 
+         int buf_num=0;
+         while ( buf != &PicBuffer[buf_num]  && buf_num < LAST_PICBUF )
+                 buf_num++;
+ 
+         return (buf_num < LAST_PICBUF ? buf_num : -1);
+ };
+ 
  void cPicBufferManager::ReleasePicBuffer(int buf_num) {
          PICDEB("ReleasePicBuffer %d\n",buf_num);
***************
*** 245,248 ****
--- 257,262 ----
  // end of code based on ffmpeg
  
+ 
+ /*------------------------------------------------------------------------*/
  void CopyPicBuf(sPicBuffer *dst, sPicBuffer *src,
                  int width, int height,
***************
*** 284,287 ****
--- 298,302 ----
  };
  
+ /*------------------------------------------------------------------------*/
  void CopyPicBufAlphaBlend(sPicBuffer *dst, sPicBuffer *src,
                  uint8_t *OsdPy,

Index: PicBuffer.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** PicBuffer.h	27 May 2006 19:12:41 -0000	1.1
--- PicBuffer.h	17 Jun 2006 16:27:34 -0000	1.2
***************
*** 27,35 ****
      uint8_t *pixel[4];
      int stride[4];
!     unsigned int use_count;
      int buf_num;
      int max_width; // maximal size of the picture edge + picture
      int max_height;
      
      int edge_width; // size of edges (needed by some ffmpeg codecs)
      int edge_height;
--- 27,37 ----
      uint8_t *pixel[4];
      int stride[4];
!     unsigned int use_count; // count the users of this buffer
      int buf_num;
      int max_width; // maximal size of the picture edge + picture
      int max_height;
+     cPicBufferManager *owner;
      
+     // picture context
      int edge_width; // size of edges (needed by some ffmpeg codecs)
      int edge_height;
***************
*** 41,49 ****
      bool interlaced_frame;
      int pict_type;
-    
-     cPicBufferManager *owner;
   
!     int pic_num;
!     int age;
      void *priv_data;
  };
--- 43,49 ----
      bool interlaced_frame;
      int pict_type;
   
!     int pic_num; // to calculate the age
!     int age; // needed by ffmpeg
      void *priv_data;
  };
***************
*** 54,61 ****
  class cPicBufferManager {
  public:
-         cPicBufferManager();
- 
-         virtual ~cPicBufferManager();
-       
          int lastPicNum;
  #define LAST_PICBUF 10
--- 54,57 ----
***************
*** 63,71 ****
--- 59,84 ----
          cMutex PicBufMutex;
  
+         cPicBufferManager();
+ 
+         virtual ~cPicBufferManager();
+ 
+         inline sPicBuffer *PicBuf(unsigned int buf_num)
+         { return ( buf_num<LAST_PICBUF ? &PicBuffer[buf_num] : NULL); };
+         // returns the address of the buffer buf_num
+         
+         int GetBufNum(sPicBuffer *PicBuf);
+         // returns the buffer number of the picture buffer PicBuf
+         // returns -1 if the buffer has not been found
+  
          sPicBuffer *GetBuffer(PixelFormat pix_fmt,int width, int height);
+         // get a picture buffer ( to be called from decoders of filters )
          void ReleaseBuffer(sPicBuffer *pic);
+         // release it again ( after use )
  
          void LockBuffer(sPicBuffer *picture);
+         // I want to keep this buffer ( not requested by me via GetBuffer() ) 
+         // longer
          void UnlockBuffer(sPicBuffer *picture);
+         // don't need it anymore
          
          int GetFormatBPP(PixelFormat fmt);
***************
*** 73,80 ****
                  int &hChromaShift,
                  int &vChromaShift);
!         virtual void ReleasePicBuffer(int buf_num);
          virtual void AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                          int w, int h);
! 
  };
  
--- 86,98 ----
                  int &hChromaShift,
                  int &vChromaShift);
! 
          virtual void AllocPicBuffer(int buf_num,PixelFormat pix_fmt,
                          int w, int h);
!         // actually allocates memory for the buffer. Can be overloaded for 
!         // direct rendering. 
!         // Has to set up max_width/max_height and format!
!         
!         virtual void ReleasePicBuffer(int buf_num);
!         // releases the memory of the buffer again
  };
  

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** configure	15 Jun 2006 21:27:08 -0000	1.16
--- configure	17 Jun 2006 16:27:34 -0000	1.17
***************
*** 36,39 ****
--- 36,40 ----
  with_mmx="yes"
  with_mmx2="yes"
+ cle266="yes"
  
  function help () {
***************
*** 114,119 ****
  pkg-config --libs libpostproc >> config.log 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
! ffmpeg_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --libs $ffmpeg_l1 2>> config.log` || ffmpeg="no"
! ffmpeg_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --cflags $ffmpeg_l1 2>> config.log`
  
  # test if it works..
--- 115,120 ----
  pkg-config --libs libpostproc >> config.log 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
! ffmpeg_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs $ffmpeg_l1 2>> config.log` || ffmpeg="no"
! ffmpeg_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags $ffmpeg_l1 2>> config.log`
  
  # test if it works..
***************
*** 155,164 ****
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --cflags directfb dfb++ ` || dfb="no"
  #dfb_cflags=`pkg-config --cflags directfb dfb++ 2>> config.log` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
  
! dfb_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH; pkg-config --libs directfb dfb++`
  dfb_opts="${dfb_cflags} ${dfb_libs}"
  dfb_device_desc="yes"
--- 156,165 ----
  if test "${dfb}" = "yes" ; then
  
! dfb_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags directfb dfb++ 2>> config.log`|| dfb="no"
  #dfb_cflags=`pkg-config --cflags directfb dfb++ 2>> config.log` || dfb="no"
  
  if test "${dfb}" = "yes" ; then
  
! dfb_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs directfb dfb++ 2>> config.log`
  dfb_opts="${dfb_cflags} ${dfb_libs}"
  dfb_device_desc="yes"
***************
*** 267,270 ****
--- 268,292 ----
  
  #########################################################
+ # cle266mpegdec: check if present
+ #
+ if test "${dfb}" = "yes" ; then
+ echo -n "Checking for cle266mpegdec... "
+ cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags cle266mpegdec 2>>config.log` || cle266="no"
+   if test "${cle266}" = "yes" ; then
+   cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs cle266mpegdec`
+   cle266_opts="${cle266_cflags} ${cle266_libs}"
+   fi
+ 
+   if test "${cle266}" = "yes" ; then
+   echo "Enabled cle266 hardware decoding."
+   else
+   echo "Not found."
+ 
+ fi
+ else
+   cle266="no"
+ fi
+ 
+ #########################################################
  # X11: check if X11 is present
  #
***************
*** 424,427 ****
--- 446,457 ----
      echo "#define HAVE_DSBLIT_INTERLACED          0" >> $TMPH
    fi
+ fi
+ 
+ ###############################################################################
+ # generating DirectFB specific defines
+ #
+ if test "${cle266}" = "yes" ; then
+   echo "CLE266_LIBS = ${cle266_libs}" >> $TMPM
+   echo "CLE266_CFLAGS = -DHAVE_CLE266_MPEG_DECODER ${cle266_cflags}" >> $TMPM
  fi
  

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.65
retrieving revision 1.66
diff -C2 -d -r1.65 -r1.66
*** mpeg2decoder.c	15 Jun 2006 21:34:20 -0000	1.65
--- mpeg2decoder.c	17 Jun 2006 16:27:34 -0000	1.66
***************
*** 17,20 ****
--- 17,23 ----
  #include "setup-softdevice.h"
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ #include <cle266mpegdec.h>
+ #endif // HAVE_CLE266_MPEG_DECODER
  
  //#define MPGDEB(out...) {printf("mpegdec[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
***************
*** 718,721 ****
--- 721,726 ----
  #if LIBAVCODEC_BUILD > 4684
    pic->interlaced_frame=picture->interlaced_frame;
+ #else
+   pic->interlaced_frame=true;
  #endif
    pic->width=context->width;
***************
*** 752,755 ****
--- 757,805 ----
  };
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
+ 
+ int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic, 
+                 int &got_picture,uint8_t *data, int length, int64_t pkt_pts) {
+   int cle266CurrentFB;
+   got_picture=0;
+   pic = NULL;
+ 
+   /* Do HW decode!
+    * Hopefully sets len to number of bytes decoded!
+    * Returns number of buffer containing decoded frame
+    */
+   cle266CurrentFB = CLE266MPEGDecodeData(data, &length, &pkt_pts);
+ 
+   if ( cle266CurrentFB == -1 ) 
+     // no new picture
+     return length;
+ 
+   got_picture = 1;
+   pic = videoOut->PicBuf(cle266CurrentFB);
+   if ( pic == NULL ) {
+     fprintf(stderr,"No picture buffer returned from cle266! %d\n",
+         cle266CurrentFB);
+     fflush(stderr);
+     got_picture = 0;
+     return length;
+   };
+ 
+   cle266_decoder_state_t decoder = CLE266MPEGGetDecoderState();
+   /* Fill up the necessary AVCodecContext information */
+   pic->width = decoder.width;
+   pic->height = decoder.height;
+   pic->pts = pkt_pts;
+   pic->edge_width=pic->edge_height=0;
+   pic->dtg_active_format = 0; // currently not parsed
+   pic->interlaced_frame = true; // FIXME Do we have that information?
+   pic->aspect_ratio = ( decoder.aspect_ratio_info >= 0 
+     && decoder.aspect_ratio_info < 5 ) ?
+     aspect_ratio_values[decoder.aspect_ratio_info] : 1.0;
+ 
+   return length;
+ }
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
  int cVideoStreamDecoder::DecodePacket(AVPacket *pkt)
  {
***************
*** 764,769 ****
      BUFDEB("start decode video stream %d data: %p size: %d \n",
          pkt->stream_index,data,size);
!     len = DecodePicture_avcodec(pic, got_picture,
!                                 data, size, pkt->pts)
        //avcodec_decode_video(context, picture, &got_picture,data, size);
      BUFDEB("end decode video got_picture %d, data %p, size %d\n",
--- 814,825 ----
      BUFDEB("start decode video stream %d data: %p size: %d \n",
          pkt->stream_index,data,size);
! #ifdef HAVE_CLE266_MPEG_DECODER
!     if (setupStore.cle266HWdecode && context->codec_id == CODEC_ID_MPEG2VIDEO)
!             len = DecodePicture_cle266(pic, got_picture,
!                                 data, size, pkt->pts);
!     else
! #endif //HAVE_CLE266_MPEG_DECODER
!             len = DecodePicture_avcodec(pic, got_picture,
!                                 data, size, pkt->pts);
        //avcodec_decode_video(context, picture, &got_picture,data, size);
      BUFDEB("end decode video got_picture %d, data %p, size %d\n",

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** mpeg2decoder.h	27 May 2006 19:12:41 -0000	1.37
--- mpeg2decoder.h	17 Jun 2006 16:27:35 -0000	1.38
***************
*** 253,256 ****
--- 253,260 ----
      int DecodePicture_avcodec(sPicBuffer *&pic, int &got_picture,
                                uint8_t *data, int length, int64_t pts);
+ #ifdef HAVE_CLE266_MPEG_DECODER
+     int DecodePicture_cle266(sPicBuffer *&pic, int &got_picture,
+                               uint8_t *data, int length, int64_t pts);
+ #endif //HAVE_CLE266_MPEG_DECODER
      virtual void      Freeze(bool freeze=true);
      virtual void      Play(void);

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** setup-softdevice.c	23 May 2006 21:11:37 -0000	1.43
--- setup-softdevice.c	17 Jun 2006 16:27:35 -0000	1.44
***************
*** 110,113 ****
--- 110,114 ----
    useMGAtv      = 0;
    viaTv         = 0;
+   cle266HWdecode  = 0;
    tripleBuffering = 0;
    useStretchBlit  = 0;

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** setup-softdevice.h	23 May 2006 21:11:37 -0000	1.30
--- setup-softdevice.h	17 Jun 2006 16:27:35 -0000	1.31
***************
*** 149,152 ****
--- 149,153 ----
      int   useMGAtv;
      int   viaTv;
+     int   cle266HWdecode;
      int   tripleBuffering;
      int   useStretchBlit;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.60
retrieving revision 1.61
diff -C2 -d -r1.60 -r1.61
*** softdevice.c	9 Jun 2006 16:45:13 -0000	1.60
--- softdevice.c	17 Jun 2006 16:27:35 -0000	1.61
***************
*** 705,708 ****
--- 705,711 ----
    "  -vo dfb:mgatv                   output via MATROX TV-out\n"
    "  -vo dfb:viatv                   output via Unichrome TV-out\n"
+ #ifdef HAVE_CLE266_MPEG_DECODER
+   "  -vo dfb:cle266                  output via CLE266 accelerated decoding\n"
+ #endif
    "  -vo dfb:triple                  enables triple buffering on back end scaler\n"
  #endif
***************
*** 801,812 ****
  #ifdef DFB_SUPPORT
            voutMethod = VOUT_DFB;
!           if (!strncmp (vo_argv, "mgatv", 5))
!             setupStore.useMGAtv = 1;
!           else if (!strncmp (vo_argv, "viatv", 5)) {
!             setupStore.viaTv = 1;
!             fprintf(stderr,"[softdevice] enabling field parity\n");
!           } else if (!strncmp (vo_argv, "triple", 6)) {
!             setupStore.tripleBuffering = 1;
!             fprintf(stderr,"[softdevice] enabling triple buffering\n");
            }
  #else
--- 804,829 ----
  #ifdef DFB_SUPPORT
            voutMethod = VOUT_DFB;
!           while (strlen(vo_argv) > 1) {
!             if (*vo_argv == ':')
!                ++vo_argv;
! 
!             if (!strncmp (vo_argv, "mgatv", 5)) {
!               setupStore.useMGAtv = 1;
!               vo_argv += 5;
!             } else if (!strncmp (vo_argv, "viatv", 5)) {
!               setupStore.viaTv = 1;
!               fprintf(stderr,"[softdevice] enabling field parity\n");
!               vo_argv += 5;
! #ifdef HAVE_CLE266_MPEG_DECODER
!             } else if (!strncmp (vo_argv, "cle266", 6)) {
!               setupStore.cle266HWdecode = 1;
!               vo_argv += 6;
!               fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
! #endif // HAVE_CLE266_MPEG_DECODER
!             } else if (!strncmp (vo_argv, "triple", 6)) {
!               setupStore.tripleBuffering = 1;
!               vo_argv += 6;
!               fprintf(stderr,"[softdevice] enabling triple buffering\n");
!             }
            }
  #else

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.64
retrieving revision 1.65
diff -C2 -d -r1.64 -r1.65
*** video-dfb.c	16 Jun 2006 18:46:11 -0000	1.64
--- video-dfb.c	17 Jun 2006 16:27:35 -0000	1.65
***************
*** 15,19 ****
  #include "setup-softdevice.h"
  
- 
  #ifdef HAVE_CONFIG
  # include "config.h"
--- 15,18 ----
***************
*** 35,38 ****
--- 34,41 ----
  #endif
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ #include <cle266mpegdec.h>
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
  //#define COLORKEY 17,8,79
  #define COLORKEY 0,0,0
***************
*** 48,51 ****
--- 51,58 ----
       }
  
+ #define OLD_VERSION_01  1
+ #define OLD_VERSION_02  1
+ #define OLD_VERSION_03  1
+ 
  typedef struct
  {
***************
*** 361,364 ****
--- 368,386 ----
        isVIAUnichrome = true;
        clearAlpha = 0xff;
+ #ifdef HAVE_CLE266_MPEG_DECODER
+       if (setupStore->cle266HWdecode) {
+           if (!SetupCle266Buffers(swidth, sheight)) {
+               fprintf(stderr, "Error allocating hardware buffers for CLE266 decoding: reverting to software decoding\n");
+               setupStore->cle266HWdecode = false;
+           } else {
+               // Need YV12 pixel format for blitting from harware buffer
+               // I420 == 0, YV12 == 1, YUY2 == 2
+               //currentPixelFormat = setupStore->pixelFormat = 0;
+               currentPixelFormat = setupStore->pixelFormat = 1;
+               setupStore->useStretchBlit = 0;
+               useStretchBlit = false;
+           }
+       }
+ #endif // HAVE_CLE266_MPEG_DECODER
  
        ReportLayerInfo(osdLayer, "osdLayer");
***************
*** 475,479 ****
--- 497,505 ----
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
+ #if OLD_VERSION_01
          if (!setupStore->viaTv)
+ #else
+         if (!isVIAUnichrome)
+ #endif
            BESColorkeyState(videoLayer, true);
        }
***************
*** 502,506 ****
      }
  
!     GetDisplayFrameTime();
      /* create an event buffer with all devices attached */
      events = dfb->CreateInputEventBuffer(DICAPS_ALL,
--- 528,537 ----
      }
  
! #if OLD_VERSION_02
!     ;
! #else
!     if (setupStore->useMGAtv)
! #endif
!       GetDisplayFrameTime();
      /* create an event buffer with all devices attached */
      events = dfb->CreateInputEventBuffer(DICAPS_ALL,
***************
*** 1312,1397 ****
    try
    {
!     videoSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch);
!     if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
!     {
  #if HAVE_SetSourceLocation
!       Py += Ystride  * cutTop * 2 + cutLeft * 2;
!       Pv += UVstride * cutTop + cutLeft;
!       Pu += UVstride * cutTop + cutLeft;
  
!       dst += pitch * cutTop * 2;
  
!       for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!         fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
!         Py  += Ystride;
!         dst += pitch;
!       }
  
!       dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!         fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
!         Pu  += UVstride;
!         dst += pitch / 2;
!       }
  
!       dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!         fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
!         Pv  += UVstride;
!         dst += pitch / 2;
!       }
  #else
!       Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
!       Pv += (UVstride * syoff/2) + UVstride * cutTop;
!       Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!       dst += pitch * cutTop * 2;
  
!       for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!         fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
!         Py  += Ystride;
!         dst += pitch;
!       }
  
!       dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!         fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!         Pu  += UVstride;
!         dst += pitch / 2;
!       }
  
!       dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!       for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!         fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!         Pv  += UVstride;
!         dst += pitch / 2;
!       }
  #endif
!     } else if (pixelformat == DSPF_YUY2) {
  
!       if (interlaceMode) {
!         yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                              Pu + UVstride * cutTop + cutLeft,
!                              Pv + UVstride * cutTop + cutLeft,
!                              dst + pitch * cutTop * 2 + cutLeft * 4,
!                              Width - 2 * (cutLeft + cutRight),
!                              Height - 2 * (cutTop + cutBottom),
!                              Ystride, UVstride, pitch);
!       } else {
!         yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                              Pu + UVstride * cutTop + cutLeft,
!                              Pv + UVstride * cutTop + cutLeft,
!                              dst + pitch * cutTop * 2 + cutLeft * 4,
!                              Width - 2 * (cutLeft + cutRight),
!                              Height - 2 * (cutTop + cutBottom),
!                              Ystride, UVstride, pitch);
        }
!      }
  
!     videoSurface->Unlock();
  
      if (useStretchBlit)
--- 1343,1443 ----
    try
    {
! #ifdef HAVE_CLE266_MPEG_DECODER
!     int currentFB = -1;
!     if (setupStore->cle266HWdecode) {
!       // check if we use internal buffers
!       currentFB=GetBufNum(buf);
!     }
! 
!     if (setupStore->cle266HWdecode && currentFB < 4 && currentFB >= 0) {
!       // we use an internal buffer and CLE266 HW decoding
!       videoSurface->Blit(mpegfb[currentFB], NULL, 0, 0);
!     } else {
! #endif // HAVE_CLE266_MPEG_DECODER
!       videoSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch);
!       if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
!       {
  #if HAVE_SetSourceLocation
!         Py += Ystride  * cutTop * 2 + cutLeft * 2;
!         Pv += UVstride * cutTop + cutLeft;
!         Pu += UVstride * cutTop + cutLeft;
  
!         dst += pitch * cutTop * 2;
  
!         for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!           fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
!           Py  += Ystride;
!           dst += pitch;
!         }
  
!         dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!           fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
!           Pu  += UVstride;
!           dst += pitch / 2;
!         }
  
!         dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!           fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
!           Pv  += UVstride;
!           dst += pitch / 2;
!         }
  #else
!         Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
!         Pv += (UVstride * syoff/2) + UVstride * cutTop;
!         Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!         dst += pitch * cutTop * 2;
  
!         for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!           fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
!           Py  += Ystride;
!           dst += pitch;
!         }
  
!         dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!           fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!           Pu  += UVstride;
!           dst += pitch / 2;
!         }
  
!         dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!           fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!           Pv  += UVstride;
!           dst += pitch / 2;
!         }
  #endif
!       } else if (pixelformat == DSPF_YUY2) {
  
!         if (interlaceMode) {
!           yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                dst + pitch * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, pitch);
!         } else {
!           yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                                Pu + UVstride * cutTop + cutLeft,
!                                Pv + UVstride * cutTop + cutLeft,
!                                dst + pitch * cutTop * 2 + cutLeft * 4,
!                                Width - 2 * (cutLeft + cutRight),
!                                Height - 2 * (cutTop + cutBottom),
!                                Ystride, UVstride, pitch);
!         }
        }
!       videoSurface->Unlock();
  
! #ifdef HAVE_CLE266_MPEG_DECODER
!     }
! #endif // HAVE_CLE266_MPEG_DECODER
  
      if (useStretchBlit)
***************
*** 1455,1460 ****
  
        }
!       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
  
      }
--- 1501,1509 ----
  
        }
! #if OLD_VERSION_03
        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
+ #else
+       scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+ #endif
  
      }
***************
*** 1475,1478 ****
--- 1524,1615 ----
  }
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+ 
+ bool cDFBVideoOut::SetupCle266Buffers(int width, int height)
+ {
+   DFBSurfaceDescription dsc;
+   int *buf;
+   int y_offset, u_offset, v_offset, i;
+   int mpegfb_stride;
+ 
+   fprintf(stderr, "Initialising CLE266 decoder:");
+   if (!CLE266MPEGInitialise(FBDEV)) {
+       fprintf(stderr, "failed!\n");
+       return false;
+   } else {
+       fprintf(stderr, "success!\n");
+   }
+ 
+   dsc.flags = (DFBSurfaceDescriptionFlags)(DSDESC_WIDTH |
+                 DSDESC_HEIGHT |
+                 DSDESC_PIXELFORMAT |
+                 DSDESC_CAPS);
+   dsc.caps = DSCAPS_VIDEOONLY;
+   //dsc.pixelformat = DSPF_I420;
+   dsc.pixelformat = DSPF_YV12;
+   dsc.width = width;
+   dsc.height = height;
+ 
+ /* Create the 4 MPEG buffers for decoding */
+   fprintf(stderr, "CLE266: Creating buffers for decoder\n");
+   for (int j=0; j < LAST_PICBUF; j++)
+           mpegfb[j]=NULL;
+ 
+   try {
+     for (i = 0; i < 4; i++) {
+       fprintf(stderr, "CLE266: Creating buffer number %i\n", i);
+       mpegfb[i] = dfb->CreateSurface(dsc);
+ 
+       mpegfb[i]->Clear(0,0,0,0);
+       mpegfb[i]->Lock(DSLF_WRITE, (void**) &buf, &mpegfb_stride);
+       mpegfb[i]->GetFramebufferOffset(&mpegfb_ofs[i]);
+ 
+       if ( PicBuffer[i].use_count>0 ||
+            PicBuffer[i].max_width>0 || PicBuffer[i].max_height>0) {
+               esyslog("Fatal error setting up CLE266 buffers!");
+               fprintf(stderr,"Fatal error setting up CLE266 buffers!\n");
+               exit(-1);
+       };
+ 
+       // at this point I know that the buffer is not already allocated
+       PicBuffer[i].pixel[0] = (uint8_t*) buf;
+       PicBuffer[i].pixel[2] = (uint8_t*) buf + height * mpegfb_stride;
+       PicBuffer[i].pixel[1] = (uint8_t*) PicBuffer[i].pixel[2]
+                                          +(height>>1)*(mpegfb_stride>>1);
+       PicBuffer[i].stride[0] = mpegfb_stride;
+       PicBuffer[i].stride[1] = PicBuffer[i].stride[2] = mpegfb_stride>>1;
+       PicBuffer[i].format = PIX_FMT_YUV420P;
+       PicBuffer[i].owner = this;
+       PicBuffer[i].max_width = width;
+       PicBuffer[i].max_height = height;
+       PicBuffer[i].use_count = 2; // should never be freed!!!
+     }
+   }
+   catch (DFBException *ex)
+   {
+     fprintf(stderr, "CLE266: Error creating buffer: action=%s, result=%s\n",
+                   ex->GetAction(), ex->GetResult());
+     delete ex;
+     return false;
+   }
+ 
+   /* Pass info to the decoder...*/
+   fprintf(stderr, "CLE266: passing mpegfb_stride\n");
+   CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride >> 1 );
+ 
+   height = (height + 15) & ~15;
+   width  = (width  + 15) & ~15;
+ 
+   fprintf(stderr, "CLE266: passing buffers to decoder\n");
+   for (i = 0; i < 4; i++) {
+     y_offset = mpegfb_ofs[i];
+     v_offset = y_offset + (mpegfb_stride * height);
+     u_offset = v_offset + (mpegfb_stride >> 1) * (height >> 1);
+     CLE266MPEGSetFrameBuffer(i,y_offset,v_offset,u_offset);
+   }
+   return true;
+ }
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 1488,1491 ****
--- 1625,1641 ----
    if (videoLayer)   videoLayer->Release ();
    if (osdLayer)     osdLayer->Release();
+ 
+ #ifdef HAVE_CLE266_MPEG_DECODER
+   if (setupStore->cle266HWdecode) {
+     CLE266MPEGClose();
+     for (int i = 0; i < 4; ++i) {
+       if (mpegfb[i]) {
+         mpegfb[i]->Unlock();
+         mpegfb[i]->Release();
+       }
+     }
+   }
+ #endif // HAVE_CLE266_MPEG_DECODER
+ 
    if (dfb)          dfb->Release();
  }

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** video-dfb.h	27 May 2006 19:12:41 -0000	1.21
--- video-dfb.h	17 Jun 2006 16:27:35 -0000	1.22
***************
*** 51,54 ****
--- 51,59 ----
      void EnableFieldParity(IDirectFBDisplayLayer *layer);
  
+ #ifdef HAVE_CLE266_MPEG_DECODER
+     IDirectFBSurface* mpegfb[LAST_PICBUF];
+     int               mpegfb_ofs[4];
+     bool SetupCle266Buffers(int, int);
+ #endif // HAVE_CLE266_MPEG_DECODER
    public:
      IDirectFB	*dfb;



From nobody at sheep.berlios.de  Sat Jun 17 21:19:41 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 17 Jun 2006 21:19:41 +0200
Subject: [Softdevice-cvs] softdevice configure,1.17,1.18
Message-ID: <200606171919.k5HJJfb29466@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28443

Modified Files:
	configure 
Log Message:
check for libcle266mpegdec instead of cle266mpegdec

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** configure	17 Jun 2006 16:27:34 -0000	1.17
--- configure	17 Jun 2006 19:19:38 -0000	1.18
***************
*** 55,59 ****
  
  echo "Parameters '$@'" >config.log
! echo "PKG_CONFIG_PATH '$PKG_CONFIG_PATH'" >> config.log 
  
  while [ $# -gt 0 ]
--- 55,59 ----
  
  echo "Parameters '$@'" >config.log
! echo "PKG_CONFIG_PATH '$PKG_CONFIG_PATH'" >> config.log
  
  while [ $# -gt 0 ]
***************
*** 87,91 ****
  echo  "Checking for ffmpeg.------------------------------------" >> config.log
  
! test_ffmpeg() 
  {
    ffmpeg="yes";
--- 87,91 ----
  echo  "Checking for ffmpeg.------------------------------------" >> config.log
  
! test_ffmpeg()
  {
    ffmpeg="yes";
***************
*** 135,139 ****
  
      test_ffmpeg
!   fi    
  
    if test "${ffmpeg}" = "no" ; then
--- 135,139 ----
  
      test_ffmpeg
!   fi
  
    if test "${ffmpeg}" = "no" ; then
***************
*** 271,287 ****
  #
  if test "${dfb}" = "yes" ; then
! echo -n "Checking for cle266mpegdec... "
! cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags cle266mpegdec 2>>config.log` || cle266="no"
    if test "${cle266}" = "yes" ; then
!   cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs cle266mpegdec`
!   cle266_opts="${cle266_cflags} ${cle266_libs}"
    fi
  
    if test "${cle266}" = "yes" ; then
!   echo "Enabled cle266 hardware decoding."
    else
!   echo "Not found."
! 
! fi
  else
    cle266="no"
--- 271,286 ----
  #
  if test "${dfb}" = "yes" ; then
!   echo -n "Checking for libcle266mpegdec ... "
!   cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec 2>>config.log` || cle266="no"
    if test "${cle266}" = "yes" ; then
!     cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
!     cle266_opts="${cle266_cflags} ${cle266_libs}"
    fi
  
    if test "${cle266}" = "yes" ; then
!     echo "Enabled cle266 hardware decoding."
    else
!     echo "Not found."
!   fi
  else
    cle266="no"



From nobody at sheep.berlios.de  Sat Jun 17 22:43:01 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 17 Jun 2006 22:43:01 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.200,1.201 utils.c,1.15,1.16 utils.h,1.9,1.10 video-dfb.c,1.65,1.66 video-fb.c,1.15,1.16 video-vidix.c,1.20,1.21
Message-ID: <200606172043.k5HKh1b32082@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv144

Modified Files:
	CHANGELOG utils.c utils.h video-dfb.c video-fb.c video-vidix.c 
Log Message:
get frame buffer name at runtime:
 1. via enviroment variable FRAMEBUFFER
 2. try /dev/fb0 or /dev/fb/0



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.200
retrieving revision 1.201
diff -C2 -d -r1.200 -r1.201
*** CHANGELOG	17 Jun 2006 16:27:34 -0000	1.200
--- CHANGELOG	17 Jun 2006 20:42:58 -0000	1.201
***************
*** 2,5 ****
--- 2,9 ----
  2006-06-17:
     - cle266, video-dfb: added HW-decoder support
+    - configure: check for libcle266mpegdec instead of cle266mpegdec
+    - get frame buffer name at runtime:
+      1. via enviroment variable FRAMEBUFFER
+      2. try /dev/fb0 or /dev/fb/0
  2006-06-16:
     - video-dfb: fix via aspect ratio handling

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** utils.c	6 Jun 2006 20:55:19 -0000	1.15
--- utils.c	17 Jun 2006 20:42:58 -0000	1.16
***************
*** 17,21 ****
--- 17,24 ----
   * Author: Olie Lho <ollie at sis.com.tw>
  */
+ #include <unistd.h>
  #include <stdlib.h>
+ #include <fcntl.h>
+ #include <string.h>
  
  #include "utils.h"
***************
*** 708,711 ****
--- 711,741 ----
      gettimeofday(&tv,NULL);
      return (int64_t)tv.tv_sec * 1000 + tv.tv_usec / 1000;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ char *getFBName(void)
+ {
+     int   fd;
+ 
+   if (getenv ("FRAMEBUFFER") && *getenv ("FRAMEBUFFER") != '\0') {
+     fd = open (getenv ("FRAMEBUFFER"), O_RDWR);
+     if (fd >= 0) {
+       close (fd);
+       return (strdup (getenv ("FRAMEBUFFER")));
+     }
+   }
+ 
+   if ((fd = open ("/dev/fb0", O_RDWR)) >= 0) {
+     close (fd);
+     return (strdup ("/dev/fb0"));
+   }
+ 
+   if ((fd = open ("/dev/fb/0", O_RDWR)) >= 0) {
+     close (fd);
+     return (strdup ("/dev/fb/0"));
+   }
+ 
+   return NULL;
  }
  

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** utils.h	6 Jun 2006 20:55:19 -0000	1.9
--- utils.h	17 Jun 2006 20:42:58 -0000	1.10
***************
*** 45,51 ****
  #else
  //#warning Using MMX extensions
! #define PREFETCH(x) 
  #define MOVNTQ   "movq "
! #define SFENCE  
  #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
  #endif
--- 45,51 ----
  #else
  //#warning Using MMX extensions
! #define PREFETCH(x)
  #define MOVNTQ   "movq "
! #define SFENCE
  #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
  #endif
***************
*** 106,110 ****
     // performes alpha blending in software
  
! uint64_t getTimeMilis(void);
  
  void mmx_unpack_16rgb (uint8_t * image, int lines, int stride);
--- 106,111 ----
     // performes alpha blending in software
  
! uint64_t  getTimeMilis(void);
! char      *getFBName(void);
  
  void mmx_unpack_16rgb (uint8_t * image, int lines, int stride);

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.65
retrieving revision 1.66
diff -C2 -d -r1.65 -r1.66
*** video-dfb.c	17 Jun 2006 16:27:35 -0000	1.65
--- video-dfb.c	17 Jun 2006 20:42:58 -0000	1.66
***************
*** 1532,1541 ****
    int y_offset, u_offset, v_offset, i;
    int mpegfb_stride;
  
!   fprintf(stderr, "Initialising CLE266 decoder:");
!   if (!CLE266MPEGInitialise(FBDEV)) {
        fprintf(stderr, "failed!\n");
        return false;
    } else {
        fprintf(stderr, "success!\n");
    }
--- 1532,1544 ----
    int y_offset, u_offset, v_offset, i;
    int mpegfb_stride;
+   char *fbName = getFBName();
  
!   fprintf(stderr, "Initialising CLE266 decoder (%s): ", fbName);
!   if (!CLE266MPEGInitialise(fbName)) {
        fprintf(stderr, "failed!\n");
+       free(fbName);
        return false;
    } else {
+       free(fbName);
        fprintf(stderr, "success!\n");
    }

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video-fb.c	27 May 2006 19:12:41 -0000	1.15
--- video-fb.c	17 Jun 2006 20:42:58 -0000	1.16
***************
*** 24,33 ****
                : cVideoOut(setupStore)
  {
      printf("[video-fb] Initializing Driver\n");
  
!     if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
!         printf("[video-fb] cant open framebuffer %s\n", FBDEV);
          exit(1);
      }
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
--- 24,37 ----
                : cVideoOut(setupStore)
  {
+     char    *fbName = getFBName();
+ 
      printf("[video-fb] Initializing Driver\n");
  
!     if ((fbdev = open(fbName, O_RDWR)) == -1) {
!         printf("[video-fb] cant open framebuffer %s\n", fbName);
!         free(fbName);
          exit(1);
      }
+     free(fbName);
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
***************
*** 251,255 ****
    int Width=buf->width;
    int Height=buf->height;
!  
    if (!videoInitialized)
      return;
--- 255,259 ----
    int Width=buf->width;
    int Height=buf->height;
! 
    if (!videoInitialized)
      return;

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** video-vidix.c	9 Jun 2006 16:24:35 -0000	1.20
--- video-vidix.c	17 Jun 2006 20:42:58 -0000	1.21
***************
*** 33,41 ****
      int     err;
      double  displayRatio;
  
!     if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
          esyslog("[cVidixVideoOut] Can't open framebuffer exiting\n");
          exit(1);
      }
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
--- 33,44 ----
      int     err;
      double  displayRatio;
+     char    *fbName = getFBName();
  
!     if ((fbdev = open(fbName, O_RDWR)) == -1) {
          esyslog("[cVidixVideoOut] Can't open framebuffer exiting\n");
+         free(fbName);
          exit(1);
      }
+     free(fbName);
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {



From nobody at sheep.berlios.de  Sun Jun 18 09:12:35 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 18 Jun 2006 09:12:35 +0200
Subject: [Softdevice-cvs] softdevice .cvsignore,1.2,1.3
Message-ID: <200606180712.k5I7CZb25398@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv699

Modified Files:
	.cvsignore 
Log Message:
ignore config.log

Index: .cvsignore
===================================================================
RCS file: /cvsroot/softdevice/softdevice/.cvsignore,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** .cvsignore	29 Apr 2006 06:19:06 -0000	1.2
--- .cvsignore	18 Jun 2006 07:12:29 -0000	1.3
***************
*** 4,6 ****
--- 4,7 ----
  config.mak
  config.h
+ config.log
  ShmClient



From nobody at sheep.berlios.de  Sun Jun 18 09:16:10 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 18 Jun 2006 09:16:10 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.201,1.202 Makefile,1.31,1.32 configure,1.18,1.19
Message-ID: <200606180716.k5I7GAb25525@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2050

Modified Files:
	CHANGELOG Makefile configure 
Log Message:
removed hardcoded FBDEV name in Makefile and configure

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.201
retrieving revision 1.202
diff -C2 -d -r1.201 -r1.202
*** CHANGELOG	17 Jun 2006 20:42:58 -0000	1.201
--- CHANGELOG	18 Jun 2006 07:16:06 -0000	1.202
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-06-18:
+    - ignore config.log on commit checks
+    - removed hardcoded FBDEV name in Makefile and configure
  2006-06-17:
     - cle266, video-dfb: added HW-decoder support

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** Makefile	17 Jun 2006 16:27:34 -0000	1.31
--- Makefile	18 Jun 2006 07:16:06 -0000	1.32
***************
*** 37,49 ****
  ifndef WITH_CONFIGURE
  
- 
- # -----------------------------------------------------------------------------
- # framebuffer device name
- #
- #FBDEV = /dev/fb/0
- #FBDEV = /dev/fb0
- 
- FBDEV = /dev/fb0
- 
  # uncomment ONE of these lines if you want to enable the support
  
--- 37,40 ----
***************
*** 164,168 ****
  
  ifdef FB_SUPPORT
!   DEFINES += -DFB_SUPPORT -DFBDEV=\"$(FBDEV)\"
  endif
  
--- 155,159 ----
  
  ifdef FB_SUPPORT
!   DEFINES += -DFB_SUPPORT
  endif
  
***************
*** 180,184 ****
    VIDIX_LIBS  = -L$(VIDIX_DIR)/lib -lvidix
    VIDIX_CFLAGS = -I$(VIDIX_DIR)/include/vidix
!   DEFINES     += -DVIDIX_SUPPORT -DVIDIX_DIR=\"$(VIDIX_DIR)/lib/vidix/\" -DFBDEV=\"$(FBDEV)\"
  endif
  
--- 171,175 ----
    VIDIX_LIBS  = -L$(VIDIX_DIR)/lib -lvidix
    VIDIX_CFLAGS = -I$(VIDIX_DIR)/include/vidix
!   DEFINES     += -DVIDIX_SUPPORT -DVIDIX_DIR=\"$(VIDIX_DIR)/lib/vidix/\"
  endif
  

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** configure	17 Jun 2006 19:19:38 -0000	1.18
--- configure	18 Jun 2006 07:16:06 -0000	1.19
***************
*** 32,36 ****
  ffmpeg_path="/usr/local/include/ffmpeg"
  with_fb="yes"
- fb_dev_name="/dev/fb0"
  with_subplugins="yes"
  with_mmx="yes"
--- 32,35 ----
***************
*** 465,469 ****
    echo "#define VIDIX_SUPPORT 1" >> $TMPH
    echo "#define VIDIX_DIR     \"${vidix_path}/lib/vidix/\"" >> $TMPH
-   echo "#define FBDEV         \"${fb_dev_name}\"" >> $TMPH
  fi
  
--- 464,467 ----
***************
*** 493,499 ****
    echo "FB_SUPPORT = 1" >> $TMPM
    echo "#define FB_SUPPORT  1" >> $TMPH
-   echo "#ifndef FBDEV" >> $TMPH
-   echo "# define FBDEV      \"${fb_dev_name}\"" >> $TMPH
-   echo "#endif" >> $TMPH
  fi
  
--- 491,494 ----



From nobody at sheep.berlios.de  Wed Jun 21 19:07:25 2006
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 21 Jun 2006 19:07:25 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.202,1.203 video-dfb.c,1.66,1.67
Message-ID: <200606211707.k5LH7Pb28793@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24850

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
video-dfb: changed pixel format for HW-decoding to I420. So accelerated and
unaccelerated modes use the same pixel format.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.202
retrieving revision 1.203
diff -C2 -d -r1.202 -r1.203
*** CHANGELOG	18 Jun 2006 07:16:06 -0000	1.202
--- CHANGELOG	21 Jun 2006 17:07:19 -0000	1.203
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-06-21:
+    - video-dfb: changed pixel format for HW-decoding to I420. So accelerated and
+      unaccelerated modes use the same pixel format.
  2006-06-18:
     - ignore config.log on commit checks

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.66
retrieving revision 1.67
diff -C2 -d -r1.66 -r1.67
*** video-dfb.c	17 Jun 2006 20:42:58 -0000	1.66
--- video-dfb.c	21 Jun 2006 17:07:19 -0000	1.67
***************
*** 376,381 ****
                // Need YV12 pixel format for blitting from harware buffer
                // I420 == 0, YV12 == 1, YUY2 == 2
!               //currentPixelFormat = setupStore->pixelFormat = 0;
!               currentPixelFormat = setupStore->pixelFormat = 1;
                setupStore->useStretchBlit = 0;
                useStretchBlit = false;
--- 376,381 ----
                // Need YV12 pixel format for blitting from harware buffer
                // I420 == 0, YV12 == 1, YUY2 == 2
!               currentPixelFormat = setupStore->pixelFormat = 0;
!               //currentPixelFormat = setupStore->pixelFormat = 1;
                setupStore->useStretchBlit = 0;
                useStretchBlit = false;
***************
*** 1549,1554 ****
                  DSDESC_CAPS);
    dsc.caps = DSCAPS_VIDEOONLY;
!   //dsc.pixelformat = DSPF_I420;
!   dsc.pixelformat = DSPF_YV12;
    dsc.width = width;
    dsc.height = height;
--- 1549,1554 ----
                  DSDESC_CAPS);
    dsc.caps = DSCAPS_VIDEOONLY;
!   dsc.pixelformat = DSPF_I420;
!   //dsc.pixelformat = DSPF_YV12;
    dsc.width = width;
    dsc.height = height;
***************
*** 1609,1613 ****
      v_offset = y_offset + (mpegfb_stride * height);
      u_offset = v_offset + (mpegfb_stride >> 1) * (height >> 1);
!     CLE266MPEGSetFrameBuffer(i,y_offset,v_offset,u_offset);
    }
    return true;
--- 1609,1613 ----
      v_offset = y_offset + (mpegfb_stride * height);
      u_offset = v_offset + (mpegfb_stride >> 1) * (height >> 1);
!     CLE266MPEGSetFrameBuffer(i,y_offset,u_offset,v_offset);
    }
    return true;



From nobody at sheep.berlios.de  Sun Jun 25 15:46:14 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 25 Jun 2006 15:46:14 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.203,1.204 setup-softdevice.h,1.31,1.32 setup-softdevice.c,1.44,1.45 setup-softdevice-menu.c,1.5,1.6 video-dfb.c,1.67,1.68
Message-ID: <200606251346.k5PDkEb02445@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9105

Modified Files:
	CHANGELOG setup-softdevice.h setup-softdevice.c 
	setup-softdevice-menu.c video-dfb.c 
Log Message:
- video pixelformat and stretchblit mode can be locked by output driver, so
  that changeing them is not offered via OSD.
- video-dfb: - Adapted radeon real alphablend handling to current DirectFB-cvs.
               It is now handled similary to via mode (with underlay).
             - In mgatv-out mode, video surface is now allways allocated with
               attribute DSCAPS_INTERLACED to support interlaced stretchblit
               of DirectFB-cvs.
             - Removed test #if directives introduced in first via hw-dec support.
             - Lock pixelformat and stretchblit mode in case via hw-decode
               and mgatv mode.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.203
retrieving revision 1.204
diff -C2 -d -r1.203 -r1.204
*** CHANGELOG	21 Jun 2006 17:07:19 -0000	1.203
--- CHANGELOG	25 Jun 2006 13:46:12 -0000	1.204
***************
*** 1,3 ****
--- 1,14 ----
  Changelog
+ 2006-06-25:
+    - video pixelformat and stretchblit mode can be locked by output driver, so
+      that changeing them is not offered via OSD.
+    - video-dfb: - Adapted radeon real alphablend handling to current DirectFB-cvs.
+                   It is now handled similary to via mode (with underlay).
+                 - In mgatv-out mode, video surface is now allways allocated with
+                   attribute DSCAPS_INTERLACED to support interlaced stretchblit
+                   of DirectFB-cvs.
+                 - Removed test #if directives introduced in first via hw-dec support.
+                 - Lock pixelformat and stretchblit mode in case via hw-decode
+                   and mgatv mode.
  2006-06-21:
     - video-dfb: changed pixel format for HW-decoding to I420. So accelerated and

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** setup-softdevice.h	17 Jun 2006 16:27:35 -0000	1.31
--- setup-softdevice.h	25 Jun 2006 13:46:12 -0000	1.32
***************
*** 128,131 ****
--- 128,132 ----
      int   outputMethod;
      int   pixelFormat;
+     bool  pixelFormatLocked;
      int   cropMode;
      int   cropModeToggleKey;
***************
*** 152,155 ****
--- 153,157 ----
      int   tripleBuffering;
      int   useStretchBlit;
+     bool  stretchBlitLocked;
      int   shouldSuspend;
      int   osdMode;

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** setup-softdevice.c	17 Jun 2006 16:27:35 -0000	1.44
--- setup-softdevice.c	25 Jun 2006 13:46:12 -0000	1.45
***************
*** 112,116 ****
    cle266HWdecode  = 0;
    tripleBuffering = 0;
!   useStretchBlit  = 0;
    bufferMode      = 0;
    mainMenu  = 1;
--- 112,119 ----
    cle266HWdecode  = 0;
    tripleBuffering = 0;
!   pixelFormat       = 0;
!   pixelFormatLocked = false;
!   useStretchBlit    = 0;
!   stretchBlitLocked = false;
    bufferMode      = 0;
    mainMenu  = 1;

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** setup-softdevice-menu.c	23 May 2006 21:31:40 -0000	1.5
--- setup-softdevice-menu.c	25 Jun 2006 13:46:12 -0000	1.6
***************
*** 357,361 ****
  #endif
  
!   if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
    {
      Add(new cMenuEditStraItem(tr("Pixel Format"),
--- 357,362 ----
  #endif
  
!   if ((data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX) &&
!       !data->pixelFormatLocked)
    {
      Add(new cMenuEditStraItem(tr("Pixel Format"),
***************
*** 365,369 ****
    }
  
!   if (data->outputMethod == VOUT_DFB)
    {
      Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
--- 366,371 ----
    }
  
!   if (data->outputMethod == VOUT_DFB &&
!       !data->stretchBlitLocked)
    {
      Add(new cMenuEditBoolItem(tr("Use StretchBlit"),

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.67
retrieving revision 1.68
diff -C2 -d -r1.67 -r1.68
*** video-dfb.c	21 Jun 2006 17:07:19 -0000	1.67
--- video-dfb.c	25 Jun 2006 13:46:12 -0000	1.68
***************
*** 51,58 ****
       }
  
- #define OLD_VERSION_01  1
- #define OLD_VERSION_02  1
- #define OLD_VERSION_03  1
- 
  typedef struct
  {
--- 51,54 ----
***************
*** 337,341 ****
--- 333,339 ----
        layerInfo = &layerList [CRTC2_LAYER_NEW];
        currentPixelFormat = setupStore->pixelFormat = 2;
+       setupStore->pixelFormatLocked = true;
        setupStore->useStretchBlit = 1;
+       setupStore->stretchBlitLocked = true;
  
        if (!setupStore->screenPixelAspect)
***************
*** 377,399 ****
                // I420 == 0, YV12 == 1, YUY2 == 2
                currentPixelFormat = setupStore->pixelFormat = 0;
!               //currentPixelFormat = setupStore->pixelFormat = 1;
                setupStore->useStretchBlit = 0;
                useStretchBlit = false;
            }
        }
  #endif // HAVE_CLE266_MPEG_DECODER
  
!       ReportLayerInfo(osdLayer, "osdLayer");
!       if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL)
!       {
! 
!         fprintf(stderr, "[dfb] osdLayer has alpha channel\n");
!         osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
!         videoLayerLevel = -1;
!       }
!       else
!       {
!         fprintf(stderr, "[dfb] osdLayer without !! alpha channel\n");
!       }
      }
  
--- 375,394 ----
                // I420 == 0, YV12 == 1, YUY2 == 2
                currentPixelFormat = setupStore->pixelFormat = 0;
!               setupStore->pixelFormatLocked = true;
                setupStore->useStretchBlit = 0;
+               setupStore->stretchBlitLocked = true;
                useStretchBlit = false;
            }
        }
  #endif // HAVE_CLE266_MPEG_DECODER
+     }
  
!     ReportLayerInfo(osdLayer, "osdLayer");
!     if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL) {
!       fprintf(stderr, "[dfb] osdLayer has alpha channel\n");
!       osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
!       videoLayerLevel = -1;
!     } else {
!       fprintf(stderr, "[dfb] osdLayer without !! alpha channel\n");
      }
  
***************
*** 497,505 ****
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
! #if OLD_VERSION_01
!         if (!setupStore->viaTv)
! #else
!         if (!isVIAUnichrome)
! #endif
            BESColorkeyState(videoLayer, true);
        }
--- 492,496 ----
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
!         if ((videoLayerLevel == 1))
            BESColorkeyState(videoLayer, true);
        }
***************
*** 528,537 ****
      }
  
! #if OLD_VERSION_02
!     ;
! #else
!     if (setupStore->useMGAtv)
! #endif
!       GetDisplayFrameTime();
      /* create an event buffer with all devices attached */
      events = dfb->CreateInputEventBuffer(DICAPS_ALL,
--- 519,523 ----
      }
  
!     GetDisplayFrameTime();
      /* create an event buffer with all devices attached */
      events = dfb->CreateInputEventBuffer(DICAPS_ALL,
***************
*** 712,716 ****
  
        useStretchBlit = false;
!       OSDpseudo_alpha = !isVIAUnichrome;
        if (setupStore->pixelFormat == 0)
        {
--- 698,706 ----
  
        useStretchBlit = false;
!       /* ---------------------------------------------------------------------
!        * if we are in video underlay mode (videoLayerLevel == -1), we have
!        * real alpha blending with videoLayer and osdLayer.
!        */
!       OSDpseudo_alpha = (videoLayerLevel == 1);
        if (setupStore->pixelFormat == 0)
        {
***************
*** 798,802 ****
          }
  #endif
!         if (isVIAUnichrome)
          {
            try
--- 788,792 ----
          }
  #endif
!         if (videoLayerLevel == -1)
          {
            try
***************
*** 959,968 ****
              videoSurface->Release();
            }
! #if HAVE_DSBLIT_INTERLACED
! 	  if (setupStore->useMGAtv)
! 	  {
! 	    vidDsc.caps = DFB_ADD_SURFACE_CAPS(vidDsc.caps, DSCAPS_INTERLACED);
! 	  }
! #endif
  
            videoSurface=dfb->CreateSurface(vidDsc);
--- 949,955 ----
              videoSurface->Release();
            }
!           if (setupStore->useMGAtv) {
!             vidDsc.caps = DFB_ADD_SURFACE_CAPS(vidDsc.caps, DSCAPS_INTERLACED);
!           }
  
            videoSurface=dfb->CreateSurface(vidDsc);
***************
*** 1501,1510 ****
  
        }
! #if OLD_VERSION_03
        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
- #else
-       scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
- #endif
- 
      }
      else
--- 1488,1493 ----
  
        }
!       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
      }
      else



