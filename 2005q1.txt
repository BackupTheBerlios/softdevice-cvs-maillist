From nobody at sheep.berlios.de  Sat Jan  1 15:28:02 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 1 Jan 2005 15:28:02 +0100
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.10,1.11
Message-ID: <200501011428.j01ES2n30743@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7964

Modified Files:
	video-dfb.c 
Log Message:
fix OSD not show with vdr-1.2.x

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-dfb.c	21 Dec 2004 05:55:42 -0000	1.10
--- video-dfb.c	1 Jan 2005 14:28:00 -0000	1.11
***************
*** 782,786 ****
      OSDpresent = true;
  
!   //tmpSurface->Flip();
  }
  #endif
--- 782,786 ----
      OSDpresent = true;
  
!   tmpSurface->Flip();
  }
  #endif



From nobody at sheep.berlios.de  Sat Jan  1 16:18:02 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 1 Jan 2005 16:18:02 +0100
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.11,1.12
Message-ID: <200501011518.j01FI2n31764@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9099

Modified Files:
	video-dfb.c 
Log Message:
support old and new matrox crtc2 layer names

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-dfb.c	1 Jan 2005 14:28:00 -0000	1.11
--- video-dfb.c	1 Jan 2005 15:18:00 -0000	1.12
***************
*** 38,50 ****
  } tLayerSelectItem;
  
! #define BES_LAYER   0
! #define CRTC2_LAYER 1
! #define SPIC_LAYER  2
! #define ANY_LAYER   3
  
! tLayerSelectItem  layerList [4] =
    {
      {"bes",   "Matrox Backend Scaler",    NULL, DFB_UNSUPPORTED},
      {"crtc2", "Matrox CRTC2",             NULL, DFB_UNSUPPORTED},
      {"spic",  "Matrox CRTC2 Sub-Picture", NULL, DFB_UNSUPPORTED},
      {NULL,    NULL,                       NULL, DFB_UNSUPPORTED}
--- 38,52 ----
  } tLayerSelectItem;
  
! #define BES_LAYER       0
! #define CRTC2_LAYER_OLD 1
! #define CRTC2_LAYER_NEW 2
! #define SPIC_LAYER      3
! #define ANY_LAYER       4
  
! tLayerSelectItem  layerList [5] =
    {
      {"bes",   "Matrox Backend Scaler",    NULL, DFB_UNSUPPORTED},
      {"crtc2", "Matrox CRTC2",             NULL, DFB_UNSUPPORTED},
+     {"crtc2", "Matrox CRTC2 Layer",       NULL, DFB_UNSUPPORTED},
      {"spic",  "Matrox CRTC2 Sub-Picture", NULL, DFB_UNSUPPORTED},
      {NULL,    NULL,                       NULL, DFB_UNSUPPORTED}
***************
*** 272,280 ****
    layerInfo = &layerList [ANY_LAYER];
    if (setupStore.useMGAtv)
!     layerInfo = &layerList [CRTC2_LAYER];
  
    dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
- 
    videoLayer = layerInfo->layer;
  
    scrDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 274,288 ----
    layerInfo = &layerList [ANY_LAYER];
    if (setupStore.useMGAtv)
!     layerInfo = &layerList [CRTC2_LAYER_NEW];
  
    dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
    videoLayer = layerInfo->layer;
+ 
+   if (setupStore.useMGAtv && !videoLayer) {
+     layerInfo = &layerList [CRTC2_LAYER_OLD];
+     fprintf(stderr, "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
+     dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
+     videoLayer = layerInfo->layer;
+   }
  
    scrDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |



From nobody at sheep.berlios.de  Sat Jan  1 16:29:42 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 1 Jan 2005 16:29:42 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.23,1.24
Message-ID: <200501011529.j01FTgn31913@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9584

Modified Files:
	CHANGELOG 
Log Message:
report last changes

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** CHANGELOG	30 Dec 2004 18:54:44 -0000	1.23
--- CHANGELOG	1 Jan 2005 15:29:40 -0000	1.24
***************
*** 1,3 ****
--- 1,12 ----
  Changelog
+   2005-01-01:
+    - dfb-out: fix for dfb-0.9.20 and 0.9.21 matrox crtc2 layer names
+               fix for OSD not shown with vdr-1.2.x
+   2004-12-31:
+    - xv-out: Fix for our bug #2972. Black color key is
+              now back to value 0x00000000. Savage card users have to
+              file bug reports at X11 developers if their OSD is not shown
+              or change colorkey setting to value 0x01000000 in file
+              video-xv.c in call of "attributeStore.SetColorkey(0x00000000);" .
    2004-12-30:
     - xv-out: compile fix for gcc 3.4.3



From nobody at sheep.berlios.de  Sun Jan  2 10:48:33 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 2 Jan 2005 10:48:33 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.24,1.25 video-dfb.c,1.12,1.13
Message-ID: <200501020948.j029mXn22527@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12049

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
override pixelformat when mgatv is specified

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** CHANGELOG	1 Jan 2005 15:29:40 -0000	1.24
--- CHANGELOG	2 Jan 2005 09:48:31 -0000	1.25
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+   2005-01-02:
+     -dfb-out: override pixelformat when mgatv is specified.
    2005-01-01:
     - dfb-out: fix for dfb-0.9.20 and 0.9.21 matrox crtc2 layer names

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-dfb.c	1 Jan 2005 15:18:00 -0000	1.12
--- video-dfb.c	2 Jan 2005 09:48:31 -0000	1.13
***************
*** 273,278 ****
    videoLayer = NULL;
    layerInfo = &layerList [ANY_LAYER];
!   if (setupStore.useMGAtv)
      layerInfo = &layerList [CRTC2_LAYER_NEW];
  
    dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
--- 273,280 ----
    videoLayer = NULL;
    layerInfo = &layerList [ANY_LAYER];
!   if (setupStore.useMGAtv) {
      layerInfo = &layerList [CRTC2_LAYER_NEW];
+     currentPixelFormat = setupStore.pixelFormat = 2;
+   }
  
    dfb->EnumDisplayLayers(EnumCallBack, layerInfo);



From nobody at sheep.berlios.de  Tue Jan  4 20:00:04 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 4 Jan 2005 20:00:04 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.25,1.26 softdevice.c,1.9,1.10
Message-ID: <200501041900.j04J04n21901@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10355

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
softdevice-0.0.8 final

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** CHANGELOG	2 Jan 2005 09:48:31 -0000	1.25
--- CHANGELOG	4 Jan 2005 19:00:01 -0000	1.26
***************
*** 1,3 ****
--- 1,4 ----
  Changelog
+   2005-01-04: softdevice-0.0.8
    2005-01-02:
      -dfb-out: override pixelformat when mgatv is specified.

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** softdevice.c	21 Dec 2004 05:55:42 -0000	1.9
--- softdevice.c	4 Jan 2005 19:00:01 -0000	1.10
***************
*** 70,74 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.0.8pre1";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 70,74 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.0.8";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";



From nobody at sheep.berlios.de  Wed Jan 12 21:24:37 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 12 Jan 2005 21:24:37 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.5,1.6 CHANGELOG,1.26,1.27
Message-ID: <200501122024.j0CKObn26748@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14669

Modified Files:
	video.c CHANGELOG 
Log Message:
fix aspect ratio calculation/recognition on some dvds

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video.c	30 Dec 2004 18:47:50 -0000	1.5
--- video.c	12 Jan 2005 20:24:34 -0000	1.6
***************
*** 129,134 ****
                                          AVCodecContext *context)
  {
!     static float  new_asp, aspect_F = -100.0;
!     static int    aspect_I = -100;
  
    /* --------------------------------------------------------------------------
--- 129,134 ----
                                          AVCodecContext *context)
  {
!     static volatile float new_asp, aspect_F = -100.0;
!     static int            aspect_I = -100;
  
    /* --------------------------------------------------------------------------
***************
*** 144,163 ****
  
  #if LIBAVCODEC_BUILD > 4686
!   if (picture->pan_scan->width) {
!     new_asp = (float) (picture->pan_scan->width *
!                        context->sample_aspect_ratio.num) /
!                (float) (picture->pan_scan->height *
!                         context->sample_aspect_ratio.den);
!   } else {
!     new_asp = (float) (context->width *
!                        context->sample_aspect_ratio.num) /
!                (float) (context->height *
!                         context->sample_aspect_ratio.den);
!   }
  #else
    new_asp = context->aspect_ratio;
  #endif
  
! 
    if (aspect_I != context->dtg_active_format ||
        aspect_F != new_asp)
--- 144,164 ----
  
  #if LIBAVCODEC_BUILD > 4686
!   /* --------------------------------------------------------------------------
!    * removed aspect ratio calculation based on picture->pan_scan->width
!    * as this value seems to be wrong on some dvds.
!    */
!   new_asp = (float) (context->width * context->sample_aspect_ratio.num) /
!               (float) (context->height * context->sample_aspect_ratio.den);
  #else
    new_asp = context->aspect_ratio;
  #endif
  
!   /* --------------------------------------------------------------------------
!    * aspect_F and new_asp are now static volatile float. Due to above
!    * code removal, gcc-3.3.1 from suse compiles comparison wrong.
!    * it compares the 32bit float value with it's temprary new_asp value
!    * from above calculation which has even a higher precision than double :-( ,
!    * and would result not_equal every time.
!    */
    if (aspect_I != context->dtg_active_format ||
        aspect_F != new_asp)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** CHANGELOG	4 Jan 2005 19:00:01 -0000	1.26
--- CHANGELOG	12 Jan 2005 20:24:34 -0000	1.27
***************
*** 1,179 ****
! Changelog
!   2005-01-04: softdevice-0.0.8
!   2005-01-02:
!     -dfb-out: override pixelformat when mgatv is specified.
!   2005-01-01:
!    - dfb-out: fix for dfb-0.9.20 and 0.9.21 matrox crtc2 layer names
!               fix for OSD not shown with vdr-1.2.x
!   2004-12-31:
!    - xv-out: Fix for our bug #2972. Black color key is
!              now back to value 0x00000000. Savage card users have to
!              file bug reports at X11 developers if their OSD is not shown
!              or change colorkey setting to value 0x01000000 in file
!              video-xv.c in call of "attributeStore.SetColorkey(0x00000000);" .
!   2004-12-30:
!    - xv-out: compile fix for gcc 3.4.3
!              fix for vdr-1.2.x "_ZN9cVideoOut8OSDStartEv"
!   2004-12-21: softdevice-0.0.8pre1
!    - directFB:
!       - some basic support for mga tv-out with directFB- this is selectable
!         via option -vo dfb:mgatv .
!       - VIA Unichrome handling added. works with recent cvs version of DFB
!   2004-12-12:
!    - Added reporting of AC3 stream info (with help from plugin femon).
!    - Changed A/V sync point by 4 frames. Sync is now ok for streams with PTS
!      value for each frame and for streams with PTS values for I-Frames only.
!      Thus OSD option "A/V Sync" is obsolete.
!   2004-11-14:
!    - new A-V sync with linux RTC support
!    - changed audio buffering 
!    - implemented serveral missing cDevice methods:
!      TrickSpeed(),Clear(),Freeze()...
!    - process smaller packets at one time to improve
!      the response time
!    - sleep in Poll if buffer is full
!   2004-11-04: softdevice-0.0.7
!    - audio-out: don't exit when we get EINTR upon write
!   2004-10-30: softdevice-0.0.7pre4 
!   2004-10-29:
!    - xv-out: changed fullscreen mode. works now with more wms (bug: #2265)
!    - xv-out: fix possible race condition causing segfault during init (bug: #2699)
!    - allow setting alsa device with command line parameter or in setup.conf
!   2004-10-25:
!    - compile fix for older vdr versions. tested with 1.2.1 .
!    - bumped level to 0.0.7pre3 .
!    - fix compile issues with X11 dpms headers. they are not usable for
!      C++ code. see: http://freedesktop.org/bugzilla/show_bug.cgi?id=830 .
!   2004-10-24:
!    - fix for DFB-out OSD not shown while paused in YUY2 mode (bug: #002266)
!   2004-10-23:
!    - some fixes upon deinterlacing selection (bug: #002267)
!    - added pseudo alpha OSD background upon an idea of Torgeir Veimo
!   2004-10-18:
!    - xv-out: allow disabling screensaver when in full screen mode (Torgeir Veimo)
!    - mpeg2decoder: enable adjustable audio / video offset (Torgeir Veimo)
!    - DFB: fix compare DFXL_NONE using equals (Torgeir Veimo)
!   2004-08-09:
!    - DFB+vidix: fix wrong colors in crop mode
!    - fix: segfaults during decoding
!   2004-08-08:
!     - DFB: fix calling sequence to avoid sig 6
!     - xv-out: added fullscreen patch (Torgeir Veimo)
!               toggle is done via pressing 'f'
!               (works at the moment _only_ with gnome window manager)
!   2004-08-01:
!     - fix: syncOnFrames not stored (Torgeir Veimo)
!     - fix: audio - some cards don't have any master volume (Torgeir Veimo)
!   2004-07-25: softdevice-0.0.7pre2
!     - Use of additional deinterlace methods of ffmpeg. This may require
!       recompilation of ffmpeg (see hints in Makefile) (Thanks to Herbert Attenberger)
!     - New OSD option for A/V sync selection. This is related to sync change
!       from 2004-06-02. Normal sync is to get the sync pts from I-Frames only.
!       To sync on any PTS you have to change this (DVB-T fix).
!     - DFB: changed remote react on keypress instead of release
!     - DFB: when selecting YUY2 mode you'll get an alpha blende OSD (at least
!            with Matrox cards).
!   2004-07-23:
!     - xv-out: while mouse in window, auto hide cursor (thanks to Torgeir Veimo)
!   2004-07-18:
!     - moved ffmpeg version and build level report
!     - setup-OSD does not depend on XV_SUPPORT
!   2004-07-12:
!     - fix: DFB cropping for 16:9 mode
!     - OSD: softdevice menu now reachable via main menu entry
!            menu behaves different to others: changes are active immediate,
!            ok-key makes them permanent, back-key restores previous state.
!   2004-07-11 :
!     - fix: compile problem when only one output method (DFB) is selected
!     - DFB + vidix: selectable pixel format I420, YV12 via OSD
!     - OSD: offer only those menu items which are useful for current output method
!     - OSD: changed text from "Xv-Aspect" to "Xv startup aspect" and use "16:9 wide"
!            and "4:3 normal" strings for selection instead of 0, 1 values
!   2004-07-10 : softdevice-0.0.7pre1
!     - use of ffmpegs deinterlacer, selectable via OSD. Thanks to Herbert Attenberger
!     - DFB out added aspect ratio and AFD handling
!     - activate cropping support, selectable via OSD (xv-out + vidix-out + dfb-out)
!   2004-07-09 : softdevice-0.0.6post3
!     - DFB out set display layer configuration according to reported capabilities
!     - DFB out use only first available video layer
!   2004-06-28 :
!     - DFB out changed COLORKEY to 0,0,0 to get transparent OSD with matrox
!     - DFB out has it's own remote
!     - DFB out only set videolayer if it is NOT set previously
!   2004-06-02 : softdevice-0.0.6post2
!              - added some addtional libs for ffmpeg which may be required
!              - changed VIDIX out to probe for driver
!              - fix for syncing on some DVB-T streams
!   2004-05-30 - fix xv video refresh for MapNotify event
!   2004-05-24 - added aspect ratio handling for VIDIX out
!   2004-05-23 - added help text for commandline help
! 
!   2004-05-22 : softdevice-0.0.6
!     - fix compilation for LIBAVCODEC_BUILD <= 4686 (thanks to Luca Olivetti)
!     - again fix savage colour key
!     - revert OSD centering for FB + VIDIX out
!       (it's a feature of vdr-1.3.7, OSD position is adjustable via OSD)
! 
!   2004-05-20 : softdevice-0.0.6pre3
!     - fb output is now running with vdr-1.3.7 too
!     - merged softdevice-0.0.5-fb-patch01
!       (its intentionaly in the vdr-1.2.x section only)
!     - fix OSD positioning fb-out + vidix-out for vdr-1.3.7
! 
!   2004-05-20 : softdevice-0.0.6pre2
!     - xv output now works with vdr-1.3.7 too
!     
!   2004-05-19 : softdevice-0.0.6pre1
!     - audio.c: dropped round() call
!     - (f)printf() replaced by dsyslog()
!         audio.c video-xv.c video.c
!     - merged Vadim's
!         vdr-softdevice-0.0.5-xv08.patch and
!         vdr-softdevice-0.0.5-xv08-2.patch
! 
!   2004-04-xx : patch08
!     - checked vidix method too. I had to select I420 instead of YV12 ;;-).
!       (With YV12 I got swaped color components. Vidix driver reports only
!       16 of my 32M G550 ;-) ).
! 
!   2004-04-28?: patch07-02
!     - fix: xv-color key for savage (workaround of X driver bug)
!     - fix: compile problems with non CVS version of ffmpeg
!     - new: xv: hack to control some atom values via keyboard.
!                This bypasses VDR remote key control :-( .
!                c/C  - contrast -/+
!                h/H  - hue -/+
!                b/B  - brightness -/+
!                s/S  - saturation -/+
!     - new: all output methods can be compiled in.
!            method selectable at runtime via:
!               '-vo xv:' or
!               '-vo fb:' or
!               '-vo dfb:' or
!               '-vo vidix:'
!            if there is only one method specified at compile time via Makefile
!            this parameter is not required (tested only with xv and fb).
! 
!   2004-04-16 : xv output patch07
!     - fix: force CheckAspect upon dimension change (since patch06)
!     - report PAN/SCAN info if present
! 
!   2004-04-16 : xv output patch06
!     - implemented StillPicture method
!     - clean up some messages
!     - AFD tag support
! 
!   2004-03-07 : xv output patch05
!     - fixed rounding error for 16:9 output area (height 575 instead of 576).
!     - OSD opaque black color translated to a different dark value so that it
!       is different from the COLORKEY and no longer transparent.
!     - xv output has now a commandline argument:
!         -vo xv:aspect=[wide|normal]
!         examples:
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=wide'
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=normal'
!     - OSD not shown (for new users) during remote teaching phase
!       (introduced by patch03).
!     - changed last paramter of X..ShmPut..() to False and replaced XFlush()
!       by XSync() (according to vlc this should save CPU time).
!     - added volume control.
--- 1,181 ----
! Changelog
!   2005-01-12:
!     - fix aspect ratio calculation/recognition on some dvds
!   2005-01-04: softdevice-0.0.8
!   2005-01-02:
!     -dfb-out: override pixelformat when mgatv is specified.
!   2005-01-01:
!    - dfb-out: fix for dfb-0.9.20 and 0.9.21 matrox crtc2 layer names
!               fix for OSD not shown with vdr-1.2.x
!   2004-12-31:
!    - xv-out: Fix for our bug #2972. Black color key is
!              now back to value 0x00000000. Savage card users have to
!              file bug reports at X11 developers if their OSD is not shown
!              or change colorkey setting to value 0x01000000 in file
!              video-xv.c in call of "attributeStore.SetColorkey(0x00000000);" .
!   2004-12-30:
!    - xv-out: compile fix for gcc 3.4.3
!              fix for vdr-1.2.x "_ZN9cVideoOut8OSDStartEv"
!   2004-12-21: softdevice-0.0.8pre1
!    - directFB:
!       - some basic support for mga tv-out with directFB- this is selectable
!         via option -vo dfb:mgatv .
!       - VIA Unichrome handling added. works with recent cvs version of DFB
!   2004-12-12:
!    - Added reporting of AC3 stream info (with help from plugin femon).
!    - Changed A/V sync point by 4 frames. Sync is now ok for streams with PTS
!      value for each frame and for streams with PTS values for I-Frames only.
!      Thus OSD option "A/V Sync" is obsolete.
!   2004-11-14:
!    - new A-V sync with linux RTC support
!    - changed audio buffering 
!    - implemented serveral missing cDevice methods:
!      TrickSpeed(),Clear(),Freeze()...
!    - process smaller packets at one time to improve
!      the response time
!    - sleep in Poll if buffer is full
!   2004-11-04: softdevice-0.0.7
!    - audio-out: don't exit when we get EINTR upon write
!   2004-10-30: softdevice-0.0.7pre4 
!   2004-10-29:
!    - xv-out: changed fullscreen mode. works now with more wms (bug: #2265)
!    - xv-out: fix possible race condition causing segfault during init (bug: #2699)
!    - allow setting alsa device with command line parameter or in setup.conf
!   2004-10-25:
!    - compile fix for older vdr versions. tested with 1.2.1 .
!    - bumped level to 0.0.7pre3 .
!    - fix compile issues with X11 dpms headers. they are not usable for
!      C++ code. see: http://freedesktop.org/bugzilla/show_bug.cgi?id=830 .
!   2004-10-24:
!    - fix for DFB-out OSD not shown while paused in YUY2 mode (bug: #002266)
!   2004-10-23:
!    - some fixes upon deinterlacing selection (bug: #002267)
!    - added pseudo alpha OSD background upon an idea of Torgeir Veimo
!   2004-10-18:
!    - xv-out: allow disabling screensaver when in full screen mode (Torgeir Veimo)
!    - mpeg2decoder: enable adjustable audio / video offset (Torgeir Veimo)
!    - DFB: fix compare DFXL_NONE using equals (Torgeir Veimo)
!   2004-08-09:
!    - DFB+vidix: fix wrong colors in crop mode
!    - fix: segfaults during decoding
!   2004-08-08:
!     - DFB: fix calling sequence to avoid sig 6
!     - xv-out: added fullscreen patch (Torgeir Veimo)
!               toggle is done via pressing 'f'
!               (works at the moment _only_ with gnome window manager)
!   2004-08-01:
!     - fix: syncOnFrames not stored (Torgeir Veimo)
!     - fix: audio - some cards don't have any master volume (Torgeir Veimo)
!   2004-07-25: softdevice-0.0.7pre2
!     - Use of additional deinterlace methods of ffmpeg. This may require
!       recompilation of ffmpeg (see hints in Makefile) (Thanks to Herbert Attenberger)
!     - New OSD option for A/V sync selection. This is related to sync change
!       from 2004-06-02. Normal sync is to get the sync pts from I-Frames only.
!       To sync on any PTS you have to change this (DVB-T fix).
!     - DFB: changed remote react on keypress instead of release
!     - DFB: when selecting YUY2 mode you'll get an alpha blende OSD (at least
!            with Matrox cards).
!   2004-07-23:
!     - xv-out: while mouse in window, auto hide cursor (thanks to Torgeir Veimo)
!   2004-07-18:
!     - moved ffmpeg version and build level report
!     - setup-OSD does not depend on XV_SUPPORT
!   2004-07-12:
!     - fix: DFB cropping for 16:9 mode
!     - OSD: softdevice menu now reachable via main menu entry
!            menu behaves different to others: changes are active immediate,
!            ok-key makes them permanent, back-key restores previous state.
!   2004-07-11 :
!     - fix: compile problem when only one output method (DFB) is selected
!     - DFB + vidix: selectable pixel format I420, YV12 via OSD
!     - OSD: offer only those menu items which are useful for current output method
!     - OSD: changed text from "Xv-Aspect" to "Xv startup aspect" and use "16:9 wide"
!            and "4:3 normal" strings for selection instead of 0, 1 values
!   2004-07-10 : softdevice-0.0.7pre1
!     - use of ffmpegs deinterlacer, selectable via OSD. Thanks to Herbert Attenberger
!     - DFB out added aspect ratio and AFD handling
!     - activate cropping support, selectable via OSD (xv-out + vidix-out + dfb-out)
!   2004-07-09 : softdevice-0.0.6post3
!     - DFB out set display layer configuration according to reported capabilities
!     - DFB out use only first available video layer
!   2004-06-28 :
!     - DFB out changed COLORKEY to 0,0,0 to get transparent OSD with matrox
!     - DFB out has it's own remote
!     - DFB out only set videolayer if it is NOT set previously
!   2004-06-02 : softdevice-0.0.6post2
!              - added some addtional libs for ffmpeg which may be required
!              - changed VIDIX out to probe for driver
!              - fix for syncing on some DVB-T streams
!   2004-05-30 - fix xv video refresh for MapNotify event
!   2004-05-24 - added aspect ratio handling for VIDIX out
!   2004-05-23 - added help text for commandline help
! 
!   2004-05-22 : softdevice-0.0.6
!     - fix compilation for LIBAVCODEC_BUILD <= 4686 (thanks to Luca Olivetti)
!     - again fix savage colour key
!     - revert OSD centering for FB + VIDIX out
!       (it's a feature of vdr-1.3.7, OSD position is adjustable via OSD)
! 
!   2004-05-20 : softdevice-0.0.6pre3
!     - fb output is now running with vdr-1.3.7 too
!     - merged softdevice-0.0.5-fb-patch01
!       (its intentionaly in the vdr-1.2.x section only)
!     - fix OSD positioning fb-out + vidix-out for vdr-1.3.7
! 
!   2004-05-20 : softdevice-0.0.6pre2
!     - xv output now works with vdr-1.3.7 too
!     
!   2004-05-19 : softdevice-0.0.6pre1
!     - audio.c: dropped round() call
!     - (f)printf() replaced by dsyslog()
!         audio.c video-xv.c video.c
!     - merged Vadim's
!         vdr-softdevice-0.0.5-xv08.patch and
!         vdr-softdevice-0.0.5-xv08-2.patch
! 
!   2004-04-xx : patch08
!     - checked vidix method too. I had to select I420 instead of YV12 ;;-).
!       (With YV12 I got swaped color components. Vidix driver reports only
!       16 of my 32M G550 ;-) ).
! 
!   2004-04-28?: patch07-02
!     - fix: xv-color key for savage (workaround of X driver bug)
!     - fix: compile problems with non CVS version of ffmpeg
!     - new: xv: hack to control some atom values via keyboard.
!                This bypasses VDR remote key control :-( .
!                c/C  - contrast -/+
!                h/H  - hue -/+
!                b/B  - brightness -/+
!                s/S  - saturation -/+
!     - new: all output methods can be compiled in.
!            method selectable at runtime via:
!               '-vo xv:' or
!               '-vo fb:' or
!               '-vo dfb:' or
!               '-vo vidix:'
!            if there is only one method specified at compile time via Makefile
!            this parameter is not required (tested only with xv and fb).
! 
!   2004-04-16 : xv output patch07
!     - fix: force CheckAspect upon dimension change (since patch06)
!     - report PAN/SCAN info if present
! 
!   2004-04-16 : xv output patch06
!     - implemented StillPicture method
!     - clean up some messages
!     - AFD tag support
! 
!   2004-03-07 : xv output patch05
!     - fixed rounding error for 16:9 output area (height 575 instead of 576).
!     - OSD opaque black color translated to a different dark value so that it
!       is different from the COLORKEY and no longer transparent.
!     - xv output has now a commandline argument:
!         -vo xv:aspect=[wide|normal]
!         examples:
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=wide'
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=normal'
!     - OSD not shown (for new users) during remote teaching phase
!       (introduced by patch03).
!     - changed last paramter of X..ShmPut..() to False and replaced XFlush()
!       by XSync() (according to vlc this should save CPU time).
!     - added volume control.



From nobody at sheep.berlios.de  Thu Jan 13 21:31:11 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 13 Jan 2005 21:31:11 +0100
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.11,1.12 mpeg2decoder.h,1.9,1.10 softdevice.c,1.10,1.11
Message-ID: <200501132031.j0DKVBE06687@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25870

Modified Files:
	mpeg2decoder.c mpeg2decoder.h softdevice.c 
Log Message:
compatibility fix for vdr-1.3.18

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** mpeg2decoder.c	21 Dec 2004 05:55:42 -0000	1.11
--- mpeg2decoder.c	13 Jan 2005 20:31:08 -0000	1.12
***************
*** 1084,1088 ****
  /* ----------------------------------------------------------------------------
   */
! void cMpeg2Decoder::PlayAudio(const uchar *Data, int Length)
  {
      const uchar *p;
--- 1084,1088 ----
  /* ----------------------------------------------------------------------------
   */
! int cMpeg2Decoder::PlayAudio(const uchar *Data, int Length)
  {
      const uchar *p;
***************
*** 1153,1156 ****
--- 1153,1160 ----
               ((*p)&1)+1, sampleRates[((*p)&3)>>4]);
    }
+ #if VDRVERSNUM >= 10318
+   aout->Write((uchar *)Data,Length);
+ #endif
+   return Length;
  }
  
***************
*** 1206,1212 ****
--- 1210,1218 ----
            vout->Write(header,6);
          }
+ #if VDRVERSNUM < 10318
          if (streamtype >= 0xC0 && streamtype <= 0xCF) {
            aout->Write(header,6);
          }
+ #endif
          state=PAYLOADDATA;
          break;
***************
*** 1215,1220 ****
--- 1221,1228 ----
          if (streamtype == 0xE0)
            vout->Write(inbuf_ptr,streamlen);
+ #if VDRVERSNUM < 10318
          if (streamtype == 0xC0)
            aout->Write(inbuf_ptr,streamlen);
+ #endif
          payload-=streamlen;
          len = streamlen;

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** mpeg2decoder.h	21 Dec 2004 05:55:42 -0000	1.9
--- mpeg2decoder.h	13 Jan 2005 20:31:08 -0000	1.10
***************
*** 181,185 ****
      cMpeg2Decoder(cAudioOut *AudioOut, cVideoOut *VideoOut);
      ~cMpeg2Decoder();
!     void PlayAudio(const uchar *Data, int Length);
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);
--- 181,185 ----
      cMpeg2Decoder(cAudioOut *AudioOut, cVideoOut *VideoOut);
      ~cMpeg2Decoder();
!     int PlayAudio(const uchar *Data, int Length);
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** softdevice.c	4 Jan 2005 19:00:01 -0000	1.10
--- softdevice.c	13 Jan 2005 20:31:08 -0000	1.11
***************
*** 276,280 ****
--- 276,284 ----
    virtual int64_t GetSTC(void);
    virtual int PlayVideo(const uchar *Data, int Length);
+ #if VDRVERSNUM < 10318
    virtual void PlayAudio(const uchar *Data, int Length);
+ #else
+   virtual int  PlayAudio(const uchar *Data, int Length);
+ #endif
  #if VDRVERSNUM >= 10307
    virtual int ProvidesCa(const cChannel *Channel) const;
***************
*** 473,476 ****
--- 477,481 ----
  }
  
+ #if VDRVERSNUM < 10318
  /* ----------------------------------------------------------------------------
   */
***************
*** 479,482 ****
--- 484,495 ----
    decoder->PlayAudio(Data, Length);
  }
+ #else
+ /* ----------------------------------------------------------------------------
+  */
+ int cSoftDevice::PlayAudio(const uchar *Data, int Length)
+ {
+   return decoder->PlayAudio(Data, Length);
+ }
+ #endif
  
  /* ----------------------------------------------------------------------------



From nobody at sheep.berlios.de  Thu Jan 13 21:48:23 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 13 Jan 2005 21:48:23 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.27,1.28 setup-softdevice.c,1.6,1.7 video-dfb.c,1.13,1.14
Message-ID: <200501132048.j0DKmNE07104@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27401

Modified Files:
	CHANGELOG setup-softdevice.c video-dfb.c 
Log Message:
    - compatibility fix for vdr-1.3.18
    - aspect ratio handling for 16:9 TV output
    - dfb-out TVout: set top field first and acpect scaleing for TV mode if not set


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** CHANGELOG	12 Jan 2005 20:24:34 -0000	1.27
--- CHANGELOG	13 Jan 2005 20:48:20 -0000	1.28
***************
*** 1,181 ****
! Changelog
!   2005-01-12:
!     - fix aspect ratio calculation/recognition on some dvds
!   2005-01-04: softdevice-0.0.8
!   2005-01-02:
!     -dfb-out: override pixelformat when mgatv is specified.
!   2005-01-01:
!    - dfb-out: fix for dfb-0.9.20 and 0.9.21 matrox crtc2 layer names
!               fix for OSD not shown with vdr-1.2.x
!   2004-12-31:
!    - xv-out: Fix for our bug #2972. Black color key is
!              now back to value 0x00000000. Savage card users have to
!              file bug reports at X11 developers if their OSD is not shown
!              or change colorkey setting to value 0x01000000 in file
!              video-xv.c in call of "attributeStore.SetColorkey(0x00000000);" .
!   2004-12-30:
!    - xv-out: compile fix for gcc 3.4.3
!              fix for vdr-1.2.x "_ZN9cVideoOut8OSDStartEv"
!   2004-12-21: softdevice-0.0.8pre1
!    - directFB:
!       - some basic support for mga tv-out with directFB- this is selectable
!         via option -vo dfb:mgatv .
!       - VIA Unichrome handling added. works with recent cvs version of DFB
!   2004-12-12:
!    - Added reporting of AC3 stream info (with help from plugin femon).
!    - Changed A/V sync point by 4 frames. Sync is now ok for streams with PTS
!      value for each frame and for streams with PTS values for I-Frames only.
!      Thus OSD option "A/V Sync" is obsolete.
!   2004-11-14:
!    - new A-V sync with linux RTC support
!    - changed audio buffering 
!    - implemented serveral missing cDevice methods:
!      TrickSpeed(),Clear(),Freeze()...
!    - process smaller packets at one time to improve
!      the response time
!    - sleep in Poll if buffer is full
!   2004-11-04: softdevice-0.0.7
!    - audio-out: don't exit when we get EINTR upon write
!   2004-10-30: softdevice-0.0.7pre4 
!   2004-10-29:
!    - xv-out: changed fullscreen mode. works now with more wms (bug: #2265)
!    - xv-out: fix possible race condition causing segfault during init (bug: #2699)
!    - allow setting alsa device with command line parameter or in setup.conf
!   2004-10-25:
!    - compile fix for older vdr versions. tested with 1.2.1 .
!    - bumped level to 0.0.7pre3 .
!    - fix compile issues with X11 dpms headers. they are not usable for
!      C++ code. see: http://freedesktop.org/bugzilla/show_bug.cgi?id=830 .
!   2004-10-24:
!    - fix for DFB-out OSD not shown while paused in YUY2 mode (bug: #002266)
!   2004-10-23:
!    - some fixes upon deinterlacing selection (bug: #002267)
!    - added pseudo alpha OSD background upon an idea of Torgeir Veimo
!   2004-10-18:
!    - xv-out: allow disabling screensaver when in full screen mode (Torgeir Veimo)
!    - mpeg2decoder: enable adjustable audio / video offset (Torgeir Veimo)
!    - DFB: fix compare DFXL_NONE using equals (Torgeir Veimo)
!   2004-08-09:
!    - DFB+vidix: fix wrong colors in crop mode
!    - fix: segfaults during decoding
!   2004-08-08:
!     - DFB: fix calling sequence to avoid sig 6
!     - xv-out: added fullscreen patch (Torgeir Veimo)
!               toggle is done via pressing 'f'
!               (works at the moment _only_ with gnome window manager)
!   2004-08-01:
!     - fix: syncOnFrames not stored (Torgeir Veimo)
!     - fix: audio - some cards don't have any master volume (Torgeir Veimo)
!   2004-07-25: softdevice-0.0.7pre2
!     - Use of additional deinterlace methods of ffmpeg. This may require
!       recompilation of ffmpeg (see hints in Makefile) (Thanks to Herbert Attenberger)
!     - New OSD option for A/V sync selection. This is related to sync change
!       from 2004-06-02. Normal sync is to get the sync pts from I-Frames only.
!       To sync on any PTS you have to change this (DVB-T fix).
!     - DFB: changed remote react on keypress instead of release
!     - DFB: when selecting YUY2 mode you'll get an alpha blende OSD (at least
!            with Matrox cards).
!   2004-07-23:
!     - xv-out: while mouse in window, auto hide cursor (thanks to Torgeir Veimo)
!   2004-07-18:
!     - moved ffmpeg version and build level report
!     - setup-OSD does not depend on XV_SUPPORT
!   2004-07-12:
!     - fix: DFB cropping for 16:9 mode
!     - OSD: softdevice menu now reachable via main menu entry
!            menu behaves different to others: changes are active immediate,
!            ok-key makes them permanent, back-key restores previous state.
!   2004-07-11 :
!     - fix: compile problem when only one output method (DFB) is selected
!     - DFB + vidix: selectable pixel format I420, YV12 via OSD
!     - OSD: offer only those menu items which are useful for current output method
!     - OSD: changed text from "Xv-Aspect" to "Xv startup aspect" and use "16:9 wide"
!            and "4:3 normal" strings for selection instead of 0, 1 values
!   2004-07-10 : softdevice-0.0.7pre1
!     - use of ffmpegs deinterlacer, selectable via OSD. Thanks to Herbert Attenberger
!     - DFB out added aspect ratio and AFD handling
!     - activate cropping support, selectable via OSD (xv-out + vidix-out + dfb-out)
!   2004-07-09 : softdevice-0.0.6post3
!     - DFB out set display layer configuration according to reported capabilities
!     - DFB out use only first available video layer
!   2004-06-28 :
!     - DFB out changed COLORKEY to 0,0,0 to get transparent OSD with matrox
!     - DFB out has it's own remote
!     - DFB out only set videolayer if it is NOT set previously
!   2004-06-02 : softdevice-0.0.6post2
!              - added some addtional libs for ffmpeg which may be required
!              - changed VIDIX out to probe for driver
!              - fix for syncing on some DVB-T streams
!   2004-05-30 - fix xv video refresh for MapNotify event
!   2004-05-24 - added aspect ratio handling for VIDIX out
!   2004-05-23 - added help text for commandline help
! 
!   2004-05-22 : softdevice-0.0.6
!     - fix compilation for LIBAVCODEC_BUILD <= 4686 (thanks to Luca Olivetti)
!     - again fix savage colour key
!     - revert OSD centering for FB + VIDIX out
!       (it's a feature of vdr-1.3.7, OSD position is adjustable via OSD)
! 
!   2004-05-20 : softdevice-0.0.6pre3
!     - fb output is now running with vdr-1.3.7 too
!     - merged softdevice-0.0.5-fb-patch01
!       (its intentionaly in the vdr-1.2.x section only)
!     - fix OSD positioning fb-out + vidix-out for vdr-1.3.7
! 
!   2004-05-20 : softdevice-0.0.6pre2
!     - xv output now works with vdr-1.3.7 too
!     
!   2004-05-19 : softdevice-0.0.6pre1
!     - audio.c: dropped round() call
!     - (f)printf() replaced by dsyslog()
!         audio.c video-xv.c video.c
!     - merged Vadim's
!         vdr-softdevice-0.0.5-xv08.patch and
!         vdr-softdevice-0.0.5-xv08-2.patch
! 
!   2004-04-xx : patch08
!     - checked vidix method too. I had to select I420 instead of YV12 ;;-).
!       (With YV12 I got swaped color components. Vidix driver reports only
!       16 of my 32M G550 ;-) ).
! 
!   2004-04-28?: patch07-02
!     - fix: xv-color key for savage (workaround of X driver bug)
!     - fix: compile problems with non CVS version of ffmpeg
!     - new: xv: hack to control some atom values via keyboard.
!                This bypasses VDR remote key control :-( .
!                c/C  - contrast -/+
!                h/H  - hue -/+
!                b/B  - brightness -/+
!                s/S  - saturation -/+
!     - new: all output methods can be compiled in.
!            method selectable at runtime via:
!               '-vo xv:' or
!               '-vo fb:' or
!               '-vo dfb:' or
!               '-vo vidix:'
!            if there is only one method specified at compile time via Makefile
!            this parameter is not required (tested only with xv and fb).
! 
!   2004-04-16 : xv output patch07
!     - fix: force CheckAspect upon dimension change (since patch06)
!     - report PAN/SCAN info if present
! 
!   2004-04-16 : xv output patch06
!     - implemented StillPicture method
!     - clean up some messages
!     - AFD tag support
! 
!   2004-03-07 : xv output patch05
!     - fixed rounding error for 16:9 output area (height 575 instead of 576).
!     - OSD opaque black color translated to a different dark value so that it
!       is different from the COLORKEY and no longer transparent.
!     - xv output has now a commandline argument:
!         -vo xv:aspect=[wide|normal]
!         examples:
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=wide'
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=normal'
!     - OSD not shown (for new users) during remote teaching phase
!       (introduced by patch03).
!     - changed last paramter of X..ShmPut..() to False and replaced XFlush()
!       by XSync() (according to vlc this should save CPU time).
!     - added volume control.
--- 1,185 ----
! Changelog
!   2005-01-13:
!     - compatibility fix for vdr-1.3.18
!     - aspect ratio handling for 16:9 TV output
!     - dfb-out TVout: set top field first and acpect scaleing for TV mode if not set
!   2005-01-12:
!     - fix aspect ratio calculation/recognition on some dvds
!   2005-01-04: softdevice-0.0.8
!   2005-01-02:
!     -dfb-out: override pixelformat when mgatv is specified.
!   2005-01-01:
!    - dfb-out: fix for dfb-0.9.20 and 0.9.21 matrox crtc2 layer names
!               fix for OSD not shown with vdr-1.2.x
!   2004-12-31:
!    - xv-out: Fix for our bug #2972. Black color key is
!              now back to value 0x00000000. Savage card users have to
!              file bug reports at X11 developers if their OSD is not shown
!              or change colorkey setting to value 0x01000000 in file
!              video-xv.c in call of "attributeStore.SetColorkey(0x00000000);" .
!   2004-12-30:
!    - xv-out: compile fix for gcc 3.4.3
!              fix for vdr-1.2.x "_ZN9cVideoOut8OSDStartEv"
!   2004-12-21: softdevice-0.0.8pre1
!    - directFB:
!       - some basic support for mga tv-out with directFB- this is selectable
!         via option -vo dfb:mgatv .
!       - VIA Unichrome handling added. works with recent cvs version of DFB
!   2004-12-12:
!    - Added reporting of AC3 stream info (with help from plugin femon).
!    - Changed A/V sync point by 4 frames. Sync is now ok for streams with PTS
!      value for each frame and for streams with PTS values for I-Frames only.
!      Thus OSD option "A/V Sync" is obsolete.
!   2004-11-14:
!    - new A-V sync with linux RTC support
!    - changed audio buffering 
!    - implemented serveral missing cDevice methods:
!      TrickSpeed(),Clear(),Freeze()...
!    - process smaller packets at one time to improve
!      the response time
!    - sleep in Poll if buffer is full
!   2004-11-04: softdevice-0.0.7
!    - audio-out: don't exit when we get EINTR upon write
!   2004-10-30: softdevice-0.0.7pre4 
!   2004-10-29:
!    - xv-out: changed fullscreen mode. works now with more wms (bug: #2265)
!    - xv-out: fix possible race condition causing segfault during init (bug: #2699)
!    - allow setting alsa device with command line parameter or in setup.conf
!   2004-10-25:
!    - compile fix for older vdr versions. tested with 1.2.1 .
!    - bumped level to 0.0.7pre3 .
!    - fix compile issues with X11 dpms headers. they are not usable for
!      C++ code. see: http://freedesktop.org/bugzilla/show_bug.cgi?id=830 .
!   2004-10-24:
!    - fix for DFB-out OSD not shown while paused in YUY2 mode (bug: #002266)
!   2004-10-23:
!    - some fixes upon deinterlacing selection (bug: #002267)
!    - added pseudo alpha OSD background upon an idea of Torgeir Veimo
!   2004-10-18:
!    - xv-out: allow disabling screensaver when in full screen mode (Torgeir Veimo)
!    - mpeg2decoder: enable adjustable audio / video offset (Torgeir Veimo)
!    - DFB: fix compare DFXL_NONE using equals (Torgeir Veimo)
!   2004-08-09:
!    - DFB+vidix: fix wrong colors in crop mode
!    - fix: segfaults during decoding
!   2004-08-08:
!     - DFB: fix calling sequence to avoid sig 6
!     - xv-out: added fullscreen patch (Torgeir Veimo)
!               toggle is done via pressing 'f'
!               (works at the moment _only_ with gnome window manager)
!   2004-08-01:
!     - fix: syncOnFrames not stored (Torgeir Veimo)
!     - fix: audio - some cards don't have any master volume (Torgeir Veimo)
!   2004-07-25: softdevice-0.0.7pre2
!     - Use of additional deinterlace methods of ffmpeg. This may require
!       recompilation of ffmpeg (see hints in Makefile) (Thanks to Herbert Attenberger)
!     - New OSD option for A/V sync selection. This is related to sync change
!       from 2004-06-02. Normal sync is to get the sync pts from I-Frames only.
!       To sync on any PTS you have to change this (DVB-T fix).
!     - DFB: changed remote react on keypress instead of release
!     - DFB: when selecting YUY2 mode you'll get an alpha blende OSD (at least
!            with Matrox cards).
!   2004-07-23:
!     - xv-out: while mouse in window, auto hide cursor (thanks to Torgeir Veimo)
!   2004-07-18:
!     - moved ffmpeg version and build level report
!     - setup-OSD does not depend on XV_SUPPORT
!   2004-07-12:
!     - fix: DFB cropping for 16:9 mode
!     - OSD: softdevice menu now reachable via main menu entry
!            menu behaves different to others: changes are active immediate,
!            ok-key makes them permanent, back-key restores previous state.
!   2004-07-11 :
!     - fix: compile problem when only one output method (DFB) is selected
!     - DFB + vidix: selectable pixel format I420, YV12 via OSD
!     - OSD: offer only those menu items which are useful for current output method
!     - OSD: changed text from "Xv-Aspect" to "Xv startup aspect" and use "16:9 wide"
!            and "4:3 normal" strings for selection instead of 0, 1 values
!   2004-07-10 : softdevice-0.0.7pre1
!     - use of ffmpegs deinterlacer, selectable via OSD. Thanks to Herbert Attenberger
!     - DFB out added aspect ratio and AFD handling
!     - activate cropping support, selectable via OSD (xv-out + vidix-out + dfb-out)
!   2004-07-09 : softdevice-0.0.6post3
!     - DFB out set display layer configuration according to reported capabilities
!     - DFB out use only first available video layer
!   2004-06-28 :
!     - DFB out changed COLORKEY to 0,0,0 to get transparent OSD with matrox
!     - DFB out has it's own remote
!     - DFB out only set videolayer if it is NOT set previously
!   2004-06-02 : softdevice-0.0.6post2
!              - added some addtional libs for ffmpeg which may be required
!              - changed VIDIX out to probe for driver
!              - fix for syncing on some DVB-T streams
!   2004-05-30 - fix xv video refresh for MapNotify event
!   2004-05-24 - added aspect ratio handling for VIDIX out
!   2004-05-23 - added help text for commandline help
! 
!   2004-05-22 : softdevice-0.0.6
!     - fix compilation for LIBAVCODEC_BUILD <= 4686 (thanks to Luca Olivetti)
!     - again fix savage colour key
!     - revert OSD centering for FB + VIDIX out
!       (it's a feature of vdr-1.3.7, OSD position is adjustable via OSD)
! 
!   2004-05-20 : softdevice-0.0.6pre3
!     - fb output is now running with vdr-1.3.7 too
!     - merged softdevice-0.0.5-fb-patch01
!       (its intentionaly in the vdr-1.2.x section only)
!     - fix OSD positioning fb-out + vidix-out for vdr-1.3.7
! 
!   2004-05-20 : softdevice-0.0.6pre2
!     - xv output now works with vdr-1.3.7 too
!     
!   2004-05-19 : softdevice-0.0.6pre1
!     - audio.c: dropped round() call
!     - (f)printf() replaced by dsyslog()
!         audio.c video-xv.c video.c
!     - merged Vadim's
!         vdr-softdevice-0.0.5-xv08.patch and
!         vdr-softdevice-0.0.5-xv08-2.patch
! 
!   2004-04-xx : patch08
!     - checked vidix method too. I had to select I420 instead of YV12 ;;-).
!       (With YV12 I got swaped color components. Vidix driver reports only
!       16 of my 32M G550 ;-) ).
! 
!   2004-04-28?: patch07-02
!     - fix: xv-color key for savage (workaround of X driver bug)
!     - fix: compile problems with non CVS version of ffmpeg
!     - new: xv: hack to control some atom values via keyboard.
!                This bypasses VDR remote key control :-( .
!                c/C  - contrast -/+
!                h/H  - hue -/+
!                b/B  - brightness -/+
!                s/S  - saturation -/+
!     - new: all output methods can be compiled in.
!            method selectable at runtime via:
!               '-vo xv:' or
!               '-vo fb:' or
!               '-vo dfb:' or
!               '-vo vidix:'
!            if there is only one method specified at compile time via Makefile
!            this parameter is not required (tested only with xv and fb).
! 
!   2004-04-16 : xv output patch07
!     - fix: force CheckAspect upon dimension change (since patch06)
!     - report PAN/SCAN info if present
! 
!   2004-04-16 : xv output patch06
!     - implemented StillPicture method
!     - clean up some messages
!     - AFD tag support
! 
!   2004-03-07 : xv output patch05
!     - fixed rounding error for 16:9 output area (height 575 instead of 576).
!     - OSD opaque black color translated to a different dark value so that it
!       is different from the COLORKEY and no longer transparent.
!     - xv output has now a commandline argument:
!         -vo xv:aspect=[wide|normal]
!         examples:
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=wide'
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=normal'
!     - OSD not shown (for new users) during remote teaching phase
!       (introduced by patch03).
!     - changed last paramter of X..ShmPut..() to False and replaced XFlush()
!       by XSync() (according to vlc this should save CPU time).
!     - added volume control.

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** setup-softdevice.c	21 Dec 2004 05:55:42 -0000	1.6
--- setup-softdevice.c	13 Jan 2005 20:48:20 -0000	1.7
***************
*** 70,77 ****
   */
  char *videoAspectNames [] = {
!         "default (PAL)",
!         "tv-out (PAL)",
          "5:4 as 4:3",
-         "test 1",
          "test 2",
          NULL
--- 70,77 ----
   */
  char *videoAspectNames [] = {
!         "Monitor",
!         "TV  4:3 PAL",
!         "TV 16:9 PAL",
          "5:4 as 4:3",
          "test 2",
          NULL
***************
*** 83,88 ****
    { 768, 576},
    { 720, 576},
    { 800, 576},
-   {10240, 6144},
    {1280, 1024},
    {768,576}
--- 83,88 ----
    { 768, 576},
    { 720, 576},
+   { 540, 576},
    { 800, 576},
    {1280, 1024},
    {768,576}
***************
*** 186,190 ****
    } else if (!strcasecmp(Name, "PixelAspect")) {
      screenPixelAspect = atoi (Value);
!     screenPixelAspect = clamp (0, screenPixelAspect, 1);
    } else return false;
  
--- 186,190 ----
    } else if (!strcasecmp(Name, "PixelAspect")) {
      screenPixelAspect = atoi (Value);
!     screenPixelAspect = clamp (0, screenPixelAspect, 4);
    } else return false;
  

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-dfb.c	2 Jan 2005 09:48:31 -0000	1.13
--- video-dfb.c	13 Jan 2005 20:48:20 -0000	1.14
***************
*** 276,279 ****
--- 276,281 ----
      layerInfo = &layerList [CRTC2_LAYER_NEW];
      currentPixelFormat = setupStore.pixelFormat = 2;
+     if (!setupStore.screenPixelAspect)
+       setupStore.screenPixelAspect = 1;
    }
  
***************
*** 611,614 ****
--- 613,619 ----
          }
  
+         if (setupStore.useMGAtv)
+           videoLayer->SetFieldParity(0);
+ 
  #if HAVE_SetSourceLocation
          try
***************
*** 656,659 ****
--- 661,668 ----
            videoSurface->Release();
          }
+         
+         if (setupStore.useMGAtv)
+           videoLayer->SetFieldParity(0);
+ 
          videoSurface=NULL;
          videoSurface=dfb->CreateSurface(vidDsc);



From nobody at sheep.berlios.de  Sat Jan 15 09:33:06 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 15 Jan 2005 09:33:06 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.28,1.29 softdevice.c,1.11,1.12 video-dfb.c,1.14,1.15 video-xv.c,1.11,1.12 video.c,1.6,1.7 video.h,1.5,1.6
Message-ID: <200501150833.j0F8X6E00901@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7611

Modified Files:
	CHANGELOG softdevice.c video-dfb.c video-xv.c video.c video.h 
Log Message:
    - fix OSD drawing when multiple areas are used (with text2skin plugin)
    - dfb out: reverted top-field first setting as it may crash


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** CHANGELOG	13 Jan 2005 20:48:20 -0000	1.28
--- CHANGELOG	15 Jan 2005 08:33:04 -0000	1.29
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+   2005-01-15:
+     - fix OSD drawing when multiple areas are used (with text2skin plugin)
+     - dfb out: reverted top-field first setting as it may crash
    2005-01-13:
      - compatibility fix for vdr-1.3.18

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** softdevice.c	13 Jan 2005 20:31:08 -0000	1.11
--- softdevice.c	15 Jan 2005 08:33:04 -0000	1.12
***************
*** 129,132 ****
--- 129,133 ----
      cBitmap *Bitmap;
  
+   videoOut->Size(Width(),Height());
    videoOut->OSDStart();
    for (int i = 0; (Bitmap = GetBitmap(i)) != NULL; i++)

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** video-dfb.c	13 Jan 2005 20:48:20 -0000	1.14
--- video-dfb.c	15 Jan 2005 08:33:04 -0000	1.15
***************
*** 135,138 ****
--- 135,139 ----
    if (desc.caps & DLCAPS_HUE) fprintf(stderr,"hue " );
    if (desc.caps & DLCAPS_LEVELS) fprintf(stderr,"levels " );
+   if (desc.caps & DLCAPS_FIELD_PARITY) fprintf(stderr,"field_parity " );
    if (desc.caps & DLCAPS_OPACITY) fprintf(stderr,"opacity " );
    if (desc.caps & DLCAPS_SATURATION) fprintf(stderr,"saturation " );
***************
*** 613,618 ****
          }
  
!         if (setupStore.useMGAtv)
!           videoLayer->SetFieldParity(0);
  
  #if HAVE_SetSourceLocation
--- 614,619 ----
          }
  
!         //if (setupStore.useMGAtv)
!           //videoLayer->SetFieldParity(0);
  
  #if HAVE_SetSourceLocation
***************
*** 661,667 ****
            videoSurface->Release();
          }
!         
!         if (setupStore.useMGAtv)
!           videoLayer->SetFieldParity(0);
  
          videoSurface=NULL;
--- 662,668 ----
            videoSurface->Release();
          }
! 
!         //if (setupStore.useMGAtv)
!           //videoLayer->SetFieldParity(0);
  
          videoSurface=NULL;
***************
*** 687,711 ****
  #if VDRVERSNUM >= 10307
  
- #if 0
- 
  /* ---------------------------------------------------------------------------
   */
  void cDFBVideoOut::OSDStart()
  {
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cDFBVideoOut::OSDCommit()
- {
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cDFBVideoOut::Refresh(cBitmap *Bitmap)
- {
-     int pitch;
-     int dx1 = 0, dx2 = 0, dy1 = 0, dy2 = 0;
-     uint8_t *dst;
      IDirectFBSurface  *tmpSurface;
  
--- 688,695 ----
***************
*** 717,743 ****
     * ??
     */
!   //tmpSurface->Clear(0,0,0,clearAlpha);
!   tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
!   if (Bitmap->Dirty(dx1,dy1,dx2,dy2))
!   {
!     Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
!     Bitmap->Clean();
!   }
!   tmpSurface->Unlock();
! 
!   if (useStretchBlit)
!   {
!     OSDpresent = true;
!     //tmpSurface->Flip();
!   }
!   //tmpSurface->Flip();
! }
! 
! #else
! 
! /* ---------------------------------------------------------------------------
!  */
! void cDFBVideoOut::OSDStart()
! {
  }
  
--- 701,705 ----
     * ??
     */
!   tmpSurface->Clear(0,0,0,clearAlpha);
  }
  
***************
*** 746,749 ****
--- 708,715 ----
  void cDFBVideoOut::OSDCommit()
  {
+     IDirectFBSurface  *tmpSurface;
+ 
+   tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
+   tmpSurface->Flip();
  }
  
***************
*** 758,769 ****
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
-   /* --------------------------------------------------------------------------
-    * ?? if that clear is removed, radeon OSD does not flicker
-    * any more. but it has some other negative effects on mga.
-    * ??
-    */
-   tmpSurface->Clear(0,0,0,clearAlpha);
    tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
    Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
    tmpSurface->Unlock();
  
--- 724,745 ----
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
    tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
+ #if 0
+   {
+     /* ------------------------------------------------------------------------
+      * handling of dirty/modified regions only, does not work for now
+      * due to double buffering :-( .
+      */
+       int dx1 = 0, dx2 = 0, dy1 = 0, dy2 = 0;
+ 
+     if (Bitmap->Dirty(dx1,dy1,dx2,dy2))
+     {
+       Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
+       Bitmap->Clean();
+     }
+   }
+ #else
    Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
+ #endif
    tmpSurface->Unlock();
  
***************
*** 773,779 ****
      //tmpSurface->Flip();
    }
-   tmpSurface->Flip();
  }
- #endif
  
  #else
--- 749,753 ----

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-xv.c	31 Dec 2004 01:00:10 -0000	1.11
--- video-xv.c	15 Jan 2005 08:33:04 -0000	1.12
***************
*** 1000,1005 ****
      osd_x = OSDxOfs;
      osd_y = OSDyOfs;
!     osd_w = Bitmap->Width();
!     osd_h = Bitmap->Height();
      pthread_mutex_unlock(&xv_mutex);
    }
--- 1000,1005 ----
      osd_x = OSDxOfs;
      osd_y = OSDyOfs;
!     osd_w = OSDw;
!     osd_h = OSDh;
      pthread_mutex_unlock(&xv_mutex);
    }

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video.c	12 Jan 2005 20:24:34 -0000	1.6
--- video.c	15 Jan 2005 08:33:04 -0000	1.7
***************
*** 240,245 ****
    {
      buf = (tIndex *) osd_buf +
!             linelen * ( OSDyOfs + y ) +
!             OSDxOfs * depth;
      prev_pix = false;
  
--- 240,245 ----
    {
      buf = (tIndex *) osd_buf +
!             linelen * ( OSDyOfs + y + Bitmap->Y0()) +
!             (OSDxOfs + Bitmap->X0()) * depth;
      prev_pix = false;
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video.h	21 Dec 2004 05:55:43 -0000	1.5
--- video.h	15 Jan 2005 08:33:04 -0000	1.6
***************
*** 42,46 ****
  protected:
      cMutex  osdMutex;
!     int     OSDxOfs, OSDyOfs;
      bool    OSDpresent,
              OSDpseudo_alpha;
--- 42,47 ----
  protected:
      cMutex  osdMutex;
!     int     OSDxOfs, OSDyOfs,
!             OSDw, OSDh;
      bool    OSDpresent,
              OSDpseudo_alpha;
***************
*** 63,66 ****
--- 64,68 ----
  public:
      virtual ~cVideoOut();
+     virtual void Size(int w, int h) {OSDw = w; OSDh = h;};
      virtual void OSDStart();
      virtual void OSDCommit();



From nobody at sheep.berlios.de  Sat Jan 15 10:29:32 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 15 Jan 2005 10:29:32 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.29,1.30 mpeg2decoder.c,1.12,1.13
Message-ID: <200501150929.j0F9TWE01957@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11414

Modified Files:
	CHANGELOG mpeg2decoder.c 
Log Message:
- some audio sync fixes


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** CHANGELOG	15 Jan 2005 08:33:04 -0000	1.29
--- CHANGELOG	15 Jan 2005 09:29:29 -0000	1.30
***************
*** 3,7 ****
      - fix OSD drawing when multiple areas are used (with text2skin plugin)
      - dfb out: reverted top-field first setting as it may crash
!   2005-01-13:
      - compatibility fix for vdr-1.3.18
      - aspect ratio handling for 16:9 TV output
--- 3,11 ----
      - fix OSD drawing when multiple areas are used (with text2skin plugin)
      - dfb out: reverted top-field first setting as it may crash
!     - removed some unused code
!     - subtract already spend time from delay before entering delay loop
!       (found by Stefan Lucke)
!     - audio pts calculation changed to use sample rate and number of channels
!  2005-01-13:
      - compatibility fix for vdr-1.3.18
      - aspect ratio handling for 16:9 TV output

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** mpeg2decoder.c	13 Jan 2005 20:31:08 -0000	1.12
--- mpeg2decoder.c	15 Jan 2005 09:29:29 -0000	1.13
***************
*** 321,343 ****
      MPGDEB("valid PTS : %lld pts - valid PTS: %lld \n",
        GET_MPEG2_PTS(header)/90,(int) pts - GET_MPEG2_PTS(header)/90);
-     //pts = GET_MPEG2_PTS(header)/90;
      pts = newPTS;
    }
  
-   int delay = audioOut->GetDelay();
- //  if (delay ==0)
- //    printf("Buffer underrun \n");
  
    audioOut->SetParams(context->channels,context->sample_rate);
    audioOut->Write(audiosamples,audio_size);
!   /*    if (delay < 80)
!    {
!   // if we have less than 80 ms in buffer we double frames
!   audioOut->Write(audiosamples,audio_size);
!   printf("doubleing audio frame!!!!\n");
!   }
!   //}
!    */
!   pts += (audio_size/(48*4)); // PTS weiterz??hlen, egal ob Samples gespielt oder nicht
    return len;
  }
--- 321,332 ----
      MPGDEB("valid PTS : %lld pts - valid PTS: %lld \n",
        GET_MPEG2_PTS(header)/90,(int) pts - GET_MPEG2_PTS(header)/90);
      pts = newPTS;
    }
  
  
    audioOut->SetParams(context->channels,context->sample_rate);
    audioOut->Write(audiosamples,audio_size);
!   // adjust PTS according to audio_size, sampel_rate and no. of channels  
!   pts += (audio_size/(context->sample_rate/1000*2*context->channels)); 
    return len;
  }
***************
*** 616,620 ****
    else if (delay < -2*frametime*1000)
      delay = -2*frametime*1000;    
! 
    // prepare picture for display
    videoOut->CheckAspectDimensions(picture,context);
--- 605,610 ----
    else if (delay < -2*frametime*1000)
      delay = -2*frametime*1000;    
!   delay-=GetRelTime();
!    
    // prepare picture for display
    videoOut->CheckAspectDimensions(picture,context);



From nobody at sheep.berlios.de  Sun Jan 23 15:54:29 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Jan 2005 15:54:29 +0100
Subject: [Softdevice-cvs] softdevice video.h,1.6,1.7 video-xv.c,1.12,1.13 video-xv.h,1.3,1.4 mpeg2decoder.c,1.13,1.14 mpeg2decoder.h,1.10,1.11 Makefile,1.4,1.5 CHANGELOG,1.30,1.31
Message-ID: <200501231454.j0NEsTN07802@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26781

Modified Files:
	video.h video-xv.c video-xv.h mpeg2decoder.c mpeg2decoder.h 
	Makefile CHANGELOG 
Log Message:
- added playback suspend patch


Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video.h	15 Jan 2005 08:33:04 -0000	1.6
--- video.h	23 Jan 2005 14:54:22 -0000	1.7
***************
*** 77,80 ****
--- 77,83 ----
      virtual bool GetInfo(int *fmt, unsigned char **dest,int *w, int *h) {return false;};
  
+     virtual void Suspend(void) { printf("Video Suspend\n"); return;};
+     virtual bool Resume(void) {printf("Video Resume\n"); return true;};
+ 
  #if VDRVERSNUM >= 10307
  

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-xv.c	15 Jan 2005 08:33:04 -0000	1.12
--- video-xv.c	23 Jan 2005 14:54:22 -0000	1.13
***************
*** 27,30 ****
--- 27,31 ----
  #include "xscreensaver.h"
  #include "utils.h"
+ #include "setup-softdevice.h"
  
  #define PATCH_VERSION "008_pre_2"
***************
*** 447,493 ****
              break;
            case 'b':
!             attributeStore.Decrement("XV_BRIGHTNESS");
              break;
            case 'B':
!             attributeStore.Increment("XV_BRIGHTNESS");
              break;
            case 'c':
!             attributeStore.Decrement("XV_CONTRAST");
              break;
            case 'C':
!             attributeStore.Increment("XV_CONTRAST");
              break;
            case 'h':
!             attributeStore.Decrement("XV_HUE");
              break;
            case 'H':
!             attributeStore.Increment("XV_HUE");
              break;
            case 's':
!             attributeStore.Decrement("XV_SATURATION");
              break;
            case 'S':
!             attributeStore.Increment("XV_SATURATION");
              break;
  #if 1
            case 'o':
!             attributeStore.Decrement("XV_OVERLAY_ALPHA");
              break;
            case 'O':
!             attributeStore.Increment("XV_OVERLAY_ALPHA");
              break;
            case 'g':
!             attributeStore.Decrement("XV_GRAPHICS_ALPHA");
              break;
            case 'G':
!             attributeStore.Increment("XV_GRAPHICS_ALPHA");
              break;
            case 'a':
!             attributeStore.Decrement("XV_ALPHA_MODE");
              break;
            case 'A':
!             attributeStore.Increment("XV_ALPHA_MODE");
              break;
  #endif
            default:
              if (xvRemote) {
--- 448,513 ----
              break;
            case 'b':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_BRIGHTNESS");
              break;
            case 'B':
!             if (xv_initialized)
!               attributeStore.Increment("XV_BRIGHTNESS");
              break;
            case 'c':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_CONTRAST");
              break;
            case 'C':
!             if (xv_initialized)
!               attributeStore.Increment("XV_CONTRAST");
              break;
            case 'h':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_HUE");
              break;
            case 'H':
!             if (xv_initialized)
!               attributeStore.Increment("XV_HUE");
              break;
            case 's':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_SATURATION");
              break;
            case 'S':
!             if (xv_initialized)
!               attributeStore.Increment("XV_SATURATION");
              break;
  #if 1
            case 'o':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_OVERLAY_ALPHA");
              break;
            case 'O':
!             if (xv_initialized)
!               attributeStore.Increment("XV_OVERLAY_ALPHA");
              break;
            case 'g':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_GRAPHICS_ALPHA");
              break;
            case 'G':
!             if (xv_initialized)
!               attributeStore.Increment("XV_GRAPHICS_ALPHA");
              break;
            case 'a':
!             if (xv_initialized)
!               attributeStore.Decrement("XV_ALPHA_MODE");
              break;
            case 'A':
!             if (xv_initialized)
!               attributeStore.Increment("XV_ALPHA_MODE");
              break;
  #endif
+ #ifdef SUSPEND_BY_KEY 
+           case 'r':
+           case 'R':
+             setupStore.shouldSuspend=!setupStore.shouldSuspend;
+ #endif
            default:
              if (xvRemote) {
***************
*** 505,509 ****
                     RevertToParent,
                     CurrentTime);
!           if (map_count > 2) {
              XvShmPutImage(dpy, port,
                            win, gc,
--- 525,529 ----
                     RevertToParent,
                     CurrentTime);
!           if (map_count > 2 && xv_initialized) {
              XvShmPutImage(dpy, port,
                            win, gc,
***************
*** 520,524 ****
          break;
        case UnmapNotify:
!         XvStopVideo (dpy,port,win);
          if(cursor_visible == False) {
            XUndefineCursor(dpy, win);
--- 540,545 ----
          break;
        case UnmapNotify:
!         if (xv_initialized)
!           XvStopVideo (dpy,port,win);
          if(cursor_visible == False) {
            XUndefineCursor(dpy, win);
***************
*** 531,535 ****
    }
  
!   if (initialized && map_count) {
      XvShmPutImage(dpy, port,
                    win, gc,
--- 552,556 ----
    }
  
!   if (xv_initialized && map_count) {
      XvShmPutImage(dpy, port,
                    win, gc,
***************
*** 777,780 ****
--- 798,803 ----
      XvImageFormatValues *fmt_info;
  
+   pthread_mutex_lock(&xv_mutex);
+ 
    /*
     * So let's first check for an available adaptor and port
***************
*** 923,933 ****
                       lwidth, lheight,   /* dw, dh */
                       False);
! 
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
! 
    rc = XSync(dpy, False);
  
    this->format = format;
    initialized = 1;
    return true;
  }
--- 946,959 ----
                       lwidth, lheight,   /* dw, dh */
                       False);
! 		     
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
!   
    rc = XSync(dpy, False);
+   
+   pthread_mutex_unlock(&xv_mutex);
  
    this->format = format;
    initialized = 1;
+   xv_initialized = 1;
    return true;
  }
***************
*** 947,950 ****
--- 973,1013 ----
  /* ---------------------------------------------------------------------------
   */
+ void cXvVideoOut::Suspend(void)
+ {
+   if (!xv_initialized)
+     return;
+ 
+   pthread_mutex_lock(&xv_mutex);
+ 
+   XvStopVideo(dpy, port, win);
+   XvUngrabPort(dpy, port, CurrentTime);
+   
+   pthread_mutex_unlock(&xv_mutex);
+ 
+   if(shminfo.shmaddr)
+   {
+     shmdt(shminfo.shmaddr);
+     shminfo.shmaddr = NULL;
+   }
+ 
+   if (xv_image)
+   {
+     free(xv_image);
+     xv_image = NULL;
+   }
+   
+   xv_initialized = 0;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ bool cXvVideoOut::Resume(void)
+ {
+   return Reconfigure(format);
+ }
+ 
+ 
+ /* ---------------------------------------------------------------------------
+  */
  bool cXvVideoOut::GetInfo(int *fmt, unsigned char **dest, int *w, int *h)
  {
***************
*** 1096,1100 ****
                        int Ystride, int UVstride)
  {
!   if (!initialized)
      return;
  
--- 1159,1163 ----
                        int Ystride, int UVstride)
  {
!   if (!initialized || !xv_initialized)
      return;
  
***************
*** 1140,1155 ****
      return;
  
!   pthread_mutex_lock(&xv_mutex);
  
!   XvStopVideo(dpy, port, win);
  
!   pthread_mutex_unlock(&xv_mutex);
  
!   if(shminfo.shmaddr)
!   {
!     shmdt(shminfo.shmaddr);
!     shminfo.shmaddr = NULL;
    }
  
    if(osd_shminfo.shmaddr)
    {
--- 1203,1228 ----
      return;
  
!   if (xv_initialized) 
!   {
!     pthread_mutex_lock(&xv_mutex);
  
!     XvStopVideo(dpy, port, win);
  
!     pthread_mutex_unlock(&xv_mutex);
  
!     if(shminfo.shmaddr)
!     {
!       shmdt(shminfo.shmaddr);
!       shminfo.shmaddr = NULL;
!     }
!   
!     if (xv_image)
!     {
!       free(xv_image);
!       xv_image = NULL;
!     }
    }
  
+ 
    if(osd_shminfo.shmaddr)
    {
***************
*** 1158,1166 ****
    }
  
-   if (xv_image)
-   {
-     free(xv_image);
-     xv_image = NULL;
-   }
  
    if (osd_image)
--- 1231,1234 ----

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** video-xv.h	29 Oct 2004 20:36:07 -0000	1.3
--- video-xv.h	23 Jan 2005 14:54:22 -0000	1.4
***************
*** 100,103 ****
--- 100,104 ----
                      net_wm_STATE;
    int               initialized,
+                     xv_initialized,
                      osd_refresh_counter,
                      osd_skip_counter,
***************
*** 156,159 ****
--- 157,163 ----
    virtual void Pause(void);
    virtual bool GetInfo(int *fmt, unsigned char **dest,int *w, int *h);
+ 
+   virtual void Suspend();
+   virtual bool Resume();
  };
  

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** mpeg2decoder.c	15 Jan 2005 09:29:29 -0000	1.13
--- mpeg2decoder.c	23 Jan 2005 14:54:22 -0000	1.14
***************
*** 44,47 ****
--- 44,54 ----
  #endif
  
+ //#define CMDDEB(out...) {printf("CMD[%04d]:",getTimeMilis() % 10000);printf(out);}
+ 
+ #ifndef CMDDEB
+ #define CMDDEB(out...)
+ #endif
+ 
+ 
  //#define AV_STATS
  
***************
*** 975,978 ****
--- 982,987 ----
  
  //----------------------------   create a new MPEG Decoder
+ 
+ 
  cMpeg2Decoder::cMpeg2Decoder(cAudioOut *AudioOut, cVideoOut *VideoOut)
  {
***************
*** 988,991 ****
--- 997,1001 ----
    running=false;
    decoding=false;
+   IsSuspended=false;
  }
  
***************
*** 1002,1005 ****
--- 1012,1020 ----
  void cMpeg2Decoder::Start(void)
  {
+   CMDDEB("Start IsSuspended %d \n",IsSuspended);
+   if (IsSuspended)
+     // don't start if we are suspended
+     return;
+ 
    // ich wei?? nicht, ob man's so kompliziert machen soll, aber jetzt hab ich's
    // schon so gemacht, das 2 Threads gestartet werden.
***************
*** 1011,1028 ****
  }
  
  void cMpeg2Decoder::Play(void)
  {
!   aout->Play();
!   vout->Play();
  };
  
  void cMpeg2Decoder::Freeze(void)
  {
!   aout->Freeze();
!   vout->Freeze();
  };
    
  void cMpeg2Decoder::Stop(void)
  {
    if (running)
    {
--- 1026,1085 ----
  }
  
+ void cMpeg2Decoder::Suspend()
+ {
+   CMDDEB("Suspend\n");
+   Stop();
+   audioOut->Suspend();
+   videoOut->Suspend();
+   IsSuspended=true;
+ }
+ 
+ void cMpeg2Decoder::Resume()
+ {
+   CMDDEB("Resume\n");
+   IsSuspended=false;
+   if (!videoOut->Resume()) {
+     fprintf(stderr,"Could not open video out! Sleeping again...\n");
+     videoOut->Suspend();
+     setupStore.shouldSuspend=true;
+     IsSuspended=true;
+     return;
+   };
+ 
+   if (!audioOut->Resume()) {
+    fprintf(stderr,"Could not open audio out! Sleeping again...\n");
+    setupStore.shouldSuspend=true;
+    IsSuspended=true;
+    videoOut->Suspend();
+    return;
+   };
+ 
+   Start();
+   IsSuspended=false;
+ }
+ 
  void cMpeg2Decoder::Play(void)
  {
!   CMDDEB("Play\n");
!   if (running) 
!   {
!     aout->Play();
!     vout->Play();
!   };
  };
  
  void cMpeg2Decoder::Freeze(void)
  {
!   CMDDEB("Freeze\n");
!   if (running) 
!   {
!     aout->Freeze();
!     vout->Freeze();
!   };
  };
    
  void cMpeg2Decoder::Stop(void)
  {
+   CMDDEB("Stop\n");
    if (running)
    {
***************
*** 1053,1073 ****
  void cMpeg2Decoder::Clear(void)
  {
!   aout->Clear();
!   vout->Clear();
  }
  
  void cMpeg2Decoder::TrickSpeed(int Speed)
  {
!   aout->TrickSpeed(Speed);
!   vout->TrickSpeed(Speed);
  }
  
  int64_t cMpeg2Decoder::GetSTC(void) {
!   return vout->GetPTS()*90;
  };
  
  bool cMpeg2Decoder::BufferFilled() 
  {
!   return vout->BufferFill()>95;
  }
  
--- 1110,1142 ----
  void cMpeg2Decoder::Clear(void)
  {
!   CMDDEB("Clear\n");
!   if (running)
!   {
!     aout->Clear();
!     vout->Clear();
!   };
  }
  
  void cMpeg2Decoder::TrickSpeed(int Speed)
  {
!   CMDDEB("TrickSpeed %d\n",Speed);
!   if (running)
!   {
!     aout->TrickSpeed(Speed);
!     vout->TrickSpeed(Speed);
!   };
  }
  
  int64_t cMpeg2Decoder::GetSTC(void) {
!   if (running)
!     return vout->GetPTS()*90;
!   else return 0;
  };
  
  bool cMpeg2Decoder::BufferFilled() 
  {
!   if (running)
!     return vout->BufferFill()>95;
!   else return false;
  }
  
***************
*** 1144,1148 ****
    }
  #if VDRVERSNUM >= 10318
!   aout->Write((uchar *)Data,Length);
  #endif
    return Length;
--- 1213,1218 ----
    }
  #if VDRVERSNUM >= 10318
!   if (running)
!     aout->Write((uchar *)Data,Length);
  #endif
    return Length;
***************
*** 1158,1168 ****
      int size=Length;
  
!   decoding=true;
    if (!running)
-   {
-     decoding=false;
      return Length;
-   }
  
    while (size > 0)
    {
--- 1228,1243 ----
      int size=Length;
  
!   if (running && !IsSuspended && setupStore.shouldSuspend)
!      // still running and should suspend
!      Suspend();
! 
!   if (!running && IsSuspended && !setupStore.shouldSuspend)
!      // not running and should resume
!      Resume();
!      
    if (!running)
      return Length;
  
+   decoding=true;
    while (size > 0)
    {

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** mpeg2decoder.h	13 Jan 2005 20:31:08 -0000	1.10
--- mpeg2decoder.h	23 Jan 2005 14:54:22 -0000	1.11
***************
*** 177,180 ****
--- 177,181 ----
      int             ac3Mode, ac3Parm, lpcmMode;
      bool running;
+     bool IsSuspended;
      bool decoding;
  public:
***************
*** 189,192 ****
--- 190,195 ----
      void Stop(void);
      void Clear(void);
+     void Suspend(void);
+     void Resume(void);
      void TrickSpeed(int Speed);
      bool BufferFilled(void);

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** Makefile	21 Dec 2004 05:55:42 -0000	1.4
--- Makefile	23 Jan 2005 14:54:22 -0000	1.5
***************
*** 37,40 ****
--- 37,43 ----
  LIBXDPMS_SUPPORT = 1
  
+ # Set this if you want to be able to toggle suspend mode by keyboard (XV only)
+ SUSPEND_BY_KEY = 1
+ 
  # Enable the usage from some deinterlacing pp-filters of libavcodec
  # ffmpeg must be compiled with the options --enable-pp --enable-gpl
***************
*** 179,182 ****
--- 182,189 ----
  DEFINES     += -DPP_LIBAVCODEC
  FFMPEGLIBS  += -lpostproc
+ endif
+ 
+ ifdef SUSPEND_BY_KEY
+ DEFINES     += -DSUSPEND_BY_KEY
  endif
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** CHANGELOG	15 Jan 2005 09:29:29 -0000	1.30
--- CHANGELOG	23 Jan 2005 14:54:22 -0000	1.31
***************
*** 1,4 ****
  Changelog
!   2005-01-15:
      - fix OSD drawing when multiple areas are used (with text2skin plugin)
      - dfb out: reverted top-field first setting as it may crash
--- 1,6 ----
  Changelog
!  2005-01-23:
!     - added suspend video playback patch. 
!  2005-01-15:
      - fix OSD drawing when multiple areas are used (with text2skin plugin)
      - dfb out: reverted top-field first setting as it may crash



From nobody at sheep.berlios.de  Sun Jan 23 15:56:10 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 23 Jan 2005 15:56:10 +0100
Subject: [Softdevice-cvs] softdevice audio.c,1.6,1.7 audio.h,1.2,1.3 setup-softdevice.c,1.7,1.8 setup-softdevice.h,1.4,1.5
Message-ID: <200501231456.j0NEuAN07844@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27046

Modified Files:
	audio.c audio.h setup-softdevice.c setup-softdevice.h 
Log Message:
-added playback suspend patch


Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** audio.c	21 Nov 2004 13:45:37 -0000	1.6
--- audio.c	23 Jan 2005 14:56:08 -0000	1.7
***************
*** 35,38 ****
--- 35,39 ----
        exit(1);
      }
+     chn=0;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
  }
***************
*** 42,45 ****
--- 43,63 ----
      snd_pcm_close(handle);
  }
+ 
+ void cAlsaAudioOut::Suspend() {
+   snd_pcm_close(handle);
+ }
+ 
+ bool cAlsaAudioOut::Resume() {
+    int err;
+    printf("Device %s\n",device);
+    if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
+      dsyslog("[softdevice-audio] Playback open error: %s, %s FATAL exiting",
+              device, snd_strerror(err));
+      return false;
+    }
+    //force setting of the parameters after resume 
+    chn=0;
+    return true;
+ };
  
  void cAlsaAudioOut::Write(uchar *Data, int Length)

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** audio.h	29 Oct 2004 16:41:39 -0000	1.2
--- audio.h	23 Jan 2005 14:56:08 -0000	1.3
***************
*** 28,31 ****
--- 28,35 ----
    virtual void Play(void)=0;
    virtual void SetVolume(int vol)=0;
+   virtual void Suspend(void) 
+   {return;};
+   virtual bool Resume(void) 
+   {return true;};
  };
  
***************
*** 51,54 ****
--- 55,60 ----
    virtual void Play(void);
    virtual void SetVolume(int vol);
+   virtual void Suspend(void);
+   virtual bool Resume(void);
  };
  #endif

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** setup-softdevice.c	13 Jan 2005 20:48:20 -0000	1.7
--- setup-softdevice.c	23 Jan 2005 14:56:08 -0000	1.8
***************
*** 66,69 ****
--- 66,77 ----
          NULL
       };
+ /* ----------------------------------------------------------------------------
+  */
+ char *suspendVideo [] = {
+         "playing",
+         "suspended",
+         NULL
+      };
+ 
  
  /* ----------------------------------------------------------------------------
***************
*** 112,115 ****
--- 120,124 ----
    syncOnFrames  = 0;
    avOffset      = 0;
+   shouldSuspend = 0;
  
    useMGAtv      = 0;
***************
*** 280,283 ****
--- 289,296 ----
                              videoAspectNames));
  
+   Add(new cMenuEditStraItem(tr("Playback"),
+                             &data->shouldSuspend,
+                             2,
+                             suspendVideo));
  }
  
***************
*** 332,334 ****
--- 345,348 ----
    SetupStore ("AlsaDevice",         setupStore.alsaDevice);
    SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
+   SetupStore ("Suspend",            setupStore.shouldSuspend);
  }

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** setup-softdevice.h	21 Dec 2004 05:55:42 -0000	1.4
--- setup-softdevice.h	23 Jan 2005 14:56:08 -0000	1.5
***************
*** 36,39 ****
--- 36,40 ----
      int   screenPixelAspect;
      int   useMGAtv;
+     int   shouldSuspend;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
  };



From nobody at sheep.berlios.de  Tue Feb  8 22:31:20 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 8 Feb 2005 22:31:20 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.31,1.32 video-dfb.c,1.15,1.16 video-xv.c,1.13,1.14
Message-ID: <200502082131.j18LVKN03472@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19816

Modified Files:
	CHANGELOG video-dfb.c video-xv.c 
Log Message:
    - dfb-out: fix for field parity in tv-out mode
    - xv-out: fix compile warnings on amd64 (reported by Konrad Naumann)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** CHANGELOG	23 Jan 2005 14:54:22 -0000	1.31
--- CHANGELOG	8 Feb 2005 21:31:17 -0000	1.32
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+  2005-02-08:
+     - dfb-out: fix for field parity in tv-out mode
+     - xv-out: fix compile warnings on amd64 (reported by Konrad Naumann)
   2005-01-23:
      - added suspend video playback patch. 

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video-dfb.c	15 Jan 2005 08:33:04 -0000	1.15
--- video-dfb.c	8 Feb 2005 21:31:17 -0000	1.16
***************
*** 253,257 ****
    DirectFB::Init();
    dfb = DirectFB::Create();
!   dfb->SetCooperativeLevel(DFSCL_FULLSCREEN);
    reportCardInfo (dfb);
  
--- 253,259 ----
    DirectFB::Init();
    dfb = DirectFB::Create();
!   if (!setupStore.useMGAtv)
!     dfb->SetCooperativeLevel(DFSCL_FULLSCREEN);
! 
    reportCardInfo (dfb);
  
***************
*** 300,306 ****
    scrDsc.pixelformat = DSPF_ARGB;
  
!   scrSurface   = dfb->CreateSurface (scrDsc);
  
!   if (!videoLayer) {
      fprintf(stderr,"[dfb]: could not find suitable videolayer\n");
      exit(1);
--- 302,356 ----
    scrDsc.pixelformat = DSPF_ARGB;
  
!   if (setupStore.useMGAtv)
!   {
!       DFBDisplayLayerConfig   dlc;
  
!     dlc.flags = (DFBDisplayLayerConfigFlags)
!                   (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
!     dlc.buffermode = DLBM_BACKVIDEO;
!     dlc.pixelformat = DSPF_ARGB;
!     dlc.options = DLOP_FIELD_PARITY;
! 
!     try
!     {
!       osdLayer->SetCooperativeLevel(DLSCL_EXCLUSIVE);
!       osdLayer->SetOpacity(0xff);
!     }
!     catch (DFBException *ex)
!     {
!       fprintf (stderr,
!                "Caught: action=%s, result=%s (could not set DLSCL_EXCLUSIVE)\n",
!                ex->GetAction(), ex->GetResult());
!     }
! 
!     try
!     {
!       osdLayer->SetConfiguration(dlc);
!     }
!     catch (DFBException *ex)
!     {
!       fprintf (stderr,"Caught: action=%s, result=%s\n",
!                ex->GetAction(), ex->GetResult());
!     }
! 
!     try
!     {
!       osdLayer->SetFieldParity(0);
!     }
!     catch (DFBException *ex)
!     {
!       fprintf (stderr,"Caught: action=%s, result=%s (could not set field parity)\n",
!                ex->GetAction(), ex->GetResult());
!     }
!     scrSurface = osdLayer->GetSurface();
! 
!   }
!   else
!   {
!     scrSurface   = dfb->CreateSurface (scrDsc);
!   }
! 
!   if (!videoLayer)
!   {
      fprintf(stderr,"[dfb]: could not find suitable videolayer\n");
      exit(1);
***************
*** 407,418 ****
      reportSurfaceCapabilities ("videoSurface:", videoSurface);
  
!     fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
!     videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
! 
!     fprintf(stderr,"[dfb] Configuring ColorKeying\n");
!     //videoLayer->SetDstColorKey(COLORKEY);
  
!     fprintf(stderr,"[dfb] Configuring CooperativeLevel for OSD\n");
!     osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
      desc = osdLayer->GetDescription();
--- 457,468 ----
      reportSurfaceCapabilities ("videoSurface:", videoSurface);
  
!     if (!setupStore.useMGAtv)
!     {
!       fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
!       videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
!       fprintf(stderr,"[dfb] Configuring CooperativeLevel for OSD\n");
!       osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
!     }
  
      desc = osdLayer->GetDescription();
***************
*** 425,429 ****
    
    /* create an event buffer with all devices attached */
!   events = dfb->CreateInputEventBuffer( DICAPS_ALL );
  }
  
--- 475,480 ----
    
    /* create an event buffer with all devices attached */
!   events = dfb->CreateInputEventBuffer(DICAPS_ALL,
!                                        (setupStore.useMGAtv) ? DFB_TRUE : DFB_FALSE);
  }
  
***************
*** 492,495 ****
--- 543,547 ----
          currentPixelFormat != setupStore.pixelFormat)
      {
+ 
        fprintf(stderr,
                "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
***************
*** 535,539 ****
                 dlc.flags   = (DFBDisplayLayerConfigFlags)
                                ((int) dlc.flags | DLCONF_OPTIONS);
!                dlc.options  = DLOP_FIELD_PARITY;
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 587,591 ----
                 dlc.flags   = (DFBDisplayLayerConfigFlags)
                                ((int) dlc.flags | DLCONF_OPTIONS);
!                dlc.options  = DLOP_FIELD_PARITY; //DLOP_NONE; //DLOP_FIELD_PARITY;
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
***************
*** 550,556 ****
        pixelformat = dlc.pixelformat;
  
        if (!useStretchBlit)
        {
-         desc = videoLayer->GetDescription();
          if (videoSurface)
            videoSurface->Release();
--- 602,609 ----
        pixelformat = dlc.pixelformat;
  
+       desc = videoLayer->GetDescription();
+ 
        if (!useStretchBlit)
        {
          if (videoSurface)
            videoSurface->Release();
***************
*** 564,568 ****
          if (desc.caps & DLCAPS_DEINTERLACING)
          {
- //        fprintf (stderr, "deinterlacing\n");
            /* ------------------------------------------------------------------
             * if deinterlacing is supported we'll use that
--- 617,620 ----
***************
*** 581,588 ****
          else
          {
- //          fprintf (stderr, "no alpha channel\n");
            if (desc.caps & DLCAPS_DST_COLORKEY)
            {
- //            fprintf (stderr, "dest color key\n");
              /* ----------------------------------------------------------------
               * no alpha channel but destination color keying is supported
--- 633,638 ----
***************
*** 631,634 ****
--- 681,689 ----
          if (desc.caps & DLCAPS_SCREEN_LOCATION)
          {
+           /* ------------------------------------------------------------------
+            * workaround for a bug in DirectFB: force SetScreenLocation to be
+            * executed always.
+            */
+           videoLayer->SetScreenLocation(0.0,0.0,0.5,0.5);
            videoLayer->SetScreenLocation((float) lxoff / (float) dwidth,
                                          (float) lyoff / (float) dheight,
***************
*** 653,657 ****
        {
          fprintf (stderr, "[dfb] creating new surface\n");
!         if (videoSurface) {
            /* ------------------------------------------------------------------
             * clear previous used surface. there were some troubles when we
--- 708,713 ----
        {
          fprintf (stderr, "[dfb] creating new surface\n");
!         if (videoSurface)
!         {
            /* ------------------------------------------------------------------
             * clear previous used surface. there were some troubles when we
***************
*** 663,669 ****
          }
  
-         //if (setupStore.useMGAtv)
-           //videoLayer->SetFieldParity(0);
- 
          videoSurface=NULL;
          videoSurface=dfb->CreateSurface(vidDsc);
--- 719,722 ----
***************
*** 999,1006 ****
          osdsrc.w = Xres;osdsrc.h=Yres;
          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
          scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
!       }
  
!       scrSurface->Flip(NULL, DSFLIP_ONSYNC);
  
        if (aspect_changed || osdClrBack)
--- 1052,1069 ----
          osdsrc.w = Xres;osdsrc.h=Yres;
          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
+ #if 0
+         /* --------------------------------------------------------------------
+          * test for OSD scaleinf to 4:3 aspect on a 16:9 tv
+          */
+           DFBRectangle  osddest;
+         osddest.x = 90; osddest.y = 0;
+         osddest.w = 540; osddest.h = Yres;
+         scrSurface->StretchBlit(osdSurface, &osdsrc, &osddest);
+ #else
          scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
! #endif
  
!       }
!       scrSurface->Flip(NULL, (setupStore.useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
  
        if (aspect_changed || osdClrBack)
***************
*** 1025,1029 ****
  cDFBVideoOut::~cDFBVideoOut()
  {
!     fprintf(stderr,"Releasing DFB\n");
!     if (dfb) dfb->Release();
  }
--- 1088,1098 ----
  cDFBVideoOut::~cDFBVideoOut()
  {
!   fprintf(stderr,"Releasing DFB\n");
! 
!   if (videoSurface) videoSurface->Release();
!   if (osdSurface)   osdSurface->Release();
!   if (scrSurface)   scrSurface->Release();
!   if (videoLayer)   videoLayer->Release ();
!   if (osdLayer)     osdLayer->Release();
!   if (dfb)          dfb->Release();
  }

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-xv.c	23 Jan 2005 14:54:22 -0000	1.13
--- video-xv.c	8 Feb 2005 21:31:17 -0000	1.14
***************
*** 726,731 ****
                                 width, height);
    if (osd_image) {
!     dsyslog("[XvVideoOut]: Initialize XShmCreateImage Successful (0x%08x)",
!             (unsigned int) osd_image);
    } else {
      dsyslog("[XvVideoOut]: Initialize ERROR: XShmCreateImage FAILED !");
--- 726,730 ----
                                 width, height);
    if (osd_image) {
!     dsyslog("[XvVideoOut]: Initialize XShmCreateImage Successful (%p)", osd_image);
    } else {
      dsyslog("[XvVideoOut]: Initialize ERROR: XShmCreateImage FAILED !");
***************
*** 750,754 ****
    osd_image->data = (char *) osd_buffer;
  
!   if ((int) osd_image->data == -1) {
      dsyslog("[XvVideoOut]: Initialize ERROR: shmat FAILED !");
    } else {
--- 749,753 ----
    osd_image->data = (char *) osd_buffer;
  
!   if (osd_image->data == (char *) -1L) {
      dsyslog("[XvVideoOut]: Initialize ERROR: shmat FAILED !");
    } else {
***************
*** 895,900 ****
  
    if (xv_image) {
!     dsyslog("[XvVideoOut]: XvShmCreateImage Successful (0x%08x)",
!             (unsigned int) xv_image);
    } else {
      dsyslog("[XvVideoOut]: ERROR: XvShmCreateImage FAILED !");
--- 894,898 ----
  
    if (xv_image) {
!     dsyslog("[XvVideoOut]: XvShmCreateImage Successful (%p)", xv_image);
    } else {
      dsyslog("[XvVideoOut]: ERROR: XvShmCreateImage FAILED !");
***************
*** 917,921 ****
    xv_image->data = (char *) outbuffer;
  
!   if ((int) xv_image->data == -1) {
      dsyslog("[XvVideoOut]: ERROR: shmat FAILED !");
    } else {
--- 915,919 ----
    xv_image->data = (char *) outbuffer;
  
!   if (xv_image->data == (char *) -1L) {
      dsyslog("[XvVideoOut]: ERROR: shmat FAILED !");
    } else {



From nobody at sheep.berlios.de  Sun Feb 13 19:12:34 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 13 Feb 2005 19:12:34 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.32,1.33 mpeg2decoder.c,1.14,1.15 mpeg2decoder.h,1.11,1.12
Message-ID: <200502131812.j1DICYN01078@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22343

Modified Files:
	CHANGELOG mpeg2decoder.c mpeg2decoder.h 
Log Message:
a/v sync: auto adjusting back index instead of using fixed value 4

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** CHANGELOG	8 Feb 2005 21:31:17 -0000	1.32
--- CHANGELOG	13 Feb 2005 18:12:31 -0000	1.33
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+  2005-02-13:
+     - a/v sync: auto adjusting back index instead of using fixed value 4
   2005-02-08:
      - dfb-out: fix for field parity in tv-out mode

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** mpeg2decoder.c	23 Jan 2005 14:54:22 -0000	1.14
--- mpeg2decoder.c	13 Feb 2005 18:12:31 -0000	1.15
***************
*** 355,358 ****
--- 355,365 ----
  {
    width = height = -1;
+   workBackIndex = currentBackIndex = 4;
+   newBackIndex = 0;
+   backIndexTab[0] = 0;
+   backIndexTab[1] = 1;
+   backIndexTab[2] = 2;
+   backIndexTab[3] = 2;
+   backIndexTab[4] = 4;
    pic_buf_lavc = pic_buf_mirror = pic_buf_pp = NULL;
    currentMirrorMode  = setupStore.mirror;
***************
*** 557,560 ****
--- 564,576 ----
  #endif
  
+   if (context->coded_frame->pict_type == FF_I_TYPE)
+   {
+     newBackIndex = 1;
+   }
+   else
+   {
+     newBackIndex++;
+   }
+ 
  #if 1 // new method for setting the video PTS
    if (picture->coded_picture_number)
***************
*** 562,571 ****
      if (picture->pict_type == FF_I_TYPE)
      {
  #if 0
        fprintf (stderr, " changing PTS from %lld to %lld. delta %lld\n",
                 pts, historyPTS[(historyPTSIndex+PTS_COUNT-4)%PTS_COUNT],
!                historyPTS[(historyPTSIndex+PTS_COUNT-4)%PTS_COUNT]-pts);
  #endif
!       pts = historyPTS[(historyPTSIndex+PTS_COUNT-4)%PTS_COUNT];
        //fprintf (stderr, "* using PTS value (%lld)\n", pts);
      }
--- 578,599 ----
      if (picture->pict_type == FF_I_TYPE)
      {
+       if (newBackIndex > 0 && newBackIndex <=4)
+       {
+         if (newBackIndex != currentBackIndex)
+         {
+           dsyslog("[mpeg2decoder]: back index change (%d -> %d(%d))\n",
+                   currentBackIndex,
+                   newBackIndex,
+                   backIndexTab[newBackIndex]);
+         }
+         currentBackIndex = newBackIndex;
+         workBackIndex = backIndexTab [currentBackIndex];
+       }
  #if 0
        fprintf (stderr, " changing PTS from %lld to %lld. delta %lld\n",
                 pts, historyPTS[(historyPTSIndex+PTS_COUNT-4)%PTS_COUNT],
!                historyPTS[(historyPTSIndex+PTS_COUNT-workBackIndex)%PTS_COUNT]-pts);
  #endif
!       pts = historyPTS[(historyPTSIndex+PTS_COUNT-workBackIndex)%PTS_COUNT];
        //fprintf (stderr, "* using PTS value (%lld)\n", pts);
      }

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** mpeg2decoder.h	23 Jan 2005 14:54:22 -0000	1.11
--- mpeg2decoder.h	13 Feb 2005 18:12:31 -0000	1.12
***************
*** 144,147 ****
--- 144,149 ----
      int                rtc_fd; 
      int                frametime;
+     int                 newBackIndex, currentBackIndex,
+                         workBackIndex, backIndexTab [5];
      int32_t GetRelTime();
     



From nobody at sheep.berlios.de  Fri Feb 18 14:31:29 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 18 Feb 2005 14:31:29 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.33,1.34 setup-softdevice.c,1.8,1.9 setup-softdevice.h,1.5,1.6 softdevice.c,1.12,1.13 utils.c,1.1.1.1,1.2 utils.h,1.1.1.1,1.2 video-dfb.c,1.16,1.17 video-fb.c,1.2,1.3 video-vidix.c,1.4,1.5 video-vidix.h,1.1.1.1,1.2 video-xv.c,1.14,1.15 video-xv.h,1.4,1.5 video.c,1.7,1.8 video.h,1.7,1.8
Message-ID: <200502181331.j1IDVTN16005@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32752

Modified Files:
	CHANGELOG setup-softdevice.c setup-softdevice.h softdevice.c 
	utils.c utils.h video-dfb.c video-fb.c video-vidix.c 
	video-vidix.h video-xv.c video-xv.h video.c video.h 
Log Message:
- software osd alpha blending & osd scaling patch


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** CHANGELOG	13 Feb 2005 18:12:31 -0000	1.33
--- CHANGELOG	18 Feb 2005 13:31:26 -0000	1.34
***************
*** 1,3 ****
--- 1,9 ----
  Changelog
+  2005-02-18:
+     - support for DIRECTCOLOR framebuffer ( most ATI cards, tested with Mach64)
+     - fixed osd flickering in framebuffer mode vdr>1.3.7
+     - software alpha blending implemented for Vidix (vdr>1.3.7)
+     - software alpha blending done in software for Xv out and vdr>1.3.7
+     - osd scaling for vdr and Xv >1.3.7
   2005-02-13:
      - a/v sync: auto adjusting back index instead of using fixed value 4

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** setup-softdevice.c	23 Jan 2005 14:56:08 -0000	1.8
--- setup-softdevice.c	18 Feb 2005 13:31:26 -0000	1.9
***************
*** 74,77 ****
--- 74,84 ----
       };
  
+ /* ----------------------------------------------------------------------------
+  */
+ char *osdMode [] = {
+         "pseudo",
+         "software",
+         NULL
+      };
  
  /* ----------------------------------------------------------------------------
***************
*** 196,200 ****
      screenPixelAspect = atoi (Value);
      screenPixelAspect = clamp (0, screenPixelAspect, 4);
!   } else return false;
  
    return true;
--- 203,210 ----
      screenPixelAspect = atoi (Value);
      screenPixelAspect = clamp (0, screenPixelAspect, 4);
!   } else if (!strcasecmp(Name, "OSDalphablend")) {
!     osdMode = atoi (Value);
!     osdMode = clamp (0, osdMode, 1);
!   } else  return false;
  
    return true;
***************
*** 293,296 ****
--- 303,310 ----
                              2,
                              suspendVideo));
+   Add(new cMenuEditStraItem(tr("OSD alpha blending"),
+                             &data->osdMode,
+                             2,
+                             osdMode));
  }
  
***************
*** 346,348 ****
--- 360,363 ----
    SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
    SetupStore ("Suspend",            setupStore.shouldSuspend);
+   SetupStore ("OSDalphablend",      setupStore.osdMode);
  }

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** setup-softdevice.h	23 Jan 2005 14:56:08 -0000	1.5
--- setup-softdevice.h	18 Feb 2005 13:31:27 -0000	1.6
***************
*** 37,43 ****
--- 37,46 ----
      int   useMGAtv;
      int   shouldSuspend;
+     int   osdMode;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
  };
  
+ #define OSDMODE_PSEUDO    0
+ #define OSDMODE_SOFTWARE  1
  
  /* ---------------------------------------------------------------------------

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** softdevice.c	15 Jan 2005 08:33:04 -0000	1.12
--- softdevice.c	18 Feb 2005 13:31:27 -0000	1.13
***************
*** 156,159 ****
--- 156,160 ----
  {
      osd = new cSoftOsd(videoOut, Left, Top);
+     videoOut->SetOsd(osd);
      return osd;
  }

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** utils.c	1 Aug 2004 05:07:05 -0000	1.1.1.1
--- utils.c	18 Feb 2005 13:31:27 -0000	1.2
***************
*** 22,25 ****
--- 22,26 ----
  
  #define VERT_SCALING
+ void (*mmx_unpack)(uint8_t * image, int lines, int stride);
  
  static inline void mmx_yuv2rgb (uint8_t * py, uint8_t * pu, uint8_t * pv)
***************
*** 101,105 ****
  
  
! static inline void mmx_unpack_16rgb (uint8_t * image, int lines, int stride)
  {
      static mmx_t mmx_bluemask = {0xf8f8f8f8f8f8f8f8ll};
--- 102,106 ----
  
  
! void mmx_unpack_16rgb (uint8_t * image, int lines, int stride)
  {
      static mmx_t mmx_bluemask = {0xf8f8f8f8f8f8f8f8ll};
***************
*** 135,147 ****
      psllq_i2r (3, mm7);
  
- 
      
      // jetzt muss ich die an bestimmten Stellen verdoppeln.
-     
      movntq (mm0, *(image));
  
      punpckhbw_r2r (mm1, mm5);
      por_r2r (mm7, mm5);
  
      movntq (mm5, *(image+8));
      while(--lines) { // write the same in the line above
--- 136,197 ----
      psllq_i2r (3, mm7);
  
      
      // jetzt muss ich die an bestimmten Stellen verdoppeln.
      movntq (mm0, *(image));
  
      punpckhbw_r2r (mm1, mm5);
      por_r2r (mm7, mm5);
+     
+     movntq (mm5, *(image+8));
+     while(--lines) { // write the same in the line above
+       image -= stride;
+       movntq (mm0, *(image));
+       movntq (mm5, *(image+8));
+     }
+ 
+ }
+ 
+ void mmx_unpack_15rgb (uint8_t * image, int lines, int stride)
+ {
+     static mmx_t mmx_bluemask = {0xf8f8f8f8f8f8f8f8ll};
+     static mmx_t mmx_greenmask = {0xf8f8f8f8f8f8f8f8ll};
+     static mmx_t mmx_redmask = {0xf8f8f8f8f8f8f8f8ll};
+ 
+     /*
+      * convert RGB plane to RGB 16 bits
+      * mm0 -> B, mm1 -> R, mm2 -> G
+      * mm4 -> GB, mm5 -> AR pixel 4-7
+      * mm6 -> GB, mm7 -> AR pixel 0-3
+      */
+ 
+     pand_m2r (mmx_bluemask, mm0);       // mm0 = b7b6b5b4b3______
+     pxor_r2r (mm4, mm4);                // mm4 = 0
+ 
+     pand_m2r (mmx_greenmask, mm2);      // mm2 = g7g6g5g4g3g2____
+     psrlq_i2r (2, mm0);                 // mm0 = ______b7b6b5b4b3
+ 
+     movq_r2r (mm2, mm7);                // mm7 = g7g6g5g4g3g2____
+     movq_r2r (mm0, mm5);                // mm5 = ______b7b6b5b4b3
+ 
+     pand_m2r (mmx_redmask, mm1);        // mm1 = r7r6r5r4r3______
+     punpcklbw_r2r (mm4, mm2);
  
+     punpcklbw_r2r (mm1, mm0);
+ 
+     psllq_i2r (3, mm2);
+ 
+     punpckhbw_r2r (mm4, mm7);
+     por_r2r (mm2, mm0);
+ 
+     psllq_i2r (3, mm7);
+     
+     // jetzt muss ich die an bestimmten Stellen verdoppeln.
+     psrlq_i2r(1,mm0);//MW 
+     movntq (mm0, *(image));
+ 
+     punpckhbw_r2r (mm1, mm5);
+     por_r2r (mm7, mm5);
+     
+     psrlq_i2r(1,mm5); //MW
      movntq (mm5, *(image+8));
      while(--lines) { // write the same in the line above
***************
*** 227,238 ****
        if (!m) { // no mask given
          mmx_yuv2rgb (sY, sU, sV);
!         mmx_unpack_16rgb (IM, lines, rgb_stride);
        } else { // mask given
          if (*m != 0xFF) { // not all bits masked
            mmx_yuv2rgb (sY, sU, sV);
            if (*m == 0) { // no bit is masked
!             mmx_unpack_16rgb (IM, lines, rgb_stride);
            } else { // at least one bit is masked
!             mmx_unpack_16rgb ((uint8_t *)pix, 1, rgb_stride);
              for (int i = 0; i < 8; i++) {
                if (! (*m & (1 << i)) ) {
--- 277,288 ----
        if (!m) { // no mask given
          mmx_yuv2rgb (sY, sU, sV);
!         mmx_unpack (IM, lines, rgb_stride);
        } else { // mask given
          if (*m != 0xFF) { // not all bits masked
            mmx_yuv2rgb (sY, sU, sV);
            if (*m == 0) { // no bit is masked
!             mmx_unpack (IM, lines, rgb_stride);
            } else { // at least one bit is masked
!             mmx_unpack ((uint8_t *)pix, lines, rgb_stride);
              for (int i = 0; i < 8; i++) {
                if (! (*m & (1 << i)) ) {

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** utils.h	1 Aug 2004 05:07:05 -0000	1.1.1.1
--- utils.h	18 Feb 2005 13:31:27 -0000	1.2
***************
*** 31,34 ****
--- 31,40 ----
  uint64_t getTimeMilis(void);
  
+ void mmx_unpack_16rgb (uint8_t * image, int lines, int stride);
+ void mmx_unpack_15rgb (uint8_t * image, int lines, int stride);
+ void mmx_unpack_24rgb (uint8_t * image, int lines, int stride);
+ extern void (*mmx_unpack)(uint8_t * image, int lines, int stride);
+ 
+ 
  #endif
  

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video-dfb.c	8 Feb 2005 21:31:17 -0000	1.16
--- video-dfb.c	18 Feb 2005 13:31:27 -0000	1.17
***************
*** 775,778 ****
--- 775,781 ----
      IDirectFBSurface  *tmpSurface;
  
+   // don't update only dirty areas 
+   OSDdirty=true;
+ 
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
***************
*** 802,805 ****
--- 805,809 ----
      //tmpSurface->Flip();
    }
+     OSDpresent = true;
  }
  

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-fb.c	21 Dec 2004 05:55:42 -0000	1.2
--- video-fb.c	18 Feb 2005 13:31:27 -0000	1.3
***************
*** 17,21 ****
  #include "video-fb.h"
  #include "utils.h"
! 
  
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 17,21 ----
  #include "video-fb.h"
  #include "utils.h"
! #include "setup-softdevice.h"
  
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 26,43 ****
  
      if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
! 	printf("[video-fb] cant open framebuffer %s\n", FBDEV);
! 	exit(1);
      }
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
          printf("[video-fb] Can't get VSCREENINFO\n");
! 	exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
! 	printf("[video-fb] Can't get FSCREENINFO\n");
! 	exit(1);
      }
  
      fb_orig_vinfo = fb_vinfo;
  
      // currently we support only 16 bit FB's
--- 26,101 ----
  
      if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
!         printf("[video-fb] cant open framebuffer %s\n", FBDEV);
!         exit(1);
      }
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
          printf("[video-fb] Can't get VSCREENINFO\n");
!         exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         printf("[video-fb] Can't get FSCREENINFO\n");
!         exit(1);
      }
  
      fb_orig_vinfo = fb_vinfo;
+          
+     switch (fb_finfo.visual) {
+ 
+        case FB_VISUAL_TRUECOLOR:
+            printf("[video-fb] Truecolor FB found\n");
+            break;
+ 
+        case FB_VISUAL_DIRECTCOLOR:
+ 
+            struct fb_cmap cmap;
+            __u16 red[256], green[256], blue[256];
+ 
+            printf("[video-fb] DirectColor FB found\n");
+ 
+            orig_cmaplen = 32;
+            orig_cmap = (__u16 *) malloc ( 3 * orig_cmaplen * sizeof(*orig_cmap) );
+ 
+            if ( orig_cmap == NULL ) {
+                printf("cFBVideoOut: Can't alloc memory for cmap\n");
+                exit(1);
+            }
+            cmap.start  = 0;
+            cmap.len    = orig_cmaplen;
+            cmap.red    = &orig_cmap[0*orig_cmaplen];
+            cmap.green  = &orig_cmap[1*orig_cmaplen];
+            cmap.blue   = &orig_cmap[2*orig_cmaplen];
+            cmap.transp = NULL;
+ 
+            if ( ioctl(fbdev, FBIOGETCMAP, &cmap)) {
+                printf("cFBVideoOut: Can't get cmap\n");
+                exit(-1);
+            }
+ 
+            for ( int i=0; i < orig_cmaplen; ++i ) {
+                red[i]   = (65535/(orig_cmaplen+1))*i;
+                green[i] = (65535/(orig_cmaplen+1))*i;
+                blue[i] =  (65535/(orig_cmaplen+1))*i;
+                //(i<<8)|i;
+            }
+ 
+            cmap.start  = 0;
+            cmap.len    = orig_cmaplen;
+            cmap.red    = red;
+            cmap.green  = green;
+            cmap.blue   = blue;
+            cmap.transp = NULL;
+ 
+            if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
+                printf("cVidixVideoOut: Can't put cmap\n");
+                exit(-1);
+            }
+ 
+            break;
+ 
+        default:
+            printf("cFBVideoOut: Unsupported FB. Don't know if it will work.\n");
+     }
+ 
  
      // currently we support only 16 bit FB's
***************
*** 46,51 ****
      line_len = fb_finfo.line_length;
      if ((fb = (unsigned char *) mmap(0, size, PROT_READ | PROT_WRITE, MAP_SHARED, fbdev, 0)) == (unsigned char *) -1) {
! 	printf("[video-fb] Can't mmap\n");
! 	exit(1);
      }
  
--- 104,109 ----
      line_len = fb_finfo.line_length;
      if ((fb = (unsigned char *) mmap(0, size, PROT_READ | PROT_WRITE, MAP_SHARED, fbdev, 0)) == (unsigned char *) -1) {
!         printf("[video-fb] Can't mmap\n");
!         exit(1);
      }
  
***************
*** 54,61 ****
      Bpp = fb_vinfo.bits_per_pixel;
      if (Bpp != 16 && Bpp != 15) {
! 	printf ("[video-fb] In software-mode only 15/16 bit Framebuffer supported\n");
! 	exit(1);
      }
  #if VDRVERSNUM < 10307
      PixelMask = (unsigned char *)malloc(Yres*line_len / ((Bpp+7) / 8) / 8); // where the Video window should be transparent
  #endif
--- 112,130 ----
      Bpp = fb_vinfo.bits_per_pixel;
      if (Bpp != 16 && Bpp != 15) {
!         printf ("[video-fb] In software-mode only 15/16 bit Framebuffer supported\n");
!         exit(1);
      }
+ 
+     // set rgb unpack method
+     mmx_unpack=mmx_unpack_16rgb;
+     if (fb_vinfo.red.length==5 && fb_vinfo.green.length==5 
+          && fb_vinfo.blue.length==5 ) {
+       mmx_unpack=mmx_unpack_15rgb;
+       printf("[video-fb] Using mmx_unpack_15rgb\n");
+     };
+       
  #if VDRVERSNUM < 10307
+     PixelMask = (unsigned char *)malloc(Xres*Yres/8 ); // where the Video window should be transparent
+ #else
      PixelMask = (unsigned char *)malloc(Yres*line_len / ((Bpp+7) / 8) / 8); // where the Video window should be transparent
  #endif
***************
*** 69,74 ****
      fbinit=fb;
      for (int i = 0; i <Yres*line_len; i++) {
! 	*fbinit=0;
! 	fbinit++;
      }
      screenPixelAspect = -1;
--- 138,143 ----
      fbinit=fb;
      for (int i = 0; i <Yres*line_len; i++) {
!         *fbinit=0;
!         fbinit++;
      }
      screenPixelAspect = -1;
***************
*** 79,90 ****
  }
  
- 
  #if VDRVERSNUM >= 10307
  void cFBVideoOut::Refresh(cBitmap *Bitmap)
  {
    Draw(Bitmap,fb,line_len);
  }
  
  #else
  void cFBVideoOut::Refresh()
  {
--- 148,180 ----
  }
  
  #if VDRVERSNUM >= 10307
+ /* ---------------------------------------------------------------------------
+  */
+ void cFBVideoOut::ClearOSD()
+ {
+   cVideoOut::ClearOSD();
+   if (PixelMask) 
+     memset(PixelMask, 0, Xres * Yres/8);
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
+    switch (current_osdMode) {
+       case OSDMODE_PSEUDO :
+                 OsdWidth=Xres;
+                 OsdHeight=Yres;
+              break;
+     };
+ };
+ 
  void cFBVideoOut::Refresh(cBitmap *Bitmap)
  {
+   OSDpresent=true;
    Draw(Bitmap,fb,line_len);
  }
  
  #else
+ 
  void cFBVideoOut::Refresh()
  {
***************
*** 113,121 ****
    pthread_mutex_lock(&fb_mutex);
    if (OSDpresent) {
- #if VDRVERSNUM < 10307
      yuv_to_rgb (fb, Py, Pu, Pv, Width, Height, line_len,Ystride,UVstride,Xres,Yres,Bpp, PixelMask);
- #else
-     yuv_to_rgb (fb, Py, Pu, Pv, Width, Height, line_len,Ystride,UVstride,Xres,Yres,Bpp, NULL);
- #endif
    } else {
      yuv_to_rgb (fb, Py, Pu, Pv, Width, Height, line_len,Ystride,UVstride,Xres,Yres,Bpp, NULL);
--- 203,207 ----
***************
*** 126,129 ****
--- 212,239 ----
  cFBVideoOut::~cFBVideoOut()
  {
+     switch (fb_finfo.visual) {
+        case FB_VISUAL_DIRECTCOLOR:
+        {
+            struct fb_cmap cmap;
+ 
+            if ( orig_cmap ) {
+ 
+                cmap.start  = 0;
+                cmap.len    = orig_cmaplen;
+                cmap.red    = &orig_cmap[0*orig_cmaplen];
+                cmap.green  = &orig_cmap[1*orig_cmaplen];
+                cmap.blue   = &orig_cmap[2*orig_cmaplen];
+                cmap.transp = NULL;
+ 
+                if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
+                    printf("cFBVideoOut : Can't put cmap\n");
+                }
+ 
+                free(orig_cmap);
+                orig_cmap = NULL;
+            }
+            break;
+        }
+   }
    if (fbdev)
      close(fbdev);

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-vidix.c	21 Dec 2004 05:55:42 -0000	1.4
--- video-vidix.c	18 Feb 2005 13:31:27 -0000	1.5
***************
*** 15,28 ****
  #include "setup-softdevice.h"
  
! cVidixVideoOut::cVidixVideoOut()
  {
      int err;
      if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
! 	printf("cVidixVideoOut: Can't open framebuffer\n");
          exit(1);
      }
      
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
! 	printf("cVidixVideoOut: Can't get VSCREENINFO\n");
          exit(1);
      }
--- 15,39 ----
  #include "setup-softdevice.h"
  
! //#define TIMINGS
! 
! #ifdef TIMINGS
! uint64_t startTime;
! #define START startTime=getTimeMilis()
! #define TIMINGS(out...)  {printf("time %d: ",getTimeMilis()-startTime);printf(out);}
! #else
! #define TIMINGS(out...)
! #define START
! #endif
! 
! cVidixVideoOut::cVidixVideoOut() : cVideoOut()
  {
      int err;
      if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
!         printf("cVidixVideoOut: Can't open framebuffer\n");
          exit(1);
      }
      
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         printf("cVidixVideoOut: Can't get VSCREENINFO\n");
          exit(1);
      }
***************
*** 31,35 ****
          exit(1);
      }
! 	         
      switch (fb_finfo.visual) {
  
--- 42,46 ----
          exit(1);
      }
!          
      switch (fb_finfo.visual) {
  
***************
*** 139,143 ****
         exit(1);
      }
! 
      OSDpseudo_alpha = true;
  
--- 150,155 ----
         exit(1);
      }
!     printf("cVidixVideoOut: capabilities:  0x%0x\n", vidix_cap.flags );
!     
      OSDpseudo_alpha = true;
  
***************
*** 166,174 ****
      vidix_play.dest.w       = Xres;
      vidix_play.dest.h       = Yres;
!     vidix_play.num_frames   = 1;
! 
  
      if( vidix_fourcc.flags & VID_CAP_COLORKEY )
      {
         vdlGetGrKeys(vidix_handler, &gr_key);
  
--- 178,188 ----
      vidix_play.dest.w       = Xres;
      vidix_play.dest.h       = Yres;
!     vidix_play.num_frames   = 2;
!     //vidix_play.num_frames   = 1;
  
+     printf("cVidixVideoOut: fourcc.flags:  0x%0x\n",vidix_fourcc.flags);
      if( vidix_fourcc.flags & VID_CAP_COLORKEY )
      {
+        printf("cVidixVideoOut: set colorkey\n");
         vdlGetGrKeys(vidix_handler, &gr_key);
  
***************
*** 176,183 ****
  
         gr_key.ckey.op = CKEY_TRUE;
!        gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
  
         vdlSetGrKeys(vidix_handler, &gr_key);
      }
  }
  
--- 190,201 ----
  
         gr_key.ckey.op = CKEY_TRUE;
!        gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 32;
  
         vdlSetGrKeys(vidix_handler, &gr_key);
      }
+   //start osd refresh thread
+   active=true;
+   Start();
+ 
  }
  
***************
*** 192,196 ****
      uint32_t apitch;
      int hi, wi;
! 
      if (aspect_changed || currentPixelFormat != setupStore.pixelFormat)
      {
--- 210,216 ----
      uint32_t apitch;
      int hi, wi;
!     START;
!     TIMINGS("start...\n");
!     
      if (aspect_changed || currentPixelFormat != setupStore.pixelFormat)
      {
***************
*** 245,248 ****
--- 265,281 ----
             exit(1);
         }
+   
+        if( vidix_fourcc.flags & VID_CAP_COLORKEY )
+        {
+          printf("cVidixVideoOut: set colorkey\n");
+          vdlGetGrKeys(vidix_handler, &gr_key);
+ 
+          gr_key.key_op = KEYS_PUT;
+ 
+          gr_key.ckey.op = CKEY_TRUE;
+          gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0xff;
+ 
+          vdlSetGrKeys(vidix_handler, &gr_key);
+        }
  
         next_frame = 0;
***************
*** 285,289 ****
         printf("cVidixVideoOut : dstrides.v=%d\n", dstrides.v);
      }
! 
      // Plane Y
      dst = (uint8_t *) vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.y;
--- 318,323 ----
         printf("cVidixVideoOut : dstrides.v=%d\n", dstrides.v);
      }
!     TIMINGS("after if, before Y\n");
!     
      // Plane Y
      dst = (uint8_t *) vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.y;
***************
*** 293,302 ****
      Pu += (UVstride * syoff/2);
  
      for(hi=0; hi < sheight; hi++){
!        memcpy(dst, Py+sxoff, swidth);
!         Py  += Ystride;
!         dst += dstrides.y;
!     }
! 
      if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
      {
--- 327,352 ----
      Pu += (UVstride * syoff/2);
  
+ #if VDRVERSNUM >= 10307
+     OsdRefreshCounter=0;
+     if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
+        for(hi=0; hi < sheight; hi++){
+            AlphaBlend(dst,OsdPy+hi*OSD_FULL_WIDTH,
+             Py + sxoff,
+             OsdPAlphaY+hi*OSD_FULL_WIDTH,swidth);
+           Py  += Ystride;
+           dst += dstrides.y;
+   
+        }
+        EMMS;
+     } else
+ #endif
      for(hi=0; hi < sheight; hi++){
!          memcpy(dst, Py+sxoff, swidth);
!          Py  += Ystride;
!           dst += dstrides.y;
!       }
!     
!     TIMINGS("Before YUV\n");
!     
      if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
      {
***************
*** 314,344 ****
         }
      } else {
!        // Plane U
!        dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
  
!        for(hi=0; hi < sheight/2; hi++) {
                 memcpy(dst, Pu+sxoff/2, swidth/2);
                 Pu   += UVstride;
                 dst += dstrides.u / 2;
!        }
  
!        // Plane V
!        dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!        for(hi=0; hi < sheight/2; hi++) {
!                memcpy(dst, Pv+sxoff/2, swidth/2);
!                Pv   += UVstride;
!                dst += dstrides.v / 2;
         }
      }
  
      vdlPlaybackFrameSelect(vidix_handler, next_frame);
      next_frame = (next_frame+1) % vidix_play.num_frames;
  }
  
  #if VDRVERSNUM >= 10307
  
  void cVidixVideoOut::Refresh(cBitmap *Bitmap)
  {
!   Draw(Bitmap,fb,fb_line_len);
  }
  
--- 364,454 ----
         }
      } else {
!       
!       // Plane U
!       dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
  
! #if VDRVERSNUM >= 10307
!       if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) { 
!          for(hi=0; hi < sheight/2; hi++){
!              AlphaBlend(dst,OsdPu+hi*OSD_FULL_WIDTH/2,
!                Pu + sxoff/2,
!                OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,swidth/2);
!              Pu  += UVstride;
!              dst += dstrides.y / 2;
!          }
!          
!          // Plane V
!          dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!          for(hi=0; hi < sheight/2; hi++) {
!                  AlphaBlend(dst, OsdPv+hi*OSD_FULL_WIDTH/2,
!                    Pv + sxoff/2, 
!                    OsdPAlphaUV+hi*OSD_FULL_WIDTH/2, swidth/2);
!                  Pv   += UVstride;
!                  dst += dstrides.v / 2;
!          }
! 
!          EMMS;
!      } else 
! #endif
!      {
!         for(hi=0; hi < sheight/2; hi++) {
                 memcpy(dst, Pu+sxoff/2, swidth/2);
                 Pu   += UVstride;
                 dst += dstrides.u / 2;
!          }
  
!          // Plane V
!          dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!          for(hi=0; hi < sheight/2; hi++) {
!                 memcpy(dst, Pv+sxoff/2, swidth/2);
!                 Pv   += UVstride;
!                 dst += dstrides.v / 2;
!          }
         }
      }
  
+     TIMINGS("After UV\n");
      vdlPlaybackFrameSelect(vidix_handler, next_frame);
      next_frame = (next_frame+1) % vidix_play.num_frames;
+     TIMINGS("End\n");
  }
  
  #if VDRVERSNUM >= 10307
  
+ /* ---------------------------------------------------------------------------
+  */
+ void cVidixVideoOut::ClearOSD()
+ {
+   cVideoOut::ClearOSD();
+   if (current_osdMode==OSDMODE_PSEUDO)
+     memset(fb, 0, fb_line_len * Yres);
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVidixVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
+    switch (current_osdMode) {
+       case OSDMODE_PSEUDO :
+                 OsdWidth=Xres;//*9/10;
+                 OsdHeight=Yres;//*9/10;
+              break;
+       case OSDMODE_SOFTWARE:
+                 OsdWidth=swidth;//*9/10;
+                 OsdHeight=sheight;//*9/10;
+              break;
+     };
+ };
+ 
+ 
  void cVidixVideoOut::Refresh(cBitmap *Bitmap)
  {
!     switch (current_osdMode) {
!       case OSDMODE_PSEUDO :
!               Draw(Bitmap, fb,fb_line_len);
!             break;
!       case OSDMODE_SOFTWARE:
!               ToYUV(Bitmap);
!             break;
!     };
  }
  
***************
*** 358,361 ****
--- 468,472 ----
  void cVidixVideoOut::CloseOSD()
  {
+     cVideoOut::CloseOSD();
      memset(fb, 0, fb_line_len * Yres);
  }

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** video-vidix.h	1 Aug 2004 05:07:04 -0000	1.1.1.1
--- video-vidix.h	18 Feb 2005 13:31:27 -0000	1.2
***************
*** 45,49 ****
--- 45,51 ----
  
  #if VDRVERSNUM >= 10307
+   virtual void ClearOSD();
    virtual void Refresh(cBitmap *Bitmap);
+   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight); 
  #else
    virtual void Refresh();

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** video-xv.c	8 Feb 2005 21:31:17 -0000	1.14
--- video-xv.c	18 Feb 2005 13:31:27 -0000	1.15
***************
*** 614,617 ****
--- 614,620 ----
      lwidth = dwidth = XV_DEST_WIDTH_16_9;
    }
+   //start osd refresh thread
+   active=true;
+   Start();
  }
  
***************
*** 944,948 ****
                       lwidth, lheight,   /* dw, dh */
                       False);
- 		     
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
    
--- 947,950 ----
***************
*** 959,964 ****
  /* ---------------------------------------------------------------------------
   */
! cXvVideoOut::cXvVideoOut()
  {
  }
  
--- 961,969 ----
  /* ---------------------------------------------------------------------------
   */
! cXvVideoOut::cXvVideoOut() : cVideoOut()
  {
+   //start osd refresh thread
+   active=true;
+   Start();  
  }
  
***************
*** 1021,1025 ****
  void cXvVideoOut::CloseOSD()
  {
!   OSDpresent=false;
  #if VDRVERSNUM < 10307
    for (int i = 0; i < MAXNUMWINDOWS; i++)
--- 1026,1031 ----
  void cXvVideoOut::CloseOSD()
  {
!   cVideoOut::CloseOSD();
!   osdMutex.Lock();
  #if VDRVERSNUM < 10307
    for (int i = 0; i < MAXNUMWINDOWS; i++)
***************
*** 1041,1047 ****
--- 1047,1078 ----
      pthread_mutex_unlock(&xv_mutex);
    }
+   osdMutex.Unlock();
  }
  
  #if VDRVERSNUM >= 10307
+ /* ---------------------------------------------------------------------------
+  */
+ void cXvVideoOut::ClearOSD()
+ {
+   cVideoOut::ClearOSD();
+   if (initialized && current_osdMode==OSDMODE_PSEUDO)
+     memset (osd_buffer, 0, osd_image->bytes_per_line * height);
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ 
+ void cXvVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
+    switch (current_osdMode) {
+       case OSDMODE_PSEUDO :
+                 OsdWidth=lwidth;//*9/10;
+                 OsdHeight=lheight;//*9/10;
+              break;
+       case OSDMODE_SOFTWARE:
+                 OsdWidth=swidth;//*9/10;
+                 OsdHeight=sheight;//*9/10;
+              break;
+     };
+ };
  
  /* ---------------------------------------------------------------------------
***************
*** 1053,1060 ****
    if (!initialized)
      return;
!   if (OSDpresent)
    {
!     Draw(Bitmap, osd_buffer, osd_image->bytes_per_line);
! 
      pthread_mutex_lock(&xv_mutex);
      ++osd_refresh_counter;
--- 1084,1098 ----
    if (!initialized)
      return;
! //  if (OSDpresent)
    {
!     switch (current_osdMode) {
!       case OSDMODE_PSEUDO :
!               Draw(Bitmap, osd_buffer, osd_image->bytes_per_line);
!             break;
!       case OSDMODE_SOFTWARE:
!               ToYUV(Bitmap);
!             break;
!     };
!     
      pthread_mutex_lock(&xv_mutex);
      ++osd_refresh_counter;
***************
*** 1063,1066 ****
--- 1101,1105 ----
      osd_w = OSDw;
      osd_h = OSDh;
+     //OSDpresent=true;
      pthread_mutex_unlock(&xv_mutex);
    }
***************
*** 1134,1147 ****
    if (OSDpresent) {
      if (osd_refresh_counter) {
!       if (osd_skip_counter > skip) {
          XShmPutImage (dpy, win, gc, osd_image,
!                       osd_x, osd_y,
!                       osd_x + (dwidth - width) / 2,
!                       osd_y + (dheight - height) / 2,
                        osd_w, osd_h,
                        False);
          if (do_sync)
            XSync(dpy, False);
          osd_skip_counter = 0;
        } else {
          osd_skip_counter++;
--- 1173,1194 ----
    if (OSDpresent) {
      if (osd_refresh_counter) {
!       if (current_osdMode==OSDMODE_PSEUDO && osd_skip_counter > skip) {
!       
!         int x= lwidth > OSD_FULL_WIDTH ? osd_x + (dwidth - width) / 2:
!                 osd_x * lwidth/OSD_FULL_WIDTH *9/10;
!         int y= lheight > OSD_FULL_HEIGHT ? osd_y + (dheight - height) / 2:
!                 osd_y * lheight/OSD_FULL_HEIGHT *9/10;
! 
          XShmPutImage (dpy, win, gc, osd_image,
!                       osd_x, 
!                       osd_y,
!                       x,y,
                        osd_w, osd_h,
                        False);
+ 
          if (do_sync)
            XSync(dpy, False);
          osd_skip_counter = 0;
+         //osd_refresh_counter--;
        } else {
          osd_skip_counter++;
***************
*** 1159,1163 ****
    if (!initialized || !xv_initialized)
      return;
! 
    /* -------------------------------------------------------------------------
     * don't know where those funny stride values (752,376) come from.
--- 1206,1212 ----
    if (!initialized || !xv_initialized)
      return;
! #if VDRVERSNUM >= 10307
!   OsdRefreshCounter=0;
!   
    /* -------------------------------------------------------------------------
     * don't know where those funny stride values (752,376) come from.
***************
*** 1166,1185 ****
     * unusual resolutions they should be configurable swidth/sheight ?
     */
-   for (int i = 0; i < fheight; i++)
-   {
-     memcpy (pixels [0] + i * width, Py + i * Ystride, fwidth);
-   }
  
!   for (int i = 0; i < fheight / 2; i++)
!   {
!     memcpy (pixels [1] + i * width / 2, Pv + i * UVstride, fwidth / 2);
!   }
  
-   for (int i = 0; i < fheight / 2; i++)
-   {
-     memcpy (pixels [2] + i * width / 2, Pu + i * UVstride, fwidth / 2);
    }
!   pthread_mutex_lock(&xv_mutex);
!   XvShmPutImage(dpy, port,
                  win, gc,
                  xv_image,
--- 1215,1268 ----
     * unusual resolutions they should be configurable swidth/sheight ?
     */
  
!   // if (0) {
!   if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         for (int i = 0; i < fheight; i++)
!         {
!           AlphaBlend(pixels[0]+i*width,OsdPy+i*OSD_FULL_WIDTH,
!             Py + i * Ystride,
!             OsdPAlphaY+i*OSD_FULL_WIDTH,fwidth);
!         }
!  
!         for (int i = 0; i < fheight / 2; i++)
!         {
!           AlphaBlend(pixels[1]+i*width/2,
!             OsdPv+i*OSD_FULL_WIDTH/2,Pv+ i * UVstride,
!             OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
!         }
! 
!         for (int i = 0; i < fheight / 2; i++)
!         {
!           AlphaBlend(pixels[2]+i*width/2,
!             OsdPu+i*OSD_FULL_WIDTH/2,Pu+i*UVstride,
!             OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
!         }
! #ifdef USE_MMX
!      EMMS;
! #endif
! 
!         pthread_mutex_lock(&xv_mutex);
!         XvShmPutImage(dpy, port,
!                 win, gc,
!                 xv_image,
!                 sxoff, syoff,      /* sx, sy */
!                 swidth, sheight,   /* sw, sh */
!                 lxoff,  lyoff,     /* dx, dy */
!                 lwidth, lheight,   /* dw, dh */
!                 False);
  
    }
!   else 
! #endif
!  {
!           for (int i = 0; i < fheight; i++)
!              memcpy (pixels [0] + i * width, Py + i * Ystride, fwidth);
!           for (int i = 0; i < fheight / 2; i++) 
!              memcpy (pixels [1] + i * width / 2, Pv + i * UVstride, fwidth / 2);
!           for (int i = 0; i < fheight / 2; i++)
!              memcpy (pixels [2] + i * width / 2, Pu + i * UVstride, fwidth / 2);
!    
!           pthread_mutex_lock(&xv_mutex);
!           XvShmPutImage(dpy, port,
                  win, gc,
                  xv_image,
***************
*** 1189,1193 ****
                  lwidth, lheight,   /* dw, dh */
                  False);
!   ShowOSD (2, False);
    ProcessEvents ();
    events_not_done = 0;
--- 1272,1277 ----
                  lwidth, lheight,   /* dw, dh */
                  False);
!           ShowOSD (1, False);
!   }
    ProcessEvents ();
    events_not_done = 0;

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-xv.h	23 Jan 2005 14:54:22 -0000	1.4
--- video-xv.h	18 Feb 2005 13:31:27 -0000	1.5
***************
*** 47,55 ****
  #define XV_SIZE_QUARTER   0x08
  
! #define XV_NOSAWINDOW     0x10  /* not use at the moment	*/
  
  #define XV_SRC_HEIGHT         576
  #define XV_SRC_WIDTH          736
  
  #define XV_DEST_HEIGHT        XV_SRC_HEIGHT
  #define XV_DEST_WIDTH_4_3     ((XV_DEST_HEIGHT/3)*4)
--- 47,56 ----
  #define XV_SIZE_QUARTER   0x08
  
! #define XV_NOSAWINDOW     0x10  /* not use at the moment*/
  
  #define XV_SRC_HEIGHT         576
  #define XV_SRC_WIDTH          736
  
+ 
  #define XV_DEST_HEIGHT        XV_SRC_HEIGHT
  #define XV_DEST_WIDTH_4_3     ((XV_DEST_HEIGHT/3)*4)
***************
*** 146,149 ****
--- 147,152 ----
  
  #if VDRVERSNUM >= 10307
+   virtual void ClearOSD();
+   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
    virtual void Refresh(cBitmap *Bitmap);
  #else

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video.c	15 Jan 2005 08:33:04 -0000	1.7
--- video.c	18 Feb 2005 13:31:27 -0000	1.8
***************
*** 16,24 ****
--- 16,96 ----
  
  
+ cVideoOut::cVideoOut()
+ {
+ #if VDRVERSNUM >= 10307
+   OsdWidth=OSD_FULL_WIDTH;
+   OsdHeight=OSD_FULL_HEIGHT;
+ #endif
+   syoff=sxoff=0;
+   PixelMask=NULL;
+  //start thread
+  // active=true;
+  // Start();
+ };
+ 
  cVideoOut::~cVideoOut()
  {
+   active=false;
+   Cancel(3);
    dsyslog("[VideoOut]: Good bye");
  }
  
+ /*----------------------------------------------------------------------------*/
+ void cVideoOut::Action() 
+ {
+ #if VDRVERSNUM >= 10307
+   while(active)
+   {
+     int newOsdWidth;
+     int newOsdHeight;
+     bool changeMode=false;
+     int newOsdMode=0;
+     
+     OsdRefreshCounter++;
+     
+     changeMode=(current_osdMode != setupStore.osdMode);
+     newOsdMode=setupStore.osdMode;
+     // if software osd has not been shown for some time fall back
+     // to pseudo osd..
+     if ( OsdRefreshCounter > 40 && setupStore.osdMode == OSDMODE_SOFTWARE ) {
+         changeMode= (current_osdMode != OSDMODE_PSEUDO);
+         newOsdMode=OSDMODE_PSEUDO;
+     };
+     
+     GetOSDDimension(newOsdWidth,newOsdHeight);
+     if ( newOsdWidth==-1 || newOsdHeight==-1 )
+     {
+       newOsdWidth=OSD_FULL_WIDTH;
+       newOsdHeight=OSD_FULL_HEIGHT;
+     }
+     else 
+     {
+       if (newOsdWidth > OSD_FULL_WIDTH)
+         newOsdWidth=OSD_FULL_WIDTH;
+       if (newOsdHeight > OSD_FULL_HEIGHT)
+         newOsdHeight=OSD_FULL_HEIGHT;
+     }
+     if (OSDpresent && osd 
+        && ( OsdWidth!=newOsdWidth  || OsdHeight!=newOsdHeight  || 
+            changeMode )
+         )
+     {
+       OSDdirty=true;
+       //printf("OsdWidth %d newOsdWidth %d OsdHeight %d newOsdHeight %d \n",
+       //   OsdWidth,newOsdWidth,OsdHeight,newOsdHeight);
+       if (changeMode) {
+         cOsd *osdSave=osd;
+         CloseOSD();
+         current_osdMode=newOsdMode;
+         OpenOSD(OSDxOfs,OSDyOfs);
+         osd=osdSave;
+       };
+       osd->Flush();
+     }
+     usleep(50000);
+   };
+ #endif
+ };
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 199,204 ****
  void cVideoOut::OSDStart()
  {
    //fprintf (stderr, "+");
! }
  
  /* ---------------------------------------------------------------------------
--- 271,324 ----
  void cVideoOut::OSDStart()
  {
+   osdMutex.Lock();
    //fprintf (stderr, "+");
! 
! #if VDRVERSNUM >= 10307
!   if (current_osdMode==OSDMODE_SOFTWARE) 
!   {
!     int Ysize=(OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
!     if (!OsdPy)
!        OsdPy=(uint8_t*)malloc(Ysize+8);
!     if (!OsdPAlphaY) 
!     {
!        OsdPAlphaY=(uint8_t*)malloc(Ysize+8);
!        memset(OsdPAlphaY,0,Ysize);
!     };
!     if (!OsdPu)
!        OsdPu=(uint8_t*)malloc(Ysize/4+8);
!     if (!OsdPv)
!        OsdPv=(uint8_t*)malloc(Ysize/4+8);
!     if (!OsdPAlphaUV)
!     {
!        OsdPAlphaUV=(uint8_t*)malloc(Ysize/4+8);
!        memset(OsdPAlphaUV,0,Ysize/4);
!     }
!   }
! 
!   int newX,newY;
!   GetOSDDimension(newX,newY);
!   if ( newX==-1 || newY==-1 )
!   {
!     newX=OSD_FULL_WIDTH;
!     newY=OSD_FULL_HEIGHT;
!   }
!   else 
!   {
!     if (newX > OSD_FULL_WIDTH)
!       newX=OSD_FULL_WIDTH;
!     if (newY > OSD_FULL_HEIGHT)
!       newY=OSD_FULL_HEIGHT;
!   }
!   if (newX!=OsdWidth || newY!=OsdHeight)
!   {
!     OsdWidth=newX;
!     OsdHeight=newY;
!     OSDdirty=true;
!   };
! 
!   if (OSDdirty)
!     ClearOSD(); 
! #endif
! } 
  
  /* ---------------------------------------------------------------------------
***************
*** 207,210 ****
--- 327,333 ----
  {
    //fprintf (stderr, "-");
+   OSDdirty=false;
+   OSDpresent=true;
+   osdMutex.Unlock();
  }
  
***************
*** 215,228 ****
    OSDxOfs = X;
    OSDyOfs = Y;
!   OSDpresent=true;
  }
  
  void cVideoOut::CloseOSD()
  {
    OSDpresent=false;
  }
  
  /* ---------------------------------------------------------------------------
   */
  void cVideoOut::Draw(cBitmap *Bitmap,
                       unsigned char *osd_buf,
--- 338,451 ----
    OSDxOfs = X;
    OSDyOfs = Y;
!   OSDdirty=true;
  }
  
  void cVideoOut::CloseOSD()
  {
+   osdMutex.Lock(); 
+   if (OsdPAlphaY)
+        memset(OsdPAlphaY,0,Xres*Yres);
+   if (OsdPAlphaUV)
+        memset(OsdPAlphaUV,0,Xres*Yres/4);
+  
+   osd=NULL;
    OSDpresent=false;
+   osdMutex.Unlock();
  }
  
  /* ---------------------------------------------------------------------------
   */
+ void cVideoOut::ClearOSD()
+ {
+   if (current_osdMode==OSDMODE_SOFTWARE) 
+   {
+     if (OsdPAlphaY)
+        memset(OsdPAlphaY,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
+     if (OsdPAlphaUV)
+        memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
+   };
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ 
+ void ScaleBitmap(cBitmap *Bitmap,
+               int &a, int &r, int &g, int &b,
+               int x, int y, int newX, int newY) {
+ // scales a bitmap down... no upscaling...
+   const tIndex  *adr;
+   struct color {
+     unsigned char b;
+     unsigned char g;
+     unsigned char r;
+     unsigned char a;
+     } pixel;
+  
+   if ( OSD_FULL_HEIGHT == newY &&
+       OSD_FULL_WIDTH == newX) 
+   {
+      adr = Bitmap->Data(x,y);
+      *((uint32_t *) &pixel) = (uint32_t) Bitmap->Color(*adr);
+      a = pixel.a;
+      b = pixel.b;
+      r = pixel.r;
+      g = pixel.g;
+      return;
+   };
+   
+   int minPY=OSD_FULL_HEIGHT*y/newY;
+   int maxPY=OSD_FULL_HEIGHT*(y+1)/newY;
+   int minPX=OSD_FULL_WIDTH*x/newX;
+   int maxPX=OSD_FULL_WIDTH*(x+1)/newX;
+   int sumA=0;
+   int sumR=0;
+   int sumG=0;
+   int sumB=0;
+   int weightYf=0;
+   int weightYl=0;
+   int weightXf=0;
+   int weightXl=0;
+   int weightX=0;
+   int weight;
+   int weights=0;
+    
+ 
+   weightYf=-OSD_FULL_HEIGHT*100*y/newY+(minPY+1)*100;
+   weightYl=-(maxPY)*100+OSD_FULL_HEIGHT*100*(y+1)/newY;
+   weightXf=-OSD_FULL_WIDTH*100*x/newX+(minPX+1)*100;
+   weightXl=-(maxPX)*100+OSD_FULL_WIDTH*100*(x+1)/newX;
+ 
+   for (int i=minPX; i<= maxPX; i++) {
+     if (i==minPX)
+       weightX=weightXf;
+     else if (i==maxPX)
+       weightX=weightXl;
+     else weight=100;
+     
+     for (int j=minPY; j<= maxPY; j++) {
+       if (j==minPY)
+         weight=weightX*weightYf;
+       else if (j==maxPY)
+         weight=weightX*weightYl;
+       else weight=weightX*100;
+ 
+ //      printf("minPX %d, maxPX %d, minPY %d maxPY %d, weightX %d,weightYf %d \n",
+ //       minPX,maxPX,minPY,maxPY,weightX,weightYf);
+       adr = Bitmap->Data(i,j);
+       *((uint32_t *) &pixel) = (uint32_t) Bitmap->Color(*adr);
+       sumA+=weight* pixel.a;
+       sumB+=weight* pixel.b;
+       sumR+=weight* pixel.r;
+       sumG+=weight* pixel.g;
+       weights+=weight;
+     };
+   };
+ 
+   a= sumA/weights;
+   b= sumB/weights;
+   r= sumR/weights;
+   g= sumG/weights;
+ };
+   
  void cVideoOut::Draw(cBitmap *Bitmap,
                       unsigned char *osd_buf,
***************
*** 233,251 ****
      int           a, r, g, b;
      bool          prev_pix = false, do_dither;
-     tColor        c;
      tIndex        *buf;
!     const tIndex  *adr;
  
!   for (int y = 0; y < Bitmap->Height(); y++)
    {
      buf = (tIndex *) osd_buf +
!             linelen * ( OSDyOfs + y + Bitmap->Y0()) +
!             (OSDxOfs + Bitmap->X0()) * depth;
      prev_pix = false;
  
!     for (int x = 0; x < Bitmap->Width(); x++)
      {
        do_dither = ((x % 2 == 1 && y % 2 == 1) ||
                      x % 2 == 0 && y % 2 == 0 || prev_pix);
        adr = Bitmap->Data(x, y);
        c = Bitmap->Color(*adr);
--- 456,496 ----
      int           a, r, g, b;
      bool          prev_pix = false, do_dither;
      tIndex        *buf;
!     int           x1,x2,y1,y2;
!     uint8_t       *PixelMaskPtr;
  
!     
! //  printf( "Draw: OSDWidth %d %d Bitmap %d %d \n",
! //   OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
!     // if bitmap didn't change, return
!     if (!Bitmap->Dirty(x1,y1,x2,y2) && !OSDdirty )
!       return;
! 
! // printf("dirty area (%d,%d) (%d,%d) \n",x1,y1,x2,y2);
!   
!   if (OSDdirty)
!   {
!     y1=x1=0;
!     x2=Bitmap->Width();
!     y2=Bitmap->Height();
!   };
! 
! #define SCALEX(x) ((x) * OsdWidth/OSD_FULL_WIDTH)
! #define SCALEY(y) ((y) * OsdHeight/OSD_FULL_HEIGHT)
!   for (int y =SCALEY(y1); y <= SCALEY(y2); y++)
    {
      buf = (tIndex *) osd_buf +
!             linelen * (syoff + OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (sxoff+OSDxOfs + SCALEX(Bitmap->X0() + x1) ) * depth;
!     PixelMaskPtr=PixelMask + 
!            linelen/16 * (syoff + OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (sxoff+OSDxOfs + SCALEX(Bitmap->X0() + x1)/8 );
      prev_pix = false;
  
!     for (int x = SCALEX(x1); x <= SCALEX(x2); x++)
      {
        do_dither = ((x % 2 == 1 && y % 2 == 1) ||
                      x % 2 == 0 && y % 2 == 0 || prev_pix);
+      /* 
        adr = Bitmap->Data(x, y);
        c = Bitmap->Color(*adr);
***************
*** 254,257 ****
--- 499,510 ----
        g = (c >> 8) & 255;  //Green
        b = c & 255;         //Blue
+     */ 
+      ScaleBitmap(Bitmap,a,r,g,b,x,y,OsdWidth,OsdHeight);
+ 
+       if (PixelMask) {
+         if (a>TRANSPARENT_THRESHOLD)
+           PixelMaskPtr[x/8]|=(1<<x%8);
+       };
+ 
        switch (depth) {
          case 4:
***************
*** 298,303 ****
            break;
          default:
!             dsyslog("[VideoOut] OSD: unsupported depth %d exiting",depth);
!             exit(1);
            break;
        }
--- 551,556 ----
            break;
          default:
!             //dsyslog("[VideoOut] OSD: unsupported depth %d exiting",depth);
!             //exit(1);
            break;
        }
***************
*** 305,309 ****
--- 558,705 ----
      }
    }
+   Bitmap->Clean();
+ }
+ 
+ void cVideoOut::ToYUV(cBitmap *Bitmap)
+ {
+     int      a1, r1, g1, b1;
+     int      a2, r2, g2, b2;
+     uint8_t       Y1,U1,V1;
+     uint8_t       Y2,U2,V2;
+     int linelen=OSD_FULL_WIDTH;
+     int offset;
+   //  printf("ToYUV... OsdPy: 0%x Res:(%d,%d)\n",OsdPy,linelen,lines);
+ 
+   
+  // printf( "YUV:OSDWidth %d %d Bitmap %d %d \n",
+  //   OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
+  
+     int           x1,x2,y1,y2;
+     // if bitmap didn't change, return
+     if (!Bitmap->Dirty(x1,y1,x2,y2) && !OSDdirty)
+       return;
+     
+    //printf( "----------------------------\nOSDWidth %d %d Bitmap %d %d \n",
+    //     OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
+    //printf("dirty area (%d,%d) (%d,%d) \n",x1,y1,x2,y2);
+     
+     if ( OSDdirty ) 
+     {
+       //printf("++++++++++++++++++++++new OsdHeight+++++++ OSDdirty %d+++++\n",
+       //  OSDdirty);
+       x1=y1=0;
+       x2=Bitmap->Width();
+       y2=Bitmap->Height();
+    };
+ 
+ #define SCALEX(x) ((x) * OsdWidth/OSD_FULL_WIDTH)
+ #define SCALEY(y) ((y) * OsdHeight/OSD_FULL_HEIGHT)
+ 
+   y1=SCALEY(y1); 
+   y2=SCALEY(y2);
+   x1=SCALEX(x1);
+   x2=SCALEX(x2);
+   int  x0=sxoff+OSDxOfs+SCALEX(Bitmap->X0());
+   int  y0=(syoff+OSDyOfs+SCALEY(Bitmap->Y0())) & ~1; // we need an even offset
+    
+   // we need a even starting point
+   y1&=~1;
+   y2+=y2!=Bitmap->Height()?1:0;//FIXME funzt nicht mehr
+   // two rows at a time...
+   for (int y = y1; y < y2; y+=2) 
+   {
+     offset = (y0+y)*linelen;
+     for (int x = x1; x <= x2; x++)
+     {
+      ScaleBitmap(Bitmap,a1,r1,g1,b1,x,y,OsdWidth,OsdHeight);
+      ScaleBitmap(Bitmap,a2,r2,g2,b2,x,y+1,OsdWidth,OsdHeight);
+   
+       Y1 = (( 66 * r1 + 129 * g1 + 25 * b1 + 128 )  >> 8)+16;
+       Y2 = (( 66 * r2 + 129 * g2 + 25 * b2 + 128 )  >> 8)+16;
+       OsdPy[offset+x+x0]=Y1;
+       OsdPAlphaY[offset+x+x0]=a1;
+       OsdPy[offset+linelen+x+x0]=Y2;
+       OsdPAlphaY[offset+linelen+x+x0]=a2;
+       
+       // even columns have U and V
+       if ( (x&1)==0 ) 
+       {
+         // I got this formular from Wikipedia...
+         U1 = (( -38 * r1 - 74 * g1 +112 * b1 + 128 )  >> 8)+128;
+         V1 = (( 112 * r1 - 94 * g1 - 18 * b1 + 128 )  >> 8)+128;
+ 
+         U2 = (( -38 * r2 - 74 * g2 +112 * b2 + 128 )  >> 8)+128;
+         V2 = (( 112 * r2 - 94 * g2 - 18 * b2 + 128 )  >> 8)+128;
+ 
+         OsdPu[offset/4+(x+x0)/2]=(U1+U2)/2;
+         OsdPv[offset/4+(x+x0)/2]=(V1+V2)/2;
+         OsdPAlphaUV[offset/4+(x+x0)/2]=(a1+a2)/2;
+       }
+      }
+     }
+   Bitmap->Clean();
+ 
+ }
+ void cVideoOut::AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
+           uint8_t *alpha,uint16_t count) {
+      // printf("%x %x %x \n",P1,P2,alpha);
+  
+ #ifdef USE_MMX
+         __asm__(" pxor %%mm3,%%mm3\n"
+ #ifdef USE_MMX2
+                 PREFETCH"(%0)\n"
+                 PREFETCH"(%1)\n"
+                 PREFETCH"(%2)\n"
+ #endif //USE_MMX2
+                 : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
+ 
+         // I guess this can be further improved...
+         while (count>8 ) {
+          __asm__(
+ #ifdef USE_MMX2
+                 PREFETCH" 32(%0)\n"
+                 PREFETCH" 32(%1)\n"
+                 PREFETCH" 32(%2)\n"
+ #endif //USE_MMX2
+                 "  movq  (%0),%%mm0\n"
+                 "  movq  (%1),%%mm1\n"
+                 "  movq  (%2),%%mm2\n"
+                 "  movq  %%mm0,%%mm4\n"
+                 "  movq  %%mm1,%%mm5\n"
+                 "  movq  %%mm2,%%mm6\n"
+                 "  punpcklbw %%mm3, %%mm0\n"
+                 "  punpcklbw %%mm3, %%mm1\n"
+                 "  punpcklbw %%mm3, %%mm2\n"
+                 "  punpckhbw %%mm3, %%mm4\n"
+                 "  punpckhbw %%mm3, %%mm5\n"
+                 "  punpckhbw %%mm3, %%mm6\n"
+                 "  psubw %%mm1, %%mm0 \n"
+                 "  psubw %%mm5, %%mm4 \n"
+                 "  psraw $1,%%mm0\n"
+                 "  psraw $1,%%mm4\n"
+                 "  pmullw %%mm2, %%mm0 \n"
+                 "  pmullw %%mm6, %%mm4 \n"
+                 "  psraw $7,%%mm0\n"
+                 "  psraw $7,%%mm4\n"
+                 "  paddw %%mm1, %%mm0 \n"
+                 "  paddw %%mm5, %%mm4 \n"
+                 "  packuswb %%mm4, %%mm0 \n"
+                 "  movq %%mm0,(%3)\n"
+                 : : "r" (P1), "r" (P2), "r" (alpha),"r"(dest) : "memory");
+                 count-=8;
+                 P1+=8;
+                 P2+=8;
+                 alpha+=8;
+                 dest+=8;
+        }
+ #endif //USE_MMX
+ 
+        //fallback version and the last missing bytes...
+        for (int i=0; i < count; i++){
+           dest[i]=(((uint16_t) P1[i] *(uint16_t) alpha[i]) +
+              ((uint16_t) P2[i] *(256-(uint16_t) alpha[i])))  >>8 ;
+        }
  }
+ 
  
  #else

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video.h	23 Jan 2005 14:54:22 -0000	1.7
--- video.h	18 Feb 2005 13:31:27 -0000	1.8
***************
*** 11,14 ****
--- 11,17 ----
  
  #include <vdr/plugin.h>
+ #if VDRVERSNUM >= 10307
+ #include <vdr/osd.h>
+ #endif
  #include <avcodec.h>
  
***************
*** 17,20 ****
--- 20,46 ----
  #define DV_FORMAT_WIDE    2
  
+ #define OSD_FULL_WIDTH    736
+ #define OSD_FULL_HEIGHT   576
+ 
+ // MMX - 3Dnow! defines
+ 
+ #undef PREFETCH
+ #undef EMMS
+ 
+ #ifdef USE_3DNOW
+ //#warning Using 3Dnow! extensions
+ #define PREFETCH "prefetch "
+ #define EMMS     __asm__ (" femms \n": :  )
+ #elif defined ( USE_MMX2 )
+ //#warning Using MMX2 extensions
+ #define PREFETCH "prefetchnta "
+ #define EMMS     __asm__ (" emms \n": :  )
+ #else
+ //#warning Using MMX extensions
+ #define PREFETCH
+ #define EMMS     __asm__ (" emms \n": :  )
+ #endif
+ 
+ 
  #if VDRVERSNUM < 10307
  
***************
*** 38,42 ****
  #endif
  
! class cVideoOut {
  private:
  protected:
--- 64,68 ----
  #endif
  
! class cVideoOut: public cThread {
  private:
  protected:
***************
*** 46,55 ****
      bool    OSDpresent,
              OSDpseudo_alpha;
      int     Xres, Yres, Bpp; // the child class MUST set these params (for OSD Drawing)
!     int     dx, dy, dwidth, dheight,
              old_x, old_y, old_dwidth, old_dheight,
!             screenPixelAspect,
!             fwidth, fheight,
!             swidth, sheight,
              sxoff, syoff,
              lwidth, lheight,
--- 72,83 ----
      bool    OSDpresent,
              OSDpseudo_alpha;
+     int     current_osdMode;
      int     Xres, Yres, Bpp; // the child class MUST set these params (for OSD Drawing)
!     int     dx, dy, 
!             dwidth, dheight,
              old_x, old_y, old_dwidth, old_dheight,
!             screenPixelAspect;
!     volatile int        fwidth, fheight;
!     int     swidth, sheight,
              sxoff, syoff,
              lwidth, lheight,
***************
*** 61,66 ****
--- 89,99 ----
              aspect_changed,
              current_afd;
+     
+     cOsd *osd;
+     bool active;
+     bool OSDdirty;
  
  public:
+     cVideoOut();
      virtual ~cVideoOut();
      virtual void Size(int w, int h) {OSDw = w; OSDh = h;};
***************
*** 77,94 ****
      virtual bool GetInfo(int *fmt, unsigned char **dest,int *w, int *h) {return false;};
  
!     virtual void Suspend(void) { printf("Video Suspend\n"); return;};
!     virtual bool Resume(void) {printf("Video Resume\n"); return true;};
  
  #if VDRVERSNUM >= 10307
  
      virtual void Refresh(cBitmap *Bitmap) { return; };
      void Draw(cBitmap *Bitmap,
                unsigned char * buf,
                int linelen,
                bool inverseAlpha = false);
  
  #else
      cWindowLayer *layer[MAXNUMWINDOWS];
-     uint8_t *PixelMask;
      virtual bool OpenWindow(cWindow *Window);
      virtual void CommitWindow(cWindow *Window);
--- 110,169 ----
      virtual bool GetInfo(int *fmt, unsigned char **dest,int *w, int *h) {return false;};
  
!     virtual void Suspend(void) { return;};
!     virtual bool Resume(void) { return true;};
! 
!     virtual void Action(void);
!     // osd control thread. Refreshes the osd on dimension changes and
!     // activates fallback mode if the osd was not updated for a too long
!     // time
  
+     void SetOsd(cOsd * Osd) {osd=Osd;};
+     // sets a pointer to the current osd. For refreshing of the osd 
+ 
+     uint8_t *PixelMask;
  #if VDRVERSNUM >= 10307
+     uint8_t *OsdPy;
+     uint8_t *OsdPu; 
+     uint8_t *OsdPv;
+     uint8_t *OsdPAlphaY; 
+     uint8_t *OsdPAlphaUV;
+     // buffers for software osd alpha blending 
+     
+     uint16_t OsdHeight;
+     uint16_t OsdWidth;
+     // current dimensions of the OSD
+     
+     uint16_t OsdRefreshCounter;
+     // should be setted to null everytime OSD is shown 
+     // (software alpha blending mode).  
  
+     virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight)
+     // called whenever OSD is to be displayed
+     // every video-out should implement a method which desired osd dimension
+     // for scaling, if -1,-1 is returned no scaling is done.
+     { OsdWidth=-1;OsdHeight=-1;};
+ 
+     virtual void ClearOSD();
+     // clear the OSD buffer
+     
      virtual void Refresh(cBitmap *Bitmap) { return; };
+     
      void Draw(cBitmap *Bitmap,
                unsigned char * buf,
                int linelen,
                bool inverseAlpha = false);
+     // draws the bitmap in buf. The bitmap is scaled automaticaly if
+     // GetOSDDimension return smaller dimensions
+       
+    void ToYUV(cBitmap *Bitmap);
+    // converts the bitmap to YUV format, saved in OSDP[yuv] and 
+    // OSDPAlpha[YUV]. The bitmap is also scaled if requested
+    
+    void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
+        uint8_t *alpha,uint16_t count);
+    // performes alpha blending in software
  
  #else
      cWindowLayer *layer[MAXNUMWINDOWS];
      virtual bool OpenWindow(cWindow *Window);
      virtual void CommitWindow(cWindow *Window);



From nobody at sheep.berlios.de  Fri Feb 18 18:35:51 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 18 Feb 2005 18:35:51 +0100
Subject: [Softdevice-cvs] softdevice video-fb.c,1.3,1.4 video-fb.h,1.1.1.1,1.2
Message-ID: <200502181735.j1IHWdN26797@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21917

Modified Files:
	video-fb.c video-fb.h 
Log Message:
compile fix for video-fb out

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** video-fb.c	18 Feb 2005 13:31:27 -0000	1.3
--- video-fb.c	18 Feb 2005 17:32:36 -0000	1.4
***************
*** 40,44 ****
  
      fb_orig_vinfo = fb_vinfo;
!          
      switch (fb_finfo.visual) {
  
--- 40,44 ----
  
      fb_orig_vinfo = fb_vinfo;
! 
      switch (fb_finfo.visual) {
  

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** video-fb.h	1 Aug 2004 05:07:04 -0000	1.1.1.1
--- video-fb.h	18 Feb 2005 17:32:36 -0000	1.2
***************
*** 18,21 ****
--- 18,25 ----
    struct fb_var_screeninfo fb_orig_vinfo;
    struct fb_var_screeninfo fb_vinfo;
+ 
+   int orig_cmaplen;
+   __u16 * orig_cmap;
+ 
    size_t size;
    int line_len;
***************
*** 25,29 ****
--- 29,35 ----
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
+   virtual void ClearOSD();
    virtual void Refresh(cBitmap *Bitmap);
+   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
  #else
    virtual void Refresh();



From nobody at sheep.berlios.de  Fri Feb 18 18:38:09 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 18 Feb 2005 18:38:09 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.8,1.9
Message-ID: <200502181738.j1IHc9N27627@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2139

Modified Files:
	video.c 
Log Message:
OSD drawing: off by 1 fix

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** video.c	18 Feb 2005 13:31:27 -0000	1.8
--- video.c	18 Feb 2005 17:38:06 -0000	1.9
***************
*** 472,477 ****
    {
      y1=x1=0;
!     x2=Bitmap->Width();
!     y2=Bitmap->Height();
    };
  
--- 472,477 ----
    {
      y1=x1=0;
!     x2=Bitmap->Width()-1;
!     y2=Bitmap->Height()-1;
    };
  



From nobody at sheep.berlios.de  Thu Feb 24 23:35:53 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 24 Feb 2005 23:35:53 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.34,1.35 Makefile,1.5,1.6 mpeg2decoder.c,1.15,1.16 setup-softdevice.c,1.9,1.10 setup-softdevice.h,1.6,1.7 softdevice.c,1.13,1.14 video-dfb.c,1.17,1.18 video-dfb.h,1.4,1.5 video-dummy.c,1.1.1.1,1.2 video-dummy.h,1.1.1.1,1.2 video-fb.c,1.4,1.5 video-fb.h,1.2,1.3 video-vidix.c,1.5,1.6 video-vidix.h,1.2,1.3 video-xv.c,1.15,1.16 video-xv.h,1.5,1.6 video.c,1.9,1.10 video.h,1.8,1.9
Message-ID: <200502242235.j1OMZrN16341@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26752

Modified Files:
	CHANGELOG Makefile mpeg2decoder.c setup-softdevice.c 
	setup-softdevice.h softdevice.c video-dfb.c video-dfb.h 
	video-dummy.c video-dummy.h video-fb.c video-fb.h 
	video-vidix.c video-vidix.h video-xv.c video-xv.h video.c 
	video.h 
Log Message:
    - vidix-out: fix segfaults upon switch from software OSD back to pseudo mode.
                 match available fourcc against selected.
                 support for YUY2 added (without soft alpha [todo]).
    - all-out: unified constuctor parameter
               optionaly output method is loaded at runtime. by this, one can
               build and ship binaries with all methods enabled to target
               enviroments where not all libs are present.
    - removed obsolete OSD option "sync on" (I-frame/all frames).


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** CHANGELOG	18 Feb 2005 13:31:26 -0000	1.34
--- CHANGELOG	24 Feb 2005 22:35:50 -0000	1.35
***************
*** 1,3 ****
--- 1,12 ----
  Changelog
+  2005-02-25:
+     - vidix-out: fix segfaults upon switch from software OSD back to pseudo mode.
+                  match available fourcc against selected.
+                  support for YUY2 added (without soft alpha [todo]).
+     - all-out: unified constuctor parameter
+                optionaly output method is loaded at runtime. by this, one can
+                build and ship binaries with all methods enabled to target
+                enviroments where not all libs are present.
+     - removed obsolete OSD option "sync on" (I-frame/all frames).
   2005-02-18:
      - support for DIRECTCOLOR framebuffer ( most ATI cards, tested with Mach64)

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** Makefile	23 Jan 2005 14:54:22 -0000	1.5
--- Makefile	24 Feb 2005 22:35:50 -0000	1.6
***************
*** 55,58 ****
--- 55,62 ----
  
  # -----------------------------------------------------------------------------
+ # if you want output methods build as separate libs uncomment this
+ #USE_SUBPLUGINS = 1
+ 
+ # -----------------------------------------------------------------------------
  # framebuffer device name
  #
***************
*** 145,189 ****
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o
  LIBS = $(FFMPEGLIBS) -lasound -lz
  
  ifdef DFB_SUPPORT
! OBJS     += video-dfb.o
! DEFINES  += -DDFB_SUPPORT
! INCLUDES += -I/usr/local/include/dfb++ -I/usr/local/include/directfb
! LIBS 	 += -L/usr/local/lib -ldfb++
! #INCLUDES += -I/opt/directfb/include/directfb -I/opt/directfb/include
! #LIBS 	 += -L/opt/directfb/lib -ldfb++
  endif
  
  ifdef FB_SUPPORT
! OBJS 	+= video-fb.o
! DEFINES += -DFB_SUPPORT -DFBDEV=\"$(FBDEV)\"
  endif
  
  ifdef XV_SUPPORT
! OBJS 	+= video-xv.o xscreensaver.o
! DEFINES += -DXV_SUPPORT
! ifdef LIBXDPMS_SUPPORT
! DEFINES += -DLIBXDPMS_SUPPORT
! endif
! LIBS 	+= -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
  endif
  
  ifdef VIDIX_SUPPORT
! OBJS        += video-vidix.o
! CXXFLAGS    += -L$(VIDIX_DIR)/lib
! INCLUDES    += -I$(VIDIX_DIR)/include/vidix
! DEFINES     += -DVIDIX_SUPPORT -DVIDIX_DIR=\"$(VIDIX_DIR)/lib/vidix/\" -DFBDEV=\"$(FBDEV)\"
! LIBS        += -lvidix
  endif
  
  ifdef PP_LIBAVCODEC
! DEFINES     += -DPP_LIBAVCODEC
! FFMPEGLIBS  += -lpostproc
  endif
  
  ifdef SUSPEND_BY_KEY
! DEFINES     += -DSUSPEND_BY_KEY
  endif
  
--- 149,225 ----
  ### The object files (add further files here):
  
! ifdef USE_SUBPLUGINS
!   DEFINES += -DUSE_SUBPLUGINS
! endif
! 
! TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound -lz
+ OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o
+ ALL_OBJS = $(OBJS)
  
  ifdef DFB_SUPPORT
!   ifdef USE_SUBPLUGINS
!     DFB_LIBS  = -L/usr/local/lib -ldfb++
!     DFB_OBJS  = video.o video-dfb.o
!     ALL_OBJS += $(DFB_OBJS)
!     TARGETS  += libvdr-$(PLUGIN)-dfb.so
!   else
!     OBJS     += video-dfb.o
!     LIBS     += -L/usr/local/lib -ldfb++
!   endif
!   DEFINES  += -DDFB_SUPPORT
!   INCLUDES += -I/usr/local/include/dfb++ -I/usr/local/include/directfb
  endif
  
  ifdef FB_SUPPORT
!   ifdef USE_SUBPLUGINS
!     FB_LIBS   =
!     FB_OBJS   = video.o video-fb.o
!     ALL_OBJS  += $(FB_OBJS)
!     TARGETS   += libvdr-$(PLUGIN)-fb.so
!   else
!     OBJS 	+= video-fb.o
!   endif
!   DEFINES += -DFB_SUPPORT -DFBDEV=\"$(FBDEV)\"
  endif
  
  ifdef XV_SUPPORT
!   ifdef USE_SUBPLUGINS
!     XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
!     XV_OBJS   = video.o video-xv.o xscreensaver.o
!     ALL_OBJS  += $(XV_OBJS)
!     TARGETS   += libvdr-$(PLUGIN)-xv.so
!   else
!     OBJS 	+= video-xv.o xscreensaver.o
!     LIBS 	+= -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
!   endif
!   ifdef LIBXDPMS_SUPPORT
!     DEFINES += -DLIBXDPMS_SUPPORT
!   endif
!   DEFINES += -DXV_SUPPORT
  endif
  
  ifdef VIDIX_SUPPORT
!   ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = video.o video-vidix.o
!     VIDIX_LIBS  = -lvidix
!     ALL_OBJS    += $(VIDIX_OBJS)
!     TARGETS     += libvdr-$(PLUGIN)-vidix.so
!   else
!     OBJS        += video-vidix.o
!     LIBS        += -lvidix
!   endif
!   CXXFLAGS    += -L$(VIDIX_DIR)/lib
!   INCLUDES    += -I$(VIDIX_DIR)/include/vidix
!   DEFINES     += -DVIDIX_SUPPORT -DVIDIX_DIR=\"$(VIDIX_DIR)/lib/vidix/\" -DFBDEV=\"$(FBDEV)\"
  endif
  
  ifdef PP_LIBAVCODEC
!   DEFINES     += -DPP_LIBAVCODEC
!   FFMPEGLIBS  += -lpostproc
  endif
  
  ifdef SUSPEND_BY_KEY
!   DEFINES     += -DSUSPEND_BY_KEY
  endif
  
***************
*** 205,214 ****
  ### Targets:
  
! all: libvdr-$(PLUGIN).so
! 
  
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
  dist: clean
--- 241,269 ----
  ### Targets:
  
! all: $(TARGETS)
  
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+ 
+ ifdef USE_SUBPLUGINS
+ 
+ libvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
+ 	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
+ 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+ 
+ libvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
+ 	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
+ 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+ 
+ libvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
+ 	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
+ 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+ 
+ libvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
+ 	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
+ 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+ 
+ endif
  
  dist: clean

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** mpeg2decoder.c	13 Feb 2005 18:12:31 -0000	1.15
--- mpeg2decoder.c	24 Feb 2005 22:35:50 -0000	1.16
***************
*** 573,577 ****
    }
  
- #if 1 // new method for setting the video PTS
    if (picture->coded_picture_number)
    {
--- 573,576 ----
***************
*** 609,623 ****
      //fprintf (stderr, "+ using PTS value (%lld)\n", pts);
    }
- #else
-   if (validPTS &&
-       (setupStore.syncOnFrames ||
-        context->coded_frame->pict_type == FF_I_TYPE))
-   {
-     //pts=(GET_MPEG2_PTS(header)/90);
-     pts=newPTS;
-     MPGDEB("Got Video PTS: %lld \n",pts);
-     validPTS=false;
-   }
- #endif
  
    historyPTS[historyPTSIndex++%PTS_COUNT] = newPTS;
--- 608,611 ----

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** setup-softdevice.c	18 Feb 2005 13:31:26 -0000	1.9
--- setup-softdevice.c	24 Feb 2005 22:35:51 -0000	1.10
***************
*** 61,71 ****
  /* ----------------------------------------------------------------------------
   */
- char *syncOnFramesStr [] = {
-         "I-Frames",
-         "Any Frames",
-         NULL
-      };
- /* ----------------------------------------------------------------------------
-  */
  char *suspendVideo [] = {
          "playing",
--- 61,64 ----
***************
*** 285,292 ****
                              &data->mirror, tr("off"), tr("on")));
  
-   Add(new cMenuEditStraItem(tr("A/V Sync"),
-                             &data->syncOnFrames,
-                             2,
-                             syncOnFramesStr));
    Add(new cMenuEditIntItem(tr("A/V Offset"),
                             &data->avOffset,
--- 278,281 ----
***************
*** 355,359 ****
    SetupStore ("PixelFormat",        setupStore.pixelFormat);
    SetupStore ("Picture mirroring",  setupStore.mirror);
-   SetupStore ("SyncAllFrames",      setupStore.syncOnFrames);
    SetupStore ("avOffset",           setupStore.avOffset);
    SetupStore ("AlsaDevice",         setupStore.alsaDevice);
--- 344,347 ----

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** setup-softdevice.h	18 Feb 2005 13:31:27 -0000	1.6
--- setup-softdevice.h	24 Feb 2005 22:35:51 -0000	1.7
***************
*** 21,28 ****
  class cSetupStore {
    public:
!     cSetupStore ();
!     bool  SetupParse(const char *Name, const char *Value);
!     char  *getPPValue(void);
!     void  getScreenDimension(int &w, int &h);
  
      int   xvAspect;
--- 21,28 ----
  class cSetupStore {
    public:
!                   cSetupStore ();
!     bool          SetupParse(const char *Name, const char *Value);
!     char          *getPPValue(void);
!     virtual void  getScreenDimension(int &w, int &h);
  
      int   xvAspect;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** softdevice.c	18 Feb 2005 13:31:27 -0000	1.13
--- softdevice.c	24 Feb 2005 22:35:51 -0000	1.14
***************
*** 9,12 ****
--- 9,17 ----
  #include <getopt.h>
  #include <stdlib.h>
+ 
+ #ifdef USE_SUBPLUGINS
+ #include <dlfcn.h>
+ #endif
+ 
  #include <vdr/interface.h>
  #include <vdr/plugin.h>
***************
*** 76,81 ****
  #define INBUF_SIZE 4096
  
- 
- 
  #if VDRVERSNUM >= 10307
  
--- 81,84 ----
***************
*** 301,308 ****
              FFMPEG_VERSION, LIBAVCODEC_BUILD);
      setupStore.outputMethod = method;
      switch (method) {
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         videoOut = new cXvVideoOut (setupStore. xvAspect);
          if (videoOut->Initialize () && videoOut->Reconfigure (FOURCC_YV12)) {
            fprintf (stderr, "[softdevice] Xv out OK !\n");
--- 304,389 ----
              FFMPEG_VERSION, LIBAVCODEC_BUILD);
      setupStore.outputMethod = method;
+ #ifdef USE_SUBPLUGINS
+   {
+       char  *pluginPath = "./PLUGINS/lib";
+       char  *subPluginFileName = NULL;
+       char  *outMethodName  = NULL;
+       int   reconfigureArg  = 0;
+     switch (method) {
+     case VOUT_XV:
+ #ifdef XV_SUPPORT
+       outMethodName = "xv";
+       reconfigureArg = FOURCC_YV12;
+ #endif
+       break;
+     case VOUT_FB:
+ #ifdef FB_SUPPORT
+       outMethodName = "fb";
+ #endif
+       break;
+     case VOUT_DFB:
+ #ifdef DFB_SUPPORT
+       outMethodName = "dfb";
+ #endif
+       break;
+     case VOUT_VIDIX:
+ #ifdef VIDIX_SUPPORT
+       outMethodName = "vidix";
+ #endif
+       break;
+     default:
+       break;
+     }
+ 
+     asprintf (&subPluginFileName,
+               "%s/%s%s.so.%s",
+               pluginPath,
+               "libvdr-softdevice-",
+               outMethodName,
+               VDRVERSION);
+     void *handle = dlopen (subPluginFileName, RTLD_NOW);
+     char *err = dlerror();
+     if (!err)
+     {
+         void  *(*creator)(cSetupStore *store);
+ 
+       creator = (void *(*)(cSetupStore *))dlsym(handle,
+                                                 "SubPluginCreator");
+       err = dlerror();
+       if (!err)
+       {
+         videoOut = (cVideoOut *) creator (&setupStore);
+       }
+       else
+       {
+         esyslog("[softdevice] could not load (%s)[%s] exiting\n",
+                 "SubPluginCreator", err);
+         exit(1);
+       }
+       if (videoOut->Initialize () &&
+           videoOut->Reconfigure (reconfigureArg))
+       {
+           dsyslog("[softdevice] videoOut OK !\n");
+       }
+       else
+       {
+         esyslog("[softdevice] videoOut failure exiting\n");
+         exit (1);
+       }
+ 
+     }
+     else
+     {
+       esyslog("[softdevice] could not load (%s)[%s] exiting\n",
+               subPluginFileName, err);
+       exit(1);
+     }
+ 
+     }
+ #else
      switch (method) {
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         videoOut = new cXvVideoOut (&setupStore);
          if (videoOut->Initialize () && videoOut->Reconfigure (FOURCC_YV12)) {
            fprintf (stderr, "[softdevice] Xv out OK !\n");
***************
*** 315,324 ****
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         videoOut=new cFBVideoOut();
  #endif
          break;
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         videoOut=new cDFBVideoOut();
          videoOut->Initialize();
  #endif
--- 396,405 ----
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         videoOut=new cFBVideoOut(&setupStore);
  #endif
          break;
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         videoOut=new cDFBVideoOut(&setupStore);
          videoOut->Initialize();
  #endif
***************
*** 326,330 ****
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         videoOut=new cVidixVideoOut();
  #endif
          break;
--- 407,411 ----
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         videoOut=new cVidixVideoOut(&setupStore);
  #endif
          break;
***************
*** 332,335 ****
--- 413,417 ----
          break;
      }
+ #endif
      fprintf(stderr,"[softdevice] Video Out seems to be OK\n");
      fprintf(stderr,"[softdevice] Initializing Audio Out\n");

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-dfb.c	18 Feb 2005 13:31:27 -0000	1.17
--- video-dfb.c	24 Feb 2005 22:35:51 -0000	1.18
***************
*** 230,234 ****
  /* ---------------------------------------------------------------------------
   */
! cDFBVideoOut::cDFBVideoOut()
  {
      DFBDisplayLayerDescription    desc;
--- 230,235 ----
  /* ---------------------------------------------------------------------------
   */
! cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore)
!               : cVideoOut(setupStore)
  {
      DFBDisplayLayerDescription    desc;
***************
*** 243,249 ****
    sheight = fheight = 576;
  
-   sxoff = syoff = lxoff = lyoff = 0;
    screenPixelAspect = -1;
!   currentPixelFormat = setupStore.pixelFormat;
    isVIAUnichrome = false;
    clearAlpha = 0x00;
--- 244,249 ----
    sheight = fheight = 576;
  
    screenPixelAspect = -1;
!   currentPixelFormat = setupStore->pixelFormat;
    isVIAUnichrome = false;
    clearAlpha = 0x00;
***************
*** 253,257 ****
    DirectFB::Init();
    dfb = DirectFB::Create();
!   if (!setupStore.useMGAtv)
      dfb->SetCooperativeLevel(DFSCL_FULLSCREEN);
  
--- 253,257 ----
    DirectFB::Init();
    dfb = DirectFB::Create();
!   if (!setupStore->useMGAtv)
      dfb->SetCooperativeLevel(DFSCL_FULLSCREEN);
  
***************
*** 276,284 ****
    videoLayer = NULL;
    layerInfo = &layerList [ANY_LAYER];
!   if (setupStore.useMGAtv) {
      layerInfo = &layerList [CRTC2_LAYER_NEW];
!     currentPixelFormat = setupStore.pixelFormat = 2;
!     if (!setupStore.screenPixelAspect)
!       setupStore.screenPixelAspect = 1;
    }
  
--- 276,284 ----
    videoLayer = NULL;
    layerInfo = &layerList [ANY_LAYER];
!   if (setupStore->useMGAtv) {
      layerInfo = &layerList [CRTC2_LAYER_NEW];
!     currentPixelFormat = setupStore->pixelFormat = 2;
!     if (!setupStore->screenPixelAspect)
!       setupStore->screenPixelAspect = 1;
    }
  
***************
*** 286,290 ****
    videoLayer = layerInfo->layer;
  
!   if (setupStore.useMGAtv && !videoLayer) {
      layerInfo = &layerList [CRTC2_LAYER_OLD];
      fprintf(stderr, "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
--- 286,290 ----
    videoLayer = layerInfo->layer;
  
!   if (setupStore->useMGAtv && !videoLayer) {
      layerInfo = &layerList [CRTC2_LAYER_OLD];
      fprintf(stderr, "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
***************
*** 302,306 ****
    scrDsc.pixelformat = DSPF_ARGB;
  
!   if (setupStore.useMGAtv)
    {
        DFBDisplayLayerConfig   dlc;
--- 302,306 ----
    scrDsc.pixelformat = DSPF_ARGB;
  
!   if (setupStore->useMGAtv)
    {
        DFBDisplayLayerConfig   dlc;
***************
*** 409,417 ****
      useStretchBlit = false;
      OSDpseudo_alpha = true;
!     if (setupStore.pixelFormat == 0)
        vidDsc.pixelformat = DSPF_I420;
!     else if (setupStore.pixelFormat == 1)
        vidDsc.pixelformat = DSPF_YV12;
!     else if (setupStore.pixelFormat == 2)
      {
        vidDsc.pixelformat = DSPF_YUY2;
--- 409,417 ----
      useStretchBlit = false;
      OSDpseudo_alpha = true;
!     if (setupStore->pixelFormat == 0)
        vidDsc.pixelformat = DSPF_I420;
!     else if (setupStore->pixelFormat == 1)
        vidDsc.pixelformat = DSPF_YV12;
!     else if (setupStore->pixelFormat == 2)
      {
        vidDsc.pixelformat = DSPF_YUY2;
***************
*** 457,461 ****
      reportSurfaceCapabilities ("videoSurface:", videoSurface);
  
!     if (!setupStore.useMGAtv)
      {
        fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
--- 457,461 ----
      reportSurfaceCapabilities ("videoSurface:", videoSurface);
  
!     if (!setupStore->useMGAtv)
      {
        fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
***************
*** 476,480 ****
    /* create an event buffer with all devices attached */
    events = dfb->CreateInputEventBuffer(DICAPS_ALL,
!                                        (setupStore.useMGAtv) ? DFB_TRUE : DFB_FALSE);
  }
  
--- 476,480 ----
    /* create an event buffer with all devices attached */
    events = dfb->CreateInputEventBuffer(DICAPS_ALL,
!                                        (setupStore->useMGAtv) ? DFB_TRUE : DFB_FALSE);
  }
  
***************
*** 541,545 ****
      if (!videoSurface ||
          aspect_changed ||
!         currentPixelFormat != setupStore.pixelFormat)
      {
  
--- 541,545 ----
      if (!videoSurface ||
          aspect_changed ||
!         currentPixelFormat != setupStore->pixelFormat)
      {
  
***************
*** 551,559 ****
        useStretchBlit = false;
        OSDpseudo_alpha = (isVIAUnichrome) ? false: true;
!       if (setupStore.pixelFormat == 0)
          dlc.pixelformat = DSPF_I420;
!       else if (setupStore.pixelFormat == 1)
          dlc.pixelformat = DSPF_YV12;
!       else if (setupStore.pixelFormat == 2)
        {
          dlc.pixelformat = DSPF_YUY2;
--- 551,559 ----
        useStretchBlit = false;
        OSDpseudo_alpha = (isVIAUnichrome) ? false: true;
!       if (setupStore->pixelFormat == 0)
          dlc.pixelformat = DSPF_I420;
!       else if (setupStore->pixelFormat == 1)
          dlc.pixelformat = DSPF_YV12;
!       else if (setupStore->pixelFormat == 2)
        {
          dlc.pixelformat = DSPF_YUY2;
***************
*** 598,602 ****
        vidDsc.pixelformat = dlc.pixelformat;
  
!       currentPixelFormat = setupStore.pixelFormat;
  
        pixelformat = dlc.pixelformat;
--- 598,602 ----
        vidDsc.pixelformat = dlc.pixelformat;
  
!       currentPixelFormat = setupStore->pixelFormat;
  
        pixelformat = dlc.pixelformat;
***************
*** 643,647 ****
          }
  
!         if (setupStore.useMGAtv)
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
--- 643,647 ----
          }
  
!         if (setupStore->useMGAtv)
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
***************
*** 664,668 ****
          }
  
!         //if (setupStore.useMGAtv)
            //videoLayer->SetFieldParity(0);
  
--- 664,668 ----
          }
  
!         //if (setupStore->useMGAtv)
            //videoLayer->SetFieldParity(0);
  
***************
*** 1069,1073 ****
  
        }
!       scrSurface->Flip(NULL, (setupStore.useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
  
        if (aspect_changed || osdClrBack)
--- 1069,1073 ----
  
        }
!       scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
  
        if (aspect_changed || osdClrBack)
***************
*** 1101,1102 ****
--- 1101,1112 ----
    if (dfb)          dfb->Release();
  }
+ 
+ #ifdef USE_SUBPLUGINS
+ /* ---------------------------------------------------------------------------
+  */
+ extern "C" void *
+ SubPluginCreator(cSetupStore *s)
+ {
+   return new cDFBVideoOut(s);
+ }
+ #endif

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-dfb.h	21 Dec 2004 05:55:42 -0000	1.4
--- video-dfb.h	24 Feb 2005 22:35:51 -0000	1.5
***************
*** 44,48 ****
    public:
      IDirectFB	*dfb;
!     cDFBVideoOut();
      virtual ~cDFBVideoOut();
      void ProcessEvents ();
--- 44,48 ----
    public:
      IDirectFB	*dfb;
!     cDFBVideoOut(cSetupStore *setupStore);
      virtual ~cDFBVideoOut();
      void ProcessEvents ();

Index: video-dummy.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dummy.c,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** video-dummy.c	1 Aug 2004 05:07:05 -0000	1.1.1.1
--- video-dummy.c	24 Feb 2005 22:35:51 -0000	1.2
***************
*** 13,17 ****
  
  
! cDummyVideoOut::cDummyVideoOut()
  {
      printf("[video-dummy] Initializing Driver, no output supported. You have to configure a driver IN the Makefile\n");
--- 13,18 ----
  
  
! cDummyVideoOut::cDummyVideoOut(cSetupStore *setupStore)
!                 : cVideoOut(setupStore)
  {
      printf("[video-dummy] Initializing Driver, no output supported. You have to configure a driver IN the Makefile\n");

Index: video-dummy.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dummy.h,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** video-dummy.h	1 Aug 2004 05:07:05 -0000	1.1.1.1
--- video-dummy.h	24 Feb 2005 22:35:51 -0000	1.2
***************
*** 14,18 ****
  private:
  public:
!   cDummyVideoOut();
    virtual ~cDummyVideoOut();
  
--- 14,18 ----
  private:
  public:
!   cDummyVideoOut(cSetupStore *setupStore);
    virtual ~cDummyVideoOut();
  

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-fb.c	18 Feb 2005 17:32:36 -0000	1.4
--- video-fb.c	24 Feb 2005 22:35:51 -0000	1.5
***************
*** 21,25 ****
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
  // --- cFrameBuffer --------------------------------------------------------
! cFBVideoOut::cFBVideoOut()
  {
      printf("[video-fb] Initializing Driver\n");
--- 21,26 ----
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
  // --- cFrameBuffer --------------------------------------------------------
! cFBVideoOut::cFBVideoOut(cSetupStore *etupStore)
!               : cVideoOut(setupStore)
  {
      printf("[video-fb] Initializing Driver\n");
***************
*** 249,250 ****
--- 250,260 ----
  }
  
+ #ifdef USE_SUBPLUGINS
+ /* ---------------------------------------------------------------------------
+  */
+ extern "C" void *
+ SubPluginCreator(cSetupStore *s)
+ {
+   return new cFBVideoOut(s);
+ }
+ #endif

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-fb.h	18 Feb 2005 17:32:36 -0000	1.2
--- video-fb.h	24 Feb 2005 22:35:51 -0000	1.3
***************
*** 26,30 ****
    unsigned char * fb;	// Framebuffer memory
  public:
!   cFBVideoOut();
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
--- 26,30 ----
    unsigned char * fb;	// Framebuffer memory
  public:
!   cFBVideoOut(cSetupStore *setupStore);
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-vidix.c	18 Feb 2005 13:31:27 -0000	1.5
--- video-vidix.c	24 Feb 2005 22:35:51 -0000	1.6
***************
*** 26,46 ****
  #endif
  
! cVidixVideoOut::cVidixVideoOut() : cVideoOut()
  {
      int err;
      if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
!         printf("cVidixVideoOut: Can't open framebuffer\n");
          exit(1);
      }
!     
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         printf("cVidixVideoOut: Can't get VSCREENINFO\n");
          exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         printf("cVidixVideoOut: Can't get FSCREENINFO\n");
          exit(1);
      }
!          
      switch (fb_finfo.visual) {
  
--- 26,47 ----
  #endif
  
! cVidixVideoOut::cVidixVideoOut(cSetupStore *setupStore)
!                   : cVideoOut(setupStore)
  {
      int err;
      if ((fbdev = open(FBDEV, O_RDWR)) == -1) {
!         esyslog("[cVidixVideoOut] Can't open framebuffer exiting\n");
          exit(1);
      }
! 
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         esyslog("[cVidixVideoOut] Can't get VSCREENINFO exiting\n");
          exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         esyslog("[cVidixVideoOut] Can't get FSCREENINFO exiting\n");
          exit(1);
      }
! 
      switch (fb_finfo.visual) {
  
***************
*** 60,64 ****
  
             if ( orig_cmap == NULL ) {
!                printf("cVidixVideoOut: Can't alloc memory for cmap\n");
                 exit(1);
             }
--- 61,65 ----
  
             if ( orig_cmap == NULL ) {
!                esyslog("[cVidixVideoOut] Can't alloc memory for cmap exiting\n");
                 exit(1);
             }
***************
*** 106,110 ****
      fwidth = lwidth = dwidth = swidth = Xres;
      fheight = lheight = dheight = sheight = Yres;
-     sxoff = syoff = lxoff = lyoff = 0;
  
      printf("cVidixVideoOut: xres = %d yres= %d \n", fb_vinfo.xres, fb_vinfo.yres);
--- 107,110 ----
***************
*** 115,119 ****
  
      if ( fb == (uint8_t *) -1 ) {
!        printf("cVidixVideoOut: Can't mmap framebuffer memory\n");
         exit(1);
       }
--- 115,119 ----
  
      if ( fb == (uint8_t *) -1 ) {
!        esyslog("[cVidixVideoOut] Can't mmap framebuffer memory exiting\n");
         exit(1);
       }
***************
*** 122,126 ****
  
      if ( osd == NULL ) {
!        printf("cVidixVideoOut: Can't alloc osd memory\n");
         exit(1);
      }
--- 122,126 ----
  
      if ( osd == NULL ) {
!        esyslog("[cVidixVideoOut] Can't alloc osd memory exiting\n");
         exit(1);
      }
***************
*** 141,145 ****
      if( !vidix_handler )
      {
!        printf("cVidixVideoOut: Couldn't find working VIDIX driver\n");
         exit(1);
      }
--- 141,145 ----
      if( !vidix_handler )
      {
!        esyslog("[cVidixVideoOut] Couldn't find working VIDIX driver exiting\n");
         exit(1);
      }
***************
*** 147,166 ****
      if( (err = vdlGetCapability(vidix_handler,&vidix_cap)) != 0)
      {
!        printf("cVidixVideoOut: Couldn't get capability: %s\n", strerror(err) );
         exit(1);
      }
      printf("cVidixVideoOut: capabilities:  0x%0x\n", vidix_cap.flags );
!     
      OSDpseudo_alpha = true;
  
!     if (setupStore.pixelFormat == 0)
        vidix_fourcc.fourcc = IMGFMT_I420;
!     else if(setupStore.pixelFormat == 1)
        vidix_fourcc.fourcc = IMGFMT_YV12;
  
!     currentPixelFormat = setupStore.pixelFormat;
      screenPixelAspect = -1;
  
      vdlQueryFourcc(vidix_handler, &vidix_fourcc);
  
      memset(&vidix_play, 0, sizeof(vidix_playback_t));
--- 147,177 ----
      if( (err = vdlGetCapability(vidix_handler,&vidix_cap)) != 0)
      {
!        esyslog("[cVidixVideoOut] Couldn't get capability: %s exiting\n",
!                strerror(err) );
         exit(1);
      }
      printf("cVidixVideoOut: capabilities:  0x%0x\n", vidix_cap.flags );
! 
      OSDpseudo_alpha = true;
  
!     if (setupStore->pixelFormat == 0)
        vidix_fourcc.fourcc = IMGFMT_I420;
!     else if(setupStore->pixelFormat == 1)
        vidix_fourcc.fourcc = IMGFMT_YV12;
+     else if (setupStore->pixelFormat == 2)
+       vidix_fourcc.fourcc = IMGFMT_YUY2;
  
!     currentPixelFormat = setupStore->pixelFormat;
      screenPixelAspect = -1;
  
      vdlQueryFourcc(vidix_handler, &vidix_fourcc);
+     if (vdlQueryFourcc(vidix_handler, &vidix_fourcc))
+     {
+       if (!matchPixelFormat())
+       {
+         esyslog("[cVidixVideoOut]: no matching pixel format found exiting\n");
+         exit(1);
+       }
+     }
  
      memset(&vidix_play, 0, sizeof(vidix_playback_t));
***************
*** 190,194 ****
  
         gr_key.ckey.op = CKEY_TRUE;
!        gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 32;
  
         vdlSetGrKeys(vidix_handler, &gr_key);
--- 201,206 ----
  
         gr_key.ckey.op = CKEY_TRUE;
!        //gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 32;
!        gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
  
         vdlSetGrKeys(vidix_handler, &gr_key);
***************
*** 200,207 ****
--- 212,244 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
+ bool cVidixVideoOut::matchPixelFormat()
+ {
+   for (int i = 0; i < 3; ++i)
+   {
+     switch (i)
+     {
+       case 0: vidix_fourcc.fourcc = IMGFMT_I420; break;
+       case 1: vidix_fourcc.fourcc = IMGFMT_YV12; break;
+       case 2: vidix_fourcc.fourcc = IMGFMT_YUY2; break;
+     }
+     if (!vdlQueryFourcc(vidix_handler, &vidix_fourcc))
+     {
+       currentPixelFormat = setupStore->pixelFormat = i;
+       return true;
+     }
+   }
+   return false;
+ }
+ 
+ /* ----------------------------------------------------------------------------
+  */
  void cVidixVideoOut::Pause(void)
  {
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  void cVidixVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride)
  {
***************
*** 213,242 ****
      TIMINGS("start...\n");
      
!     if (aspect_changed || currentPixelFormat != setupStore.pixelFormat)
      {
         printf("cVidixVideoOut: Video changed format to %dx%d\n", Width, Height);
  
!        if((Xres > Width || Yres > Height) && (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
         {
!            printf("cVidixVideoOut : vidix driver can't upscale image (%dx%d -> %dx%d)\n", Width, Height, Xres, Yres);
             exit(1);
         }
  
!        if((Xres < Width || Yres < Height) && (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
         {
!            printf("cVidixVideoOut : vidix driver can't downscale image (%dx%d -> %dx%d)\n", Width, Height, Xres, Yres);
             exit(1);
         }
  
!        if (currentPixelFormat != setupStore.pixelFormat)
         {
!          if (setupStore.pixelFormat == 0)
!            vidix_play.fourcc = IMGFMT_I420;
!          else if(setupStore.pixelFormat == 1)
!            vidix_play.fourcc = IMGFMT_YV12;
  
!          currentPixelFormat = setupStore.pixelFormat;
         }
  
         vidix_play.src.w  = swidth;
         vidix_play.src.h  = sheight;
--- 250,295 ----
      TIMINGS("start...\n");
      
!     if (aspect_changed || currentPixelFormat != setupStore->pixelFormat)
      {
         printf("cVidixVideoOut: Video changed format to %dx%d\n", Width, Height);
  
!        if((Xres > Width || Yres > Height) &&
!           (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
         {
!            esyslog("[cVidixVideoOut] vidix driver can't upscale image (%dx%d -> %dx%d) exiting\n",
!                    Width, Height, Xres, Yres);
             exit(1);
         }
  
!        if((Xres < Width || Yres < Height) &&
!           (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
         {
!            esyslog("[cVidixVideoOut] vidix driver can't downscale image (%dx%d -> %dx%d) exiting\n",
!                    Width, Height, Xres, Yres);
             exit(1);
         }
  
!        if (currentPixelFormat != setupStore->pixelFormat)
         {
!          if (setupStore->pixelFormat == 0)
!            vidix_fourcc.fourcc = IMGFMT_I420;
!          else if(setupStore->pixelFormat == 1)
!            vidix_fourcc.fourcc = IMGFMT_YV12;
!          else if(setupStore->pixelFormat == 2)
!            vidix_fourcc.fourcc = IMGFMT_YUY2;
  
!          currentPixelFormat = setupStore->pixelFormat;
!          if (vdlQueryFourcc(vidix_handler, &vidix_fourcc))
!          {
!           if (!matchPixelFormat())
!           {
!             esyslog("[cVidixVideoOut]: no matching pixel format found exiting\n");
!             exit(1);
!           }
!          }
         }
  
+        vidix_play.fourcc       = vidix_fourcc.fourcc;
+ 
         vidix_play.src.w  = swidth;
         vidix_play.src.h  = sheight;
***************
*** 251,269 ****
         vidix_play.src.pitch.v=UVstride;
  
         if((err = vdlPlaybackOff(vidix_handler)) != 0) {
!            printf("cVidixVideoOut : Can't stop playback: %s\n", strerror(err));
             exit(1);
         }
  
         if((err = vdlConfigPlayback(vidix_handler, &vidix_play)) != 0) {
!            printf("cVidixVideoOut : Can't configure playback: %s\n", strerror(err));
             exit(1);
         }
  
         if((err = vdlPlaybackOn(vidix_handler)) != 0) {
!            printf("cVidixVideoOut : Can't start playback: %s\n", strerror(err));
             exit(1);
         }
!   
         if( vidix_fourcc.flags & VID_CAP_COLORKEY )
         {
--- 304,328 ----
         vidix_play.src.pitch.v=UVstride;
  
+        if (currentPixelFormat == 2)
+          vidix_play.src.pitch.y *= 2;
+ 
         if((err = vdlPlaybackOff(vidix_handler)) != 0) {
!            esyslog("[cVidixVideoOut] Can't stop playback: %s exiting\n",
!                    strerror(err));
             exit(1);
         }
  
         if((err = vdlConfigPlayback(vidix_handler, &vidix_play)) != 0) {
!            esyslog("[cVidixVideoOut] Can't configure playback: %s exiting\n",
!                    strerror(err));
             exit(1);
         }
  
         if((err = vdlPlaybackOn(vidix_handler)) != 0) {
!            esyslog("[cVidixVideoOut] Can't start playback: %s exiting\n",
!                    strerror(err));
             exit(1);
         }
! 
         if( vidix_fourcc.flags & VID_CAP_COLORKEY )
         {
***************
*** 274,278 ****
  
           gr_key.ckey.op = CKEY_TRUE;
!          gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0xff;
  
           vdlSetGrKeys(vidix_handler, &gr_key);
--- 333,338 ----
  
           gr_key.ckey.op = CKEY_TRUE;
!          //gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0xff;
!          gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
  
           vdlSetGrKeys(vidix_handler, &gr_key);
***************
*** 303,306 ****
--- 363,367 ----
         }
  
+ #if 0
         printf("cVidixVideoOut : num_frames=%d \n", vidix_play.num_frames);
         printf("cVidixVideoOut : frame_size=%d\n",  vidix_play.frame_size);
***************
*** 317,323 ****
         printf("cVidixVideoOut : dstrides.u=%d\n", dstrides.u);
         printf("cVidixVideoOut : dstrides.v=%d\n", dstrides.v);
      }
      TIMINGS("after if, before Y\n");
!     
      // Plane Y
      dst = (uint8_t *) vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.y;
--- 378,385 ----
         printf("cVidixVideoOut : dstrides.u=%d\n", dstrides.u);
         printf("cVidixVideoOut : dstrides.v=%d\n", dstrides.v);
+ #endif
      }
      TIMINGS("after if, before Y\n");
! 
      // Plane Y
      dst = (uint8_t *) vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.y;
***************
*** 327,409 ****
      Pu += (UVstride * syoff/2);
  
  #if VDRVERSNUM >= 10307
!     OsdRefreshCounter=0;
!     if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!        for(hi=0; hi < sheight; hi++){
!            AlphaBlend(dst,OsdPy+hi*OSD_FULL_WIDTH,
!             Py + sxoff,
!             OsdPAlphaY+hi*OSD_FULL_WIDTH,swidth);
            Py  += Ystride;
            dst += dstrides.y;
!   
!        }
!        EMMS;
!     } else
  #endif
!     for(hi=0; hi < sheight; hi++){
!          memcpy(dst, Py+sxoff, swidth);
!          Py  += Ystride;
            dst += dstrides.y;
!       }
!     
!     TIMINGS("Before YUV\n");
!     
!     if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
!     {
          dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
  
          for(hi = 0; hi < sheight/2; hi++) {
!             for(wi = 0; wi < swidth/2; wi++) {
!                 dst[2*wi+0] = Pu[wi+sxoff/2];
!                 dst[2*wi+1] = Pv[wi+sxoff/2];
!             }
  
!             dst += dstrides.y;
!             Pu += UVstride;
!            Pv += UVstride;
!        }
!     } else {
!       
!       // Plane U
!       dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
  
  #if VDRVERSNUM >= 10307
!       if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) { 
!          for(hi=0; hi < sheight/2; hi++){
!              AlphaBlend(dst,OsdPu+hi*OSD_FULL_WIDTH/2,
                 Pu + sxoff/2,
                 OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,swidth/2);
!              Pu  += UVstride;
!              dst += dstrides.y / 2;
!          }
!          
!          // Plane V
!          dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!          for(hi=0; hi < sheight/2; hi++) {
!                  AlphaBlend(dst, OsdPv+hi*OSD_FULL_WIDTH/2,
!                    Pv + sxoff/2, 
                     OsdPAlphaUV+hi*OSD_FULL_WIDTH/2, swidth/2);
!                  Pv   += UVstride;
!                  dst += dstrides.v / 2;
!          }
  
!          EMMS;
!      } else 
  #endif
!      {
!         for(hi=0; hi < sheight/2; hi++) {
!                memcpy(dst, Pu+sxoff/2, swidth/2);
!                Pu   += UVstride;
!                dst += dstrides.u / 2;
!          }
  
!          // Plane V
!          dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!          for(hi=0; hi < sheight/2; hi++) {
!                 memcpy(dst, Pv+sxoff/2, swidth/2);
!                 Pv   += UVstride;
!                 dst += dstrides.v / 2;
!          }
!        }
      }
  
--- 389,529 ----
      Pu += (UVstride * syoff/2);
  
+     if (currentPixelFormat == 0 || currentPixelFormat == 1)
+     {
  #if VDRVERSNUM >= 10307
!       OsdRefreshCounter=0;
!       if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         for(hi=0; hi < sheight; hi++){
!           AlphaBlend(dst,OsdPy+hi*OSD_FULL_WIDTH,
!               Py + sxoff,
!               OsdPAlphaY+hi*OSD_FULL_WIDTH,swidth);
            Py  += Ystride;
            dst += dstrides.y;
! 
!         }
!         EMMS;
!       } else
  #endif
! 
!         for(hi=0; hi < sheight; hi++){
!           memcpy(dst, Py+sxoff, swidth);
!           Py  += Ystride;
            dst += dstrides.y;
!         }
! 
!       TIMINGS("Before YUV\n");
! 
!       if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
!       {
          dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
  
          for(hi = 0; hi < sheight/2; hi++) {
!           for(wi = 0; wi < swidth/2; wi++) {
!             dst[2*wi+0] = Pu[wi+sxoff/2];
!             dst[2*wi+1] = Pv[wi+sxoff/2];
!           }
  
!           dst += dstrides.y;
!           Pu += UVstride;
!           Pv += UVstride;
!         }
!       } else {
! 
!         // Plane U
!         dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
  
  #if VDRVERSNUM >= 10307
!         if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!           for(hi=0; hi < sheight/2; hi++){
!             AlphaBlend(dst,OsdPu+hi*OSD_FULL_WIDTH/2,
                 Pu + sxoff/2,
                 OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,swidth/2);
!             Pu  += UVstride;
!             dst += dstrides.y / 2;
!           }
! 
!           // Plane V
!           dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!           for(hi=0; hi < sheight/2; hi++) {
!             AlphaBlend(dst, OsdPv+hi*OSD_FULL_WIDTH/2,
!                    Pv + sxoff/2,
                     OsdPAlphaUV+hi*OSD_FULL_WIDTH/2, swidth/2);
!             Pv  += UVstride;
!             dst += dstrides.v / 2;
!           }
  
!           EMMS;
!         } else
  #endif
!         {
!           for(hi=0; hi < sheight/2; hi++) {
!             memcpy(dst, Pu+sxoff/2, swidth/2);
!             Pu   += UVstride;
!             dst += dstrides.u / 2;
!           }
  
!           // Plane V
!           dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!           for(hi=0; hi < sheight/2; hi++) {
!             memcpy(dst, Pv+sxoff/2, swidth/2);
!             Pv   += UVstride;
!             dst += dstrides.v / 2;
!           }
!         }
!       }
!     } else if (currentPixelFormat == 2) {
! 
! #ifndef USE_MMX
! 
!       /* reference implementation */
!       //int p = vidix_play.src.pitch.y - Width*2;
!       for (int i=0; i<Height; i++) {
!         for (int j =0; j < Width/2; j++) {
!           *dst = *(Py + (j*2) + i * Ystride);
!           dst +=1;
!           *dst = *(Pu + j + (i/2) * UVstride);
!           dst +=1;
!           *dst = *(Py + (j*2)+1 + i * Ystride);
!           dst +=1;
!           *dst = *(Pv + j + (i/2) * UVstride);
!           dst +=1;
!         }
!         //dst +=p;
!       }
! #else
!       /* deltas */
!       for (int i=0; i<Height; i++) {
!           uint8_t *pu, *pv, *py, *srfc;
! 
!         pu = Pu;
!         pv = Pv;
!         py = Py;
!         srfc = dst;
!         for (int j =0; j < Width/8; j++) {
!           movd_m2r(*pu, mm1);       // mm1 = 00 00 00 00 U3 U2 U1 U0
!           movd_m2r(*pv, mm2);       // mm2 = 00 00 00 00 V3 V2 V1 V0
!           movq_m2r(*py, mm0);       // mm0 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
!           punpcklbw_r2r(mm2, mm1);  // mm1 = V3 U3 V2 U2 V1 U1 V0 U0
!           movq_r2r(mm0,mm3);        // mm3 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
!           movq_r2r(mm1,mm4);        // mm4 = V3 U3 V2 U2 V1 U1 V0 U0
!           punpcklbw_r2r(mm1, mm0);  // mm0 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
!           punpckhbw_r2r(mm4, mm3);  // mm3 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
! 
!           movntq(mm0,*srfc);        // Am Meisten brauchen die Speicherzugriffe
!           srfc+=8;
!           py+=8;
!           pu+=4;
!           pv+=4;
!           movntq(mm3,*srfc);      // wenn movntq nicht geht, dann movq verwenden
!           srfc+=8;
!         }
!         Py += Ystride;;
!         if (i % 2 == 1) {
!           Pu += UVstride;
!           Pv += UVstride;
!         }
!         dst += Width*2;
!       }
! #endif
      }
  
***************
*** 450,454 ****
                ToYUV(Bitmap);
              break;
!     };
  }
  
--- 570,574 ----
                ToYUV(Bitmap);
              break;
!     }
  }
  
***************
*** 512,513 ****
--- 632,643 ----
      if (fbdev) close(fbdev);
  }
+ 
+ #ifdef USE_SUBPLUGINS
+ /* ---------------------------------------------------------------------------
+  */
+ extern "C" void *
+ SubPluginCreator(cSetupStore *s)
+ {
+   return new cVidixVideoOut(s);
+ }
+ #endif

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-vidix.h	18 Feb 2005 13:31:27 -0000	1.2
--- video-vidix.h	24 Feb 2005 22:35:51 -0000	1.3
***************
*** 41,45 ****
  
  public:
!   cVidixVideoOut();
    virtual ~cVidixVideoOut();
  
--- 41,45 ----
  
  public:
!   cVidixVideoOut(cSetupStore *setupStore);
    virtual ~cVidixVideoOut();
  
***************
*** 56,59 ****
--- 56,61 ----
    virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);
+ 
+   bool matchPixelFormat(void);
  };
  

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video-xv.c	18 Feb 2005 13:31:27 -0000	1.15
--- video-xv.c	24 Feb 2005 22:35:51 -0000	1.16
***************
*** 508,512 ****
            case 'r':
            case 'R':
!             setupStore.shouldSuspend=!setupStore.shouldSuspend;
  #endif
            default:
--- 508,512 ----
            case 'r':
            case 'R':
!             setupStore->shouldSuspend=!setupStore->shouldSuspend;
  #endif
            default:
***************
*** 576,580 ****
  /* ---------------------------------------------------------------------------
   */
! cXvVideoOut::cXvVideoOut(int aspect, int port, int crop, int xres, int yres)
  {
    OSDpresent = false;
--- 576,581 ----
  /* ---------------------------------------------------------------------------
   */
! cXvVideoOut::cXvVideoOut(cSetupStore *setupStore)
!               : cVideoOut(setupStore)
  {
    OSDpresent = false;
***************
*** 584,595 ****
     * could be specified by argv ! TODO
     */
!   display_aspect = current_aspect = aspect;
    scale_size = 0;
    screenPixelAspect = -1;
!   width = xres;
!   height = yres;
  
    format = FOURCC_YV12;
!   use_xv_port = port;
    len = width * height * 4;
    outbuffer = NULL;
--- 585,596 ----
     * could be specified by argv ! TODO
     */
!   display_aspect = current_aspect = setupStore->xvAspect;
    scale_size = 0;
    screenPixelAspect = -1;
!   width = XV_SRC_WIDTH;
!   height = XV_SRC_HEIGHT;
  
    format = FOURCC_YV12;
!   use_xv_port = 0;
    len = width * height * 4;
    outbuffer = NULL;
***************
*** 606,610 ****
    fwidth = lwidth = dwidth = swidth = width;
    fheight = lheight = dheight = sheight = height;
-   sxoff = syoff = lxoff = lyoff = 0;
  
    if (current_aspect == DV_FORMAT_NORMAL) {
--- 607,610 ----
***************
*** 961,973 ****
  /* ---------------------------------------------------------------------------
   */
- cXvVideoOut::cXvVideoOut() : cVideoOut()
- {
-   //start osd refresh thread
-   active=true;
-   Start();  
- }
- 
- /* ---------------------------------------------------------------------------
-  */
  void cXvVideoOut::Pause(void)
  {
--- 961,964 ----
***************
*** 1332,1333 ****
--- 1323,1334 ----
  #endif
  }
+ 
+ #ifdef USE_SUBPLUGINS
+ /* ---------------------------------------------------------------------------
+  */
+ extern "C" void *
+ SubPluginCreator(cSetupStore *s)
+ {
+   return new cXvVideoOut(s);
+ }
+ #endif

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-xv.h	18 Feb 2005 13:31:27 -0000	1.5
--- video-xv.h	24 Feb 2005 22:35:51 -0000	1.6
***************
*** 139,145 ****
  
  public:
!   cXvVideoOut();
!   cXvVideoOut (int aspect = DV_FORMAT_NORMAL, int port = 0, int crop = 0,
!                int xres = XV_SRC_WIDTH, int yres = XV_SRC_HEIGHT);
    virtual ~cXvVideoOut();
    void ProcessEvents ();
--- 139,143 ----
  
  public:
!   cXvVideoOut(cSetupStore *setupStore);
    virtual ~cXvVideoOut();
    void ProcessEvents ();

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video.c	18 Feb 2005 17:38:06 -0000	1.9
--- video.c	24 Feb 2005 22:35:51 -0000	1.10
***************
*** 16,20 ****
  
  
! cVideoOut::cVideoOut()
  {
  #if VDRVERSNUM >= 10307
--- 16,20 ----
  
  
! cVideoOut::cVideoOut(cSetupStore *setupStore)
  {
  #if VDRVERSNUM >= 10307
***************
*** 22,27 ****
    OsdHeight=OSD_FULL_HEIGHT;
  #endif
!   syoff=sxoff=0;
    PixelMask=NULL;
   //start thread
   // active=true;
--- 22,28 ----
    OsdHeight=OSD_FULL_HEIGHT;
  #endif
!   sxoff = syoff = lxoff = lyoff = 0;
    PixelMask=NULL;
+   this->setupStore=setupStore;
   //start thread
   // active=true;
***************
*** 49,60 ****
      OsdRefreshCounter++;
      
!     changeMode=(current_osdMode != setupStore.osdMode);
!     newOsdMode=setupStore.osdMode;
      // if software osd has not been shown for some time fall back
      // to pseudo osd..
!     if ( OsdRefreshCounter > 40 && setupStore.osdMode == OSDMODE_SOFTWARE ) {
          changeMode= (current_osdMode != OSDMODE_PSEUDO);
          newOsdMode=OSDMODE_PSEUDO;
!     };
      
      GetOSDDimension(newOsdWidth,newOsdHeight);
--- 50,61 ----
      OsdRefreshCounter++;
      
!     changeMode=(current_osdMode != setupStore->osdMode);
!     newOsdMode=setupStore->osdMode;
      // if software osd has not been shown for some time fall back
      // to pseudo osd..
!     if ( OsdRefreshCounter > 40 && setupStore->osdMode == OSDMODE_SOFTWARE ) {
          changeMode= (current_osdMode != OSDMODE_PSEUDO);
          newOsdMode=OSDMODE_PSEUDO;
!     }
      
      GetOSDDimension(newOsdWidth,newOsdHeight);
***************
*** 85,95 ****
          OpenOSD(OSDxOfs,OSDyOfs);
          osd=osdSave;
!       };
        osd->Flush();
      }
      usleep(50000);
!   };
  #endif
! };
  
  /* ---------------------------------------------------------------------------
--- 86,96 ----
          OpenOSD(OSDxOfs,OSDyOfs);
          osd=osdSave;
!       }
        osd->Flush();
      }
      usleep(50000);
!   }
  #endif
! }
  
  /* ---------------------------------------------------------------------------
***************
*** 112,116 ****
     * override afd value with crop value from setup
     */
!   new_afd = (setupStore.cropMode) ? setupStore.cropMode : new_afd;
  
    /* -------------------------------------------------------------------------
--- 113,117 ----
     * override afd value with crop value from setup
     */
!   new_afd = (setupStore->cropMode) ? setupStore->cropMode : new_afd;
  
    /* -------------------------------------------------------------------------
***************
*** 118,124 ****
     */
  
!   if (screenPixelAspect != setupStore.screenPixelAspect)
    {
!     screenPixelAspect = setupStore.screenPixelAspect;
      /* -----------------------------------------------------------------------
       * force recalculation for aspect ration handling
--- 119,125 ----
     */
  
!   if (screenPixelAspect != setupStore->screenPixelAspect)
    {
!     screenPixelAspect = setupStore->screenPixelAspect;
      /* -----------------------------------------------------------------------
       * force recalculation for aspect ration handling
***************
*** 133,137 ****
    }
  
!   setupStore.getScreenDimension (screenWidth, screenHeight);
    aspect_changed = 1;
  
--- 134,138 ----
    }
  
!   setupStore->getScreenDimension (screenWidth, screenHeight);
    aspect_changed = 1;
  
***************
*** 343,352 ****
  void cVideoOut::CloseOSD()
  {
!   osdMutex.Lock(); 
    if (OsdPAlphaY)
!        memset(OsdPAlphaY,0,Xres*Yres);
    if (OsdPAlphaUV)
!        memset(OsdPAlphaUV,0,Xres*Yres/4);
!  
    osd=NULL;
    OSDpresent=false;
--- 344,353 ----
  void cVideoOut::CloseOSD()
  {
!   osdMutex.Lock();
    if (OsdPAlphaY)
!        memset(OsdPAlphaY,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
    if (OsdPAlphaUV)
!        memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
! 
    osd=NULL;
    OSDpresent=false;
***************
*** 589,595 ****
        //  OSDdirty);
        x1=y1=0;
!       x2=Bitmap->Width();
!       y2=Bitmap->Height();
!    };
  
  #define SCALEX(x) ((x) * OsdWidth/OSD_FULL_WIDTH)
--- 590,596 ----
        //  OSDdirty);
        x1=y1=0;
!       x2=Bitmap->Width()-1;
!       y2=Bitmap->Height()-1;
!    }
  
  #define SCALEX(x) ((x) * OsdWidth/OSD_FULL_WIDTH)

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** video.h	18 Feb 2005 13:31:27 -0000	1.8
--- video.h	24 Feb 2005 22:35:51 -0000	1.9
***************
*** 11,14 ****
--- 11,16 ----
  
  #include <vdr/plugin.h>
+ #include "setup-softdevice.h"
+ 
  #if VDRVERSNUM >= 10307
  #include <vdr/osd.h>
***************
*** 89,93 ****
              aspect_changed,
              current_afd;
!     
      cOsd *osd;
      bool active;
--- 91,97 ----
              aspect_changed,
              current_afd;
! 
!     cSetupStore *setupStore;
!                 
      cOsd *osd;
      bool active;
***************
*** 95,99 ****
  
  public:
!     cVideoOut();
      virtual ~cVideoOut();
      virtual void Size(int w, int h) {OSDw = w; OSDh = h;};
--- 99,103 ----
  
  public:
!     cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
      virtual void Size(int w, int h) {OSDw = w; OSDh = h;};



From nobody at sheep.berlios.de  Sun Feb 27 09:52:36 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 27 Feb 2005 09:52:36 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.35,1.36 Makefile,1.6,1.7 setup-softdevice.c,1.10,1.11 setup-softdevice.h,1.7,1.8 softdevice.c,1.14,1.15 video-dfb.c,1.18,1.19
Message-ID: <200502270852.j1R8qaN07137@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32080

Modified Files:
	CHANGELOG Makefile setup-softdevice.c setup-softdevice.h 
	softdevice.c video-dfb.c 
Log Message:
- save "vo" and "ao" calling args in setup store.
- new runtime arg "-L path_name". Default set in Makefile to: "./PLUGINS/lib"
- USE_SUBPLUGINS is now default build option
- dfb-out: fix for segfault on via unichrome with current DirectFB cvs.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** CHANGELOG	24 Feb 2005 22:35:50 -0000	1.35
--- CHANGELOG	27 Feb 2005 08:52:33 -0000	1.36
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+  2005-02-27:
+     - save "vo" and "ao" calling args in setup store.
+     - new runtime arg "-L path_name". Default set in Makefile to: "./PLUGINS/lib"
+     - USE_SUBPLUGINS is now default build option
+     - dfb-out: fix for segfault on via unichrome with current DirectFB cvs.
   2005-02-25:
      - vidix-out: fix segfaults upon switch from software OSD back to pseudo mode.

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** Makefile	24 Feb 2005 22:35:50 -0000	1.6
--- Makefile	27 Feb 2005 08:52:33 -0000	1.7
***************
*** 56,60 ****
  # -----------------------------------------------------------------------------
  # if you want output methods build as separate libs uncomment this
! #USE_SUBPLUGINS = 1
  
  # -----------------------------------------------------------------------------
--- 56,60 ----
  # -----------------------------------------------------------------------------
  # if you want output methods build as separate libs uncomment this
! USE_SUBPLUGINS = 1
  
  # -----------------------------------------------------------------------------
***************
*** 146,149 ****
--- 146,150 ----
  
  DEFINES += -DPLUGIN_NAME_I18N='"$(PLUGIN)"' -D_GNU_SOURCE
+ DEFINES += -DPLUGINLIBDIR='"./PLUGINS/lib"'
  
  ### The object files (add further files here):

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** setup-softdevice.c	24 Feb 2005 22:35:51 -0000	1.10
--- setup-softdevice.c	27 Feb 2005 08:52:33 -0000	1.11
***************
*** 130,133 ****
--- 130,134 ----
  
    strcpy (alsaDevice, "");
+   voArgs = aoArgs = NULL;
  }
  

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** setup-softdevice.h	24 Feb 2005 22:35:51 -0000	1.7
--- setup-softdevice.h	27 Feb 2005 08:52:33 -0000	1.8
***************
*** 39,42 ****
--- 39,44 ----
      int   osdMode;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
+     char  *voArgs;
+     char  *aoArgs;
  };
  

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** softdevice.c	24 Feb 2005 22:35:51 -0000	1.14
--- softdevice.c	27 Feb 2005 08:52:33 -0000	1.15
***************
*** 226,230 ****
  class cPluginSoftDevice : public cPlugin {
  private:
!   int voutMethod;
  
  public:
--- 226,231 ----
  class cPluginSoftDevice : public cPlugin {
  private:
!   int   voutMethod;
!   char  *pluginPath;
  
  public:
***************
*** 266,270 ****
  
  public:
!   cSoftDevice(int method = 0);
    ~cSoftDevice();
    virtual bool HasDecoder(void) const;
--- 267,271 ----
  
  public:
!   cSoftDevice(int method, char *pluginPath);
    ~cSoftDevice();
    virtual bool HasDecoder(void) const;
***************
*** 295,299 ****
  };
  
! cSoftDevice::cSoftDevice(int method)
  {
      freezeModeEnabled = false;
--- 296,300 ----
  };
  
! cSoftDevice::cSoftDevice(int method,char *pluginPath)
  {
      freezeModeEnabled = false;
***************
*** 306,310 ****
  #ifdef USE_SUBPLUGINS
    {
-       char  *pluginPath = "./PLUGINS/lib";
        char  *subPluginFileName = NULL;
        char  *outMethodName  = NULL;
--- 307,310 ----
***************
*** 612,615 ****
--- 612,616 ----
    voutMethod = 0;
  #endif
+   pluginPath = PLUGINLIBDIR;
  }
  
***************
*** 639,642 ****
--- 640,644 ----
    "  -vo vidix:               enable output via vidix driver\n"
  #endif
+   "  -L <plugin_path_name>    search path for loading subplugins\n"
    "\n";
  }
***************
*** 658,661 ****
--- 660,664 ----
          if (!strncmp (vo_argv, "xv:", 3)) {
            vo_argv += 3;
+           setupStore.voArgs = vo_argv;
  #ifdef XV_SUPPORT
            voutMethod = VOUT_XV;
***************
*** 681,684 ****
--- 684,688 ----
          } else if (!strncmp (vo_argv, "fb:", 3)) {
            vo_argv += 3;
+           setupStore.voArgs = vo_argv;
  #ifdef FB_SUPPORT
            voutMethod = VOUT_FB;
***************
*** 688,691 ****
--- 692,696 ----
          } else if (!strncmp (vo_argv, "dfb:", 4)) {
            vo_argv += 4;
+           setupStore.voArgs = vo_argv;
  #ifdef DFB_SUPPORT
            voutMethod = VOUT_DFB;
***************
*** 697,700 ****
--- 702,706 ----
          } else if (!strncmp (vo_argv, "vidix:", 6)) {
            vo_argv += 6;
+           setupStore.voArgs = vo_argv;
  #ifdef VIDIX_SUPPORT
            voutMethod = VOUT_VIDIX;
***************
*** 711,718 ****
--- 717,730 ----
          if (!strncmp(ao_argv, "alsa:", 5)) {
            ao_argv += 5;
+           setupStore.aoArgs = ao_argv;
            fprintf(stderr, "[softdevice] using alsa device %s\n", ao_argv);
            strncpy(setupStore.alsaDevice, ao_argv, ALSA_DEVICE_NAME_LENGTH);
          }
        }
+     } else if (!strcmp (argv[i], "-L")) {
+       ++i; --argc;
+       if (argc > 0) {
+         pluginPath = argv[i];
+       }
      }
      ++i;
***************
*** 733,737 ****
    // Start any background activities the plugin shall perform.
    fprintf(stderr,"[softdevice] initializing Plugin\n");
!   new cSoftDevice(voutMethod);
    return true;
  }
--- 745,749 ----
    // Start any background activities the plugin shall perform.
    fprintf(stderr,"[softdevice] initializing Plugin\n");
!   new cSoftDevice(voutMethod,pluginPath);
    return true;
  }

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-dfb.c	24 Feb 2005 22:35:51 -0000	1.18
--- video-dfb.c	27 Feb 2005 08:52:33 -0000	1.19
***************
*** 585,591 ****
        }
  #endif
!                dlc.flags   = (DFBDisplayLayerConfigFlags)
!                               ((int) dlc.flags | DLCONF_OPTIONS);
!                dlc.options  = DLOP_FIELD_PARITY; //DLOP_NONE; //DLOP_FIELD_PARITY;
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 585,591 ----
        }
  #endif
!       dlc.flags = (DFBDisplayLayerConfigFlags)((int) dlc.flags | DLCONF_OPTIONS);
! 
!       dlc.options = DLOP_FIELD_PARITY;
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
***************
*** 646,652 ****
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
! 
!         if (isVIAUnichrome)
!           videoLayer->SetLevel(1);
  
          /* --------------------------------------------------------------------
--- 646,659 ----
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
!         try
!         {
!           if (isVIAUnichrome)
!             videoLayer->SetLevel(1);
!         }
!         catch (DFBException *ex)
!         {
!           fprintf (stderr,"Caught: action=%s, result=%s\n",
!                    ex->GetAction(), ex->GetResult());
!         }
  
          /* --------------------------------------------------------------------
***************
*** 661,670 ****
            fprintf (stderr,"Caught: action=%s, result=%s\n",
                     ex->GetAction(), ex->GetResult());
-           //exit(1);
          }
  
-         //if (setupStore->useMGAtv)
-           //videoLayer->SetFieldParity(0);
- 
  #if HAVE_SetSourceLocation
          try
--- 668,673 ----
***************
*** 775,779 ****
      IDirectFBSurface  *tmpSurface;
  
!   // don't update only dirty areas 
    OSDdirty=true;
  
--- 778,782 ----
      IDirectFBSurface  *tmpSurface;
  
!   // don't update only dirty areas
    OSDdirty=true;
  



From nobody at sheep.berlios.de  Wed Mar  2 09:39:38 2005
From: nobody at sheep.berlios.de (wachm)
Date: Wed, 2 Mar 2005 09:39:38 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.10,1.11 CHANGELOG,1.36,1.37
Message-ID: <200503020839.j228dcN24005@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11448

Modified Files:
	video.c CHANGELOG 
Log Message:
- increased osd fallback timeout
- removed sxoff & syoff from Draw()


Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video.c	24 Feb 2005 22:35:51 -0000	1.10
--- video.c	2 Mar 2005 08:39:36 -0000	1.11
***************
*** 54,58 ****
      // if software osd has not been shown for some time fall back
      // to pseudo osd..
!     if ( OsdRefreshCounter > 40 && setupStore->osdMode == OSDMODE_SOFTWARE ) {
          changeMode= (current_osdMode != OSDMODE_PSEUDO);
          newOsdMode=OSDMODE_PSEUDO;
--- 54,58 ----
      // if software osd has not been shown for some time fall back
      // to pseudo osd..
!     if ( OsdRefreshCounter > 80 && setupStore->osdMode == OSDMODE_SOFTWARE ) {
          changeMode= (current_osdMode != OSDMODE_PSEUDO);
          newOsdMode=OSDMODE_PSEUDO;
***************
*** 482,490 ****
    {
      buf = (tIndex *) osd_buf +
!             linelen * (syoff + OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (sxoff+OSDxOfs + SCALEX(Bitmap->X0() + x1) ) * depth;
      PixelMaskPtr=PixelMask + 
!            linelen/16 * (syoff + OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (sxoff+OSDxOfs + SCALEX(Bitmap->X0() + x1)/8 );
      prev_pix = false;
  
--- 482,490 ----
    {
      buf = (tIndex *) osd_buf +
!             linelen * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (OSDxOfs + SCALEX(Bitmap->X0() + x1) ) * depth;
      PixelMaskPtr=PixelMask + 
!            linelen/16 * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (OSDxOfs + SCALEX(Bitmap->X0() + x1)/8 );
      prev_pix = false;
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** CHANGELOG	27 Feb 2005 08:52:33 -0000	1.36
--- CHANGELOG	2 Mar 2005 08:39:36 -0000	1.37
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+  2005-03-02:
+     - increased osd fallback timeout
+     - removed syoff and sxoff from Draw(...) 
   2005-02-27:
      - save "vo" and "ao" calling args in setup store.



From nobody at sheep.berlios.de  Thu Mar  3 19:16:28 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 3 Mar 2005 19:16:28 +0100
Subject: [Softdevice-cvs] softdevice Makefile,1.7,1.8 utils.c,1.2,1.3 utils.h,1.2,1.3 video-fb.c,1.5,1.6
Message-ID: <200503031816.j23IGSN27520@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17807

Modified Files:
	Makefile utils.c utils.h video-fb.c 
Log Message:
fix for build option USE_SUBPLUGINS


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** Makefile	27 Feb 2005 08:52:33 -0000	1.7
--- Makefile	3 Mar 2005 18:16:26 -0000	1.8
***************
*** 176,180 ****
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libvdr-$(PLUGIN)-fb.so
--- 176,180 ----
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libvdr-$(PLUGIN)-fb.so

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** utils.c	18 Feb 2005 13:31:27 -0000	1.2
--- utils.c	3 Mar 2005 18:16:26 -0000	1.3
***************
*** 207,211 ****
                   int width, int height,
                   int rgb_stride, int y_stride, int uv_stride,
!                  int dstW, int dstH, int depth, unsigned char * mask)
  {
  /*
--- 207,212 ----
                   int width, int height,
                   int rgb_stride, int y_stride, int uv_stride,
!                  int dstW, int dstH,
!                  int depth, unsigned char * mask, int deintMethod)
  {
  /*
***************
*** 258,262 ****
          int srcpix = x * width / dstW;
  
!       if (setupStore.deintMethod == 2) {
          // deinterlace with FB-intern method
          scaleY[x] = (Y[srcpix] / 2) + (Y1[srcpix] /4) + (Y2[srcpix] / 4);
--- 259,263 ----
          int srcpix = x * width / dstW;
  
!       if (deintMethod == 2) {
          // deinterlace with FB-intern method
          scaleY[x] = (Y[srcpix] / 2) + (Y1[srcpix] /4) + (Y2[srcpix] / 4);

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** utils.h	18 Feb 2005 13:31:27 -0000	1.2
--- utils.h	3 Mar 2005 18:16:26 -0000	1.3
***************
*** 25,32 ****
  */
  void yuv_to_rgb (uint8_t * image, uint8_t * py,
! 				  uint8_t * pu, uint8_t * pv,
! 				  int width, int height,
! 				  int rgb_stride, int y_stride, int uv_stride,
! 				  int dstW, int dstH, int depth, unsigned char * mask);
  uint64_t getTimeMilis(void);
  
--- 25,33 ----
  */
  void yuv_to_rgb (uint8_t * image, uint8_t * py,
!                  uint8_t * pu, uint8_t * pv,
!                  int width, int height,
!                  int rgb_stride, int y_stride, int uv_stride,
!                  int dstW, int dstH,
!                  int depth, unsigned char * mask, int deintMethod);
  uint64_t getTimeMilis(void);
  

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-fb.c	24 Feb 2005 22:35:51 -0000	1.5
--- video-fb.c	3 Mar 2005 18:16:26 -0000	1.6
***************
*** 21,25 ****
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
  // --- cFrameBuffer --------------------------------------------------------
! cFBVideoOut::cFBVideoOut(cSetupStore *etupStore)
                : cVideoOut(setupStore)
  {
--- 21,25 ----
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
  // --- cFrameBuffer --------------------------------------------------------
! cFBVideoOut::cFBVideoOut(cSetupStore *setupStore)
                : cVideoOut(setupStore)
  {
***************
*** 167,172 ****
                  OsdHeight=Yres;
               break;
!     };
! };
  
  void cFBVideoOut::Refresh(cBitmap *Bitmap)
--- 167,172 ----
                  OsdHeight=Yres;
               break;
!     }
! }
  
  void cFBVideoOut::Refresh(cBitmap *Bitmap)
***************
*** 204,210 ****
    pthread_mutex_lock(&fb_mutex);
    if (OSDpresent) {
!     yuv_to_rgb (fb, Py, Pu, Pv, Width, Height, line_len,Ystride,UVstride,Xres,Yres,Bpp, PixelMask);
    } else {
!     yuv_to_rgb (fb, Py, Pu, Pv, Width, Height, line_len,Ystride,UVstride,Xres,Yres,Bpp, NULL);
    }
    pthread_mutex_unlock(&fb_mutex);
--- 204,218 ----
    pthread_mutex_lock(&fb_mutex);
    if (OSDpresent) {
!     yuv_to_rgb (fb, Py, Pu, Pv,
!                 Width, Height, line_len,
!                 Ystride,UVstride,
!                 Xres,Yres,
!                 Bpp, PixelMask, setupStore->deintMethod);
    } else {
!     yuv_to_rgb (fb, Py, Pu, Pv,
!                 Width, Height, line_len,
!                 Ystride,UVstride,
!                 Xres,Yres,
!                 Bpp, NULL, setupStore->deintMethod);
    }
    pthread_mutex_unlock(&fb_mutex);



From nobody at sheep.berlios.de  Thu Mar  3 19:21:44 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 3 Mar 2005 19:21:44 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.11,1.12
Message-ID: <200503031821.j23ILiN27773@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19695

Modified Files:
	video.c 
Log Message:
fix alpha mask misplacement

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video.c	2 Mar 2005 08:39:36 -0000	1.11
--- video.c	3 Mar 2005 18:21:41 -0000	1.12
***************
*** 486,490 ****
      PixelMaskPtr=PixelMask + 
             linelen/16 * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (OSDxOfs + SCALEX(Bitmap->X0() + x1)/8 );
      prev_pix = false;
  
--- 486,490 ----
      PixelMaskPtr=PixelMask + 
             linelen/16 * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
!             (OSDxOfs + SCALEX(Bitmap->X0() + x1))/8;
      prev_pix = false;
  



From nobody at sheep.berlios.de  Thu Mar  3 19:32:48 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 3 Mar 2005 19:32:48 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.37,1.38 video-fb.c,1.6,1.7
Message-ID: <200503031832.j23IWmN28249@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20369

Modified Files:
	CHANGELOG video-fb.c 
Log Message:
fb-out: fix locking during video and OSD drawing

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** CHANGELOG	2 Mar 2005 08:39:36 -0000	1.37
--- CHANGELOG	3 Mar 2005 18:32:46 -0000	1.38
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+  2005-03-03:
+     - fb-out: fix for build option USE_SUBPLUGINS
+               fix alpha mask misplacement
+               fix locking during video and OSD drawing
   2005-03-02:
      - increased osd fallback timeout

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video-fb.c	3 Mar 2005 18:16:26 -0000	1.6
--- video-fb.c	3 Mar 2005 18:32:46 -0000	1.7
***************
*** 172,177 ****
--- 172,179 ----
  void cFBVideoOut::Refresh(cBitmap *Bitmap)
  {
+   pthread_mutex_lock(&fb_mutex);
    OSDpresent=true;
    Draw(Bitmap,fb,line_len);
+   pthread_mutex_unlock(&fb_mutex);
  }
  



From nobody at sheep.berlios.de  Thu Mar  3 21:22:19 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 3 Mar 2005 21:22:19 +0100
Subject: [Softdevice-cvs] softdevice video-fb.c,1.7,1.8 video-fb.h,1.3,1.4
Message-ID: <200503032022.j23KMJN30985@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29517

Modified Files:
	video-fb.c video-fb.h 
Log Message:
some additional adjustments on OSD and alpha mask positions

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video-fb.c	3 Mar 2005 18:32:46 -0000	1.7
--- video-fb.c	3 Mar 2005 20:22:17 -0000	1.8
***************
*** 152,159 ****
  /* ---------------------------------------------------------------------------
   */
  void cFBVideoOut::ClearOSD()
  {
    cVideoOut::ClearOSD();
!   if (PixelMask) 
      memset(PixelMask, 0, Xres * Yres/8);
  };
--- 152,168 ----
  /* ---------------------------------------------------------------------------
   */
+ void cFBVideoOut::OpenOSD(int X, int Y)
+ {
+   OSDxOfs = X & ~7;
+   OSDyOfs = Y & ~1;
+   OSDdirty=true;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cFBVideoOut::ClearOSD()
  {
    cVideoOut::ClearOSD();
!   if (PixelMask)
      memset(PixelMask, 0, Xres * Yres/8);
  };

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** video-fb.h	24 Feb 2005 22:35:51 -0000	1.3
--- video-fb.h	3 Mar 2005 20:22:17 -0000	1.4
***************
*** 29,32 ****
--- 29,33 ----
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
+   virtual void OpenOSD(int X, int Y);
    virtual void ClearOSD();
    virtual void Refresh(cBitmap *Bitmap);



From nobody at sheep.berlios.de  Fri Mar  4 21:04:23 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 4 Mar 2005 21:04:23 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.38,1.39 Makefile,1.8,1.9 i18n.c,1.1.1.1,1.2 setup-softdevice.c,1.11,1.12 softdevice.c,1.15,1.16 video-xv.c,1.16,1.17
Message-ID: <200503042004.j24K4NN10902@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9568

Modified Files:
	CHANGELOG Makefile i18n.c setup-softdevice.c softdevice.c 
	video-xv.c 
Log Message:
current version is 0.1.0pre1

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** CHANGELOG	3 Mar 2005 18:32:46 -0000	1.38
--- CHANGELOG	4 Mar 2005 20:04:20 -0000	1.39
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+  2005-03-04: 0.1.0pre1
+     - some i18n changes
   2005-03-03:
      - fb-out: fix for build option USE_SUBPLUGINS

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** Makefile	3 Mar 2005 18:16:26 -0000	1.8
--- Makefile	4 Mar 2005 20:04:20 -0000	1.9
***************
*** 55,59 ****
  
  # -----------------------------------------------------------------------------
! # if you want output methods build as separate libs uncomment this
  USE_SUBPLUGINS = 1
  
--- 55,59 ----
  
  # -----------------------------------------------------------------------------
! # if you want output methods build as a single lib comment the following line
  USE_SUBPLUGINS = 1
  

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** i18n.c	1 Aug 2004 05:07:04 -0000	1.1.1.1
--- i18n.c	4 Mar 2005 20:04:20 -0000	1.2
***************
*** 10,108 ****
  
  const tI18nPhrase Phrases[] = {
!   { "Hello",
!     "Hallo",
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
    },
!   { "Hello world!",
!     "Hallo Welt!",
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
    },
!   { "Howdy folks!",
!     "Tach zusammen!",
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
    },
!   { "A friendly greeting",
!     "Ein freundlicher Gru?",
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
    },
!   { "Greeting time (s)",
!     "Dauer des Gru?es (s)",
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
    },
!   { "Use alternate greeting",
!     "Alternativen Gru? verwenden",
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
!     "",// TODO
    },
    { NULL }
--- 10,264 ----
  
  const tI18nPhrase Phrases[] = {
!   { "Softdevice",   //  1
!     "Softdevice",   //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
    },
!   { "Xv startup aspect",   //  1
!     "Xv Startgr??e",       //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
    },
!   { "CropMode",         //  1
!     "Bildausschnitt",   //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
    },
!   { "Deinterlace Method",   //  1
!     "Deinterlace Method",   //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
    },
!   { "Pixel Format",   //  1
!     "Pixel Format",   //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
    },
!   { "Picture mirroring",    //  1
!     "Spiegelbild",          //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
!   },
!   { "A/V Delay",        //  1
!     "A/V Verz?gerung",  //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
!   },
!   { "Pixel Aspect",       //  1
!     "Seitenverh?ltnis",   //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
!   },
!   { "Playback",     //  1
!     "Wiedergabe",   //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
!   },
!   { "OSD alpha blending",   //  1
!     "OSD Einblendung",      //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
!   },
!   { "on",       //  1
!     "ein",      //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
!   },
!   { "off",          //  1
!     "aus",          //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "",             //  9 TODO
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
    },
    { NULL }

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** setup-softdevice.c	27 Feb 2005 08:52:33 -0000	1.11
--- setup-softdevice.c	4 Mar 2005 20:04:20 -0000	1.12
***************
*** 279,283 ****
                              &data->mirror, tr("off"), tr("on")));
  
!   Add(new cMenuEditIntItem(tr("A/V Offset"),
                             &data->avOffset,
                             MINAVOFFSET, MAXAVOFFSET));
--- 279,283 ----
                              &data->mirror, tr("off"), tr("on")));
  
!   Add(new cMenuEditIntItem(tr("A/V Delay"),
                             &data->avOffset,
                             MINAVOFFSET, MAXAVOFFSET));

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** softdevice.c	27 Feb 2005 08:52:33 -0000	1.15
--- softdevice.c	4 Mar 2005 20:04:20 -0000	1.16
***************
*** 75,79 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.0.8";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 75,79 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.1.0pre1";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video-xv.c	24 Feb 2005 22:35:51 -0000	1.16
--- video-xv.c	4 Mar 2005 20:04:20 -0000	1.17
***************
*** 29,33 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "008_pre_2"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 29,33 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "010_pre_1"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;



From nobody at sheep.berlios.de  Sat Mar  5 14:50:51 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 5 Mar 2005 14:50:51 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.39,1.40 mpeg2decoder.c,1.16,1.17 mpeg2decoder.h,1.12,1.13 softdevice.c,1.16,1.17
Message-ID: <200503051350.j25DopN02301@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23577

Modified Files:
	CHANGELOG mpeg2decoder.c mpeg2decoder.h softdevice.c 
Log Message:
fix audio stream selection

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** CHANGELOG	4 Mar 2005 20:04:20 -0000	1.39
--- CHANGELOG	5 Mar 2005 13:50:49 -0000	1.40
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+  2005-03-05:
+     - audio-out: fix audio stream selection
   2005-03-04: 0.1.0pre1
      - some i18n changes

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** mpeg2decoder.c	24 Feb 2005 22:35:50 -0000	1.16
--- mpeg2decoder.c	5 Mar 2005 13:50:49 -0000	1.17
***************
*** 304,312 ****
  }
  
! uint64_t cAudioStreamDecoder::GetPTS() 
  {
    return pts - audioOut->GetDelay() + setupStore.avOffset;
! };
  
  int cAudioStreamDecoder::DecodeData(uchar *Data, int Length)
  {
--- 304,329 ----
  }
  
! /* ---------------------------------------------------------------------------
!  */
! uint64_t cAudioStreamDecoder::GetPTS()
  {
    return pts - audioOut->GetDelay() + setupStore.avOffset;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void cAudioStreamDecoder::setStreamId(int id)
! {
!   /* -------------------------------------------------------------------------
!    * don't hook on DD stream
!    */
!   if (id != 0x01bd)
!   {
!     streamID = id;
!   }
! }
  
+ /* ---------------------------------------------------------------------------
+  */
  int cAudioStreamDecoder::DecodeData(uchar *Data, int Length)
  {
***************
*** 1231,1234 ****
--- 1248,1252 ----
    if (running)
      aout->Write((uchar *)Data,Length);
+     aout->setStreamId(Data[2]<<8|Data[3]);
  #endif
    return Length;

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** mpeg2decoder.h	13 Feb 2005 18:12:31 -0000	1.12
--- mpeg2decoder.h	5 Mar 2005 13:50:49 -0000	1.13
***************
*** 104,107 ****
--- 104,109 ----
  
      virtual void Stop();
+     virtual void setStreamId (int id) {return;};
+ 
      cStreamDecoder(unsigned int StreamID);
      virtual ~cStreamDecoder();
***************
*** 119,122 ****
--- 121,125 ----
      ~cAudioStreamDecoder();
      virtual uint64_t GetPTS();
+     virtual void setStreamId (int id);
  };
  

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** softdevice.c	4 Mar 2005 20:04:20 -0000	1.16
--- softdevice.c	5 Mar 2005 13:50:49 -0000	1.17
***************
*** 286,289 ****
--- 286,295 ----
  #else
    virtual int  PlayAudio(const uchar *Data, int Length);
+   virtual void SetDigitalAudioDevice(bool On);
+ 
+ protected:
+   virtual void SetAudioTrackDevice(eTrackType Type);
+ 
+ public:
  #endif
  #if VDRVERSNUM >= 10307
***************
*** 574,577 ****
--- 580,597 ----
  {
    return decoder->PlayAudio(Data, Length);
+ }
+ 
+ /* ----------------------------------------------------------------------------
+  */
+ void cSoftDevice::SetAudioTrackDevice(eTrackType Type)
+ {
+   //fprintf (stderr, "[SetAudioTrackDevice] (%d)\n",Type);
+ }
+ 
+ /* ----------------------------------------------------------------------------
+  */
+ void cSoftDevice::SetDigitalAudioDevice(bool On)
+ {
+   //fprintf (stderr, "[SetDigitalAudioDevice] (%s)\n",(On)? "TRUE":"FALSE");
  }
  #endif



From nobody at sheep.berlios.de  Sat Mar  5 15:35:54 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 5 Mar 2005 15:35:54 +0100
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.17,1.18
Message-ID: <200503051435.j25EZsN03317@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27363

Modified Files:
	mpeg2decoder.c 
Log Message:
some additional segfault fixes

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** mpeg2decoder.c	5 Mar 2005 13:50:49 -0000	1.17
--- mpeg2decoder.c	5 Mar 2005 14:35:51 -0000	1.18
***************
*** 1136,1144 ****
  }
  
  int cMpeg2Decoder::StillPicture(uchar *Data, int Length)
  {
!   return vout->StillPicture(Data,Length);
  }
  
  void cMpeg2Decoder::Clear(void)
  {
--- 1136,1148 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  int cMpeg2Decoder::StillPicture(uchar *Data, int Length)
  {
!   return (running) ? vout->StillPicture(Data,Length): Length;
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  void cMpeg2Decoder::Clear(void)
  {
***************
*** 1148,1154 ****
      aout->Clear();
      vout->Clear();
!   };
  }
  
  void cMpeg2Decoder::TrickSpeed(int Speed)
  {
--- 1152,1160 ----
      aout->Clear();
      vout->Clear();
!   }
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  void cMpeg2Decoder::TrickSpeed(int Speed)
  {
***************
*** 1161,1164 ****
--- 1167,1172 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  int64_t cMpeg2Decoder::GetSTC(void) {
    if (running)
***************
*** 1167,1171 ****
  };
  
! bool cMpeg2Decoder::BufferFilled() 
  {
    if (running)
--- 1175,1181 ----
  };
  
! /* ----------------------------------------------------------------------------
!  */
! bool cMpeg2Decoder::BufferFilled()
  {
    if (running)
***************
*** 1247,1252 ****
--- 1257,1264 ----
  #if VDRVERSNUM >= 10318
    if (running)
+   {
      aout->Write((uchar *)Data,Length);
      aout->setStreamId(Data[2]<<8|Data[3]);
+   }
  #endif
    return Length;



From nobody at sheep.berlios.de  Sat Mar  5 20:20:11 2005
From: nobody at sheep.berlios.de (iampivot)
Date: Sat, 5 Mar 2005 20:20:11 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.40,1.41 mpeg2decoder.c,1.18,1.19
Message-ID: <200503051920.j25JKBN12168@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3726

Modified Files:
	CHANGELOG mpeg2decoder.c 
Log Message:
fix to initialize ppmode if pp based deinterlace selected


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** CHANGELOG	5 Mar 2005 13:50:49 -0000	1.40
--- CHANGELOG	5 Mar 2005 19:20:09 -0000	1.41
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
   2005-03-05:
+     - mpeg2decoder: fix to initialize ppmode if pp based deinterlace selected
+  2005-03-05:
      - audio-out: fix audio stream selection
   2005-03-04: 0.1.0pre1

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** mpeg2decoder.c	5 Mar 2005 14:35:51 -0000	1.18
--- mpeg2decoder.c	5 Mar 2005 19:20:09 -0000	1.19
***************
*** 927,938 ****
  
    deintWork = setupStore.deintMethod;
-   if (currentDeintMethod != deintWork)
-   {
  #if FB_SUPPORT
!     if (currentDeintMethod > 2)
  #else
!     if (currentDeintMethod > 1)
  #endif
      {
        if (ppmode)
        {
--- 927,939 ----
  
    deintWork = setupStore.deintMethod;
  #if FB_SUPPORT
!   if (currentDeintMethod > 2)
  #else
!   if (currentDeintMethod > 1)
  #endif
+   {
+     if (currentDeintMethod != deintWork || ppmode == NULL)
      {
+ 
        if (ppmode)
        {
***************
*** 940,948 ****
          ppmode = NULL;
        }
      }
-     ppmode = pp_get_mode_by_name_and_quality(setupStore.getPPValue(), 6);
-     currentDeintMethod = deintWork;
    }
- 
  
    if (ppmode == NULL || ppcontext == NULL)
--- 941,949 ----
          ppmode = NULL;
        }
+     
+       ppmode = pp_get_mode_by_name_and_quality(setupStore.getPPValue(), 6);
+       currentDeintMethod = deintWork;
      }
    }
  
    if (ppmode == NULL || ppcontext == NULL)



From nobody at sheep.berlios.de  Tue Mar  8 18:27:36 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 8 Mar 2005 18:27:36 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.41,1.42 softdevice.c,1.17,1.18
Message-ID: <200503081727.j28HRaN30634@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30364

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
version is 0.1.0

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** CHANGELOG	5 Mar 2005 19:20:09 -0000	1.41
--- CHANGELOG	8 Mar 2005 17:27:33 -0000	1.42
***************
*** 1,6 ****
  Changelog
   2005-03-05:
      - mpeg2decoder: fix to initialize ppmode if pp based deinterlace selected
-  2005-03-05:
      - audio-out: fix audio stream selection
   2005-03-04: 0.1.0pre1
--- 1,6 ----
  Changelog
+  2005-03-08: softdevice-0.1.0
   2005-03-05:
      - mpeg2decoder: fix to initialize ppmode if pp based deinterlace selected
      - audio-out: fix audio stream selection
   2005-03-04: 0.1.0pre1

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** softdevice.c	5 Mar 2005 13:50:49 -0000	1.17
--- softdevice.c	8 Mar 2005 17:27:33 -0000	1.18
***************
*** 75,79 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.1.0pre1";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 75,79 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.1.0";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";



From nobody at sheep.berlios.de  Thu Mar 10 22:05:59 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 10 Mar 2005 22:05:59 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.42,1.43 audio.c,1.7,1.8 audio.h,1.3,1.4 setup-softdevice.c,1.12,1.13 setup-softdevice.h,1.8,1.9 softdevice.c,1.18,1.19 video-xv.c,1.17,1.18 video-xv.h,1.6,1.7
Message-ID: <200503102105.j2AL5xN32027@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29702

Modified Files:
	CHANGELOG audio.c audio.h setup-softdevice.c 
	setup-softdevice.h softdevice.c video-xv.c video-xv.h 
Log Message:
- xv-out: support max available area (pre for hdtv spport)
- audio-out: new dummy device (-ao dummy:)
             audio device constructor gets pointer to setup-store like video-out
- save options when called via main menu


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** CHANGELOG	8 Mar 2005 17:27:33 -0000	1.42
--- CHANGELOG	10 Mar 2005 21:05:56 -0000	1.43
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+  2005-03-10:
+     - xv-out: support max available area (pre for hdtv spport)
+     - audio-out: new dummy device (-ao dummy:)
+                  audio device constructor gets pointer to setup-store like video-out
+     - save options when called via main menu
   2005-03-08: softdevice-0.1.0
   2005-03-05:

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** audio.c	23 Jan 2005 14:56:08 -0000	1.7
--- audio.c	10 Mar 2005 21:05:56 -0000	1.8
***************
*** 23,31 ****
  }
  
! cAlsaAudioOut::cAlsaAudioOut(char *alsaDevice) {
!     if (strlen(alsaDevice) == 0)
!       strcpy (alsaDevice, "default");
!     dsyslog("[softdevice-audio] Opening alsa device %s",alsaDevice);
!     device = alsaDevice;
      int err;
      paused=false;
--- 23,31 ----
  }
  
! cAlsaAudioOut::cAlsaAudioOut(cSetupStore *setupStore) {
!     if (strlen(setupStore->alsaDevice) == 0)
!       strcpy (setupStore->alsaDevice, "default");
!     dsyslog("[softdevice-audio] Opening alsa device %s",setupStore->alsaDevice);
!     device = setupStore->alsaDevice;
      int err;
      paused=false;
***************
*** 290,291 ****
--- 290,343 ----
    snd_mixer_close(mHandle);
  }
+ 
+ cDummyAudioOut::cDummyAudioOut(cSetupStore *setupStore)
+ {
+   paused=false;
+   rate = chn=0;
+   dsyslog("[softdevice-audio-dummy] Device opened! Ready to play");
+ }
+ 
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cDummyAudioOut::Write(uchar *Data, int Length)
+ {
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cDummyAudioOut::Pause(void)
+ {
+   dsyslog("[softdevice-audio-dummy]: Should pause now");
+   paused=true;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cDummyAudioOut::Play(void)
+ {
+   paused=false;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ int cDummyAudioOut::GetDelay(void)
+ {
+   return 0;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ int cDummyAudioOut::SetParams(int channels, unsigned int samplerate)
+ {
+   if ((chn == channels) && (rate == samplerate))
+     return 0;
+ 
+   dsyslog ("[softdevice-audio-dummy] samplerate: %dHz, channels: #%d",
+            samplerate, channels);
+   rate=samplerate;
+   chn=channels;
+ 
+   return 0;
+ }
+ 

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** audio.h	23 Jan 2005 14:56:08 -0000	1.3
--- audio.h	10 Mar 2005 21:05:56 -0000	1.4
***************
*** 13,19 ****
  #include <alsa/asoundlib.h>
  #include <vdr/plugin.h>
  
! 
! // Abstract class for an audio device
  class cAudioOut  {
  private:
--- 13,21 ----
  #include <alsa/asoundlib.h>
  #include <vdr/plugin.h>
+ #include "setup-softdevice.h"
  
! /* ---------------------------------------------------------------------------
!  * Abstract class for an audio device
!  */
  class cAudioOut  {
  private:
***************
*** 35,38 ****
--- 37,42 ----
  
  
+ /* ---------------------------------------------------------------------------
+  */
  class cAlsaAudioOut : public cAudioOut  {
  private:
***************
*** 47,51 ****
  protected:
  public:
!   cAlsaAudioOut(char *device);
    virtual ~cAlsaAudioOut();
    virtual void Write(uchar *Data, int Length);
--- 51,55 ----
  protected:
  public:
!   cAlsaAudioOut(cSetupStore *setupStore);
    virtual ~cAlsaAudioOut();
    virtual void Write(uchar *Data, int Length);
***************
*** 57,60 ****
--- 61,82 ----
    virtual void Suspend(void);
    virtual bool Resume(void);
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ class cDummyAudioOut : public cAudioOut  {
+ private:
+   unsigned int rate;
+   int chn;
+   volatile bool paused;
+ public:
+   cDummyAudioOut(cSetupStore *setupStore);
+   virtual ~cDummyAudioOut() { return; };
+   virtual void Write(uchar *Data, int Length);
+   virtual int SetParams(int channels, unsigned int samplerate);
+   virtual int GetDelay(void);
+   virtual void Pause(void);
+   virtual void Play(void);
+   virtual void SetVolume(int vol) { return; };
  };
  #endif

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** setup-softdevice.c	4 Mar 2005 20:04:20 -0000	1.12
--- setup-softdevice.c	10 Mar 2005 21:05:56 -0000	1.13
***************
*** 227,232 ****
  /* ---------------------------------------------------------------------------
   */
! cMenuSetupSoftdevice::cMenuSetupSoftdevice(void)
  {
    copyData = setupStore;
    data = &setupStore;
--- 227,235 ----
  /* ---------------------------------------------------------------------------
   */
! cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
  {
+   if (plugin)
+     SetPlugin(plugin);
+     
    copyData = setupStore;
    data = &setupStore;

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** setup-softdevice.h	27 Feb 2005 08:52:33 -0000	1.8
--- setup-softdevice.h	10 Mar 2005 21:05:56 -0000	1.9
***************
*** 55,59 ****
      virtual void Store(void);
    public:
!     cMenuSetupSoftdevice(void);
  };
  
--- 55,59 ----
      virtual void Store(void);
    public:
!     cMenuSetupSoftdevice(cPlugin *plugin = NULL);
  };
  

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** softdevice.c	8 Mar 2005 17:27:33 -0000	1.18
--- softdevice.c	10 Mar 2005 21:05:56 -0000	1.19
***************
*** 81,84 ****
--- 81,87 ----
  #define INBUF_SIZE 4096
  
+ #define AOUT_ALSA   1
+ #define AOUT_DUMMY  2
+ 
  #if VDRVERSNUM >= 10307
  
***************
*** 226,230 ****
  class cPluginSoftDevice : public cPlugin {
  private:
!   int   voutMethod;
    char  *pluginPath;
  
--- 229,233 ----
  class cPluginSoftDevice : public cPlugin {
  private:
!   int   voutMethod, aoutMethod;
    char  *pluginPath;
  
***************
*** 267,271 ****
  
  public:
!   cSoftDevice(int method, char *pluginPath);
    ~cSoftDevice();
    virtual bool HasDecoder(void) const;
--- 270,274 ----
  
  public:
!   cSoftDevice(int method, int audioMethod, char *pluginPath);
    ~cSoftDevice();
    virtual bool HasDecoder(void) const;
***************
*** 302,306 ****
  };
  
! cSoftDevice::cSoftDevice(int method,char *pluginPath)
  {
      freezeModeEnabled = false;
--- 305,309 ----
  };
  
! cSoftDevice::cSoftDevice(int method,int audioMethod, char *pluginPath)
  {
      freezeModeEnabled = false;
***************
*** 422,426 ****
      fprintf(stderr,"[softdevice] Video Out seems to be OK\n");
      fprintf(stderr,"[softdevice] Initializing Audio Out\n");
!     audioOut=new cAlsaAudioOut(setupStore.alsaDevice);
      fprintf(stderr,"[softdevice] Audio out seems to be OK\n");
      fprintf(stderr,"[softdevice] A/V devices initialized, now initializing MPEG2 Decoder\n");
--- 425,436 ----
      fprintf(stderr,"[softdevice] Video Out seems to be OK\n");
      fprintf(stderr,"[softdevice] Initializing Audio Out\n");
!     switch (audioMethod) {
!       case AOUT_ALSA:
!         audioOut=new cAlsaAudioOut(&setupStore);
!         break;
!       case AOUT_DUMMY:
!         audioOut=new cDummyAudioOut(&setupStore);
!         break;
!     }
      fprintf(stderr,"[softdevice] Audio out seems to be OK\n");
      fprintf(stderr,"[softdevice] A/V devices initialized, now initializing MPEG2 Decoder\n");
***************
*** 467,473 ****
  #endif
  
- 
- 
- 
  bool cSoftDevice::HasDecoder(void) const
  {
--- 477,480 ----
***************
*** 632,635 ****
--- 639,643 ----
    voutMethod = 0;
  #endif
+   aoutMethod = AOUT_ALSA;
    pluginPath = PLUGINLIBDIR;
  }
***************
*** 645,648 ****
--- 653,657 ----
    return
    "  -ao alsa:devicename      alsa output device\n"
+   "  -ao dummy:               dummy output device\n"
  #ifdef XV_SUPPORT
    "  -vo xv:                  enable output via X11-Xv\n"
***************
*** 738,743 ****
--- 747,757 ----
            ao_argv += 5;
            setupStore.aoArgs = ao_argv;
+           aoutMethod = AOUT_ALSA;
            fprintf(stderr, "[softdevice] using alsa device %s\n", ao_argv);
            strncpy(setupStore.alsaDevice, ao_argv, ALSA_DEVICE_NAME_LENGTH);
+         } else if (!strncmp(ao_argv, "dummy:", 6)) {
+           ao_argv += 6;
+           setupStore.aoArgs = ao_argv;
+           aoutMethod = AOUT_DUMMY;
          }
        }
***************
*** 765,769 ****
    // Start any background activities the plugin shall perform.
    fprintf(stderr,"[softdevice] initializing Plugin\n");
!   new cSoftDevice(voutMethod,pluginPath);
    return true;
  }
--- 779,783 ----
    // Start any background activities the plugin shall perform.
    fprintf(stderr,"[softdevice] initializing Plugin\n");
!   new cSoftDevice(voutMethod,aoutMethod,pluginPath);
    return true;
  }
***************
*** 778,782 ****
    // Perform the action when selected from the main VDR menu.
    fprintf (stderr, "[MainMenuAction]\n");
!   return new cMenuSetupSoftdevice;
  //  return NULL;
  }
--- 792,796 ----
    // Perform the action when selected from the main VDR menu.
    fprintf (stderr, "[MainMenuAction]\n");
!   return new cMenuSetupSoftdevice(this);
  //  return NULL;
  }

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-xv.c	4 Mar 2005 20:04:20 -0000	1.17
--- video-xv.c	10 Mar 2005 21:05:56 -0000	1.18
***************
*** 29,33 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "010_pre_1"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 29,33 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2005-03-10"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 479,483 ****
                attributeStore.Increment("XV_SATURATION");
              break;
- #if 1
            case 'o':
              if (xv_initialized)
--- 479,482 ----
***************
*** 504,509 ****
                attributeStore.Increment("XV_ALPHA_MODE");
              break;
! #endif
! #ifdef SUSPEND_BY_KEY 
            case 'r':
            case 'R':
--- 503,507 ----
                attributeStore.Increment("XV_ALPHA_MODE");
              break;
! #ifdef SUSPEND_BY_KEY
            case 'r':
            case 'R':
***************
*** 588,593 ****
    scale_size = 0;
    screenPixelAspect = -1;
!   width = XV_SRC_WIDTH;
!   height = XV_SRC_HEIGHT;
  
    format = FOURCC_YV12;
--- 586,591 ----
    scale_size = 0;
    screenPixelAspect = -1;
!   xvWidth  = width  = XV_SRC_WIDTH;
!   xvHeight = height = XV_SRC_HEIGHT;
  
    format = FOURCC_YV12;
***************
*** 860,865 ****
--- 858,888 ----
            continue;
          if(!XvGrabPort(dpy, port, CurrentTime)) {
+             unsigned int    encodingCount, n;
+             XvEncodingInfo  *encodingInfo;
+ 
            dsyslog("[XvVideoOut]: grabbed port %ld", port);
            got_port = True;
+           XvQueryEncodings(dpy,ad_info[i].base_id,&encodingCount,&encodingInfo);
+           for (n = 0; n < encodingCount; ++n)
+           {
+             if (!strcmp(encodingInfo[n].name, "XV_IMAGE"))
+             {
+               fprintf(stderr, "[XvVideoOut]: max area size %d x %d\n",
+                       encodingInfo[n].width, encodingInfo[n].height);
+               dsyslog("[XvVideoOut]: max area size %lu x %lu",
+                       encodingInfo[n].width, encodingInfo[n].height);
+               /* --------------------------------------------------------------
+                * adjust width to 8 byte boundary and height to an even
+                * number of lines.
+                */
+               xvWidth  = (encodingInfo[n].width & ~7);
+               xvHeight = (encodingInfo[n].height & ~1);
+               fprintf(stderr, "[XvVideoOut]: using area size %d x %d\n",
+                       xvWidth, xvHeight);
+               dsyslog("[XvVideoOut]: using area size %d x %d",
+                       xvWidth, xvHeight);
+               len = xvWidth * xvHeight * 2;
+             }
+           }
            break;
          } /* if */
***************
*** 893,897 ****
    xv_image = XvShmCreateImage(dpy, port,
                                format, (char *) outbuffer,
!                               width, height,
                                &shminfo);
  
--- 916,920 ----
    xv_image = XvShmCreateImage(dpy, port,
                                format, (char *) outbuffer,
!                               xvWidth, xvHeight,
                                &shminfo);
  
***************
*** 926,931 ****
  
    pixels [0] = outbuffer;
!   pixels [1] = outbuffer + width * height;
!   pixels [2] = pixels [1] + width * height / 4;
    rc = XShmAttach(dpy, &shminfo);
    dsyslog("[XvVideoOut]: XShmAttach    rc = %d %s",
--- 949,954 ----
  
    pixels [0] = outbuffer;
!   pixels [1] = outbuffer + xvWidth * xvHeight;
!   pixels [2] = pixels [1] + xvWidth * xvHeight / 4;
    rc = XShmAttach(dpy, &shminfo);
    dsyslog("[XvVideoOut]: XShmAttach    rc = %d %s",
***************
*** 935,941 ****
      shmctl (shminfo. shmid, IPC_RMID, 0);
  
!   memset (pixels [0], 0, width*height);
!   memset (pixels [1], 128, width*height/4);
!   memset (pixels [2], 128, width*height/4);
  //    dv_display_event(dv_dpy);
    rc = XvShmPutImage(dpy, port,
--- 958,964 ----
      shmctl (shminfo. shmid, IPC_RMID, 0);
  
!   memset (pixels [0], 0, xvWidth*xvHeight);
!   memset (pixels [1], 128, xvWidth*xvHeight/4);
!   memset (pixels [2], 128, xvWidth*xvHeight/4);
  //    dv_display_event(dv_dpy);
    rc = XvShmPutImage(dpy, port,
***************
*** 1211,1215 ****
          for (int i = 0; i < fheight; i++)
          {
!           AlphaBlend(pixels[0]+i*width,OsdPy+i*OSD_FULL_WIDTH,
              Py + i * Ystride,
              OsdPAlphaY+i*OSD_FULL_WIDTH,fwidth);
--- 1234,1238 ----
          for (int i = 0; i < fheight; i++)
          {
!           AlphaBlend(pixels[0]+i*xvWidth,OsdPy+i*OSD_FULL_WIDTH,
              Py + i * Ystride,
              OsdPAlphaY+i*OSD_FULL_WIDTH,fwidth);
***************
*** 1218,1222 ****
          for (int i = 0; i < fheight / 2; i++)
          {
!           AlphaBlend(pixels[1]+i*width/2,
              OsdPv+i*OSD_FULL_WIDTH/2,Pv+ i * UVstride,
              OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
--- 1241,1245 ----
          for (int i = 0; i < fheight / 2; i++)
          {
!           AlphaBlend(pixels[1]+i*xvWidth/2,
              OsdPv+i*OSD_FULL_WIDTH/2,Pv+ i * UVstride,
              OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
***************
*** 1225,1229 ****
          for (int i = 0; i < fheight / 2; i++)
          {
!           AlphaBlend(pixels[2]+i*width/2,
              OsdPu+i*OSD_FULL_WIDTH/2,Pu+i*UVstride,
              OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
--- 1248,1252 ----
          for (int i = 0; i < fheight / 2; i++)
          {
!           AlphaBlend(pixels[2]+i*xvWidth/2,
              OsdPu+i*OSD_FULL_WIDTH/2,Pu+i*UVstride,
              OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
***************
*** 1248,1257 ****
   {
            for (int i = 0; i < fheight; i++)
!              memcpy (pixels [0] + i * width, Py + i * Ystride, fwidth);
!           for (int i = 0; i < fheight / 2; i++) 
!              memcpy (pixels [1] + i * width / 2, Pv + i * UVstride, fwidth / 2);
            for (int i = 0; i < fheight / 2; i++)
!              memcpy (pixels [2] + i * width / 2, Pu + i * UVstride, fwidth / 2);
!    
            pthread_mutex_lock(&xv_mutex);
            XvShmPutImage(dpy, port,
--- 1271,1280 ----
   {
            for (int i = 0; i < fheight; i++)
!              memcpy (pixels [0] + i * xvWidth, Py + i * Ystride, fwidth);
            for (int i = 0; i < fheight / 2; i++)
!              memcpy (pixels [1] + i * xvWidth / 2, Pv + i * UVstride, fwidth / 2);
!           for (int i = 0; i < fheight / 2; i++)
!              memcpy (pixels [2] + i * xvWidth / 2, Pu + i * UVstride, fwidth / 2);
! 
            pthread_mutex_lock(&xv_mutex);
            XvShmPutImage(dpy, port,

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video-xv.h	24 Feb 2005 22:35:51 -0000	1.6
--- video-xv.h	10 Mar 2005 21:05:56 -0000	1.7
***************
*** 110,113 ****
--- 110,114 ----
                       * could be specified via argv or parameters
                       */
+                     xvWidth, xvHeight,
                      width, height,
                      attr,



From nobody at sheep.berlios.de  Fri Mar 11 16:56:25 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 11 Mar 2005 16:56:25 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.43,1.44 video-xv.c,1.18,1.19 video.c,1.12,1.13
Message-ID: <200503111556.j2BFuPN00077@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5323

Modified Files:
	CHANGELOG video-xv.c video.c 
Log Message:
fix some OSD misplacements

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** CHANGELOG	10 Mar 2005 21:05:56 -0000	1.43
--- CHANGELOG	11 Mar 2005 15:56:22 -0000	1.44
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+  2005-03-11:
+     - xv-out: fix OSD misplacement in downscaleing mode (pseudo mode)
+     - fix OSD misplacement for software alpha when in crop mode (info menu)
   2005-03-10:
      - xv-out: support max available area (pre for hdtv spport)

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-xv.c	10 Mar 2005 21:05:56 -0000	1.18
--- video-xv.c	11 Mar 2005 15:56:22 -0000	1.19
***************
*** 1190,1199 ****
        
          int x= lwidth > OSD_FULL_WIDTH ? osd_x + (dwidth - width) / 2:
!                 osd_x * lwidth/OSD_FULL_WIDTH *9/10;
          int y= lheight > OSD_FULL_HEIGHT ? osd_y + (dheight - height) / 2:
!                 osd_y * lheight/OSD_FULL_HEIGHT *9/10;
  
          XShmPutImage (dpy, win, gc, osd_image,
!                       osd_x, 
                        osd_y,
                        x,y,
--- 1190,1199 ----
        
          int x= lwidth > OSD_FULL_WIDTH ? osd_x + (dwidth - width) / 2:
!                 lxoff + (osd_x * lwidth/OSD_FULL_WIDTH *9/10);
          int y= lheight > OSD_FULL_HEIGHT ? osd_y + (dheight - height) / 2:
!                 lyoff + (osd_y * lheight/OSD_FULL_HEIGHT *9/10);
  
          XShmPutImage (dpy, win, gc, osd_image,
!                       osd_x,
                        osd_y,
                        x,y,

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video.c	3 Mar 2005 18:21:41 -0000	1.12
--- video.c	11 Mar 2005 15:56:22 -0000	1.13
***************
*** 484,488 ****
              linelen * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
              (OSDxOfs + SCALEX(Bitmap->X0() + x1) ) * depth;
!     PixelMaskPtr=PixelMask + 
             linelen/16 * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
              (OSDxOfs + SCALEX(Bitmap->X0() + x1))/8;
--- 484,488 ----
              linelen * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
              (OSDxOfs + SCALEX(Bitmap->X0() + x1) ) * depth;
!     PixelMaskPtr=PixelMask +
             linelen/16 * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
              (OSDxOfs + SCALEX(Bitmap->X0() + x1))/8;
***************
*** 601,607 ****
    x1=SCALEX(x1);
    x2=SCALEX(x2);
!   int  x0=sxoff+OSDxOfs+SCALEX(Bitmap->X0());
!   int  y0=(syoff+OSDyOfs+SCALEY(Bitmap->Y0())) & ~1; // we need an even offset
!    
    // we need a even starting point
    y1&=~1;
--- 601,607 ----
    x1=SCALEX(x1);
    x2=SCALEX(x2);
!   int  x0=sxoff+SCALEX(OSDxOfs+Bitmap->X0());
!   int  y0=(syoff+SCALEY(OSDyOfs+Bitmap->Y0())) & ~1; // we need an even offset
! 
    // we need a even starting point
    y1&=~1;



From nobody at sheep.berlios.de  Tue Mar 15 18:20:25 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 15 Mar 2005 18:20:25 +0100
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.19,1.20 mpeg2decoder.h,1.13,1.14
Message-ID: <200503151720.j2FHKPN06435@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10999

Modified Files:
	mpeg2decoder.c mpeg2decoder.h 
Log Message:
get dvdplugin work in _non_ ac3 mode

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** mpeg2decoder.c	5 Mar 2005 19:20:09 -0000	1.19
--- mpeg2decoder.c	15 Mar 2005 17:20:22 -0000	1.20
***************
*** 71,74 ****
--- 71,75 ----
    state=UNSYNCED;
    prevPTS = newPTS = pts=0;
+   packetLength = 0;
    for (int i = 0; i < PTS_COUNT; i++)
      historyPTS [i] = 0;
***************
*** 150,154 ****
            hdr_ptr=header;
            HDRDEB("ID 0x%x PtsDts 0x%x ESCR 0x%x ESRATE 0x%x optHLength 0x%x\n",
!              streamID,Header2.ptsdts_flags,Header2.has_escr,Header2.has_es_rate,headerLength); 
          }
          payload--;
--- 151,155 ----
            hdr_ptr=header;
            HDRDEB("ID 0x%x PtsDts 0x%x ESCR 0x%x ESRATE 0x%x optHLength 0x%x\n",
!              streamID,Header2.ptsdts_flags,Header2.has_escr,Header2.has_es_rate,headerLength);
          }
          payload--;
***************
*** 168,172 ****
                HDRDEB("ID: 0x%x PTS: %lld DTS: %lld ESCR: %lld\n",streamID,
                  GET_MPEG2_PTS(header),GET_MPEG2_PTS((header+5)),
!                 GET_MPEG2_PTS((header+10)) );    
              }
              break;
--- 169,173 ----
                HDRDEB("ID: 0x%x PTS: %lld DTS: %lld ESCR: %lld\n",streamID,
                  GET_MPEG2_PTS(header),GET_MPEG2_PTS((header+5)),
!                 GET_MPEG2_PTS((header+10)) );
              }
              break;
***************
*** 174,177 ****
--- 175,179 ----
        case STREAM:
          streamlen=min(payload,size); // Max data that is avaiable
+         packetLength = payload;
          len=DecodeData(inbuf_ptr,streamlen);
          payload-=len;
***************
*** 289,292 ****
--- 291,296 ----
  {
    audioOut=AudioOut;
+   PCMState = SNone;
+   PCMpos = 0;
    codec = avcodec_find_decoder(CODEC_ID_MP2);
    if (!codec)
***************
*** 313,320 ****
  /* ---------------------------------------------------------------------------
   */
! void cAudioStreamDecoder::setStreamId(int id)
  {
    /* -------------------------------------------------------------------------
!    * don't hook on DD stream
     */
    if (id != 0x01bd)
--- 317,324 ----
  /* ---------------------------------------------------------------------------
   */
! void cAudioStreamDecoder::setStreamId(int id, const uchar *d)
  {
    /* -------------------------------------------------------------------------
!    * don't hook on DD stream, except for LDPCM
     */
    if (id != 0x01bd)
***************
*** 322,325 ****
--- 326,395 ----
      streamID = id;
    }
+   else if ((d[d[8]+9]&0xe0) == 0xa0)
+   {
+     streamID = id;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ int cAudioStreamDecoder::PCMDecode(AVCodecContext *context,
+                                    short *audiosamples, int *audio_size,
+                                    uchar *Data, int Length/*, int PacketLength*/)
+ {
+     int         PCMDataPos=0;
+     static int  PCMHeaderPos=0;
+ 
+   *audio_size=0;
+   while (PCMDataPos < Length  && PCMDataPos <  packetLength) {
+ 
+     switch (PCMState) {
+       case SNone:
+       case SHeader:
+         if ((Data[PCMDataPos] &0xe0)==0xa0)  {
+           PCMState=SHeader+1;
+           PCMHeader[0]=Data[PCMDataPos];
+           PCMpos=0;
+           PCMHeaderPos=1;
+         }
+         PCMDataPos++;
+         break;
+       case SHeader+1:
+       case SHeader+2:
+       case SHeader+3:
+       case SHeader+4:
+       case SHeader+5:
+         PCMHeader[PCMHeaderPos++]=Data[PCMDataPos];
+         PCMDataPos++;
+         PCMState++;
+         break;
+ 
+       case SHeader+6:
+         PCMState=SData;
+         PCMDataPos++;
+         break;
+ 
+       case SData:
+         while (PCMDataPos < packetLength && PCMDataPos <Length )
+         {
+           ((uchar*) audiosamples)[2*(PCMpos/2)+1-PCMpos%2]=Data[PCMDataPos];
+           PCMDataPos++;
+           PCMpos++;
+         }
+         break;
+     }
+   }
+ 
+   if (PCMDataPos >= packetLength ) {
+     // taken from libavcodec
+     static const int lpcm_freq_tab[4] = { 48000, 96000, 44100, 32000 };
+     int freq = (PCMHeader[5] >> 4) & 3;
+     context->sample_rate=lpcm_freq_tab[freq];
+     context->channels = 1 + (PCMHeader[5] & 7);
+     *audio_size=PCMpos;
+     PCMState=SNone;
+     PCMpos=0;
+   }
+   return PCMDataPos;
  }
  
***************
*** 331,335 ****
      int audio_size;
  
!   len=avcodec_decode_audio(context, (short *)audiosamples, &audio_size, Data, Length);
    frame++;
    MPGDEB("count: %d  Length: %d len: %d a_size: %d a_delay: %d\n",
--- 401,410 ----
      int audio_size;
  
!   if (streamID == 0x01bd)
!     len=PCMDecode(context, (short *) audiosamples,
!                   &audio_size, Data, Length);
!   else
!     len=avcodec_decode_audio(context, (short *)audiosamples,
!                              &audio_size, Data, Length);
    frame++;
    MPGDEB("count: %d  Length: %d len: %d a_size: %d a_delay: %d\n",
***************
*** 1190,1198 ****
  {
      const uchar *p;
!     int         ac3ModeNew, ac3ParmNew, lpcmModeNew;
  
    ac3ModeNew = ac3Mode;
    ac3ParmNew = ac3Parm;
    lpcmModeNew = lpcmMode;
  
    p = Data;
--- 1265,1274 ----
  {
      const uchar *p;
!     int         ac3ModeNew, ac3ParmNew, lpcmModeNew, lpcmSubstreamIdNew;
  
    ac3ModeNew = ac3Mode;
    ac3ParmNew = ac3Parm;
    lpcmModeNew = lpcmMode;
+   lpcmSubstreamIdNew = lpcmSubstreamId;
  
    p = Data;
***************
*** 1202,1207 ****
    if (p[0] == 0x00 && p[1] == 0x00 && p[2] == 0x01 && p[3] == 0xbd)
    {
!     p += 4 + 2 + 2;   // skip: stream id, length, ??
!     p += *p;
      p++;
  
--- 1278,1284 ----
    if (p[0] == 0x00 && p[1] == 0x00 && p[2] == 0x01 && p[3] == 0xbd)
    {
!     p += 3 /*start_code*/ + 1 /*stream_id*/;
!     p += 2 /*packet_length*/ + 2 /* ?? */;
!     p += *p /*header_data_length*/;
      p++;
  
***************
*** 1209,1212 ****
--- 1286,1292 ----
       * check for ac3 sync word
       */
+     if (p[4] == 0x0b && p[5] == 0x77)
+       p += 4;
+ 
      if (p[0] == 0x0b && p[1] == 0x77)
      {
***************
*** 1219,1226 ****
       * check for LPCM sync word
       */
!     else if (p[0] == 0xa0 && p[1] == 0xff)
      {
        ac3ModeNew = ac3ParmNew = 0;
        lpcmModeNew = 1;
        p += 2 + 2 + 1;
      }
--- 1299,1307 ----
       * check for LPCM sync word
       */
!     else if ((p[0] & 0xe0) == 0xa0)
      {
        ac3ModeNew = ac3ParmNew = 0;
        lpcmModeNew = 1;
+       lpcmSubstreamIdNew = p[0] & 0x1f;
        p += 2 + 2 + 1;
      }
***************
*** 1249,1264 ****
    }
  
!   if (lpcmModeNew != lpcmMode)
    {
        char  *sampleRates [4] = {"48000", "96000", "44100", "32000"};
  
!     dsyslog ("[Mpeg2Decoder]: LPCM info: %dch@%sHz",
!              ((*p)&1)+1, sampleRates[((*p)&3)>>4]);
    }
  #if VDRVERSNUM >= 10318
    if (running)
    {
      aout->Write((uchar *)Data,Length);
-     aout->setStreamId(Data[2]<<8|Data[3]);
    }
  #endif
--- 1330,1347 ----
    }
  
!   if (lpcmModeNew != lpcmMode || lpcmSubstreamIdNew != lpcmSubstreamId)
    {
        char  *sampleRates [4] = {"48000", "96000", "44100", "32000"};
  
!     lpcmMode = lpcmModeNew;
!     lpcmSubstreamId = lpcmSubstreamIdNew;
!     dsyslog ("[Mpeg2Decoder]: LPCM info: %dch@%sHz (%d)",
!              ((*p)&1)+1, sampleRates[((*p)&3)>>4],lpcmSubstreamId);
    }
  #if VDRVERSNUM >= 10318
    if (running)
    {
+     aout->setStreamId(Data[2]<<8|Data[3], Data);
      aout->Write((uchar *)Data,Length);
    }
  #endif

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** mpeg2decoder.h	5 Mar 2005 13:50:49 -0000	1.13
--- mpeg2decoder.h	15 Mar 2005 17:20:22 -0000	1.14
***************
*** 77,80 ****
--- 77,81 ----
                            pts;
      int                   frame,
+                           packetLength,
                            historyPTSIndex;
      bool                  validPTS;
***************
*** 104,108 ****
  
      virtual void Stop();
!     virtual void setStreamId (int id) {return;};
  
      cStreamDecoder(unsigned int StreamID);
--- 105,109 ----
  
      virtual void Stop();
!     virtual void setStreamId (int id, const uchar *d) {return;};
  
      cStreamDecoder(unsigned int StreamID);
***************
*** 111,118 ****
  
  
  class cAudioStreamDecoder : public cStreamDecoder {
  private:
!     uint8_t * audiosamples;
      cAudioOut *audioOut;
  protected:
  public:
--- 112,129 ----
  
  
+   enum PCMState {
+       SNone,
+       SHeader=10,
+       SData=50,
+   } ;
+ 
  class cAudioStreamDecoder : public cStreamDecoder {
  private:
!     uint8_t   *audiosamples;
      cAudioOut *audioOut;
+     int       PCMpos,
+               PCMState;
+     uchar     PCMHeader[10];
+ 
  protected:
  public:
***************
*** 120,125 ****
      cAudioStreamDecoder(unsigned int StreamID, cAudioOut *AudioOut);
      ~cAudioStreamDecoder();
!     virtual uint64_t GetPTS();
!     virtual void setStreamId (int id);
  };
  
--- 131,138 ----
      cAudioStreamDecoder(unsigned int StreamID, cAudioOut *AudioOut);
      ~cAudioStreamDecoder();
!     virtual uint64_t  GetPTS();
!     virtual void      setStreamId (int id, const uchar *d);
!     virtual int       PCMDecode(AVCodecContext *context, short *audiosamples,
!                                 int *audio_size, uchar *Data, int Length);
  };
  
***************
*** 180,184 ****
      cAudioOut       *audioOut;
      cVideoOut       *videoOut;
!     int             ac3Mode, ac3Parm, lpcmMode;
      bool running;
      bool IsSuspended;
--- 193,197 ----
      cAudioOut       *audioOut;
      cVideoOut       *videoOut;
!     int             ac3Mode, ac3Parm, lpcmMode, lpcmSubstreamId;
      bool running;
      bool IsSuspended;



From nobody at sheep.berlios.de  Tue Mar 15 18:29:11 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 15 Mar 2005 18:29:11 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.44,1.45
Message-ID: <200503151729.j2FHTBN06681@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11711

Modified Files:
	CHANGELOG 
Log Message:
get dvdplugin work in _non_ ac3 mode

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** CHANGELOG	11 Mar 2005 15:56:22 -0000	1.44
--- CHANGELOG	15 Mar 2005 17:29:04 -0000	1.45
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+  2005-03-15:
+     - get cvs version of dvd-plugin work in _non_ ac3 mode
   2005-03-11:
      - xv-out: fix OSD misplacement in downscaleing mode (pseudo mode)



From nobody at sheep.berlios.de  Thu Mar 17 21:15:38 2005
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 17 Mar 2005 21:15:38 +0100
Subject: [Softdevice-cvs] softdevice softdevice.h,NONE,1.1 CHANGELOG,1.45,1.46 Makefile,1.9,1.10 audio.c,1.8,1.9 audio.h,1.4,1.5 mpeg2decoder.c,1.20,1.21 mpeg2decoder.h,1.14,1.15 softdevice.c,1.19,1.20
Message-ID: <200503172015.j2HKFcN05705@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10611

Modified Files:
	CHANGELOG Makefile audio.c audio.h mpeg2decoder.c 
	mpeg2decoder.h softdevice.c 
Added Files:
	softdevice.h 
Log Message:
- use libavformat for pes-stream parsing


--- NEW FILE: softdevice.h ---
/*
 * softdevice.h: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: softdevice.h,v 1.1 2005/03/17 20:15:35 wachm Exp $
 */

#ifndef __SOFTDEVICE_H__
#define __SOFTDEVICE_H__
#include <vdr/interface.h>
#include <vdr/plugin.h>
#include <vdr/player.h>

#include "i18n.h"
#include "setup-softdevice.h"
#include "audio.h"
#include "mpeg2decoder.h"
#include "utils.h"

// --- cSoftDevice ------------------------------------------------------------
class cPluginSoftDevice : public cPlugin {
private:
  int   voutMethod;
  int   aoutMethod;
  char  *pluginPath;

public:
  cPluginSoftDevice(void);
  virtual ~cPluginSoftDevice();
  virtual const char *Version(void); 
  virtual const char *Description(void);
  virtual const char *CommandLineHelp(void);
  virtual bool Initialize(void);
  virtual bool ProcessArgs(int argc, char *argv[]);
  virtual bool Start(void);
  virtual void Housekeeping(void);
  virtual const char *MainMenuEntry(void);
  virtual cOsdObject *MainMenuAction(void);
  virtual cMenuSetupPage *SetupMenu(void);
  virtual bool SetupParse(const char *Name, const char *Value);
};


class cSoftDevice : public cDevice {
private:
  cMpeg2Decoder *decoder;

#if VDRVERSNUM < 10307
  cOsdBase *OSD;
#endif

  cVideoOut *videoOut;
  cAudioOut *audioOut;
  int       outMethod;

  bool      freezeModeEnabled;
  cMutex    playMutex;
  cCondVar  readyForPlayCondVar;

public:
  cSoftDevice(int method, int audioMethod, char *pluginPath);
  ~cSoftDevice();
  
  void DecodePacket(const AVFormatContext *ic, AVPacket &pkt) 
  { if (decoder) decoder->DecodePacket(ic,pkt); };

  virtual bool HasDecoder(void) const;
  virtual bool CanReplay(void) const;
  virtual bool SetPlayMode(ePlayMode PlayMode);
  virtual void TrickSpeed(int Speed);
  virtual void Clear(void);
  virtual void Play(void);
  virtual void Freeze(void);
  virtual void Mute(void);
  virtual void SetVolumeDevice (int Volume);
  virtual void StillPicture(const uchar *Data, int Length);
  virtual bool Poll(cPoller &Poller, int TimeoutMs = 0);
  virtual bool Flush(int TimeoutMs = 0);
  virtual int64_t GetSTC(void);
  virtual int PlayVideo(const uchar *Data, int Length);
#if VDRVERSNUM < 10318
  virtual void PlayAudio(const uchar *Data, int Length);
#else
  virtual void SetAudioChannelDevice(int AudioChannel);
  virtual int  GetAudioChannelDevice(void);
  virtual void SetDigitalAudioDevice(bool On);
  virtual void SetAudioTrackDevice(eTrackType Type);  
  virtual int  PlayAudio(const uchar *Data, int Length);
#endif
#if VDRVERSNUM >= 10307
  virtual int ProvidesCa(const cChannel *Channel) const;
  virtual void MakePrimaryDevice(bool On);
#else
  int ProvidesCa(int Ca);
  virtual cOsdBase *NewOsd(int x, int y);
#endif
};

#endif

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** CHANGELOG	15 Mar 2005 17:29:04 -0000	1.45
--- CHANGELOG	17 Mar 2005 20:15:35 -0000	1.46
***************
*** 1,4 ****
  Changelog
!  2005-03-15:
      - get cvs version of dvd-plugin work in _non_ ac3 mode
   2005-03-11:
--- 1,8 ----
  Changelog
! 2005-03-17:
!     - add left/right channel only support
!     - be more precise in GetSTC
!     - use libavformat for PES stream parsing
! 2005-03-15:
      - get cvs version of dvd-plugin work in _non_ ac3 mode
   2005-03-11:

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** Makefile	4 Mar 2005 20:04:20 -0000	1.9
--- Makefile	17 Mar 2005 20:15:35 -0000	1.10
***************
*** 87,91 ****
  #
  # DON'T touch this:
! FFMPEGLIBS = -lavcodec
  #
  # -----------------------------------------------------------------------------
--- 87,91 ----
  #
  # DON'T touch this:
! FFMPEGLIBS = -lavcodec -lavformat
  #
  # -----------------------------------------------------------------------------

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** audio.c	10 Mar 2005 21:05:56 -0000	1.8
--- audio.c	17 Mar 2005 20:15:35 -0000	1.9
***************
*** 35,39 ****
        exit(1);
      }
!     chn=0;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
  }
--- 35,39 ----
        exit(1);
      }
!     currContext.channels=0;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
  }
***************
*** 57,61 ****
     }
     //force setting of the parameters after resume 
!    chn=0;
     return true;
  };
--- 57,61 ----
     }
     //force setting of the parameters after resume 
!    currContext.channels=0;
     return true;
  };
***************
*** 65,69 ****
      int err;
      size_t size;
!     size = Length/(2*chn);
    while (size) {
      while (paused) usleep(1000); // block
--- 65,69 ----
      int err;
      size_t size;
!     size = Length/(2*currContext.channels);
    while (size) {
      while (paused) usleep(1000); // block
***************
*** 109,113 ****
  		exit(EXIT_FAILURE);
  	}
!     return snd_pcm_status_get_delay(status) *1000 / rate;
  }
  
--- 109,113 ----
  		exit(EXIT_FAILURE);
  	}
!     return snd_pcm_status_get_delay(status) *1000 / currContext.samplerate;
  }
  
***************
*** 118,121 ****
--- 118,122 ----
  	int res;
  	snd_pcm_status_alloca(&status);
+         printf("alsa-audio: Xrun\n");
  	if ((res = snd_pcm_status(handle, status))<0) {
      dsyslog("[softdevice-audio]: Xrun status error: %s FATAL exiting",
***************
*** 138,149 ****
  }
  
! 
! int cAlsaAudioOut::SetParams(int channels, unsigned int samplerate)
  {
        int err;
  
      // not needed to set again
!     if ((chn == channels) && (rate == samplerate)) return 0;
! 
      snd_pcm_close(handle);
      if ((err = snd_pcm_open(&handle,
--- 139,157 ----
  }
  
! int cAlsaAudioOut::SetParams(SampleContext &context)
! //int cAlsaAudioOut::SetParams(int channels, unsigned int samplerate)
  {
        int err;
  
      // not needed to set again
!     //if ((chn == channels) && (rate == samplerate)) return 0;
!     if (currContext.samplerate == context.samplerate &&
!         currContext.channels == context.channels ) {
!       context=currContext;
!       return 0;
!     };
!     printf("alsa-audio: SetParams\n");
!     currContext=context;
!     
      snd_pcm_close(handle);
      if ((err = snd_pcm_open(&handle,
***************
*** 156,162 ****
  
      dsyslog ("[softdevice-audio] samplerate: %dHz, channels: #%d",
!              samplerate, channels);
!     rate=samplerate;
!     chn=channels;
      snd_pcm_hw_params_t *params;
      snd_pcm_sw_params_t *swparams;
--- 164,170 ----
  
      dsyslog ("[softdevice-audio] samplerate: %dHz, channels: #%d",
!              currContext.samplerate, currContext.channels);
!     //rate=samplerate;
!     //chn=channels;
      snd_pcm_hw_params_t *params;
      snd_pcm_sw_params_t *swparams;
***************
*** 188,192 ****
      }
  
!     err = snd_pcm_hw_params_set_channels(handle, params, channels);
      if (err < 0) {
        dsyslog("[softdevice-audio] Channels count non available FATAL exiting");
--- 196,200 ----
      }
  
!     err = snd_pcm_hw_params_set_channels(handle, params,currContext.channels);
      if (err < 0) {
        dsyslog("[softdevice-audio] Channels count non available FATAL exiting");
***************
*** 194,205 ****
      }
  
!     err = snd_pcm_hw_params_set_rate_near(handle, params, &rate, 0);
      assert(err >= 0);
      if (rate != samplerate ) {
        dsyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",samplerate,rate);
        exit(1);
      }
! 
      // set period size
      periodSize = 4608 / 4;
      err = snd_pcm_hw_params_set_period_size_near(handle, params, &periodSize, 0);
--- 202,217 ----
      }
  
!     err = snd_pcm_hw_params_set_rate_near(handle, params, &currContext.samplerate, 0);
      assert(err >= 0);
+     /*
      if (rate != samplerate ) {
        dsyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",samplerate,rate);
        exit(1);
      }
! */
      // set period size
+     snd_pcm_uframes_t bufferSize;
+     snd_pcm_uframes_t periodSize;
+     //periodSize = 8;
      periodSize = 4608 / 4;
      err = snd_pcm_hw_params_set_period_size_near(handle, params, &periodSize, 0);
***************
*** 232,235 ****
--- 244,250 ----
              periodSize, bufferSize);
  
+     currContext.buffer_size=bufferSize;
+     currContext.period_size=periodSize;  
+     
      snd_pcm_sw_params_current(handle, swparams);
      err = snd_pcm_sw_params_get_xfer_align(swparams, &xfer_align);
***************
*** 239,244 ****
      }
      dsyslog("[softdevice-audio] Hardware initialized");
!     //usleep(200000);
!     // audioOut->Play(audiosamples,audio_size);
      return 0;
  }
--- 254,259 ----
      }
      dsyslog("[softdevice-audio] Hardware initialized");
! 
!     context=currContext;
      return 0;
  }
***************
*** 294,298 ****
  {
    paused=false;
-   rate = chn=0;
    dsyslog("[softdevice-audio-dummy] Device opened! Ready to play");
  }
--- 309,312 ----
***************
*** 329,341 ****
  /* ---------------------------------------------------------------------------
   */
! int cDummyAudioOut::SetParams(int channels, unsigned int samplerate)
  {
!   if ((chn == channels) && (rate == samplerate))
!     return 0;
  
!   dsyslog ("[softdevice-audio-dummy] samplerate: %dHz, channels: #%d",
!            samplerate, channels);
!   rate=samplerate;
!   chn=channels;
  
    return 0;
--- 343,357 ----
  /* ---------------------------------------------------------------------------
   */
! int cDummyAudioOut::SetParams(SampleContext &context)
  {
!   int err;
  
!   // not needed to set again
!   if (currContext.samplerate == context.samplerate &&
!       currContext.channels == context.channels ) {
!     context=currContext;
!     return 0;
!   };
!   currContext=context;
  
    return 0;

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** audio.h	10 Mar 2005 21:05:56 -0000	1.4
--- audio.h	17 Mar 2005 20:15:35 -0000	1.5
***************
*** 15,18 ****
--- 15,26 ----
  #include "setup-softdevice.h"
  
+ struct SampleContext {
+    uint32_t channels;
+    uint32_t samplerate;
+    uint32_t pcm_fmt;
+    uint32_t period_size;
+    uint32_t buffer_size;
+ };
+ 
  /* ---------------------------------------------------------------------------
   * Abstract class for an audio device
***************
*** 21,29 ****
  private:
  protected:
  public:
    virtual ~cAudioOut();
    virtual void Write(uchar *Data, int Length)=0;
    // length should always be a multiple of 4
!   virtual int SetParams(int channels, unsigned int samplerate)=0;
    virtual int GetDelay(void)=0; // returns delay in ms
    virtual void Pause(void)=0;
--- 29,38 ----
  private:
  protected:
+   SampleContext currContext;
  public:
    virtual ~cAudioOut();
    virtual void Write(uchar *Data, int Length)=0;
    // length should always be a multiple of 4
!   virtual int SetParams(SampleContext &context)=0;
    virtual int GetDelay(void)=0; // returns delay in ms
    virtual void Pause(void)=0;
***************
*** 42,49 ****
  private:
    void Xrun(void);
!   unsigned int rate;
!   int chn;
!   snd_pcm_uframes_t bufferSize;
!   snd_pcm_uframes_t periodSize;
    snd_pcm_t *handle;
    char *device;
--- 51,58 ----
  private:
    void Xrun(void);
!   //unsigned int rate;
!   //int chn;
!   //snd_pcm_uframes_t bufferSize;
!   //snd_pcm_uframes_t periodSize;
    snd_pcm_t *handle;
    char *device;
***************
*** 54,58 ****
    virtual ~cAlsaAudioOut();
    virtual void Write(uchar *Data, int Length);
!   virtual int SetParams(int channels, unsigned int samplerate);
    virtual int GetDelay(void);
    virtual void Pause(void);
--- 63,68 ----
    virtual ~cAlsaAudioOut();
    virtual void Write(uchar *Data, int Length);
!   //virtual int SetParams(int channels, unsigned int samplerate);
!   virtual int SetParams(SampleContext &context);
    virtual int GetDelay(void);
    virtual void Pause(void);
***************
*** 67,72 ****
  class cDummyAudioOut : public cAudioOut  {
  private:
-   unsigned int rate;
-   int chn;
    volatile bool paused;
  public:
--- 77,80 ----
***************
*** 74,78 ****
    virtual ~cDummyAudioOut() { return; };
    virtual void Write(uchar *Data, int Length);
!   virtual int SetParams(int channels, unsigned int samplerate);
    virtual int GetDelay(void);
    virtual void Pause(void);
--- 82,86 ----
    virtual ~cDummyAudioOut() { return; };
    virtual void Write(uchar *Data, int Length);
!   virtual int SetParams(SampleContext &context);
    virtual int GetDelay(void);
    virtual void Pause(void);

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** mpeg2decoder.c	15 Mar 2005 17:20:22 -0000	1.20
--- mpeg2decoder.c	17 Mar 2005 20:15:35 -0000	1.21
***************
*** 19,34 ****
  #include "utils.h"
  #include "setup-softdevice.h"
- #define UNSYNCED 0
- #define PAYLOAD 100
- #define PAYLOADDATA 200
- #define HEADER 300
- #define OPTHEADER 400
- #define STREAM 500
  
- //#define HDRDEB(out...) {printf("header[%04d]:",getTimeMilis() % 10000);printf(out);}
[...1998 lines suppressed...]
!   decoding=false;
    return Length;
  }
--- 1324,1339 ----
      return Length;
  
!   //MPGDEB("Decode: StreamBuffer: %d plus %d\n",StreamBuffer->Available(),Length);
! 
!   mutex.Lock();
!   int P;
!   int Size=Length;
!   while ( (P = StreamBuffer->Put(Data, Size)) != Size ) {
!     Data+=P;
!     Size-=P;
!     usleep( 10000 );
    }
!   mutex.Unlock();
!    
    return Length;
  }

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** mpeg2decoder.h	15 Mar 2005 17:20:22 -0000	1.14
--- mpeg2decoder.h	17 Mar 2005 20:15:35 -0000	1.15
***************
*** 14,45 ****
  #include "video.h"
  #include "audio.h"
  #include <vdr/plugin.h>
  #include <vdr/ringbuffer.h>
- #define MAX_HDR_LEN 0xFF
  
  #define DEFAULT_FRAMETIME 40   // for PAL
! #define DVB_BUF_SIZE   (4* 256*1024)  // same value as in dvbplayer.c
! #define AVG_FRAME_SIZE 15000         // dito 
! #define PTS_COUNT       4             // history of four PTS values
  
! struct PES_Header1 {
!   unsigned int is_original:1;
!   unsigned int has_copyright:1;
!   unsigned int data_alignment:1;
!   unsigned int priority:1;
!   unsigned int scrambling_ctrl:2;
!   unsigned int flag:2;
! };
  
! struct PES_Header2 {
!   unsigned int extension_exists:1;
!   unsigned int has_crc:1;
!   unsigned int has_copy_info:1;
!   unsigned int trick_mode_flag:1;
!   unsigned int has_es_rate:1;
!   unsigned int has_escr:1;
!   unsigned int ptsdts_flags:2;
! };
  
  // wrapper class to access protected methods
  class cSoftRingBufferLinear : public cRingBufferLinear {
--- 14,69 ----
  #include "video.h"
  #include "audio.h"
+ #include <avformat.h>
+ #include <sys/time.h>
  #include <vdr/plugin.h>
  #include <vdr/ringbuffer.h>
  
  #define DEFAULT_FRAMETIME 40   // for PAL
! #define DVB_BUF_SIZE   (64*1024)  // same value as in dvbplayer.c
  
! #define NO_STREAM    -1
! #define DONT_PLAY  -100
  
! class cAudioStreamDecoder; 
! 
! // -----------------cClock --------------------------------------------
! class cClock {
!     static cAudioStreamDecoder *audioClock;
  
+ public:
+     cClock() {audioClock=NULL;};
+     virtual ~cClock() {};
+     static void SetAudioClock(cAudioStreamDecoder *AudioClock)
+     {audioClock=AudioClock;};
+     virtual uint64_t GetPTS();
+ };	
+ 
+ // -----------------cPacketQueue -----------------------------------------
+ class cPacketQueue {
+     // Only one thread may read, and only one thread may write!!!
+ public:
+    const static int MaxPackets=500;
+ private:
+     AVPacket queue[MaxPackets];
+     int FirstPacket,LastPacket;
+ 
+     inline int Next(int Packet) 
+     { return (Packet+1)%MaxPackets; };
+     
+ public:
+     cPacketQueue();
+     ~cPacketQueue() {};
+ 
+     int PutPacket(const AVPacket &Packet);
+ 
+     AVPacket * GetReadPacket();
+     void FreeReadPacket(AVPacket *Packet);
+ 
+     void Clear();
+     inline int Available()
+     { return (LastPacket+MaxPackets - FirstPacket)%MaxPackets; }; 
+ };
+  
+ //--------------------------cSoftRingBufferLinear --------------------------
  // wrapper class to access protected methods
  class cSoftRingBufferLinear : public cRingBufferLinear {
***************
*** 54,143 ****
  };
  
  // Output device handler
  class cStreamDecoder : public cThread {
  private:
  
-     // used by ParseStreamIntern
-     unsigned int syncword;
-     int payload;
-     int state;
-     int headerLength;
-     unsigned char * hdr_ptr;
- 
-     struct PES_Header1 Header1;
-     struct PES_Header2 Header2;
- 
- 
      bool freezeMode;
  protected:
!     unsigned int          streamID; // stream to filter
!     int64_t               newPTS,
!                           prevPTS,
!                           historyPTS[PTS_COUNT],
!                           pts;
!     int                   frame,
!                           packetLength,
!                           historyPTSIndex;
!     bool                  validPTS;
!     unsigned char         header[MAX_HDR_LEN];
      AVCodec               *codec;
      AVCodecContext        *context;
      
      cMutex                mutex;
-     cSoftRingBufferLinear *ringBuffer;
      bool                  active, running;
      
-     int ParseStream(uchar *Data, int Length);
-     int ParseStreamIntern(uchar *Data, int Length, unsigned int lowID, unsigned int highID);
-     inline void ClearParseStream() {state=0;};
-     
      virtual void Action(void);
  public:
!     virtual int DecodeData(uchar *Data, int Length) = 0;
!     virtual void Write(uchar *Data, int Length);
      virtual void Clear(void);
      virtual void Freeze(void);
      virtual void Play(void);
      virtual void TrickSpeed(int Speed) {return;};
      virtual int StillPicture(uchar *Data, int Length) {return 0;};
      virtual int BufferFill(void);
      virtual uint64_t GetPTS()  {return pts;};
! 
!     virtual void Stop();
!     virtual void setStreamId (int id, const uchar *d) {return;};
! 
!     cStreamDecoder(unsigned int StreamID);
      virtual ~cStreamDecoder();
  };
  
! 
!   enum PCMState {
!       SNone,
!       SHeader=10,
!       SData=50,
!   } ;
! 
  class cAudioStreamDecoder : public cStreamDecoder {
  private:
!     uint8_t   *audiosamples;
      cAudioOut *audioOut;
!     int       PCMpos,
!               PCMState;
!     uchar     PCMHeader[10];
  
  protected:
  public:
!     virtual int DecodeData(uchar *Data, int Length);
!     cAudioStreamDecoder(unsigned int StreamID, cAudioOut *AudioOut);
      ~cAudioStreamDecoder();
!     virtual uint64_t  GetPTS();
!     virtual void      setStreamId (int id, const uchar *d);
!     virtual int       PCMDecode(AVCodecContext *context, short *audiosamples,
!                                 int *audio_size, uchar *Data, int Length);
  };
  
  class cVideoStreamDecoder : public cStreamDecoder {
    private:
!     cAudioStreamDecoder *AudioStream;
      AVFrame             *picture;
      AVPicture           avpic_src, avpic_dest;
--- 78,176 ----
  };
  
+ //-------------------------cRelTimer-----------------------------------
+ class cRelTimer {
+    private:
+       int64_t lastTime;
+       inline int64_t GetTime()
+       {  
+         struct timeval tv;
+         struct timezone tz;
+         gettimeofday(&tv,&tz);
+         return tv.tv_sec*1000000+tv.tv_usec;
+       };
+ 
+    public:
+       cRelTimer() {lastTime=GetTime();};
+       ~cRelTimer() {};
+       
+       int32_t TimePassed();
+       int32_t GetRelTime();
+       inline void Reset() { lastTime=GetTime(); };
+ };
+       
+ //-------------------------cStreamDecoder ----------------------------------
  // Output device handler
  class cStreamDecoder : public cThread {
  private:
  
      bool freezeMode;
+     cPacketQueue PacketQueue;
  protected:
!     int64_t               pts;
!     int                   frame;
!     
      AVCodec               *codec;
      AVCodecContext        *context;
      
      cMutex                mutex;
      bool                  active, running;
      
      virtual void Action(void);
+     virtual int DecodePacket(AVPacket *pkt) = 0;
  public:
!     inline int PutPacket(const AVPacket &pkt)
!     { return PacketQueue.PutPacket(pkt); };
! 
      virtual void Clear(void);
      virtual void Freeze(void);
      virtual void Play(void);
+     virtual void Stop();
      virtual void TrickSpeed(int Speed) {return;};
      virtual int StillPicture(uchar *Data, int Length) {return 0;};
      virtual int BufferFill(void);
+     bool    initCodec(void);
+     void    resetCodec(void);
      virtual uint64_t GetPTS()  {return pts;};
!     
!     cStreamDecoder(AVCodecContext * Context);
      virtual ~cStreamDecoder();
  };
  
! //----------------------------cAudioStreamDecoder ----------------------------
  class cAudioStreamDecoder : public cStreamDecoder {
  private:
!     uint8_t * audiosamples;
!     cSoftRingBufferLinear *audioBuffer;
      cAudioOut *audioOut;
!     SampleContext audioOutContext;
!     int audioMode;
  
+     void OnlyLeft(uint8_t *samples,int Length);
+     // copy left data to right channel
+     void OnlyRight(uint8_t *samples,int Length);
+     // copy right data to left channel
  protected:
  public:
!     virtual int DecodePacket(AVPacket *pkt);
!     cAudioStreamDecoder(AVCodecContext *Context, cAudioOut *AudioOut,
!        int AudioChannel=0);
      ~cAudioStreamDecoder();
!     inline void SetAudioMode(int AudioMode)
!       { audioMode=AudioMode; };
!     virtual uint64_t GetPTS();
  };
  
+ //---------------------------cVideoStreamDecoder -----------------------------
  class cVideoStreamDecoder : public cStreamDecoder {
    private:
!     cClock *clock;
! #define NO_PTS_VALUES 10
!     struct {
!        int coded_frame_no;
!        int64_t pts;
!     } pts_values[NO_PTS_VALUES];
!     int lastPTSidx;
!     int lastCodedPictNo;
!     int64_t lastPTS;
      AVFrame             *picture;
      AVPicture           avpic_src, avpic_dest;
***************
*** 155,168 ****
      // A-V syncing stuff
      bool               syncOnAudio;
!     int64_t            lastTime;
      int                offset;
      int                delay;
      int                rtc_fd; 
      int                frametime;
-     int                 newBackIndex, currentBackIndex,
-                         workBackIndex, backIndexTab [5];
      int32_t GetRelTime();
     
-     void    resetCodec(void);
      uchar   *allocatePicBuf(uchar *pic_buf);
      void    deintLibavcodec(void);
--- 188,199 ----
      // A-V syncing stuff
      bool               syncOnAudio;
!     cRelTimer          Timer;
      int                offset;
      int                delay;
+     int                timePassed;
      int                rtc_fd; 
      int                frametime;
      int32_t GetRelTime();
     
      uchar   *allocatePicBuf(uchar *pic_buf);
      void    deintLibavcodec(void);
***************
*** 174,215 ****
  
    public:
!     cVideoStreamDecoder(unsigned int StreamID, cVideoOut *VideoOut,
!        cAudioStreamDecoder *AudioStreamDecoder );
      ~cVideoStreamDecoder();
  
!     virtual int   DecodeData(uchar *Data, int Length);
!     virtual int   StillPicture(uchar *Data, int Length);
      virtual void TrickSpeed(int Speed);
  };
  
  
! class cMpeg2Decoder {
  private:
!     uint8_t * audiosamples;
!     int  state, payload, streamtype;
!     unsigned char header[6];     
!     unsigned int syncword;
!     cStreamDecoder  *vout, *aout;
      cAudioOut       *audioOut;
      cVideoOut       *videoOut;
-     int             ac3Mode, ac3Parm, lpcmMode, lpcmSubstreamId;
      bool running;
      bool IsSuspended;
      bool decoding;
  public:
      cMpeg2Decoder(cAudioOut *AudioOut, cVideoOut *VideoOut);
      ~cMpeg2Decoder();
!     int PlayAudio(const uchar *Data, int Length);
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);
!     void Start(void);
      void Play(void);
      void Freeze(void);
!     void Stop(void);
      void Clear(void);
      void Suspend(void);
      void Resume(void);
      void TrickSpeed(int Speed);
!     bool BufferFilled(void);
      int64_t GetSTC(void);
  };
--- 205,276 ----
  
    public:
!     cVideoStreamDecoder(AVCodecContext *Context, cVideoOut *VideoOut,
!        cClock *clock);
      ~cVideoStreamDecoder();
  
!     virtual int DecodePacket(AVPacket *pkt);
!     virtual int StillPicture(uchar *Data, int Length);
      virtual void TrickSpeed(int Speed);
+     virtual uint64_t GetPTS();
  };
  
  
! //--------------------------------cMpeg2Decoder -------------------------
! class cMpeg2Decoder: public cThread  {
  private:
!     cVideoStreamDecoder  *vout;
!     cAudioStreamDecoder  *aout;
      cAudioOut       *audioOut;
      cVideoOut       *videoOut;
      bool running;
      bool IsSuspended;
      bool decoding;
+     bool freezeMode;
+     
+     AVFormatContext *ic;
+     int LastSize;
+     cMutex  mutex;
+     cSoftRingBufferLinear *StreamBuffer;
+     void initStream();
+     virtual void Action(void);
+     volatile bool   ThreadActive, ThreadRunning;
+     cClock  clock;
+     //demuxing
+     int AudioIdx;
+     int VideoIdx;
+ 
+     int audioMode;
+ public:
+     int read_packet(uint8_t *buf, int buf_size);
+     int seek(offset_t offset, int whence);
+ 
  public:
      cMpeg2Decoder(cAudioOut *AudioOut, cVideoOut *VideoOut);
      ~cMpeg2Decoder();
! 
!     void DecodePacket(const AVFormatContext *ic,AVPacket &pkt);
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);
!     void Start(bool GetMutex=true);
      void Play(void);
      void Freeze(void);
!     void Stop(bool GetMutex=true);
      void Clear(void);
      void Suspend(void);
      void Resume(void);
      void TrickSpeed(int Speed);
!     
!     void PlayAudioVideo(bool playVideo,bool playAudio)
!     { AudioIdx=playAudio?NO_STREAM:DONT_PLAY;
!       VideoIdx=playVideo?NO_STREAM:DONT_PLAY;}
! 
!     inline void SetAudioMode(int AudioMode) 
!     { audioMode=AudioMode; if (aout) aout->SetAudioMode(audioMode); };
!     inline int GetAudioMode()
!     { return audioMode; };
!     
!     int BufferFill(void);
!     // in percent 
!     
      int64_t GetSTC(void);
  };

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** softdevice.c	10 Mar 2005 21:05:56 -0000	1.19
--- softdevice.c	17 Mar 2005 20:15:35 -0000	1.20
***************
*** 7,10 ****
--- 7,12 ----
   */
  
+ #include "softdevice.h"
+ 
  #include <getopt.h>
  #include <stdlib.h>
***************
*** 14,21 ****
  #endif
  
- #include <vdr/interface.h>
- #include <vdr/plugin.h>
- #include <vdr/player.h>
- 
  #if VDRVERSNUM >= 10307
  #include <vdr/osd.h>
--- 16,19 ----
***************
*** 28,34 ****
  #include <sys/ioctl.h>
  #include <linux/fb.h>
- #include "i18n.h"
- #include "setup-softdevice.h"
- 
  #include "video-dummy.h"
  
--- 26,29 ----
***************
*** 226,308 ****
  #endif
  
- // --- cSoftDevice ------------------------------------------------------------
- class cPluginSoftDevice : public cPlugin {
- private:
-   int   voutMethod, aoutMethod;
-   char  *pluginPath;
- 
- public:
-   cPluginSoftDevice(void);
-   virtual ~cPluginSoftDevice();
-   virtual const char *Version(void) { return VERSION; }
-   virtual const char *Description(void) { return tr(DESCRIPTION); }
-   virtual const char *CommandLineHelp(void);
-   virtual bool Initialize(void);
-   virtual bool ProcessArgs(int argc, char *argv[]);
-   virtual bool Start(void);
-   virtual void Housekeeping(void);
-   virtual const char *MainMenuEntry(void) { return tr(MAINMENUENTRY); }
-   virtual cOsdObject *MainMenuAction(void);
-   virtual cMenuSetupPage *SetupMenu(void);
-   virtual bool SetupParse(const char *Name, const char *Value);
-   };
- 
- // Global variables that control the overall behaviour:
- 
- #define AC3_TEST  1
- 
- // --- cSoftDevice --------------------------------------------------
- class cSoftDevice : public cDevice {
- private:
-   cMpeg2Decoder *decoder;
- 
- #if VDRVERSNUM < 10307
-   cOsdBase *OSD;
- #endif
- 
-   cVideoOut *videoOut;
-   cAudioOut *audioOut;
-   int       outMethod;
- 
-   bool      freezeModeEnabled;
-   cMutex    playMutex;
-   cCondVar  readyForPlayCondVar;
- 
- public:
-   cSoftDevice(int method, int audioMethod, char *pluginPath);
-   ~cSoftDevice();
-   virtual bool HasDecoder(void) const;
-   virtual bool CanReplay(void) const;
-   virtual bool SetPlayMode(ePlayMode PlayMode);
-   virtual void TrickSpeed(int Speed);
-   virtual void Clear(void);
-   virtual void Play(void);
-   virtual void Freeze(void);
-   virtual void Mute(void);
-   virtual void SetVolumeDevice (int Volume);
-   virtual void StillPicture(const uchar *Data, int Length);
-   virtual bool Poll(cPoller &Poller, int TimeoutMs = 0);
-   virtual int64_t GetSTC(void);
-   virtual int PlayVideo(const uchar *Data, int Length);
- #if VDRVERSNUM < 10318
-   virtual void PlayAudio(const uchar *Data, int Length);
- #else
-   virtual int  PlayAudio(const uchar *Data, int Length);
-   virtual void SetDigitalAudioDevice(bool On);
- 
- protected:
-   virtual void SetAudioTrackDevice(eTrackType Type);
- 
- public:
- #endif
- #if VDRVERSNUM >= 10307
-   virtual int ProvidesCa(const cChannel *Channel) const;
-   virtual void MakePrimaryDevice(bool On);
- #else
-   int ProvidesCa(int Ca);
-   virtual cOsdBase *NewOsd(int x, int y);
- #endif
- };
- 
  cSoftDevice::cSoftDevice(int method,int audioMethod, char *pluginPath)
  {
--- 221,224 ----
***************
*** 373,376 ****
--- 289,293 ----
            videoOut->Reconfigure (reconfigureArg))
        {
+           printf("Subplugin successfully opend\n");
            dsyslog("[softdevice] videoOut OK !\n");
        }
***************
*** 498,501 ****
--- 415,419 ----
  	    break;
  	default:
+ 	    printf("playmode not implemented... %d\n",PlayMode);
  	    decoder->Stop();
  	    break;
***************
*** 506,509 ****
--- 424,440 ----
  }
  
+ void cSoftDevice::SetAudioChannelDevice(int AudioChannel)
+ {
+   if (decoder)
+      decoder->SetAudioMode(AudioChannel);
+ };
+ 
+ int  cSoftDevice::GetAudioChannelDevice(void)
+ {
+   if (decoder)
+     return decoder->GetAudioMode();
+   else return 0;
+ };
+ 
  void cSoftDevice::TrickSpeed(int Speed)
  {
***************
*** 565,572 ****
    playMutex.Unlock();
  
!   if (decoder->BufferFilled()) {
!      //fprintf(stderr,"[softdevice] Buffer filled, sleeping\n");
!      usleep(TimeoutMs*1000);
!      return decoder->BufferFilled();
    }
  
--- 496,512 ----
    playMutex.Unlock();
  
!   if ( decoder->BufferFill() > 90 ) {
!      //fprintf(stderr,"[softdevice] Buffer filled, TimeoutMs %d, fill %d\n",
!      //  TimeoutMs,decoder->BufferFill());
!      int64_t TimeoutUs=TimeoutMs*1000;
!      cRelTimer Timer;
!      Timer.Reset();
!   
!      while ( TimeoutUs > 0 ) {
!        usleep(10000);
!        TimeoutUs-=Timer.GetRelTime();
!      };
!      
!      return decoder->BufferFill() < 99;
    }
  
***************
*** 574,577 ****
--- 514,531 ----
  }
  
+ bool cSoftDevice::Flush(int TimeoutMs)
+ {
+   int64_t TimeoutUs=TimeoutMs*1000;
+   cRelTimer Timer;
+   Timer.Reset();
+   
+   while ( TimeoutUs > 0 && decoder->BufferFill() > 0 ) {
+        usleep(1000);
+        TimeoutUs-=Timer.GetRelTime();
+   };
+       
+   return  decoder->BufferFill() == 0;
+ };
+ 
  #if VDRVERSNUM < 10318
  /* ----------------------------------------------------------------------------
***************
*** 579,583 ****
  void cSoftDevice::PlayAudio(const uchar *Data, int Length)
  {
-   decoder->PlayAudio(Data, Length);
  }
  #else
--- 533,536 ----
***************
*** 586,590 ****
  int cSoftDevice::PlayAudio(const uchar *Data, int Length)
  {
!   return decoder->PlayAudio(Data, Length);
  }
  
--- 539,543 ----
  int cSoftDevice::PlayAudio(const uchar *Data, int Length)
  {
!   return decoder->Decode(Data, Length);
  }
  
***************
*** 647,650 ****
--- 600,612 ----
    // Clean up after yourself!
  }
+ 
+ const char *cPluginSoftDevice::Version(void) 
+ { return VERSION; }
+ 
+ const char *cPluginSoftDevice::Description(void) 
+ { return tr(DESCRIPTION); }
+ 
+ const char *cPluginSoftDevice::MainMenuEntry(void)
+ { return tr(MAINMENUENTRY); }
  
  const char *cPluginSoftDevice::CommandLineHelp(void)



From nobody at sheep.berlios.de  Fri Mar 18 18:36:49 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 18 Mar 2005 18:36:49 +0100
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.21,1.22
Message-ID: <200503181736.j2IHanN15718@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10105

Modified Files:
	mpeg2decoder.c 
Log Message:
- set freezeMode to false before starting mpeg2decoder thread
- use audioOutContext instead of context in AudioStreamDecoder::GetPTS



Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** mpeg2decoder.c	17 Mar 2005 20:15:35 -0000	1.21
--- mpeg2decoder.c	18 Mar 2005 17:36:45 -0000	1.22
***************
*** 269,273 ****
  {
    uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset;
!   if (audioBuffer && context)
       PTS-=(audioBuffer->Available() /
         (audioOutContext.samplerate/1000*2*audioOutContext.channels));
--- 269,273 ----
  {
    uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset;
!   if (audioBuffer && audioOutContext.channels)
       PTS-=(audioBuffer->Available() /
         (audioOutContext.samplerate/1000*2*audioOutContext.channels));
***************
*** 1137,1140 ****
--- 1137,1141 ----
    initStream();
    ThreadActive=true;
+   freezeMode=false;
    cThread::Start();
    running=true;



From nobody at sheep.berlios.de  Fri Mar 18 19:33:47 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 18 Mar 2005 19:33:47 +0100
Subject: [Softdevice-cvs] softdevice audio.c,1.9,1.10
Message-ID: <200503181833.j2IIXlN17082@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14586

Modified Files:
	audio.c 
Log Message:
- init samplerate with default to avoid divide by zero


Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** audio.c	17 Mar 2005 20:15:35 -0000	1.9
--- audio.c	18 Mar 2005 18:33:43 -0000	1.10
***************
*** 36,39 ****
--- 36,40 ----
      }
      currContext.channels=0;
+     currContext.samplerate=48000;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
  }



From nobody at sheep.berlios.de  Sat Mar 19 23:01:23 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 19 Mar 2005 23:01:23 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.46,1.47 Makefile,1.10,1.11 audio.c,1.10,1.11 i18n.c,1.2,1.3 softdevice.c,1.20,1.21
Message-ID: <200503192201.j2JM1NM10918@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4228

Modified Files:
	CHANGELOG Makefile audio.c i18n.c softdevice.c 
Log Message:
fix compile problems for vdr-1.2.x (OSD ok, but _no_ A/V :-( )

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** CHANGELOG	17 Mar 2005 20:15:35 -0000	1.46
--- CHANGELOG	19 Mar 2005 22:01:21 -0000	1.47
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-03-19:
+     - fix compile problems for vdr-1.2.x (OSD ok, but _no_ A/V :-( ).
  2005-03-17:
      - add left/right channel only support

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** Makefile	17 Mar 2005 20:15:35 -0000	1.10
--- Makefile	19 Mar 2005 22:01:21 -0000	1.11
***************
*** 188,192 ****
    ifdef USE_SUBPLUGINS
      XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
!     XV_OBJS   = video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libvdr-$(PLUGIN)-xv.so
--- 188,192 ----
    ifdef USE_SUBPLUGINS
      XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libvdr-$(PLUGIN)-xv.so
***************
*** 203,207 ****
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = video.o video-vidix.o
      VIDIX_LIBS  = -lvidix
      ALL_OBJS    += $(VIDIX_OBJS)
--- 203,207 ----
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o
      VIDIX_LIBS  = -lvidix
      ALL_OBJS    += $(VIDIX_OBJS)
***************
*** 277,279 ****
  
  clean:
! 	@-rm -f $(OBJS) $(DEPFILE) *.so *.tgz core* *~
--- 277,279 ----
  
  clean:
! 	@-rm -f $(OBJS) $(DEPFILE) *.so *.o *.tgz core* *~

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** audio.c	18 Mar 2005 18:33:43 -0000	1.10
--- audio.c	19 Mar 2005 22:01:21 -0000	1.11
***************
*** 307,310 ****
--- 307,312 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
  cDummyAudioOut::cDummyAudioOut(cSetupStore *setupStore)
  {
***************
*** 313,317 ****
  }
  
- 
  /* ---------------------------------------------------------------------------
   */
--- 315,318 ----
***************
*** 346,351 ****
  int cDummyAudioOut::SetParams(SampleContext &context)
  {
-   int err;
- 
    // not needed to set again
    if (currContext.samplerate == context.samplerate &&
--- 347,350 ----
***************
*** 353,357 ****
      context=currContext;
      return 0;
!   };
    currContext=context;
  
--- 352,356 ----
      context=currContext;
      return 0;
!   }
    currContext=context;
  

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** i18n.c	4 Mar 2005 20:04:20 -0000	1.2
--- i18n.c	19 Mar 2005 22:01:21 -0000	1.3
***************
*** 26,33 ****
--- 26,35 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "Xv startup aspect",   //  1
***************
*** 47,54 ****
--- 49,58 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "CropMode",         //  1
***************
*** 68,75 ****
--- 72,81 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "Deinterlace Method",   //  1
***************
*** 89,96 ****
--- 95,104 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "Pixel Format",   //  1
***************
*** 110,117 ****
--- 118,127 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "Picture mirroring",    //  1
***************
*** 131,138 ****
--- 141,150 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "A/V Delay",        //  1
***************
*** 152,159 ****
--- 164,173 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "Pixel Aspect",       //  1
***************
*** 173,180 ****
--- 187,196 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "Playback",     //  1
***************
*** 194,201 ****
--- 210,219 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "OSD alpha blending",   //  1
***************
*** 215,222 ****
--- 233,242 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "on",       //  1
***************
*** 236,243 ****
--- 256,265 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { "off",          //  1
***************
*** 257,264 ****
--- 279,288 ----
      "",             // 15 TODO
      "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
      "",             // 17 TODO
      "",             // 18 TODO
      "",             // 19 TODO
      "",             // 20 TODO
+ #endif
    },
    { NULL }

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** softdevice.c	17 Mar 2005 20:15:35 -0000	1.20
--- softdevice.c	19 Mar 2005 22:01:21 -0000	1.21
***************
*** 424,440 ****
  }
  
- void cSoftDevice::SetAudioChannelDevice(int AudioChannel)
- {
-   if (decoder)
-      decoder->SetAudioMode(AudioChannel);
- };
- 
- int  cSoftDevice::GetAudioChannelDevice(void)
- {
-   if (decoder)
-     return decoder->GetAudioMode();
-   else return 0;
- };
- 
  void cSoftDevice::TrickSpeed(int Speed)
  {
--- 424,427 ----
***************
*** 555,558 ****
--- 542,563 ----
    //fprintf (stderr, "[SetDigitalAudioDevice] (%s)\n",(On)? "TRUE":"FALSE");
  }
+ 
+ /* ----------------------------------------------------------------------------
+  */
+ void cSoftDevice::SetAudioChannelDevice(int AudioChannel)
+ {
+   if (decoder)
+      decoder->SetAudioMode(AudioChannel);
+ }
+ 
+ /* ----------------------------------------------------------------------------
+  */
+ int  cSoftDevice::GetAudioChannelDevice(void)
+ {
+   if (decoder)
+     return decoder->GetAudioMode();
+   else return 0;
+ }
+ 
  #endif
  



From nobody at sheep.berlios.de  Sun Mar 20 13:21:31 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 20 Mar 2005 13:21:31 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.47,1.48 audio.c,1.11,1.12 audio.h,1.5,1.6 mpeg2decoder.c,1.22,1.23 mpeg2decoder.h,1.15,1.16 softdevice.c,1.21,1.22 softdevice.h,1.1,1.2
Message-ID: <200503201221.j2KCLVM29209@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25435

Modified Files:
	CHANGELOG audio.c audio.h mpeg2decoder.c mpeg2decoder.h 
	softdevice.c softdevice.h 
Log Message:
- preperations for sync on video option
- syncronize audio and video start
- all pts values now in units of 0.1ms (needed for 44.1kHz audio streams)
- add SpuDecoder
		


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.47
retrieving revision 1.48
diff -C2 -d -r1.47 -r1.48
*** CHANGELOG	19 Mar 2005 22:01:21 -0000	1.47
--- CHANGELOG	20 Mar 2005 12:21:27 -0000	1.48
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+     - preperations for sync on video option
+     - syncronize audio and video start
+     - all pts values now in units of 0.1ms (needed for 44.1kHz audio streams)
+     - add SpuDecoder
  2005-03-19:
      - fix compile problems for vdr-1.2.x (OSD ok, but _no_ A/V :-( ).

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** audio.c	19 Mar 2005 22:01:21 -0000	1.11
--- audio.c	20 Mar 2005 12:21:27 -0000	1.12
***************
*** 110,114 ****
  		exit(EXIT_FAILURE);
  	}
!     return snd_pcm_status_get_delay(status) *1000 / currContext.samplerate;
  }
  
--- 110,114 ----
  		exit(EXIT_FAILURE);
  	}
!     return snd_pcm_status_get_delay(status) *10000 / currContext.samplerate;
  }
  
***************
*** 205,214 ****
      err = snd_pcm_hw_params_set_rate_near(handle, params, &currContext.samplerate, 0);
      assert(err >= 0);
!     /*
!     if (rate != samplerate ) {
!       dsyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",samplerate,rate);
        exit(1);
      }
! */
      // set period size
      snd_pcm_uframes_t bufferSize;
--- 205,213 ----
      err = snd_pcm_hw_params_set_rate_near(handle, params, &currContext.samplerate, 0);
      assert(err >= 0);
!     if (currContext.samplerate != context.samplerate ) {
!       dsyslog("[softdevice-audio] Rate %d Hz is not possible (and using instead %d Hz is not implemented) FATAL exiting",context.samplerate,currContext.samplerate);
        exit(1);
      }
! 
      // set period size
      snd_pcm_uframes_t bufferSize;

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** audio.h	17 Mar 2005 20:15:35 -0000	1.5
--- audio.h	20 Mar 2005 12:21:27 -0000	1.6
***************
*** 35,39 ****
    // length should always be a multiple of 4
    virtual int SetParams(SampleContext &context)=0;
!   virtual int GetDelay(void)=0; // returns delay in ms
    virtual void Pause(void)=0;
    virtual void Play(void)=0;
--- 35,39 ----
    // length should always be a multiple of 4
    virtual int SetParams(SampleContext &context)=0;
!   virtual int GetDelay(void)=0; // returns delay in 0.1 ms
    virtual void Pause(void)=0;
    virtual void Play(void)=0;

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** mpeg2decoder.c	18 Mar 2005 17:36:45 -0000	1.22
--- mpeg2decoder.c	20 Mar 2005 12:21:27 -0000	1.23
***************
*** 33,36 ****
--- 33,43 ----
  #endif
  
+ //#define BUFDEB(out...) {printf("BUF[%04d]:",getTimeMilis() % 10000);printf(out);}
+ 
+ #ifndef BUFDEB
+ #define BUFDEB(out...)
+ #endif
+ 
+ 
  //#define AV_STATS
  //------------------------------------cPacketBuffer------------------------
***************
*** 78,81 ****
--- 85,89 ----
  
  cAudioStreamDecoder *cClock::audioClock=NULL;
+ cVideoStreamDecoder *cClock::videoClock=NULL;
  
  uint64_t  cClock::GetPTS() {
***************
*** 121,125 ****
    context=Context;
    context->error_resilience=1;
!   CMDDEB("Neuer StreamDecoder type %d\n",getpid(),context->codec_type );
    pts=0;
    frame=0;
--- 129,133 ----
    context=Context;
    context->error_resilience=1;
!   CMDDEB("Neuer StreamDecoder Pid: %d type %d\n",getpid(),context->codec_type );
    pts=0;
    frame=0;
***************
*** 146,154 ****
    AVPacket *pkt;
  
!   while ( PacketQueue.Available() < 5 && active) 
      usleep(5000);
   
    while(active)
    {
  
      while (freezeMode && active)
--- 154,166 ----
    AVPacket *pkt;
  
!   while ( PacketQueue.Available() < 10 && active) { 
!     BUFDEB("wait while loop packets %d StreamDecoder  pid:%d type %d\n",
!       PacketQueue.Available(),getpid(),context->codec_type );
      usleep(5000);
+   };
   
    while(active)
    {
+     BUFDEB("while loop start StreamDecoder  pid:%d type %d\n",getpid(),context->codec_type );
  
      while (freezeMode && active)
***************
*** 162,165 ****
--- 174,178 ----
         av_free_packet(pkt);
         PacketQueue.FreeReadPacket(pkt);
+        mutex.Unlock();
      } else {
        mutex.Unlock();
***************
*** 172,178 ****
        if (!(count % 10)) {
          printf("Type: %d Buffer fill: %d\n",
! 	  context->codec_type,PacketQueue.Available());
! 	count=0;
! 	usleep(1000);
        };
      };
--- 185,191 ----
        if (!(count % 10)) {
          printf("Type: %d Buffer fill: %d\n",
!           context->codec_type,PacketQueue.Available());
!         count=0;
!         usleep(1000);
        };
      };
***************
*** 203,212 ****
  void cStreamDecoder::Clear(void)
  {
!   //printf("[mpegdecoder] Stream 0x%0x Clear %d \n",streamID,(ringBuffer->Free()*100)/ ringBuffer->Size() );
    mutex.Lock();
    avcodec_flush_buffers(context);
    PacketQueue.Clear();
    mutex.Unlock();
!   //printf("[mpegdecoder] Stream 0x%0x Clear %d \n",streamID,(ringBuffer->Free()*100)/ ringBuffer->Size() );
  }
  
--- 216,225 ----
  void cStreamDecoder::Clear(void)
  {
!   CMDDEB("cStreamDecoder clear\n");
    mutex.Lock();
    avcodec_flush_buffers(context);
    PacketQueue.Clear();
    mutex.Unlock();
!   CMDDEB("cStreamDecoder clear finished\n");
  }
  
***************
*** 260,265 ****
    audioOutContext.samplerate=44100;
    audioOutContext.channels=2;
-   
-   cClock::SetAudioClock(this);
  }
  
--- 273,276 ----
***************
*** 270,276 ****
    uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset;
    if (audioBuffer && audioOutContext.channels)
!      PTS-=(audioBuffer->Available() /
!        (audioOutContext.samplerate/1000*2*audioOutContext.channels));
!  
   return PTS;
  };
--- 281,286 ----
    uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset;
    if (audioBuffer && audioOutContext.channels)
!      PTS-=(audioBuffer->Available()*10000 /
!        (audioOutContext.samplerate*2*audioOutContext.channels));
   return PTS;
  };
***************
*** 278,287 ****
  void cAudioStreamDecoder::OnlyLeft(uint8_t *samples,int Length) {
    for (int i=0; i < Length/2; i+=2)
!   	((uint16_t*)samples)[i+1]=((uint16_t*)samples)[i];
  };
  
  void cAudioStreamDecoder::OnlyRight(uint8_t *samples,int Length) {
    for (int i=0; i < Length/2; i+=2)
!   	((uint16_t*)samples)[i]=((uint16_t*)samples)[i+1];
  };
  
--- 288,297 ----
  void cAudioStreamDecoder::OnlyLeft(uint8_t *samples,int Length) {
    for (int i=0; i < Length/2; i+=2)
!      ((uint16_t*)samples)[i+1]=((uint16_t*)samples)[i];
  };
  
  void cAudioStreamDecoder::OnlyRight(uint8_t *samples,int Length) {
    for (int i=0; i < Length/2; i+=2)
!     ((uint16_t*)samples)[i]=((uint16_t*)samples)[i+1];
  };
  
***************
*** 307,311 ****
      data+=len;
  
-     frame++;
      MPGDEB("audio: count: %d  Length: %d len: %d a_size: %d a_delay: %d\n",
         frame,pkt->size,len, audio_size, audioOut->GetDelay());
--- 317,320 ----
***************
*** 315,318 ****
--- 324,336 ----
        continue;
  
+     if (!frame)
+     {
+       //first frame - wait for ready for play
+       cClock::SetAudioClock(this);
+       while ( !cClock::ReadyForPlay() ) {
+          usleep(1000);
+          MPGDEB("audioStreamDecoder waiting for ReadyForPlay...\n");
+       };
+     };
      audioOutContext.channels=context->channels;
      audioOutContext.samplerate=context->sample_rate;
***************
*** 322,326 ****
      audioBuffer->Put(audiosamples,audio_size);
      // adjust PTS according to audio_size, sampel_rate and no. of channels  
!     pts += (audio_size/(context->sample_rate/1000*2*context->channels)); 
  
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
--- 340,344 ----
      audioBuffer->Put(audiosamples,audio_size);
      // adjust PTS according to audio_size, sampel_rate and no. of channels  
!     pts += (audio_size*10000/(context->sample_rate*2*context->channels)); 
  
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
***************
*** 328,332 ****
--- 346,352 ----
           pts,pkt->pts,(int) pts - pkt->pts );
        pts = pkt->pts;
+       pkt->pts=AV_NOPTS_VALUE;
      }
+     frame++;
    }
  
***************
*** 425,429 ****
  
  uint64_t cVideoStreamDecoder::GetPTS() {
!   return pts - (delay + Timer.TimePassed())/1000;
  };
  
--- 445,449 ----
  
  uint64_t cVideoStreamDecoder::GetPTS() {
!   return pts - (delay + Timer.TimePassed())/100;
  };
  
***************
*** 445,453 ****
      size-=len;
      data+=len;
! 	 
      // save coded picture number together with corresponding pts
      if (context->coded_frame  &&
          context->coded_frame->coded_picture_number!=lastCodedPictNo
! 	&& lastPTS != (int64_t) AV_NOPTS_VALUE ) {
        pts_values[lastPTSidx].pts = lastPTS;
        pts_values[lastPTSidx].coded_frame_no = 
--- 465,473 ----
      size-=len;
      data+=len;
!  
      // save coded picture number together with corresponding pts
      if (context->coded_frame  &&
          context->coded_frame->coded_picture_number!=lastCodedPictNo
!         && lastPTS != (int64_t) AV_NOPTS_VALUE ) {
        pts_values[lastPTSidx].pts = lastPTS;
        pts_values[lastPTSidx].coded_frame_no = 
***************
*** 458,462 ****
          context->coded_frame->coded_picture_number,
          lastPTS,
! 	lastPTSidx);
        lastPTS = AV_NOPTS_VALUE;
      };
--- 478,482 ----
          context->coded_frame->coded_picture_number,
          lastPTS,
!         lastPTSidx);
        lastPTS = AV_NOPTS_VALUE;
      };
***************
*** 468,471 ****
--- 488,501 ----
        continue;
  
+     if (!frame)
+     {
+       //first frame - wait for ready for play 
+       cClock::SetVideoClock(this);
+       while ( !cClock::ReadyForPlay() ) {
+         MPGDEB("audioStreamDecoder waiting for ReadyForPlay...\n");
+         usleep(1000);
+       };
+     };
+       
      // postproc stuff....
      if (setupStore.mirror == 1)
***************
*** 505,528 ****
    };
     */
     
!    // find decoded pictures pts value
!    int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
!    while ( picture->coded_picture_number !=
!               pts_values[findPTS].coded_frame_no && 
! 	   findPTS != lastPTSidx) 
! 	findPTS=(findPTS+1)%NO_PTS_VALUES;
!    
!    // found corresponding pts value
!    if (picture->coded_picture_number==pts_values[findPTS].coded_frame_no) {
!         MPGDEB("video pts: %lld, values.pkt : %lld pts - valid PTS: %lld pictno: %d idx: %d\n",
!         pts,pts_values[findPTS].pts,(int) pts - pts_values[findPTS].pts,
! 	picture->coded_picture_number,findPTS);
!       pts = pts_values[findPTS].pts;
!     };
! 
    
    // prepare picture for display
    videoOut->CheckAspectDimensions(picture,context);
- 
    
    // sleep ....
--- 535,561 ----
    };
     */
+ /*   if (picture->pts)
+    {
+      MPGDEB("got pts from picture: old pts: %lld pict pts: %lld\n",pts,picture->pts/100);
+      pts = picture->pts/100;
+    } else {*/
+      // find decoded pictures pts value
+      int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
+      while ( picture->coded_picture_number !=
+                 pts_values[findPTS].coded_frame_no && 
+                 findPTS != lastPTSidx) 
+          findPTS=(findPTS+1)%NO_PTS_VALUES;
     
!      // found corresponding pts value
!      if (picture->coded_picture_number==pts_values[findPTS].coded_frame_no) {
!           MPGDEB("video pts: %lld, values.pkt : %lld pts - valid PTS: %lld pictno: %d idx: %d\n",
!           pts,pts_values[findPTS].pts,(int) pts - pts_values[findPTS].pts,
!           picture->coded_picture_number,findPTS);
!           pts = pts_values[findPTS].pts;
!       };
!    //}
    
    // prepare picture for display
    videoOut->CheckAspectDimensions(picture,context);
    
    // sleep ....
***************
*** 581,594 ****
  
    // calculate pts correction. Max. correction is 1/10 frametime.
!   pts_corr = offset * 100;
!   if (pts_corr > frametime*100 )
!     pts_corr = frametime*100;
!   else if (pts_corr < -frametime*100)
!     pts_corr =-frametime*100;
  
    // calculate delay
    delay += ( frametime *1000 - pts_corr ) ;
    // update video pts 
!   pts += frametime;
    // so that pts - delay/1000 is always the current PTS
   
--- 614,627 ----
  
    // calculate pts correction. Max. correction is 1/10 frametime.
!   pts_corr = offset * 10;
!   if (pts_corr > frametime*100*2 )
!     pts_corr = frametime*100*2;
!   else if (pts_corr < -frametime*100*2)
!     pts_corr =-frametime*100*2;
  
    // calculate delay
    delay += ( frametime *1000 - pts_corr ) ;
    // update video pts 
!   pts += frametime*10;
    // so that pts - delay/1000 is always the current PTS
   
***************
*** 914,917 ****
--- 947,951 ----
  cVideoStreamDecoder::~cVideoStreamDecoder()
  {
+   cClock::SetVideoClock(NULL);
    //RTC
    if (rtc_fd)
***************
*** 967,972 ****
  //    printf("Del %d\n",LastSize);
      StreamBuffer->Del(LastSize);
! 
! //    MPGDEB("read_packet: StreamBuffer: %d\n",StreamBuffer->Available());
      int size=StreamBuffer->Available(); 
      int count=0;
--- 1001,1006 ----
  //    printf("Del %d\n",LastSize);
      StreamBuffer->Del(LastSize);
! start:
!     BUFDEB("read_packet: StreamBuffer: %d\n",StreamBuffer->Available());
      int size=StreamBuffer->Available(); 
      int count=0;
***************
*** 977,981 ****
        if (size>188) {
          count++;
! 	//CMDDEB("sleeping while data (%d) in buffer\n",size);
        };
      };
--- 1011,1015 ----
        if (size>188) {
          count++;
!         BUFDEB("read_packet: sleeping while data (%d) in buffer\n",size);
        };
      };
***************
*** 990,1000 ****
         size-=8;
         // libavformat wants to be able to read beyond the boundaries
!        if (size>buf_size/2)
!          size=buf_size/2;
! 	 
         ic->pb.buffer=u;
         LastSize=size;
         return size;
!     } else printf("read_packet u is NULL!!!\n");
      return 0;
  };
--- 1024,1042 ----
         size-=8;
         // libavformat wants to be able to read beyond the boundaries
!        if (size>buf_size)
!          size=buf_size;
!  
         ic->pb.buffer=u;
         LastSize=size;
+        BUFDEB("read_packet: got %d bytes\n",size);
         return size;
!     } else  {
!        BUFDEB("read_packet u is NULL!!!\n");
!        if (ThreadActive) {
!          //try again...
!          usleep(10000);
!          goto start;
!        };
!     };
      return 0;
  };
***************
*** 1034,1074 ****
  
    int nStreams=0;
!   AudioIdx=-1;
!   VideoIdx=-1;
    
    while(ThreadActive) {
- 
          while (freezeMode && ThreadActive)
! 	   usleep(10000);
        
          //ret = av_read_frame(ic, &pkt);
          ret = av_read_packet(ic, &pkt);
          if (ret < 0) {
! 	    usleep(10000);
              continue;
          }
! 	PacketCount++;
! 	
! 	if ( pkt.pts != (int64_t) AV_NOPTS_VALUE )
! 	  pkt.pts/=90;
! 	  //pkt.pts*=1000/AV_TIME_BASE;
! 	
! 	DecodePacket(ic,pkt);
  
!  	if (nStreams!=ic->nb_streams ){
! 	  PacketCount=0;
! 	  nStreams=ic->nb_streams;
! /*	  fprintf(stderr,"Streams: %d\n",nStreams);
! 	  for (int i=0; i <nStreams; i++ ) {
! 	    printf("Codec %d ID: %d\n",i,ic->streams[i]->codec.codec_id);
! 	    };*/
          };
  
! 	if (!(PacketCount % 100)) {
! 	  usleep(1000);
! 	};
  
! 	if (PacketCount == 200)
! 	  dump_format(ic, 0, "test", 0);
    }
    running=false;
--- 1076,1117 ----
  
    int nStreams=0;
!   AudioIdx=NO_STREAM;
!   VideoIdx=NO_STREAM;
    
    while(ThreadActive) {
          while (freezeMode && ThreadActive)
!           usleep(10000);
        
          //ret = av_read_frame(ic, &pkt);
+         BUFDEB("av_read_frame start\n");
          ret = av_read_packet(ic, &pkt);
          if (ret < 0) {
!             BUFDEB("cMpeg2Decoder Stream Error!!!!!!!!!!!!!!!!!!\n");
!             usleep(10000);
              continue;
          }
!         PacketCount++;
!         BUFDEB("got packet from av_read_frame!\n");
  
!         if ( pkt.pts != (int64_t) AV_NOPTS_VALUE )
!           pkt.pts/=9;
! 
!         QueuePacket(ic,pkt);
! 
!         if (nStreams!=ic->nb_streams ){
!           PacketCount=0;
!           nStreams=ic->nb_streams;
! /*        fprintf(stderr,"Streams: %d\n",nStreams);
!           for (int i=0; i <nStreams; i++ ) {
!             printf("Codec %d ID: %d\n",i,ic->streams[i]->codec.codec_id);
!           };*/
          };
  
!         if (!(PacketCount % 100)) {
!           usleep(1000);
!         };
  
!         if (PacketCount == 200)
!           dump_format(ic, 0, "test", 0);
    }
    running=false;
***************
*** 1076,1086 ****
  }
  
! void cMpeg2Decoder::DecodePacket(const AVFormatContext *ic, AVPacket &pkt)
  {
    // check if there are new streams
    if (AudioIdx != DONT_PLAY &&
        ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO && 
        AudioIdx != pkt.stream_index) {
!     
      AudioIdx = pkt.stream_index;
      if (aout) {
--- 1119,1140 ----
  }
  
! void cMpeg2Decoder::ClearPacketQueue()
! {
!   if (aout)
!     aout->Clear();
!   if (vout);
!     vout->Clear();
! };
! 
! void cMpeg2Decoder::QueuePacket(const AVFormatContext *ic, AVPacket &pkt)
  {
+   BUFDEB("QueuePacket AudioIdx: %d VideoIdx %d pkt.stream_index: %d\n",
+     AudioIdx,VideoIdx,pkt.stream_index);
    // check if there are new streams
    if (AudioIdx != DONT_PLAY &&
        ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO && 
        AudioIdx != pkt.stream_index) {
!    
!     BUFDEB("new Audio stream index..\n");
      AudioIdx = pkt.stream_index;
      if (aout) {
***************
*** 1096,1099 ****
--- 1150,1154 ----
        VideoIdx!=pkt.stream_index) {
    
+     BUFDEB("new Video stream index..\n");
      VideoIdx=pkt.stream_index;
      if (vout) {
***************
*** 1108,1111 ****
--- 1163,1167 ----
    // write streams 
    if ( pkt.stream_index == VideoIdx && vout ) {
+     BUFDEB("QueuePacket video stream\n");
      while ( vout->PutPacket(pkt) == -1 ) {
        //printf("Video Buffer full\n");
***************
*** 1113,1116 ****
--- 1169,1173 ----
      };
    } else if ( pkt.stream_index == AudioIdx && aout ) {
+     BUFDEB("QueuePacket audio stream\n");
      while ( aout->PutPacket(pkt) == -1 ) {
        //printf("Audio Buffer full\n");
***************
*** 1160,1174 ****
          fprintf(stderr,"Could not open video out! Sleeping again...\n");
          videoOut->Suspend();
! 	setupStore.shouldSuspend=true;
! 	IsSuspended=true;
          return;
    };
  
    if (!audioOut->Resume()) {
!    	fprintf(stderr,"Could not open audio out! Sleeping again...\n");
! 	setupStore.shouldSuspend=true;
! 	IsSuspended=true;
! 	videoOut->Suspend();
! 	return;
    };
  
--- 1217,1231 ----
          fprintf(stderr,"Could not open video out! Sleeping again...\n");
          videoOut->Suspend();
!         setupStore.shouldSuspend=true;
!         IsSuspended=true;
          return;
    };
  
    if (!audioOut->Resume()) {
!         fprintf(stderr,"Could not open audio out! Sleeping again...\n");
!         setupStore.shouldSuspend=true;
!         IsSuspended=true;
!         videoOut->Suspend();
!         return;
    };
  
***************
*** 1294,1298 ****
    //return -1;
    if (running && vout)
!     return vout->GetPTS();
    else return -1;
  };
--- 1351,1355 ----
    //return -1;
    if (running && vout)
!     return vout->GetPTS()*9;
    else return -1;
  };
***************
*** 1314,1317 ****
--- 1371,1375 ----
  int cMpeg2Decoder::Decode(const uchar *Data, int Length)
  {
+   BUFDEB("Decode %x, Length %d\n",Data,Length);
    if (running && !IsSuspended && setupStore.shouldSuspend)
       // still running and should suspend
***************
*** 1322,1327 ****
       Resume();
       
!   if (!running)
      return Length;
  
    //MPGDEB("Decode: StreamBuffer: %d plus %d\n",StreamBuffer->Available(),Length);
--- 1380,1387 ----
       Resume();
       
!   if (!running) {
!     BUFDEB("not running..\n");
      return Length;
+   };
  
    //MPGDEB("Decode: StreamBuffer: %d plus %d\n",StreamBuffer->Available(),Length);
***************
*** 1336,1340 ****
    }
    mutex.Unlock();
!    
    return Length;
  }
--- 1396,1401 ----
    }
    mutex.Unlock();
!   BUFDEB("Deocde finished\n");
!   
    return Length;
  }

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** mpeg2decoder.h	17 Mar 2005 20:15:35 -0000	1.15
--- mpeg2decoder.h	20 Mar 2005 12:21:27 -0000	1.16
***************
*** 26,40 ****
  
  class cAudioStreamDecoder; 
  
  // -----------------cClock --------------------------------------------
  class cClock {
      static cAudioStreamDecoder *audioClock;
  
  public:
!     cClock() {audioClock=NULL;};
      virtual ~cClock() {};
      static void SetAudioClock(cAudioStreamDecoder *AudioClock)
      {audioClock=AudioClock;};
!     virtual uint64_t GetPTS();
  };	
  
--- 26,46 ----
  
  class cAudioStreamDecoder; 
+ class cVideoStreamDecoder; 
  
  // -----------------cClock --------------------------------------------
  class cClock {
      static cAudioStreamDecoder *audioClock;
+     static cVideoStreamDecoder *videoClock;
  
  public:
!     cClock() {audioClock=NULL;videoClock=NULL;};
      virtual ~cClock() {};
      static void SetAudioClock(cAudioStreamDecoder *AudioClock)
      {audioClock=AudioClock;};
!     static void SetVideoClock(cVideoStreamDecoder *VideoClock)
!     {videoClock=VideoClock;};
!     uint64_t GetPTS();
!     static bool ReadyForPlay()
!     { return audioClock && videoClock; };
  };	
  
***************
*** 249,253 ****
      ~cMpeg2Decoder();
  
!     void DecodePacket(const AVFormatContext *ic,AVPacket &pkt);
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);
--- 255,260 ----
      ~cMpeg2Decoder();
  
!     void QueuePacket(const AVFormatContext *ic,AVPacket &pkt);
!     void ClearPacketQueue();
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** softdevice.c	19 Mar 2005 22:01:21 -0000	1.21
--- softdevice.c	20 Mar 2005 12:21:27 -0000	1.22
***************
*** 18,21 ****
--- 18,22 ----
  #if VDRVERSNUM >= 10307
  #include <vdr/osd.h>
+ #include <vdr/dvbspu.h>
  #else
  #include <vdr/osdbase.h>
***************
*** 224,228 ****
  {
      freezeModeEnabled = false;
! 
      fprintf(stderr,"[softdevice] Initializing Video Out\n");
      fprintf(stderr,
--- 225,231 ----
  {
      freezeModeEnabled = false;
! #if VDRVERSNUM >= 10307
!     spuDecoder = NULL;
! #endif
      fprintf(stderr,"[softdevice] Initializing Video Out\n");
      fprintf(stderr,
***************
*** 379,382 ****
--- 382,393 ----
      return 0;
  }
+ 
+ cSpuDecoder *cSoftDevice::GetSpuDecoder(void) 
+ {
+   printf("GetSpuDecoder %x\n",spuDecoder);
+   if (IsPrimaryDevice() && !spuDecoder)
+     spuDecoder = new cDvbSpuDecoder();
+   return spuDecoder;
+ };
  
  #else

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** softdevice.h	17 Mar 2005 20:15:35 -0000	1.1
--- softdevice.h	20 Mar 2005 12:21:27 -0000	1.2
***************
*** 63,68 ****
    ~cSoftDevice();
    
!   void DecodePacket(const AVFormatContext *ic, AVPacket &pkt) 
!   { if (decoder) decoder->DecodePacket(ic,pkt); };
  
    virtual bool HasDecoder(void) const;
--- 63,71 ----
    ~cSoftDevice();
    
!   void QueuePacket(const AVFormatContext *ic, AVPacket &pkt) 
!   { if (decoder) decoder->QueuePacket(ic,pkt); };
!   void ClearPacketQueue() 
!   { if (decoder) decoder->ClearPacketQueue(); };
! 
  
    virtual bool HasDecoder(void) const;
***************
*** 91,94 ****
--- 94,103 ----
  #if VDRVERSNUM >= 10307
    virtual int ProvidesCa(const cChannel *Channel) const;
+ 
+ private:
+   cSpuDecoder *spuDecoder;
+ public:
+   virtual cSpuDecoder *GetSpuDecoder(void);
+ 
    virtual void MakePrimaryDevice(bool On);
  #else



From nobody at sheep.berlios.de  Sun Mar 20 16:46:52 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 20 Mar 2005 16:46:52 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.13,1.14 CHANGELOG,1.48,1.49
Message-ID: <200503201546.j2KFkqM00892@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10790

Modified Files:
	video.c CHANGELOG 
Log Message:
Draw(): set rgb to zero (colorkey) if alpha is zero

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video.c	11 Mar 2005 15:56:22 -0000	1.13
--- video.c	20 Mar 2005 15:46:49 -0000	1.14
***************
*** 319,323 ****
  
    if (OSDdirty)
!     ClearOSD(); 
  #endif
  } 
--- 319,323 ----
  
    if (OSDdirty)
!     ClearOSD();
  #endif
  } 
***************
*** 506,510 ****
          if (a>TRANSPARENT_THRESHOLD)
            PixelMaskPtr[x/8]|=(1<<x%8);
!       };
  
        switch (depth) {
--- 506,517 ----
          if (a>TRANSPARENT_THRESHOLD)
            PixelMaskPtr[x/8]|=(1<<x%8);
!       }
! 
!       /* ---------------------------------------------------------------------
!        * pseudo spu drawing looks better if rgb values are set to colorkey
!        * so that they are full transparent in case of zero alpha value
!        */
!       if (!a)
!         r = g = b = 0;
  
        switch (depth) {
***************
*** 585,589 ****
     //printf("dirty area (%d,%d) (%d,%d) \n",x1,y1,x2,y2);
      
!     if ( OSDdirty ) 
      {
        //printf("++++++++++++++++++++++new OsdHeight+++++++ OSDdirty %d+++++\n",
--- 592,596 ----
     //printf("dirty area (%d,%d) (%d,%d) \n",x1,y1,x2,y2);
      
!     if ( OSDdirty )
      {
        //printf("++++++++++++++++++++++new OsdHeight+++++++ OSDdirty %d+++++\n",

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** CHANGELOG	20 Mar 2005 12:21:27 -0000	1.48
--- CHANGELOG	20 Mar 2005 15:46:49 -0000	1.49
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-03-20:
+     - video.c, Draw(): set rgb to zero (colorkey) if alpha is zero.
      - preperations for sync on video option
      - syncronize audio and video start



From nobody at sheep.berlios.de  Mon Mar 21 20:07:17 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 21 Mar 2005 20:07:17 +0100
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.23,1.24
Message-ID: <200503211907.j2LJ7Hi05561@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15856

Modified Files:
	mpeg2decoder.c 
Log Message:
- fix the A/V sync
- make channel switch faster again


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** mpeg2decoder.c	20 Mar 2005 12:21:27 -0000	1.23
--- mpeg2decoder.c	21 Mar 2005 19:07:15 -0000	1.24
***************
*** 154,158 ****
    AVPacket *pkt;
  
!   while ( PacketQueue.Available() < 10 && active) { 
      BUFDEB("wait while loop packets %d StreamDecoder  pid:%d type %d\n",
        PacketQueue.Available(),getpid(),context->codec_type );
--- 154,158 ----
    AVPacket *pkt;
  
!   while ( PacketQueue.Available() < 7 && active) { 
      BUFDEB("wait while loop packets %d StreamDecoder  pid:%d type %d\n",
        PacketQueue.Available(),getpid(),context->codec_type );
***************
*** 279,283 ****
  uint64_t cAudioStreamDecoder::GetPTS()
  {
!   uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset;
    if (audioBuffer && audioOutContext.channels)
       PTS-=(audioBuffer->Available()*10000 /
--- 279,283 ----
  uint64_t cAudioStreamDecoder::GetPTS()
  {
!   uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset*10;
    if (audioBuffer && audioOutContext.channels)
       PTS-=(audioBuffer->Available()*10000 /
***************
*** 1123,1127 ****
    if (aout)
      aout->Clear();
!   if (vout);
      vout->Clear();
  };
--- 1123,1127 ----
    if (aout)
      aout->Clear();
!   if (vout)
      vout->Clear();
  };



From nobody at sheep.berlios.de  Fri Mar 25 14:42:33 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 25 Mar 2005 14:42:33 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.49,1.50 softdevice.h,1.2,1.3 softdevice.c,1.22,1.23 mpeg2decoder.h,1.16,1.17 mpeg2decoder.c,1.24,1.25
Message-ID: <200503251342.j2PDgXh04803@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24447

Modified Files:
	CHANGELOG softdevice.h softdevice.c mpeg2decoder.h 
	mpeg2decoder.c 
Log Message:
- respect play mode
- disable WaitForSync in video only mode
- removed unused code



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** CHANGELOG	20 Mar 2005 15:46:49 -0000	1.49
--- CHANGELOG	25 Mar 2005 13:42:30 -0000	1.50
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2005-03-25:
+     - respect replay mode
+     - disable WaitForSync in video only mode (trickspeed mode)
+     - removed unused code
  2005-03-20:
      - video.c, Draw(): set rgb to zero (colorkey) if alpha is zero.

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** softdevice.h	20 Mar 2005 12:21:27 -0000	1.2
--- softdevice.h	25 Mar 2005 13:42:30 -0000	1.3
***************
*** 55,62 ****
    int       outMethod;
  
-   bool      freezeModeEnabled;
-   cMutex    playMutex;
-   cCondVar  readyForPlayCondVar;
- 
  public:
    cSoftDevice(int method, int audioMethod, char *pluginPath);
--- 55,58 ----

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** softdevice.c	20 Mar 2005 12:21:27 -0000	1.22
--- softdevice.c	25 Mar 2005 13:42:30 -0000	1.23
***************
*** 191,196 ****
  cSoftOsd::~cSoftOsd() {
      if (videoOut) {
! 	videoOut->CloseOSD();
! 	videoOut=0;
      }
      fprintf(stderr,"[softdevice] OSD is off now\n");
--- 191,196 ----
  cSoftOsd::~cSoftOsd() {
      if (videoOut) {
!       videoOut->CloseOSD();
!       videoOut=0;
      }
      fprintf(stderr,"[softdevice] OSD is off now\n");
***************
*** 224,228 ****
  cSoftDevice::cSoftDevice(int method,int audioMethod, char *pluginPath)
  {
-     freezeModeEnabled = false;
  #if VDRVERSNUM >= 10307
      spuDecoder = NULL;
--- 224,227 ----
***************
*** 420,435 ****
        // FIXME - Implement audio or video only Playmode (is this really needed?)
        case pmAudioVideo:
            decoder->Start();
!           playMutex.Lock();
!           freezeModeEnabled = false;
!           playMutex.Unlock();
! 	    break;
! 	default:
! 	    printf("playmode not implemented... %d\n",PlayMode);
! 	    decoder->Stop();
! 	    break;
! 
      }
- //    printf("setting Playmode not implemented yet... %d\n",PlayMode);
      return true;
  }
--- 419,442 ----
        // FIXME - Implement audio or video only Playmode (is this really needed?)
        case pmAudioVideo:
+           decoder->SetPlayMode(cMpeg2Decoder::PmAudioVideo);
            decoder->Start();
!           break;
!       case pmAudioOnly:
!       case pmAudioOnlyBlack:
!           decoder->SetPlayMode(cMpeg2Decoder::PmAudioOnly);
!           decoder->Start();
!           break;
!       case pmVideoOnly:
!           decoder->SetPlayMode(cMpeg2Decoder::PmVideoOnly);
!           decoder->Start();
!           break;
!       case pmNone:
!           decoder->Stop();
!           break;
!       default:
!           printf("playmode not implemented... %d\n",PlayMode);
!           decoder->Stop();
!           break;
      }
      return true;
  }
***************
*** 452,459 ****
      decoder->TrickSpeed(1);
      decoder->Play();
-     playMutex.Lock();
-     freezeModeEnabled = false;
-     playMutex.Unlock();
-     readyForPlayCondVar.Broadcast();
  }
  
--- 459,462 ----
***************
*** 463,469 ****
      cDevice::Freeze();
      decoder->Freeze();
-     playMutex.Lock();
-     freezeModeEnabled = true;
-     playMutex.Unlock();
  }
  
--- 466,469 ----
***************
*** 477,481 ****
  {
    //fprintf (stderr, "[softdevice] should set volume to %d\n", Volume);
!   audioOut->SetVolume(Volume);
  }
  
--- 477,481 ----
  {
    //fprintf (stderr, "[softdevice] should set volume to %d\n", Volume);
!   //audioOut->SetVolume(Volume);
  }
  
***************
*** 489,496 ****
  {
    // fprintf(stderr,"[softdevice] Poll TimeoutMs: %d ....\n",TimeoutMs);
-   playMutex.Lock();
-   if (freezeModeEnabled)
-     readyForPlayCondVar.TimedWait(playMutex,TimeoutMs);
-   playMutex.Unlock();
  
    if ( decoder->BufferFill() > 90 ) {
--- 489,492 ----
***************
*** 577,589 ****
  int cSoftDevice::PlayVideo(const uchar *Data, int Length)
  {
-     bool freezeMode;
- 
-     playMutex.Lock();
-     freezeMode = freezeModeEnabled;
-     playMutex.Unlock();
- 
-     if (freezeMode)
-       return 0;
- 
      int result=decoder->Decode(Data, Length);
      // restart the decoder
--- 573,576 ----

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** mpeg2decoder.h	20 Mar 2005 12:21:27 -0000	1.16
--- mpeg2decoder.h	25 Mar 2005 13:42:30 -0000	1.17
***************
*** 33,46 ****
      static cVideoStreamDecoder *videoClock;
  
  public:
      cClock() {audioClock=NULL;videoClock=NULL;};
      virtual ~cClock() {};
      static void SetAudioClock(cAudioStreamDecoder *AudioClock)
      {audioClock=AudioClock;};
      static void SetVideoClock(cVideoStreamDecoder *VideoClock)
      {videoClock=VideoClock;};
      uint64_t GetPTS();
      static bool ReadyForPlay()
!     { return audioClock && videoClock; };
  };	
  
--- 33,54 ----
      static cVideoStreamDecoder *videoClock;
  
+     static bool waitForSync;
  public:
      cClock() {audioClock=NULL;videoClock=NULL;};
      virtual ~cClock() {};
+     
      static void SetAudioClock(cAudioStreamDecoder *AudioClock)
      {audioClock=AudioClock;};
+     
      static void SetVideoClock(cVideoStreamDecoder *VideoClock)
      {videoClock=VideoClock;};
+     
      uint64_t GetPTS();
+     
      static bool ReadyForPlay()
!     { return (waitForSync ? (audioClock && videoClock) : 1 ); };
! 
!     void SetWaitForSync(bool WaitForSync)
!     { waitForSync=WaitForSync; };
  };	
  
***************
*** 133,137 ****
      virtual void Stop();
      virtual void TrickSpeed(int Speed) {return;};
-     virtual int StillPicture(uchar *Data, int Length) {return 0;};
      virtual int BufferFill(void);
      bool    initCodec(void);
--- 141,144 ----
***************
*** 197,204 ****
      int                offset;
      int                delay;
-     int                timePassed;
      int                rtc_fd; 
      int                frametime;
-     int32_t GetRelTime();
     
      uchar   *allocatePicBuf(uchar *pic_buf);
--- 204,209 ----
***************
*** 216,220 ****
  
      virtual int DecodePacket(AVPacket *pkt);
-     virtual int StillPicture(uchar *Data, int Length);
      virtual void TrickSpeed(int Speed);
      virtual uint64_t GetPTS();
--- 221,224 ----
***************
*** 247,250 ****
--- 251,264 ----
  
      int audioMode;
+ 
+ public:
+     enum softPlayMode {
+       PmNoChange=-1,
+       PmAudioVideo,
+       PmVideoOnly,
+       PmAudioOnly,
+     };
+ private:
+     softPlayMode curPlayMode;
  public:
      int read_packet(uint8_t *buf, int buf_size);
***************
*** 267,272 ****
      void Resume(void);
      void TrickSpeed(int Speed);
!     
!     void PlayAudioVideo(bool playVideo,bool playAudio)
      { AudioIdx=playAudio?NO_STREAM:DONT_PLAY;
        VideoIdx=playVideo?NO_STREAM:DONT_PLAY;}
--- 281,287 ----
      void Resume(void);
      void TrickSpeed(int Speed);
!    
!     void SetPlayMode(softPlayMode playMode);
!     void PlayAudioVideo(bool playAudio,bool playVideo)
      { AudioIdx=playAudio?NO_STREAM:DONT_PLAY;
        VideoIdx=playVideo?NO_STREAM:DONT_PLAY;}

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** mpeg2decoder.c	21 Mar 2005 19:07:15 -0000	1.24
--- mpeg2decoder.c	25 Mar 2005 13:42:30 -0000	1.25
***************
*** 86,89 ****
--- 86,90 ----
  cAudioStreamDecoder *cClock::audioClock=NULL;
  cVideoStreamDecoder *cClock::videoClock=NULL;
+ bool                 cClock::waitForSync=false;
  
  uint64_t  cClock::GetPTS() {
***************
*** 432,447 ****
  }
  
- int cVideoStreamDecoder::StillPicture(uchar *Data, int Length)
- {
-   mutex.Lock();
-   //ringBuffer->Clear();
-   avcodec_flush_buffers(context);
-   mutex.Unlock();
-   //for (int i = 0;i < 4;++i)
-    //(Data,Length,0x000001E0,0x000001EF);
- 
-   return Length;
- }
- 
  uint64_t cVideoStreamDecoder::GetPTS() {
    return pts - (delay + Timer.TimePassed())/100;
--- 433,436 ----
***************
*** 1076,1081 ****
  
    int nStreams=0;
-   AudioIdx=NO_STREAM;
-   VideoIdx=NO_STREAM;
    
    while(ThreadActive) {
--- 1065,1068 ----
***************
*** 1136,1140 ****
        AudioIdx != pkt.stream_index) {
     
!     BUFDEB("new Audio stream index..\n");
      AudioIdx = pkt.stream_index;
      if (aout) {
--- 1123,1128 ----
        AudioIdx != pkt.stream_index) {
     
!     CMDDEB("new Audio stream index.. old %d new %d\n",
!       AudioIdx,pkt.stream_index);
      AudioIdx = pkt.stream_index;
      if (aout) {
***************
*** 1150,1154 ****
        VideoIdx!=pkt.stream_index) {
    
!     BUFDEB("new Video stream index..\n");
      VideoIdx=pkt.stream_index;
      if (vout) {
--- 1138,1143 ----
        VideoIdx!=pkt.stream_index) {
    
!     CMDDEB("new Video stream index.. old %d new %d\n",
!       VideoIdx,pkt.stream_index);
      VideoIdx=pkt.stream_index;
      if (vout) {
***************
*** 1193,1198 ****
--- 1182,1190 ----
    StreamBuffer->Clear();
    initStream();
+   clock.SetWaitForSync(curPlayMode==PmAudioVideo);
    ThreadActive=true;
    freezeMode=false;
+   AudioIdx=NO_STREAM;
+   VideoIdx=NO_STREAM;
    cThread::Start();
    running=true;
***************
*** 1247,1250 ****
--- 1239,1264 ----
  };
  
+ void cMpeg2Decoder::SetPlayMode(softPlayMode playMode)
+ {
+   curPlayMode=playMode;
+   clock.SetWaitForSync(curPlayMode==PmAudioVideo);
+   switch (curPlayMode) {
+     case PmAudioVideo: 
+       CMDDEB("SetPlayMode PmAudioVideo\n");
+       PlayAudioVideo(true,true);
+       break;
+     case PmVideoOnly:
+       CMDDEB("SetPlayMode PmVideoOnly\n");
+       PlayAudioVideo(false,true);
+       break;
+     case PmAudioOnly:
+       CMDDEB("SetPlayMode PmAudioOnly\n");
+       PlayAudioVideo(true,false);
+       break;
+     default:
+       break;
+   };
+ };
+       
  void cMpeg2Decoder::Freeze(void)
  {
***************
*** 1269,1274 ****
    CMDDEB("Stop\n");
    // can't stop properly in freeze mode
! //  Freeze();
    freezeMode=false;
    if (running)
    {
--- 1283,1289 ----
    CMDDEB("Stop\n");
    // can't stop properly in freeze mode
!   //  Freeze();
    freezeMode=false;
+   clock.SetWaitForSync(false);
    if (running)
    {
***************
*** 1304,1308 ****
    mutex.Lock();
    CMDDEB("StillPicture \n");
!  
    for (int i=0; 4>i;i++) {
      int P;
--- 1319,1326 ----
    mutex.Lock();
    CMDDEB("StillPicture \n");
!   // we have only video, so no syncing should be done
!   clock.SetWaitForSync(false); 
!   // XXX hack to ingore audio junk sent by vdr in the still picture
!   AudioIdx=DONT_PLAY;
    for (int i=0; 4>i;i++) {
      int P;
***************
*** 1337,1340 ****
--- 1355,1362 ----
  {
    CMDDEB("TrickSpeed %d\n",Speed);
+   if ( Speed!=1 )
+     clock.SetWaitForSync(false);
+   else clock.SetWaitForSync(curPlayMode==PmAudioVideo);
+ 
    if (running)
    {
***************
*** 1349,1356 ****
   */
  int64_t cMpeg2Decoder::GetSTC(void) {
!   //return -1;
!   if (running && vout)
!     return vout->GetPTS()*9;
!   else return -1;
  };
  
--- 1371,1381 ----
   */
  int64_t cMpeg2Decoder::GetSTC(void) {
!   if (running) {
!     if (vout)
!       return vout->GetPTS()*9;
!     if (aout)
!       return aout->GetPTS()*9;
!   }
!   return -1;
  };
  



From nobody at sheep.berlios.de  Mon Mar 28 10:02:25 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 28 Mar 2005 10:02:25 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.50,1.51 video-dfb.c,1.19,1.20 video-dfb.h,1.5,1.6
Message-ID: <200503280802.j2S82PL16503@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22930

Modified Files:
	CHANGELOG video-dfb.c video-dfb.h 
Log Message:
- dfb-out: chg. OSD drawing to update only modified areas.
           chg. videolayer to double buffered.
           report surface capabilities in a single line.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** CHANGELOG	25 Mar 2005 13:42:30 -0000	1.50
--- CHANGELOG	28 Mar 2005 08:02:22 -0000	1.51
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2005-03-28:
+     - dfb-out: chg. OSD drawing to update only modified areas.
+                chg. videolayer to double buffered.
+                report surface capabilities in a single line
  2005-03-25:
      - respect replay mode

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** video-dfb.c	27 Feb 2005 08:52:33 -0000	1.19
--- video-dfb.c	28 Mar 2005 08:02:22 -0000	1.20
***************
*** 205,220 ****
  
    scaps = surf->GetCapabilities();
!   fprintf(stderr,"%s:\n", name);
  
!   if (scaps & DSCAPS_NONE) fprintf(stderr," - none\n");
!   if (scaps & DSCAPS_PRIMARY) fprintf(stderr," - primary\n");
!   if (scaps & DSCAPS_SYSTEMONLY) fprintf(stderr," - systemonly\n");
!   if (scaps & DSCAPS_VIDEOONLY) fprintf(stderr," - videoonly\n");
!   if (scaps & DSCAPS_FLIPPING) fprintf(stderr," - flipping\n");
!   if (scaps & DSCAPS_SUBSURFACE) fprintf(stderr," - subsurface\n");
!   if (scaps & DSCAPS_INTERLACED) fprintf(stderr," - interlaced\n");
!   if (scaps & DSCAPS_SEPARATED) fprintf(stderr," - separated\n");
!   if (scaps & DSCAPS_STATIC_ALLOC) fprintf(stderr," - static alloc\n");
!   if (scaps & DSCAPS_TRIPLE) fprintf(stderr," - triple buffered\n");
  }
  
--- 205,222 ----
  
    scaps = surf->GetCapabilities();
!   fprintf(stderr,"[surface capabilities] %s: ", name);
  
!   if (scaps == DSCAPS_NONE) fprintf(stderr,"none ");
!   if (scaps & DSCAPS_PRIMARY) fprintf(stderr,"primary ");
!   if (scaps & DSCAPS_SYSTEMONLY) fprintf(stderr,"systemonly ");
!   if (scaps & DSCAPS_VIDEOONLY) fprintf(stderr,"videoonly ");
!   if (scaps & DSCAPS_DOUBLE) fprintf(stderr,"double-buffered ");
!   if (scaps & DSCAPS_FLIPPING) fprintf(stderr,"flipping ");
!   if (scaps & DSCAPS_SUBSURFACE) fprintf(stderr,"subsurface ");
!   if (scaps & DSCAPS_INTERLACED) fprintf(stderr,"interlaced ");
!   if (scaps & DSCAPS_SEPARATED) fprintf(stderr,"separated ");
!   if (scaps & DSCAPS_STATIC_ALLOC) fprintf(stderr,"static-alloc ");
!   if (scaps & DSCAPS_TRIPLE) fprintf(stderr,"triple-buffered ");
!   fprintf(stderr,"\n");
  }
  
***************
*** 351,354 ****
--- 353,358 ----
    }
  
+   reportSurfaceCapabilities ("scrSurface", scrSurface);
+ 
    if (!videoLayer)
    {
***************
*** 384,391 ****
      Bpp = DFB_BITS_PER_PIXEL(fmt);
  
!     if (Xres > 768)
!       Xres = 768;
!     if (Yres > 576)
!       Yres = 576;
  
      /* ------------------------------------------------------------------------
--- 388,395 ----
      Bpp = DFB_BITS_PER_PIXEL(fmt);
  
!     if (Xres > OSD_FULL_WIDTH)
!       Xres = OSD_FULL_WIDTH;
!     if (Yres > OSD_FULL_HEIGHT)
!       Yres = OSD_FULL_HEIGHT;
  
      /* ------------------------------------------------------------------------
***************
*** 430,434 ****
              desc.name, osdSurface->GetWidth(), osdSurface->GetHeight());
  
!     reportSurfaceCapabilities ("osdSurface:", osdSurface);
  
      vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 434,438 ----
              desc.name, osdSurface->GetWidth(), osdSurface->GetHeight());
  
!     reportSurfaceCapabilities ("osdSurface", osdSurface);
  
      vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
***************
*** 444,459 ****
      {
        videoSurface = dfb->CreateSurface (vidDsc);
!       videoSurface->Clear(0,0,0,0); //clear and
      }
      else
      {
        videoSurface=videoLayer->GetSurface();
!       videoSurface->Clear(COLORKEY,0); //clear and
        videoSurface->Flip(); // Flip the field
!       videoSurface->Clear(COLORKEY,0); //clear and
        videoSurface->Flip(); // Flip the field
      }
  
!     reportSurfaceCapabilities ("videoSurface:", videoSurface);
  
      if (!setupStore->useMGAtv)
--- 448,463 ----
      {
        videoSurface = dfb->CreateSurface (vidDsc);
!       videoSurface->Clear(0,0,0,clearAlpha); //clear and
      }
      else
      {
        videoSurface=videoLayer->GetSurface();
!       videoSurface->Clear(COLORKEY,clearAlpha); //clear and
        videoSurface->Flip(); // Flip the field
!       videoSurface->Clear(COLORKEY,clearAlpha); //clear and
        videoSurface->Flip(); // Flip the field
      }
  
!     reportSurfaceCapabilities ("videoSurface", videoSurface);
  
      if (!setupStore->useMGAtv)
***************
*** 536,539 ****
--- 540,544 ----
      DFBDisplayLayerConfig       dlc;
      DFBDisplayLayerDescription  desc;
+     DFBDisplayLayerConfigFlags  failed;
  
    if (videoLayer || useStretchBlit)
***************
*** 585,591 ****
        }
  #endif
!       dlc.flags = (DFBDisplayLayerConfigFlags)((int) dlc.flags | DLCONF_OPTIONS);
  
!       dlc.options = DLOP_FIELD_PARITY;
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 590,602 ----
        }
  #endif
!       dlc.flags = (DFBDisplayLayerConfigFlags)((int) dlc.flags |
!                                                       DLCONF_OPTIONS);
!       dlc.options       = DLOP_FIELD_PARITY;
  
! #if 1
!       dlc.flags = (DFBDisplayLayerConfigFlags)
!                       ((int) dlc.flags | DLCONF_SURFACE_CAPS);
!       dlc.surface_caps  = DSCAPS_DOUBLE;
! #endif
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
***************
*** 653,660 ****
          catch (DFBException *ex)
          {
!           fprintf (stderr,"Caught: action=%s, result=%s\n",
                     ex->GetAction(), ex->GetResult());
          }
  
          /* --------------------------------------------------------------------
           * OK, try to set the video layer configuration
--- 664,695 ----
          catch (DFBException *ex)
          {
!           fprintf (stderr,"Caught: action=%s, result=%s Failed: SetLevel()\n",
                     ex->GetAction(), ex->GetResult());
          }
  
+         /*
+          * --------------------------------------------------------------------
+          * Try with tripple or double buffering
+          */
+         dlc.flags = (DFBDisplayLayerConfigFlags)
+                       ((int) dlc.flags | DLCONF_BUFFERMODE);
+ 
+         //dlc.buffermode = DLBM_TRIPLE;
+ 
+         //videoLayer->TestConfiguration(dlc, &failed);
+         //if (failed & DLCONF_BUFFERMODE)
+         //{
+         //  fprintf(stderr, "[dfb]: SetParms (): failed to set buffermode "
+         //          "to tripple mode, trying back video\n");
+           dlc.buffermode = DLBM_BACKVIDEO;
+           videoLayer->TestConfiguration(dlc, &failed);
+           if (failed & DLCONF_BUFFERMODE)
+           {
+             fprintf(stderr, "[dfb]: SetParms (): failed to set buffermode "
+                     "to back video, reverting to normal\n");
+             dlc.buffermode = DLBM_FRONTONLY;
+           }
+         //}
+ 
          /* --------------------------------------------------------------------
           * OK, try to set the video layer configuration
***************
*** 725,728 ****
--- 760,764 ----
          videoSurface=dfb->CreateSurface(vidDsc);
        }
+       reportSurfaceCapabilities ("videoSurface", videoSurface);
  
        fprintf(stderr,"[dfb] (re)configured 0x%08x\n",pixelformat);
***************
*** 744,760 ****
  #if VDRVERSNUM >= 10307
  
! /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::OSDStart()
  {
      IDirectFBSurface  *tmpSurface;
  
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
! 
!   /* --------------------------------------------------------------------------
!    * ?? if that clear is removed, radeon OSD does not flicker
!    * any more. but it has some other negative effects on mga.
!    * ??
!    */
    tmpSurface->Clear(0,0,0,clearAlpha);
  }
--- 780,793 ----
  #if VDRVERSNUM >= 10307
  
! /* ----------------------------------------------------------------------------
   */
! void cDFBVideoOut::OpenOSD (int x, int y)
  {
      IDirectFBSurface  *tmpSurface;
  
+   cVideoOut::OpenOSD(x, y);
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
!   tmpSurface->Clear(0,0,0,clearAlpha);
!   tmpSurface->Flip();
    tmpSurface->Clear(0,0,0,clearAlpha);
  }
***************
*** 762,771 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::OSDCommit()
  {
      IDirectFBSurface  *tmpSurface;
  
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
!   tmpSurface->Flip();
  }
  
--- 795,812 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::OSDStart()
  {
      IDirectFBSurface  *tmpSurface;
  
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
!   tmpSurface->SetBlittingFlags(DSBLIT_NOFX);
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void cDFBVideoOut::OSDCommit()
! {
!   OSDdirty=false;
!   OSDpresent = true;
  }
  
***************
*** 774,812 ****
  void cDFBVideoOut::Refresh(cBitmap *Bitmap)
  {
!     int pitch;
!     uint8_t *dst;
      IDirectFBSurface  *tmpSurface;
  
!   // don't update only dirty areas
!   OSDdirty=true;
! 
!   tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
! 
!   tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
! #if 0
    {
      /* ------------------------------------------------------------------------
!      * handling of dirty/modified regions only, does not work for now
!      * due to double buffering :-( .
       */
!       int dx1 = 0, dx2 = 0, dy1 = 0, dy2 = 0;
  
!     if (Bitmap->Dirty(dx1,dy1,dx2,dy2))
!     {
!       Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
!       Bitmap->Clean();
!     }
!   }
! #else
!   Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
! #endif
!   tmpSurface->Unlock();
  
!   if (useStretchBlit)
!   {
!     OSDpresent = true;
!     //tmpSurface->Flip();
    }
-     OSDpresent = true;
  }
  
--- 815,850 ----
  void cDFBVideoOut::Refresh(cBitmap *Bitmap)
  {
!     int               pitch;
!     uint8_t           *dst;
      IDirectFBSurface  *tmpSurface;
+     DFBRegion         modArea;
+     DFBRectangle      osdsrc;
  
!   if (Bitmap->Dirty(modArea.x1,modArea.y1,modArea.x2,modArea.y2))
    {
+     tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
+     tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
+     Draw(Bitmap,dst,pitch,(isVIAUnichrome) ? true:false);
+     tmpSurface->Unlock();
+ 
      /* ------------------------------------------------------------------------
!      * TODO: Have to get area coordinates in screen dimensions from Draw().
!      *       In case Draw() scales down, bitmap dirty area coordinates
!      *       could not be transformed the following way.
       */
!     modArea.x1 += OSDxOfs;
!     modArea.y1 += OSDyOfs;
!     modArea.x2 += OSDxOfs;
!     modArea.y2 += OSDyOfs;
  
!     tmpSurface->Flip(&modArea,DSFLIP_WAIT);
!     osdsrc.x = modArea.x1;
!     osdsrc.y = modArea.y1;
!     osdsrc.w = modArea.x2 - modArea.x1 + 1;
!     osdsrc.h = modArea.y2 - modArea.y1 + 1;
!     tmpSurface->Blit(tmpSurface, &osdsrc, modArea.x1, modArea.y1);
  
!     Bitmap->Clean();
    }
  }
  
***************
*** 852,857 ****
      OSDpresent  = false;
      osdClrBack = true;
-     tmpSurface->Clear(COLORKEY,0); //clear and
      osdMutex.Unlock();
    }
    else
--- 890,895 ----
      OSDpresent  = false;
      osdClrBack = true;
      osdMutex.Unlock();
+     tmpSurface->Clear(COLORKEY,0); //clear and
    }
    else
***************
*** 1034,1037 ****
--- 1072,1076 ----
      {
          DFBRectangle  src, dst;
+         int     clearBackground;
  
        src.x = sxoff;
***************
*** 1047,1051 ****
  
        osdMutex.Lock();
!       if (aspect_changed || osdClrBack)
          scrSurface->Clear(0,0,0,0);
  
--- 1086,1094 ----
  
        osdMutex.Lock();
!       clearBackground = (aspect_changed || osdClrBack) ? 1: 0;
!       osdClrBack = false;
!       osdMutex.Unlock();
! 
!       if (clearBackground)
          scrSurface->Clear(0,0,0,0);
  
***************
*** 1072,1086 ****
  
        }
!       scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
  
!       if (aspect_changed || osdClrBack)
          scrSurface->Clear(0,0,0,0);
- 
-       osdClrBack = false;
-       osdMutex.Unlock();
      }
      else
      {
!       videoSurface->Flip();
      }
    } catch (DFBException *ex){
--- 1115,1128 ----
  
        }
!       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
!       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
  
!       if (clearBackground)
          scrSurface->Clear(0,0,0,0);
      }
      else
      {
!       //videoSurface->Flip();
!       videoSurface->Flip(NULL, DSFLIP_ONSYNC);
      }
    } catch (DFBException *ex){

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-dfb.h	24 Feb 2005 22:35:51 -0000	1.5
--- video-dfb.h	28 Mar 2005 08:02:22 -0000	1.6
***************
*** 48,51 ****
--- 48,52 ----
      void ProcessEvents ();
      void ShowOSD ();
+     virtual void OpenOSD(int x, int y);
  
  #if VDRVERSNUM >= 10307



