From nobody at sheep.berlios.de  Sat Jan  7 14:20:37 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 7 Jan 2006 14:20:37 +0100
Subject: [Softdevice-cvs] softdevice audio.c,1.22,1.23 CHANGELOG,1.132,1.133
Message-ID: <200601071320.k07DKbH16134@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31192

Modified Files:
	audio.c CHANGELOG 
Log Message:
- on resume try to open audio-out in non-blocking mode



Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** audio.c	6 Oct 2005 21:28:11 -0000	1.22
--- audio.c	7 Jan 2006 13:20:24 -0000	1.23
***************
*** 80,85 ****
     int err;
     printf("Device %s\n",device);
!    if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
!      esyslog("[softdevice-audio] Playback open error: %s, %s FATAL",
               device, snd_strerror(err));
       return false;
--- 80,85 ----
     int err;
     printf("Device %s\n",device);
!    if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK,SND_PCM_NONBLOCK )) < 0) {
!      esyslog("[softdevice-audio] Playback open error: %s, %s ",
               device, snd_strerror(err));
       return false;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.132
retrieving revision 1.133
diff -C2 -d -r1.132 -r1.133
*** CHANGELOG	15 Dec 2005 20:12:38 -0000	1.132
--- CHANGELOG	7 Jan 2006 13:20:24 -0000	1.133
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-01-07:
+     - on resume try to open audio-out in non-blocking mode
  2005-12-15:
      - use fast_memcpy in dfb out



From nobody at sheep.berlios.de  Sat Jan  7 14:26:46 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 7 Jan 2006 14:26:46 +0100
Subject: [Softdevice-cvs] softdevice utils.c,1.9,1.10 CHANGELOG,1.133,1.134
Message-ID: <200601071326.k07DQkH16405@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1511

Modified Files:
	utils.c CHANGELOG 
Log Message:
- add sfence and emms to yv12_to_yuv2()



Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** utils.c	30 Nov 2005 18:26:33 -0000	1.9
--- utils.c	7 Jan 2006 13:26:43 -0000	1.10
***************
*** 98,101 ****
--- 98,104 ----
      dst += dstStride;
    }
+   __asm__ __volatile__ ("sfence \n"
+ 		        "emms \n" : : : "memory");
+ 
  #endif
  }

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.133
retrieving revision 1.134
diff -C2 -d -r1.133 -r1.134
*** CHANGELOG	7 Jan 2006 13:20:24 -0000	1.133
--- CHANGELOG	7 Jan 2006 13:26:43 -0000	1.134
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-01-07:
+     - add sfence and emms to yv12_to_yuy2()
      - on resume try to open audio-out in non-blocking mode
  2005-12-15:



From nobody at sheep.berlios.de  Sat Jan  7 15:29:37 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 7 Jan 2006 15:29:37 +0100
Subject: [Softdevice-cvs] softdevice SoftOsd.c,NONE,1.1 SoftOsd.h,NONE,1.1
Message-ID: <200601071429.k07ETbH19594@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21453

Added Files:
	SoftOsd.c SoftOsd.h 
Log Message:
- completely rewritten OSD. Supports up- and down-scaleing in MMX



--- NEW FILE: SoftOsd.c ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: SoftOsd.c,v 1.1 2006/01/07 14:29:35 wachm Exp $
 */
#include <assert.h>
#include "SoftOsd.h"
#include "utils.h"
#if VDRVERSNUM >= 10307 // only for the new osd interface...

//#define OSDDEB(out...) {printf("soft_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}

#ifndef OSDDEB
#define OSDDEB(out...) 
[...1213 lines suppressed...]
				" pshufw $0b0,%%mm3,%%mm3 \n"
				" pmullw %%mm3, %%mm0 \n"
				" psraw $"SHIFT_BITS",%%mm0 \n"
				" paddsw %%mm1, %%mm0 \n"
				" packuswb %%mm0,%%mm0 \n"
				" movd %%mm0,(%1) \n"
				: : "r" (pos),
				"r" (&dest[ypos*linesize+currPixel*4]) );
#endif
                       
                        pos +=new_pixel_height;
                        ypos+=1;
                };
		currPixel++;
        };
	EMMS;
};
      
#endif   // VDRVERSNUM >= 10307
                        

--- NEW FILE: SoftOsd.h ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: SoftOsd.h,v 1.1 2006/01/07 14:29:35 wachm Exp $
 */

#ifndef __SOFTOSD_H__
#define __SOFTOSD_H__

// osd some constants and macros
#define OPACITY_THRESHOLD 0x9FLL
#define TRANSPARENT_THRESHOLD 0x1FLL
#define COLOR_KEY 0x00000000LL

#define OSD_WIDTH   720
#define OSD_HEIGHT  576

#define IS_BACKGROUND(a) (((a) < OPACITY_THRESHOLD) && ((a) > TRANSPARENT_THRESHOLD))
#define IS_TRANSPARENT(a) ((a) < TRANSPARENT_THRESHOLD)
#define IS_OPAQUE(a) ((a) > OPACITY_THRESHOLD)

#include "vdr/config.h"

#if VDRVERSNUM >= 10307 // only for the new osd interface...

#include "vdr/osd.h"
#include "vdr/thread.h"
#include "video.h"

#define X_OFFSET 0 
#define Y_OFFSET 0

#define OSD_STRIDE (736)

#define COLOR_RGB16(r,g,b) (((b >> 3)& 0x1F) | ((g & 0xF8) << 2)| ((r & 0xF8)<<10) )


struct color {
    unsigned char b;
    unsigned char g;
    unsigned char r;
    unsigned char a;
};

class cVideoOut;

/* ---------------------------------------------------------------------------
 */
class cSoftOsd : public cOsd {
private:
    cVideoOut *videoOut;
protected:
    int xOfs,yOfs;
    uint32_t *OSD_Bitmap;
    bool dirty_lines[OSD_STRIDE];
    cMutex dirty_Mutex;
    
    void (*OutputConvert)(uint8_t * dest, color * pixmap, int Pixel);
    uint8_t *pixelMask;
    enum PixFormat {
	    PF_None,
	    PF_ARGB32,
	    PF_inverseAlpha_ARGB32,
	    PF_pseudoAlpha_ARGB32,
	    PF_AYUV
    };
    PixFormat bitmap_Format;

    void ConvertPalette(tColor *dest_palette, const tColor *orig_palette, 
		    int maxColors);
    
public:
    cSoftOsd(cVideoOut *VideoOut, int XOfs, int XOfs);
    virtual ~cSoftOsd();

    bool SetMode(int Depth, bool HasAlpha, bool AlphaInversed, 
                 bool IsYUV, uint8_t *PixelMask=NULL);
    
    bool FlushBitmaps(bool OnlyDirty);
    bool DrawConvertBitmap(cBitmap *Bitmap, bool OnlyDirty);
    virtual void Flush(void);
    
    void Clear();
    
    static void ARGB_to_AYUV(uint8_t * dest, color * pixmap, int Pixel);
    static void ARGB_to_ARGB32(uint8_t * dest, color * pixmap, int Pixel);
    static void ARGB_to_RGB32(uint8_t * dest, color * pixmap, int Pixel);
    static void ARGB_to_RGB24(uint8_t * dest, color * pixmap, int Pixel);
    static void ARGB_to_RGB16(uint8_t * dest, color * pixmap, int Pixel);
    static void ARGB_to_RGB16_PixelMask(uint8_t * dest, color * pixmap, 
                    int Pixel);

    void CreatePixelMask(uint8_t * dest, color * pixmap, int Pixel);


    static void AYUV_to_AYUV420P(uint8_t *PY1,uint8_t *PY2,
		    uint8_t *PU, uint8_t *PV,
		    uint8_t *PAlphaY1, uint8_t *PAlphaY2, uint8_t *PAlphaUV,
		    color * pixmap1, color *pixmap2, int Pixel);

    // YUV planar modes
    void CopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
                    int Ystride, int UVstride,
                    int dest_Width, int dest_Height, bool RefreshAll=false);

    // ARGB packed modes
    void CopyToBitmap(uint8_t * dest, int linesize,
                    int dest_Width, int dest_Height, bool RefreshAll=false,
                    bool *dirtyLines=NULL);
    void ScaleVUpCopyToBitmap(uint8_t * dest, int linesize,
                    int dest_Width, int dest_Height, bool RefreshAll=false,
                    bool *dirtyLines=NULL);
    void ScaleVDownCopyToBitmap(uint8_t * dest, int linesize,
                    int dest_Width, int dest_Height, bool RefreshAll=false,
                    bool *dirtyLines=NULL);


    
 private:
    void ScaleUpHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
    void ScaleDownHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
    void ScaleDownVert_MMX(uint8_t * dest, int linesize, int32_t new_pixel_height, 
                int start_pos,
                color ** pixmap, int Pixel);
    void ScaleUpVert_MMX(uint8_t *dest, int linesize, int32_t new_pixel_height, 
                int start_pos,
                color **pixmap, int Pixel);

 public:
	    
};

#endif //VDRVERSUM >= 10307
#endif



From nobody at sheep.berlios.de  Sat Jan  7 15:30:13 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 7 Jan 2006 15:30:13 +0100
Subject: [Softdevice-cvs] softdevice softdevice.c,1.49,1.50
Message-ID: <200601071430.k07EUDH19690@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21605

Modified Files:
	softdevice.c 
Log Message:
- completely rewritten OSD. Supports up- and down-scaleing in MMX



Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** softdevice.c	12 Nov 2005 15:50:41 -0000	1.49
--- softdevice.c	7 Jan 2006 14:30:11 -0000	1.50
***************
*** 90,151 ****
  #if VDRVERSNUM >= 10307
  
! // --- cSoftOsd -----------------------------------------------
! 
! /* ---------------------------------------------------------------------------
!  */
! class cSoftOsd : public cOsd {
! private:
!     cVideoOut *videoOut;
! protected:
! public:
!     cSoftOsd(cVideoOut *VideoOut, int XOfs, int XOfs);
!     virtual ~cSoftOsd();
!     virtual eOsdError CanHandleAreas(const tArea *Areas, int NumAreas);
!     virtual void Flush(void);
! };
! 
! /* ---------------------------------------------------------------------------
!  */
! cSoftOsd::cSoftOsd(cVideoOut *VideoOut, int X, int Y) : cOsd(X, Y)
! {
!   videoOut = VideoOut;
!   videoOut->OpenOSD(X, Y);
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! cSoftOsd::~cSoftOsd()
! {
!   if (videoOut)
!   {
!     videoOut->CloseOSD();
!     videoOut=0;
!   }
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! eOsdError cSoftOsd::CanHandleAreas(const tArea *Areas, int NumAreas)
! {
!     eOsdError Result = cOsd::CanHandleAreas(Areas, NumAreas);
! 
!     return Result;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void cSoftOsd::Flush(void)
! {
!     cBitmap *Bitmap;
! 
!   videoOut->Size(Width(),Height());
!   videoOut->OSDStart();
!   for (int i = 0; (Bitmap = GetBitmap(i)) != NULL; i++)
!   {
!     videoOut->Refresh(Bitmap);
!   }
!   videoOut->OSDCommit();
! }
! 
  // --- cSoftOsdProvider -----------------------------------------------
  class cSoftOsdProvider : public cOsdProvider {
--- 90,94 ----
  #if VDRVERSNUM >= 10307
  
! #include "SoftOsd.h"
  // --- cSoftOsdProvider -----------------------------------------------
  class cSoftOsdProvider : public cOsdProvider {
***************
*** 166,170 ****
  {
      osd = new cSoftOsd(videoOut, Left, Top);
-     videoOut->SetOsd(osd);
      return osd;
  }
--- 109,112 ----



From nobody at sheep.berlios.de  Sat Jan  7 15:28:42 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 7 Jan 2006 15:28:42 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.134,1.135 Makefile,1.19,1.20 video.c,1.37,1.38 video.h,1.23,1.24 video-fb.c,1.9,1.10 video-fb.h,1.4,1.5 video-xv.c,1.35,1.36 video-xv.h,1.10,1.11 video-dfb.c,1.42,1.43 video-dfb.h,1.12,1.13 video-vidix.c,1.12,1.13 video-vidix.h,1.5,1.6
Message-ID: <200601071428.k07ESgH19572@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21292

Modified Files:
	CHANGELOG Makefile video.c video.h video-fb.c video-fb.h 
	video-xv.c video-xv.h video-dfb.c video-dfb.h video-vidix.c 
	video-vidix.h 
Log Message:
- completely rewritten OSD. Supports up- and down-scaleing in MMX


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.134
retrieving revision 1.135
diff -C2 -d -r1.134 -r1.135
*** CHANGELOG	7 Jan 2006 13:26:43 -0000	1.134
--- CHANGELOG	7 Jan 2006 14:28:39 -0000	1.135
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-01-07:
+     - completely rewritten OSD. Supports up- and down-scaleing in MMX
      - add sfence and emms to yv12_to_yuy2()
      - on resume try to open audio-out in non-blocking mode

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** Makefile	6 Oct 2005 21:28:11 -0000	1.19
--- Makefile	7 Jan 2006 14:28:39 -0000	1.20
***************
*** 210,219 ****
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o sync-timer.o
  ALL_OBJS = $(OBJS)
  
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
--- 210,219 ----
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o sync-timer.o SoftOsd.o
  ALL_OBJS = $(OBJS)
  
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o SoftOsd.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
***************
*** 228,232 ****
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
--- 228,232 ----
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o SoftOsd.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
***************
*** 238,242 ****
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
--- 238,242 ----
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o SoftOsd.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
***************
*** 249,253 ****
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
--- 249,253 ----
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o SoftOsd.o
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** video.c	15 Nov 2005 06:02:16 -0000	1.37
--- video.c	7 Jan 2006 14:28:39 -0000	1.38
***************
*** 15,18 ****
--- 15,25 ----
  #include "setup-softdevice.h"
  #include "sync-timer.h"
+ #include "SoftOsd.h"
+ 
+ //#define OSDDEB(out...) {printf("vout_osd[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
+ 
+ #ifndef OSDDEB
+ #define OSDDEB(out...)
+ #endif
  
  cVideoOut::cVideoOut(cSetupStore *setupStore)
***************
*** 22,29 ****
    OsdHeight=OSD_FULL_HEIGHT;
  #endif
    sxoff = syoff = lxoff = lyoff = 0;
    cutTop = cutBottom = cutLeft = cutRight = 0;
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
!   Osd_changed = Osd_Bitmap_changed = 0;
    aspect_F = 4.1 / 3.0;
    aspect_I = 0;
--- 29,39 ----
    OsdHeight=OSD_FULL_HEIGHT;
  #endif
+   // set some reasonable defaults
+   fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
+   fheight = lheight = old_dheight = dheight = sheight = 536;
    sxoff = syoff = lxoff = lyoff = 0;
    cutTop = cutBottom = cutLeft = cutRight = 0;
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
!   Osd_changed = 0;
    aspect_F = 4.1 / 3.0;
    aspect_I = 0;
***************
*** 31,34 ****
--- 41,45 ----
    PixelMask=NULL;
    OsdRefreshCounter=0;
+   osd=NULL;
    displayTimeUS = 0;
    this->setupStore=setupStore;
***************
*** 99,102 ****
--- 110,114 ----
           OsdRefreshCounter>10 && Osd_changed))
      {
+       osdMutex.Lock();
        if (old_picture)
        {
***************
*** 110,120 ****
        else
        {
!         DrawStill_420pl (OsdPy,OsdPu, OsdPv, OsdWidth, OsdHeight,
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
-       
-       osdMutex.Lock();
        Osd_changed=0;
        osdMutex.Unlock();
      }
  #if 0
--- 122,131 ----
        else
        {
!         DrawStill_420pl (OsdPy,OsdPu, OsdPv,OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
        Osd_changed=0;
        osdMutex.Unlock();
+       
      }
  #if 0
***************
*** 131,158 ****
        newOsdHeight=OSD_FULL_HEIGHT;
      }
!     else 
!     {
!       if (newOsdWidth > OSD_FULL_WIDTH)
!         newOsdWidth=OSD_FULL_WIDTH;
!       if (newOsdHeight > OSD_FULL_HEIGHT)
!         newOsdHeight=OSD_FULL_HEIGHT;
!     }
!     if (OSDpresent && osd
         && ( OsdWidth!=newOsdWidth  || OsdHeight!=newOsdHeight  || 
             changeMode )
          )
      {
!       OSDdirty=true;
!       //printf("OsdWidth %d newOsdWidth %d OsdHeight %d newOsdHeight %d \n",
!       //   OsdWidth,newOsdWidth,OsdHeight,newOsdHeight);
!       if (changeMode) {
!         cOsd *osdSave=osd;
!         CloseOSD();
!         current_osdMode=newOsdMode;
!         OpenOSD(OSDxOfs,OSDyOfs);
!         osd=osdSave;
!       }
!       osd->Flush();
      }
      usleep(50000);
    }
--- 142,159 ----
        newOsdHeight=OSD_FULL_HEIGHT;
      }
!    
!     osdMutex.Lock();
!     if (OSDpresent && osd 
         && ( OsdWidth!=newOsdWidth  || OsdHeight!=newOsdHeight  || 
             changeMode )
          )
      {
!       OSDDEB("change size: OsdWidth %d newOsdWidth %d\n",OsdWidth,newOsdWidth);
!       current_osdMode=newOsdMode;
!       // redraw the complete osd
!       OSDFlush_nolock(osd,true);
!       OSDDEB("change size end\n");
      }
+     osdMutex.Unlock();
      usleep(50000);
    }
***************
*** 164,170 ****
  void cVideoOut::InvalidateOldPicture(void)
  {
!   osdMutex.Lock();
    old_picture = NULL;
!   osdMutex.Unlock();
  }
  
--- 165,171 ----
  void cVideoOut::InvalidateOldPicture(void)
  {
!   areaMutex.Lock();
    old_picture = NULL;
!   areaMutex.Unlock();
  }
  
***************
*** 173,181 ****
  void cVideoOut::SetOldPicture(AVFrame *picture, int width, int height)
  {
!   osdMutex.Lock();
    old_picture = picture;
    old_width = width;
    old_height = height;
!   osdMutex.Unlock();
  }
  
--- 174,182 ----
  void cVideoOut::SetOldPicture(AVFrame *picture, int width, int height)
  {
!   //osdMutex.Lock(); //protected by areaMutex osdMutex will cause deadlocks!
    old_picture = picture;
    old_width = width;
    old_height = height;
!   //osdMutex.Unlock();
  }
  
***************
*** 312,315 ****
--- 313,317 ----
  {
    current_aspect = -1;
+   //printf("aspect_F %f\n",aspect_F);
    CheckAspect (current_afd, aspect_F);
  }
***************
*** 425,428 ****
--- 427,431 ----
  {
    areaMutex. Lock();
+   OsdRefreshCounter=0;
    CheckAspectDimensions(picture,context);
    SetOldPicture(picture,context->width,context->height);
***************
*** 447,450 ****
--- 450,454 ----
  {
    areaMutex. Lock();
+   OsdRefreshCounter=0;
    CheckArea(w, h);
    // display picture
***************
*** 453,468 ****
  }
  
! #define OPACITY_THRESHOLD 0x8F
! #define TRANSPARENT_THRESHOLD 0x0F
! #define IS_BACKGROUND(a) (((a) < OPACITY_THRESHOLD) && (a > TRANSPARENT_THRESHOLD))
! 
! /* ---------------------------------------------------------------------------
!  */
! void cVideoOut::OSDStart()
  {
!   osdMutex.Lock();
!   //fprintf (stderr, "+");
  
- #if VDRVERSNUM >= 10307
    if (current_osdMode==OSDMODE_SOFTWARE)
    	init_OsdBuffers();
--- 457,466 ----
  }
  
! #if VDRVERSNUM >= 10307
! void cVideoOut::OSDFlush_nolock(cSoftOsd *Osd,bool RefreshAll)
  {
!   OSDDEB("OSDFlush RefreshAll: %d \n",
!                   RefreshAll);
  
    if (current_osdMode==OSDMODE_SOFTWARE)
    	init_OsdBuffers();
***************
*** 475,513 ****
      newY=OSD_FULL_HEIGHT;
    }
-   else 
-   {
-     if (newX > OSD_FULL_WIDTH)
-       newX=OSD_FULL_WIDTH;
-     if (newY > OSD_FULL_HEIGHT)
-       newY=OSD_FULL_HEIGHT;
-   }
    if (newX!=OsdWidth || newY!=OsdHeight)
    {
      OsdWidth=newX;
      OsdHeight=newY;
!     OSDdirty=true;
    };
  
!   if (OSDdirty)
      ClearOSD();
! #endif
! } 
! 
! /* ---------------------------------------------------------------------------
!  */
! void cVideoOut::OSDCommit()
! {
!   //fprintf (stderr, "-");
!   OSDdirty=false;
    OSDpresent=true;
! #if VDRVERSNUM >= 10307
!   if (Osd_Bitmap_changed)
!   {
!     Osd_Bitmap_changed = 0;
!     Osd_changed = 1;
!   }
! #endif
!   osdMutex.Unlock();
  }
  
  /* ---------------------------------------------------------------------------
--- 473,502 ----
      newY=OSD_FULL_HEIGHT;
    }
    if (newX!=OsdWidth || newY!=OsdHeight)
    {
+     OSDDEB("new osd dimensions: %d,%d\n",newX,newY);
      OsdWidth=newX;
      OsdHeight=newY;
!     RefreshAll=true;
    };
+   
  
!   if (RefreshAll)
      ClearOSD();
!  
!   cSoftOsd *SoftOsd=dynamic_cast<cSoftOsd*>(Osd);
!   if (SoftOsd) {
!           int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
!           uint8_t *PixelMask;
!           GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
!           SoftOsd->SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
! 	  RefreshOSD(SoftOsd,RefreshAll);
!   } else printf("SoftOsd=NULL!!!!!!!\n");
!   
    OSDpresent=true;
!   Osd_changed = 1;
!   OSDDEB("End OSDFlush\n");
  }
+ #endif
  
  /* ---------------------------------------------------------------------------
***************
*** 515,518 ****
--- 504,508 ----
  void cVideoOut::ClearOSD()
  {
+   OSDDEB("ClearOSD\n");
    //if (current_osdMode==OSDMODE_SOFTWARE)
    {
***************
*** 532,540 ****
  #if VDRVERSNUM >= 10307
  
! void cVideoOut::OpenOSD(int X, int Y)
  {
!   OSDxOfs = X;
!   OSDyOfs = Y;
!   OSDdirty=true;
  }
  
--- 522,536 ----
  #if VDRVERSNUM >= 10307
  
! void cVideoOut::OpenOSD(int X, int Y, cSoftOsd * Osd)
  {
!   OSDDEB("OpenOSD\n");
!   osd=Osd;
!   //cSoftOsd *SoftOsd=dynamic_cast<cSoftOsd*>(osd);
!   //if (SoftOsd) {
!           int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV;
!           uint8_t *PixelMask;
!           GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
!           osd->SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
!   //} else printf("SoftOSD NULL!\n");
  }
  
***************
*** 542,843 ****
  {
    osdMutex.Lock();
- 
    ClearOSD();
-   
    osd=NULL;
    OSDpresent=false;
    Osd_changed=1;
    osdMutex.Unlock();
  }
  
- 
- /* ---------------------------------------------------------------------------
-  */
- 
- void ScaleBitmap(cBitmap *Bitmap,
-               int &a, int &r, int &g, int &b,
-               int x, int y, int newX, int newY) {
- // scales a bitmap down... no upscaling...
-   const tIndex  *adr;
-   struct color {
-     unsigned char b;
-     unsigned char g;
-     unsigned char r;
-     unsigned char a;
-     } pixel;
-  
-   if ( OSD_FULL_HEIGHT == newY &&
-       OSD_FULL_WIDTH == newX) 
-   {
-      adr = Bitmap->Data(x,y);
-      *((uint32_t *) &pixel) = (uint32_t) Bitmap->Color(*adr);
-      a = pixel.a;
-      b = pixel.b;
-      r = pixel.r;
-      g = pixel.g;
-      return;
-   };
-   
-   int minPY=OSD_FULL_HEIGHT*y/newY;
-   int maxPY=OSD_FULL_HEIGHT*(y+1)/newY;
-   int minPX=OSD_FULL_WIDTH*x/newX;
-   int maxPX=OSD_FULL_WIDTH*(x+1)/newX;
-   int sumA=0;
-   int sumR=0;
-   int sumG=0;
-   int sumB=0;
-   int weightYf=0;
-   int weightYl=0;
-   int weightXf=0;
-   int weightXl=0;
-   int weightX=0;
-   int weight;
-   int weights=0;
-    
- 
-   weightYf=-OSD_FULL_HEIGHT*100*y/newY+(minPY+1)*100;
-   weightYl=-(maxPY)*100+OSD_FULL_HEIGHT*100*(y+1)/newY;
-   weightXf=-OSD_FULL_WIDTH*100*x/newX+(minPX+1)*100;
-   weightXl=-(maxPX)*100+OSD_FULL_WIDTH*100*(x+1)/newX;
- 
-   for (int i=minPX; i<= maxPX; i++) {
-     if (i==minPX)
-       weightX=weightXf;
-     else if (i==maxPX)
-       weightX=weightXl;
-     else weight=100;
-     
-     for (int j=minPY; j<= maxPY; j++) {
-       if (j==minPY)
-         weight=weightX*weightYf;
-       else if (j==maxPY)
-         weight=weightX*weightYl;
-       else weight=weightX*100;
- 
- //      printf("minPX %d, maxPX %d, minPY %d maxPY %d, weightX %d,weightYf %d \n",
- //       minPX,maxPX,minPY,maxPY,weightX,weightYf);
-       if ( i > Bitmap->Width() )
-               continue;
-       if ( j > Bitmap->Height() )
-               continue;
-                       
-       adr = Bitmap->Data(i,j);
-       *((uint32_t *) &pixel) = (uint32_t) Bitmap->Color(*adr);
-       sumA+=weight* pixel.a;
-       sumB+=weight* pixel.b;
-       sumR+=weight* pixel.r;
-       sumG+=weight* pixel.g;
-       weights+=weight;
-     };
-   };
- 
-   a= sumA/weights;
-   b= sumB/weights;
-   r= sumR/weights;
-   g= sumG/weights;
- };
-   
- void cVideoOut::Draw(cBitmap *Bitmap,
-                      unsigned char *osd_buf,
-                      int linelen,
-                      bool inverseAlpha)
- {
-     int           depth = (Bpp + 7) / 8;
-     int           a, r, g, b;
-     bool          prev_pix = false, do_dither;
-     tIndex        *buf;
-     int           x1,x2,y1,y2;
-     uint8_t       *PixelMaskPtr;
- 
- 
- //  printf( "Draw: OSDWidth %d %d Bitmap %d %d \n",
- //   OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
-     // if bitmap didn't change, return
-     if (!Bitmap->Dirty(x1,y1,x2,y2) && !OSDdirty )
-       return;
-   
- // printf("dirty area (%d,%d) (%d,%d) \n",x1,y1,x2,y2);
-   
-   if (OSDdirty)
-   {
-     y1=x1=0;
-     x2=Bitmap->Width()-1;
-     y2=Bitmap->Height()-1;
-   };
- 
- #define SCALEX(x) ((x) * OsdWidth/OSD_FULL_WIDTH)
- #define SCALEY(y) ((y) * OsdHeight/OSD_FULL_HEIGHT)
-   for (int y =SCALEY(y1); y <= SCALEY(y2); y++)
-   {
-     buf = (tIndex *) osd_buf +
-             linelen * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
-             (OSDxOfs + SCALEX(Bitmap->X0() + x1) ) * depth;
-     PixelMaskPtr=PixelMask +
-            linelen/16 * ( OSDyOfs + y + SCALEY(Bitmap->Y0())) +
-             (OSDxOfs + SCALEX(Bitmap->X0() + x1))/8;
-     prev_pix = false;
- 
-     for (int x = SCALEX(x1); x <= SCALEX(x2); x++)
-     {
-       do_dither = ((x % 2 == 1 && y % 2 == 1) ||
-                     x % 2 == 0 && y % 2 == 0 || prev_pix);
-      /* 
-       adr = Bitmap->Data(x, y);
-       c = Bitmap->Color(*adr);
-       a = (c >> 24) & 255; //Alpha
-       r = (c >> 16) & 255; //Red
-       g = (c >> 8) & 255;  //Green
-       b = c & 255;         //Blue
-     */ 
-      ScaleBitmap(Bitmap,a,r,g,b,x,y,OsdWidth,OsdHeight);
- 
-       if (PixelMask) {
-         if (a>TRANSPARENT_THRESHOLD)
-           PixelMaskPtr[x/8]|=(1<<x%8);
-       }
- 
-       /* ---------------------------------------------------------------------
-        * pseudo spu drawing looks better if rgb values are set to colorkey
-        * so that they are full transparent in case of zero alpha value
-        */
-       if (!a)
-         r = g = b = 0;
- 
-       switch (depth) {
-         case 4:
-           if ((do_dither && IS_BACKGROUND(a) && OSDpseudo_alpha) ||
-               (a == 255 && r == 0 && g == 0 && b == 0))
-           {
-             buf[0] = 1; buf[1] = 1; buf[2] = 1; buf[3] = 255;
-           } else {
-             if (inverseAlpha)
-               a = 255 - a;
- 
-             buf[0] = b;
-             buf[1] = g;
-             buf[2] = r;
-             buf[3] = a;
-           }
- 
-           buf += 4;
-           break;
-         case 3:
-           if ((do_dither && IS_BACKGROUND(a)) ||
-               (a == 255 && r == 0 && g == 0 && b == 0))
-           {
-             buf[0] = 1; buf[1] = 1; buf[2] = 1;
-           } else {
-             buf[0] = b;
-             buf[1] = g;
-             buf[2] = r;
-           }
- 
-           buf += 3;
-           break;
-         case 2:
-           if ((do_dither && IS_BACKGROUND(a)) ||
-               (a == 255 && r == 0 && g == 0 && b == 0))
-           {
-               buf[0] = 0x21; buf[1] = 0x08;
-           } else {
-             buf[0] = ((b >> 3)& 0x1F) | ((g & 0x1C) << 3);
-             buf[1] = (r & 0xF8) | (g >> 5);
-           }
- 
-           buf += 2;
-           break;
-         default:
-             //dsyslog("[VideoOut] OSD: unsupported depth %d exiting",depth);
-             //exit(1);
-           break;
-       }
-       prev_pix = !IS_BACKGROUND(a);
-     }
-   }
-   Bitmap->Clean();
- }
- 
- void cVideoOut::ToYUV(cBitmap *Bitmap)
- {
-     int      a1, r1, g1, b1;
-     int      a2, r2, g2, b2;
-     uint8_t       Y1,U1,V1;
-     uint8_t       Y2,U2,V2;
-     int linelen=OSD_FULL_WIDTH;
-     int offset;
-   //  printf("ToYUV... OsdPy: 0%x Res:(%d,%d)\n",OsdPy,linelen,lines);
- 
-   
-  // printf( "YUV:OSDWidth %d %d Bitmap %d %d \n",
-  //   OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height());
-  
-     int           x1,x2,y1,y2;
-     // if bitmap didn't change, return
-     if (!Bitmap->Dirty(x1,y1,x2,y2) && !OSDdirty)
-       return;
-     
-   Osd_Bitmap_changed=1;
-    //printf( "----------------------------\nOSDWidth %d %d Bitmap %d %d \n",
-    //     OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
-    //printf("dirty area (%d,%d) (%d,%d) \n",x1,y1,x2,y2);
-     
-     if ( OSDdirty )
-     {
-       //printf("++++++++++++++++++++++new OsdHeight+++++++ OSDdirty %d+++++\n",
-       //  OSDdirty);
-       x1=y1=0;
-       x2=Bitmap->Width()-1;
-       y2=Bitmap->Height()-1;
-    }
- 
- #define SCALEX(x) ((x) * OsdWidth/OSD_FULL_WIDTH)
- #define SCALEY(y) ((y) * OsdHeight/OSD_FULL_HEIGHT)
- 
-   y1=SCALEY(y1); 
-   y2=SCALEY(y2); 
-   x1=SCALEX(x1);
-   x2=SCALEX(x2);
-   int  x0=sxoff+SCALEX(OSDxOfs+Bitmap->X0());
-   int  y0=(syoff+SCALEY(OSDyOfs+Bitmap->Y0())) & ~1; // we need an even offset
- 
-   // we need a even starting point
-   y1&=~1;
-   y2= (y2+2) & ~1;
-   y2= ( y2 > Bitmap->Height()-1 ? Bitmap->Height()-1 : y2);
-   // two rows at a time...
-   for (int y = y1; y < y2; y+=2) 
-   {
-     offset = (y0+y)*linelen;
-     for (int x = x1; x <= x2; x++)
-     {
-      ScaleBitmap(Bitmap,a1,r1,g1,b1,x,y,OsdWidth,OsdHeight);
-      ScaleBitmap(Bitmap,a2,r2,g2,b2,x,y+1,OsdWidth,OsdHeight);
-   
-       Y1 = (( 66 * r1 + 129 * g1 + 25 * b1 + 128 )  >> 8)+16;
-       Y2 = (( 66 * r2 + 129 * g2 + 25 * b2 + 128 )  >> 8)+16;
-       OsdPy[offset+x+x0]=Y1;
-       OsdPAlphaY[offset+x+x0]=a1;
-       OsdPy[offset+linelen+x+x0]=Y2;
-       OsdPAlphaY[offset+linelen+x+x0]=a2;
-       
-       // even columns have U and V
-       if ( (x&1)==0 ) 
-       {
-         // I got this formular from Wikipedia...
-         U1 = (( -38 * r1 - 74 * g1 +112 * b1 + 128 )  >> 8)+128;
-         V1 = (( 112 * r1 - 94 * g1 - 18 * b1 + 128 )  >> 8)+128;
- 
-         U2 = (( -38 * r2 - 74 * g2 +112 * b2 + 128 )  >> 8)+128;
-         V2 = (( 112 * r2 - 94 * g2 - 18 * b2 + 128 )  >> 8)+128;
- 
-         OsdPu[offset/4+(x+x0)/2]=(U1+U2)/2;
-         OsdPv[offset/4+(x+x0)/2]=(V1+V2)/2;
-         OsdPAlphaUV[offset/4+(x+x0)/2]=(a1+a2)/2;
-       }
-      }
-     }
-   Bitmap->Clean();
- 
- }
  void cVideoOut::AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
            uint8_t *alpha,uint16_t count) {
--- 538,549 ----
  {
    osdMutex.Lock();
    ClearOSD();
    osd=NULL;
    OSDpresent=false;
    Osd_changed=1;
    osdMutex.Unlock();
+   OSDDEB("CloseOSD\n");
  }
  
  void cVideoOut::AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
            uint8_t *alpha,uint16_t count) {

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** video.h	25 Oct 2005 19:35:25 -0000	1.23
--- video.h	7 Jan 2006 14:28:39 -0000	1.24
***************
*** 42,56 ****
  #define PREFETCH "prefetch "
  #define MOVQ     "movntq "
! #define EMMS     __asm__ (" femms \n": :  )
  #elif defined ( USE_MMX2 )
  //#warning Using MMX2 extensions
  #define PREFETCH "prefetchnta "
  #define MOVQ     "movntq "
! #define EMMS     __asm__ (" emms \n": :  )
  #else
  //#warning Using MMX extensions
  #define PREFETCH
  #define MOVQ     "movq "
! #define EMMS     __asm__ (" emms \n": :  )
  #endif
  
--- 42,56 ----
  #define PREFETCH "prefetch "
  #define MOVQ     "movntq "
! #define EMMS     __asm__ __volatile__  (" femms \n": : : "memory"  )
  #elif defined ( USE_MMX2 )
  //#warning Using MMX2 extensions
  #define PREFETCH "prefetchnta "
  #define MOVQ     "movntq "
! #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
  #else
  //#warning Using MMX extensions
  #define PREFETCH
  #define MOVQ     "movq "
! #define EMMS     __asm__ __volatile__ (" emms \n": : : "memory"  )
  #endif
  
***************
*** 77,80 ****
--- 77,82 ----
  #endif
  
+ class cSoftOsd;
+ 
  class cVideoOut: public cThread {
  private:
***************
*** 85,90 ****
      cMutex  osdMutex,
              areaMutex;
-     int     OSDxOfs, OSDyOfs,
-             OSDw, OSDh;
      bool    OSDpresent,
              OSDpseudo_alpha;
--- 87,90 ----
***************
*** 116,122 ****
      cSetupStore *setupStore;
  
-     cOsd *osd;
      bool active;
-     bool OSDdirty;
  
      virtual void RecalculateAspect(void);
--- 116,120 ----
***************
*** 125,133 ****
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
-     virtual void Size(int w, int h) {OSDw = w; OSDh = h;};
-     virtual void OSDStart();
-     virtual void OSDCommit();
-     virtual void OpenOSD(int X, int Y);
      virtual void CloseOSD();
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
      virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride) { return; };
--- 123,128 ----
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
      virtual void CloseOSD();
+     
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
      virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride) { return; };
***************
*** 156,168 ****
      // time
  
-     void SetOsd(cOsd * Osd) {osd=Osd;};
-     // sets a pointer to the current osd. For refreshing of the osd 
- 
      virtual void InvalidateOldPicture(void);
      virtual void SetOldPicture(AVFrame *picture, int width, int height);
  
      uint8_t *PixelMask;
!     int     Osd_changed,
!             Osd_Bitmap_changed;
      uint8_t *OsdPy;
      uint8_t *OsdPu; 
--- 151,159 ----
      // time
  
      virtual void InvalidateOldPicture(void);
      virtual void SetOldPicture(AVFrame *picture, int width, int height);
  
      uint8_t *PixelMask;
!     int     Osd_changed;
      uint8_t *OsdPy;
      uint8_t *OsdPu; 
***************
*** 185,188 ****
--- 176,186 ----
  
  #if VDRVERSNUM >= 10307
+     cSoftOsd *osd;
+     void OSDFlush_nolock(cSoftOsd *Osd,bool RefreshAll=false);
+     inline void OSDFlush(cSoftOsd *Osd,bool RefreshAll=false)
+     {osdMutex.Lock();OSDFlush_nolock(Osd,RefreshAll); osdMutex.Unlock();};
+     
+     virtual void OpenOSD(int X, int Y, cSoftOsd *Osd);
+     
      virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight)
      // called whenever OSD is to be displayed
***************
*** 190,208 ****
      // for scaling, if -1,-1 is returned no scaling is done.
      { OsdWidth=-1;OsdHeight=-1;};
  
!     
!     virtual void Refresh(cBitmap *Bitmap) { return; };
!     
!     void Draw(cBitmap *Bitmap,
!               unsigned char * buf,
!               int linelen,
!               bool inverseAlpha = false);
!     // draws the bitmap in buf. The bitmap is scaled automaticaly if
!     // GetOSDDimension return smaller dimensions
        
-    void ToYUV(cBitmap *Bitmap);
-    // converts the bitmap to YUV format, saved in OSDP[yuv] and 
-    // OSDPAlpha[YUV]. The bitmap is also scaled if requested
-    
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
         uint8_t *alpha,uint16_t count);
--- 188,201 ----
      // for scaling, if -1,-1 is returned no scaling is done.
      { OsdWidth=-1;OsdHeight=-1;};
+      
+     virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
+                     bool &IsYUV, uint8_t *&PixelMask)
+     { Depth=32; HasAlpha=true; AlphaInversed=false; IsYUV=false; 
+             PixelMask=NULL;};
+     // should be implemented by all video out method to set the OSD pixel mode
  
!     virtual void RefreshOSD(cSoftOsd *SoftOsd, bool RefreshAll=false) 
!     { return; };
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
         uint8_t *alpha,uint16_t count);
***************
*** 210,213 ****
--- 203,208 ----
  
  #else
+     int OSDxOfs,OSDyOfs;
+ 
      cWindowLayer *layer[MAXNUMWINDOWS];
      virtual bool OpenWindow(cWindow *Window);

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-fb.c	20 May 2005 21:36:04 -0000	1.9
--- video-fb.c	7 Jan 2006 14:28:39 -0000	1.10
***************
*** 18,21 ****
--- 18,22 ----
  #include "utils.h"
  #include "setup-softdevice.h"
+ #include "SoftOsd.h"
  
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 154,162 ****
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::OpenOSD(int X, int Y)
  {
!   OSDxOfs = X & ~7;
!   OSDyOfs = Y & ~1;
!   OSDdirty=true;
  }
  
--- 155,163 ----
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::OpenOSD(int X, int Y, cSoftOsd *osd)
  {
!   cVideoOut::OpenOSD(X,Y,osd);
!   //OSDxOfs = X & ~7;
!   //OSDyOfs = Y & ~1;
  }
  
***************
*** 181,189 ****
  }
  
! void cFBVideoOut::Refresh(cBitmap *Bitmap)
  {
    pthread_mutex_lock(&fb_mutex);
    OSDpresent=true;
!   Draw(Bitmap,fb,line_len);
    pthread_mutex_unlock(&fb_mutex);
  }
--- 182,191 ----
  }
  
! void cFBVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
  {
    pthread_mutex_lock(&fb_mutex);
    OSDpresent=true;
!   Osd->CopyToBitmap(fb,line_len,OsdWidth,OsdHeight,RefreshAll);
!   //Draw(Bitmap,fb,line_len);
    pthread_mutex_unlock(&fb_mutex);
  }

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-fb.h	3 Mar 2005 20:22:17 -0000	1.4
--- video-fb.h	7 Jan 2006 14:28:39 -0000	1.5
***************
*** 22,25 ****
--- 22,26 ----
    __u16 * orig_cmap;
  
+   uint8_t *PixelMask;
    size_t size;
    int line_len;
***************
*** 29,35 ****
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
!   virtual void OpenOSD(int X, int Y);
    virtual void ClearOSD();
!   virtual void Refresh(cBitmap *Bitmap);
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
  #else
--- 30,39 ----
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
!   virtual void OpenOSD(int X, int Y, cSoftOsd *osd);
    virtual void ClearOSD();
!   virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
! 		  bool &IsYUV, uint8_t *&pixelmask)
!   { Depth=16;HasAlpha=false;IsYUV=false;pixelmask=PixelMask; };
!   virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
  #else

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** video-xv.c	7 Nov 2005 20:59:35 -0000	1.35
--- video-xv.c	7 Jan 2006 14:28:39 -0000	1.36
***************
*** 32,36 ****
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
! static cXvRemote        *xvRemote = NULL;
  static cScreensaver     *xScreensaver = NULL;
  static int              events_not_done = 0;
--- 32,36 ----
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
! cXvRemote        *xvRemote = NULL;
  static cScreensaver     *xScreensaver = NULL;
  static int              events_not_done = 0;
***************
*** 462,465 ****
--- 462,468 ----
  }
  
+ //#define EVDEB(out...) {printf("EVDEB:");printf(out);} 
+ #define EVDEB(out...)
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 501,504 ****
--- 504,508 ----
          break;
        case ConfigureNotify:
+         EVDEB("ConfigureNotify\n");
          map_count++;
          dx = event.xconfigure.x;
***************
*** 610,613 ****
--- 614,618 ----
  
        case MapNotify:
+         EVDEB("MapNotify\n");
          map_count++;
          if (initialized) {
***************
*** 618,621 ****
--- 623,627 ----
            if (map_count > 2 && xv_initialized) {
              XClearArea (dpy, win, 0, 0, 0, 0, True);
+             ShowOSD(0,false);
              XvShmPutImage(dpy, port,
                            win, gc,
***************
*** 632,635 ****
--- 638,642 ----
          break;
        case UnmapNotify:
+         EVDEB("UnmapNotify\n");
          if (xv_initialized)
            XvStopVideo (dpy,port,win);
***************
*** 639,643 ****
--- 646,655 ----
          }
          break;
+       case Expose:
+         EVDEB("Expose\n");
+         map_count++;
+         break;
        default:
+         EVDEB("unhandled event: %d\n",event.type);
          break;
      }
***************
*** 646,659 ****
    if (xv_initialized) {
      if (map_count) {
!       XClearArea (dpy, win, 0, 0, 0, 0, True);
!       XvShmPutImage(dpy, port,
!                     win, gc,
!                     xv_image,
!                     sxoff, syoff,      /* sx, sy */
!                     swidth, sheight,   /* sw, sh */
!                     lxoff,  lyoff,     /* dx, dy */
!                     lwidth, lheight,   /* dw, dh */
!                     False);
        XSync(dpy, False);
      }
      attributeStore.CheckVideoParmChange();
--- 658,673 ----
    if (xv_initialized) {
      if (map_count) {
!       //XClearArea (dpy, win, 0, 0, 0, 0, True);
!       ShowOSD(0,false);
! //      XvShmPutImage(dpy, port,
! //                    win, gc,
! //                    xv_image,
! //                    sxoff, syoff,      /* sx, sy */
! //                    swidth, sheight,   /* sw, sh */
! //                    lxoff,  lyoff,     /* dx, dy */
! //                    lwidth, lheight,   /* dw, dh */
! //                    False);
        XSync(dpy, False);
+       map_count=0;
      }
      attributeStore.CheckVideoParmChange();
***************
*** 841,844 ****
--- 855,861 ----
    useShm=XShmQueryExtension(dpy) && isLocal;
    if (useShm) {
+ 	  osd_max_width=DisplayWidth(dpy,DefaultScreen(dpy));
+           osd_max_height=DisplayHeight(dpy,DefaultScreen(dpy));
+ 
            osd_image = XShmCreateImage (dpy,
                            XDefaultVisual (dpy, scn_id),
***************
*** 846,850 ****
                            ZPixmap,NULL,
                            &osd_shminfo,
!                           width, height);
            if (osd_image) {
                    dsyslog("[XvVideoOut]: Initialize XShmCreateImage Successful (%p)", osd_image);
--- 863,868 ----
                            ZPixmap,NULL,
                            &osd_shminfo,
! 			  osd_max_width,osd_max_height);
!                           //width, height);
            if (osd_image) {
                    dsyslog("[XvVideoOut]: Initialize XShmCreateImage Successful (%p)", osd_image);
***************
*** 854,858 ****
  
            osd_shminfo.shmid = shmget (IPC_PRIVATE,
!                           osd_image->bytes_per_line*height,
                            IPC_CREAT | 0777);
            if (osd_shminfo.shmid == -1) {
--- 872,877 ----
  
            osd_shminfo.shmid = shmget (IPC_PRIVATE,
!                           osd_image->bytes_per_line*osd_max_height,
!                           //osd_image->bytes_per_line*height,
                            IPC_CREAT | 0777);
            if (osd_shminfo.shmid == -1) {
***************
*** 881,894 ****
    } else {
            osd_image = XGetImage(dpy, win, 0, 0,
!                           width, height, AllPlanes,
                            ZPixmap);
            if (osd_image) {
                    dsyslog("[XvVideoOut]: Initialize XGetImage Successful (%p)", osd_image);
            } else {
                    dsyslog("[XvVideoOut]: Initialize ERROR: XGetImage FAILED !");
            }
-           osd_buffer = (unsigned char *) osd_image->data;
    };
    Bpp=osd_image->bits_per_pixel;
    
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
--- 900,916 ----
    } else {
            osd_image = XGetImage(dpy, win, 0, 0,
!                           osd_max_width, osd_max_height, AllPlanes,
                            ZPixmap);
            if (osd_image) {
                    dsyslog("[XvVideoOut]: Initialize XGetImage Successful (%p)", osd_image);
+ 		  osd_buffer = (unsigned char *) osd_image->data;
            } else {
                    dsyslog("[XvVideoOut]: Initialize ERROR: XGetImage FAILED !");
+ 		  osd_buffer = NULL;
            }
    };
    Bpp=osd_image->bits_per_pixel;
+   printf("got osd_image: width %d height %d, bytes per line %d\n",
+                   osd_max_width, osd_max_height,osd_image->bytes_per_line);
    
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
***************
*** 1055,1059 ****
    attributeStore.Save();
    attributeStore.SetColorkey(0x00000000);
!   attributeStore.SetValue("XV_AUTOPAINT_COLORKEY",1);
  
    /*
--- 1077,1081 ----
    attributeStore.Save();
    attributeStore.SetColorkey(0x00000000);
!   attributeStore.SetValue("XV_AUTOPAINT_COLORKEY",0);
  
    /*
***************
*** 1201,1208 ****
    if (initialized)
    {
!     memset (osd_buffer, 0, osd_image->bytes_per_line * height);
      pthread_mutex_lock(&xv_mutex);
      osd_refresh_counter = osd_skip_counter = 0;
      XClearArea (dpy, win, 0, 0, 0, 0, True);
      XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
--- 1223,1231 ----
    if (initialized)
    {
!     memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
      pthread_mutex_lock(&xv_mutex);
      osd_refresh_counter = osd_skip_counter = 0;
      XClearArea (dpy, win, 0, 0, 0, 0, True);
+     ShowOSD(0,false);
      XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
***************
*** 1217,1222 ****
  {
    cVideoOut::ClearOSD();
!   if (initialized && current_osdMode==OSDMODE_PSEUDO)
!     memset (osd_buffer, 0, osd_image->bytes_per_line * height);
  };
  
--- 1240,1250 ----
  {
    cVideoOut::ClearOSD();
!   if (initialized && current_osdMode==OSDMODE_PSEUDO) {
!     pthread_mutex_lock(&xv_mutex);
!     memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     //XClearArea (dpy, win, 0, 0, 0, 0, True);// still needs locking!
!     //XSync(dpy, False);
!     pthread_mutex_unlock(&xv_mutex);
!   };
  };
  
***************
*** 1227,1232 ****
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!                 OsdWidth=lwidth;//*9/10;
!                 OsdHeight=lheight;//*9/10;
               break;
        case OSDMODE_SOFTWARE:
--- 1255,1260 ----
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!                 OsdWidth=lwidth<osd_max_width?lwidth:osd_max_width;
!                 OsdHeight=lheight<osd_max_height?lheight:osd_max_height;
               break;
        case OSDMODE_SOFTWARE:
***************
*** 1237,1243 ****
  };
  
! /* ---------------------------------------------------------------------------
!  */
! void cXvVideoOut::Refresh(cBitmap *Bitmap)
  {
    // refreshes the screen
--- 1265,1283 ----
  };
  
! void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
!                   bool &IsYUV, uint8_t *&PixelMask) {
!         if (current_osdMode==OSDMODE_SOFTWARE) {
!                 IsYUV=true;
!                 PixelMask=NULL;
!                 return;
!         };
! 
!         IsYUV=false; 
!         Depth=osd_image->bits_per_pixel;
!         HasAlpha=false;
!         PixelMask=NULL;
! };       
! 
! void cXvVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
  {
    // refreshes the screen
***************
*** 1249,1269 ****
      switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!               Draw(Bitmap, osd_buffer, osd_image->bytes_per_line);
              break;
        case OSDMODE_SOFTWARE:
!               ToYUV(Bitmap);
!             break;
!     };
!    
      pthread_mutex_lock(&xv_mutex);
      ++osd_refresh_counter;
!     osd_x = OSDxOfs;
!     osd_y = OSDyOfs;
!     osd_w = OSDw;
!     osd_h = OSDh;
      //OSDpresent=true;
      pthread_mutex_unlock(&xv_mutex);
!   }
! }
  
  #else
--- 1289,1309 ----
      switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!               Osd->CopyToBitmap(osd_buffer, osd_image->bytes_per_line,
!                               OsdWidth,OsdHeight,RefreshAll);
              break;
        case OSDMODE_SOFTWARE:
! 	    Osd->CopyToBitmap(OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
!                             OSD_FULL_WIDTH,OSD_FULL_WIDTH/2,
! 			    OsdWidth,OsdHeight,RefreshAll);
! 	    break;
!  
!     }
      pthread_mutex_lock(&xv_mutex);
      ++osd_refresh_counter;
!     ShowOSD(0,1);
      //OSDpresent=true;
      pthread_mutex_unlock(&xv_mutex);
!   };
! };
  
  #else
***************
*** 1276,1280 ****
    if (!initialized)
      return;
!   if (OSDpresent)
    {
        int x0 = 0, y0 = 0, x1 = 0, y1 = 0, w = 0, h = 0,
--- 1316,1320 ----
    if (!initialized)
      return;
!   //if (OSDpresent)
    {
        int x0 = 0, y0 = 0, x1 = 0, y1 = 0, w = 0, h = 0,
***************
*** 1321,1324 ****
--- 1361,1365 ----
        osd_w = w;
        osd_h = h;
+       ShowOSD(0,1);
        pthread_mutex_unlock(&xv_mutex);
  
***************
*** 1332,1358 ****
  void cXvVideoOut::ShowOSD (int skip, int do_sync)
  {
!   if (OSDpresent) {
!     if (osd_refresh_counter) {
!       if (current_osdMode==OSDMODE_PSEUDO && osd_skip_counter > skip) {
!       
!         int x= lwidth > OSD_FULL_WIDTH ? osd_x + (dwidth - width) / 2:
!                 lxoff + (osd_x * lwidth/OSD_FULL_WIDTH *9/10);
!         int y= lheight > OSD_FULL_HEIGHT ? osd_y + (dheight - height) / 2:
!                 lyoff + (osd_y * lheight/OSD_FULL_HEIGHT *9/10);
! 
  	if (useShm) 
  		XShmPutImage (dpy, win, gc, osd_image,
! 				osd_x,
! 				osd_y,
  				x,y,
! 				osd_w, osd_h,
  				False);
  	else
  		XPutImage (dpy, win, gc, osd_image,
! 				osd_x,
! 				osd_y,
  				x,y,
! 				osd_w, osd_h);
! 
          if (do_sync)
            XSync(dpy, False);
--- 1373,1400 ----
  void cXvVideoOut::ShowOSD (int skip, int do_sync)
  {
!   //if (OSDpresent) 
!   {
!     //if (osd_refresh_counter) {
!       if (current_osdMode==OSDMODE_PSEUDO ){//&& osd_skip_counter > skip) {
!      
! #if VDRVERSNUM >= 10307
!         int x= lwidth > osd_max_width ?(lwidth - osd_max_width)/2+lxoff:lxoff;
!         int y= lheight > osd_max_height ? (lheight - osd_max_height) / 2+lyoff:lyoff;
! #else
!         int x=lwidth > OSD_WIDTH ?(lwidth - OSD_WIDTH)/2+lxoff:lxoff;
! 	int y=lheight > OSD_HEIGHT?(lheight - OSD_HEIGHT) / 2+lyoff:lyoff;
! #endif
  	if (useShm) 
  		XShmPutImage (dpy, win, gc, osd_image,
! 				1,1,
  				x,y,
! 				lwidth-1,lheight-1,
  				False);
  	else
  		XPutImage (dpy, win, gc, osd_image,
! 				1,
! 				1,
  				x,y,
! 				lwidth-1,lheight-1);
          if (do_sync)
            XSync(dpy, False);
***************
*** 1362,1366 ****
          osd_skip_counter++;
        }
!     }
    }
  }
--- 1404,1408 ----
          osd_skip_counter++;
        }
!     //}
    }
  }
***************
*** 1375,1378 ****
--- 1417,1421 ----
      return;
  
+   pthread_mutex_lock(&xv_mutex);
    if (aspect_changed ||
        cutTop != setupStore->cropTopLines ||
***************
*** 1382,1385 ****
--- 1425,1429 ----
    {
      XClearArea (dpy, win, 0, 0, 0, 0, True);
+     ShowOSD(0,false);
      aspect_changed = 0;
      cutTop = setupStore->cropTopLines;
***************
*** 1430,1438 ****
                       fwidth/2-(cutLeft+cutRight));
          }
- #ifdef USE_MMX
-      EMMS;
- #endif
  
-         pthread_mutex_lock(&xv_mutex);
          XvShmPutImage(dpy, port,
                  win, gc,
--- 1474,1478 ----
***************
*** 1462,1466 ****
                            fwidth / 2 - (cutLeft + cutRight));
  
-           pthread_mutex_lock(&xv_mutex);
            XvShmPutImage(dpy, port,
                  win, gc,
--- 1502,1505 ----
***************
*** 1471,1475 ****
                  lwidth, lheight,   /* dw, dh */
                  False);
!           ShowOSD (1, False);
    }
    ProcessEvents ();
--- 1510,1514 ----
                  lwidth, lheight,   /* dw, dh */
                  False);
!           //ShowOSD (1, False);
    }
    ProcessEvents ();

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-xv.h	6 Nov 2005 07:29:16 -0000	1.10
--- video-xv.h	7 Jan 2006 14:28:39 -0000	1.11
***************
*** 19,22 ****
--- 19,23 ----
  #define VIDEO_XV_H
  #include "video.h"
+ #include "SoftOsd.h"
  
  #include <pthread.h>
***************
*** 133,139 ****
    bool              useShm;
    XImage            *osd_image;
    unsigned char     *outbuffer,
                      *osd_buffer,
-                     *osd_argb_buffer,
                      *pixels[3];
    char              *w_name, *i_name;
--- 134,140 ----
    bool              useShm;
    XImage            *osd_image;
+   int               osd_max_width,osd_max_height;
    unsigned char     *outbuffer,
                      *osd_buffer,
                      *pixels[3];
    char              *w_name, *i_name;
***************
*** 158,162 ****
    virtual void ClearOSD();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
!   virtual void Refresh(cBitmap *Bitmap);
  #else
    virtual void Refresh();
--- 159,165 ----
    virtual void ClearOSD();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
!   virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
!                   bool &IsYUV, uint8_t *&PixelMask);
!  virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
  #else
    virtual void Refresh();
***************
*** 189,195 ****
      void          SetX11Info (Display *d, Window w);
      void          XvRemoteStart (void);
!     void          PutKey (KeySym key);
  //    virtual bool  Initialize(void);
  };
  
  #endif // VIDEO_XV_H
--- 192,199 ----
      void          SetX11Info (Display *d, Window w);
      void          XvRemoteStart (void);
!     virtual void  PutKey (KeySym key);
  //    virtual bool  Initialize(void);
  };
+ extern cXvRemote        *xvRemote;
  
  #endif // VIDEO_XV_H

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** video-dfb.c	15 Dec 2005 20:12:38 -0000	1.42
--- video-dfb.c	7 Jan 2006 14:28:39 -0000	1.43
***************
*** 15,18 ****
--- 15,20 ----
  #include "setup-softdevice.h"
  
+ #include "SoftOsd.h"
+ 
  #ifdef HAVE_CONFIG
  # include "config.h"
***************
*** 412,421 ****
                 fmt, DFB_BITS_PER_PIXEL(fmt));
        Bpp = DFB_BITS_PER_PIXEL(fmt);
! 
        if (Xres > OSD_FULL_WIDTH)
          Xres = OSD_FULL_WIDTH;
        if (Yres > OSD_FULL_HEIGHT)
          Yres = OSD_FULL_HEIGHT;
! 
        /* ------------------------------------------------------------------------
         * clear screen surface at startup
--- 414,423 ----
                 fmt, DFB_BITS_PER_PIXEL(fmt));
        Bpp = DFB_BITS_PER_PIXEL(fmt);
! /*
        if (Xres > OSD_FULL_WIDTH)
          Xres = OSD_FULL_WIDTH;
        if (Yres > OSD_FULL_HEIGHT)
          Yres = OSD_FULL_HEIGHT;
! */
        /* ------------------------------------------------------------------------
         * clear screen surface at startup
***************
*** 924,928 ****
        else
        {
!         fprintf (stderr, "[dfb] creating new surface\n");
          try
          {
--- 926,930 ----
        else
        {
!         fprintf (stderr, "[dfb] creating new surface (stretchBlit)\n");
          try
          {
***************
*** 989,997 ****
  /* ----------------------------------------------------------------------------
   */
! void cDFBVideoOut::OpenOSD (int x, int y)
  {
      IDirectFBSurface  *tmpSurface;
  
!   cVideoOut::OpenOSD(x, y);
    try
    {
--- 991,999 ----
  /* ----------------------------------------------------------------------------
   */
! void cDFBVideoOut::OpenOSD (int x, int y, cSoftOsd *osd)
  {
      IDirectFBSurface  *tmpSurface;
  
!   cVideoOut::OpenOSD(x, y,osd);
    try
    {
***************
*** 1032,1041 ****
  void cDFBVideoOut::OSDCommit()
  {
-   OSDdirty=false;
    OSDpresent = true;
  }
  
  /* ---------------------------------------------------------------------------
   */
  void cDFBVideoOut::Refresh(cBitmap *Bitmap)
  {
--- 1034,1087 ----
  void cDFBVideoOut::OSDCommit()
  {
    OSDpresent = true;
  }
  
+ void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll) 
+ {
+     int               pitch;
+     uint8_t           *dst;
+     IDirectFBSurface  *tmpSurface;
+     DFBRegion         modArea;
+     DFBRectangle      osdsrc;
+ 
+     try
+     {
+       bool dirtyLines[Yres];
+       tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
+       tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
+       //Osd->SetMode(Bpp,!OSDpseudo_alpha,(isVIAUnichrome) ? true:false);
+       Osd->CopyToBitmap(dst, pitch,
+                               Xres,Yres,RefreshAll,dirtyLines);
+       tmpSurface->Unlock();
+ 
+       /* ------------------------------------------------------------------------
+        * TODO: Have to get area coordinates in screen dimensions from Draw().
+        *       In case Draw() scales down, bitmap dirty area coordinates
+        *       could not be transformed the following way.
+        */
+       modArea.x1 = 0;
+       modArea.y1 = 0;
+       modArea.x2 = Xres;
+       modArea.y2 = Yres;
+ 
+       tmpSurface->Flip(&modArea,DSFLIP_WAIT);
+       osdsrc.x = modArea.x1;
+       osdsrc.y = modArea.y1;
+       osdsrc.w = modArea.x2 - modArea.x1 + 1;
+       osdsrc.h = modArea.y2 - modArea.y1 + 1;
+       tmpSurface->Blit(tmpSurface, &osdsrc, modArea.x1, modArea.y1);
+     }
+     catch (DFBException *ex)
+     {
+       fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
+                ex->GetAction(), ex->GetResult());
+       delete ex;
+     }
+ 
+ }
+ 	
  /* ---------------------------------------------------------------------------
   */
+ /*
  void cDFBVideoOut::Refresh(cBitmap *Bitmap)
  {
***************
*** 1055,1063 ****
        tmpSurface->Unlock();
  
-       /* ------------------------------------------------------------------------
-        * TODO: Have to get area coordinates in screen dimensions from Draw().
-        *       In case Draw() scales down, bitmap dirty area coordinates
-        *       could not be transformed the following way.
-        */
        modArea.x1 += OSDxOfs + Bitmap->X0();
        modArea.y1 += OSDyOfs + Bitmap->Y0();
--- 1101,1104 ----
***************
*** 1082,1086 ****
    }
  }
! 
  #else
  
--- 1123,1127 ----
    }
  }
! */
  #else
  
***************
*** 1294,1298 ****
                     Height - 2 * (cutTop + cutBottom),
                     Ystride, UVstride, pitch);
!     }
  
      videoSurface->Unlock();
--- 1335,1339 ----
                     Height - 2 * (cutTop + cutBottom),
                     Ystride, UVstride, pitch);
!      }
  
      videoSurface->Unlock();

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-dfb.h	6 Nov 2005 17:56:06 -0000	1.12
--- video-dfb.h	7 Jan 2006 14:28:39 -0000	1.13
***************
*** 56,61 ****
  
  #if VDRVERSNUM >= 10307
!     virtual void OpenOSD(int x, int y);
!     virtual void Refresh(cBitmap *Bitmap);
      virtual void OSDStart();
      virtual void OSDCommit();
--- 56,62 ----
  
  #if VDRVERSNUM >= 10307
!     virtual void OpenOSD(int x, int y, cSoftOsd *Osd);
! //    virtual void Refresh(cBitmap *Bitmap);
!     virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
      virtual void OSDStart();
      virtual void OSDCommit();

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-vidix.c	23 Jul 2005 20:14:31 -0000	1.12
--- video-vidix.c	7 Jan 2006 14:28:39 -0000	1.13
***************
*** 14,17 ****
--- 14,18 ----
  #include "utils.h"
  #include "setup-softdevice.h"
+ #include "SoftOsd.h"
  
  //#define TIMINGS
***************
*** 584,595 ****
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::Refresh(cBitmap *Bitmap)
  {
      switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!               Draw(Bitmap, fb,fb_line_len);
              break;
        case OSDMODE_SOFTWARE:
!               ToYUV(Bitmap);
              break;
      }
--- 585,598 ----
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::Refresh(cSoftOsd *Osd,bool RefreshAll)
  {
      switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!               Osd->CopyToBitmap(fb,fb_line_len,OsdWidth,OsdHeight,RefreshAll);
              break;
        case OSDMODE_SOFTWARE:
!               Osd->CopyToBitmap(OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV,
! 			      OSD_FULL_WIDTH,OSD_FULL_WIDTH/2,
! 			      OsdWidth,OsdHeight,RefreshAll);
              break;
      }

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-vidix.h	23 Jul 2005 20:14:32 -0000	1.5
--- video-vidix.h	7 Jan 2006 14:28:39 -0000	1.6
***************
*** 47,52 ****
  #if VDRVERSNUM >= 10307
    virtual void ClearOSD();
-   virtual void Refresh(cBitmap *Bitmap);
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight); 
  #else
    virtual void Refresh();
--- 47,57 ----
  #if VDRVERSNUM >= 10307
    virtual void ClearOSD();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight); 
+   virtual void GetOSDMode(int &Depth,bool &HasAlpha, bool &AlphaInversed,
+ 		  bool &IsYUV,uint8_t *&PixelMask)
+   { Depth=Bpp; HasAlpha=false;AlphaInversed=false; 
+ 	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
+ 	  PixelMask=NULL;};
+   virtual void Refresh(cSoftOsd *Osd,bool RefreshAll=false);
  #else
    virtual void Refresh();



From nobody at sheep.berlios.de  Sun Jan  8 10:43:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 8 Jan 2006 10:43:34 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.135,1.136 video-dfb.c,1.43,1.44 video-dfb.h,1.13,1.14
Message-ID: <200601080943.k089hYH26363@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23910

Modified Files:
	CHANGELOG video-dfb.c video-dfb.h 
Log Message:
- updated video-dfb for the new OSD. Fix double buffered displays and set
  OSD mode correctly



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.135
retrieving revision 1.136
diff -C2 -d -r1.135 -r1.136
*** CHANGELOG	7 Jan 2006 14:28:39 -0000	1.135
--- CHANGELOG	8 Jan 2006 09:43:31 -0000	1.136
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-01-08:
+     - updated video-dfb for the new OSD. Double buffered displays should
+       work now as well and the OSD mode is set properly
  2006-01-07:
      - completely rewritten OSD. Supports up- and down-scaleing in MMX

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** video-dfb.c	7 Jan 2006 14:28:39 -0000	1.43
--- video-dfb.c	8 Jan 2006 09:43:32 -0000	1.44
***************
*** 1042,1046 ****
      uint8_t           *dst;
      IDirectFBSurface  *tmpSurface;
-     DFBRegion         modArea;
      DFBRectangle      osdsrc;
  
--- 1042,1045 ----
***************
*** 1048,1074 ****
      {
        bool dirtyLines[Yres];
        tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
        tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
-       //Osd->SetMode(Bpp,!OSDpseudo_alpha,(isVIAUnichrome) ? true:false);
        Osd->CopyToBitmap(dst, pitch,
                                Xres,Yres,RefreshAll,dirtyLines);
        tmpSurface->Unlock();
  
!       /* ------------------------------------------------------------------------
!        * TODO: Have to get area coordinates in screen dimensions from Draw().
!        *       In case Draw() scales down, bitmap dirty area coordinates
!        *       could not be transformed the following way.
!        */
!       modArea.x1 = 0;
!       modArea.y1 = 0;
!       modArea.x2 = Xres;
!       modArea.y2 = Yres;
  
!       tmpSurface->Flip(&modArea,DSFLIP_WAIT);
!       osdsrc.x = modArea.x1;
!       osdsrc.y = modArea.y1;
!       osdsrc.w = modArea.x2 - modArea.x1 + 1;
!       osdsrc.h = modArea.y2 - modArea.y1 + 1;
!       tmpSurface->Blit(tmpSurface, &osdsrc, modArea.x1, modArea.y1);
      }
      catch (DFBException *ex)
--- 1047,1080 ----
      {
        bool dirtyLines[Yres];
+       memset(dirtyLines,false,sizeof(dirtyLines));
+ 
        tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
        tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
        Osd->CopyToBitmap(dst, pitch,
                                Xres,Yres,RefreshAll,dirtyLines);
        tmpSurface->Unlock();
  
!       tmpSurface->Flip();
!               
!       int miny=0;
!       int maxy=0;
!       do {
!               while (!dirtyLines[miny] && miny <= Yres)
!                       miny++;
  
!               maxy=miny;
!               while (dirtyLines[maxy] && maxy<=Yres)
!                       maxy++;
!     
!               osdsrc.x = 0;
!               osdsrc.y = miny;
!               osdsrc.w = Xres;
!               osdsrc.h = maxy-miny + 1;
!               tmpSurface->Blit(tmpSurface,&osdsrc,0,miny);
!               
!               miny=maxy;
!              
!       } while ( miny<=Yres);
!       
      }
      catch (DFBException *ex)

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-dfb.h	7 Jan 2006 14:28:39 -0000	1.13
--- video-dfb.h	8 Jan 2006 09:43:32 -0000	1.14
***************
*** 59,62 ****
--- 59,66 ----
  //    virtual void Refresh(cBitmap *Bitmap);
      virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
+     virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
+                   bool &IsYUV, uint8_t *&PixelMask) 
+     { Depth=Bpp; HasAlpha=!OSDpseudo_alpha; AlphaInversed=isVIAUnichrome;
+             IsYUV=false;PixelMask=NULL;}
      virtual void OSDStart();
      virtual void OSDCommit();



From nobody at sheep.berlios.de  Sun Jan  8 15:23:00 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 8 Jan 2006 15:23:00 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.136,1.137 SoftOsd.c,1.1,1.2
Message-ID: <200601081423.k08EN0H04403@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16743

Modified Files:
	CHANGELOG SoftOsd.c 
Log Message:
- fix segfault in cSoftOsd for lines longer than 1024



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.136
retrieving revision 1.137
diff -C2 -d -r1.136 -r1.137
*** CHANGELOG	8 Jan 2006 09:43:31 -0000	1.136
--- CHANGELOG	8 Jan 2006 14:22:57 -0000	1.137
***************
*** 1,6 ****
  Changelog
  2006-01-08:
      - updated video-dfb for the new OSD. Double buffered displays should
!       work now as well and the OSD mode is set properly
  2006-01-07:
      - completely rewritten OSD. Supports up- and down-scaleing in MMX
--- 1,7 ----
  Changelog
  2006-01-08:
+     - fix segfault in cSoftOsd for lines longer than 1024
      - updated video-dfb for the new OSD. Double buffered displays should
! work now as well and the OSD mode is set properly
  2006-01-07:
      - completely rewritten OSD. Supports up- and down-scaleing in MMX

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** SoftOsd.c	7 Jan 2006 14:29:35 -0000	1.1
--- SoftOsd.c	8 Jan 2006 14:22:57 -0000	1.2
***************
*** 640,644 ****
  	
  	cMutexLock dirty(&dirty_Mutex);
! 	const int dest_stride=1056;
  	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
--- 640,644 ----
  	
  	cMutexLock dirty(&dirty_Mutex);
! 	const int dest_stride=dest_Width+16;
  	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
***************
*** 789,792 ****
--- 789,793 ----
                                  scaleH_Reference,dest_Width);
                  buf=dest+y*linesize;
+                 //printf("copy to destination %d\n",y);
                  (*OutputConvert)(buf,tmp_pixmap,dest_Width);
                  if (pixelMask)



From nobody at sheep.berlios.de  Mon Jan  9 21:26:05 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 9 Jan 2006 21:26:05 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.137,1.138 SoftOsd.c,1.2,1.3 SoftOsd.h,1.1,1.2
Message-ID: <200601092026.k09KQ5H20277@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16387

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
- add missing sanity check in cSoftOsd::DrawConvertBitmap()



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.137
retrieving revision 1.138
diff -C2 -d -r1.137 -r1.138
*** CHANGELOG	8 Jan 2006 14:22:57 -0000	1.137
--- CHANGELOG	9 Jan 2006 20:26:02 -0000	1.138
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-01-09:
+     - add missing sanity check in cSoftOsd::DrawConvertBitmap()
  2006-01-08:
      - fix segfault in cSoftOsd for lines longer than 1024

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** SoftOsd.c	8 Jan 2006 14:22:57 -0000	1.2
--- SoftOsd.c	9 Jan 2006 20:26:02 -0000	1.3
***************
*** 212,215 ****
--- 212,220 ----
  	y2++;
  	x2++;
+         y2= yOfs+y2+bitmap->Y0() > OSD_HEIGHT ? 
+                 OSD_HEIGHT-bitmap->Y0()-yOfs : y2;
+         x2= xOfs+x2+bitmap->X0() > OSD_WIDTH ? 
+                 OSD_WIDTH-bitmap->X0()-xOfs : x2;
+         
  	int bitmap_yOfs=yOfs+bitmap->Y0()+Y_OFFSET;
  	uint32_t *OSD_pointer=&OSD_Bitmap[(bitmap_yOfs+y1)*OSD_STRIDE+
***************
*** 217,221 ****
          int missing_line_length=OSD_STRIDE-(x2-x1);
          bool *dirty_line=&dirty_lines[bitmap_yOfs+y1];
! 	for (int y=y1; y<y2; y++) {
  		for (int x=x1; x<x2; x++) {
  			*(OSD_pointer++)=palette[*bitmap->Data(x,y)];
--- 222,227 ----
          int missing_line_length=OSD_STRIDE-(x2-x1);
          bool *dirty_line=&dirty_lines[bitmap_yOfs+y1];
! 
!         for (int y=y1; y<y2; y++) {
  		for (int x=x1; x<x2; x++) {
  			*(OSD_pointer++)=palette[*bitmap->Data(x,y)];

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** SoftOsd.h	7 Jan 2006 14:29:35 -0000	1.1
--- SoftOsd.h	9 Jan 2006 20:26:02 -0000	1.2
***************
*** 58,62 ****
      int xOfs,yOfs;
      uint32_t *OSD_Bitmap;
!     bool dirty_lines[OSD_STRIDE];
      cMutex dirty_Mutex;
      
--- 58,62 ----
      int xOfs,yOfs;
      uint32_t *OSD_Bitmap;
!     bool dirty_lines[OSD_HEIGHT+10];
      cMutex dirty_Mutex;
      



From nobody at sheep.berlios.de  Tue Jan 10 20:40:29 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 10 Jan 2006 20:40:29 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.138,1.139 video-dfb.c,1.44,1.45
Message-ID: <200601101940.k0AJeTH08811@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6045

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
- fix error message from DirectFB about wrong blitting area when useing the 
  new OSD



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.138
retrieving revision 1.139
diff -C2 -d -r1.138 -r1.139
*** CHANGELOG	9 Jan 2006 20:26:02 -0000	1.138
--- CHANGELOG	10 Jan 2006 19:40:25 -0000	1.139
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-01-10:
+    - fix error message from DirectFB about wrong blitting area with new OSD
  2006-01-09:
      - add missing sanity check in cSoftOsd::DrawConvertBitmap()

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** video-dfb.c	8 Jan 2006 09:43:32 -0000	1.44
--- video-dfb.c	10 Jan 2006 19:40:25 -0000	1.45
***************
*** 1060,1070 ****
        int maxy=0;
        do {
!               while (!dirtyLines[miny] && miny <= Yres)
                        miny++;
  
                maxy=miny;
!               while (dirtyLines[maxy] && maxy<=Yres)
                        maxy++;
!     
                osdsrc.x = 0;
                osdsrc.y = miny;
--- 1060,1073 ----
        int maxy=0;
        do {
!               while (!dirtyLines[miny] && miny < Yres)
                        miny++;
  
+ 	      if (miny >= Yres)
+ 		      break;
+ 
                maxy=miny;
!               while (dirtyLines[maxy] && maxy < Yres)
                        maxy++;
! 	      
                osdsrc.x = 0;
                osdsrc.y = miny;
***************
*** 1075,1079 ****
                miny=maxy;
               
!       } while ( miny<=Yres);
        
      }
--- 1078,1082 ----
                miny=maxy;
               
!       } while ( miny<Yres);
        
      }



From nobody at sheep.berlios.de  Sun Jan 15 21:41:19 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 15 Jan 2006 21:41:19 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.139,1.140 video-fb.c,1.10,1.11 audio-ac3pt.c,1.1,1.2 SoftOsd.c,1.3,1.4 Makefile,1.20,1.21 video-xv.c,1.36,1.37
Message-ID: <200601152041.k0FKfJx00372@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8238

Modified Files:
	CHANGELOG video-fb.c audio-ac3pt.c SoftOsd.c Makefile 
	video-xv.c 
Log Message:
- fix AMD64 builds (patch by Janne Huttunen)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.139
retrieving revision 1.140
diff -C2 -d -r1.139 -r1.140
*** CHANGELOG	10 Jan 2006 19:40:25 -0000	1.139
--- CHANGELOG	15 Jan 2006 20:41:14 -0000	1.140
***************
*** 1,9 ****
--- 1,13 ----
  Changelog
+ 2006-01-15:
+    - fix for AMD64 builds (patch by Janne Huttunen, many thanks to him)
  2006-01-10:
     - fix error message from DirectFB about wrong blitting area with new OSD
  2006-01-09:
      - add missing sanity check in cSoftOsd::DrawConvertBitmap()
+       (many thanks to Andre Neumann for reporting the problem)
  2006-01-08:
      - fix segfault in cSoftOsd for lines longer than 1024
+       (thanks to Andre Neumann for reporting the problem)
      - updated video-dfb for the new OSD. Double buffered displays should
  work now as well and the OSD mode is set properly

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-fb.c	7 Jan 2006 14:28:39 -0000	1.10
--- video-fb.c	15 Jan 2006 20:41:14 -0000	1.11
***************
*** 136,140 ****
      OSDpresent=false;
  
!     printf("[video-fb] init %d x %d (Size: %d Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
      // clear screens
      printf("[video-fb] Clearing the FB\n");
--- 136,140 ----
      OSDpresent=false;
  
!     printf("[video-fb] init %d x %d (Size: %zu Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
      // clear screens
      printf("[video-fb] Clearing the FB\n");

Index: audio-ac3pt.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-ac3pt.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** audio-ac3pt.c	6 Oct 2005 21:16:47 -0000	1.1
--- audio-ac3pt.c	15 Jan 2006 20:41:15 -0000	1.2
***************
*** 19,23 ****
  #include "audio-ac3pt.h"
  
! enum {SPDIF_CON, SPDIF_PRO} spdif_t;
  
  
--- 19,23 ----
  #include "audio-ac3pt.h"
  
! typedef enum {SPDIF_CON, SPDIF_PRO} spdif_t;
  
  

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** SoftOsd.c	9 Jan 2006 20:26:02 -0000	1.3
--- SoftOsd.c	15 Jan 2006 20:41:15 -0000	1.4
***************
*** 324,328 ****
  #endif
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((int)dest) & 0x4) ) {
                          dest[0] = 0; dest[1] = 0; dest[2] = 0; dest[3] = 0x00;
                          // color key!
--- 324,328 ----
  #endif
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)dest) & 0x4) ) {
                          dest[0] = 0; dest[1] = 0; dest[2] = 0; dest[3] = 0x00;
                          // color key!
***************
*** 473,477 ****
  #endif
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((int)dest) & 0x2) ) {
                          dest[0] = 0x0; dest[1] = 0x0; // color key!
                  } else {
--- 473,477 ----
  #endif
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)dest) & 0x2) ) {
                          dest[0] = 0x0; dest[1] = 0x0; // color key!
                  } else {
***************
*** 491,495 ****
  	int PixelCount=0;
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((int)pixmap) & 0x4)
  				|| IS_TRANSPARENT(pixmap->a) ) {
                          // transparent, don't draw anything !
--- 491,495 ----
  	int PixelCount=0;
          while (end_dest>dest) {
!                 if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)pixmap) & 0x4)
  				|| IS_TRANSPARENT(pixmap->a) ) {
                          // transparent, don't draw anything !
***************
*** 510,514 ****
  	int CurrPixel=0;
          while (CurrPixel<Pixel) {
!                 if ( (IS_BACKGROUND(pixmap->a) && !(((int)pixmap) & 0x4)  )
                                  || IS_OPAQUE(pixmap->a) ) 
                          dest[CurrPixel/8]|=(1<<CurrPixel%8);
--- 510,514 ----
  	int CurrPixel=0;
          while (CurrPixel<Pixel) {
!                 if ( (IS_BACKGROUND(pixmap->a) && !(((intptr_t)pixmap) & 0x4)  )
                                  || IS_OPAQUE(pixmap->a) ) 
                          dest[CurrPixel/8]|=(1<<CurrPixel%8);

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** Makefile	7 Jan 2006 14:28:39 -0000	1.20
--- Makefile	15 Jan 2006 20:41:15 -0000	1.21
***************
*** 185,189 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -Woverloaded-virtual
  
  ### The directory environment:
--- 185,189 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual
  
  ### The directory environment:

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** video-xv.c	7 Jan 2006 14:28:39 -0000	1.36
--- video-xv.c	15 Jan 2006 20:41:15 -0000	1.37
***************
*** 1026,1030 ****
              if (!strcmp(encodingInfo[n].name, "XV_IMAGE"))
              {
!               fprintf(stderr, "[XvVideoOut]: max area size %d x %d\n",
                        encodingInfo[n].width, encodingInfo[n].height);
                dsyslog("[XvVideoOut]: max area size %lu x %lu",
--- 1026,1030 ----
              if (!strcmp(encodingInfo[n].name, "XV_IMAGE"))
              {
!               fprintf(stderr, "[XvVideoOut]: max area size %lu x %lu\n",
                        encodingInfo[n].width, encodingInfo[n].height);
                dsyslog("[XvVideoOut]: max area size %lu x %lu",



From nobody at sheep.berlios.de  Sun Jan 15 22:11:28 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 15 Jan 2006 22:11:28 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.38,1.39 video.h,1.24,1.25 CHANGELOG,1.140,1.141
Message-ID: <200601152111.k0FLBSx01463@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12236

Modified Files:
	video.c video.h CHANGELOG 
Log Message:
- compile fix for vdr-1.2.6


Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** video.c	7 Jan 2006 14:28:39 -0000	1.38
--- video.c	15 Jan 2006 21:11:25 -0000	1.39
***************
*** 28,31 ****
--- 28,32 ----
    OsdWidth=OSD_FULL_WIDTH;
    OsdHeight=OSD_FULL_HEIGHT;
+   osd=NULL;
  #endif
    // set some reasonable defaults
***************
*** 41,45 ****
    PixelMask=NULL;
    OsdRefreshCounter=0;
-   osd=NULL;
    displayTimeUS = 0;
    this->setupStore=setupStore;
--- 42,45 ----

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** video.h	7 Jan 2006 14:28:39 -0000	1.24
--- video.h	15 Jan 2006 21:11:25 -0000	1.25
***************
*** 206,209 ****
--- 206,210 ----
  
      cWindowLayer *layer[MAXNUMWINDOWS];
+     virtual void OpenOSD(int X, int Y);
      virtual bool OpenWindow(cWindow *Window);
      virtual void CommitWindow(cWindow *Window);

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.140
retrieving revision 1.141
diff -C2 -d -r1.140 -r1.141
*** CHANGELOG	15 Jan 2006 20:41:14 -0000	1.140
--- CHANGELOG	15 Jan 2006 21:11:25 -0000	1.141
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-01-15:
+    - compile fix for vdr-1.2.6
     - fix for AMD64 builds (patch by Janne Huttunen, many thanks to him)
  2006-01-10:



From nobody at sheep.berlios.de  Tue Jan 17 21:45:48 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 17 Jan 2006 21:45:48 +0100
Subject: [Softdevice-cvs] softdevice ShmClient.c,NONE,1.1 shm-common.h,NONE,1.1 video-shm.c,NONE,1.1 video-shm.h,NONE,1.1 setup-softdevice-menu.c,NONE,1.1 CHANGELOG,1.141,1.142 README,1.11,1.12 setup-softdevice.c,1.39,1.40 setup-softdevice.h,1.24,1.25 Makefile,1.21,1.22 softdevice.c,1.50,1.51 video.c,1.39,1.40 video.h,1.25,1.26
Message-ID: <200601172045.k0HKjmx31719@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8595

Modified Files:
	CHANGELOG README setup-softdevice.c setup-softdevice.h 
	Makefile softdevice.c video.c video.h 
Added Files:
	ShmClient.c shm-common.h video-shm.c video-shm.h 
	setup-softdevice-menu.c 
Log Message:
- add video-shm and ShmClient, a simple server/client model for the 
  softdevice. See the file README for details.   



--- NEW FILE: ShmClient.c ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: ShmClient.c,v 1.1 2006/01/17 20:45:46 wachm Exp $
 */

#include <signal.h>

#include "video-xv.h"
#include "shm-common.h"
#include "vdr/keys.h"
#include "utils.h"

#define SHMDEB(out...) {printf("SHMCLIENT[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}

#ifndef SHMDEB
#define SHMDEB(out...)
#endif

ShmCtlBlock * ctl;
bool active=true;

void sig_handler(int signal) {
        printf("got signal, ending\n");
        active=false;
};

class cShmXvRemote : public cXvRemote {
        public:  
                cShmXvRemote(const char *Name, cXvVideoOut *vout)
                        : cXvRemote(Name,vout) 
                        {};
                        
                ~cShmXvRemote()
                {};

                virtual void   PutKey (KeySym key);
};

void cShmXvRemote::PutKey(KeySym key) {
        if (ctl) 
        {
                SHMDEB("get lock for the key\n");
                sem_wait_lock(ctl->semid,KEY_MUT);
                SHMDEB("got lock for the key\n");
                
                ctl->key=(uint64_t) key;

                // release lock
                sem_sig_unlock(ctl->semid,KEY_MUT);
                // signal new key
                sem_sig_unlock(ctl->semid,KEY_SIG);
                SHMDEB("signal new key\n");
        };

};

int main(int argc, char **argv) {
        cSetupStore SetupStore;
        cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
        xvRemote= new cShmXvRemote ("softdevice-xv",vout);
        
        signal(SIGINT,sig_handler);
        signal(SIGQUIT,sig_handler);
        
        int ctl_shmid;
        key_t ctl_key=CTL_KEY;
 
        int curr_pict_shmid;
        uint8_t *curr_pict;
        uint8_t *pixel[4];
       
        if ((ctl_shmid = shmget(ctl_key, sizeof( ShmCtlBlock ), 0666)) < 0) {
                fprintf(stderr,"ctl_shmid error in shmget!\n");
                exit(1);
        }
        
        if ( (ctl = (ShmCtlBlock *)shmat(ctl_shmid,NULL,0)) 
                        == (ShmCtlBlock *) -1 ) {
                fprintf(stderr,"ctl_shmid error attatching shm ctl!\n");
                exit(-1);
        };

        
        // create a picture in shm
        ctl->max_width=736;
        ctl->max_height=576;
        ctl->stride0=ctl->max_width;
        ctl->stride2=ctl->stride1=ctl->max_width/2;
        
        if ( (ctl->pict_shmid = shmget(IPC_PRIVATE,
                          ctl->max_width*ctl->max_height*2, 
                          IPC_CREAT | 0666)) < 0 ) {
                fprintf(stderr,"error creating  pict_shm!\n");
                exit(-1);
        };
        
        if ( (curr_pict = (uint8_t*)shmat(ctl->pict_shmid,NULL,0)) 
                        == (uint8_t*) -1 ) {
                fprintf(stderr,"error attatching shm ctl!\n");
                exit(-1);
        };

        // request removeing after detaching
        if ( ctl->pict_shmid > 0)
                shmctl (ctl->pict_shmid, IPC_RMID, 0);
 
        pixel[0]=curr_pict;
        pixel[1]=curr_pict+ctl->height*ctl->stride0;
        pixel[2]=pixel[1]+ctl->height/2*ctl->stride1;

        ctl->attached=1;
        
        if ( !vout->Initialize() || !vout->Reconfigure(FOURCC_YV12) ) {
                fprintf(stderr,"Could not init video out!\n");
                exit(-1);
        };
        xvRemote->XvRemoteStart();
        
                
        ctl->key=NO_KEY;
        // wakeup remote thread to unsuspend video/audio
        sem_sig_unlock(ctl->semid,KEY_SIG);

        while (active) {
                //SHMDEB("wait for signal\n");
                sem_wait_lock(ctl->semid,PICT_SIG);
                //SHMDEB("got signal\n");
                sem_wait_lock(ctl->semid,PICT_MUT,SEM_UNDO);
                //SHMDEB("got lock\n");
                
                int width=ctl->width>ctl->max_width?ctl->max_width:ctl->width;
                int height=ctl->height>ctl->max_height?
                        ctl->max_height:ctl->height;

                vout->CheckArea(width,height);
                vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                vout->YUV(pixel[0],pixel[1],pixel[2],
                                width,height,
                                ctl->stride0,ctl->stride1);
                ctl->new_pict=0;
                
                // consumed all pictures - set semaphore to 0
                sem_zero(ctl->semid,PICT_SIG);
                // unlock picture ctl
                sem_sig_unlock(ctl->semid,PICT_MUT,SEM_UNDO);
                //SHMDEB("released the lock\n");
                
        };
        ctl->attached=0;
        ctl->pict_shmid=-1;
};


--- NEW FILE: shm-common.h ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: shm-common.h,v 1.1 2006/01/17 20:45:46 wachm Exp $
 */
#ifndef __SHM_COMMON_H__
#define __SHM_COMMON_H__


#include <sys/types.h>
#include <sys/ipc.h> 
#include <sys/shm.h> 
#include <sys/sem.h> 

#include "vdr/keys.h"

#define CTL_KEY 5678 

union semun {
        int val;                  
        struct semid_ds *buf;     
        unsigned short *array;    
};


#define PICT_SIG 0
#define PICT_MUT 1

#define KEY_SIG 2
#define KEY_MUT 3

#define NO_KEY 0x000000

struct ShmCtlBlock {
        /* semaphores */
        int semid;
        
        /* picture control */
        int pict_shmid;
        
        int max_width;
        int max_height;        
        int width;
        int height;
        int new_afd;
        double new_asp;
        int stride0;
        int stride1;
        int stride2;
        int new_pict;
        
        /* is a client attached */
        int attached;

        /* keypress events */
        uint64_t key;
};

inline void sem_wait_lock(int semid, int idx, int flag=0) 
{
        struct sembuf sem_op = { idx, -1, flag };
        
        semop(semid, &sem_op,1);
};

inline void sem_sig_unlock(int semid, int idx,int flag=0) 
{
        struct sembuf sem_op = { idx, 1, flag };
        
        semop(semid, &sem_op,1);
};
 
inline void sem_zero(int semid,int idx) {
        semun sem_val;
        sem_val.val = 0; 
        semctl(semid,idx, SETVAL, sem_val);
};

#endif // SHM_COMMON

--- NEW FILE: video-shm.c ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: video-shm.c,v 1.1 2006/01/17 20:45:46 wachm Exp $
 */

#include "video-shm.h"
#include "utils.h"
#include "SoftOsd.h"

#define SHMDEB(out...) {printf("SHMSERV[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}

#ifndef SHMDEB
#define SHMDEB(out...)
#endif
  
cShmRemote::~cShmRemote(){
        SHMDEB("~cShmRemote\n");
        Stop();
        SHMDEB("~cShmRemote returned from cancel\n");
};

void cShmRemote::Action(void) {
        while (active) {
                SHMDEB("cShmRemote trying to get a lock\n");
                sem_wait_lock(vout->ctl->semid,KEY_MUT);
                SHMDEB("cShmRemote got lock\n");
                
                if (!vout->ctl->attached) {
                        vout->setupStore->shouldSuspend=1;
                } else vout->setupStore->shouldSuspend=0;
            
                if (vout->ctl->key!=NO_KEY) {
                        SHMDEB("cShmRemote put key\n");
                        // put and clear
                        Put(vout->ctl->key);
                        vout->ctl->key=NO_KEY;
                };
                        
                // clear signal
                sem_zero(vout->ctl->semid,KEY_SIG);
                // release lock
                sem_sig_unlock(vout->ctl->semid,KEY_MUT);

                SHMDEB("wait for a new key\n");
                sem_wait_lock(vout->ctl->semid,KEY_SIG);
        };
        SHMDEB("ShmRemote thread ended\n");
};


/*----------------------------------------------------------------------------*/
cShmVideoOut::cShmVideoOut(cSetupStore *setupStore) 
        : cVideoOut(setupStore) {
        ctl_key = CTL_KEY;
        bool Clear_Ctl=false;

        // first try to get an existing ShmCltBlock
        if  ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 0666)) >= 0 ) {
                fprintf(stderr,"got ctl_shmid %d shm ctl!\n",ctl_shmid);
        } else if ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 
                                        IPC_CREAT | 0666)) >= 0 ) {
                fprintf(stderr,"created ctl_shmid %d shm ctl!\n",ctl_shmid);
                // created ShmCltBlock, clear it
                Clear_Ctl=true;
        } else {
                fprintf(stderr,"error creating shm ctl!\n");
                exit(-1);
        };

        // attach to the control block
        if ( (ctl = (ShmCtlBlock*)shmat(ctl_shmid,NULL,0)) 
                        == (ShmCtlBlock*) -1 ) {
                fprintf(stderr,"error attatching shm ctl!\n");
                exit(-1);
        };

        if (Clear_Ctl) {
                ctl->semid=-1;
                ctl->pict_shmid=-1;
                ctl->attached = 0;
        };

        if ( ctl->semid == -1 ) {
                // create semaphores
                if ( (ctl->semid = semget(IPC_PRIVATE, 4, 0666 | IPC_CREAT) )
                                == -1) {
                        fprintf(stderr,"error creating semaphore set!\n");
                        exit(-1);
                };
                printf("created semaphores id %d\n",ctl->semid);
        };

        semun sem_val;
        sem_val.val = 0; // nothing available
        if ( semctl(ctl->semid,PICT_SIG, SETVAL, sem_val) == -1 ) {
                printf("error resetting semaphore PICT_SIG\n");
                exit(-1);
        };
        if ( semctl(ctl->semid,KEY_SIG,SETVAL,sem_val) == -1 ) {
                printf("error resetting semaphore KEY_SIG\n");
                exit(-1);
        };
        
        sem_val.val = 1; // not locked
        if ( semctl(ctl->semid,PICT_MUT, SETVAL, sem_val) == -1 ) {
                printf("error resetting semaphore PICT_MUT\n");
                exit(-1);
        };
        if ( semctl(ctl->semid,KEY_MUT,SETVAL,sem_val) == -1 ) {
                printf("error resetting semaphore KEY_MUT\n");
                exit(-1);
        };
   
        curr_pict_shmid=0;
        //ctl->pict_shmid=-1;
        curr_pict=NULL;
        ctl->key=kNone;
        remote = new cShmRemote("softdevice-xv",this);
};

cShmVideoOut::~cShmVideoOut() {
        // stop&delete remote
        remote->Stop();
        
        semun sem_val;
        // remove semaphore 
        if ( semctl(ctl->semid, 0, IPC_RMID, sem_val ) == -1) {
            fprintf(stderr,"error removeing semaphore set!\n");
            exit(1);
        }
        ctl->semid=-1;
        
        if (curr_pict)
                shmdt(curr_pict);
        curr_pict=NULL;
/*
        if ( ctl_shmid > 0)
                shmctl (ctl_shmid, IPC_RMID, 0);
*/
};

void cShmVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
{
    if (current_osdMode==OSDMODE_SOFTWARE)
	    Osd->CopyToBitmap(OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
                            OSD_FULL_WIDTH,OSD_FULL_WIDTH/2,
			    OsdWidth,OsdHeight,RefreshAll);
};

void cShmVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
                     int Width, int Height, int Ystride, int UVstride) {
        OsdRefreshCounter=0; 

        if (!ctl->attached) {
                setupStore->shouldSuspend=1;
                return;
        } else setupStore->shouldSuspend=0;

        //SHMDEB("trying to get a lock\n");
        sem_wait_lock(ctl->semid,PICT_MUT);
        //SHMDEB("got a lock\n");
        
        if ( ctl->pict_shmid != curr_pict_shmid ) {
                if (curr_pict) {
                        shmdt(curr_pict);
                        curr_pict=NULL;
                };
                
                if ( ctl->pict_shmid != -1 ) {
                       if ( (curr_pict = (uint8_t *)shmat(ctl->pict_shmid,NULL,0)) 
                                       == (uint8_t*) -1 ) {
                               fprintf(stderr,"error attatching shm pict! Assumeing no client connected\n");
                               ctl->pict_shmid = -1;
                               ctl->attached = 0;
                               curr_pict=NULL;
                               sem_sig_unlock(ctl->semid,PICT_MUT);
                               return;
                       } 
                       pixels[0]=curr_pict;
                       pixels[1]=curr_pict+ctl->height*ctl->stride0;
                       pixels[2]=pixels[1]+ctl->height/2*ctl->stride1;
                       curr_pict_shmid=ctl->pict_shmid;
                };
        };

        
        if (!ctl->pict_shmid || !curr_pict) {
                // unlock picture ctl
                sem_sig_unlock(ctl->semid,PICT_MUT);
                SHMDEB(" no pict_shmid or no curr_pict unlock and return\n");
                return;
        };
      
        int width= ctl->max_width < Width ? ctl->max_width : Width;
        int height= ctl->max_height < Height ? ctl->max_height : Height;    
        
        ctl->width=fwidth;
        ctl->height=fheight;
        ctl->new_afd=current_afd;
        ctl->new_asp=GetAspect_F();
        if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
                
                for (int i = 0; i < height; i++)
                        AlphaBlend(pixels [0] + i * ctl->stride0,
                                       OsdPy+i*OSD_FULL_WIDTH,
                                       Py + i * Ystride,
                                       OsdPAlphaY+i*OSD_FULL_WIDTH,
                                       width );
                for (int i = 0; i < height / 2; i++)
                        AlphaBlend(pixels [1] + i * ctl->stride1,
                                        OsdPu+i*OSD_FULL_WIDTH/2,
                                        Pu + i * UVstride ,
                                        OsdPAlphaUV+i*OSD_FULL_WIDTH/2,
                                        width/2);
                for (int i = 0; i < height / 2 ; i++)
                        AlphaBlend(pixels [2] + i * ctl->stride2 ,
                                        OsdPv+i*OSD_FULL_WIDTH/2,
                                        Pv + i * UVstride,
                                        OsdPAlphaUV+i*OSD_FULL_WIDTH/2,
                                        width / 2);
        } else {
                
                for (int i = 0; i < height; i++)
                        fast_memcpy(pixels [0] + i * ctl->stride0,
                                        Py + i * Ystride,
                                        width );
                for (int i = 0; i < height / 2; i++)
                        fast_memcpy (pixels [1] + i * ctl->stride1,
                                        Pu + i * UVstride,
                                        width / 2);
                for (int i = 0; i < height / 2 ; i++)
                        fast_memcpy (pixels [2] + i * ctl->stride2 ,
                                        Pv + i * UVstride,
                                        width / 2);

        };
        ctl->new_pict++;
        if (ctl->new_pict>30) {
                printf("new_pict > 30; assueming client died!\n");
                ctl->attached=0;
        };
        sem_sig_unlock(ctl->semid,PICT_MUT);
        sem_sig_unlock(ctl->semid,PICT_SIG);
        //SHMDEB("send signal\n");
        
};

void cShmVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
   if (current_osdMode==OSDMODE_SOFTWARE) {
                OsdWidth=swidth;
                OsdHeight=sheight;
    };
};

#ifdef USE_SUBPLUGINS
/* ---------------------------------------------------------------------------
 */
extern "C" void *
SubPluginCreator(cSetupStore *s)
{
  return new cShmVideoOut(s);
}
#endif

--- NEW FILE: video-shm.h ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: video-shm.h,v 1.1 2006/01/17 20:45:46 wachm Exp $
 */

#ifndef __VIDEO_SHM_H__
#define __VIDEO_SHM_H__

#include "video.h"
#include "shm-common.h"

#include <sys/types.h>
#include <sys/ipc.h> 
#include <sys/shm.h> 
#include <sys/sem.h> 

#include <vdr/remote.h>

/*-------------------------------------------------------------------------*/
class cShmVideoOut : public cVideoOut {
        friend class cShmRemote;
        cShmRemote *remote;
        int ctl_shmid;
        key_t ctl_key;
        ShmCtlBlock * ctl;

        int curr_pict_shmid;
        uint8_t *curr_pict;
        uint8_t *pixels[4];

        public:
        cShmVideoOut(cSetupStore *setupStore);
        ~cShmVideoOut();
        void cShmVideoOut::RefreshOSD(cSoftOsd*, bool RefreshAll);
        
        virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
        
        virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                    bool &IsYUV, uint8_t *&PixelMask)
        { IsYUV=true; PixelMask=NULL;};

        virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
                     int Width, int Height, int Ystride, int UVstride);

};

/* ---------------------------------------------------------------------------
 */
class cShmRemote : public cRemote, private cThread {
  private:
    bool        active;
    cShmVideoOut *vout;

    virtual void Action(void);
  public:
          cShmRemote(const char *Name, cShmVideoOut *video_out) 
                  : cRemote(Name) {
                  vout=video_out;
                  active=true;
                  Start();
          };
          
          ~cShmRemote(); 
          
          void Stop()
          {
                  if (!vout || !active)
                          return;

                  active = false;
                  // signal new key to stop the thread from waiting
                  sem_sig_unlock(vout->ctl->semid,KEY_SIG);
        
                  Cancel(2);
                  vout=NULL;
          };

};

#endif // __VIDEO_SHM_H__

--- NEW FILE: setup-softdevice-menu.c ---
/*
 * setup-softdevice-menu.c
 *
 * See the README file for copyright information and how to reach the authors.
 *
 * $Id: setup-softdevice-menu.c,v 1.1 2006/01/17 20:45:46 wachm Exp $
 */

#include "video.h"
#include "setup-softdevice.h"

/* ---------------------------------------------------------------------------
 */
cMenuSetupVideoParm::cMenuSetupVideoParm(const char *name) : cOsdMenu(name, 33)
{
  copyData = setupStore;
  data = &setupStore;

  if (data->vidCaps & CAP_BRIGHTNESS)
  {
    Add(new cMenuEditIntItem(tr("Brightness"),
                             &data->vidBrightness,
                             0,
                             VID_MAX_PARM_VALUE));
  }
  if (data->vidCaps & CAP_CONTRAST)
  {
    Add(new cMenuEditIntItem(tr("Contrast"),
                             &data->vidContrast,
                             0,
                             VID_MAX_PARM_VALUE));
  }
  if (data->vidCaps & CAP_HUE)
  {
    Add(new cMenuEditIntItem(tr("Hue"),
                             &data->vidHue,
                             0,
                             VID_MAX_PARM_VALUE));
  }
  if (data->vidCaps & CAP_SATURATION)
  {
    Add(new cMenuEditIntItem(tr("Saturation"),
                             &data->vidSaturation,
                             0,
                             VID_MAX_PARM_VALUE));
  }
}

/* ---------------------------------------------------------------------------
 */
eOSState cMenuSetupVideoParm::ProcessKey(eKeys Key)
{
    eOSState state = cOsdMenu::ProcessKey(Key);

  switch (state)
  {
    case osUnknown:
      switch (Key)
      {
        case kOk:
          state = osBack;
          break;
        default:
          break;
      }
      break;
    case osBack:
      setupStore = copyData;
      fprintf (stderr, "[setup-videoparm] restoring setup state\n");
      break;
    default:
      break;
  }
  return state;
}

/* ---------------------------------------------------------------------------
 */
cMenuSetupCropping::cMenuSetupCropping(const char *name) : cOsdMenu(name, 33)
{
  copyData = setupStore;
  data = &setupStore;

  crop_str[0] = tr("none");
  Add(new cMenuEditStraItem(tr("CropMode"),
                            &data->cropMode,
                            SETUP_CROPMODES,
                            crop_str));

  userKeyUsage[0] = tr("none");
  Add(new cMenuEditStraItem(tr("CropModeToggleKey"),
                            &data->cropModeToggleKey,
                            (SETUP_USERKEYS-1),
                            userKeyUsage));

  if (data->outputMethod != VOUT_FB)
  {
#if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
#else
    Add(new cOsdItem(" ", osUnknown));
#endif

    Add(new cMenuEditIntItem(tr("Crop lines from top"),
                             &data->cropTopLines,
                             0,
                             MAX_CROP_LINES));

    Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
                             &data->cropBottomLines,
                             0,
                             MAX_CROP_LINES));
  }

  if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_DFB)
  {
    Add(new cMenuEditIntItem(tr("Crop columns from left"),
                             &data->cropLeftCols,
                             0,
                             MAX_CROP_COLS));
    Add(new cMenuEditIntItem(tr("Crop columns from right"),
                             &data->cropRightCols,
                             0,
                             MAX_CROP_COLS));
  }
}

/* ---------------------------------------------------------------------------
 */
eOSState cMenuSetupCropping::ProcessKey(eKeys Key)
{
    eOSState state = cOsdMenu::ProcessKey(Key);

  switch (state)
  {
    case osUnknown:
      switch (Key)
      {
        case kOk:
          state = osBack;
          break;
        default:
          break;
      }
      break;
    case osBack:
      setupStore = copyData;
      fprintf (stderr, "[setup-cropping] restoring setup state\n");
      break;
    default:
      break;
  }
  return state;
}

/* ---------------------------------------------------------------------------
 */
cMenuSetupPostproc::cMenuSetupPostproc(const char *name) : cOsdMenu(name, 33)
{
  copyData = setupStore;
  data = &setupStore;

  deint_str[0] = tr("none");
  if (data->outputMethod == VOUT_FB)
  {
    Add(new cMenuEditStraItem(tr("Deinterlace Method"),
                              &data->deintMethod,
#ifdef PP_LIBAVCODEC
                              8,
#else
                              3,
#endif //PP_LIBAVCODEC
                              deint_str));
  }
  else
  {
    Add(new cMenuEditStraItem(tr("Deinterlace Method"),
                              &data->deintMethod,
#ifdef PP_LIBAVCODEC
                              7,
#else
                              2,
#endif //PP_LIBAVCODEC
                              deint_str));
  }

#ifdef PP_LIBAVCODEC
  pp_str[0] = tr("none");
  pp_str[1] = tr("fast");
  pp_str[2] = tr("default");
  Add(new cMenuEditStraItem(tr("Postprocessing Method"),
                              &data->ppMethod,(SETUP_PPMODES-1),pp_str));
  Add(new cMenuEditIntItem(tr("Postprocessing Quality"),
                              &data->ppQuality,0,6));
#endif

  Add(new cMenuEditBoolItem(tr("Picture mirroring"),
                            &data->mirror, tr("off"), tr("on")));

}

/* ---------------------------------------------------------------------------
 */
eOSState cMenuSetupPostproc::ProcessKey(eKeys Key)
{
    eOSState state = cOsdMenu::ProcessKey(Key);

  switch (state)
  {
    case osUnknown:
      switch (Key)
      {
        case kOk:
          state = osBack;
          break;
        default:
          break;
      }
      break;
    case osBack:
      setupStore = copyData;
      fprintf (stderr, "[setup-postproc] restoring setup state\n");
      break;
    default:
      break;
  }
  return state;
}

/* ---------------------------------------------------------------------------
 */
cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
{
  if (plugin)
    SetPlugin(plugin);

  copyData = setupStore;
  data = &setupStore;

  Add(new cOsdItem(tr("Cropping")));
  Add(new cOsdItem(tr("Post processing")));

  if (data->vidCaps)
  {
    Add(new cOsdItem(tr("Video out")));
  }

#if VDRVERSNUM >= 10334
  Add(new cOsdItem(" ", osUnknown, false));
#else
  Add(new cOsdItem(" ", osUnknown));
#endif

  if (data->outputMethod == VOUT_XV)
  {
    xv_startup_aspect[0] = tr("16:9 wide");
    xv_startup_aspect[1] = tr("4:3 normal");
    Add(new cMenuEditStraItem(tr("Xv startup aspect"),
                             &data->xvAspect,
                             (SETUP_XVSTARTUPASPECT-1),
                             xv_startup_aspect));
  }

  videoAspectNames[0] = tr("default");
  Add(new cMenuEditStraItem(tr("Screen Aspect"),
                            &data->screenPixelAspect,
                            (SETUP_VIDEOASPECTNAMES-1),
                            videoAspectNames));

  osdModeNames[0] = tr("pseudo");
  osdModeNames[1] = tr("software");
  Add(new cMenuEditStraItem(tr("OSD alpha blending"),
                            &data->osdMode,
                            (SETUP_OSDMODES-1),
                            osdModeNames));

#if VDRVERSNUM >= 10334
  Add(new cOsdItem(" ", osUnknown, false));
#else
  Add(new cOsdItem(" ", osUnknown));
#endif

  bufferModes[0] = tr("safe");
  bufferModes[1] = tr("good seeking");
  bufferModes[2] = tr("HDTV");
  Add(new cMenuEditStraItem(tr("Buffer Mode"),
                              &data->bufferMode,(SETUP_BUFFERMODES-1),bufferModes));

  suspendVideo[0] = tr("playing");
  suspendVideo[1] = tr("suspended");
  Add(new cMenuEditStraItem(tr("Playback"),
                            &data->shouldSuspend,
                            (SETUP_SUSPENDVIDEO-1),
                            suspendVideo));

#if VDRVERSNUM >= 10334
  Add(new cOsdItem(" ", osUnknown, false));
#else
  Add(new cOsdItem(" ", osUnknown));
#endif

  Add(new cMenuEditIntItem(tr("A/V Delay"),
                           &data->avOffset,
                           MINAVOFFSET, MAXAVOFFSET));

  Add(new cMenuEditStraItem(tr("AC3 Mode"),
                            &data->ac3Mode,
                            (SETUP_AC3MODENAMES-1),
                            ac3ModeNames));

  Add(new cMenuEditStraItem(tr("Sync Mode"),
                            &data->syncTimerMode,
                            (SETUP_SYNC_TIMER_NAMES-1),
                            syncTimerNames));

#if VDRVERSNUM >= 10334
  Add(new cOsdItem(" ", osUnknown, false));
#else
  Add(new cOsdItem(" ", osUnknown));
#endif

  if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
  {
    Add(new cMenuEditStraItem(tr("Pixel Format"),
                              &data->pixelFormat,
                              (SETUP_PIXFMT-1),
                              pix_fmt));
  }

  if (data->outputMethod == VOUT_DFB)
  {
    Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
                              &data->useStretchBlit, tr("off"), tr("on")));
  }

  Add(new cMenuEditBoolItem(tr("Hide main menu entry"),
                            &data->mainMenu, tr("yes"), tr("no")));
}

/* ---------------------------------------------------------------------------
 */
eOSState cMenuSetupSoftdevice::ProcessKey(eKeys Key)
{
    eOSState state = cOsdMenu::ProcessKey(Key);

  switch (state)
  {
    case osUnknown:
      switch (Key)
      {
        case kOk:
          if (!strcmp(Get(Current())->Text(),tr("Cropping")))
          {
            return AddSubMenu (new cMenuSetupCropping(tr("Cropping")));
          }
          else if (!strcmp(Get(Current())->Text(),tr("Post processing")))
          {
            return AddSubMenu (new cMenuSetupPostproc(tr("Post processing")));
          }
          else if (!strcmp(Get(Current())->Text(),tr("Video out")))
          {
            return AddSubMenu (new cMenuSetupVideoParm(tr("Video out")));
          }
          Store();
          state = osBack;
          break;
        default:
          break;
      }
      break;
    case osBack:
      setupStore = copyData;
      fprintf (stderr, "[setup-softdevice] restoring setup state\n");
      break;
    default:
      break;
  }
  return state;
}

/* ---------------------------------------------------------------------------
 */
void cMenuSetupSoftdevice::Store(void)
{
#if 0
  if (setupStore.deintMethod != data.deintMethod) {
    fprintf(stderr,
            "[setup-softdevice] deinterlace method changed to (%d) %s\n",
            data.deintMethod, deint_str [data.deintMethod]);
  }
#endif


  fprintf (stderr, "[setup-softdevice] storing data\n");
//  setupStore = data;
  SetupStore ("Xv-Aspect",          setupStore.xvAspect);
  // don't save max area value as it is ignored on load
  //SetupStore ("Xv-MaxArea",         setupStore.xvMaxArea);
  SetupStore ("CropMode",           setupStore.cropMode);
  SetupStore ("CropModeToggleKey",     setupStore.cropModeToggleKey);
  SetupStore ("CropTopLines",        setupStore.cropTopLines);
  SetupStore ("CropBottomLines",     setupStore.cropBottomLines);
  SetupStore ("CropLeftCols",        setupStore.cropLeftCols);
  SetupStore ("CropRightCols",       setupStore.cropRightCols);
  SetupStore ("Deinterlace Method", setupStore.deintMethod);
  SetupStore ("Postprocess Method", setupStore.ppMethod);
  SetupStore ("Postprocess Quality", setupStore.ppQuality);
  SetupStore ("PixelFormat",        setupStore.pixelFormat);
  SetupStore ("UseStretchBlit",     setupStore.useStretchBlit);
  SetupStore ("Picture mirroring",  setupStore.mirror);
  SetupStore ("avOffset",           setupStore.avOffset);
  SetupStore ("AlsaDevice",         setupStore.alsaDevice);
  SetupStore ("AlsaAC3Device",      setupStore.alsaAC3Device);
  SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
  SetupStore ("Suspend",            setupStore.shouldSuspend);
  SetupStore ("OSDalphablend",      setupStore.osdMode);
  SetupStore ("AC3Mode",            setupStore.ac3Mode);
  SetupStore ("bufferMode",           setupStore.bufferMode);
  SetupStore ("mainMenu",             setupStore.mainMenu);
  SetupStore ("syncTimerMode",        setupStore.syncTimerMode);
  SetupStore ("vidBrightness",        setupStore.vidBrightness);
  SetupStore ("vidContrast",          setupStore.vidContrast);
  SetupStore ("vidHue",               setupStore.vidHue);
  SetupStore ("vidSaturation",        setupStore.vidSaturation);
}

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.141
retrieving revision 1.142
diff -C2 -d -r1.141 -r1.142
*** CHANGELOG	15 Jan 2006 21:11:25 -0000	1.141
--- CHANGELOG	17 Jan 2006 20:45:46 -0000	1.142
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-01-17:
+    - add video-shm and ShmClient, a simple server/client model for the 
+      softdevice. See the file README for details.
  2006-01-15:
     - compile fix for vdr-1.2.6

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** README	6 Nov 2005 17:56:06 -0000	1.11
--- README	17 Jan 2006 20:45:46 -0000	1.12
***************
*** 105,108 ****
--- 105,124 ----
  many thanks to the authors of that program.
  
+ 
+ Shared Memory Client/Server
+ ---------------------------
+ 
+ There is now an experimental client/server model in the softdevice. To use
+ it compile the softdevice with SHM_SUPPORT enabled and start it using
+ "-vo shm:". The softdevice will then start with the decoding suspended until
+ a client connects to the shared memory. For now there is only an Xv client,
+ to build it type "make ShmClient" in the plugin's source directory. To start
+ the Xv client simply type "ShmClient", and a window will open from which you
+ can use Vdr just like you are used to from the Xv-out will open up. When
+ this window is closed the Softdevice will automatically suspend the decoding.
+ It is possible to make a client for the other video-out methods too, but
+ I found the Xv-Client the most usefull for combined desktop/vdr machines :-)
+ 
+ 
  Problems/todo:
  --------------

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** setup-softdevice.c	15 Nov 2005 23:05:23 -0000	1.39
--- setup-softdevice.c	17 Jan 2006 20:45:46 -0000	1.40
***************
*** 11,29 ****
  #include "mpeg2decoder.h"
  
- #define MINAVOFFSET (-250)
- #define MAXAVOFFSET (250)
- 
- #define MAX_CROP_LINES  50
- #define MAX_CROP_COLS   50
  
  /* ----------------------------------------------------------------------------
   * index to this array correspond to AFD values
   */
- #define SETUP_CROPMODES 4
  const char *crop_str[SETUP_CROPMODES+1];
  
  /* ---------------------------------------------------------------------------
   */
- #define SETUP_DEINTMODES 9
  const char *deint_str[SETUP_DEINTMODES] = {
          "none",      // translated in cMenuSetupSoftdevice::cMenuSetupSoftdevice()
--- 11,22 ----
***************
*** 44,48 ****
  /*-----------------------------------------------------------------------------
   */
- #define SETUP_PPMODES 4
  const char *pp_str[SETUP_PPMODES];
  
--- 37,40 ----
***************
*** 50,54 ****
   * allow changing of output pixfmt
   */
- #define SETUP_PIXFMT 4
  const char *pix_fmt[SETUP_PIXFMT];
  
--- 42,45 ----
***************
*** 56,60 ****
   * give some readable values for aspect ratio selection instead fo 0, 1 values
   */
- #define SETUP_XVSTARTUPASPECT 3
  const char *xv_startup_aspect[SETUP_XVSTARTUPASPECT];
  
--- 47,50 ----
***************
*** 66,93 ****
  /*-----------------------------------------------------------------------------
   */
- #define SETUP_OSDMODES 3
  const char *osdModeNames[SETUP_OSDMODES];
  
  /*-----------------------------------------------------------------------------
   */
- #define SETUP_VIDEOASPECTNAMES 6
  const char *videoAspectNames[SETUP_VIDEOASPECTNAMES];
  
  /*-----------------------------------------------------------------------------
   */
- #define SETUP_BUFFERMODES 4
  const char *bufferModes[SETUP_BUFFERMODES];
  
  /*-----------------------------------------------------------------------------
   */
- #define SETUP_AC3MODENAMES 5
  const char *ac3ModeNames[SETUP_AC3MODENAMES];
  
- /*-----------------------------------------------------------------------------
-  */
- #define SETUP_USERKEYS 11
  const char *userKeyUsage[SETUP_USERKEYS];
  
- #define SETUP_SYNC_TIMER_NAMES  4
  const char *syncTimerNames[SETUP_SYNC_TIMER_NAMES];
  
--- 56,75 ----
***************
*** 431,846 ****
  }
  
- /* ---------------------------------------------------------------------------
-  */
- cMenuSetupVideoParm::cMenuSetupVideoParm(const char *name) : cOsdMenu(name, 33)
- {
-   copyData = setupStore;
-   data = &setupStore;
- 
-   if (data->vidCaps & CAP_BRIGHTNESS)
-   {
-     Add(new cMenuEditIntItem(tr("Brightness"),
-                              &data->vidBrightness,
-                              0,
-                              VID_MAX_PARM_VALUE));
-   }
-   if (data->vidCaps & CAP_CONTRAST)
-   {
-     Add(new cMenuEditIntItem(tr("Contrast"),
-                              &data->vidContrast,
-                              0,
-                              VID_MAX_PARM_VALUE));
-   }
-   if (data->vidCaps & CAP_HUE)
-   {
-     Add(new cMenuEditIntItem(tr("Hue"),
-                              &data->vidHue,
-                              0,
-                              VID_MAX_PARM_VALUE));
-   }
-   if (data->vidCaps & CAP_SATURATION)
-   {
-     Add(new cMenuEditIntItem(tr("Saturation"),
-                              &data->vidSaturation,
-                              0,
-                              VID_MAX_PARM_VALUE));
-   }
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- eOSState cMenuSetupVideoParm::ProcessKey(eKeys Key)
- {
-     eOSState state = cOsdMenu::ProcessKey(Key);
- 
-   switch (state)
-   {
-     case osUnknown:
-       switch (Key)
-       {
-         case kOk:
-           state = osBack;
-           break;
-         default:
-           break;
-       }
-       break;
-     case osBack:
-       setupStore = copyData;
-       fprintf (stderr, "[setup-videoparm] restoring setup state\n");
-       break;
-     default:
-       break;
-   }
-   return state;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- cMenuSetupCropping::cMenuSetupCropping(const char *name) : cOsdMenu(name, 33)
- {
-   copyData = setupStore;
-   data = &setupStore;
- 
-   crop_str[0] = tr("none");
-   Add(new cMenuEditStraItem(tr("CropMode"),
-                             &data->cropMode,
-                             SETUP_CROPMODES,
-                             crop_str));
- 
-   userKeyUsage[0] = tr("none");
-   Add(new cMenuEditStraItem(tr("CropModeToggleKey"),
-                             &data->cropModeToggleKey,
-                             (SETUP_USERKEYS-1),
-                             userKeyUsage));
- 
-   if (data->outputMethod != VOUT_FB)
-   {
- #if VDRVERSNUM >= 10334
-     Add(new cOsdItem(" ", osUnknown, false));
- #else
-     Add(new cOsdItem(" ", osUnknown));
- #endif
- 
-     Add(new cMenuEditIntItem(tr("Crop lines from top"),
-                              &data->cropTopLines,
-                              0,
-                              MAX_CROP_LINES));
- 
-     Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
-                              &data->cropBottomLines,
-                              0,
-                              MAX_CROP_LINES));
-   }
- 
-   if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_DFB)
-   {
-     Add(new cMenuEditIntItem(tr("Crop columns from left"),
-                              &data->cropLeftCols,
-                              0,
-                              MAX_CROP_COLS));
-     Add(new cMenuEditIntItem(tr("Crop columns from right"),
-                              &data->cropRightCols,
-                              0,
-                              MAX_CROP_COLS));
-   }
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- eOSState cMenuSetupCropping::ProcessKey(eKeys Key)
- {
-     eOSState state = cOsdMenu::ProcessKey(Key);
- 
-   switch (state)
-   {
-     case osUnknown:
-       switch (Key)
-       {
-         case kOk:
-           state = osBack;
-           break;
-         default:
-           break;
-       }
-       break;
-     case osBack:
-       setupStore = copyData;
-       fprintf (stderr, "[setup-cropping] restoring setup state\n");
-       break;
-     default:
-       break;
-   }
-   return state;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- cMenuSetupPostproc::cMenuSetupPostproc(const char *name) : cOsdMenu(name, 33)
- {
-   copyData = setupStore;
-   data = &setupStore;
- 
-   deint_str[0] = tr("none");
-   if (data->outputMethod == VOUT_FB)
-   {
-     Add(new cMenuEditStraItem(tr("Deinterlace Method"),
-                               &data->deintMethod,
- #ifdef PP_LIBAVCODEC
-                               8,
- #else
-                               3,
- #endif //PP_LIBAVCODEC
-                               deint_str));
-   }
-   else
-   {
-     Add(new cMenuEditStraItem(tr("Deinterlace Method"),
-                               &data->deintMethod,
- #ifdef PP_LIBAVCODEC
-                               7,
- #else
-                               2,
- #endif //PP_LIBAVCODEC
-                               deint_str));
-   }
- 
- #ifdef PP_LIBAVCODEC
-   pp_str[0] = tr("none");
-   pp_str[1] = tr("fast");
-   pp_str[2] = tr("default");
-   Add(new cMenuEditStraItem(tr("Postprocessing Method"),
-                               &data->ppMethod,(SETUP_PPMODES-1),pp_str));
-   Add(new cMenuEditIntItem(tr("Postprocessing Quality"),
-                               &data->ppQuality,0,6));
- #endif
- 
-   Add(new cMenuEditBoolItem(tr("Picture mirroring"),
-                             &data->mirror, tr("off"), tr("on")));
- 
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- eOSState cMenuSetupPostproc::ProcessKey(eKeys Key)
- {
-     eOSState state = cOsdMenu::ProcessKey(Key);
- 
-   switch (state)
-   {
-     case osUnknown:
-       switch (Key)
-       {
-         case kOk:
-           state = osBack;
-           break;
-         default:
-           break;
-       }
-       break;
-     case osBack:
-       setupStore = copyData;
-       fprintf (stderr, "[setup-postproc] restoring setup state\n");
-       break;
-     default:
-       break;
-   }
-   return state;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
- {
-   if (plugin)
-     SetPlugin(plugin);
- 
-   copyData = setupStore;
-   data = &setupStore;
- 
-   Add(new cOsdItem(tr("Cropping")));
-   Add(new cOsdItem(tr("Post processing")));
- 
-   if (data->vidCaps)
-   {
-     Add(new cOsdItem(tr("Video out")));
-   }
- 
- #if VDRVERSNUM >= 10334
-   Add(new cOsdItem(" ", osUnknown, false));
- #else
-   Add(new cOsdItem(" ", osUnknown));
- #endif
- 
-   if (data->outputMethod == VOUT_XV)
-   {
-     xv_startup_aspect[0] = tr("16:9 wide");
-     xv_startup_aspect[1] = tr("4:3 normal");
-     Add(new cMenuEditStraItem(tr("Xv startup aspect"),
-                              &data->xvAspect,
-                              (SETUP_XVSTARTUPASPECT-1),
-                              xv_startup_aspect));
-   }
- 
-   videoAspectNames[0] = tr("default");
-   Add(new cMenuEditStraItem(tr("Screen Aspect"),
-                             &data->screenPixelAspect,
-                             (SETUP_VIDEOASPECTNAMES-1),
-                             videoAspectNames));
- 
-   osdModeNames[0] = tr("pseudo");
-   osdModeNames[1] = tr("software");
-   Add(new cMenuEditStraItem(tr("OSD alpha blending"),
-                             &data->osdMode,
-                             (SETUP_OSDMODES-1),
-                             osdModeNames));
- 
- #if VDRVERSNUM >= 10334
-   Add(new cOsdItem(" ", osUnknown, false));
- #else
-   Add(new cOsdItem(" ", osUnknown));
- #endif
- 
-   bufferModes[0] = tr("safe");
-   bufferModes[1] = tr("good seeking");
-   bufferModes[2] = tr("HDTV");
-   Add(new cMenuEditStraItem(tr("Buffer Mode"),
-                               &data->bufferMode,(SETUP_BUFFERMODES-1),bufferModes));
- 
-   suspendVideo[0] = tr("playing");
-   suspendVideo[1] = tr("suspended");
-   Add(new cMenuEditStraItem(tr("Playback"),
-                             &data->shouldSuspend,
-                             (SETUP_SUSPENDVIDEO-1),
-                             suspendVideo));
- 
- #if VDRVERSNUM >= 10334
-   Add(new cOsdItem(" ", osUnknown, false));
- #else
-   Add(new cOsdItem(" ", osUnknown));
- #endif
- 
-   Add(new cMenuEditIntItem(tr("A/V Delay"),
-                            &data->avOffset,
-                            MINAVOFFSET, MAXAVOFFSET));
- 
-   Add(new cMenuEditStraItem(tr("AC3 Mode"),
-                             &data->ac3Mode,
-                             (SETUP_AC3MODENAMES-1),
-                             ac3ModeNames));
- 
-   Add(new cMenuEditStraItem(tr("Sync Mode"),
-                             &data->syncTimerMode,
-                             (SETUP_SYNC_TIMER_NAMES-1),
-                             syncTimerNames));
- 
- #if VDRVERSNUM >= 10334
-   Add(new cOsdItem(" ", osUnknown, false));
- #else
-   Add(new cOsdItem(" ", osUnknown));
- #endif
- 
-   if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
-   {
-     Add(new cMenuEditStraItem(tr("Pixel Format"),
-                               &data->pixelFormat,
-                               (SETUP_PIXFMT-1),
-                               pix_fmt));
-   }
- 
-   if (data->outputMethod == VOUT_DFB)
-   {
-     Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
-                               &data->useStretchBlit, tr("off"), tr("on")));
-   }
- 
-   Add(new cMenuEditBoolItem(tr("Hide main menu entry"),
-                             &data->mainMenu, tr("yes"), tr("no")));
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- eOSState cMenuSetupSoftdevice::ProcessKey(eKeys Key)
- {
-     eOSState state = cOsdMenu::ProcessKey(Key);
- 
-   switch (state)
-   {
-     case osUnknown:
-       switch (Key)
-       {
-         case kOk:
-           if (!strcmp(Get(Current())->Text(),tr("Cropping")))
-           {
-             return AddSubMenu (new cMenuSetupCropping(tr("Cropping")));
-           }
-           else if (!strcmp(Get(Current())->Text(),tr("Post processing")))
-           {
-             return AddSubMenu (new cMenuSetupPostproc(tr("Post processing")));
-           }
-           else if (!strcmp(Get(Current())->Text(),tr("Video out")))
-           {
-             return AddSubMenu (new cMenuSetupVideoParm(tr("Video out")));
-           }
-           Store();
-           state = osBack;
-           break;
-         default:
-           break;
-       }
-       break;
-     case osBack:
-       setupStore = copyData;
-       fprintf (stderr, "[setup-softdevice] restoring setup state\n");
-       break;
-     default:
-       break;
-   }
-   return state;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- void cMenuSetupSoftdevice::Store(void)
- {
- #if 0
-   if (setupStore.deintMethod != data.deintMethod) {
-     fprintf(stderr,
-             "[setup-softdevice] deinterlace method changed to (%d) %s\n",
-             data.deintMethod, deint_str [data.deintMethod]);
-   }
- #endif
- 
- 
-   fprintf (stderr, "[setup-softdevice] storing data\n");
- //  setupStore = data;
-   SetupStore ("Xv-Aspect",          setupStore.xvAspect);
-   // don't save max area value as it is ignored on load
-   //SetupStore ("Xv-MaxArea",         setupStore.xvMaxArea);
-   SetupStore ("CropMode",           setupStore.cropMode);
-   SetupStore ("CropModeToggleKey",     setupStore.cropModeToggleKey);
-   SetupStore ("CropTopLines",        setupStore.cropTopLines);
-   SetupStore ("CropBottomLines",     setupStore.cropBottomLines);
-   SetupStore ("CropLeftCols",        setupStore.cropLeftCols);
-   SetupStore ("CropRightCols",       setupStore.cropRightCols);
-   SetupStore ("Deinterlace Method", setupStore.deintMethod);
-   SetupStore ("Postprocess Method", setupStore.ppMethod);
-   SetupStore ("Postprocess Quality", setupStore.ppQuality);
-   SetupStore ("PixelFormat",        setupStore.pixelFormat);
-   SetupStore ("UseStretchBlit",     setupStore.useStretchBlit);
-   SetupStore ("Picture mirroring",  setupStore.mirror);
-   SetupStore ("avOffset",           setupStore.avOffset);
-   SetupStore ("AlsaDevice",         setupStore.alsaDevice);
-   SetupStore ("AlsaAC3Device",      setupStore.alsaAC3Device);
-   SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
-   SetupStore ("Suspend",            setupStore.shouldSuspend);
-   SetupStore ("OSDalphablend",      setupStore.osdMode);
-   SetupStore ("AC3Mode",            setupStore.ac3Mode);
-   SetupStore ("bufferMode",           setupStore.bufferMode);
-   SetupStore ("mainMenu",             setupStore.mainMenu);
-   SetupStore ("syncTimerMode",        setupStore.syncTimerMode);
-   SetupStore ("vidBrightness",        setupStore.vidBrightness);
-   SetupStore ("vidContrast",          setupStore.vidContrast);
-   SetupStore ("vidHue",               setupStore.vidHue);
-   SetupStore ("vidSaturation",        setupStore.vidSaturation);
- }
--- 413,414 ----

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** setup-softdevice.h	6 Nov 2005 17:56:06 -0000	1.24
--- setup-softdevice.h	17 Jan 2006 20:45:46 -0000	1.25
***************
*** 15,18 ****
--- 15,19 ----
  #define VOUT_VIDIX    4
  #define VOUT_DUMMY    5
+ #define VOUT_SHM      6
  
  #define ALSA_DEVICE_NAME_LENGTH  64
***************
*** 24,27 ****
--- 25,97 ----
  
  #define VID_MAX_PARM_VALUE  100
+ 
+ #define MINAVOFFSET (-250)
+ #define MAXAVOFFSET (250)
+ 
+ #define MAX_CROP_LINES  50
+ #define MAX_CROP_COLS   50
+ 
+ /* ----------------------------------------------------------------------------
+  * index to this array correspond to AFD values
+  */
+ #define SETUP_CROPMODES 4
+ extern const char *crop_str[SETUP_CROPMODES+1];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_USERKEYS 11
+ extern const char *userKeyUsage[SETUP_USERKEYS];
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ #define SETUP_DEINTMODES 9
+ extern const char *deint_str[SETUP_DEINTMODES];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_PPMODES 4
+ extern const char *pp_str[SETUP_PPMODES];
+ 
+ /* ----------------------------------------------------------------------------
+  * give some readable values for aspect ratio selection instead fo 0, 1 values
+  */
+ #define SETUP_XVSTARTUPASPECT 3
+ extern const char *xv_startup_aspect[SETUP_XVSTARTUPASPECT];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_OSDMODES 3
+ extern const char *osdModeNames[SETUP_OSDMODES];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_VIDEOASPECTNAMES 6
+ extern const char *videoAspectNames[SETUP_VIDEOASPECTNAMES];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_BUFFERMODES 4
+ extern const char *bufferModes[SETUP_BUFFERMODES];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_AC3MODENAMES 5
+ extern const char *ac3ModeNames[SETUP_AC3MODENAMES];
+ 
+ extern const char *userKeyUsage[SETUP_USERKEYS];
+ 
+ #define SETUP_SYNC_TIMER_NAMES  4
+ extern const char *syncTimerNames[SETUP_SYNC_TIMER_NAMES];
+ 
+ /* ----------------------------------------------------------------------------
+  * allow changing of output pixfmt
+  */
+ #define SETUP_PIXFMT 4
+ extern const char *pix_fmt[SETUP_PIXFMT];
+ 
+ /*-----------------------------------------------------------------------------
+  */
+ #define SETUP_SUSPENDVIDEO 3
+ extern const char *suspendVideo[SETUP_SUSPENDVIDEO];
  
  /* ---------------------------------------------------------------------------

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** Makefile	15 Jan 2006 20:41:15 -0000	1.21
--- Makefile	17 Jan 2006 20:45:46 -0000	1.22
***************
*** 29,34 ****
--- 29,40 ----
  -include config.mak
  
+ # uncomment to build the shared memory video server
+ # 
+ #SHM_SUPPORT = 1
+ 
+ 
  ifndef WITH_CONFIGURE
  
+ 
  # -----------------------------------------------------------------------------
  # framebuffer device name
***************
*** 210,214 ****
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o sync-timer.o SoftOsd.o
  ALL_OBJS = $(OBJS)
  
--- 216,220 ----
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o setup-softdevice-menu.o sync-timer.o SoftOsd.o
  ALL_OBJS = $(OBJS)
  
***************
*** 259,262 ****
--- 265,279 ----
  endif
  
+ ifdef SHM_SUPPORT
+   ifdef USE_SUBPLUGINS
+     SHM_OBJS  = utils.o video.o video-shm.o SoftOsd.o
+     ALL_OBJS    += $(SHM_OBJS)
+     TARGETS     += libsubvdr-$(PLUGIN)-shm.so
+   else
+     OBJS += video-shm.o
+   endif
+   DEFINES += -DSHM_SUPPORT
+ endif
+ 
  ### Implicit rules:
  
***************
*** 300,303 ****
--- 317,324 ----
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
+ libsubvdr-$(PLUGIN)-shm.so: $(SHM_OBJS)
+ 	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
+ 	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+ 
  endif
  
***************
*** 315,316 ****
--- 336,347 ----
  clean:
  	@-rm -f $(OBJS) $(DEPFILE) *.so *.o *.tgz core* *~
+ 
+ VDR_SHM_CLIENT_OBJS = ../../../osd.o ../../../tools.o ../../../thread.o \
+ 		      ../../../remote.o ../../../i18n.o ../../../keys.o \
+ 		      ../../../font.o ../../../config.o ../../../plugin.o\
+ 		      ../../../sources.o
+ SHM_CLIENT_OBJS  = video.o video-xv.o setup-softdevice.o xscreensaver.o \
+ 		   utils.o SoftOsd.o
+ 
+ ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)
+ 	$(CXX) $(CXXFLAGS) $(XV_LIBS) $(VDR_SHM_CLIENT_OBJS) $(SHM_CLIENT_OBJS) -lpthread $< -o $@

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** softdevice.c	7 Jan 2006 14:30:11 -0000	1.50
--- softdevice.c	17 Jan 2006 20:45:46 -0000	1.51
***************
*** 52,55 ****
--- 52,59 ----
  #endif
  
+ #ifdef SHM_SUPPORT
+ #include "video-shm.h"
+ #endif
+ 
  #ifdef DFB_SUPPORT
  #include "video-dfb.h"
***************
*** 206,209 ****
--- 210,218 ----
  #endif
          break;
+       case VOUT_SHM:
+ #ifdef SHM_SUPPORT
+         LoadSubPlugin ("shm", 0, pluginPath);
+ #endif
+         break;
        case VOUT_DUMMY:
          videoOut=new cDummyVideoOut(&setupStore);
***************
*** 232,235 ****
--- 241,249 ----
  #endif
          break;
+       case VOUT_SHM:
+ #ifdef SHM_SUPPORT
+         videoOut=new cShmVideoOut(&setupStore);
+ #endif
+         break;
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
***************
*** 318,321 ****
--- 332,336 ----
      {
        esyslog("[softdevice] videoOut failure exiting\n");
+       fprintf(stderr,"[softdevice] videoOut failure exiting\n");
        exit (1);
      }
***************
*** 724,727 ****
--- 739,750 ----
  #else
            fprintf(stderr,"[softdevice] fb support not compiled in\n");
+ #endif
+         } else if (!strncmp (vo_argv, "shm:", 3)) {
+           vo_argv += 4;
+           setupStore.voArgs = vo_argv;
+ #ifdef SHM_SUPPORT
+           voutMethod = VOUT_SHM;
+ #else
+           fprintf(stderr,"[softdevice] shm support not compiled in\n");
  #endif
          } else if (!strncmp (vo_argv, "dfb:", 4)) {

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** video.c	15 Jan 2006 21:11:25 -0000	1.39
--- video.c	17 Jan 2006 20:45:46 -0000	1.40
***************
*** 225,229 ****
    }
  
!   if (new_aspect == current_aspect && new_afd == current_afd)
    {
      aspect_changed = 0;
--- 225,229 ----
    }
  
!   if (new_aspect == current_aspect && new_afd == current_afd && !aspect_changed)
    {
      aspect_changed = 0;

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** video.h	15 Jan 2006 21:11:25 -0000	1.25
--- video.h	17 Jan 2006 20:45:46 -0000	1.26
***************
*** 83,86 ****
--- 83,89 ----
      int     aspect_I;
      double  aspect_F;
+ protected:
+     inline double GetAspect_F()
+     { return aspect_F;};
  
  protected:



From nobody at sheep.berlios.de  Thu Jan 19 20:20:07 2006
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 19 Jan 2006 20:20:07 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.142,1.143 video.c,1.40,1.41
Message-ID: <200601191920.k0JJK7x27403@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22317

Modified Files:
	CHANGELOG video.c 
Log Message:
- now the correct fix for CheckArea() not updateing the aspect ratio



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.142
retrieving revision 1.143
diff -C2 -d -r1.142 -r1.143
*** CHANGELOG	17 Jan 2006 20:45:46 -0000	1.142
--- CHANGELOG	19 Jan 2006 19:20:02 -0000	1.143
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-01-19:
+    - now correct fix for CheckArea() not updateing the aspect ratio
  2006-01-17:
     - add video-shm and ShmClient, a simple server/client model for the 

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** video.c	17 Jan 2006 20:45:46 -0000	1.40
--- video.c	19 Jan 2006 19:20:02 -0000	1.41
***************
*** 225,229 ****
    }
  
!   if (new_aspect == current_aspect && new_afd == current_afd && !aspect_changed)
    {
      aspect_changed = 0;
--- 225,229 ----
    }
  
!   if (new_aspect == current_aspect && new_afd == current_afd )
    {
      aspect_changed = 0;
***************
*** 409,412 ****
--- 409,413 ----
      fheight = h;
      aspect_changed = 1;
+     current_aspect = -1;
    }
  }



From nobody at sheep.berlios.de  Mon Jan 23 20:59:21 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 23 Jan 2006 20:59:21 +0100
Subject: [Softdevice-cvs] softdevice video-xv.c,1.37,1.38
Message-ID: <200601231959.k0NJxLx32153@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1766

Modified Files:
	video-xv.c 
Log Message:
changed most XClearArea()

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** video-xv.c	15 Jan 2006 20:41:15 -0000	1.37
--- video-xv.c	23 Jan 2006 19:59:17 -0000	1.38
***************
*** 462,466 ****
  }
  
! //#define EVDEB(out...) {printf("EVDEB:");printf(out);} 
  #define EVDEB(out...)
  
--- 462,466 ----
  }
  
! //#define EVDEB(out...) {printf("EVDEB:");printf(out);}
  #define EVDEB(out...)
  
***************
*** 621,638 ****
                     RevertToParent,
                     CurrentTime);
-           if (map_count > 2 && xv_initialized) {
-             XClearArea (dpy, win, 0, 0, 0, 0, True);
-             ShowOSD(0,false);
-             XvShmPutImage(dpy, port,
-                           win, gc,
-                           xv_image,
-                           sxoff, syoff,      /* sx, sy */
-                           swidth, sheight,   /* sw, sh */
-                           lxoff,  lyoff,     /* dx, dy */
-                           lwidth, lheight,   /* dw, dh */
-                           False);
-             XSync(dpy, False);
-             map_count = 0;
-           }
          }
          break;
--- 621,624 ----
***************
*** 658,673 ****
    if (xv_initialized) {
      if (map_count) {
!       //XClearArea (dpy, win, 0, 0, 0, 0, True);
        ShowOSD(0,false);
! //      XvShmPutImage(dpy, port,
! //                    win, gc,
! //                    xv_image,
! //                    sxoff, syoff,      /* sx, sy */
! //                    swidth, sheight,   /* sw, sh */
! //                    lxoff,  lyoff,     /* dx, dy */
! //                    lwidth, lheight,   /* dw, dh */
! //                    False);
        XSync(dpy, False);
-       map_count=0;
      }
      attributeStore.CheckVideoParmChange();
--- 644,658 ----
    if (xv_initialized) {
      if (map_count) {
!       XClearArea (dpy, win, 0, 0, 0, 0, False);
        ShowOSD(0,false);
!       XvShmPutImage(dpy, port,
!                     win, gc,
!                     xv_image,
!                     sxoff, syoff,      /* sx, sy */
!                     swidth, sheight,   /* sw, sh */
!                     lxoff,  lyoff,     /* dx, dy */
!                     lwidth, lheight,   /* dw, dh */
!                     False);
        XSync(dpy, False);
      }
      attributeStore.CheckVideoParmChange();
***************
*** 1226,1230 ****
      pthread_mutex_lock(&xv_mutex);
      osd_refresh_counter = osd_skip_counter = 0;
!     XClearArea (dpy, win, 0, 0, 0, 0, True);
      ShowOSD(0,false);
      XSync(dpy, False);
--- 1211,1215 ----
      pthread_mutex_lock(&xv_mutex);
      osd_refresh_counter = osd_skip_counter = 0;
!     XClearArea (dpy, win, 0, 0, 0, 0, False);
      ShowOSD(0,false);
      XSync(dpy, False);
***************
*** 1424,1428 ****
        cutRight != setupStore->cropRightCols)
    {
!     XClearArea (dpy, win, 0, 0, 0, 0, True);
      ShowOSD(0,false);
      aspect_changed = 0;
--- 1409,1413 ----
        cutRight != setupStore->cropRightCols)
    {
!     XClearArea (dpy, win, 0, 0, 0, 0, False);
      ShowOSD(0,false);
      aspect_changed = 0;



From nobody at sheep.berlios.de  Fri Feb  3 23:34:57 2006
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 3 Feb 2006 23:34:57 +0100
Subject: [Softdevice-cvs] softdevice Makefile,1.22,1.23 CHANGELOG,1.143,1.144 ShmClient.c,1.1,1.2 SoftOsd.c,1.4,1.5 SoftOsd.h,1.2,1.3 shm-common.h,1.1,1.2 video-dfb.c,1.45,1.46 video-dfb.h,1.14,1.15 video-fb.c,1.11,1.12 video-fb.h,1.5,1.6 video-shm.c,1.1,1.2 video-shm.h,1.1,1.2 video-vidix.c,1.13,1.14 video-vidix.h,1.6,1.7 video-xv.c,1.38,1.39 video-xv.h,1.11,1.12 video.c,1.41,1.42 video.h,1.26,1.27
Message-ID: <200602032234.k13MYvx17007@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv949

Modified Files:
	Makefile CHANGELOG ShmClient.c SoftOsd.c SoftOsd.h 
	shm-common.h video-dfb.c video-dfb.h video-fb.c video-fb.h 
	video-shm.c video-shm.h video-vidix.c video-vidix.h video-xv.c 
	video-xv.h video.c video.h 
Log Message:
- remove cSoftOsd and cOsd dependency from cVideoOut. Size and
  Mode changes are now handled by a thread from cSoftOsd.
- introduce separate OSD layer in ShmClient/video-shm
	   


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** Makefile	17 Jan 2006 20:45:46 -0000	1.22
--- Makefile	3 Feb 2006 22:34:54 -0000	1.23
***************
*** 221,225 ****
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o SoftOsd.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
--- 221,225 ----
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
!     DFB_OBJS  = utils.o video.o video-dfb.o 
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
***************
*** 234,238 ****
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o SoftOsd.o
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
--- 234,238 ----
    ifdef USE_SUBPLUGINS
      FB_LIBS   =
!     FB_OBJS   = utils.o video.o video-fb.o 
      ALL_OBJS  += $(FB_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-fb.so
***************
*** 244,248 ****
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o SoftOsd.o
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
--- 244,248 ----
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
!     XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o 
      ALL_OBJS  += $(XV_OBJS)
      TARGETS   += libsubvdr-$(PLUGIN)-xv.so
***************
*** 255,259 ****
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o SoftOsd.o
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
--- 255,259 ----
  ifdef VIDIX_SUPPORT
    ifdef USE_SUBPLUGINS
!     VIDIX_OBJS  = utils.o video.o video-vidix.o 
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
***************
*** 267,271 ****
  ifdef SHM_SUPPORT
    ifdef USE_SUBPLUGINS
!     SHM_OBJS  = utils.o video.o video-shm.o SoftOsd.o
      ALL_OBJS    += $(SHM_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-shm.so
--- 267,271 ----
  ifdef SHM_SUPPORT
    ifdef USE_SUBPLUGINS
!     SHM_OBJS  = utils.o video.o video-shm.o 
      ALL_OBJS    += $(SHM_OBJS)
      TARGETS     += libsubvdr-$(PLUGIN)-shm.so
***************
*** 337,346 ****
  	@-rm -f $(OBJS) $(DEPFILE) *.so *.o *.tgz core* *~
  
! VDR_SHM_CLIENT_OBJS = ../../../osd.o ../../../tools.o ../../../thread.o \
  		      ../../../remote.o ../../../i18n.o ../../../keys.o \
! 		      ../../../font.o ../../../config.o ../../../plugin.o\
  		      ../../../sources.o
  SHM_CLIENT_OBJS  = video.o video-xv.o setup-softdevice.o xscreensaver.o \
! 		   utils.o SoftOsd.o
  
  ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)
--- 337,346 ----
  	@-rm -f $(OBJS) $(DEPFILE) *.so *.o *.tgz core* *~
  
! VDR_SHM_CLIENT_OBJS = ../../../tools.o ../../../thread.o \
  		      ../../../remote.o ../../../i18n.o ../../../keys.o \
! 		      ../../../config.o ../../../plugin.o\
  		      ../../../sources.o
  SHM_CLIENT_OBJS  = video.o video-xv.o setup-softdevice.o xscreensaver.o \
! 		   utils.o 
  
  ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.143
retrieving revision 1.144
diff -C2 -d -r1.143 -r1.144
*** CHANGELOG	19 Jan 2006 19:20:02 -0000	1.143
--- CHANGELOG	3 Feb 2006 22:34:54 -0000	1.144
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2006-02-03:
+    - remove cSoftOsd and cOsd dependency from cVideoOut. Size and
+      Mode changes are now handled by a thread from cSoftOsd.
+    - introduce separate OSD layer in ShmClient/video-shm
  2006-01-19:
     - now correct fix for CheckArea() not updateing the aspect ratio

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** ShmClient.c	17 Jan 2006 20:45:46 -0000	1.1
--- ShmClient.c	3 Feb 2006 22:34:54 -0000	1.2
***************
*** 122,127 ****
          };
          xvRemote->XvRemoteStart();
          
-                 
          ctl->key=NO_KEY;
          // wakeup remote thread to unsuspend video/audio
--- 122,132 ----
          };
          xvRemote->XvRemoteStart();
+ 
+         ctl->osd_shmid= vout->osd_shminfo.shmid;
+         ctl->osd_stride=vout->osd_image->bytes_per_line;
+         ctl->osd_depth=vout->osd_image->bits_per_pixel;
+         vout->GetOSDDimension(ctl->osd_width,ctl->osd_height);
+         printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
          
          ctl->key=NO_KEY;
          // wakeup remote thread to unsuspend video/audio
***************
*** 134,149 ****
                  sem_wait_lock(ctl->semid,PICT_MUT,SEM_UNDO);
                  //SHMDEB("got lock\n");
!                 
!                 int width=ctl->width>ctl->max_width?ctl->max_width:ctl->width;
!                 int height=ctl->height>ctl->max_height?
!                         ctl->max_height:ctl->height;
  
!                 vout->CheckArea(width,height);
!                 vout->CheckAspect(ctl->new_afd,ctl->new_asp);
!                 vout->YUV(pixel[0],pixel[1],pixel[2],
!                                 width,height,
!                                 ctl->stride0,ctl->stride1);
!                 ctl->new_pict=0;
                  
                  // consumed all pictures - set semaphore to 0
                  sem_zero(ctl->semid,PICT_SIG);
--- 139,162 ----
                  sem_wait_lock(ctl->semid,PICT_MUT,SEM_UNDO);
                  //SHMDEB("got lock\n");
!                
!                 if (ctl->new_pict) {
!                         int width=ctl->width>ctl->max_width?
!                                 ctl->max_width:ctl->width;
!                         int height=ctl->height>ctl->max_height?
!                                 ctl->max_height:ctl->height;
  
!                         vout->CheckArea(width,height);
!                         vout->CheckAspect(ctl->new_afd,ctl->new_asp);
!                         vout->YUV(pixel[0],pixel[1],pixel[2],
!                                         width,height,
!                                         ctl->stride0,ctl->stride1);
!                         ctl->new_pict=0;
!                 };
!                 if (ctl->new_osd) {
!                         vout->CommitUnlockOsdSurface();
!                         ctl->new_osd=0;
!                 };
                  
+                 vout->GetOSDDimension(ctl->osd_width,ctl->osd_height);
                  // consumed all pictures - set semaphore to 0
                  sem_zero(ctl->semid,PICT_SIG);

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** SoftOsd.c	15 Jan 2006 20:41:15 -0000	1.4
--- SoftOsd.c	3 Feb 2006 22:34:54 -0000	1.5
***************
*** 33,37 ****
  
  cSoftOsd::cSoftOsd(cVideoOut *VideoOut, int X, int Y) 
! 	: cOsd(X, Y) {
          OSDDEB("cSoftOsd constructor\n");
          OutputConvert=&cSoftOsd::ARGB_to_ARGB32;
--- 33,37 ----
  
  cSoftOsd::cSoftOsd(cVideoOut *VideoOut, int X, int Y) 
! 	: cOsd(X, Y),active(false) {
          OSDDEB("cSoftOsd constructor\n");
          OutputConvert=&cSoftOsd::ARGB_to_ARGB32;
***************
*** 41,46 ****
          
          videoOut = VideoOut;
! 	videoOut->OpenOSD(X, Y, this);
  	xOfs=X;yOfs=Y;
  };
  
--- 41,52 ----
          
          videoOut = VideoOut;
! 	videoOut->OpenOSD();
  	xOfs=X;yOfs=Y;
+         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
+         uint8_t *PixelMask;
+         videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
+                         IsYUV,PixelMask);
+         SetMode(Depth,HasAlpha,AlphaInversed,
+                         IsYUV,PixelMask);
  };
  
***************
*** 62,78 ****
  /* --------------------------------------------------------------------------*/
  cSoftOsd::~cSoftOsd() {
!   OSDDEB("cSoftOsd destructor\n");
!   if (videoOut) {
!     videoOut->CloseOSD();
!     videoOut=0;
!   }
!   delete OSD_Bitmap;
  }
  
  /* --------------------------------------------------------------------------*/
  bool cSoftOsd::SetMode(int Depth, bool HasAlpha, bool AlphaInversed, 
                  bool IsYUV,uint8_t *PixelMask) {
!         OSDDEB("SetMode Depth %d HasAlpha %d IsYUV %d AlphaInversed %d PixelMask %p\n",
!                         Depth,HasAlpha,IsYUV,AlphaInversed,PixelMask);
          
          if (IsYUV) {
--- 68,167 ----
  /* --------------------------------------------------------------------------*/
  cSoftOsd::~cSoftOsd() {
!         OSDDEB("cSoftOsd destructor\n");
!         active=false;
!         Cancel(3);
!         if (videoOut) {
!                 videoOut->CloseOSD();
!                 videoOut=0;
!         }
!         delete OSD_Bitmap;
! }
! 
! /* -------------------------------------------------------------------------*/
! void cSoftOsd::Action() {
!         OSDDEB("OSD thread started\n");
!         active=true;
!         while(active && videoOut) {
!                 int newOsdWidth;
!                 int newOsdHeight;
! 
!                 videoOut->GetOSDDimension(newOsdWidth,newOsdHeight);
!                 if ( newOsdWidth==-1 || newOsdHeight==-1 )
!                 {
!                         newOsdWidth=OSD_FULL_WIDTH;
!                         newOsdHeight=OSD_FULL_HEIGHT;
!                 }
!                 
!                 int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
!                 uint8_t *PixelMask;
!                 videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
!                                 IsYUV,PixelMask);
!                 bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,
!                                 IsYUV,PixelMask);
! 
!                 if ( ScreenOsdWidth!=newOsdWidth  || 
!                                 ScreenOsdHeight!=newOsdHeight  || 
!                                 modeChanged ) {
!                         OSDDEB("Resolution or mode changed!\n");
!                         if (modeChanged)
!                                 videoOut->ClearOSD();
!                         OsdCommit();
!                 }
!                 usleep(17000);
!         }
!         OSDDEB("OSD thread ended\n");
  }
  
+ /*--------------------------------------------------------------------------*/
+ void cSoftOsd::OsdCommit() {
+         int newX;
+         int newY;
+         bool RefreshAll=false;
+         videoOut->GetOSDDimension(newX,newY);
+         if ( newX==-1 || newY==-1 ) {
+                 newX=OSD_FULL_WIDTH;
+                 newY=OSD_FULL_HEIGHT;
+         }
+         if (newX!=ScreenOsdWidth || newY!=ScreenOsdHeight) {
+                 ScreenOsdWidth=newX;
+                 ScreenOsdHeight=newY;
+                 RefreshAll=true;
+         };
+ 
+         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
+         uint8_t *PixelMask;
+         videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
+         bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
+         if (modeChanged)
+                 videoOut->ClearOSD();
+ 
+         if (IsYUV) { 
+                 uint8_t *osdPy; uint8_t *osdPu; uint8_t *osdPv;
+                 uint8_t *osdPAlphaY; uint8_t *osdPAlphaUV;
+                 int strideY; int strideUV;
+                 videoOut->GetLockSoftOsdSurface(osdPy,osdPu,osdPv,
+                                 osdPAlphaY,osdPAlphaUV,strideY,strideUV);
+                 if (osdPy)
+                         CopyToBitmap(osdPy,osdPv,osdPu,
+                                         osdPAlphaY,osdPAlphaUV,
+                                         strideY,strideUV,
+                                         ScreenOsdWidth,ScreenOsdHeight,
+                                         RefreshAll);
+                 videoOut->CommitUnlockSoftOsdSurface();
+         } else {
+                 uint8_t *osd; int stride; bool *dirtyLines;
+                 videoOut->GetLockOsdSurface(osd,stride,dirtyLines);
+                 if (osd)
+                         CopyToBitmap(osd,stride,ScreenOsdWidth,ScreenOsdHeight,
+                                         RefreshAll,dirtyLines);
+                 videoOut->CommitUnlockOsdSurface();
+         }
+ };
+ 
  /* --------------------------------------------------------------------------*/
  bool cSoftOsd::SetMode(int Depth, bool HasAlpha, bool AlphaInversed, 
                  bool IsYUV,uint8_t *PixelMask) {
!         //OSDDEB("SetMode Depth %d HasAlpha %d IsYUV %d AlphaInversed %d PixelMask %p\n",
!         //                Depth,HasAlpha,IsYUV,AlphaInversed,PixelMask);
          
          if (IsYUV) {
***************
*** 82,87 ****
                          Clear();
                          FlushBitmaps(false);
                  };
!                 return true;
          };
  
--- 171,177 ----
                          Clear();
                          FlushBitmaps(false);
+                         return true;
                  };
!                 return false;
          };
  
***************
*** 119,125 ****
                  Clear();
  		FlushBitmaps(false);
          };
          
!         return true;
  };
  
--- 209,216 ----
                  Clear();
  		FlushBitmaps(false);
+                 return true;
          };
          
!         return false;
  };
  
***************
*** 131,138 ****
  	
  	if (OSD_changed)
! 		videoOut->OSDFlush(this);
  
  	// give priority to the other threads
  	pthread_yield();
  }
  
--- 222,231 ----
  	
  	if (OSD_changed)
! 		OsdCommit();
  
  	// give priority to the other threads
  	pthread_yield();
+         if (!active)
+                 Start();
  }
  

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** SoftOsd.h	9 Jan 2006 20:26:02 -0000	1.2
--- SoftOsd.h	3 Feb 2006 22:34:54 -0000	1.3
***************
*** 52,56 ****
  /* ---------------------------------------------------------------------------
   */
! class cSoftOsd : public cOsd {
  private:
      cVideoOut *videoOut;
--- 52,56 ----
  /* ---------------------------------------------------------------------------
   */
! class cSoftOsd : public cOsd,cThread {
  private:
      cVideoOut *videoOut;
***************
*** 74,78 ****
      void ConvertPalette(tColor *dest_palette, const tColor *orig_palette, 
  		    int maxColors);
!     
  public:
      cSoftOsd(cVideoOut *VideoOut, int XOfs, int XOfs);
--- 74,81 ----
      void ConvertPalette(tColor *dest_palette, const tColor *orig_palette, 
  		    int maxColors);
!    
!     bool active;
!     int ScreenOsdWidth;
!     int ScreenOsdHeight;
  public:
      cSoftOsd(cVideoOut *VideoOut, int XOfs, int XOfs);
***************
*** 85,90 ****
--- 88,95 ----
      bool DrawConvertBitmap(cBitmap *Bitmap, bool OnlyDirty);
      virtual void Flush(void);
+     void OsdCommit();
      
      void Clear();
+     virtual void Action();
      
      static void ARGB_to_AYUV(uint8_t * dest, color * pixmap, int Pixel);

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** shm-common.h	17 Jan 2006 20:45:46 -0000	1.1
--- shm-common.h	3 Feb 2006 22:34:54 -0000	1.2
***************
*** 54,57 ****
--- 54,65 ----
          int stride2;
          int new_pict;
+ 
+         /* osd layer */
+         int osd_shmid;
+         int osd_width;
+         int osd_height;
+         int osd_depth;
+         int osd_stride;
+         int new_osd;
          
          /* is a client attached */

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** video-dfb.c	10 Jan 2006 19:40:25 -0000	1.45
--- video-dfb.c	3 Feb 2006 22:34:54 -0000	1.46
***************
*** 15,19 ****
  #include "setup-softdevice.h"
  
- #include "SoftOsd.h"
  
  #ifdef HAVE_CONFIG
--- 15,18 ----
***************
*** 991,999 ****
  /* ----------------------------------------------------------------------------
   */
! void cDFBVideoOut::OpenOSD (int x, int y, cSoftOsd *osd)
  {
      IDirectFBSurface  *tmpSurface;
  
!   cVideoOut::OpenOSD(x, y,osd);
    try
    {
--- 990,998 ----
  /* ----------------------------------------------------------------------------
   */
! void cDFBVideoOut::OpenOSD ()
  {
      IDirectFBSurface  *tmpSurface;
  
!   cVideoOut::OpenOSD();
    try
    {
***************
*** 1032,1040 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::OSDCommit()
! {
!   OSDpresent = true;
! }
  
  void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll) 
  {
--- 1031,1106 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                                      bool *&DirtyLines) {
!   int               pitch;
!   uint8_t           *dst;
! 
!   try
!   {
!     dirtyLines=DirtyLines=new bool[Yres];
!     memset(dirtyLines,false,sizeof(dirtyLines));
! 
!     tmpOsdSurface = (useStretchBlit) ? osdSurface : scrSurface;
!     tmpOsdSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
!     osd=dst;stride=pitch;
!   }
!   catch (DFBException *ex)
!   {
!     fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
!         ex->GetAction(), ex->GetResult());
!     delete ex;
!   }
! };
! 
! void cDFBVideoOut::CommitUnlockOsdSurface() {
!   if (!tmpOsdSurface)
!     return;
! 
!   printf("CommitUnlockOsdSurface %p\n",tmpOsdSurface);fflush(stdout);
!   try 
!   {
!     DFBRectangle      osdsrc;
!     
!     tmpOsdSurface->Unlock();
!     tmpOsdSurface->Flip();
  
+     int miny=0;
+     int maxy=0;
+     do {
+       while (!dirtyLines[miny] && miny < Yres)
+         miny++;
+ 
+       if (miny >= Yres)
+         break;
+ 
+       maxy=miny;
+       while (dirtyLines[maxy] && maxy < Yres)
+         maxy++;
+ 
+       osdsrc.x = 0;
+       osdsrc.y = miny;
+       osdsrc.w = Xres;
+       osdsrc.h = maxy-miny + 1;
+       tmpOsdSurface->Blit(tmpOsdSurface,&osdsrc,0,miny);
+ 
+   printf("CommitUnlockOsdSurface3 %p\n",tmpOsdSurface);fflush(stdout);
+       miny=maxy;
+ 
+     } while ( miny<Yres);
+ 
+   }
+   catch (DFBException *ex)
+   {
+     fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
+         ex->GetAction(), ex->GetResult());
+     delete ex;
+   }
+   printf("CommitUnlockOsdSurface %p 4\n",tmpOsdSurface);fflush(stdout);
+   free(dirtyLines);
+   dirtyLines=NULL;
+   tmpOsdSurface=NULL;
+   cVideoOut::CommitUnlockOsdSurface();
+ }
+ /*
  void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll) 
  {
***************
*** 1089,1093 ****
  
  }
! 	
  /* ---------------------------------------------------------------------------
   */
--- 1155,1159 ----
  
  }
! 	*/
  /* ---------------------------------------------------------------------------
   */

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** video-dfb.h	8 Jan 2006 09:43:32 -0000	1.14
--- video-dfb.h	3 Feb 2006 22:34:54 -0000	1.15
***************
*** 56,68 ****
  
  #if VDRVERSNUM >= 10307
!     virtual void OpenOSD(int x, int y, cSoftOsd *Osd);
! //    virtual void Refresh(cBitmap *Bitmap);
!     virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                    bool &IsYUV, uint8_t *&PixelMask) 
      { Depth=Bpp; HasAlpha=!OSDpseudo_alpha; AlphaInversed=isVIAUnichrome;
!             IsYUV=false;PixelMask=NULL;}
      virtual void OSDStart();
!     virtual void OSDCommit();
  #else
      virtual void Refresh();
--- 56,72 ----
  
  #if VDRVERSNUM >= 10307
!     bool *dirtyLines;
!     IDirectFBSurface  *tmpOsdSurface;
!     virtual void OpenOSD();
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                    bool &IsYUV, uint8_t *&PixelMask) 
      { Depth=Bpp; HasAlpha=!OSDpseudo_alpha; AlphaInversed=isVIAUnichrome;
!             IsYUV=false;PixelMask=NULL;};
!     virtual void GetOSDDimension( int &Width, int &Height)
!     { Width=Xres; Height=Yres;};		    
      virtual void OSDStart();
!     virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                     bool *&dirtyLines);
!     virtual void CommitUnlockOsdSurface();
  #else
      virtual void Refresh();

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-fb.c	15 Jan 2006 20:41:14 -0000	1.11
--- video-fb.c	3 Feb 2006 22:34:54 -0000	1.12
***************
*** 18,22 ****
  #include "utils.h"
  #include "setup-softdevice.h"
- #include "SoftOsd.h"
  
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 18,21 ----
***************
*** 155,161 ****
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::OpenOSD(int X, int Y, cSoftOsd *osd)
  {
!   cVideoOut::OpenOSD(X,Y,osd);
    //OSDxOfs = X & ~7;
    //OSDyOfs = Y & ~1;
--- 154,160 ----
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::OpenOSD()
  {
!   cVideoOut::OpenOSD();
    //OSDxOfs = X & ~7;
    //OSDyOfs = Y & ~1;
***************
*** 182,193 ****
  }
  
! void cFBVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
! {
    pthread_mutex_lock(&fb_mutex);
!   OSDpresent=true;
!   Osd->CopyToBitmap(fb,line_len,OsdWidth,OsdHeight,RefreshAll);
!   //Draw(Bitmap,fb,line_len);
    pthread_mutex_unlock(&fb_mutex);
! }
  
  #else
--- 181,196 ----
  }
  
! void cFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines) {
    pthread_mutex_lock(&fb_mutex);
!   osd=fb; 
!   stride=line_len;
!   dirtyLines=NULL;
! };
! 
! void cFBVideoOut::CommitUnlockOsdSurface() {      
    pthread_mutex_unlock(&fb_mutex);
!   cVideoOut::CommitUnlockOsdSurface();
! };
  
  #else

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-fb.h	7 Jan 2006 14:28:39 -0000	1.5
--- video-fb.h	3 Feb 2006 22:34:54 -0000	1.6
***************
*** 30,39 ****
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
!   virtual void OpenOSD(int X, int Y, cSoftOsd *osd);
    virtual void ClearOSD();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
  		  bool &IsYUV, uint8_t *&pixelmask)
    { Depth=16;HasAlpha=false;IsYUV=false;pixelmask=PixelMask; };
!   virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
  #else
--- 30,41 ----
    virtual ~cFBVideoOut();
  #if VDRVERSNUM >= 10307
!   virtual void OpenOSD();
    virtual void ClearOSD();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
  		  bool &IsYUV, uint8_t *&pixelmask)
    { Depth=16;HasAlpha=false;IsYUV=false;pixelmask=PixelMask; };
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
!   virtual void CommitUnlockOsdSurface();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
  #else

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** video-shm.c	17 Jan 2006 20:45:46 -0000	1.1
--- video-shm.c	3 Feb 2006 22:34:54 -0000	1.2
***************
*** 12,16 ****
  #include "video-shm.h"
  #include "utils.h"
- #include "SoftOsd.h"
  
  #define SHMDEB(out...) {printf("SHMSERV[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
--- 12,15 ----
***************
*** 118,124 ****
          };
     
!         curr_pict_shmid=0;
          //ctl->pict_shmid=-1;
          curr_pict=NULL;
          ctl->key=kNone;
          remote = new cShmRemote("softdevice-xv",this);
--- 117,125 ----
          };
     
!         curr_pict_shmid=-1;
!         curr_osd_shmid=-1;
          //ctl->pict_shmid=-1;
          curr_pict=NULL;
+         osd_surface=NULL;
          ctl->key=kNone;
          remote = new cShmRemote("softdevice-xv",this);
***************
*** 146,160 ****
  };
  
! void cShmVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
  {
!     if (current_osdMode==OSDMODE_SOFTWARE)
! 	    Osd->CopyToBitmap(OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
!                             OSD_FULL_WIDTH,OSD_FULL_WIDTH/2,
! 			    OsdWidth,OsdHeight,RefreshAll);
  };
  
  void cShmVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
                       int Width, int Height, int Ystride, int UVstride) {
-         OsdRefreshCounter=0; 
  
          if (!ctl->attached) {
--- 147,241 ----
  };
  
! void cShmVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
!    switch (setupStore->osdMode) {
!    //switch (current_osdMode) {
!       case OSDMODE_PSEUDO :
!                 OsdWidth=ctl->osd_width;
!                 OsdHeight=ctl->osd_height;
!              break;
!       case OSDMODE_SOFTWARE:
!                 OsdWidth=swidth;
!                 OsdHeight=sheight;
!              break;
!     };
! };
! 
! void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                 bool &IsYUV, uint8_t *&PixelMask) {
!         if (setupStore->osdMode==OSDMODE_SOFTWARE) {
!                 IsYUV=true;
!                 PixelMask=NULL;
!                 return;
!         };
! 
!         IsYUV=false; 
!         Depth=ctl->osd_depth;
!         HasAlpha=false;
!         PixelMask=NULL;
! };       
! 
! void cShmVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines) {
!         if ( ctl->osd_shmid != curr_osd_shmid ) {
!                 if (osd_surface) {
!                         shmdt(osd_surface);
!                         osd_surface=NULL;
!                         osd=NULL;
!                 };
!                 
!                 if ( ctl->osd_shmid != -1 ) {
!                        if ( (osd_surface = (uint8_t *)shmat(ctl->osd_shmid,NULL,0)) 
!                                        == (uint8_t*) -1 ) {
!                                fprintf(stderr,"error attatching osd pict(%d)! Assuming no client connected\n",
!                                                ctl->osd_shmid);
!                                ctl->osd_shmid = -1;
!                                ctl->attached = 0;
!                                osd_surface=NULL;
!                                osd=NULL;
!                                return;
!                        } 
!                 };
!         };
! 
!         
!         osd=osd_surface;
!         stride=ctl->osd_stride;
!         dirtyLines=NULL;
! };
! 
! void cShmVideoOut::ClearOSD()
  {
!   cVideoOut::ClearOSD();
!   if ( ctl->osd_shmid != curr_osd_shmid ) {
!           if (osd_surface) {
!                   shmdt(osd_surface);
!                   osd_surface=NULL;
!           };
! 
!           if ( ctl->osd_shmid != -1 ) {
!                   if ( (osd_surface = (uint8_t *)shmat(ctl->osd_shmid,NULL,0)) 
!                                   == (uint8_t*) -1 ) {
!                           fprintf(stderr,"error attatching osd pict(%d)! Assuming no client connected\n",
!                                           ctl->osd_shmid);
!                           ctl->osd_shmid = -1;
!                           ctl->attached = 0;
!                           osd_surface=NULL;
!                           return;
!                   } 
!           };
!   };
!   if (osd_surface)
!           memset (osd_surface, 0, ctl->osd_stride *ctl->osd_height);
!   ctl->new_osd++;
!         sem_sig_unlock(ctl->semid,PICT_SIG);
! };
! 
! void cShmVideoOut::CommitUnlockOsdSurface() {
!         ctl->new_osd++;        
!         sem_sig_unlock(ctl->semid,PICT_SIG);
  };
  
  void cShmVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
                       int Width, int Height, int Ystride, int UVstride) {
  
          if (!ctl->attached) {
***************
*** 250,260 ****
          //SHMDEB("send signal\n");
          
- };
- 
- void cShmVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
-    if (current_osdMode==OSDMODE_SOFTWARE) {
-                 OsdWidth=swidth;
-                 OsdHeight=sheight;
-     };
  };
  
--- 331,334 ----

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** video-shm.h	17 Jan 2006 20:45:46 -0000	1.1
--- video-shm.h	3 Feb 2006 22:34:54 -0000	1.2
***************
*** 35,52 ****
          uint8_t *pixels[4];
  
          public:
          cShmVideoOut(cSetupStore *setupStore);
          ~cShmVideoOut();
-         void cShmVideoOut::RefreshOSD(cSoftOsd*, bool RefreshAll);
          
          virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
          
          virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                     bool &IsYUV, uint8_t *&PixelMask)
!         { IsYUV=true; PixelMask=NULL;};
  
          virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
                       int Width, int Height, int Ystride, int UVstride);
! 
  };
  
--- 35,56 ----
          uint8_t *pixels[4];
  
+         int curr_osd_shmid;
+         uint8_t *osd_surface;
+ 
          public:
          cShmVideoOut(cSetupStore *setupStore);
          ~cShmVideoOut();
          
          virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
          
          virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                     bool &IsYUV, uint8_t *&PixelMask);
  
          virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
                       int Width, int Height, int Ystride, int UVstride);
!         virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
!                         bool *&dirtyLines);
!         virtual void CommitUnlockOsdSurface();
!         virtual void ClearOSD();
  };
  

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-vidix.c	7 Jan 2006 14:28:39 -0000	1.13
--- video-vidix.c	3 Feb 2006 22:34:54 -0000	1.14
***************
*** 14,18 ****
  #include "utils.h"
  #include "setup-softdevice.h"
- #include "SoftOsd.h"
  
  //#define TIMINGS
--- 14,17 ----
***************
*** 585,601 ****
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::Refresh(cSoftOsd *Osd,bool RefreshAll)
! {
!     switch (current_osdMode) {
!       case OSDMODE_PSEUDO :
!               Osd->CopyToBitmap(fb,fb_line_len,OsdWidth,OsdHeight,RefreshAll);
!             break;
!       case OSDMODE_SOFTWARE:
!               Osd->CopyToBitmap(OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV,
! 			      OSD_FULL_WIDTH,OSD_FULL_WIDTH/2,
! 			      OsdWidth,OsdHeight,RefreshAll);
!             break;
!     }
! }
  
  #else
--- 584,593 ----
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                 bool *&dirtyLines) {
!         osd=fb;
!         stride=fb_line_len;
!         dirtyLines=NULL;
! };
  
  #else

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video-vidix.h	7 Jan 2006 14:28:39 -0000	1.6
--- video-vidix.h	3 Feb 2006 22:34:54 -0000	1.7
***************
*** 53,57 ****
  	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
  	  PixelMask=NULL;};
!   virtual void Refresh(cSoftOsd *Osd,bool RefreshAll=false);
  #else
    virtual void Refresh();
--- 53,58 ----
  	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
  	  PixelMask=NULL;};
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
  #else
    virtual void Refresh();

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** video-xv.c	23 Jan 2006 19:59:17 -0000	1.38
--- video-xv.c	3 Feb 2006 22:34:54 -0000	1.39
***************
*** 860,863 ****
--- 860,864 ----
                            //osd_image->bytes_per_line*height,
                            IPC_CREAT | 0777);
+           printf("osd_image allocated: %d\n",osd_shminfo.shmid);
            if (osd_shminfo.shmid == -1) {
                    dsyslog("[XvVideoOut]: Initialize ERROR: shmget FAILED !");
***************
*** 1228,1233 ****
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     //XClearArea (dpy, win, 0, 0, 0, 0, True);// still needs locking!
!     //XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
    };
--- 1229,1233 ----
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     ShowOSD(0,true);
      pthread_mutex_unlock(&xv_mutex);
    };
***************
*** 1252,1256 ****
  void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                    bool &IsYUV, uint8_t *&PixelMask) {
!         if (current_osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;
--- 1252,1256 ----
  void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                    bool &IsYUV, uint8_t *&PixelMask) {
!         if (setupStore->osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;
***************
*** 1264,1267 ****
--- 1264,1282 ----
  };       
  
+ void cXvVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
+                   bool *&dirtyLines) {
+         osd=osd_buffer;
+         stride=osd_image->bytes_per_line;
+         dirtyLines=NULL;
+ };
+ 
+ void cXvVideoOut::CommitUnlockOsdSurface() {
+         cVideoOut::CommitUnlockOsdSurface();
+         pthread_mutex_lock(&xv_mutex);
+         ++osd_refresh_counter;
+         ShowOSD(0,true);
+         pthread_mutex_unlock(&xv_mutex);
+ };
+ /*
  void cXvVideoOut::RefreshOSD(cSoftOsd *Osd,bool RefreshAll)
  {
***************
*** 1291,1295 ****
    };
  };
! 
  #else
  /* ---------------------------------------------------------------------------
--- 1306,1310 ----
    };
  };
! */
  #else
  /* ---------------------------------------------------------------------------

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-xv.h	7 Jan 2006 14:28:39 -0000	1.11
--- video-xv.h	3 Feb 2006 22:34:54 -0000	1.12
***************
*** 19,23 ****
  #define VIDEO_XV_H
  #include "video.h"
- #include "SoftOsd.h"
  
  #include <pthread.h>
--- 19,22 ----
***************
*** 130,137 ****
    XEvent            event;
    XvPortID          port;
    XShmSegmentInfo   shminfo, osd_shminfo;
    XvImage           *xv_image;
-   bool              useShm;
    XImage            *osd_image;
    int               osd_max_width,osd_max_height;
    unsigned char     *outbuffer,
--- 129,138 ----
    XEvent            event;
    XvPortID          port;
+   bool              useShm;
+ public:
    XShmSegmentInfo   shminfo, osd_shminfo;
    XvImage           *xv_image;
    XImage            *osd_image;
+ private:
    int               osd_max_width,osd_max_height;
    unsigned char     *outbuffer,
***************
*** 161,165 ****
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                    bool &IsYUV, uint8_t *&PixelMask);
!  virtual void RefreshOSD(cSoftOsd *Osd, bool RefreshAll=false);
  #else
    virtual void Refresh();
--- 162,168 ----
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                    bool &IsYUV, uint8_t *&PixelMask);
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines);
!   virtual void CommitUnlockOsdSurface();
  #else
    virtual void Refresh();

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** video.c	19 Jan 2006 19:20:02 -0000	1.41
--- video.c	3 Feb 2006 22:34:54 -0000	1.42
***************
*** 28,32 ****
    OsdWidth=OSD_FULL_WIDTH;
    OsdHeight=OSD_FULL_HEIGHT;
-   osd=NULL;
  #endif
    // set some reasonable defaults
--- 28,31 ----
***************
*** 92,109 ****
    while(active)
    {
-     int newOsdWidth;
-     int newOsdHeight;
-     bool changeMode=false;
-     int newOsdMode=0;
- 
      OsdRefreshCounter++;
- #if 0
-     if (freezeMode && OsdRefreshCounter > 10 )
-       OsdRefreshCounter=3;
- #endif
-     changeMode=(current_osdMode != setupStore->osdMode);
-     newOsdMode=setupStore->osdMode;
-     // if software osd has not been shown for some time or
-     // no signal
      if (OsdRefreshCounter > 80 ||
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
--- 91,95 ----
***************
*** 127,159 ****
        Osd_changed=0;
        osdMutex.Unlock();
-       
-     }
- #if 0
-     // freeze mode and osd changed, change osd mode
-     if ( Osd_changed && freezeMode && OsdRefreshCounter >  2 ) {
-         changeMode= (current_osdMode != OSDMODE_PSEUDO);
-         newOsdMode=OSDMODE_PSEUDO;
-     }
- #endif
-     GetOSDDimension(newOsdWidth,newOsdHeight);
-     if ( newOsdWidth==-1 || newOsdHeight==-1 )
-     {
-       newOsdWidth=OSD_FULL_WIDTH;
-       newOsdHeight=OSD_FULL_HEIGHT;
-     }
-    
-     osdMutex.Lock();
-     if (OSDpresent && osd 
-        && ( OsdWidth!=newOsdWidth  || OsdHeight!=newOsdHeight  || 
-            changeMode )
-         )
-     {
-       OSDDEB("change size: OsdWidth %d newOsdWidth %d\n",OsdWidth,newOsdWidth);
-       current_osdMode=newOsdMode;
-       // redraw the complete osd
-       OSDFlush_nolock(osd,true);
-       OSDDEB("change size end\n");
      }
-     osdMutex.Unlock();
      usleep(50000);
    }
--- 113,117 ----
***************
*** 458,504 ****
  }
  
- #if VDRVERSNUM >= 10307
- void cVideoOut::OSDFlush_nolock(cSoftOsd *Osd,bool RefreshAll)
- {
-   OSDDEB("OSDFlush RefreshAll: %d \n",
-                   RefreshAll);
- 
-   if (current_osdMode==OSDMODE_SOFTWARE)
-   	init_OsdBuffers();
- 
-   int newX,newY;
-   GetOSDDimension(newX,newY);
-   if ( newX==-1 || newY==-1 )
-   {
-     newX=OSD_FULL_WIDTH;
-     newY=OSD_FULL_HEIGHT;
-   }
-   if (newX!=OsdWidth || newY!=OsdHeight)
-   {
-     OSDDEB("new osd dimensions: %d,%d\n",newX,newY);
-     OsdWidth=newX;
-     OsdHeight=newY;
-     RefreshAll=true;
-   };
-   
- 
-   if (RefreshAll)
-     ClearOSD();
-  
-   cSoftOsd *SoftOsd=dynamic_cast<cSoftOsd*>(Osd);
-   if (SoftOsd) {
-           int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
-           uint8_t *PixelMask;
-           GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
-           SoftOsd->SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
- 	  RefreshOSD(SoftOsd,RefreshAll);
-   } else printf("SoftOsd=NULL!!!!!!!\n");
-   
-   OSDpresent=true;
-   Osd_changed = 1;
-   OSDDEB("End OSDFlush\n");
- }
- #endif
- 
  /* ---------------------------------------------------------------------------
   */
--- 416,419 ----
***************
*** 523,537 ****
  #if VDRVERSNUM >= 10307
  
! void cVideoOut::OpenOSD(int X, int Y, cSoftOsd * Osd)
  {
    OSDDEB("OpenOSD\n");
-   osd=Osd;
-   //cSoftOsd *SoftOsd=dynamic_cast<cSoftOsd*>(osd);
-   //if (SoftOsd) {
-           int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV;
-           uint8_t *PixelMask;
-           GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
-           osd->SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
-   //} else printf("SoftOSD NULL!\n");
  }
  
--- 438,444 ----
  #if VDRVERSNUM >= 10307
  
! void cVideoOut::OpenOSD()
  {
    OSDDEB("OpenOSD\n");
  }
  
***************
*** 540,544 ****
    osdMutex.Lock();
    ClearOSD();
-   osd=NULL;
    OSDpresent=false;
    Osd_changed=1;
--- 447,450 ----

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** video.h	17 Jan 2006 20:45:46 -0000	1.26
--- video.h	3 Feb 2006 22:34:54 -0000	1.27
***************
*** 19,25 ****
  #include "sync-timer.h"
  
- #if VDRVERSNUM >= 10307
- #include <vdr/osd.h>
- #endif
  #include <avcodec.h>
  
--- 19,22 ----
***************
*** 126,130 ****
      cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
-     virtual void CloseOSD();
      
      virtual void Sync(cSyncTimer *syncTimer, int *delay);
--- 123,126 ----
***************
*** 179,189 ****
  
  #if VDRVERSNUM >= 10307
!     cSoftOsd *osd;
!     void OSDFlush_nolock(cSoftOsd *Osd,bool RefreshAll=false);
!     inline void OSDFlush(cSoftOsd *Osd,bool RefreshAll=false)
!     {osdMutex.Lock();OSDFlush_nolock(Osd,RefreshAll); osdMutex.Unlock();};
!     
!     virtual void OpenOSD(int X, int Y, cSoftOsd *Osd);
!     
      virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight)
      // called whenever OSD is to be displayed
--- 175,181 ----
  
  #if VDRVERSNUM >= 10307
!     virtual void OpenOSD();
!     virtual void CloseOSD();
! 
      virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight)
      // called whenever OSD is to be displayed
***************
*** 198,203 ****
      // should be implemented by all video out method to set the OSD pixel mode
  
!     virtual void RefreshOSD(cSoftOsd *SoftOsd, bool RefreshAll=false) 
!     { return; };
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
--- 190,211 ----
      // should be implemented by all video out method to set the OSD pixel mode
  
!     // RGB modes
!     virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                     bool *&dirtyLines)
!     { osd=NULL; stride=0; dirtyLines=NULL;};
!     virtual void CommitUnlockOsdSurface()
!     { current_osdMode=OSDMODE_PSEUDO;OSDpresent=true; };
! 
!     // Software YUV mode
!     virtual void GetLockSoftOsdSurface(
!                         uint8_t *&osdPy, uint8_t *&osdPu, uint8_t *&osdPv,
!                         uint8_t *&osdPAlphaY, uint8_t *&osdPAlphaUV,
!                         int &strideY, int &strideUV)
!     { osdPy=OsdPy; osdPu=OsdPu; osdPv=OsdPv; 
!             osdPAlphaY=OsdPAlphaY; osdPAlphaUV=OsdPAlphaUV;
!             strideY=OSD_FULL_WIDTH; strideUV=OSD_FULL_WIDTH/2;};
! 
!     virtual void CommitUnlockSoftOsdSurface()
!     { current_osdMode=OSDMODE_SOFTWARE; OSDpresent=true; };
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
***************
*** 217,220 ****
--- 225,229 ----
      virtual void CloseWindow(cWindow *Window);
      virtual void Refresh() {return;};
+     virtual void CloseOSD();
  #endif
  



From nobody at sheep.berlios.de  Sat Feb  4 11:05:11 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 4 Feb 2006 11:05:11 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.144,1.145 SoftOsd.c,1.5,1.6 SoftOsd.h,1.3,1.4
Message-ID: <200602041005.k14A5Bx06087@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25183

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
   - added NoVScaleCopyToBitmap() vor YUV mode
   - fix thread termination in cSoftOsd
   - make sure that strides are multiples of 16 in cSoftOsd
	 


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.144
retrieving revision 1.145
diff -C2 -d -r1.144 -r1.145
*** CHANGELOG	3 Feb 2006 22:34:54 -0000	1.144
--- CHANGELOG	4 Feb 2006 10:05:09 -0000	1.145
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2006-03-03:
+    - added NoVScaleCopyToBitmap() vor YUV mode
+    - fix thread termination in cSoftOsd
+    - make sure that strides are multiples of 16 in cSoftOsd
  2006-02-03:
     - remove cSoftOsd and cOsd dependency from cVideoOut. Size and

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** SoftOsd.c	3 Feb 2006 22:34:54 -0000	1.5
--- SoftOsd.c	4 Feb 2006 10:05:09 -0000	1.6
***************
*** 33,37 ****
  
  cSoftOsd::cSoftOsd(cVideoOut *VideoOut, int X, int Y) 
! 	: cOsd(X, Y),active(false) {
          OSDDEB("cSoftOsd constructor\n");
          OutputConvert=&cSoftOsd::ARGB_to_ARGB32;
--- 33,37 ----
  
  cSoftOsd::cSoftOsd(cVideoOut *VideoOut, int X, int Y) 
! 	: cOsd(X, Y),active(false),close(false) {
          OSDDEB("cSoftOsd constructor\n");
          OutputConvert=&cSoftOsd::ARGB_to_ARGB32;
***************
*** 69,72 ****
--- 69,73 ----
  cSoftOsd::~cSoftOsd() {
          OSDDEB("cSoftOsd destructor\n");
+         close=true;
          active=false;
          Cancel(3);
***************
*** 82,86 ****
          OSDDEB("OSD thread started\n");
          active=true;
!         while(active && videoOut) {
                  int newOsdWidth;
                  int newOsdHeight;
--- 83,87 ----
          OSDDEB("OSD thread started\n");
          active=true;
!         while(active && videoOut && !close) {
                  int newOsdWidth;
                  int newOsdHeight;
***************
*** 115,118 ****
--- 116,120 ----
  /*--------------------------------------------------------------------------*/
  void cSoftOsd::OsdCommit() {
+         OSDDEB("OsdCommit()\n");
          int newX;
          int newY;
***************
*** 226,230 ****
  	// give priority to the other threads
  	pthread_yield();
!         if (!active)
                  Start();
  }
--- 228,232 ----
  	// give priority to the other threads
  	pthread_yield();
!         if (!active && !close)
                  Start();
  }
***************
*** 613,621 ****
  
  //---------------------------YUV modes ----------------------
- #define SCALEH_IDX(x) ((scaleH_strtIdx+(x))%lines_count)
  void cSoftOsd::CopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
  		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
                      int Ystride, int UVstride,
                      int dest_Width, int dest_Height, bool RefreshAll) {
  
          OSDDEB("CopyToBitmap YUV down\n");
--- 615,683 ----
  
  //---------------------------YUV modes ----------------------
  void cSoftOsd::CopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
  		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
                      int Ystride, int UVstride,
                      int dest_Width, int dest_Height, bool RefreshAll) {
+         OSDDEB("CopyToBitmap destsize: %d,%d\n",dest_Width,dest_Height);
+         if (dest_Height==OSD_HEIGHT)
+                 NoVScaleCopyToBitmap(PY,PU,PV,PAlphaY,PAlphaUV,Ystride,UVstride,
+                                 dest_Width,dest_Height,RefreshAll);
+         else 
+                 ScaleVDownCopyToBitmap(PY,PU,PV,PAlphaY,PAlphaUV,Ystride,UVstride,
+                                 dest_Width,dest_Height,RefreshAll);
+ };
+                 
+ void cSoftOsd::NoVScaleCopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
+ 		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
+                     int Ystride, int UVstride,
+                     int dest_Width, int dest_Height, bool RefreshAll) {
+         OSDDEB("CopyToBitmap YUV no Vscale\n");
+  	cMutexLock dirty(&dirty_Mutex);
+         color *pixmap=(color*) OSD_Bitmap;
+         int dest_Stride=(dest_Width+32) & ~0xf;
+         color tmp_pixmap[2*dest_Stride];
+         uint8_t *pY;uint8_t *pU;uint8_t *pV;
+         uint8_t *pAlphaY; uint8_t *pAlphaUV;
+  	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
+ 	ScaleHoriz = ( dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
+                       ( dest_Width==OSD_WIDTH ? &cSoftOsd::NoScaleHoriz_MMX :
+                         &cSoftOsd::ScaleUpHoriz_MMX));
+       
+         for (int y=0; y<dest_Height; y+=2) {
+ 
+                 int is_dirty=RefreshAll;
+                 is_dirty |= dirty_lines[y] || dirty_lines[y+1];
+ 
+                 if (!is_dirty) 
+                         continue;
+ 
+                 //printf("Horiz scaling line %d\n",start_row+i);
+                 (this->*ScaleHoriz)((uint8_t *)tmp_pixmap,dest_Width,
+                                 &pixmap[y*OSD_STRIDE],OSD_WIDTH-1); 
+                 (this->*ScaleHoriz)((uint8_t *)&tmp_pixmap[dest_Stride],
+                                 dest_Width,
+                                 &pixmap[(y+1)*OSD_STRIDE],OSD_WIDTH-1); 
+ 
+                 // convert and copy to video out OSD layer
+                 pY=PY+y*Ystride;
+                 pU=PU+y*UVstride/2;
+                 pV=PV+y*UVstride/2;
+                 pAlphaY=PAlphaY+y*Ystride;
+                 pAlphaUV=PAlphaUV+y*UVstride/2;
+                 AYUV_to_AYUV420P(pY,pY+Ystride,pU,pV,
+                                 pAlphaY,pAlphaY+Ystride,pAlphaUV,
+                                 //              &pixmap[y*OSD_STRIDE],&pixmap[(y+1)*OSD_STRIDE],
+                                 //              dest_Width);
+                         tmp_pixmap,&tmp_pixmap[dest_Stride],dest_Width);
+         };
+         memset(dirty_lines,false,sizeof(dirty_lines));
+         OSDDEB("CopyToBitmap YUV no Vscale end \n");
+ };
+        
+ #define SCALEH_IDX(x) ((scaleH_strtIdx+(x))%lines_count)
+ void cSoftOsd::ScaleVDownCopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
+ 		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
+                     int Ystride, int UVstride,
+                     int dest_Width, int dest_Height, bool RefreshAll) {
  
          OSDDEB("CopyToBitmap YUV down\n");
***************
*** 739,743 ****
  	
  	cMutexLock dirty(&dirty_Mutex);
! 	const int dest_stride=dest_Width+16;
  	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
--- 801,805 ----
  	
  	cMutexLock dirty(&dirty_Mutex);
! 	const int dest_stride=(dest_Width+32)&~0xF;
  	void (cSoftOsd::*ScaleHoriz)(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
  	ScaleHoriz= dest_Width<OSD_WIDTH ? &cSoftOsd::ScaleDownHoriz_MMX :
***************
*** 843,847 ****
          uint8_t *buf;
          color *pixmap=(color*) OSD_Bitmap;
! 	const int dest_stride=dest_Width+16;
          color tmp_pixmap[2*dest_stride];
  
--- 905,909 ----
          uint8_t *buf;
          color *pixmap=(color*) OSD_Bitmap;
! 	const int dest_stride=(dest_Width+32)&~0xF;
          color tmp_pixmap[2*dest_stride];
  
***************
*** 1039,1042 ****
--- 1101,1108 ----
  };
  
+ void cSoftOsd::NoScaleHoriz_MMX(uint8_t * dest, int dest_Width, 
+                 color * pixmap, int Pixel) {
+         memcpy(dest,pixmap,Pixel*sizeof(color));
+ };
  
  //-----------------------------------------------------------------

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** SoftOsd.h	3 Feb 2006 22:34:54 -0000	1.3
--- SoftOsd.h	4 Feb 2006 10:05:09 -0000	1.4
***************
*** 76,79 ****
--- 76,80 ----
     
      bool active;
+     bool close;
      int ScreenOsdWidth;
      int ScreenOsdHeight;
***************
*** 114,117 ****
--- 115,129 ----
                      int Ystride, int UVstride,
                      int dest_Width, int dest_Height, bool RefreshAll=false);
+   
+     void NoVScaleCopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
+ 		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
+                     int Ystride, int UVstride,
+                     int dest_Width, int dest_Height, bool RefreshAll=false);
+ 
+     void ScaleVDownCopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
+ 		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
+                     int Ystride, int UVstride,
+                     int dest_Width, int dest_Height, bool RefreshAll=false);
+     
  
      // ARGB packed modes
***************
*** 129,132 ****
--- 141,145 ----
      
   private:
+     void NoScaleHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
      void ScaleUpHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);
      void ScaleDownHoriz_MMX(uint8_t * dest, int dest_Width, color * pixmap,int Pixel);



From nobody at sheep.berlios.de  Sat Feb  4 11:25:41 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 4 Feb 2006 11:25:41 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.145,1.146 shm-common.h,1.2,1.3 video-shm.c,1.2,1.3 video-shm.h,1.2,1.3 ShmClient.c,1.2,1.3
Message-ID: <200602041025.k14APfx06846@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27769

Modified Files:
	CHANGELOG shm-common.h video-shm.c video-shm.h ShmClient.c 
Log Message:
   - compile fix for video-shm.h
   - some fixes in the osd handling of video-shm


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.145
retrieving revision 1.146
diff -C2 -d -r1.145 -r1.146
*** CHANGELOG	4 Feb 2006 10:05:09 -0000	1.145
--- CHANGELOG	4 Feb 2006 10:25:39 -0000	1.146
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2006-03-03:
+    - compile fix for video-shm.h
+    - some fixes in the osd handling of video-shm
     - added NoVScaleCopyToBitmap() vor YUV mode
     - fix thread termination in cSoftOsd

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** shm-common.h	3 Feb 2006 22:34:54 -0000	1.2
--- shm-common.h	4 Feb 2006 10:25:39 -0000	1.3
***************
*** 59,62 ****
--- 59,64 ----
          int osd_width;
          int osd_height;
+         int osd_max_width;
+         int osd_max_height;
          int osd_depth;
          int osd_stride;

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-shm.c	3 Feb 2006 22:34:54 -0000	1.2
--- video-shm.c	4 Feb 2006 10:25:39 -0000	1.3
***************
*** 83,86 ****
--- 83,87 ----
                  ctl->semid=-1;
                  ctl->pict_shmid=-1;
+                 ctl->osd_shmid=-1;
                  ctl->attached = 0;
          };
***************
*** 151,156 ****
     //switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!                 OsdWidth=ctl->osd_width;
!                 OsdHeight=ctl->osd_height;
               break;
        case OSDMODE_SOFTWARE:
--- 152,159 ----
     //switch (current_osdMode) {
        case OSDMODE_PSEUDO :
!                 OsdWidth=ctl->osd_width>ctl->osd_max_width?
!                         ctl->osd_max_width:ctl->osd_width;
!                 OsdHeight=ctl->osd_height>ctl->osd_max_height?
!                         ctl->osd_max_height:ctl->osd_height;
               break;
        case OSDMODE_SOFTWARE:
***************
*** 177,180 ****
--- 180,184 ----
  void cShmVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
                    bool *&dirtyLines) {
+ 	SHMDEB("GetLockOsdSurface osd_surface %p\n",osd_surface);
          if ( ctl->osd_shmid != curr_osd_shmid ) {
                  if (osd_surface) {
***************
*** 185,192 ****
--- 189,198 ----
                  
                  if ( ctl->osd_shmid != -1 ) {
+                        SHMDEB("get new osd_surface %p\n",osd_surface);
                         if ( (osd_surface = (uint8_t *)shmat(ctl->osd_shmid,NULL,0)) 
                                         == (uint8_t*) -1 ) {
                                 fprintf(stderr,"error attatching osd pict(%d)! Assuming no client connected\n",
                                                 ctl->osd_shmid);
+                                ctl->pict_shmid = -1;
                                 ctl->osd_shmid = -1;
                                 ctl->attached = 0;
***************
*** 194,202 ****
                                 osd=NULL;
                                 return;
!                        } 
                  };
          };
  
-         
          osd=osd_surface;
          stride=ctl->osd_stride;
--- 200,209 ----
                                 osd=NULL;
                                 return;
!                        }
!                        curr_osd_shmid=ctl->osd_shmid;
                  };
+ 	        SHMDEB("got new osd_surface %p\n",osd_surface);
          };
  
          osd=osd_surface;
          stride=ctl->osd_stride;
***************
*** 206,209 ****
--- 213,217 ----
  void cShmVideoOut::ClearOSD()
  {
+   SHMDEB("ClearOsd\n");
    cVideoOut::ClearOSD();
    if ( ctl->osd_shmid != curr_osd_shmid ) {
***************
*** 226,235 ****
    };
    if (osd_surface)
!           memset (osd_surface, 0, ctl->osd_stride *ctl->osd_height);
    ctl->new_osd++;
!         sem_sig_unlock(ctl->semid,PICT_SIG);
  };
  
  void cShmVideoOut::CommitUnlockOsdSurface() {
          ctl->new_osd++;        
          sem_sig_unlock(ctl->semid,PICT_SIG);
--- 234,244 ----
    };
    if (osd_surface)
!           memset (osd_surface, 0, ctl->osd_stride *ctl->osd_max_height);
    ctl->new_osd++;
!   sem_sig_unlock(ctl->semid,PICT_SIG);
  };
  
  void cShmVideoOut::CommitUnlockOsdSurface() {
+         SHMDEB("CommitOsd\n");
          ctl->new_osd++;        
          sem_sig_unlock(ctl->semid,PICT_SIG);

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** video-shm.h	3 Feb 2006 22:34:54 -0000	1.2
--- video-shm.h	4 Feb 2006 10:25:39 -0000	1.3
***************
*** 23,26 ****
--- 23,28 ----
  #include <vdr/remote.h>
  
+ class cShmRemote;
+ 
  /*-------------------------------------------------------------------------*/
  class cShmVideoOut : public cVideoOut {

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** ShmClient.c	3 Feb 2006 22:34:54 -0000	1.2
--- ShmClient.c	4 Feb 2006 10:25:39 -0000	1.3
***************
*** 126,129 ****
--- 126,131 ----
          ctl->osd_stride=vout->osd_image->bytes_per_line;
          ctl->osd_depth=vout->osd_image->bits_per_pixel;
+         ctl->osd_max_width=vout->osd_max_width;
+         ctl->osd_max_height=vout->osd_max_height;
          vout->GetOSDDimension(ctl->osd_width,ctl->osd_height);
          printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
***************
*** 154,157 ****
--- 156,160 ----
                  };
                  if (ctl->new_osd) {
+                         SHMDEB("new osd picture\n");
                          vout->CommitUnlockOsdSurface();
                          ctl->new_osd=0;



From nobody at sheep.berlios.de  Sat Feb  4 15:40:07 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 4 Feb 2006 15:40:07 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.146,1.147 ShmClient.c,1.3,1.4 video-shm.c,1.3,1.4 README,1.12,1.13
Message-ID: <200602041440.k14Ee7x17351@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22522

Modified Files:
	CHANGELOG ShmClient.c video-shm.c README 
Log Message:
- add more documentation to the readme
- fix ShmClient pixel[] array initialisation
      


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.146
retrieving revision 1.147
diff -C2 -d -r1.146 -r1.147
*** CHANGELOG	4 Feb 2006 10:25:39 -0000	1.146
--- CHANGELOG	4 Feb 2006 14:40:04 -0000	1.147
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2006-03-03:
+    - add more documentation to the readme
+    - fix ShmClient pixel[] array initialisation
     - compile fix for video-shm.h
     - some fixes in the osd handling of video-shm
***************
*** 11,15 ****
     - introduce separate OSD layer in ShmClient/video-shm
  2006-01-19:
!    - now correct fix for CheckArea() not updateing the aspect ratio
  2006-01-17:
     - add video-shm and ShmClient, a simple server/client model for the 
--- 13,17 ----
     - introduce separate OSD layer in ShmClient/video-shm
  2006-01-19:
!    - now correct fix for CheckArea() not updating the aspect ratio
  2006-01-17:
     - add video-shm and ShmClient, a simple server/client model for the 

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** ShmClient.c	4 Feb 2006 10:25:39 -0000	1.3
--- ShmClient.c	4 Feb 2006 14:40:04 -0000	1.4
***************
*** 112,117 ****
   
          pixel[0]=curr_pict;
!         pixel[1]=curr_pict+ctl->height*ctl->stride0;
!         pixel[2]=pixel[1]+ctl->height/2*ctl->stride1;
  
          ctl->attached=1;
--- 112,117 ----
   
          pixel[0]=curr_pict;
!         pixel[1]=curr_pict+ctl->max_height*ctl->stride0;
!         pixel[2]=pixel[1]+ctl->max_height/2*ctl->stride1;
  
          ctl->attached=1;

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** video-shm.c	4 Feb 2006 10:25:39 -0000	1.3
--- video-shm.c	4 Feb 2006 14:40:04 -0000	1.4
***************
*** 274,279 ****
                         } 
                         pixels[0]=curr_pict;
!                        pixels[1]=curr_pict+ctl->height*ctl->stride0;
!                        pixels[2]=pixels[1]+ctl->height/2*ctl->stride1;
                         curr_pict_shmid=ctl->pict_shmid;
                  };
--- 274,279 ----
                         } 
                         pixels[0]=curr_pict;
!                        pixels[1]=curr_pict+ctl->max_height*ctl->stride0;
!                        pixels[2]=pixels[1]+ctl->max_height/2*ctl->stride1;
                         curr_pict_shmid=ctl->pict_shmid;
                  };

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** README	17 Jan 2006 20:45:46 -0000	1.12
--- README	4 Feb 2006 14:40:04 -0000	1.13
***************
*** 119,122 ****
--- 119,129 ----
  It is possible to make a client for the other video-out methods too, but
  I found the Xv-Client the most usefull for combined desktop/vdr machines :-)
+ The softdevice doesn't always remove the shared memory segment which is
+ used for comunication with the client, if you have troubles with that (or
+ you get an error message that the client/server can't connect to the shm ctl)
+ you can remove the shared memory segment with "ipcrm". First you have to
+ find out the shared memory id, type the command "ipcs" and look for the
+ key "0x0000162" the shared memory id is next to it. Them remove the
+ shared memory segment with "ipcrm shm shared_memory_id".
  
  



From nobody at sheep.berlios.de  Sat Feb  4 18:33:34 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 4 Feb 2006 18:33:34 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.147,1.148 video.h,1.27,1.28 video-xv.c,1.39,1.40 video-xv.h,1.12,1.13
Message-ID: <200602041733.k14HXYx24271@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15842

Modified Files:
	CHANGELOG video.h video-xv.c video-xv.h 
Log Message:
- remove unused code, variables and parameters from video-xv



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.147
retrieving revision 1.148
diff -C2 -d -r1.147 -r1.148
*** CHANGELOG	4 Feb 2006 14:40:04 -0000	1.147
--- CHANGELOG	4 Feb 2006 17:33:31 -0000	1.148
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2006-03-03:
+    - remove unused code, variables and parameters from video-xv
     - add more documentation to the readme
     - fix ShmClient pixel[] array initialisation

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** video.h	3 Feb 2006 22:34:54 -0000	1.27
--- video.h	4 Feb 2006 17:33:31 -0000	1.28
***************
*** 137,141 ****
      virtual bool Initialize(void) {return 1;};
      virtual bool Reconfigure (int format) {return 1;};
-     virtual bool GetInfo(int *fmt, unsigned char **dest,int *w, int *h) {return false;};
  
      virtual void Suspend(void) { return;};
--- 137,140 ----

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** video-xv.c	3 Feb 2006 22:34:54 -0000	1.39
--- video-xv.c	4 Feb 2006 17:33:31 -0000	1.40
***************
*** 299,311 ****
  /* ---------------------------------------------------------------------------
   */
- Bool chk_event (Display *d, XEvent *e, char *a)
- {
-   if (e->type == KeyPress)
-     return True;
-   return False;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
  cXvRemote::cXvRemote(const char *Name, cXvVideoOut *vout) : cRemote(Name)
  {
--- 299,302 ----
***************
*** 340,344 ****
      if (events_not_done > 2) {
        video_out->ProcessEvents ();
-       video_out->ShowOSD (0, True);
        events_not_done = 0;
      } else {
--- 331,334 ----
***************
*** 471,479 ****
  
      char            buffer [80];
!     int             len,
!                     map_count = 0;
      XComposeStatus  compose;
      KeySym          keysym;
      struct timeval  current_time;
  
    while (XCheckMaskEvent (dpy, /* win, */
--- 461,469 ----
  
      char            buffer [80];
!     int             map_count = 0;
      XComposeStatus  compose;
      KeySym          keysym;
      struct timeval  current_time;
+     XEvent            event;
  
    while (XCheckMaskEvent (dpy, /* win, */
***************
*** 530,534 ****
          button_time = current_time.tv_sec;
  
!         len = XLookupString (&event. xkey, buffer, 80, &keysym, &compose);
          switch (keysym)
          {
--- 520,524 ----
          button_time = current_time.tv_sec;
  
!         XLookupString (&event.xkey, buffer, 80, &keysym, &compose);
          switch (keysym)
          {
***************
*** 645,649 ****
      if (map_count) {
        XClearArea (dpy, win, 0, 0, 0, 0, False);
!       ShowOSD(0,false);
        XvShmPutImage(dpy, port,
                      win, gc,
--- 635,639 ----
      if (map_count) {
        XClearArea (dpy, win, 0, 0, 0, 0, False);
!       ShowOSD();
        XvShmPutImage(dpy, port,
                      win, gc,
***************
*** 683,687 ****
     */
    display_aspect = current_aspect = setupStore->xvAspect;
-   scale_size = 0;
    screenPixelAspect = -1;
    xvWidth  = width  = XV_SRC_WIDTH;
--- 673,676 ----
***************
*** 690,694 ****
    format = FOURCC_YV12;
    use_xv_port = 0;
-   len = width * height * 4;
    outbuffer = NULL;
    w_name = "vdr";
--- 679,682 ----
***************
*** 769,778 ****
            displayAspect, displayRatio, parValues[0]);
  
-   if (scale_size) {
-     lwidth  = (int)(((double)lwidth  * (double)scale_size)/100.0);
-     lheight = (int)(((double)lheight * (double)scale_size)/100.0);
-     dwidth  = (int)(((double)dwidth  * (double)scale_size)/100.0);
-     dheight = (int)(((double)dheight * (double)scale_size)/100.0);
-   }
    if (flags & XV_FORMAT_MASK) {
      hints.flags |= PAspect;
--- 757,760 ----
***************
*** 802,806 ****
  
    XMapRaised(dpy, win);
!   XNextEvent(dpy, &event);
  
    gc = XCreateGC(dpy, win, 0, &values);
--- 784,788 ----
  
    XMapRaised(dpy, win);
!   //XNextEvent(dpy, &event);
  
    gc = XCreateGC(dpy, win, 0, &values);
***************
*** 941,944 ****
--- 923,927 ----
      XvAdaptorInfo       *ad_info;
      XvImageFormatValues *fmt_info;
+     int                 len=0;
  
    pthread_mutex_lock(&xv_mutex);
***************
*** 1182,1196 ****
  /* ---------------------------------------------------------------------------
   */
- bool cXvVideoOut::GetInfo(int *fmt, unsigned char **dest, int *w, int *h)
- {
-   *fmt = format;
-   *dest = (unsigned char *) xv_image->data;
-   *w = width;
-   *h = height;
-   return true;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
  void cXvVideoOut::CloseOSD()
  {
--- 1165,1168 ----
***************
*** 1211,1217 ****
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
      pthread_mutex_lock(&xv_mutex);
-     osd_refresh_counter = osd_skip_counter = 0;
      XClearArea (dpy, win, 0, 0, 0, 0, False);
!     ShowOSD(0,false);
      XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
--- 1183,1188 ----
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
      pthread_mutex_lock(&xv_mutex);
      XClearArea (dpy, win, 0, 0, 0, 0, False);
!     ShowOSD();
      XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
***************
*** 1229,1233 ****
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     ShowOSD(0,true);
      pthread_mutex_unlock(&xv_mutex);
    };
--- 1200,1205 ----
      pthread_mutex_lock(&xv_mutex);
      memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
!     ShowOSD();
!     XSync(dpy, False);
      pthread_mutex_unlock(&xv_mutex);
    };
***************
*** 1274,1279 ****
          cVideoOut::CommitUnlockOsdSurface();
          pthread_mutex_lock(&xv_mutex);
!         ++osd_refresh_counter;
!         ShowOSD(0,true);
          pthread_mutex_unlock(&xv_mutex);
  };
--- 1246,1251 ----
          cVideoOut::CommitUnlockOsdSurface();
          pthread_mutex_lock(&xv_mutex);
!         ShowOSD();
!         XSync(dpy, False);
          pthread_mutex_unlock(&xv_mutex);
  };
***************
*** 1300,1304 ****
      }
      pthread_mutex_lock(&xv_mutex);
-     ++osd_refresh_counter;
      ShowOSD(0,1);
      //OSDpresent=true;
--- 1272,1275 ----
***************
*** 1356,1365 ****
      {
        pthread_mutex_lock(&xv_mutex);
!       ++osd_refresh_counter;
!       osd_x = x0;
!       osd_y = y0;
!       osd_w = w;
!       osd_h = h;
!       ShowOSD(0,1);
        pthread_mutex_unlock(&xv_mutex);
  
--- 1327,1332 ----
      {
        pthread_mutex_lock(&xv_mutex);
!       ShowOSD();
!       XSync(dpy, False);
        pthread_mutex_unlock(&xv_mutex);
  
***************
*** 1371,1408 ****
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::ShowOSD (int skip, int do_sync)
  {
!   //if (OSDpresent) 
!   {
!     //if (osd_refresh_counter) {
!       if (current_osdMode==OSDMODE_PSEUDO ){//&& osd_skip_counter > skip) {
!      
  #if VDRVERSNUM >= 10307
!         int x= lwidth > osd_max_width ?(lwidth - osd_max_width)/2+lxoff:lxoff;
!         int y= lheight > osd_max_height ? (lheight - osd_max_height) / 2+lyoff:lyoff;
  #else
!         int x=lwidth > OSD_WIDTH ?(lwidth - OSD_WIDTH)/2+lxoff:lxoff;
! 	int y=lheight > OSD_HEIGHT?(lheight - OSD_HEIGHT) / 2+lyoff:lyoff;
  #endif
! 	if (useShm) 
! 		XShmPutImage (dpy, win, gc, osd_image,
! 				1,1,
! 				x,y,
! 				lwidth-1,lheight-1,
! 				False);
! 	else
! 		XPutImage (dpy, win, gc, osd_image,
! 				1,
! 				1,
! 				x,y,
! 				lwidth-1,lheight-1);
!         if (do_sync)
!           XSync(dpy, False);
!         osd_skip_counter = 0;
!         //osd_refresh_counter--;
!       } else {
!         osd_skip_counter++;
!       }
!     //}
    }
  }
--- 1338,1363 ----
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::ShowOSD ()
  {
!   if (current_osdMode==OSDMODE_PSEUDO ) {
  #if VDRVERSNUM >= 10307
!     int x= lwidth > osd_max_width ?(lwidth - osd_max_width)/2+lxoff:lxoff;
!     int y= lheight > osd_max_height ? (lheight - osd_max_height) / 2+lyoff:lyoff;
  #else
!     int x=lwidth > OSD_WIDTH ?(lwidth - OSD_WIDTH)/2+lxoff:lxoff;
!     int y=lheight > OSD_HEIGHT?(lheight - OSD_HEIGHT) / 2+lyoff:lyoff;
  #endif
!     if (useShm) 
!       XShmPutImage (dpy, win, gc, osd_image,
!           1,1,
!           x,y,
!           lwidth-1,lheight-1,
!           False);
!     else
!       XPutImage (dpy, win, gc, osd_image,
!           1,
!           1,
!           x,y,
!           lwidth-1,lheight-1);
    }
  }
***************
*** 1425,1429 ****
    {
      XClearArea (dpy, win, 0, 0, 0, 0, False);
!     ShowOSD(0,false);
      aspect_changed = 0;
      cutTop = setupStore->cropTopLines;
--- 1380,1384 ----
    {
      XClearArea (dpy, win, 0, 0, 0, 0, False);
!     ShowOSD();
      aspect_changed = 0;
      cutTop = setupStore->cropTopLines;
***************
*** 1510,1514 ****
                  lwidth, lheight,   /* dw, dh */
                  False);
-           //ShowOSD (1, False);
    }
    ProcessEvents ();
--- 1465,1468 ----

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-xv.h	3 Feb 2006 22:34:54 -0000	1.12
--- video-xv.h	4 Feb 2006 17:33:31 -0000	1.13
***************
*** 111,119 ****
                      toggleInProgress,
                      xv_initialized,
-                     osd_refresh_counter,
-                     osd_skip_counter,
-                     osd_x, osd_y,
-                     osd_w, osd_h,
- 
                      /* -------------------------------------------------------
                       * could be specified via argv or parameters
--- 111,114 ----
***************
*** 121,131 ****
                      xvWidth, xvHeight,
                      width, height,
-                     attr,
-                     len,
-                     scale_size,
                      format;
  
!   GC                gc, osd_gc;
!   XEvent            event;
    XvPortID          port;
    bool              useShm;
--- 116,122 ----
                      xvWidth, xvHeight,
                      width, height,
                      format;
  
!   GC                gc;
    XvPortID          port;
    bool              useShm;
***************
*** 134,139 ****
    XvImage           *xv_image;
    XImage            *osd_image;
- private:
    int               osd_max_width,osd_max_height;
    unsigned char     *outbuffer,
                      *osd_buffer,
--- 125,130 ----
    XvImage           *xv_image;
    XImage            *osd_image;
    int               osd_max_width,osd_max_height;
+ private:
    unsigned char     *outbuffer,
                      *osd_buffer,
***************
*** 155,159 ****
    virtual ~cXvVideoOut();
    void ProcessEvents ();
!   void ShowOSD (int skip, int do_sync);
  
  #if VDRVERSNUM >= 10307
--- 146,150 ----
    virtual ~cXvVideoOut();
    void ProcessEvents ();
!   void ShowOSD ();
  
  #if VDRVERSNUM >= 10307
***************
*** 174,178 ****
    virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);
-   virtual bool GetInfo(int *fmt, unsigned char **dest,int *w, int *h);
  
    virtual void Suspend();
--- 165,168 ----



From nobody at sheep.berlios.de  Sun Feb  5 12:56:00 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 5 Feb 2006 12:56:00 +0100
Subject: [Softdevice-cvs] softdevice video-xv.c,1.40,1.41
Message-ID: <200602051156.k15Bu0x30146@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26533

Modified Files:
	video-xv.c 
Log Message:
compile fix for vdr-1.2.x

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** video-xv.c	4 Feb 2006 17:33:31 -0000	1.40
--- video-xv.c	5 Feb 2006 11:55:54 -0000	1.41
***************
*** 29,33 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2005-11-06"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 29,33 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2006-02-05"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 1345,1350 ****
      int y= lheight > osd_max_height ? (lheight - osd_max_height) / 2+lyoff:lyoff;
  #else
!     int x=lwidth > OSD_WIDTH ?(lwidth - OSD_WIDTH)/2+lxoff:lxoff;
!     int y=lheight > OSD_HEIGHT?(lheight - OSD_HEIGHT) / 2+lyoff:lyoff;
  #endif
      if (useShm) 
--- 1345,1350 ----
      int y= lheight > osd_max_height ? (lheight - osd_max_height) / 2+lyoff:lyoff;
  #else
!     int x=lwidth > OSD_FULL_WIDTH ?(lwidth - OSD_FULL_WIDTH)/2+lxoff:lxoff;
!     int y=lheight > OSD_FULL_HEIGHT?(lheight - OSD_FULL_HEIGHT) / 2+lyoff:lyoff;
  #endif
      if (useShm) 



From nobody at sheep.berlios.de  Mon Feb  6 07:58:56 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 6 Feb 2006 07:58:56 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.148,1.149 softdevice.c,1.51,1.52 softdevice.h,1.7,1.8
Message-ID: <200602060658.k166wux10424@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11242

Modified Files:
	CHANGELOG softdevice.c softdevice.h 
Log Message:
fix for vdr-1.3.42 compatibility

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.148
retrieving revision 1.149
diff -C2 -d -r1.148 -r1.149
*** CHANGELOG	4 Feb 2006 17:33:31 -0000	1.148
--- CHANGELOG	6 Feb 2006 06:58:49 -0000	1.149
***************
*** 1,4 ****
  Changelog
! 2006-03-03:
     - remove unused code, variables and parameters from video-xv
     - add more documentation to the readme
--- 1,6 ----
  Changelog
! 2006-02-06:
!    - fix for vdr-1.3.42 compatibility
! 2006-02-03:
     - remove unused code, variables and parameters from video-xv
     - add more documentation to the readme

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** softdevice.c	17 Jan 2006 20:45:46 -0000	1.51
--- softdevice.c	6 Feb 2006 06:58:49 -0000	1.52
***************
*** 527,533 ****
--- 527,540 ----
  }
  #else
+ 
+ # if VDRVERSNUM >= 10342
+ /* ----------------------------------------------------------------------------
+  */
+ int cSoftDevice::PlayAudio(const uchar *Data, int Length, uchar Id)
+ # else
  /* ----------------------------------------------------------------------------
   */
  int cSoftDevice::PlayAudio(const uchar *Data, int Length)
+ # endif
  {
    //fprintf(stderr,"PlayAudio...\n");

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** softdevice.h	12 Nov 2005 15:47:34 -0000	1.7
--- softdevice.h	6 Feb 2006 06:58:49 -0000	1.8
***************
*** 115,120 ****
    virtual int  GetAudioChannelDevice(void);
    virtual void SetDigitalAudioDevice(bool On);
!   virtual void SetAudioTrackDevice(eTrackType Type);  
    virtual int  PlayAudio(const uchar *Data, int Length);
  #endif
  #if VDRVERSNUM >= 10307
--- 115,126 ----
    virtual int  GetAudioChannelDevice(void);
    virtual void SetDigitalAudioDevice(bool On);
!   virtual void SetAudioTrackDevice(eTrackType Type);
! 
! # if VDRVERSNUM >= 10342
!   virtual int  PlayAudio(const uchar *Data, int Length, uchar Id);
! # else
    virtual int  PlayAudio(const uchar *Data, int Length);
+ # endif
+ 
  #endif
  #if VDRVERSNUM >= 10307



From nobody at sheep.berlios.de  Mon Feb  6 20:39:01 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 6 Feb 2006 20:39:01 +0100
Subject: [Softdevice-cvs] softdevice softdevice.c,1.52,1.53 video.c,1.42,1.43
Message-ID: <200602061939.k16Jd1E12248@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27911

Modified Files:
	softdevice.c video.c 
Log Message:
disable  vdr-1.2.x OSD trace messages

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** softdevice.c	6 Feb 2006 06:58:49 -0000	1.52
--- softdevice.c	6 Feb 2006 19:38:56 -0000	1.53
***************
*** 140,144 ****
      xOfs=X; // this position should be recalculated
      yOfs=Y;
!     fprintf(stderr,"[softdevice] OSD-Position at %d x %d\n",X,Y);
      videoOut->OpenOSD(X, Y);
  }
--- 140,144 ----
      xOfs=X; // this position should be recalculated
      yOfs=Y;
!     //fprintf(stderr,"[softdevice] OSD-Position at %d x %d\n",X,Y);
      videoOut->OpenOSD(X, Y);
  }
***************
*** 148,152 ****
        videoOut=0;
      }
!     fprintf(stderr,"[softdevice] OSD is off now\n");
  }
  
--- 148,152 ----
        videoOut=0;
      }
!     //fprintf(stderr,"[softdevice] OSD is off now\n");
  }
  

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** video.c	3 Feb 2006 22:34:54 -0000	1.42
--- video.c	6 Feb 2006 19:38:56 -0000	1.43
***************
*** 610,614 ****
      OSDpseudo_alpha = alpha;
      imagedata=(unsigned char *)malloc(W*H*4); // RGBA Screen memory
!     printf("[video] Creating WindowLayer at %d x %d, (%d x %d)\n",X,Y,W,H);
  }
  
--- 610,614 ----
      OSDpseudo_alpha = alpha;
      imagedata=(unsigned char *)malloc(W*H*4); // RGBA Screen memory
!     //printf("[video] Creating WindowLayer at %d x %d, (%d x %d)\n",X,Y,W,H);
  }
  



From nobody at sheep.berlios.de  Mon Feb  6 20:44:10 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 6 Feb 2006 20:44:10 +0100
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.46,1.47
Message-ID: <200602061944.k16JiAE12386@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29676

Modified Files:
	video-dfb.c 
Log Message:
disable trace messages

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** video-dfb.c	3 Feb 2006 22:34:54 -0000	1.46
--- video-dfb.c	6 Feb 2006 19:44:06 -0000	1.47
***************
*** 1031,1035 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride, 
                                       bool *&DirtyLines) {
    int               pitch;
--- 1031,1035 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
                                       bool *&DirtyLines) {
    int               pitch;
***************
*** 1051,1061 ****
      delete ex;
    }
! };
  
  void cDFBVideoOut::CommitUnlockOsdSurface() {
    if (!tmpOsdSurface)
      return;
  
!   printf("CommitUnlockOsdSurface %p\n",tmpOsdSurface);fflush(stdout);
    try 
    {
--- 1051,1063 ----
      delete ex;
    }
! }
  
+ /* ---------------------------------------------------------------------------
+  */
  void cDFBVideoOut::CommitUnlockOsdSurface() {
    if (!tmpOsdSurface)
      return;
  
!   //printf("CommitUnlockOsdSurface %p\n",tmpOsdSurface);fflush(stdout);
    try 
    {
***************
*** 1084,1088 ****
        tmpOsdSurface->Blit(tmpOsdSurface,&osdsrc,0,miny);
  
!   printf("CommitUnlockOsdSurface3 %p\n",tmpOsdSurface);fflush(stdout);
        miny=maxy;
  
--- 1086,1090 ----
        tmpOsdSurface->Blit(tmpOsdSurface,&osdsrc,0,miny);
  
!       //printf("CommitUnlockOsdSurface3 %p\n",tmpOsdSurface);fflush(stdout);
        miny=maxy;
  
***************
*** 1096,1100 ****
      delete ex;
    }
!   printf("CommitUnlockOsdSurface %p 4\n",tmpOsdSurface);fflush(stdout);
    free(dirtyLines);
    dirtyLines=NULL;
--- 1098,1102 ----
      delete ex;
    }
!   //printf("CommitUnlockOsdSurface %p 4\n",tmpOsdSurface);fflush(stdout);
    free(dirtyLines);
    dirtyLines=NULL;
***************
*** 1102,1105 ****
--- 1104,1108 ----
    cVideoOut::CommitUnlockOsdSurface();
  }
+ 
  /*
  void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll) 



From nobody at sheep.berlios.de  Mon Feb  6 20:59:38 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 6 Feb 2006 20:59:38 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.149,1.150 ShmClient.c,1.4,1.5 Makefile,1.23,1.24
Message-ID: <200602061959.k16JxcE12953@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5159

Modified Files:
	CHANGELOG ShmClient.c Makefile 
Log Message:
- fix linking of ShmClient with vdr-1.3.42
- add usleep to ShmClient (to avoid busy loop in case there are no 
  semaphores)
	   


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.149
retrieving revision 1.150
diff -C2 -d -r1.149 -r1.150
*** CHANGELOG	6 Feb 2006 06:58:49 -0000	1.149
--- CHANGELOG	6 Feb 2006 19:59:34 -0000	1.150
***************
*** 1,4 ****
  Changelog
! 2006-02-06:
     - fix for vdr-1.3.42 compatibility
  2006-02-03:
--- 1,8 ----
  Changelog
! 2006-06-03:
!    - fix linking of ShmClient with vdr-1.3.42
!    - add usleep to ShmClient (to avoid busy loop in case there are no 
!      semaphores)
! 2006-03-03:
     - fix for vdr-1.3.42 compatibility
  2006-02-03:

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** ShmClient.c	4 Feb 2006 14:40:04 -0000	1.4
--- ShmClient.c	6 Feb 2006 19:59:34 -0000	1.5
***************
*** 167,171 ****
                  sem_sig_unlock(ctl->semid,PICT_MUT,SEM_UNDO);
                  //SHMDEB("released the lock\n");
!                 
          };
          ctl->attached=0;
--- 167,172 ----
                  sem_sig_unlock(ctl->semid,PICT_MUT,SEM_UNDO);
                  //SHMDEB("released the lock\n");
!                 // in case there are no semaphores (no vdr connected)
!                 usleep(13000); 
          };
          ctl->attached=0;

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** Makefile	3 Feb 2006 22:34:54 -0000	1.23
--- Makefile	6 Feb 2006 19:59:34 -0000	1.24
***************
*** 345,347 ****
  
  ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)
! 	$(CXX) $(CXXFLAGS) $(XV_LIBS) $(VDR_SHM_CLIENT_OBJS) $(SHM_CLIENT_OBJS) -lpthread $< -o $@
--- 345,347 ----
  
  ShmClient: ShmClient.o $(SHM_CLIENT_OBJS)
! 	$(CXX) $(CXXFLAGS) $(XV_LIBS) $(VDR_SHM_CLIENT_OBJS) $(SHM_CLIENT_OBJS) -lpthread -ljpeg $< -o $@



From nobody at sheep.berlios.de  Mon Feb  6 21:32:04 2006
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 6 Feb 2006 21:32:04 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.150,1.151 README,1.13,1.14 ShmClient.c,1.5,1.6 mpeg2decoder.c,1.60,1.61
Message-ID: <200602062032.k16KW4E14063@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18494

Modified Files:
	CHANGELOG README ShmClient.c mpeg2decoder.c 
Log Message:
- don't start ShmClient in fullscreen mode by default
- some more documentation
- disable debugging information
	 


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.150
retrieving revision 1.151
diff -C2 -d -r1.150 -r1.151
*** CHANGELOG	6 Feb 2006 19:59:34 -0000	1.150
--- CHANGELOG	6 Feb 2006 20:32:00 -0000	1.151
***************
*** 1,4 ****
--- 1,7 ----
  Changelog
  2006-06-03:
+    - don't start ShmClient in fullscreen mode by default
+    - some more documentation
+    - disable debuging information
     - fix linking of ShmClient with vdr-1.3.42
     - add usleep to ShmClient (to avoid busy loop in case there are no 

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** README	4 Feb 2006 14:40:04 -0000	1.13
--- README	6 Feb 2006 20:32:00 -0000	1.14
***************
*** 126,130 ****
  key "0x0000162" the shared memory id is next to it. Them remove the
  shared memory segment with "ipcrm shm shared_memory_id".
! 
  
  Problems/todo:
--- 126,132 ----
  key "0x0000162" the shared memory id is next to it. Them remove the
  shared memory segment with "ipcrm shm shared_memory_id".
! There is currently one limitation to the ShmClient: it has no access to the
! SetupStore, this means that some settings, for example hue, contrast and others
! are not available.
  
  Problems/todo:

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** ShmClient.c	6 Feb 2006 19:59:34 -0000	1.5
--- ShmClient.c	6 Feb 2006 20:32:00 -0000	1.6
***************
*** 63,66 ****
--- 63,67 ----
  int main(int argc, char **argv) {
          cSetupStore SetupStore;
+         SetupStore.xvFullscreen=0;
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
          xvRemote= new cShmXvRemote ("softdevice-xv",vout);

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.60
retrieving revision 1.61
diff -C2 -d -r1.60 -r1.61
*** mpeg2decoder.c	12 Nov 2005 08:07:21 -0000	1.60
--- mpeg2decoder.c	6 Feb 2006 20:32:00 -0000	1.61
***************
*** 24,28 ****
  #endif
  
! #define CMDDEB(out...) {printf("CMD[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef CMDDEB
--- 24,28 ----
  #endif
  
! //#define CMDDEB(out...) {printf("CMD[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
  
  #ifndef CMDDEB



From nobody at sheep.berlios.de  Mon Feb  6 22:32:19 2006
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 6 Feb 2006 22:32:19 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.151,1.152
Message-ID: <200602062132.k16LWJE16585@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3866

Modified Files:
	CHANGELOG 
Log Message:
fix dates YYYY-MM-DD

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.151
retrieving revision 1.152
diff -C2 -d -r1.151 -r1.152
*** CHANGELOG	6 Feb 2006 20:32:00 -0000	1.151
--- CHANGELOG	6 Feb 2006 21:32:16 -0000	1.152
***************
*** 1,12 ****
  Changelog
! 2006-06-03:
     - don't start ShmClient in fullscreen mode by default
     - some more documentation
     - disable debuging information
     - fix linking of ShmClient with vdr-1.3.42
!    - add usleep to ShmClient (to avoid busy loop in case there are no 
       semaphores)
- 2006-03-03:
     - fix for vdr-1.3.42 compatibility
  2006-02-03:
     - remove unused code, variables and parameters from video-xv
--- 1,12 ----
  Changelog
! 2006-02-06:
     - don't start ShmClient in fullscreen mode by default
     - some more documentation
     - disable debuging information
     - fix linking of ShmClient with vdr-1.3.42
!    - add usleep to ShmClient (to avoid busy loop in case there are no
       semaphores)
     - fix for vdr-1.3.42 compatibility
+    - disable some trace messages
  2006-02-03:
     - remove unused code, variables and parameters from video-xv



From nobody at sheep.berlios.de  Fri Feb 10 18:22:14 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 10 Feb 2006 18:22:14 +0100
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.47,1.48
Message-ID: <200602101722.k1AHMEE15114@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30507

Modified Files:
	video-dfb.c 
Log Message:
fix for OSD drawing on matrox cards, when changing from stretchblit to non-stretchblit mode


Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.47
retrieving revision 1.48
diff -C2 -d -r1.47 -r1.48
*** video-dfb.c	6 Feb 2006 19:44:06 -0000	1.47
--- video-dfb.c	10 Feb 2006 17:22:11 -0000	1.48
***************
*** 1060,1067 ****
  
    //printf("CommitUnlockOsdSurface %p\n",tmpOsdSurface);fflush(stdout);
!   try 
    {
      DFBRectangle      osdsrc;
!     
      tmpOsdSurface->Unlock();
      tmpOsdSurface->Flip();
--- 1060,1067 ----
  
    //printf("CommitUnlockOsdSurface %p\n",tmpOsdSurface);fflush(stdout);
!   try
    {
      DFBRectangle      osdsrc;
! 
      tmpOsdSurface->Unlock();
      tmpOsdSurface->Flip();
***************
*** 1069,1072 ****
--- 1069,1073 ----
      int miny=0;
      int maxy=0;
+     tmpOsdSurface->SetBlittingFlags(DSBLIT_NOFX);
      do {
        while (!dirtyLines[miny] && miny < Yres)
***************
*** 1090,1094 ****
  
      } while ( miny<Yres);
- 
    }
    catch (DFBException *ex)
--- 1091,1094 ----



From nobody at sheep.berlios.de  Fri Feb 10 18:33:54 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 10 Feb 2006 18:33:54 +0100
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.48,1.49 video-dfb.h,1.15,1.16
Message-ID: <200602101733.k1AHXsE15681@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2078

Modified Files:
	video-dfb.c video-dfb.h 
Log Message:
moved some functions from video-dfb.h to video-dfb.c


Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** video-dfb.c	10 Feb 2006 17:22:11 -0000	1.48
--- video-dfb.c	10 Feb 2006 17:33:49 -0000	1.49
***************
*** 1105,1110 ****
  }
  
  /*
! void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll) 
  {
      int               pitch;
--- 1105,1130 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
+ void cDFBVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
+                               bool &IsYUV, uint8_t *&PixelMask)
+ {
+   Depth=Bpp;
+   HasAlpha=!OSDpseudo_alpha;
+   AlphaInversed=isVIAUnichrome;
+   IsYUV=false;
+   PixelMask=NULL;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cDFBVideoOut::GetOSDDimension( int &Width, int &Height)
+ {
+   Width=Xres;
+   Height=Yres;
+ }
+ 
  /*
! void cDFBVideoOut::RefreshOSD(cSoftOsd *Osd, bool RefreshAll)
  {
      int               pitch;

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video-dfb.h	3 Feb 2006 22:34:54 -0000	1.15
--- video-dfb.h	10 Feb 2006 17:33:49 -0000	1.16
***************
*** 60,71 ****
      virtual void OpenOSD();
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                   bool &IsYUV, uint8_t *&PixelMask) 
!     { Depth=Bpp; HasAlpha=!OSDpseudo_alpha; AlphaInversed=isVIAUnichrome;
!             IsYUV=false;PixelMask=NULL;};
!     virtual void GetOSDDimension( int &Width, int &Height)
!     { Width=Xres; Height=Yres;};		    
      virtual void OSDStart();
!     virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                     bool *&dirtyLines);
      virtual void CommitUnlockOsdSurface();
  #else
--- 60,68 ----
      virtual void OpenOSD();
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                             bool &IsYUV, uint8_t *&PixelMask);
!     virtual void GetOSDDimension( int &Width, int &Height);
      virtual void OSDStart();
!     virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
!                                    bool *&dirtyLines);
      virtual void CommitUnlockOsdSurface();
  #else



From nobody at sheep.berlios.de  Sat Feb 11 19:28:44 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 11 Feb 2006 19:28:44 +0100
Subject: [Softdevice-cvs] softdevice SoftOsd.c,1.6,1.7
Message-ID: <200602111828.k1BISiE04072@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19065

Modified Files:
	SoftOsd.c 
Log Message:
compile fix for gcc 2.95.3

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** SoftOsd.c	4 Feb 2006 10:05:09 -0000	1.6
--- SoftOsd.c	11 Feb 2006 18:28:39 -0000	1.7
***************
*** 901,905 ****
  		FlushBitmaps(false);
  	};
! 	
  	cMutexLock dirty(&dirty_Mutex);
          uint8_t *buf;
--- 901,905 ----
  		FlushBitmaps(false);
  	};
! 
  	cMutexLock dirty(&dirty_Mutex);
          uint8_t *buf;
***************
*** 1047,1051 ****
                                 : : "r" (&pixmap[row][Pixel])  );
  #endif
!                        
                          pos -=ScaleFactor;
                          row++;
--- 1047,1051 ----
                                 : : "r" (&pixmap[row][Pixel])  );
  #endif
! 
                          pos -=ScaleFactor;
                          row++;
***************
*** 1349,1356 ****
  #else
          __asm__(
!                  " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
!                  : :   );	
  #endif
!         
          int32_t pos=start_pos;
  	int currPixel=0;
--- 1349,1356 ----
  #else
          __asm__(
!                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
!                 : : : "memory" );
  #endif
! 
          int32_t pos=start_pos;
  	int currPixel=0;
***************
*** 1373,1377 ****
                        " movd (%1),%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"  // mm1 pixel1
!                       " punpcklbw %%mm7, %%mm2 \n"  
  		      //" psubw %%mm1, %%mm2 \n"// mm2 pixel2-pixel1
  		      " psubsw %%mm1, %%mm2 \n"// mm2 pixel2-pixel1
--- 1373,1377 ----
                        " movd (%1),%%mm2 \n"
                        " punpcklbw %%mm7, %%mm1 \n"  // mm1 pixel1
!                       " punpcklbw %%mm7, %%mm2 \n"
  		      //" psubw %%mm1, %%mm2 \n"// mm2 pixel2-pixel1
  		      " psubsw %%mm1, %%mm2 \n"// mm2 pixel2-pixel1



From nobody at sheep.berlios.de  Sun Feb 12 18:24:30 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 12 Feb 2006 18:24:30 +0100
Subject: [Softdevice-cvs] softdevice video-xv.c,1.41,1.42
Message-ID: <200602121724.k1CHOUE21011@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16379

Modified Files:
	video-xv.c 
Log Message:
adjusted some printf to usual unbuffered fprintf(stderr, ..) call

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** video-xv.c	5 Feb 2006 11:55:54 -0000	1.41
--- video-xv.c	12 Feb 2006 17:24:28 -0000	1.42
***************
*** 842,846 ****
                            //osd_image->bytes_per_line*height,
                            IPC_CREAT | 0777);
!           printf("osd_image allocated: %d\n",osd_shminfo.shmid);
            if (osd_shminfo.shmid == -1) {
                    dsyslog("[XvVideoOut]: Initialize ERROR: shmget FAILED !");
--- 842,846 ----
                            //osd_image->bytes_per_line*height,
                            IPC_CREAT | 0777);
!           fprintf(stderr,"[XvVideoOut]: osd_image shmid = %d\n",osd_shminfo.shmid);
            if (osd_shminfo.shmid == -1) {
                    dsyslog("[XvVideoOut]: Initialize ERROR: shmget FAILED !");
***************
*** 879,884 ****
    };
    Bpp=osd_image->bits_per_pixel;
!   printf("got osd_image: width %d height %d, bytes per line %d\n",
!                   osd_max_width, osd_max_height,osd_image->bytes_per_line);
    
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
--- 879,885 ----
    };
    Bpp=osd_image->bits_per_pixel;
!   fprintf(stderr,
!           "[XvVideoOut]: got osd_image: width %d height %d, bytes per line %d\n",
!           osd_max_width, osd_max_height,osd_image->bytes_per_line);
    
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);



From nobody at sheep.berlios.de  Sun Feb 12 18:59:15 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 12 Feb 2006 18:59:15 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.152,1.153 softdevice.c,1.53,1.54
Message-ID: <200602121759.k1CHxFE22441@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7379

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
softdevice-0.2.2

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.152
retrieving revision 1.153
diff -C2 -d -r1.152 -r1.153
*** CHANGELOG	6 Feb 2006 21:32:16 -0000	1.152
--- CHANGELOG	12 Feb 2006 17:59:12 -0000	1.153
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2006-02-12: softdevice-0.2.2
+ 2006-02-11:
+    - some minor fixes:
+        - OSD redrawing with dfb-out when switching from StretchBlit to BES mode
+        - compiling with SoftOsd.c with gcc 2.95.3
  2006-02-06:
     - don't start ShmClient in fullscreen mode by default
***************
*** 25,29 ****
     - now correct fix for CheckArea() not updating the aspect ratio
  2006-01-17:
!    - add video-shm and ShmClient, a simple server/client model for the 
       softdevice. See the file README for details.
  2006-01-15:
--- 30,34 ----
     - now correct fix for CheckArea() not updating the aspect ratio
  2006-01-17:
!    - add video-shm and ShmClient, a simple server/client model for the
       softdevice. See the file README for details.
  2006-01-15:

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** softdevice.c	6 Feb 2006 19:38:56 -0000	1.53
--- softdevice.c	12 Feb 2006 17:59:12 -0000	1.54
***************
*** 77,81 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.2.1";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 77,81 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.2.2";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
***************
*** 353,357 ****
  void cSoftDevice::MakePrimaryDevice(bool On)
  {
!   fprintf(stderr,"cSoftDevice::MakePrimaryDevice\n");
  
    new cSoftOsdProvider(videoOut);
--- 353,357 ----
  void cSoftDevice::MakePrimaryDevice(bool On)
  {
!   //fprintf(stderr,"cSoftDevice::MakePrimaryDevice\n");
  
    new cSoftOsdProvider(videoOut);



From nobody at sheep.berlios.de  Fri Feb 17 22:31:12 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 17 Feb 2006 22:31:12 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.153,1.154 SoftOsd.c,1.7,1.8 video-vidix.c,1.14,1.15 video-vidix.h,1.7,1.8 video-xv.c,1.42,1.43 video-xv.h,1.13,1.14 video.c,1.43,1.44 video.h,1.28,1.29
Message-ID: <200602172131.k1HLVCE14940@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27963

Modified Files:
	CHANGELOG SoftOsd.c video-vidix.c video-vidix.h video-xv.c 
	video-xv.h video.c video.h 
Log Message:
   - fix bug #6409 (OSD not refreshed fast enough in software OSD blending mode
     when video is paused)
   - fix crash / deadlocks at startup in 16:9 mode in software OSD blending mode


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.153
retrieving revision 1.154
diff -C2 -d -r1.153 -r1.154
*** CHANGELOG	12 Feb 2006 17:59:12 -0000	1.153
--- CHANGELOG	17 Feb 2006 21:31:09 -0000	1.154
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2006-02-17:
+    - fix bug #6409 (OSD not refreshed fast enough in software OSD blending mode
+      when video is paused)
+    - fix crash / deadlocks at startup in 16:9 mode in software OSD blending mode
  2006-02-12: softdevice-0.2.2
  2006-02-11:

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** SoftOsd.c	11 Feb 2006 18:28:39 -0000	1.7
--- SoftOsd.c	17 Feb 2006 21:31:09 -0000	1.8
***************
*** 39,43 ****
  	bitmap_Format=PF_None; // forces a clear after first SetMode
          OSD_Bitmap=new uint32_t[OSD_STRIDE*(OSD_HEIGHT+2)];
!         
          videoOut = VideoOut;
  	videoOut->OpenOSD();
--- 39,43 ----
  	bitmap_Format=PF_None; // forces a clear after first SetMode
          OSD_Bitmap=new uint32_t[OSD_STRIDE*(OSD_HEIGHT+2)];
! 
          videoOut = VideoOut;
  	videoOut->OpenOSD();
***************
*** 45,48 ****
--- 45,49 ----
          int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
          uint8_t *PixelMask;
+         videoOut->AdjustOSDMode();
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
                          IsYUV,PixelMask);
***************
*** 87,90 ****
--- 88,92 ----
                  int newOsdHeight;
  
+                 videoOut->AdjustOSDMode();
                  videoOut->GetOSDDimension(newOsdWidth,newOsdHeight);
                  if ( newOsdWidth==-1 || newOsdHeight==-1 )
***************
*** 120,123 ****
--- 122,127 ----
          int newY;
          bool RefreshAll=false;
+ 
+         videoOut->AdjustOSDMode();
          videoOut->GetOSDDimension(newX,newY);
          if ( newX==-1 || newY==-1 ) {
***************
*** 223,228 ****
  	bool OSD_changed=FlushBitmaps(true);
  	
! 	if (OSD_changed)
! 		OsdCommit();
  
  	// give priority to the other threads
--- 227,234 ----
  	bool OSD_changed=FlushBitmaps(true);
  	
!         if (OSD_changed) {
!                 OsdCommit();
!                 videoOut->Osd_changed = true;
!         }
  
  	// give priority to the other threads

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** video-vidix.c	3 Feb 2006 22:34:54 -0000	1.14
--- video-vidix.c	17 Feb 2006 21:31:09 -0000	1.15
***************
*** 568,571 ****
--- 568,578 ----
  /* ---------------------------------------------------------------------------
   */
+ void cVidixVideoOut::AdjustOSDMode()
+ {
+   current_osdMode = setupStore->osdMode;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cVidixVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
     switch (current_osdMode) {

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** video-vidix.h	3 Feb 2006 22:34:54 -0000	1.7
--- video-vidix.h	17 Feb 2006 21:31:10 -0000	1.8
***************
*** 1,70 ****
! /*
!  * video-vidix.h: A plugin for the Video Disk Recorder
!  *
!  * See the README file for copyright information and how to reach the author.
!  *
!  * $Id$
!  */
! 
! #ifndef VIDEO_VIDIX_H
! #define VIDEO_VIDIX_H
! 
! #include "video.h"
! #include <linux/fb.h>
! #include "vidixlib.h"
! #include "fourcc.h"
! 
! 
! class cVidixVideoOut : public cVideoOut {
! private:
!     uint8_t * fb;
! 
!     int fbdev;
!     int fb_line_len;
! 
!     struct fb_fix_screeninfo fb_finfo;
!     struct fb_var_screeninfo fb_vinfo;
! 
!     int orig_cmaplen;
!     __u16 * orig_cmap;
! 
!     char               * vidix_name;
!     int                vidix_version;
!     VDL_HANDLE         vidix_handler;
!     vidix_capability_t vidix_cap;
!     vidix_playback_t   vidix_play;
!     vidix_fourcc_t     vidix_fourcc;
!     vidix_yuv_t        dstrides;
!     vidix_grkey_t      gr_key;
!     uint8_t            next_frame;
! 
!     void SetParams(int Ystride, int UVstride);
! 
! public:
!   cVidixVideoOut(cSetupStore *setupStore);
!   virtual ~cVidixVideoOut();
! 
! #if VDRVERSNUM >= 10307
!   virtual void ClearOSD();
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight); 
!   virtual void GetOSDMode(int &Depth,bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV,uint8_t *&PixelMask)
!   { Depth=Bpp; HasAlpha=false;AlphaInversed=false; 
! 	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
! 	  PixelMask=NULL;};
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
! #else
!   virtual void Refresh();
! #endif
! 
!   virtual void CloseOSD();
! //  virtual void OpenOSD();  
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
!   virtual void Pause(void);
! 
!   bool MatchPixelFormat(void);
!   void AllocLayer(void);
! };
! 
! #endif // VIDEO_VIDIX_H
--- 1,71 ----
! /*
!  * video-vidix.h: A plugin for the Video Disk Recorder
!  *
!  * See the README file for copyright information and how to reach the author.
!  *
!  * $Id$
!  */
! 
! #ifndef VIDEO_VIDIX_H
! #define VIDEO_VIDIX_H
! 
! #include "video.h"
! #include <linux/fb.h>
! #include "vidixlib.h"
! #include "fourcc.h"
! 
! 
! class cVidixVideoOut : public cVideoOut {
! private:
!     uint8_t * fb;
! 
!     int fbdev;
!     int fb_line_len;
! 
!     struct fb_fix_screeninfo fb_finfo;
!     struct fb_var_screeninfo fb_vinfo;
! 
!     int orig_cmaplen;
!     __u16 * orig_cmap;
! 
!     char               * vidix_name;
!     int                vidix_version;
!     VDL_HANDLE         vidix_handler;
!     vidix_capability_t vidix_cap;
!     vidix_playback_t   vidix_play;
!     vidix_fourcc_t     vidix_fourcc;
!     vidix_yuv_t        dstrides;
!     vidix_grkey_t      gr_key;
!     uint8_t            next_frame;
! 
!     void SetParams(int Ystride, int UVstride);
! 
! public:
!   cVidixVideoOut(cSetupStore *setupStore);
!   virtual ~cVidixVideoOut();
! 
! #if VDRVERSNUM >= 10307
!   virtual void ClearOSD();
!   virtual void AdjustOSDMode();  
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight); 
!   virtual void GetOSDMode(int &Depth,bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV,uint8_t *&PixelMask)
!   { Depth=Bpp; HasAlpha=false;AlphaInversed=false; 
! 	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
! 	  PixelMask=NULL;};
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
! #else
!   virtual void Refresh();
! #endif
! 
!   virtual void CloseOSD();
! //  virtual void OpenOSD();  
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
!   virtual void Pause(void);
! 
!   bool MatchPixelFormat(void);
!   void AllocLayer(void);
! };
! 
! #endif // VIDEO_VIDIX_H

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** video-xv.c	12 Feb 2006 17:24:28 -0000	1.42
--- video-xv.c	17 Feb 2006 21:31:10 -0000	1.43
***************
*** 892,895 ****
--- 892,896 ----
    }
  
+   pthread_mutex_lock(&xv_mutex);
    /* -------------------------------------------------------------------------
     * get up our remote running
***************
*** 908,913 ****
      toggleFullScreen();
      setupStore->xvFullscreen=0;
!   };
  
    initialized=true;
    return true;
--- 909,915 ----
      toggleFullScreen();
      setupStore->xvFullscreen=0;
!   }
  
+   pthread_mutex_unlock(&xv_mutex);
    initialized=true;
    return true;
***************
*** 1209,1213 ****
--- 1211,1221 ----
  /* ---------------------------------------------------------------------------
   */
+ void cXvVideoOut::AdjustOSDMode()
+ {
+   current_osdMode = setupStore->osdMode;
+ }
  
+ /* ---------------------------------------------------------------------------
+  */
  void cXvVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
     switch (current_osdMode) {
***************
*** 1223,1229 ****
  };
  
! void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                    bool &IsYUV, uint8_t *&PixelMask) {
!         if (setupStore->osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;
--- 1231,1239 ----
  };
  
! /* ---------------------------------------------------------------------------
!  */
! void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                    bool &IsYUV, uint8_t *&PixelMask) {
!         if (current_osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;
***************
*** 1231,1235 ****
          };
  
!         IsYUV=false; 
          Depth=osd_image->bits_per_pixel;
          HasAlpha=false;
--- 1241,1245 ----
          };
  
!         IsYUV=false;
          Depth=osd_image->bits_per_pixel;
          HasAlpha=false;
***************
*** 1237,1240 ****
--- 1247,1252 ----
  };       
  
+ /* ---------------------------------------------------------------------------
+  */
  void cXvVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
                    bool *&dirtyLines) {
***************
*** 1244,1247 ****
--- 1256,1261 ----
  };
  
+ /* ---------------------------------------------------------------------------
+  */
  void cXvVideoOut::CommitUnlockOsdSurface() {
          cVideoOut::CommitUnlockOsdSurface();
***************
*** 1349,1353 ****
      int y=lheight > OSD_FULL_HEIGHT?(lheight - OSD_FULL_HEIGHT) / 2+lyoff:lyoff;
  #endif
!     if (useShm) 
        XShmPutImage (dpy, win, gc, osd_image,
            1,1,
--- 1363,1367 ----
      int y=lheight > OSD_FULL_HEIGHT?(lheight - OSD_FULL_HEIGHT) / 2+lyoff:lyoff;
  #endif
!     if (useShm)
        XShmPutImage (dpy, win, gc, osd_image,
            1,1,
***************
*** 1394,1398 ****
  #if VDRVERSNUM >= 10307
    OsdRefreshCounter=0;
!   
    /* -------------------------------------------------------------------------
     * don't know where those funny stride values (752,376) come from.
--- 1408,1412 ----
  #if VDRVERSNUM >= 10307
    OsdRefreshCounter=0;
! 
    /* -------------------------------------------------------------------------
     * don't know where those funny stride values (752,376) come from.
***************
*** 1441,1445 ****
  
    }
!   else 
  #endif
   {
--- 1455,1459 ----
  
    }
!   else
  #endif
   {

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-xv.h	4 Feb 2006 17:33:31 -0000	1.13
--- video-xv.h	17 Feb 2006 21:31:10 -0000	1.14
***************
*** 150,153 ****
--- 150,154 ----
  #if VDRVERSNUM >= 10307
    virtual void ClearOSD();
+   virtual void AdjustOSDMode();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** video.c	6 Feb 2006 19:38:56 -0000	1.43
--- video.c	17 Feb 2006 21:31:10 -0000	1.44
***************
*** 49,52 ****
--- 49,54 ----
      parValues [i] = 1.0;
  
+   init_OsdBuffers();
+ 
    //start osd thread
    active=true;
***************
*** 86,90 ****
  void cVideoOut::Action()
  {
-   init_OsdBuffers();
    ClearOSD();
  #if VDRVERSNUM >= 10307
--- 88,91 ----
***************
*** 92,98 ****
    {
      OsdRefreshCounter++;
!     if (OsdRefreshCounter > 80 ||
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>10 && Osd_changed))
      {
        osdMutex.Lock();
--- 93,104 ----
    {
      OsdRefreshCounter++;
!     if (
!         //
!         // Don't do an unconditional redraw. TV-out cannot handle higher
!         // diplay rates than 25Hz.
!         //
!         //OsdRefreshCounter > 80 ||
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>1 && Osd_changed))
      {
        osdMutex.Lock();
***************
*** 451,454 ****
--- 457,467 ----
    osdMutex.Unlock();
    OSDDEB("CloseOSD\n");
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::AdjustOSDMode()
+ {
+   current_osdMode = OSDMODE_PSEUDO;
  }
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** video.h	4 Feb 2006 17:33:31 -0000	1.28
--- video.h	17 Feb 2006 21:31:10 -0000	1.29
***************
*** 177,180 ****
--- 177,182 ----
      virtual void CloseOSD();
  
+     virtual void AdjustOSDMode();
+ 
      virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight)
      // called whenever OSD is to be displayed
***************
*** 194,198 ****
      { osd=NULL; stride=0; dirtyLines=NULL;};
      virtual void CommitUnlockOsdSurface()
!     { current_osdMode=OSDMODE_PSEUDO;OSDpresent=true; };
  
      // Software YUV mode
--- 196,200 ----
      { osd=NULL; stride=0; dirtyLines=NULL;};
      virtual void CommitUnlockOsdSurface()
!     { OSDpresent=true; };
  
      // Software YUV mode
***************
*** 201,210 ****
                          uint8_t *&osdPAlphaY, uint8_t *&osdPAlphaUV,
                          int &strideY, int &strideUV)
!     { osdPy=OsdPy; osdPu=OsdPu; osdPv=OsdPv; 
              osdPAlphaY=OsdPAlphaY; osdPAlphaUV=OsdPAlphaUV;
              strideY=OSD_FULL_WIDTH; strideUV=OSD_FULL_WIDTH/2;};
  
      virtual void CommitUnlockSoftOsdSurface()
!     { current_osdMode=OSDMODE_SOFTWARE; OSDpresent=true; };
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
--- 203,212 ----
                          uint8_t *&osdPAlphaY, uint8_t *&osdPAlphaUV,
                          int &strideY, int &strideUV)
!     { osdPy=OsdPy; osdPu=OsdPu; osdPv=OsdPv;
              osdPAlphaY=OsdPAlphaY; osdPAlphaUV=OsdPAlphaUV;
              strideY=OSD_FULL_WIDTH; strideUV=OSD_FULL_WIDTH/2;};
  
      virtual void CommitUnlockSoftOsdSurface()
!     { OSDpresent=true; };
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,



From nobody at sheep.berlios.de  Sat Feb 18 23:20:32 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 18 Feb 2006 23:20:32 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.154,1.155 SoftOsd.c,1.8,1.9 SoftOsd.h,1.4,1.5 video-dfb.c,1.49,1.50 video-dfb.h,1.16,1.17 video-fb.c,1.12,1.13 video-fb.h,1.6,1.7 video-vidix.c,1.15,1.16 video-vidix.h,1.8,1.9 video-xv.c,1.43,1.44 video-xv.h,1.14,1.15 video.c,1.44,1.45 video.h,1.29,1.30
Message-ID: <200602182220.k1IMKWE04747@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8137

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h video-dfb.c video-dfb.h 
	video-fb.c video-fb.h video-vidix.c video-vidix.h video-xv.c 
	video-xv.h video.c video.h 
Log Message:
   - fix OSD drawn at wrong location in software OSD blending mode when
     cropping is active


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.154
retrieving revision 1.155
diff -C2 -d -r1.154 -r1.155
*** CHANGELOG	17 Feb 2006 21:31:09 -0000	1.154
--- CHANGELOG	18 Feb 2006 22:20:29 -0000	1.155
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2006-02-18:
+    - fix OSD drawn at wrong location in software OSD blending mode when
+      cropping is active
  2006-02-17:
     - fix bug #6409 (OSD not refreshed fast enough in software OSD blending mode

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** SoftOsd.c	17 Feb 2006 21:31:09 -0000	1.8
--- SoftOsd.c	18 Feb 2006 22:20:29 -0000	1.9
***************
*** 41,44 ****
--- 41,45 ----
  
          videoOut = VideoOut;
+         xPan = yPan = 0;
  	videoOut->OpenOSD();
  	xOfs=X;yOfs=Y;
***************
*** 87,93 ****
                  int newOsdWidth;
                  int newOsdHeight;
  
                  videoOut->AdjustOSDMode();
!                 videoOut->GetOSDDimension(newOsdWidth,newOsdHeight);
                  if ( newOsdWidth==-1 || newOsdHeight==-1 )
                  {
--- 88,95 ----
                  int newOsdWidth;
                  int newOsdHeight;
+                 int newXPan, newYPan;
  
                  videoOut->AdjustOSDMode();
!                 videoOut->GetOSDDimension(newOsdWidth,newOsdHeight,newXPan,newYPan);
                  if ( newOsdWidth==-1 || newOsdHeight==-1 )
                  {
***************
*** 95,100 ****
                          newOsdHeight=OSD_FULL_HEIGHT;
                  }
!                 
!                 int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
                  uint8_t *PixelMask;
                  videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
--- 97,102 ----
                          newOsdHeight=OSD_FULL_HEIGHT;
                  }
! 
!                 int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV;
                  uint8_t *PixelMask;
                  videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
***************
*** 103,108 ****
                                  IsYUV,PixelMask);
  
!                 if ( ScreenOsdWidth!=newOsdWidth  || 
!                                 ScreenOsdHeight!=newOsdHeight  || 
                                  modeChanged ) {
                          OSDDEB("Resolution or mode changed!\n");
--- 105,116 ----
                                  IsYUV,PixelMask);
  
!                 if (newXPan != xPan || newYPan != yPan) {
!                         xPan = newXPan;
!                         yPan = newYPan;
!                         modeChanged = true;
!                 }
! 
!                 if ( ScreenOsdWidth!=newOsdWidth  ||
!                                 ScreenOsdHeight!=newOsdHeight  ||
                                  modeChanged ) {
                          OSDDEB("Resolution or mode changed!\n");
***************
*** 121,128 ****
          int newX;
          int newY;
          bool RefreshAll=false;
  
          videoOut->AdjustOSDMode();
!         videoOut->GetOSDDimension(newX,newY);
          if ( newX==-1 || newY==-1 ) {
                  newX=OSD_FULL_WIDTH;
--- 129,137 ----
          int newX;
          int newY;
+         int newXPan, newYPan;
          bool RefreshAll=false;
  
          videoOut->AdjustOSDMode();
!         videoOut->GetOSDDimension(newX,newY,newXPan,newYPan);
          if ( newX==-1 || newY==-1 ) {
                  newX=OSD_FULL_WIDTH;
***************
*** 135,142 ****
          };
  
!         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
          uint8_t *PixelMask;
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
          bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
          if (modeChanged)
                  videoOut->ClearOSD();
--- 144,159 ----
          };
  
!         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV;
          uint8_t *PixelMask;
          videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
          bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
+ 
+         if (newXPan != xPan || newYPan != yPan) {
+                 xPan = newXPan;
+                 yPan = newYPan;
+                 RefreshAll = true;
+                 modeChanged = true;
+         }
+ 
          if (modeChanged)
                  videoOut->ClearOSD();
***************
*** 163,166 ****
--- 180,184 ----
                  videoOut->CommitUnlockOsdSurface();
          }
+         videoOut->Osd_changed = true;
  };
  
***************
*** 227,234 ****
  	bool OSD_changed=FlushBitmaps(true);
  	
!         if (OSD_changed) {
                  OsdCommit();
-                 videoOut->Osd_changed = true;
-         }
  
  	// give priority to the other threads
--- 245,250 ----
  	bool OSD_changed=FlushBitmaps(true);
  	
!         if (OSD_changed)
                  OsdCommit();
  
  	// give priority to the other threads
***************
*** 311,314 ****
--- 327,331 ----
  	OSDDEB("drawing bitmap %p at P0 (%d,%d) from (%d,%d) to (%d,%d) \n",
  			bitmap,bitmap->X0(),bitmap->Y0(),x1,y1,x2,y2);
+ 
  	y2++;
  	x2++;
***************
*** 666,674 ****
  
                  // convert and copy to video out OSD layer
!                 pY=PY+y*Ystride;
!                 pU=PU+y*UVstride/2;
!                 pV=PV+y*UVstride/2;
!                 pAlphaY=PAlphaY+y*Ystride;
!                 pAlphaUV=PAlphaUV+y*UVstride/2;
                  AYUV_to_AYUV420P(pY,pY+Ystride,pU,pV,
                                  pAlphaY,pAlphaY+Ystride,pAlphaUV,
--- 683,691 ----
  
                  // convert and copy to video out OSD layer
!                 pY=PY+(y+yPan)*Ystride+xPan;
!                 pU=PU+((y+yPan)*UVstride+xPan)/2;
!                 pV=PV+((y+yPan)*UVstride+xPan)/2;
!                 pAlphaY=PAlphaY+(y+yPan)*Ystride+xPan;
!                 pAlphaUV=PAlphaUV+((y+yPan)*UVstride+xPan)/2;
                  AYUV_to_AYUV420P(pY,pY+Ystride,pU,pV,
                                  pAlphaY,pAlphaY+Ystride,pAlphaUV,
***************
*** 764,772 ****
  
                  // convert and copy to video out OSD layer
!                 pY=PY+y*Ystride;
!                 pU=PU+y*UVstride/2;
!                 pV=PV+y*UVstride/2;
!                 pAlphaY=PAlphaY+y*Ystride;
!                 pAlphaUV=PAlphaUV+y*UVstride/2;
                  AYUV_to_AYUV420P(pY,pY+Ystride,pU,pV,
                                pAlphaY,pAlphaY+Ystride,pAlphaUV,
--- 781,789 ----
  
                  // convert and copy to video out OSD layer
!                 pY=PY+(y+yPan)*Ystride+xPan;
!                 pU=PU+((y+yPan)*UVstride+xPan)/2;
!                 pV=PV+((y+yPan)*UVstride+xPan)/2;
!                 pAlphaY=PAlphaY+(y+yPan)*Ystride+xPan;
!                 pAlphaUV=PAlphaUV+((y+yPan)*UVstride+xPan)/2;
                  AYUV_to_AYUV420P(pY,pY+Ystride,pU,pV,
                                pAlphaY,pAlphaY+Ystride,pAlphaUV,
***************
*** 781,788 ****
  //---------------------------RGB modes ----------------------
  
! void cSoftOsd::CopyToBitmap(uint8_t *dest, int linesize, 
                  int dest_Width, int dest_Height, bool RefreshAll,
                  bool *dirtyLines) {
! 	if (dest_Height>=OSD_HEIGHT) 
  		ScaleVUpCopyToBitmap(dest,linesize,dest_Width,dest_Height,
                                  RefreshAll,dirtyLines);
--- 798,805 ----
  //---------------------------RGB modes ----------------------
  
! void cSoftOsd::CopyToBitmap(uint8_t *dest, int linesize,
                  int dest_Width, int dest_Height, bool RefreshAll,
                  bool *dirtyLines) {
! 	if (dest_Height>=OSD_HEIGHT)
  		ScaleVUpCopyToBitmap(dest,linesize,dest_Width,dest_Height,
                                  RefreshAll,dirtyLines);

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** SoftOsd.h	4 Feb 2006 10:05:09 -0000	1.4
--- SoftOsd.h	18 Feb 2006 22:20:29 -0000	1.5
***************
*** 56,60 ****
      cVideoOut *videoOut;
  protected:
!     int xOfs,yOfs;
      uint32_t *OSD_Bitmap;
      bool dirty_lines[OSD_HEIGHT+10];
--- 56,61 ----
      cVideoOut *videoOut;
  protected:
!     int      xOfs, yOfs;
!     int      xPan, yPan;
      uint32_t *OSD_Bitmap;
      bool dirty_lines[OSD_HEIGHT+10];

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** video-dfb.c	10 Feb 2006 17:33:49 -0000	1.49
--- video-dfb.c	18 Feb 2006 22:20:29 -0000	1.50
***************
*** 1119,1126 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::GetOSDDimension( int &Width, int &Height)
  {
    Width=Xres;
    Height=Yres;
  }
  
--- 1119,1127 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBVideoOut::GetOSDDimension( int &Width, int &Height, int &xPan, int &yPan)
  {
    Width=Xres;
    Height=Yres;
+   xPan = yPan = 0;
  }
  

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video-dfb.h	10 Feb 2006 17:33:49 -0000	1.16
--- video-dfb.h	18 Feb 2006 22:20:29 -0000	1.17
***************
*** 61,65 ****
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                              bool &IsYUV, uint8_t *&PixelMask);
!     virtual void GetOSDDimension( int &Width, int &Height);
      virtual void OSDStart();
      virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
--- 61,66 ----
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                              bool &IsYUV, uint8_t *&PixelMask);
!     virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                  int &xPan, int &yPan);
      virtual void OSDStart();
      virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-fb.c	3 Feb 2006 22:34:54 -0000	1.12
--- video-fb.c	18 Feb 2006 22:20:29 -0000	1.13
***************
*** 172,180 ****
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=Xres;
                  OsdHeight=Yres;
               break;
      }
--- 172,182 ----
  /* ---------------------------------------------------------------------------
   */
! void cFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                   int &xPan, int &yPan) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=Xres;
                  OsdHeight=Yres;
+                 xPan = yPan = 0;
               break;
      }

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** video-fb.h	3 Feb 2006 22:34:54 -0000	1.6
--- video-fb.h	18 Feb 2006 22:20:29 -0000	1.7
***************
*** 38,42 ****
                    bool *&dirtyLines);
    virtual void CommitUnlockOsdSurface();
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
  #else
    virtual void Refresh();
--- 38,43 ----
                    bool *&dirtyLines);
    virtual void CommitUnlockOsdSurface();
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                int &xPan, int &yPan);
  #else
    virtual void Refresh();

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video-vidix.c	17 Feb 2006 21:31:09 -0000	1.15
--- video-vidix.c	18 Feb 2006 22:20:29 -0000	1.16
***************
*** 575,587 ****
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=Xres;//*9/10;
                  OsdHeight=Yres;//*9/10;
               break;
        case OSDMODE_SOFTWARE:
                  OsdWidth=swidth;//*9/10;
                  OsdHeight=sheight;//*9/10;
               break;
      };
--- 575,591 ----
  /* ---------------------------------------------------------------------------
   */
! void cVidixVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                      int &xPan, int &yPan) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=Xres;//*9/10;
                  OsdHeight=Yres;//*9/10;
+                 xPan = yPan = 0;
               break;
        case OSDMODE_SOFTWARE:
                  OsdWidth=swidth;//*9/10;
                  OsdHeight=sheight;//*9/10;
+                 xPan = sxoff;
+                 yPan = syoff;
               break;
      };

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** video-vidix.h	17 Feb 2006 21:31:10 -0000	1.8
--- video-vidix.h	18 Feb 2006 22:20:30 -0000	1.9
***************
*** 1,71 ****
! /*
!  * video-vidix.h: A plugin for the Video Disk Recorder
!  *
!  * See the README file for copyright information and how to reach the author.
!  *
!  * $Id$
!  */
! 
! #ifndef VIDEO_VIDIX_H
! #define VIDEO_VIDIX_H
! 
! #include "video.h"
! #include <linux/fb.h>
! #include "vidixlib.h"
! #include "fourcc.h"
! 
! 
! class cVidixVideoOut : public cVideoOut {
! private:
!     uint8_t * fb;
! 
!     int fbdev;
!     int fb_line_len;
! 
!     struct fb_fix_screeninfo fb_finfo;
!     struct fb_var_screeninfo fb_vinfo;
! 
!     int orig_cmaplen;
!     __u16 * orig_cmap;
! 
!     char               * vidix_name;
!     int                vidix_version;
!     VDL_HANDLE         vidix_handler;
!     vidix_capability_t vidix_cap;
!     vidix_playback_t   vidix_play;
!     vidix_fourcc_t     vidix_fourcc;
!     vidix_yuv_t        dstrides;
!     vidix_grkey_t      gr_key;
!     uint8_t            next_frame;
! 
!     void SetParams(int Ystride, int UVstride);
! 
! public:
!   cVidixVideoOut(cSetupStore *setupStore);
!   virtual ~cVidixVideoOut();
! 
! #if VDRVERSNUM >= 10307
!   virtual void ClearOSD();
!   virtual void AdjustOSDMode();  
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight); 
!   virtual void GetOSDMode(int &Depth,bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV,uint8_t *&PixelMask)
!   { Depth=Bpp; HasAlpha=false;AlphaInversed=false; 
! 	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
! 	  PixelMask=NULL;};
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
! #else
!   virtual void Refresh();
! #endif
! 
!   virtual void CloseOSD();
! //  virtual void OpenOSD();  
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
!   virtual void Pause(void);
! 
!   bool MatchPixelFormat(void);
!   void AllocLayer(void);
! };
! 
! #endif // VIDEO_VIDIX_H
--- 1,72 ----
! /*
!  * video-vidix.h: A plugin for the Video Disk Recorder
!  *
!  * See the README file for copyright information and how to reach the author.
!  *
!  * $Id$
!  */
! 
! #ifndef VIDEO_VIDIX_H
! #define VIDEO_VIDIX_H
! 
! #include "video.h"
! #include <linux/fb.h>
! #include "vidixlib.h"
! #include "fourcc.h"
! 
! 
! class cVidixVideoOut : public cVideoOut {
! private:
!     uint8_t * fb;
! 
!     int fbdev;
!     int fb_line_len;
! 
!     struct fb_fix_screeninfo fb_finfo;
!     struct fb_var_screeninfo fb_vinfo;
! 
!     int orig_cmaplen;
!     __u16 * orig_cmap;
! 
!     char               * vidix_name;
!     int                vidix_version;
!     VDL_HANDLE         vidix_handler;
!     vidix_capability_t vidix_cap;
!     vidix_playback_t   vidix_play;
!     vidix_fourcc_t     vidix_fourcc;
!     vidix_yuv_t        dstrides;
!     vidix_grkey_t      gr_key;
!     uint8_t            next_frame;
! 
!     void SetParams(int Ystride, int UVstride);
! 
! public:
!   cVidixVideoOut(cSetupStore *setupStore);
!   virtual ~cVidixVideoOut();
! 
! #if VDRVERSNUM >= 10307
!   virtual void ClearOSD();
!   virtual void AdjustOSDMode();  
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                int &xPan, int &yPan);
!   virtual void GetOSDMode(int &Depth,bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV,uint8_t *&PixelMask)
!   { Depth=Bpp; HasAlpha=false;AlphaInversed=false; 
! 	  IsYUV=(current_osdMode == OSDMODE_SOFTWARE);
! 	  PixelMask=NULL;};
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, 
!                   bool *&dirtyLines);
! #else
!   virtual void Refresh();
! #endif
! 
!   virtual void CloseOSD();
! //  virtual void OpenOSD();  
!   virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
!   virtual void Pause(void);
! 
!   bool MatchPixelFormat(void);
!   void AllocLayer(void);
! };
! 
! #endif // VIDEO_VIDIX_H

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** video-xv.c	17 Feb 2006 21:31:10 -0000	1.43
--- video-xv.c	18 Feb 2006 22:20:30 -0000	1.44
***************
*** 1218,1230 ****
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=lwidth<osd_max_width?lwidth:osd_max_width;
                  OsdHeight=lheight<osd_max_height?lheight:osd_max_height;
               break;
        case OSDMODE_SOFTWARE:
                  OsdWidth=swidth;//*9/10;
                  OsdHeight=sheight;//*9/10;
               break;
      };
--- 1218,1234 ----
  /* ---------------------------------------------------------------------------
   */
! void cXvVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                   int &xPan, int &yPan) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=lwidth<osd_max_width?lwidth:osd_max_width;
                  OsdHeight=lheight<osd_max_height?lheight:osd_max_height;
+                 xPan = yPan = 0;
               break;
        case OSDMODE_SOFTWARE:
                  OsdWidth=swidth;//*9/10;
                  OsdHeight=sheight;//*9/10;
+                 xPan = sxoff;
+                 yPan = syoff;
               break;
      };

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** video-xv.h	17 Feb 2006 21:31:10 -0000	1.14
--- video-xv.h	18 Feb 2006 22:20:30 -0000	1.15
***************
*** 151,156 ****
    virtual void ClearOSD();
    virtual void AdjustOSDMode();
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
!   virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
                    bool &IsYUV, uint8_t *&PixelMask);
    virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
--- 151,157 ----
    virtual void ClearOSD();
    virtual void AdjustOSDMode();
!   virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                int &xPan, int &yPan);
!   virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                    bool &IsYUV, uint8_t *&PixelMask);
    virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** video.c	17 Feb 2006 21:31:10 -0000	1.44
--- video.c	18 Feb 2006 22:20:30 -0000	1.45
***************
*** 416,419 ****
--- 416,420 ----
    areaMutex. Lock();
    OsdRefreshCounter=0;
+   RecalculateAspect();
    CheckArea(w, h);
    // display picture

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** video.h	17 Feb 2006 21:31:10 -0000	1.29
--- video.h	18 Feb 2006 22:20:30 -0000	1.30
***************
*** 179,187 ****
      virtual void AdjustOSDMode();
  
!     virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight)
      // called whenever OSD is to be displayed
      // every video-out should implement a method which desired osd dimension
      // for scaling, if -1,-1 is returned no scaling is done.
!     { OsdWidth=-1;OsdHeight=-1;};
       
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 
--- 179,188 ----
      virtual void AdjustOSDMode();
  
!     virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                  int &xPan, int &yPan)
      // called whenever OSD is to be displayed
      // every video-out should implement a method which desired osd dimension
      // for scaling, if -1,-1 is returned no scaling is done.
!     { OsdWidth=-1;OsdHeight=-1; xPan = yPan = 0;};
       
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed, 



From nobody at sheep.berlios.de  Sun Feb 19 11:38:32 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 19 Feb 2006 11:38:32 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.16,1.17
Message-ID: <200602191038.k1JAcWE27676@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19363

Modified Files:
	i18n.c 
Log Message:
some german OSD translations

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** i18n.c	12 Nov 2005 15:45:39 -0000	1.16
--- i18n.c	19 Feb 2006 10:38:30 -0000	1.17
***************
*** 103,107 ****
    },
    { "Deinterlace Method",   //  1
!     "Deinterlace Methode",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 103,107 ----
    },
    { "Deinterlace Method",   //  1
!     "Deinterlace-Methode",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 356,360 ****
    },
    { "CropModeToggleKey",                  //  1
!     "Bildausschnitt-Taste",               //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 356,360 ----
    },
    { "CropModeToggleKey",                  //  1
!     "Bildausschnitts-Taste",               //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 471,475 ****
    },
    { "Postprocessing Method",              //  1
!     "Bildnachbearbeitungsmethode",        //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 471,475 ----
    },
    { "Postprocessing Method",              //  1
!     "Nachbearbeitungs-Methode",        //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 494,498 ****
    },
    { "Postprocessing Quality",             //  1
!     "Nachbearbeitungs Qualit?t",          //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 494,498 ----
    },
    { "Postprocessing Quality",             //  1
!     "Nachbearbeitungs-Qualit?t",          //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 838,843 ****
  #endif
    },
!   { "Cropping",     //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 838,843 ----
  #endif
    },
!   { "Cropping",      //  1
!     "Bildausschnitt",//  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 862,866 ****
    },
    { "Post processing",//  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 862,866 ----
    },
    { "Post processing",//  1
!     "Bildnachbearbeitung",  //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 884,889 ****
  #endif
    },
!   { "Sync Mode",//  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 884,889 ----
  #endif
    },
!   { "Sync Mode",    //  1
!     "Sync Modus",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 931,935 ****
    },
    { "Brightness",   //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 931,935 ----
    },
    { "Brightness",   //  1
!     "Helligkeit",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 954,958 ****
    },
    { "Contrast",     //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 954,958 ----
    },
    { "Contrast",     //  1
!     "Kontrast",     //  2
      "",             //  3 TODO
      "",             //  4 TODO



From nobody at sheep.berlios.de  Sun Feb 19 17:58:38 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 19 Feb 2006 17:58:38 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.155,1.156 ShmClient.c,1.6,1.7 shm-common.h,1.3,1.4
Message-ID: <200602191658.k1JGwcE10593@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14750

Modified Files:
	CHANGELOG ShmClient.c shm-common.h 
Log Message:
fix compilation of shm-client

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.155
retrieving revision 1.156
diff -C2 -d -r1.155 -r1.156
*** CHANGELOG	18 Feb 2006 22:20:29 -0000	1.155
--- CHANGELOG	19 Feb 2006 16:58:35 -0000	1.156
***************
*** 1,540 ****
! Changelog
! 2006-02-18:
!    - fix OSD drawn at wrong location in software OSD blending mode when
!      cropping is active
! 2006-02-17:
!    - fix bug #6409 (OSD not refreshed fast enough in software OSD blending mode
!      when video is paused)
!    - fix crash / deadlocks at startup in 16:9 mode in software OSD blending mode
! 2006-02-12: softdevice-0.2.2
! 2006-02-11:
[...1054 lines suppressed...]
! 
!   2004-04-16 : xv output patch06
!     - implemented StillPicture method
!     - clean up some messages
!     - AFD tag support
! 
!   2004-03-07 : xv output patch05
!     - fixed rounding error for 16:9 output area (height 575 instead of 576).
!     - OSD opaque black color translated to a different dark value so that it
!       is different from the COLORKEY and no longer transparent.
!     - xv output has now a commandline argument:
!         -vo xv:aspect=[wide|normal]
!         examples:
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=wide'
!         ./vdr -P streamdev -P 'softdevice -vo xv:aspect=normal'
!     - OSD not shown (for new users) during remote teaching phase
!       (introduced by patch03).
!     - changed last paramter of X..ShmPut..() to False and replaced XFlush()
!       by XSync() (according to vlc this should save CPU time).
!     - added volume control.

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** ShmClient.c	6 Feb 2006 20:32:00 -0000	1.6
--- ShmClient.c	19 Feb 2006 16:58:35 -0000	1.7
***************
*** 129,133 ****
          ctl->osd_max_width=vout->osd_max_width;
          ctl->osd_max_height=vout->osd_max_height;
!         vout->GetOSDDimension(ctl->osd_width,ctl->osd_height);
          printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
          
--- 129,134 ----
          ctl->osd_max_width=vout->osd_max_width;
          ctl->osd_max_height=vout->osd_max_height;
!         vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
!                               ctl->osd_xPan,ctl->osd_yPan);
          printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
          
***************
*** 162,166 ****
                  };
                  
!                 vout->GetOSDDimension(ctl->osd_width,ctl->osd_height);
                  // consumed all pictures - set semaphore to 0
                  sem_zero(ctl->semid,PICT_SIG);
--- 163,168 ----
                  };
                  
!                 vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
!                                       ctl->osd_xPan,ctl->osd_yPan);
                  // consumed all pictures - set semaphore to 0
                  sem_zero(ctl->semid,PICT_SIG);

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** shm-common.h	4 Feb 2006 10:25:39 -0000	1.3
--- shm-common.h	19 Feb 2006 16:58:35 -0000	1.4
***************
*** 59,62 ****
--- 59,64 ----
          int osd_width;
          int osd_height;
+         int osd_xPan;
+         int osd_yPan;
          int osd_max_width;
          int osd_max_height;



From nobody at sheep.berlios.de  Sun Feb 19 19:40:32 2006
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 19 Feb 2006 19:40:32 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.156,1.157 video-shm.c,1.4,1.5 video-shm.h,1.3,1.4
Message-ID: <200602191840.k1JIeWE16116@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28771

Modified Files:
	CHANGELOG video-shm.c video-shm.h 
Log Message:
fix compilation of video-shm

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.156
retrieving revision 1.157
diff -C2 -d -r1.156 -r1.157
*** CHANGELOG	19 Feb 2006 16:58:35 -0000	1.156
--- CHANGELOG	19 Feb 2006 18:40:28 -0000	1.157
***************
*** 3,6 ****
--- 3,7 ----
     - some german translations
     - fix compilation of shm-client
+    - fix compilation of video-shm
  2006-02-18:
     - fix OSD drawn at wrong location in software OSD blending mode when

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-shm.c	4 Feb 2006 14:40:04 -0000	1.4
--- video-shm.c	19 Feb 2006 18:40:28 -0000	1.5
***************
*** 148,154 ****
  };
  
! void cShmVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
!    switch (setupStore->osdMode) {
!    //switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=ctl->osd_width>ctl->osd_max_width?
--- 148,158 ----
  };
  
! void cShmVideoOut::AdjustOSDMode() {
!   current_osdMode = setupStore->osdMode;
! }
! 
! void cShmVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                    int &xPan, int &yPan) {
!    switch (current_osdMode) {
        case OSDMODE_PSEUDO :
                  OsdWidth=ctl->osd_width>ctl->osd_max_width?
***************
*** 156,163 ****
--- 160,170 ----
                  OsdHeight=ctl->osd_height>ctl->osd_max_height?
                          ctl->osd_max_height:ctl->osd_height;
+                 xPan = yPan = 0;
               break;
        case OSDMODE_SOFTWARE:
                  OsdWidth=swidth;
                  OsdHeight=sheight;
+                 xPan = sxoff;
+                 yPan = syoff;
               break;
      };
***************
*** 166,170 ****
  void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                  bool &IsYUV, uint8_t *&PixelMask) {
!         if (setupStore->osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;
--- 173,177 ----
  void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                  bool &IsYUV, uint8_t *&PixelMask) {
!         if (current_osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** video-shm.h	4 Feb 2006 10:25:39 -0000	1.3
--- video-shm.h	19 Feb 2006 18:40:28 -0000	1.4
***************
*** 44,49 ****
          ~cShmVideoOut();
          
!         virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
!         
          virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                      bool &IsYUV, uint8_t *&PixelMask);
--- 44,52 ----
          ~cShmVideoOut();
          
!         virtual void AdjustOSDMode();
! 
!         virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                      int &xPan, int &yPan);
! 
          virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                      bool &IsYUV, uint8_t *&PixelMask);



From nobody at sheep.berlios.de  Fri Mar 10 22:35:12 2006
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 10 Mar 2006 22:35:12 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.157,1.158 video.c,1.45,1.46
Message-ID: <200603102135.k2ALZCb30659@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8119

Modified Files:
	CHANGELOG video.c 
Log Message:
tune some parameters to avoid unecessary rescaling/redrawing of the OSD


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.157
retrieving revision 1.158
diff -C2 -d -r1.157 -r1.158
*** CHANGELOG	19 Feb 2006 18:40:28 -0000	1.157
--- CHANGELOG	10 Mar 2006 20:36:30 -0000	1.158
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-03-10:
+    - tune some parameters to avoid unecessary rescaling/redrawing of the OSD
  2006-02-19:
     - some german translations

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** video.c	18 Feb 2006 22:20:30 -0000	1.45
--- video.c	10 Mar 2006 20:36:30 -0000	1.46
***************
*** 30,35 ****
  #endif
    // set some reasonable defaults
!   fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
!   fheight = lheight = old_dheight = dheight = sheight = 536;
    sxoff = syoff = lxoff = lyoff = 0;
    cutTop = cutBottom = cutLeft = cutRight = 0;
--- 30,35 ----
  #endif
    // set some reasonable defaults
!   old_width = fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
!   old_height = fheight = lheight = old_dheight = dheight = sheight = 536;
    sxoff = syoff = lxoff = lyoff = 0;
    cutTop = cutBottom = cutLeft = cutRight = 0;
***************
*** 100,108 ****
          //OsdRefreshCounter > 80 ||
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>1 && Osd_changed))
      {
        osdMutex.Lock();
        if (old_picture)
        {
          DrawStill_420pl (old_picture->data[0],
                           old_picture->data[1],
--- 100,109 ----
          //OsdRefreshCounter > 80 ||
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>5 && Osd_changed))
      {
        osdMutex.Lock();
        if (old_picture)
        {
+         OSDDEB("redrawing old_picture\n");
          DrawStill_420pl (old_picture->data[0],
                           old_picture->data[1],
***************
*** 114,118 ****
        else
        {
!         DrawStill_420pl (OsdPy,OsdPu, OsdPv,OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
--- 115,122 ----
        else
        {
!         OSDDEB("drawing osd_layer\n");
!         DrawStill_420pl (OsdPy,OsdPu, OsdPv,
!                         old_width,old_height,
!                         //OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
***************
*** 455,459 ****
    ClearOSD();
    OSDpresent=false;
!   Osd_changed=1;
    osdMutex.Unlock();
    OSDDEB("CloseOSD\n");
--- 459,463 ----
    ClearOSD();
    OSDpresent=false;
!   Osd_changed=0;
    osdMutex.Unlock();
    OSDDEB("CloseOSD\n");



From nobody at sheep.berlios.de  Sat Mar 11 11:17:01 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 11 Mar 2006 11:17:01 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.158,1.159 SoftOsd.c,1.9,1.10
Message-ID: <200603111017.k2BAH1b21314@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13584

Modified Files:
	CHANGELOG SoftOsd.c 
Log Message:

- MMX version of AYUV_to_AYUV420P()
- shortcut for AYUV no scale OSD modes
      


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.158
retrieving revision 1.159
diff -C2 -d -r1.158 -r1.159
*** CHANGELOG	10 Mar 2006 20:36:30 -0000	1.158
--- CHANGELOG	11 Mar 2006 09:18:21 -0000	1.159
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-03-11:
+    - MMX version of AYUV_to_AYUV420P()
+    - shortcut for AYUV no scale OSD modes
  2005-03-10:
     - tune some parameters to avoid unecessary rescaling/redrawing of the OSD

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** SoftOsd.c	18 Feb 2006 22:20:29 -0000	1.9
--- SoftOsd.c	11 Mar 2006 09:18:22 -0000	1.10
***************
*** 463,466 ****
--- 463,651 ----
  		    uint8_t *PAlphaUV,
  		    color * pixmap1, color * pixmap2, int Pixel) {
+        
+ #ifdef USE_MMX2  
+         __asm__(
+                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
+                 : : : "memory" ); 
+         // "memory" is not really needed but g++-2.95 wants to have it :-(
+                                  
+         
+ 	while (Pixel>8*30) {
+                 __asm__ (
+                     " prefetchnta 96(%0) \n"
+                     " prefetchnta 96(%1) \n"
+                     : : "r" (pixmap1), "r" (pixmap2) );
+ 
+                 __asm__(
+                     " movd  (%0),%%mm0\n"    
+                     " punpcklbw 4(%0),%%mm0\n"// mm0: 1A 2A 1Y 2Y 1U 2U 1V 2V 
+                     " movd  8(%0),%%mm1\n"  
+                     " punpcklbw 12(%0),%%mm1\n"// mm1: 3A 4A 3Y 4Y 3U 4U 3V 4V 
+                    
+                     " movq %%mm0, %%mm2 \n"
+                     " punpckhwd %%mm1, %%mm2 \n" //mm2: 1A 2A 3A 4A 1Y 2Y 3Y 4Y
+                     " movd %%mm2, (%2) \n" // store alpha  values 1-4 first line
+                     " punpckhdq %%mm2, %%mm2 \n"
+                     " movd %%mm2, (%1) \n" // store luminance values 1-4 first line
+                     " punpcklwd %%mm1, %%mm0 \n" //mm0: 1U 2U 3U 4U 1V 2V 3V 4V
+                     " movq %%mm0, %%mm1  \n"
+                     " punpckhbw %%mm7, %%mm0 \n" //mm0: 1V 00 2V 00 3V 00 4V 00
+                     " punpcklbw %%mm7, %%mm1 \n" //mm1: 1U 00 2U 00 3U 00 4U 00
+                     : : "r" (pixmap1),
+                         "r" (PAlphaY1),
+                         "r" (PY1) : "memory");
+                 
+                 __asm__(
+                     // second line
+                     " movd  (%0),%%mm3\n"    
+                     " punpcklbw 4(%0),%%mm3\n"// mm3: 1A 2A 1Y 2Y 1U 2U 1V 2V 
+                     " movd  8(%0),%%mm4\n"  
+                     " punpcklbw 12(%0),%%mm4\n"//mm4: 3A 4A 3Y 4Y 3U 4U 3V 4V  
+                     
+                     " movq %%mm3, %%mm2 \n"
+                     " punpckhwd %%mm4, %%mm2 \n" //mm2: 1A 2A 3A 4A 1Y 2Y 3Y 4Y
+                     " movd %%mm2, (%2) \n" // store alpha 1-4 second line
+                     " punpckhdq %%mm2, %%mm2 \n"
+                     " movd %%mm2, (%1) \n" // store luminance 1-4 second line
+  
+                     " punpcklwd %%mm4, %%mm3 \n" //mm3: 1U 2U 3U 4U 1V 2V 3V 4V
+ 
+                     " movq %%mm3, %%mm4  \n"
+                     " punpckhbw %%mm7, %%mm3 \n" //mm0: 1V 00 2V 00 3V 00 4V 00
+                     " punpcklbw %%mm7, %%mm4 \n" //mm1: 1U 00 2U 00 3U 00 4U 00
+ 
+                     // add U and V component of first and second line
+                     " paddusw %%mm3, %%mm0 \n"
+                     " paddusw %%mm4, %%mm1 \n"
+                     
+                     " pshufw $0b11011101,%%mm0,%%mm2 \n" //mm2: 2V 00 4V 00
+                     " pshufw $0b10001000,%%mm0,%%mm6 \n" //mm6: 1V 00 3V 00
+                     " paddusw %%mm2, %%mm6 \n" // mm6: 1V+2V  3V+4V
+                     " psraw $2, %%mm6 \n" // mm6 div 4
+                     
+                     " pshufw $0b11011101,%%mm1,%%mm2 \n" //mm2: 2U 00 4U 00
+                     " pshufw $0b10001000,%%mm1,%%mm1 \n" //mm1: 1U 00 3U 00
+                     " paddusw %%mm2, %%mm1 \n" // mm1: 1U+2U 3U+4U
+                     " psraw $2, %%mm1 \n" // mm1 div 4
+                     
+                     " packuswb %%mm1,%%mm6 \n" // mm6: 1u+2u 3u+4u XX XX 1v+2v 3v+4v XX XX
+                     : : "r" (pixmap2),
+                         "r" (PAlphaY2),
+                         "r" (PY2): "memory");
+ 
+                 // next 4 pixels
+                 __asm__(   
+                     // inventory: mm6: 2 pixels u and v values    
+                     " movd  16(%0),%%mm0\n"    
+                     " punpcklbw 20(%0),%%mm0\n"// mm0: 1A 2A 1Y 2Y 1U 2U 1V 2V 
+                     " movd  24(%0),%%mm1\n"  
+                     " punpcklbw 28(%0),%%mm1\n"// mm1: 3A 4A 3Y 4Y 3U 4U 3V 4V 
+                    
+                     " movq %%mm0, %%mm2 \n"
+                     " punpckhwd %%mm1, %%mm2 \n" //mm2: 1A 2A 3A 4A 1Y 2Y 3Y 4Y
+                     " movd %%mm2, 4(%2) \n" // store alpha  values 1-4 first line
+                     " punpckhdq %%mm2, %%mm2 \n"
+                     " movd %%mm2, 4(%1) \n" // store luminance values 1-4 first line
+                     " punpcklwd %%mm1, %%mm0 \n" //mm0: 1U 2U 3U 4U 1V 2V 3V 4V
+                     " movq %%mm0, %%mm1  \n"
+                     " punpckhbw %%mm7, %%mm0 \n" //mm0: 1V 00 2V 00 3V 00 4V 00
+                     " punpcklbw %%mm7, %%mm1 \n" //mm1: 1U 00 2U 00 3U 00 4U 00
+                     : : "r" (pixmap1),
+                         "r" (PAlphaY1),
+                         "r" (PY1) : "memory");
+                 
+                 __asm__(
+                     // second line
+                     " movd  16(%0),%%mm3\n"    
+                     " punpcklbw 20(%0),%%mm3\n"//mm3: 1A 2A 1Y 2Y 1U 2U 1V 2V 
+                     " movd  24(%0),%%mm4\n"  
+                     " punpcklbw 28(%0),%%mm4\n"//mm4: 3A 4A 3Y 4Y 3U 4U 3V 4V  
+                     
+                     " movq %%mm3, %%mm2 \n"
+                     " punpckhwd %%mm4, %%mm2 \n" //mm2: 1A 2A 3A 4A 1Y 2Y 3Y 4Y
+                     " movd %%mm2, 4(%2) \n" // store alpha 1-4 second line
+                     " punpckhdq %%mm2, %%mm2 \n"
+                     " movd %%mm2, 4(%1) \n" // store luminance 1-4 second line
+  
+                     " punpcklwd %%mm4, %%mm3 \n" //mm3: 1U 2U 3U 4U 1V 2V 3V 4V
+ 
+                     " movq %%mm3, %%mm4  \n"
+                     " punpckhbw %%mm7, %%mm3 \n" //mm0: 1V 00 2V 00 3V 00 4V 00
+                     " punpcklbw %%mm7, %%mm4 \n" //mm1: 1U 00 2U 00 3U 00 4U 00
+ 
+                     // add U and V component of first and second line
+                     " paddusw %%mm3, %%mm0 \n"
+                     " paddusw %%mm4, %%mm1 \n"
+                     
+                     " pshufw $0b11011101,%%mm0,%%mm2 \n" //mm2: 2V 00 4V 00
+                     " pshufw $0b10001000,%%mm0,%%mm0 \n" //mm0: 1V 00 3V 00
+                     " paddusw %%mm2, %%mm0 \n" // mm0: 1V+2V  3V+4V
+                     " psraw $2, %%mm0 \n" // mm0 div 4
+                     
+                     " pshufw $0b11011101,%%mm1,%%mm2 \n" //mm2: 2U 00 4U 00
+                     " pshufw $0b10001000,%%mm1,%%mm1 \n" //mm1: 1U 00 3U 00
+                     " paddusw %%mm2, %%mm1 \n" // mm1: 1U+2U 3U+4U
+                     " psraw $2, %%mm1 \n" // mm1 div 4
+                     
+                     " packuswb %%mm1,%%mm0 \n" // mm0: 1u+2u 3u+4u XX XX 1v+2v 3v+4v XX XX
+                     : : "r" (pixmap2),
+                         "r" (PAlphaY2),
+                         "r" (PY2): "memory");
+                
+                 // now care about the missing u and v components
+                 __asm__(   
+                     // inventory: 
+                     // mm6: first 2 pixels u and v values    
+                     // mm0: second 2 pixels u and v values
+                     " movq %%mm6, %%mm2 \n"
+                     " punpckhwd %%mm0, %%mm6\n"
+                     " punpcklwd %%mm0, %%mm2\n"
+                     " movd %%mm2, (%1)\n"
+                     " movd %%mm6, (%0) \n"
+                     : : "r" (PU), "r" (PV) : "memory" );
+ 
+                 // and calculate PAlphaUV from PAlphaY1 and PAlphaY2
+                 __asm__(
+                     " movd (%0), %%mm0 \n"
+                     " punpcklbw %%mm7, %%mm0 \n"
+                     " movd (%1), %%mm1 \n"
+                     " punpcklbw %%mm7, %%mm1 \n"
+                     " paddusw %%mm1, %%mm0 \n" // mm1: PAlphaY1+PAlphaY2
+                     
+                     " pshufw $0b11011101,%%mm0,%%mm1 \n" //mm2: 2A 00 4A 00
+                     " pshufw $0b10001000,%%mm0,%%mm0 \n" //mm0: 1A 00 3A 00
+                     " paddusw %%mm1, %%mm0 \n" // mm0: 1A+2A  3A+4A
+                     " psraw $2, %%mm0 \n" // mm0 div 4
+                     " packuswb %%mm0,%%mm0 \n"
+ 
+                     " movd 4(%0), %%mm2 \n"
+                     " punpcklbw %%mm7, %%mm2 \n"
+                     " movd 4(%1), %%mm3 \n"
+                     " punpcklbw %%mm7,%%mm3 \n"
+                     " paddusw %%mm3, %%mm2 \n" // mm2: PAlphaY1+PAlphaY2
+ 
+                     " pshufw $0b11011101,%%mm2,%%mm1 \n" //mm2: 6A 00 8A 00
+                     " pshufw $0b10001000,%%mm2,%%mm3 \n" //mm0: 5A 00 7A 00
+                     " paddusw %%mm1, %%mm3 \n" // mm0: 5A+6A  7A+8A
+                     " psraw $2, %%mm3 \n" // mm0 div 4
+                     " packuswb %%mm3,%%mm3 \n"
+ 
+                     " punpckhwd %%mm3, %%mm0\n"
+                     " movd %%mm0, (%2)\n"
+                      
+                      : : "r" (PAlphaY1), "r" (PAlphaY2),
+                          "r" (PAlphaUV)
+                                  : "memory" );
+ 
+                 pixmap1+=8;
+                 pixmap2+=8;
+                 PAlphaY1+=8;PAlphaY2+=8;
+                 PY1+=8;PY2+=8;
+                 PU+=4;PV+=4;
+                 PAlphaUV+=4;
+                 Pixel-=8;
+         };       
+ 	EMMS;
+ #endif
  	while (Pixel>1) {
  		*(PAlphaY1++)=pixmap1[0].a; *(PAlphaY1++)=pixmap1[1].a;
***************
*** 636,640 ****
          };
  };
- 
  //---------------------------YUV modes ----------------------
  void cSoftOsd::CopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
--- 821,824 ----
***************
*** 659,663 ****
          color *pixmap=(color*) OSD_Bitmap;
          int dest_Stride=(dest_Width+32) & ~0xf;
!         color tmp_pixmap[2*dest_Stride];
          uint8_t *pY;uint8_t *pU;uint8_t *pV;
          uint8_t *pAlphaY; uint8_t *pAlphaUV;
--- 843,848 ----
          color *pixmap=(color*) OSD_Bitmap;
          int dest_Stride=(dest_Width+32) & ~0xf;
!         color tmp_pixmap1[2*dest_Stride];
!         color *tmp_pixmap=tmp_pixmap1;
          uint8_t *pY;uint8_t *pU;uint8_t *pV;
          uint8_t *pAlphaY; uint8_t *pAlphaUV;
***************
*** 666,670 ****
                        ( dest_Width==OSD_WIDTH ? &cSoftOsd::NoScaleHoriz_MMX :
                          &cSoftOsd::ScaleUpHoriz_MMX));
!       
          for (int y=0; y<dest_Height; y+=2) {
  
--- 851,858 ----
                        ( dest_Width==OSD_WIDTH ? &cSoftOsd::NoScaleHoriz_MMX :
                          &cSoftOsd::ScaleUpHoriz_MMX));
!         
!         if (dest_Width==OSD_WIDTH) 
!                 dest_Stride=OSD_STRIDE;
!  
          for (int y=0; y<dest_Height; y+=2) {
  
***************
*** 675,685 ****
                          continue;
  
!                 //printf("Horiz scaling line %d\n",start_row+i);
!                 (this->*ScaleHoriz)((uint8_t *)tmp_pixmap,dest_Width,
!                                 &pixmap[y*OSD_STRIDE],OSD_WIDTH-1); 
!                 (this->*ScaleHoriz)((uint8_t *)&tmp_pixmap[dest_Stride],
!                                 dest_Width,
!                                 &pixmap[(y+1)*OSD_STRIDE],OSD_WIDTH-1); 
! 
                  // convert and copy to video out OSD layer
                  pY=PY+(y+yPan)*Ystride+xPan;
--- 863,876 ----
                          continue;
  
!                 if (dest_Width==OSD_WIDTH) {
!                         tmp_pixmap=&pixmap[y*OSD_STRIDE];
!                 } else {
!                         //printf("Horiz scaling line %d\n",start_row+i);
!                         (this->*ScaleHoriz)((uint8_t *)tmp_pixmap,dest_Width,
!                                             &pixmap[y*OSD_STRIDE],OSD_WIDTH-1); 
!                         (this->*ScaleHoriz)((uint8_t *)&tmp_pixmap[dest_Stride],
!                                             dest_Width,
!                                             &pixmap[(y+1)*OSD_STRIDE],OSD_WIDTH-1); 
!                 };
                  // convert and copy to video out OSD layer
                  pY=PY+(y+yPan)*Ystride+xPan;
***************
*** 723,727 ****
          uint8_t *pY;uint8_t *pU;uint8_t *pV;
          uint8_t *pAlphaY; uint8_t *pAlphaUV;
!        
          //printf("Scale to %d,%d\n",dest_Width,dest_Height);
          const int ScaleFactor=1<<6;
--- 914,918 ----
          uint8_t *pY;uint8_t *pU;uint8_t *pV;
          uint8_t *pAlphaY; uint8_t *pAlphaUV;
!     
          //printf("Scale to %d,%d\n",dest_Width,dest_Height);
          const int ScaleFactor=1<<6;
***************
*** 841,847 ****
          memset(scaleH_lines,-1,sizeof(scaleH_lines));
          
          color tmp_pixmap[20*dest_stride];//dest_Width];
          //color tmp_pixmap[ScaleFactor/dest_Height*dest_stride];//dest_Width];
!         
  	for (int y=0; y<dest_Height; y++) {
                  int start_row=new_pixel_height*y/ScaleFactor;
--- 1032,1039 ----
          memset(scaleH_lines,-1,sizeof(scaleH_lines));
          
+         // FIXME why 20*dest_stride?
          color tmp_pixmap[20*dest_stride];//dest_Width];
          //color tmp_pixmap[ScaleFactor/dest_Height*dest_stride];//dest_Width];
! 
  	for (int y=0; y<dest_Height; y++) {
                  int start_row=new_pixel_height*y/ScaleFactor;



From nobody at sheep.berlios.de  Sun Mar 12 11:42:08 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 12 Mar 2006 11:42:08 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.159,1.160 video.h,1.30,1.31 video-dfb.c,1.50,1.51 video-vidix.c,1.16,1.17 video-xv.c,1.44,1.45 video.c,1.46,1.47
Message-ID: <200603121042.k2CAg8b07055@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5663

Modified Files:
	CHANGELOG video.h video-dfb.c video-vidix.c video-xv.c video.c 
Log Message:
- redraw video layer on OSD close in software mode
- use OsdWidth and OsdHeight for drawing osd layer
   


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.159
retrieving revision 1.160
diff -C2 -d -r1.159 -r1.160
*** CHANGELOG	11 Mar 2006 09:18:21 -0000	1.159
--- CHANGELOG	12 Mar 2006 09:43:28 -0000	1.160
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-03-12:
+    - redraw video layer on OSD close in software mode
+    - use OsdWidth and OsdHeight for drawing osd layer
  2005-03-11:
     - MMX version of AYUV_to_AYUV420P()

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** video.h	18 Feb 2006 22:20:30 -0000	1.30
--- video.h	12 Mar 2006 09:43:28 -0000	1.31
***************
*** 153,157 ****
  
      uint8_t *PixelMask;
-     int     Osd_changed;
      uint8_t *OsdPy;
      uint8_t *OsdPu; 
--- 153,156 ----
***************
*** 162,173 ****
      void init_OsdBuffers();
      
!     uint16_t OsdHeight;
!     uint16_t OsdWidth;
!     // current dimensions of the OSD
!     
      uint16_t OsdRefreshCounter;
      // should be setted to null everytime OSD is shown 
      // (software alpha blending mode).  
! 
      virtual void ClearOSD();
      // clear the OSD buffer
--- 161,174 ----
      void init_OsdBuffers();
      
!     int OsdHeight;
!     int OsdWidth;
!     // current dimensions of the software OSD
! private:
!     int     Osd_changed;
!    
      uint16_t OsdRefreshCounter;
      // should be setted to null everytime OSD is shown 
      // (software alpha blending mode).  
! public:
      virtual void ClearOSD();
      // clear the OSD buffer
***************
*** 197,201 ****
      { osd=NULL; stride=0; dirtyLines=NULL;};
      virtual void CommitUnlockOsdSurface()
!     { OSDpresent=true; };
  
      // Software YUV mode
--- 198,202 ----
      { osd=NULL; stride=0; dirtyLines=NULL;};
      virtual void CommitUnlockOsdSurface()
!     { OSDpresent=true; Osd_changed=1; };
  
      // Software YUV mode
***************
*** 208,213 ****
              strideY=OSD_FULL_WIDTH; strideUV=OSD_FULL_WIDTH/2;};
  
!     virtual void CommitUnlockSoftOsdSurface()
!     { OSDpresent=true; };
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
--- 209,214 ----
              strideY=OSD_FULL_WIDTH; strideUV=OSD_FULL_WIDTH/2;};
  
!     virtual void CommitUnlockSoftOsdSurface( int osdwidth, int osdheight)
!     { OSDpresent=true; OsdWidth=osdwidth; OsdHeight=osdheight; Osd_changed=1;};
        
     void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** video-dfb.c	18 Feb 2006 22:20:29 -0000	1.50
--- video-dfb.c	12 Mar 2006 09:43:28 -0000	1.51
***************
*** 1358,1362 ****
      int hi;
  
-   OsdRefreshCounter=0;
    events_not_done = 0;
    SetParams();
--- 1358,1361 ----

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video-vidix.c	18 Feb 2006 22:20:29 -0000	1.16
--- video-vidix.c	12 Mar 2006 09:43:28 -0000	1.17
***************
*** 416,421 ****
    Pu += (UVstride * syoff/2);
  
-   OsdRefreshCounter=0;
- 
    if (currentPixelFormat == 0 || currentPixelFormat == 1)
    {
--- 416,419 ----

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** video-xv.c	18 Feb 2006 22:20:30 -0000	1.44
--- video-xv.c	12 Mar 2006 09:43:28 -0000	1.45
***************
*** 820,827 ****
            isLocal = false;
  
    useShm=XShmQueryExtension(dpy) && isLocal;
    if (useShm) {
- 	  osd_max_width=DisplayWidth(dpy,DefaultScreen(dpy));
-           osd_max_height=DisplayHeight(dpy,DefaultScreen(dpy));
  
            osd_image = XShmCreateImage (dpy,
--- 820,827 ----
            isLocal = false;
  
+   osd_max_width=DisplayWidth(dpy,DefaultScreen(dpy));
+   osd_max_height=DisplayHeight(dpy,DefaultScreen(dpy));
    useShm=XShmQueryExtension(dpy) && isLocal;
    if (useShm) {
  
            osd_image = XShmCreateImage (dpy,
***************
*** 1411,1416 ****
  
  #if VDRVERSNUM >= 10307
-   OsdRefreshCounter=0;
- 
    /* -------------------------------------------------------------------------
     * don't know where those funny stride values (752,376) come from.
--- 1411,1414 ----

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** video.c	10 Mar 2006 20:36:30 -0000	1.46
--- video.c	12 Mar 2006 09:43:28 -0000	1.47
***************
*** 93,104 ****
    {
      OsdRefreshCounter++;
      if (
!         //
!         // Don't do an unconditional redraw. TV-out cannot handle higher
!         // diplay rates than 25Hz.
!         //
!         //OsdRefreshCounter > 80 ||
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>5 && Osd_changed))
      {
        osdMutex.Lock();
--- 93,101 ----
    {
      OsdRefreshCounter++;
+     usleep(50000);
      if (
!         OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
          (setupStore->osdMode == OSDMODE_SOFTWARE &&
!          OsdRefreshCounter>2 && Osd_changed))
      {
        osdMutex.Lock();
***************
*** 117,128 ****
          OSDDEB("drawing osd_layer\n");
          DrawStill_420pl (OsdPy,OsdPu, OsdPv,
!                         old_width,old_height,
                          //OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
-       Osd_changed=0;
        osdMutex.Unlock();
      }
-     usleep(50000);
    }
  #endif
--- 114,123 ----
          OSDDEB("drawing osd_layer\n");
          DrawStill_420pl (OsdPy,OsdPu, OsdPv,
!                         OsdWidth,OsdHeight,
                          //OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
        osdMutex.Unlock();
      }
    }
  #endif
***************
*** 397,400 ****
--- 392,396 ----
    areaMutex. Lock();
    OsdRefreshCounter=0;
+   Osd_changed=0;
    CheckAspectDimensions(picture,context);
    SetOldPicture(picture,context->width,context->height);
***************
*** 420,423 ****
--- 416,420 ----
    areaMutex. Lock();
    OsdRefreshCounter=0;
+   Osd_changed=0;
    RecalculateAspect();
    CheckArea(w, h);
***************
*** 432,435 ****
--- 429,433 ----
  {
    OSDDEB("ClearOSD\n");
+   OSDpresent=false; // will automaticly be set to true on redraw ;-)
    //if (current_osdMode==OSDMODE_SOFTWARE)
    {
***************
*** 445,448 ****
--- 443,447 ----
         memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
     };
+   Osd_changed=1;
  };
  
***************
*** 459,463 ****
    ClearOSD();
    OSDpresent=false;
-   Osd_changed=0;
    osdMutex.Unlock();
    OSDDEB("CloseOSD\n");
--- 458,461 ----



From nobody at sheep.berlios.de  Sun Mar 12 11:46:23 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 12 Mar 2006 11:46:23 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.160,1.161 mpeg2decoder.c,1.61,1.62
Message-ID: <200603121046.k2CAkNb07179@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6033

Modified Files:
	CHANGELOG mpeg2decoder.c 
Log Message:
- Fix StillPicture handling when no PES header is sent 
  (for example streamdev-server-plugin)
	


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.160
retrieving revision 1.161
diff -C2 -d -r1.160 -r1.161
*** CHANGELOG	12 Mar 2006 09:43:28 -0000	1.160
--- CHANGELOG	12 Mar 2006 09:47:43 -0000	1.161
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-03-12:
+    - Fix StillPicture handling when no PES header is sent 
+      (for example streamdev-server-plugin)
     - redraw video layer on OSD close in software mode
     - use OsdWidth and OsdHeight for drawing osd layer

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.61
retrieving revision 1.62
diff -C2 -d -r1.61 -r1.62
*** mpeg2decoder.c	6 Feb 2006 20:32:00 -0000	1.61
--- mpeg2decoder.c	12 Mar 2006 09:47:43 -0000	1.62
***************
*** 145,149 ****
    syncTimer=NULL;
  
! //  Context->debug |=FF_DEBUG_STARTCODE;
    active=true;
    Start(); // starte thread
--- 145,150 ----
    syncTimer=NULL;
  
! //  Context->debug |=0xF|FF_DEBUG_STARTCODE|FF_DEBUG_PTS;
! //  av_log_set_level(AV_LOG_DEBUG);
    active=true;
    Start(); // starte thread
***************
*** 1558,1587 ****
  /* ----------------------------------------------------------------------------
   */
  int cMpeg2Decoder::StillPicture(uchar *Data, int Length)
  {
!   //Clear();
!   mutex.Lock();
!   CMDDEB("StillPicture \n");
    // XXX hack to ingore audio junk sent by vdr in the still picture
    AudioIdx=DONT_PLAY;
    for (int i=0; 4>i;i++) {
!     int P;
!     uchar *data=Data;
!     int Size=Length;
!     BUFDEB("StillPicture StreamBuffer Put %d\n",Size);
!     while ( (P = StreamBuffer->Put(data, Size)) != Size ) {
!       BUFDEB("StillPicture StreamBuffer->Put only accepted %d bytes\n",P);
!       data+=P;
!       Size-=P;
!       BUFDEB("StillPicture EnableGet.Signal(), EnablePut.Sleep start\n");
!       EnableGetSignal.Signal();
!       EnablePutSignal.Sleep(50000);
!       BUFDEB("StillPicture EnablePut.Sleep end\n");
!     }
!     BUFDEB("StillPicture EnableGetSignal.Signal() wrote %d bytes\n",Length);
!     EnableGetSignal.Signal();
    }
    CMDDEB("StillPicture end \n");
-   mutex.Unlock();
    return Length;
  }
--- 1559,1598 ----
  /* ----------------------------------------------------------------------------
   */
+ 
+ static uint8_t pes_packet_header[] = {
+      0x00,0x00,0x01, 0xe0,           0x00,0x00,   0x84, 0x00, 0x00,0x00};
+      // startcode,  video-stream 0, packet length,      no pts
  int cMpeg2Decoder::StillPicture(uchar *Data, int Length)
  {
!   bool has_pesheader=false;
!   CMDDEB("StillPicture %p length %d \n",Data,Length);
    // XXX hack to ingore audio junk sent by vdr in the still picture
    AudioIdx=DONT_PLAY;
+ 
+   // check if data contains a valid pes header
+ #define SEARCH_LENGTH 64
+   if (Length>SEARCH_LENGTH) {
+     uchar *start=Data+1;
+     do {
+       start++;
+       start=(uchar *)memchr(start,0x01,Data+SEARCH_LENGTH-start);
+       if ( start && start[-1]==0 && start[-2] == 0
+           && ((start[1] &0xF0)==0xe0) ) { // video stream pes header
+         has_pesheader=true;
+         break;
+       };
+     } while (start<Data+SEARCH_LENGTH && start);
+   };
+ 
    for (int i=0; 4>i;i++) {
!     if (!has_pesheader) {
!       // send a fake pes header
!       pes_packet_header[4]=(Length+2)>>8 & 0xFF;
!       pes_packet_header[5]=(Length+2) & 0xFF;
!       Decode(pes_packet_header,9);
!     };
!     Decode(Data,Length);
    }
    CMDDEB("StillPicture end \n");
    return Length;
  }
***************
*** 1684,1688 ****
  int cMpeg2Decoder::Decode(const uchar *Data, int Length)
  {
!   BUFDEB("Decode %x, Length %d\n",Data,Length);
    
    if (running && !IsSuspended && setupStore.shouldSuspend)
--- 1695,1699 ----
  int cMpeg2Decoder::Decode(const uchar *Data, int Length)
  {
!   BUFDEB("Decode %p, Length %d\n",Data,Length);
    
    if (running && !IsSuspended && setupStore.shouldSuspend)



From nobody at sheep.berlios.de  Sun Mar 12 13:40:32 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 12 Mar 2006 13:40:32 +0100
Subject: [Softdevice-cvs] softdevice SoftOsd.c,1.10,1.11
Message-ID: <200603121240.k2CCeWb12656@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18118

Modified Files:
	SoftOsd.c 
Log Message:
forgot to commit SoftOsd.c ...



Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** SoftOsd.c	11 Mar 2006 09:18:22 -0000	1.10
--- SoftOsd.c	12 Mar 2006 11:41:50 -0000	1.11
***************
*** 171,175 ****
                                          ScreenOsdWidth,ScreenOsdHeight,
                                          RefreshAll);
!                 videoOut->CommitUnlockSoftOsdSurface();
          } else {
                  uint8_t *osd; int stride; bool *dirtyLines;
--- 171,176 ----
                                          ScreenOsdWidth,ScreenOsdHeight,
                                          RefreshAll);
!                 videoOut->CommitUnlockSoftOsdSurface(ScreenOsdWidth,
!                                 ScreenOsdHeight);
          } else {
                  uint8_t *osd; int stride; bool *dirtyLines;
***************
*** 180,184 ****
                  videoOut->CommitUnlockOsdSurface();
          }
-         videoOut->Osd_changed = true;
  };
  
--- 181,184 ----



From nobody at sheep.berlios.de  Sun Mar 12 22:22:04 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 12 Mar 2006 22:22:04 +0100
Subject: [Softdevice-cvs] softplay FileIndex.c,NONE,1.1 FileIndex.h,NONE,1.1 Receiver.c,NONE,1.1 Receiver.h,NONE,1.1 Setup.c,NONE,1.1 Setup.h,NONE,1.1 SoftHandles.h,NONE,1.1 README,1.5,1.6
Message-ID: <200603122122.k2CLM4b02003@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv30097

Modified Files:
	README 
Added Files:
	FileIndex.c FileIndex.h Receiver.c Receiver.h Setup.c Setup.h 
	SoftHandles.h 
Log Message:
- change playlist format
- use the service interface (no need to include softdevice.h anymore!)
- introduce a file index
- introduce setup options
- introduce a receiver for live tv
- many, more things I forgot about...



--- NEW FILE: FileIndex.c ---
/*
 * Media Player plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: FileIndex.c,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */

#include "FileIndex.h"

#define INDEXDEB(out...) printf("INDEXDEB: " out)


//--cIndex------------------------------------------------------------------

void cIndex::copyName(char* dest,int size, const char *const src) {
        strlcpy(dest,src,size);
        stripTrailingNonLetters(dest);
        //printf("copyName to '%s'\n");
};


void cIndex::Save(FILE *out) {
        
        //don't save empty entries (at least for now...)
        if ( !*GetTitle() )
                return;
	
        fprintf(out,"\"%s\",",GetFilename());
	fprintf(out,"\"%s\",",GetTitle());
        fprintf(out,"\"%s\",",GetAlbum());
        fprintf(out,"\"%s\",",GetAuthor());
        fprintf(out,"\"%d\",",GetDuration());
        fprintf(out,"\n");
};

void cIndex::ParseSaveLine(const char *pos ) {
        char str[STR_LENGTH];
 
	skipSpaces(pos);
 	// read title
        if ( !(pos = ReadQuotedString(str,pos) ) ) {
                printf("Could not parse title. Ignoring.\n");
                return;
        };
	SetTitle(str);
	
	nextField(pos);
 	// read album
        if ( !(pos = ReadQuotedString(str,pos) ) ) {
                printf("Could not parse album. Ignoring.\n");
                return ;
        };
	SetAlbum(str);

	nextField(pos);
	// read author
        if ( !(pos = ReadQuotedString(str,pos) ) ) {
                printf("Could not parse author. Ignoring.\n");
                return;
        };
	SetAuthor(str);

	nextField(pos);
	// read duration
        if ( !(pos = ReadQuotedString(str,pos) ) ) {
                printf("Could not parse duration. Ignoring.\n");
                return;
        };
	SetDuration(atoi(str));
};
 
void cIndex::ParseM3uExtInf(const char *pos) {
	char tmp[100];
	int len=0;

        INDEXDEB("Parse extinfo '%s'\n",pos);

	if ( !pos || *pos !='#' )
		return;
	pos++;
	
	skipSpaces(pos);
	if ( strncmp(pos,"EXTINF",6) )
		return;
	pos+=6;

	skipSpaces(pos);
	if ( *pos !=':' )
		return;
	pos++;
	
	skipSpaces(pos);
        printf("duration '%s' \n",pos);
        if ( !*pos || sscanf(pos,"%100[0-9]%n",&tmp,&len) == 0 ) {
                printf("EXTINF Could not parse duration \"%s\". Ignoring.\n",pos);
                return;
        };
        duration=atoi(tmp);
        printf("duration parsed '%s'= %d\n",tmp,duration);
        pos=pos + len;

	skipSpaces(pos);
	if ( *pos !=',' )
		return;
	pos++;
	
	skipSpaces(pos);
	if ( !*pos || sscanf(pos,"%100[^-]%n",tmp,&len) == 0 ) {
                printf("EXTINF Could not parse author \"%s\". Ignoring.\n",pos);
                return;
        };
        pos=pos + len;
	SetAuthor(tmp);
	
	skipSpaces(pos);
	if ( *pos !='-' )
		return;
	pos++;
	
	skipSpaces(pos);
	// the rest should be the title
	SetTitle(pos);

	INDEXDEB("Parsed M3U EXTINF: %d '%s' '%s'\n",duration,author,title);
};	

//---cIndexIdx------------------------------------------------------------

cIndexIdx::~cIndexIdx() {
        if (!index)
                       return;

        while ( nIndex-- ) 
                delete index[nIndex].file;

        free(index);
};


cIndex *cIndexIdx::GetIndex(const char *Filename) {
        if (!index || !Filename)
                return NULL;
        
        int Hash=SimpleHash(Filename);
        
        for (int i=0; i < nIndex; i++ ) 
                if ( Hash == index[i].hash && 
                            strcmp(index[i].file->GetFilename(),Filename)==0 )
                        return index[i].file;
        
        
        return NULL;
};

#define MIN_INDEX_SIZE 200

bool cIndexIdx::ReallocIndex() {
        void *tmp;
        
        if ( !(tmp=realloc(index,indexSize+MIN_INDEX_SIZE*
                                        sizeof(sIndexRef))) ) {
                fprintf(stderr,"reallocation of file index failed!\n");
                return false;
        };

        index=(sIndexRef *) tmp;
        indexSize+=MIN_INDEX_SIZE;
        return true;
};

cIndex *cIndexIdx::AddIndex(const char *Filename) {
        if (!Filename)
                return NULL;
        // realloc in case the array is too small
        if ( nIndex >= indexSize && !ReallocIndex() )
                return NULL;
        
        index[nIndex].hash=SimpleHash(Filename);
        index[nIndex].file=new cIndex(Filename);
        nIndex++;

        return index[nIndex-1].file;
};

void cIndexIdx::SaveIndex(const char *Filename) {
	if (!index)
		return;

        FILE *out=fopen(Filename,"w");
        if (!out)
                return;

        for (int i=0; i < nIndex; i++ ) 
                if (index[i].file)
                        index[i].file->Save(out);

        return;
};

bool cIndexIdx::ReadIndex(const char *Filename) {
        char line[500];
        char str[STR_LENGTH];
        const char *pos;
        cIndex *Idx;
        
        FILE *in=fopen(Filename,"r");
        if (!in)
                return false;
                
        while( !feof(in) && fgets(line,500,in)) {
                chomp(line);

                pos=line;
                skipSpaces(pos);
                // read filename
                if ( !(pos = ReadQuotedString(str,pos) ) ) {
                        INDEXDEB("Could not parse filename. Ignoring.\n");
                        continue;
                };
                Idx=GetOrAddIndex(str);
                if (!Idx)
                        return false;
                
                nextField(pos);
                Idx->ParseSaveLine(pos);
        };
        return true;
};

        

--- NEW FILE: FileIndex.h ---
/*
 * Media Player plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: FileIndex.h,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */

#ifndef __FILEINDEX_H__
#define __FILEINDEX_H__

#include <string.h>

#include "softplay.h"

class cIndex {
        protected:
                char filename[STR_LENGTH];
                char title[STR_LENGTH];
                char album[STR_LENGTH];
                char author[STR_LENGTH];

                int duration;

                void copyName(char* dest,int size, const char *const src);
        public:
                cIndex(const char *Filename=NULL) {
                        if (Filename)
                                copyName(filename,sizeof(filename),Filename);
                        else filename[0]=0;
                                
                        title[0]=album[0]=author[0]=0;
                        duration=0;
                };
                virtual ~cIndex() {};
  
  		inline const char *GetFilename() 
                { return filename; };

                
                inline const char *GetTitle() 
                { return title; };

                inline void SetTitle( const char *const Title) { 
                        copyName(title,sizeof(title),Title);
                };

                inline const char *GetAlbum()
                { return album; };

                inline void SetAlbum( const char *const Album) {
                        copyName(album,sizeof(album),Album);
                };

                inline const char *GetAuthor()
                { return author; };

                inline void SetAuthor( const char *const Author) {
                        copyName(author,sizeof(author),Author);
                };

                inline const int GetDuration()
                { return duration; };

                inline void SetDuration(int Duration) {
                        duration=Duration;
                };

                void Save(FILE *out);
                
                void ParseSaveLine(const char *pos );
                void ParseM3uExtInf(const char *pos);
};

struct sIndexRef {
        int hash;
        cIndex *file;
};

class cIndexIdx {
        protected:
                sIndexRef *index;
                int nIndex;
                int indexSize;
        
		bool ReallocIndex();
        public:
                cIndexIdx() : index(NULL),nIndex(0),indexSize(0)
                {};
                   
                virtual ~cIndexIdx();

		cIndex *GetIndex(const char *Filename);

		cIndex *AddIndex(const char *Filename);

		inline cIndex *GetOrAddIndex(const char *Filename) {
                        cIndex *Idx=GetIndex(Filename);
                        return Idx ? Idx : AddIndex(Filename);
                };

                void SaveIndex(const char *File);

                bool ReadIndex(const char *File);
};     

#endif //__FILEINDEX_H__


--- NEW FILE: Receiver.c ---
/*
 * Media Player plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: Receiver.c,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */

#include "Receiver.h"

#include <sys/time.h>

#include <vdr/channels.h>
#include <vdr/device.h>
#include <vdr/remux.h>
#include <vdr/ringbuffer.h>

//#define RECEIVER_DEB(out...) {printf("RECIEVER[%04d]:",(int)(getTimeMillis() % 10000));printf(out);}

#ifndef RECEIVER_DEB
#define RECEIVER_DEB(out...)
#endif

#define BUFFER_SIZE 1024*1024

static inline uint64_t getTimeMillis(void) {
        struct timeval tv;
        gettimeofday(&tv,NULL);
        return (int64_t)tv.tv_sec * 1000 + tv.tv_usec / 1000;
}

cSoftplayReceiver::cSoftplayReceiver(const cChannel *Channel, cDevice *Device,
                PacketHandlesV100 &SoftHandles) 
        : cReceiver(Channel->Ca(),0,Channel->Vpid()),startChannel(*Channel),
          currChannel(*Channel) {
                RECEIVER_DEB("cSoftplayReceiver");
                device=Device;
                softHandles=SoftHandles;
                buffer = new cRingBufferLinear(BUFFER_SIZE,TS_SIZE*2);

                remux = new cRemux(Channel->Vpid(), NULL, NULL, NULL,true);
                active=false;
        };

cSoftplayReceiver::~cSoftplayReceiver() {
        RECEIVER_DEB("~cSoftplayReceiver");
        if (active) {
                active = false;
                Cancel(3);
        };
        
        Detach();
        delete buffer;
        delete remux;
};


void cSoftplayReceiver::Activate(bool On) {
        RECEIVER_DEB("Activate %d\n",On);
        if (On) {
                Start();
                StartTransfer();
        } else if ( active ) {
                StopTransfer();
                active =false;
                Cancel(3);
        };
};


void cSoftplayReceiver::Receive(uchar *Data, int Length) {
        //RECEIVER_DEB("Receive data: %p, length %d transfer %d\n",
        //                Data,Length,transfer);
        if (!transfer)
                return;

        int ret = buffer->Put(Data, Length);
        if (ret != Length) {
                RECEIVER_DEB("buffer overflow in Receive ret=%d!\n",ret);
                fprintf(stderr,"buffer overflow in Receive!\n");
        };
};

void cSoftplayReceiver::Action() {
        uchar *pes=NULL;
        RECEIVER_DEB("cSoftplayReceiver thread started!\n");

        active = true;
        while (active) {
                int length;
                if ( buffer->Available() > 9 * BUFFER_SIZE/10 ) {
                        printf("clearing receiver buffers!!\n");
                        buffer->Clear();
                        remux->Clear();
                        softHandles.ResetDecoder(device,SOFTDEVICE_VIDEO_STREAM,0);
                };
        
                if (!transfer ) {
                        RECEIVER_DEB("Transfer stopped, waiting!!\n");
                        buffer->Clear();
                        remux->Clear();
                        softHandles.ResetDecoder(device,SOFTDEVICE_VIDEO_STREAM,0);
                        transfer_stopped=true;
                        while ( !transfer && active )
                                usleep(10000);
                        buffer->Clear();
                        transfer_stopped=false;
                        RECEIVER_DEB("Transfer restarted!!\n");
                };
                uchar *data=buffer->Get(length);
                if (!data) {
                        // no data in buffer
                        usleep(10000);
                        continue;
                };


                RECEIVER_DEB("got %d bytes from buffer\n",length);
                length=remux->Put(data,length);
                RECEIVER_DEB("put %d bytes into remux\n",length);
                if (length)
                        buffer->Del(length);
                
                pes=remux->Get(length);
                if (!pes) 
                        continue;
                RECEIVER_DEB("got %d (%p) from remuxer\n",length,data);

                int count=0;
                while (softHandles.BufferFill(device,SOFTDEVICE_VIDEO_STREAM,0) > 90  
                                && count < 10 ) {
                        usleep(10000);
                        count++;
                };
                if ( count > 9) {
                        printf("Poll timeout. Reset decoder!\n");
                        softHandles.ResetDecoder(device,SOFTDEVICE_VIDEO_STREAM,0);
                };
                
                int played = device->PlayPes(pes,length,true);
                RECEIVER_DEB("played %d\n",played);

                if ( played > 0 ) {
                       remux->Del(played);
                       if (length <= 0)
                               pes=NULL;
                } else  {
                        printf("PlayPes error: %d\n",played);
                        device->PlayPes(NULL,0,true);
                        usleep(10000);
                };
        };
        RECEIVER_DEB("cSoftplayReceiver thread ended!\n");
};

                
        

--- NEW FILE: Receiver.h ---
/*
 * Media Player plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: Receiver.h,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */
#ifndef __RECEIVER_H__
#define __RECEIVER_H__

#include "vdr/receiver.h"
#include "vdr/thread.h"
#include "vdr/device.h"
#include "vdr/remux.h"
#include "SoftHandles.h"
//#include "../softdevice/softdevice.h"

class cSoftplayReceiver : public cReceiver, public cThread {
        private: 
                friend class cSoftPlayer;
                cRingBufferLinear *buffer;
                cDevice *device;
                cRemux *remux;
                PacketHandlesV100 softHandles;

                bool active;

                bool transfer,transfer_stopped;
                cChannel startChannel;
                cChannel currChannel;
        public:
                cSoftplayReceiver( const cChannel *Channel, cDevice *Device,
                                PacketHandlesV100 &SoftHandles);
                virtual ~cSoftplayReceiver();
                
        protected:
                virtual void Activate(bool On);
                virtual void Receive(uchar *Data, int Length);
                virtual void Action(void);

        public:
                inline void StopTransfer() {
                      transfer=false;
                      while (!transfer_stopped)
                              usleep(10000);
                };

                inline void StartTransfer() {
                        transfer=true;
                };
                
};

#endif // __RECEIVER_H_

--- NEW FILE: Setup.c ---
/*
 * softplay.c: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: Setup.c,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */

#include "Setup.h"

#define SETUPDBG(out...) {printf("[Setup-Softplay] ");printf(out);}

#ifndef SETUPDBG
#define SETUPDBG(out...)
#endif

static inline int clamp (int min, int val, int max)
{
  if (val < min)
    return min;
  if (val > max)
    return max;
  return val;
}

//-- cSetup ------------------------------------------------------------

cSoftplaySetup SoftplaySetup;

void cSoftplaySetup::Store() {
        if (!plugin) {
                printf("[Setup-Softplay] can't save values, no plugin!\n");
                return;
        };
        
        plugin->SetupStore ("UseReceiver", receiver);
        plugin->SetupStore ("UseFileIndex", fileIndex);
	plugin->SetupStore ("LastBrowsedDir", lastDir);
	plugin->SetupStore ("openLastDir", openLastDir);
};        

bool cSoftplaySetup::Parse( const char *Name, const char *Value) {
        if ( !Value || !Name )
                return false;
        
        if ( strcasecmp(Name,"UseReceiver") == 0 ) {
                receiver=clamp( 0, atoi(Value), 1 );
                SETUPDBG("set live-TV while audio to %d\n",receiver);
                return true;
        } else if ( strcasecmp(Name,"UseFileIndex") == 0 ) {
                fileIndex=clamp(0, atoi(Value), 1 );
                SETUPDBG("set use file index to %d\n",fileIndex);
                return true;
        } else if ( strcasecmp(Name,"LastBrowsedDir") == 0) {
		strncpy(lastDir,Value,sizeof(lastDir));
		SETUPDBG("set lastDir to '%s'\n",lastDir);
		return true;
	} else if ( strcasecmp(Name,"openLastDir") == 0) {
		openLastDir=clamp(0,atoi(Value), 1);
                SETUPDBG("set openLastDir to %d\n",openLastDir);
		return true;
        } else if ( strcasecmp(Name,"returnToLiveTV") == 0) {
		returnToLiveTV=clamp(0,atoi(Value), 1);
                SETUPDBG("set returnToLiveTV to %d\n",returnToLiveTV);
		return true;
	} else return false;
};
                
//-- cSoftplaySetupMenu-------------------------------------------------

cSoftplaySetupMenu::cSoftplaySetupMenu( cPlugin *plugin, cSoftplaySetup *Data ) 
        : data(Data), origData(*Data) 
{ 
        SetPlugin(plugin);
          
        Add(new cMenuEditBoolItem(tr("Use Fileindex"),
                            (int*)&data->fileIndex, tr("no"), tr("yes")));

        Add(new cMenuEditBoolItem(tr("Watch live TV while audio replay"),
                            (int*)&data->receiver, tr("no"), tr("yes")));

        Add(new cMenuEditBoolItem(tr("Remember last directory"),
                            (int*)&data->openLastDir, tr("no"), tr("yes")));

        Add(new cMenuEditBoolItem(tr("return to live TV after replay"),
                            (int*)&data->returnToLiveTV, tr("no"), tr("yes")));

};

eOSState cSoftplaySetupMenu::ProcessKey(eKeys Key) {
        eOSState state = cOsdMenu::ProcessKey(Key);

        if ( state != osUnknown )
                return state;
        
        if ( Key == kOk ) {
                data->Store();
                state = osBack;
                return state;
        } else if ( Key == kBack ) {
                // restore all changed settings
                *data = origData;
                state = osBack;
                return state;
        }
        return state;
}


--- NEW FILE: Setup.h ---
/*
 * softplay.c: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: Setup.h,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */

#ifndef __SETUP_H__
#define __SETUP_H__

#include "vdr/menuitems.h"
#include "vdr/plugin.h"

class cSoftplaySetup {
        friend class cSoftplaySetupMenu;
        
        private:
                cPlugin *plugin;
                
                int receiver;
                int fileIndex;
		char lastDir[120];
		int openLastDir;
                int returnToLiveTV;
        public:
                cSoftplaySetup() 
                {};
                ~cSoftplaySetup()
                {};
                
                inline void SetPlugin(cPlugin *Plugin) {
                        plugin=Plugin;
                };

		inline void SetLastDir( const char * Dir ) {
			strncpy(lastDir,Dir,sizeof(lastDir));
		};

		inline const char *GetLastDir() {
			return lastDir;
		};			

                inline bool UseReceiver() {
                        return receiver;
                };
                
                inline bool UseFileIndex() {
                        return fileIndex;
                };

		inline bool OpenLastDir() {
			return openLastDir;
		};

                inline bool ReturnToLiveTV() {
                        return returnToLiveTV;
                };

                void Store( void );

                bool Parse( const char *Name, const char *Value);

};

extern cSoftplaySetup SoftplaySetup;

class cSoftplaySetupMenu: public cMenuSetupPage {
        private :
                cSoftplaySetup *data;
                cSoftplaySetup origData;
                
        public:
                cSoftplaySetupMenu( cPlugin *plugin, cSoftplaySetup *Data ) ; 
                
                ~cSoftplaySetupMenu()
                {};

        protected:
                virtual eOSState ProcessKey(eKeys Key);
                
                virtual void Store( void ) {
                        if (data)
                                data->Store();
                };
};
                
#endif //__SETUP_H__

--- NEW FILE: SoftHandles.h ---
/*
 * Media Player plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: SoftHandles.h,v 1.1 2006/03/12 20:23:23 wachm Exp $
 */

#ifndef __SOFTHANDLES_H
#define __SOFTHANDLES_H

#include <avformat.h>

#if VDRVERSNUM >= 10330
#define SOFTDEVICE_VIDEO_STREAM  1
#define SOFTDEVICE_AUDIO_STREAM  2 
#define SOFTDEVICE_BOTH_STREAMS (SOFTDEVICE_VIDEO_STREAM | SOFTDEVICE_AUDIO_STREAM )
        
       typedef void (* fQueuePacket)(cDevice *Device, AVFormatContext *ic, AVPacket &pkt);

typedef int (* SoftdeviceHandle)(cDevice *Device,int Stream, int value);

typedef void (* SoftdeviceDrawStill)(cDevice *Device,
                                uint8_t *pY, uint8_t *pU, uint8_t *pV,
                                int w, int h, int yPitch, int uvPitch);

struct PacketHandlesV100{
        fQueuePacket  QueuePacket;
        SoftdeviceHandle ResetDecoder;
        SoftdeviceHandle BufferFill;
        SoftdeviceHandle Freeze;
        // value = 0 Play, value = 1 Pause
};
        

static const char *const GET_PACKET_HANDEL_IDV100="softdevice-GetPacketHandles-v1.0";

#else
#include "../softdevice/softdevice.h"
#endif


#endif

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softplay/README,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** README	8 Aug 2005 08:40:10 -0000	1.5
--- README	12 Mar 2006 20:23:22 -0000	1.6
***************
*** 60,63 ****
--- 60,69 ----
  keys):
  
+ (If you have enabled LiveTV during audio playback:
+         (1)                  (2)
+        Chan.                Chan.
+        down                  up
+ )
+        
          (4)       (5)        (6)
         Prev.    Playlist     Next
***************
*** 80,87 ****
  will start.
  To add/remove a file or directory to the current playlist use the yellow
! button, files included in the current playlist will be marked with 'P'. To
  start the playback of the current playlist press the blue button.
  
  
  TODO
  ----
--- 86,110 ----
  will start.
  To add/remove a file or directory to the current playlist use the yellow
! button, files included in the current playlist will be marked with '*'. To
  start the playback of the current playlist press the blue button.
  
+ The Setup Menu
+ ==============
+ 
+ Use Fileindex:
+  if switched to yes, sofplay uses extended information for example
+  mp3-id tags and saves the information in a separate file for easier 
+  access
  
+ Watch live TV while audio replay:
+   I guess that's self-explanatory. Nice for commercial breaks :-)
+   
+ Remember last directory:
+   opens the last browsed directory in the File Menu by default.
+   
+ Return to live TV after replay:
+   Also self-explanatory. 
+   
+   
  TODO
  ----
***************
*** 89,96 ****
  - fast forward / backward
  - selection of audio tracks for videos
! - playlist saving
! - add .m3u-playlist support
! - read ID 3 tags for playlists
  - get playtime of playlists
  
  Problems
--- 112,122 ----
  - fast forward / backward
  - selection of audio tracks for videos
! X playlist saving 
! X add .m3u-playlist support
! X read ID 3 tags for playlists (introduced file index)
  - get playtime of playlists
+ x introduce a setup menu (with option saving)
+ - playlist reading at startup
+ - add files in playlists
  
  Problems



From nobody at sheep.berlios.de  Sun Mar 12 22:27:33 2006
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 12 Mar 2006 22:27:33 +0100
Subject: [Softdevice-cvs] softplay Makefile,1.4,1.5 PlayList.c,1.12,1.13 PlayList.h,1.10,1.11 PlayListMenu.c,1.2,1.3 PlayListMenu.h,1.1,1.2 SoftPlayer.c,1.13,1.14 SoftPlayer.h,1.5,1.6 softplay.c,1.9,1.10 softplay.h,1.3,1.4
Message-ID: <200603122127.k2CLRXb02181@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv1872

Modified Files:
	Makefile PlayList.c PlayList.h PlayListMenu.c PlayListMenu.h 
	SoftPlayer.c SoftPlayer.h softplay.c softplay.h 
Log Message:
- some more files to commit



Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softplay/Makefile,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** Makefile	15 Aug 2005 09:13:39 -0000	1.4
--- Makefile	12 Mar 2006 20:28:52 -0000	1.5
***************
*** 10,14 ****
  PLUGIN = softplay
  
! #LIBFFMPEG=/home/martin/ffmpeg_cvs
  #LIBFFMPEG=/home/martin/vdr/ffmpeg-0.4.9-pre1
  LIBFFMPEG=/usr/local/include/ffmpeg/
--- 10,14 ----
  PLUGIN = softplay
  
! #LIBFFMPEG=/home/martin/vdr/ffmpeg
  #LIBFFMPEG=/home/martin/vdr/ffmpeg-0.4.9-pre1
  LIBFFMPEG=/usr/local/include/ffmpeg/
***************
*** 52,56 ****
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o PlayListMenu.o i18n.o
  
  LIBS = -lavformat -lavcodec -lz
--- 52,56 ----
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o PlayListMenu.o i18n.o FileIndex.o Receiver.o Setup.o
  
  LIBS = -lavformat -lavcodec -lz

Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** PlayList.c	15 Aug 2005 13:13:14 -0000	1.12
--- PlayList.c	12 Mar 2006 20:28:52 -0000	1.13
***************
*** 18,21 ****
--- 18,23 ----
  #include "vdr/player.h"
  
+ #include "FileIndex.h"
+ 
  #define LISTDEB(out...) {printf("LISTDEB: ");printf(out);}
  
***************
*** 255,265 ****
  };
  
  
! // ---cPlayListItem--------------------------------------------------------
! cPlayListItem::cPlayListItem(const char *Filename, const char *Name) {
!         if (Name) {
!                 SetName(Name);
!         } else name[0]=0;
  
          if (Filename) {
                  SetFilename(Filename);
--- 257,300 ----
  };
  
+ void cItemIdx::Move(int From, int To) {
+         LISTDEB("Move From %d to %d currIdx %d\n",From,To,currShuffleIdx);
+ //        for (int i=(To>From?From:To)-1; i < (To>From?To:From) +1; i++ ) 
+ //                if ( i > 0 && i <  nIdx )
+ //                        LISTDEB("Item %d '%s'\n",i,Idx[i].Item->GetFilename());
  
!         if ( From == To )
!                 return;
!         
! 	if ( From >= 0 && From <  nIdx
!              && To >= 0 && To <  nIdx ) {
!                 sIdx dummy=Idx[From];
!                 if ( From < To ) {
!                         memmove(&Idx[From],&Idx[From+1],
!                                         sizeof(Idx[To])*(To-From));
!                         if ( currShuffleIdx == From)
!                                 currShuffleIdx = To;
!                         else if ( currShuffleIdx > From && 
!                                         currShuffleIdx <= To )
!                                 currShuffleIdx--;
!                 } else {
!                         memmove(&Idx[To+1],&Idx[To],
!                                         sizeof(Idx[To])*(From-To));
!                         if ( currShuffleIdx == From )
!                                 currShuffleIdx = To;
!                         else if ( currShuffleIdx >= To && 
!                                         currShuffleIdx < From )
!                                 currShuffleIdx++;
!                 };
!                 Idx[To]=dummy;
!         };
!         LISTDEB("After Move From %d to %d currIdx %d\n",From,To,currShuffleIdx);
!         for (int i=(To>From?From:To)-1; i < (To>From?To:From) +2; i++ ) 
!                 if ( i >= 0 && i <  nIdx )
!                         LISTDEB("Item %d '%s'\n",i,Idx[i].Item->GetFilename());
! };
  
+ 
+ // ---cPlayListItem--------------------------------------------------------
+ cPlayListItem::cPlayListItem(const char *Filename) {
          if (Filename) {
                  SetFilename(Filename);
***************
*** 281,291 ****
  };
  
  
  void cPlayListItem::BuildIdx(cItemIdx *ShuffleIdx) {
  };
  
! const char *cPlayListItem::ParseTypeFilenameName(const char *pos, 
!                 char *Type, char *Filename, char *Name) {
          int len;
          // read entry type
          if ( sscanf(pos,"%20[^:]:%n",Type,&len) == 0 ) {
--- 316,336 ----
  };
  
+ void cPlayListItem::RemoveSelfFromList() {
+         if (next) 
+                 next->previous=previous;
+         if (previous)
+                 previous->next=next;
+ };
+ 
  
  void cPlayListItem::BuildIdx(cItemIdx *ShuffleIdx) {
  };
  
! const char *cPlayListItem::ParseTypeFilename(const char *pos, 
!                 char *Type, char *Filename) {
          int len;
+ 	if (!*pos)
+ 		return NULL;
+ 
          // read entry type
          if ( sscanf(pos,"%20[^:]:%n",Type,&len) == 0 ) {
***************
*** 295,343 ****
          pos = &pos[len];
  
!         //skip whitespaces
!         while (pos[0] && pos[0]==' ')
!                 pos++;
          // read file name (should be always present)
!         if ( !strncmp(pos,"\"\",",3) ) {
!                 filename[0]=0;
!                 len=3;
!         } else if ( sscanf(pos,"\"%" TO_STRING(STR_LENGTH) 
!                                 "[^\"]\",%n",Filename,&len) == 0 ) {
                  LISTDEB("Could not parse filename at pos \"%s\". Ignoring.\n",pos);
                  return NULL;
          };
-         pos = &pos[len];
- 
-         // skip whitespaces
-         while (pos[0] && pos[0]==' ')
-                 pos++;
- 
-         // read name (should be always present)
-         if ( !strncmp(pos,"\"\",",3) ) {
-                 name[0]=0;
-                 len=3;
-         } else if ( sscanf(pos,"\"%" TO_STRING(SHORT_STR) 
-                                 "[^\"]\",%n",Name,&len) == 0 ) {
-                 LISTDEB("Could not parse name at pos \"%s\". Ignoring.\n",pos);
-                 return NULL;
-         };
-         pos = &pos[len];
  
          return pos;
  };
-  
- //-----cPlayListRegular-----------------------------------------------------
  
! void cPlayListRegular::Save(FILE *out) {
  	fprintf(out,"File: ");
          fprintf(out,"\"%s\",",GetFilename());
-         fprintf(out,"\"%s\",",GetName());
-         fprintf(out,"\n");
  };
! 
  // -----cPlayList------------------------------------------------------------
! cPlayList::cPlayList(const char *Filename, const char *Name,
!                 cItemIdx *ShuffleIdx) 
!                 : cPlayListItem(Filename,(Name ? Name : tr("Playlist 1"))) {
          first=NULL;
          last=NULL;
--- 340,363 ----
          pos = &pos[len];
  
! 
!         skipSpaces(pos);
          // read file name (should be always present)
!         if ( !(pos = ReadQuotedString(Filename,pos) ) ) {
                  LISTDEB("Could not parse filename at pos \"%s\". Ignoring.\n",pos);
                  return NULL;
          };
  
+ 	nextField(pos);
          return pos;
  };
  
! void cPlayListItem::Save(FILE *out) {
  	fprintf(out,"File: ");
          fprintf(out,"\"%s\",",GetFilename());
  };
! 	
  // -----cPlayList------------------------------------------------------------
! cPlayList::cPlayList(const char *Filename, cItemIdx *ShuffleIdx) 
!                 : cPlayListItem( (Filename? Filename : tr("Playlist 1")) ) {
          first=NULL;
          last=NULL;
***************
*** 365,382 ****
  bool cPlayList::RemoveItemFromList(cPlayListItem *Item) {
          LISTDEB("RemoveItemFromList %p, first %p last %p\n",Item,first,last);
! 	
!         // is it the first or the last item?
          if (first && Item == first)
!                 first = first->next;
          if (last && Item == last) 
!                 last = last->previous;
  	// remove from list
!         if (Item->next) 
!                 Item->next->previous=Item->previous;
!         if (Item->previous) 
!                 Item->previous->next=Item->next;
!         Item->previous=NULL;
!         Item->next=NULL;
!         delete Item;
  	return true;
  };
--- 385,398 ----
  bool cPlayList::RemoveItemFromList(cPlayListItem *Item) {
          LISTDEB("RemoveItemFromList %p, first %p last %p\n",Item,first,last);
! 
! 	// is it the first or the last item?
          if (first && Item == first)
!                 first = first->GetNext();
          if (last && Item == last) 
!                 last = last->GetPrev();
  	// remove from list
!         Item->RemoveSelfFromList();
! 	delete Item;
! 
  	return true;
  };
***************
*** 387,393 ****
                  first = last = Item;
          } else {
!                 last->next = Item;
!                 Item->previous = last;
!                 Item->next = NULL;
                  last = Item;
          };
--- 403,407 ----
                  first = last = Item;
          } else {
!                 Item->InsertSelfIntoList(NULL,last);
                  last = Item;
          };
***************
*** 412,418 ****
  };
  
! bool cPlayList::AddFile(char * filename, char *title) {
          LISTDEB("AddFile %s\n",filename);
!         cPlayListItem *Item= new cPlayListRegular(filename,title);
          LISTDEB("Item created %p\n",Item);
          AddItemAtEnd(Item);
--- 426,432 ----
  };
  
! bool cPlayList::AddFile(char * filename) {
          LISTDEB("AddFile %s\n",filename);
!         cPlayListItem *Item= new cPlayListItem(filename);
          LISTDEB("Item created %p\n",Item);
          AddItemAtEnd(Item);
***************
*** 422,428 ****
  };
  
! bool cPlayList::AddDir(char * dirname, char * title, bool recursive) {
          LISTDEB("AddDir %s\n",dirname);
!         cPlayList *Item= new cPlayList(dirname,title,shuffleIdx);
          Item->ScanDir(dirname,recursive);
          AddItemAtEnd(Item);
--- 436,442 ----
  };
  
! bool cPlayList::AddDir(char * dirname, bool recursive) {
          LISTDEB("AddDir %s\n",dirname);
!         cPlayList *Item= new cPlayList(dirname,shuffleIdx);
          Item->ScanDir(dirname,recursive);
          AddItemAtEnd(Item);
***************
*** 431,438 ****
  };
  
! bool cPlayList::AddM3U(char * Filename, char * title) {
          LISTDEB("AddM3U %s\n",Filename);
!         cPlayList *Item= new cPlayList(Filename,title,shuffleIdx);
!         Item->LoadM3U(Filename,title);
          AddItemAtEnd(Item);
  
--- 445,452 ----
  };
  
! bool cPlayList::AddM3U(char * Filename) {
          LISTDEB("AddM3U %s\n",Filename);
!         cPlayList *Item= new cPlayList(Filename,shuffleIdx);
!         Item->LoadM3U(Filename);
          AddItemAtEnd(Item);
  
***************
*** 466,471 ****
--- 480,492 ----
  
          options=Options;
+         SetFilename(Options.name);
  };
  
+ void cPlayList::GetOptions( sPlayListOptions &Options) {
+         Options=options;
+         strncpy(Options.name,GetFilename(),40);
+         Options.name[40-1]=0;
+ };
+         
  bool cPlayList::ScanDir(char * dirname, bool recursive) {
          struct dirent **namelist;
***************
*** 506,511 ****
  
                  if (namelist[i]->d_type == DT_DIR && recursive )  
!                         ret=AddDir(Name,namelist[i]->d_name,recursive);
!                 else  ret=AddFile(Name,namelist[i]->d_name);
  
                  free(namelist[i]);	  
--- 527,532 ----
  
                  if (namelist[i]->d_type == DT_DIR && recursive )  
!                         ret=AddDir(Name,recursive);
!                 else  ret=AddFile(Name);
  
                  free(namelist[i]);	  
***************
*** 515,537 ****
  };
  
- 
  void cPlayList::Save(FILE *out) {
          cPlayListItem *Item;
          
          fprintf(out,"Start_List: ");
!         fprintf(out,"\"%s\",",filename);
!         fprintf(out,"\"%s\",",name);
          fprintf(out,"\n");
          
          Item=first;
          while (Item) {
!                 Item->Save(out);
!                 Item=Item->next;
          };
  
          fprintf(out,"End_List: ");
!         fprintf(out,"\"%s\",",filename);
!         fprintf(out,"\"%s\",",name);
!         fprintf(out,"\n");
  };
          
--- 536,555 ----
  };
  
  void cPlayList::Save(FILE *out) {
          cPlayListItem *Item;
          
          fprintf(out,"Start_List: ");
!         fprintf(out,"\"%s\",",GetFilename());
          fprintf(out,"\n");
          
          Item=first;
          while (Item) {
!                 Item->Save(out);fprintf(out,"\n");
!                 Item=Item->GetNext();
          };
  
          fprintf(out,"End_List: ");
!         fprintf(out,"\"%s\",",GetFilename());
!         //fprintf(out,"\n");
  };
          
***************
*** 542,549 ****
          char Type[STR_LENGTH];
          char Filename[STR_LENGTH];
-         char Name[SHORT_STR];
         
          if (StartLine) {
!                 if ( !(pos=ParseTypeFilenameName(StartLine,Type,Filename,Name)) ) {
                          LISTDEB("Could not parse Startline. Returning. \n");
                          return -1;
--- 560,566 ----
          char Type[STR_LENGTH];
          char Filename[STR_LENGTH];
         
          if (StartLine) {
!                 if ( !(pos=ParseTypeFilename(StartLine,Type,Filename)) ) {
                          LISTDEB("Could not parse Startline. Returning. \n");
                          return -1;
***************
*** 555,559 ****
                  };
                  
-                 SetName(Name);
                  SetFilename(Filename);
          };              
--- 572,575 ----
***************
*** 562,574 ****
                  chomp(line);
  
!                 LISTDEB("read line %s \n",line); 
  
!                 if ( !(pos=ParseTypeFilenameName(line,Type,Filename,Name)) )
                          continue;
                         
!                 LISTDEB("filename \"%s\" name \"%s\" \n",Filename,Name); 
                  if ( !strcmp(Type,"Start_List") ) {
                          LISTDEB("Found start of list\n");
!                         cPlayList *Item = new cPlayList(Filename,Name,shuffleIdx);
                          if ( Item->Load(in,line)<0 )
                                  return -1;
--- 578,590 ----
                  chomp(line);
  
!                 LISTDEB("read line '%s' \n",line); 
  
!                 if ( !(pos=ParseTypeFilename(line,Type,Filename)) )
                          continue;
                         
!                 LISTDEB("filename \"%s\"\n",Filename); 
                  if ( !strcmp(Type,"Start_List") ) {
                          LISTDEB("Found start of list\n");
!                         cPlayList *Item = new cPlayList(Filename,shuffleIdx);
                          if ( Item->Load(in,line)<0 )
                                  return -1;
***************
*** 577,582 ****
                  } else if ( !strcmp(Type,"End_List") ) {
                          LISTDEB("Found end of list \n");
!                         if ( strcmp(Filename,GetFilename()) ||
!                                         strcmp(Name,GetName()) ) {
                                  LISTDEB("End of list doesn't match! Returning!\n");
                                  return -1; 
--- 593,597 ----
                  } else if ( !strcmp(Type,"End_List") ) {
                          LISTDEB("Found end of list \n");
!                         if ( strcmp(Filename,GetFilename()) ) { 
                                  LISTDEB("End of list doesn't match! Returning!\n");
                                  return -1; 
***************
*** 585,590 ****
                  } else if ( !strcmp(Type,"File") ) {
                          LISTDEB("Found file \n");
!                         cPlayListItem *Item = new cPlayListRegular(Filename,Name);
!                         Item->ParseSaveLine(line);
                          AddItemAtEnd(Item);
                  } else {
--- 600,605 ----
                  } else if ( !strcmp(Type,"File") ) {
                          LISTDEB("Found file \n");
!                         cPlayListItem *Item = new cPlayListItem(Filename);
!                         Item->ParseSaveLine(pos);
                          AddItemAtEnd(Item);
                  } else {
***************
*** 595,603 ****
  };
  
! int cPlayList::LoadM3U(const char *Filename, const char *Name) {
          FILE *list;
!         char line[500];
          char dir[STR_LENGTH];
!         LISTDEB("LoadM3U: %s\n",Filename);
          
          list = fopen( Filename, "r");
--- 610,621 ----
  };
  
! int cPlayList::LoadM3U(const char *Filename) {
          FILE *list;
!         char line[2][500];
          char dir[STR_LENGTH];
! 	int swapLine=0;
! 	line[0][0]=line[1][0]=0;
! 	
! 	LISTDEB("LoadM3U: %s\n",Filename);
          
          list = fopen( Filename, "r");
***************
*** 608,612 ****
          };
          
-         SetName(Name);
          SetFilename(Filename);
          char *ncopy=rindex(Filename,'/');
--- 626,629 ----
***************
*** 620,653 ****
          LISTDEB("dir: %s\n",dir);
  
!         while ( !feof(list)  && fgets(line,500,list) ) {
!                 chomp(line);
!                 printf("read line \"%s\"\n",line);
!                 if (line[0]=='#')
                          continue;
  
-                 // poor man's windows to linux filename transformation
-                 char *pos=line;
-                 while ( (pos=index(pos,'\\')) )
-                         *pos='/';
-     
-                 ncopy=line;
-                 // don't copy leading "./"
-                 if (ncopy[0]=='.' && ncopy[1]=='/')
-                         ncopy+=2;
-                 
-                 char ItemName[SHORT_STR];
                  char ItemFile[STR_LENGTH];
!                 snprintf(ItemFile,STR_LENGTH,"%s/%s",dir,ncopy);
  
!                 // strip off all directories to extract the name
!                 ncopy = rindex(line,'/');
!                 if (!ncopy)
!                         ncopy=line;
!                 else ncopy++;
!                 snprintf(ItemName,SHORT_STR,"%s",ncopy);
!                 printf("Name %s \n",ncopy);
                  
!                 cPlayListItem *Item = new cPlayListRegular(ItemFile,ItemName);
!                 AddItemAtEnd(Item);
          };
  
--- 637,684 ----
          LISTDEB("dir: %s\n",dir);
  
! 	
!         while ( fgets(line[swapLine],500,list) ) {
!                 chomp(line[swapLine]);
!                 LISTDEB("read line \"%s\"\n",line[swapLine]);
!                 char *pos=line[swapLine];
!                 
!                 
! 		//skip leading white spaces
! 		skipSpaces((const char *) pos);
! 
! 		if ( *pos=='#' ) {
! 			// either a comment or EXTINF
! 			swapLine=!swapLine;
                          continue;
+ 		};
  
                  char ItemFile[STR_LENGTH];
!                 if ( IsStream(pos) ) {
!                         snprintf(ItemFile,STR_LENGTH,"%s",pos);
!                 } else {
!                         // regular file
!                         // poor man's windows to linux filename transformation
!                         char *tmp=pos;
!                         while ( (tmp=index(tmp,'\\')) )
!                                 *tmp='/';
  
!                         // don't copy leading "./"
!                         if (pos[0]=='.' && pos[1]=='/')
!                                 pos+=2;
! 
!                         snprintf(ItemFile,STR_LENGTH,"%s/%s",dir,pos);
!                 };
                  
! 		// check for extinfos...
! 		char *extInfoPos=line[!swapLine];
! 		skipSpaces((const char *)extInfoPos);
! 		if ( *extInfoPos=='#' && FileIndex ) {
! 			cIndex *Idx=FileIndex->GetOrAddIndex(ItemFile);
! 			if (Idx)
! 				Idx->ParseM3uExtInf(extInfoPos);
! 		};
! 
!                 AddItemAtEnd(new cPlayListItem(ItemFile));
! 		swapLine=!swapLine;
          };
  

Index: PlayList.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** PlayList.h	15 Aug 2005 13:13:14 -0000	1.10
--- PlayList.h	12 Mar 2006 20:28:52 -0000	1.11
***************
*** 63,78 ****
  
                  void Shuffle();
  };      
  
  class cPlayListItem {
-         friend class cPlayList;
          private:
!                 char name[SHORT_STR];
                  char filename[STR_LENGTH];
          protected:
                  cPlayListItem *next;
                  cPlayListItem *previous;
          public:
!                 cPlayListItem(const char *Filename=NULL, const char *Name=NULL);
                  virtual ~cPlayListItem();
  
--- 63,87 ----
  
                  void Shuffle();
+ 
+                 void Move(int From, int To);
  };      
  
  class cPlayListItem {
          private:
! 		char *namePos;
                  char filename[STR_LENGTH];
          protected:
                  cPlayListItem *next;
                  cPlayListItem *previous;
+       
          public:
!                 inline cPlayListItem *GetNext()
!                 {return next;};
! 
!                 inline cPlayListItem *GetPrev()
!                 {return previous;};
! 
!         public:
!                 cPlayListItem(const char *Filename=NULL);
                  virtual ~cPlayListItem();
  
***************
*** 80,97 ****
                                  cPlayListItem *previous);
  
!                 inline char * GetName()
!                 { return name; };
   
!                 inline char * GetFilename()
                  { return filename; };
  
-         protected:
-                 inline void SetName(const char *Name) {
-                         strncpy(name,Name,SHORT_STR);
-                         name[SHORT_STR-1]=0;
-                 };
                  inline void SetFilename(const char *Filename) {
                          strncpy(filename,Filename,STR_LENGTH);
                          filename[STR_LENGTH-1]=0;
                  };
  
--- 89,107 ----
                                  cPlayListItem *previous);
  
!                 void RemoveSelfFromList();
! 
!                 inline const char * GetName()
!                 { return namePos; };
   
!                 inline const char * GetFilename()
                  { return filename; };
  
                  inline void SetFilename(const char *Filename) {
                          strncpy(filename,Filename,STR_LENGTH);
                          filename[STR_LENGTH-1]=0;
+ 			namePos=rindex(filename,'/');
+ 			if (namePos)
+                                 namePos++;
+                         else namePos=filename;
                  };
  
***************
*** 99,167 ****
                  virtual void BuildIdx(cItemIdx *shuffleIdx);
                          
!                 inline cPlayListItem *GetNext()
!                 {return next;};
! 
!                 inline cPlayListItem *GetPrev()
!                 {return previous;};
! 
! 		virtual void Save(FILE *out)
! 		{};
  
                  virtual void ParseSaveLine(const char *Line)
                  {};
-         protected:
-                 const char *ParseTypeFilenameName(const char *Str, 
-                                 char *Type, char *Filename, char *Name);
- };
- 
- class cPlayListRegular: public cPlayListItem {
-         private:
-                 char title[STR_LENGTH];
-                 char album[STR_LENGTH];
-                 char author[STR_LENGTH];
- 
-                 int duration;
-         public:
-                 cPlayListRegular(char *Filename,  char *Name) :
-                         cPlayListItem(Filename,Name) {};
-                 virtual ~cPlayListRegular() {};
- 
- 		virtual void Save(FILE *out);
- 
-                 virtual void ParseSaveLine(const char *Line){};
- 
-                 inline char *GetTitle() 
-                 { return title; };
- 
-                 inline void SetTitle( const char *const Title) { 
-                         strncpy(title,Title,STR_LENGTH);
-                         title[STR_LENGTH-1]=0;
-                 };
- 
-                 inline char *GetAlbum()
-                 { return album; };
- 
-                 inline void SetAlbum( const char *const Album) {
-                         strncpy(album,Album,STR_LENGTH);
-                         album[STR_LENGTH-1]=0;
-                 };
  
-                 inline char *GetAuthor()
-                 { return author; };
  
!                 inline void SetAuthor( const char *const Author) {
!                         strncpy(author,Author,STR_LENGTH);
!                         author[STR_LENGTH-1]=0;
!                 };
! 
!                 inline int GetDuration()
!                 { return duration; };
  
!                 inline void SetDuration(int Duration) {
!                         duration=Duration;
!                 };
! }; 
  
  struct sPlayListOptions {
  	int shuffle;
  	int autoRepeat;
--- 109,126 ----
                  virtual void BuildIdx(cItemIdx *shuffleIdx);
                          
!  		virtual void Save(FILE *out);
  
                  virtual void ParseSaveLine(const char *Line)
                  {};
  
  
!         protected:
!                 const char *ParseTypeFilename(const char *Str, 
!                                 char *Type, char *Filename);
  
! };
  
  struct sPlayListOptions {
+         char name[40];
  	int shuffle;
  	int autoRepeat;
***************
*** 177,182 ****
    public:
          sPlayListOptions options;
!         cPlayList(const char *Filename=NULL, const char *Name=NULL,
!                         cItemIdx *shuffleIdx=NULL);
    private:
  	cPlayList(const cPlayList &List) {};
--- 136,140 ----
    public:
          sPlayListOptions options;
!         cPlayList(const char *Filename=NULL,cItemIdx *shuffleIdx=NULL);
    private:
  	cPlayList(const cPlayList &List) {};
***************
*** 191,196 ****
          void PrepareForPlayback();
  	void SetOptions(sPlayListOptions &Options);
! 	void GetOptions(sPlayListOptions &Options)
! 	{ Options=options; };
          
    private:
--- 149,153 ----
          void PrepareForPlayback();
  	void SetOptions(sPlayListOptions &Options);
! 	void GetOptions(sPlayListOptions &Options);
          
    private:
***************
*** 209,215 ****
  	{ return first; };
  
!         bool AddFile(char * Filename,char *Title = NULL);
!         bool AddDir(char * dirname,char *Title = NULL, bool recursive = true);
!         bool AddM3U(char * Filename,char *Title = NULL);
  
          virtual void Save(FILE *out);
--- 166,172 ----
  	{ return first; };
  
!         bool AddFile(char * Filename);
!         bool AddDir(char * dirname, bool recursive = true);
!         bool AddM3U(char * Filename);
  
          virtual void Save(FILE *out);
***************
*** 218,224 ****
          bool ScanDir(char * dirname, bool recursive = true);
          
!         int LoadM3U(const char *Filename, const char *Name);
  
!         // interface to cItemIdx        
  	inline bool IsDirty()
  	{ return shuffleIdx ? shuffleIdx->reshuffled : 0; };
--- 175,183 ----
          bool ScanDir(char * dirname, bool recursive = true);
          
!         int LoadM3U(const char *Filename);
  
!         // interface to cItemIdx    
!         cItemIdx *GetShuffleIdx() 
!         { return shuffleIdx; };
  	inline bool IsDirty()
  	{ return shuffleIdx ? shuffleIdx->reshuffled : 0; };
***************
*** 229,234 ****
          inline int GetCurrIdx()
  	{ return shuffleIdx ? shuffleIdx->currShuffleIdx : -1; };
!         inline void SetCurrShuffleIdx(int Idx)
  	{ if (shuffleIdx) shuffleIdx->currShuffleIdx = Idx; };
  
  	inline int GetNIdx()
--- 188,196 ----
          inline int GetCurrIdx()
  	{ return shuffleIdx ? shuffleIdx->currShuffleIdx : -1; };
!         inline void SetCurrIdx(int Idx)
  	{ if (shuffleIdx) shuffleIdx->currShuffleIdx = Idx; };
+ 	inline cPlayListItem* GetCurrItem()
+ 	{ return shuffleIdx ? shuffleIdx->GetItemByIndex(
+                         shuffleIdx->currShuffleIdx) : NULL; };
  
  	inline int GetNIdx()
***************
*** 246,250 ****
          { return shuffleIdx ? shuffleIdx->PrevAlbumFile() : NULL; };
  	
!         inline cPlayListItem *GetShuffledItemByIndex(int Index) {   
                  return shuffleIdx ?
                          shuffleIdx->GetItemByIndex(Index) : NULL; 
--- 208,212 ----
          { return shuffleIdx ? shuffleIdx->PrevAlbumFile() : NULL; };
  	
!         inline cPlayListItem *GetItemByIndex(int Index) {   
                  return shuffleIdx ?
                          shuffleIdx->GetItemByIndex(Index) : NULL; 

Index: PlayListMenu.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayListMenu.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** PlayListMenu.c	15 Aug 2005 13:13:14 -0000	1.2
--- PlayListMenu.c	12 Mar 2006 20:28:52 -0000	1.3
***************
*** 12,15 ****
--- 12,16 ----
  
  #include "PlayListMenu.h"
+ #include "FileIndex.h"
  
  #define MENUDEB(out...) {printf("MENUDEB: ");printf(out);}
***************
*** 56,61 ****
                          }  else {
                                  // skip to current track
!                                 playList->SetCurrShuffleIdx(
!                                         playList->GetIndexByItem(Item) );
                                  state = PLAY_CURR_FILE;
                          };
--- 57,62 ----
                          }  else {
                                  // skip to current track
!                                 playList->SetCurrIdx(
!                                                 playList->GetIndexByItem(Item));
                                  state = PLAY_CURR_FILE;
                          };
***************
*** 90,97 ****
  
  // ----cReplayList------------------------------------------------------------
! cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->GetName()) {
          playList=List;
-         SetHelp(tr("Options"),tr("(Add)"),tr("Delete"),tr("Stop"));
          RebuildList();
  };
  
--- 91,105 ----
  
  // ----cReplayList------------------------------------------------------------
! cReplayList::eMode cReplayList::Mode=cReplayList::eMNormal;
! 
! cReplayList::cReplayList(cPlayList * List) 
!                 : cOsdMenu(List->GetName(),20,1,16,5) {
!         displayedCurrIdx=-1;
          playList=List;
          RebuildList();
+ 	UpdateHelp();
+         lastModeActivity=time(NULL)-600;
+         lastActivity=time(NULL)-600;
+         hold=false;
  };
  
***************
*** 99,102 ****
--- 107,149 ----
  };
  
+ void cReplayList::UpdateHelp() {
+ 	switch (Mode) {
+ 		case eMEdit:
+ 			SetHelp(tr("Mode"),tr("(Add)"),
+ 					tr("Delete"),tr("Move"));
+ 			break;
+ 		case eMNormal:
+ 			SetHelp(tr("Mode"),tr("Skip Forward"),
+ 					tr("Skip Back"),tr("Stop"));
+ 			break;
+ 		case eMOptions:
+ 			SetHelp(tr("Mode"),tr("Options"),NULL,tr("Save"));
+ 			break;
+                 default:
+                         break;
+ 	};
+         lastMode=Mode;
+ };
+ 
+ void cReplayList::PrintItemStr(char *ItemStr, int count,
+                         cPlayListItem *Item, bool hold ) {
+         cIndex *Idx=FileIndex ? 
+                 FileIndex->GetIndex(Item->GetFilename()) : NULL ;
+         char holdR = hold ? '>' : ' ';
+         char holdL = hold ? '<' : ' ';
+                
+         if ( Idx && *Idx->GetTitle() ) { 
+                 snprintf(ItemStr,100," %c%s\t\t%s\t%3d:%02d%c ",
+                                 holdR,
+                                 Idx->GetTitle(),
+                                 Idx->GetAuthor(),
+                                 Idx->GetDuration()/60,
+                                 Idx->GetDuration()%60,
+                                 holdL);
+         } else
+                 snprintf(ItemStr,count," %c%s%c ",
+                                 holdR,Item->GetName(),holdL);
+ };
+ 
  void cReplayList::RebuildList() {
          int nItems=playList->GetNIdx();
***************
*** 104,109 ****
  
          cPlayListItem * Item;
!         for (int i = 0 ; i<nItems; i++) {
! 		Item=playList->GetShuffledItemByIndex(i);
                  if (!Item) {
                          printf("Error getting all files for list index %d\n",
--- 151,156 ----
  
          cPlayListItem * Item;
!         for (int i = 0; i < nItems; i++) {
! 		Item=playList->GetItemByIndex(i);
                  if (!Item) {
                          printf("Error getting all files for list index %d\n",
***************
*** 114,119 ****
  		MENUDEB("Add item %d (%p)  %s\n",
                                  i,Item,Item->GetName());
!                 Add(new cOsdItem(Item->GetName(),
!                    osUnknown),false);
          };
          lastListItemCount = playList->GetNIdx();
--- 161,168 ----
  		MENUDEB("Add item %d (%p)  %s\n",
                                  i,Item,Item->GetName());
! 
!                 char ItemStr[100];
!                 PrintItemStr(ItemStr,100,Item);                
!                 Add(new cOsdItem(ItemStr,osUnknown),false);
          };
          lastListItemCount = playList->GetNIdx();
***************
*** 128,131 ****
--- 177,181 ----
          char Status[60];
          char Name[60];
+         cPlayListItem *Item;
          
          if (!cControl::Control() || 
***************
*** 140,165 ****
          SetStatus(Status);
  
!         if (displayedCurrIdx != playList->GetCurrIdx()){
!                 cPlayListItem *Item=playList->GetShuffledItemByIndex(
!                                 playList->GetCurrIdx());
!                 if (Item) {
!                         PrintCutDownString(Name,Item->GetName(),30);
!                         snprintf(Status,60,"%s: %s",playList->GetName(),
!                                                 Name);
!                         SetTitle(Status);
!                         Display();
!                         displayedCurrIdx=playList->GetCurrIdx();
!                 } else printf("Didn't get currShuffleIdx %d!\n",playList->GetCurrIdx());
          };
  };
  
  eOSState cReplayList::ProcessKey(eKeys Key) {
          eOSState state = cOsdMenu::ProcessKey(Key);
  
! 	// don't move cursor when it has been moved by the user
! 	// a short while ago
          if ( Key==kUp || Key==kDown || Key==kRight || Key==kLeft ) 
                  lastActivity=time(NULL);
          
          if ( lastListItemCount != playList->GetNIdx()
  	     || playList->IsDirty() ) {
--- 190,296 ----
          SetStatus(Status);
  
!         if ( displayedCurrIdx != playList->GetCurrIdx() 
!                         && ( Item=playList->GetCurrItem() ) ) {
!                 cIndex *Idx=FileIndex ? 
!                         FileIndex->GetIndex(Item->GetFilename()) : NULL ;
!                 if ( Idx && *Idx->GetTitle() ) 
!                         PrintCutDownString(Name,Idx->GetTitle(),30);
!                 else PrintCutDownString(Name,Item->GetName(),30);
!                 
!                 snprintf(Status,60,"%s: %s",playList->GetName(),
!                                 Name);
!                 SetTitle(Status);
!                 Display();
!                 displayedCurrIdx=playList->GetCurrIdx();
          };
  };
  
  eOSState cReplayList::ProcessKey(eKeys Key) {
+         int lastCurrent=Current();
          eOSState state = cOsdMenu::ProcessKey(Key);
  
! 
!         // fallback to default mode after some time of inactivity
!         if ( Key!=kNone) 
!                 lastModeActivity=time(NULL);
!        
!         if ( lastMode !=eMNormal && 
!                         time(NULL) - lastModeActivity > 40 ) {
!                 if (hold) {
!                         // break move
!                         hold=false;
!                         SetItemStr(Get(Current()),
!                                         playList->GetItemByIndex(Current()),
!                                         hold);
!                         Move(Current(),origPos);
!                         playList->GetShuffleIdx()->Move(Current(),
!                                         origPos);
!                         SetCurrent(Get(origPos));
!                         Display();
!                 };
!                Mode=eMNormal;
!         };
!  
!         // don't move cursor when it has been moved by the user
! 	// a short while ago or in move item mode
          if ( Key==kUp || Key==kDown || Key==kRight || Key==kLeft ) 
                  lastActivity=time(NULL);
+ 
+         if (Current() != playList->GetCurrIdx() && 
+                         time(NULL) - lastActivity > 40
+                         && !hold ) {
+                 MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
+                                 playList->GetCurrIdx(),time(NULL),lastActivity);
+                 SetCurrent(Get(playList->GetCurrIdx()));
+                 Display();
+         };
+        
+         // handle move item mode
+         if ( lastMode == eMEdit && hold ) {
+                 // moves
+                 if ( (Key==kUp || Key==kDown|| Key==kRight || Key==kLeft) ) {
+                         Move(lastCurrent,Current());
+                         playList->GetShuffleIdx()->Move(lastCurrent,Current()); 
+                         Display();
+                 };
+                
+                 // end move
+                 switch(Key) {
+                         case kBack:
+                         case kRed:
+                         case kGreen:
+                         case kYellow:
+                                 // break Move
+                                 hold=false;
+                                 SetItemStr(Get(Current()),
+                                                 playList->GetItemByIndex(Current()),
+                                                 hold);
+                                 Move(Current(),origPos);
+                                 playList->GetShuffleIdx()->Move(Current(),
+                                                 origPos);
+                                 SetCurrent(Get(origPos));
+                                 Display();
+ 
+                                 Key=kNone;
+                                 state= osContinue;
+                                 break;
+                         case kOk:
+                         case kBlue:
+                                 // finish move
+                                 hold=false;
+                                 SetItemStr(Get(Current()),
+                                                 playList->GetItemByIndex(Current()),
+                                                 hold);
+ 
+                                 DisplayCurrent(true);
+                                 state= osContinue;
+                                 break;
+                         default:
+                                 break;
+                 } 
          
+         };
+ 
+         // handle new items or removed items
          if ( lastListItemCount != playList->GetNIdx()
  	     || playList->IsDirty() ) {
***************
*** 169,230 ****
          };
          
-         if (Current() != playList->GetCurrIdx() && 
-                         time(NULL) - lastActivity > 12 ) {
-                 MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
-                                 playList->GetCurrIdx(),time(NULL),lastActivity);
-                 SetCurrent(Get(playList->GetCurrIdx()));
-                 Display();
-         };
  
  	if (state != osUnknown ) 
  		return state;
  
-         cPlayListItem *Item;
-         switch (Key) {
-                 case kOk:
-                         // skip to current track
-                         playList->SetCurrShuffleIdx( Current() );
-                         state = PLAY_CURR_FILE;
-                         // want to have automatic track change
-                         lastActivity=time(NULL)-300;
-                         break;
-                 case kBack:
-                         state= osBack;
-                         break;
-                 case kBlue:
-                         state= osEnd;
-                         break;
-                 case kGreen:
- 			// not yet implemented
-                         state= osContinue;
-                         break;
-                 case kRed:
-                         return AddSubMenu(new cPlOptionsMenu(playList));
-                         break;
-                 case kYellow:
-                         Item=playList->GetShuffledItemByIndex(Current());
-                         if (!Item) {
-                                 printf("No current Item %d!\n",Current());
-                                 break;
-                         };
-                         MENUDEB("Del current %d: %s\n",
-                                         Current(),
-                                         Item->GetName() );
-                         playList->RemoveItem(Item);
- 			lastListItemCount = playList->GetNIdx();
-                         Del(Current());
-                         Display();
-                         state=osContinue;
-                         break;
  
!                 default:    
!                         break;
!         }
          if (!HasSubMenu())
                  UpdateStatus();
! 		
          return state;
  }
  
  
  // ---cPlOptionsMenu-------------------------------------------------------
--- 300,422 ----
          };
          
  
  	if (state != osUnknown ) 
  		return state;
  
  
! 	switch (Key) {
! 		case kOk:
! 			// skip to current track
! 			playList->SetCurrIdx( Current() );
! 			state = PLAY_CURR_FILE;
! 			// want to have automatic track change
! 			lastActivity=time(NULL)-300;
! 			break;
! 		case kBack:
! 			state= osBack;
! 			break;
! 		default:    
! 			break;
! 	};
! 
!         if ( Key >= kRed && Key <= kBlue)
!                 state=ProcessColourKeys(Key);
!         
          if (!HasSubMenu())
                  UpdateStatus();
!         
!         if ( Mode != lastMode ) 
! 		UpdateHelp();
! 
          return state;
  }
  
+ eOSState cReplayList::ProcessColourKeys(eKeys Key) {
+         eOSState state = osUnknown;
+         
+ 	if (Key==kRed) { 
+ 		Mode=(eMode) ( ( Mode + 1 ) % eMLast );
+ 		return osContinue;
+ 	};
+ 	
+ 	switch (lastMode) {
+ 		case eMNormal:
+ 			switch(Key) {
+ 				case kGreen:
+ 					// Skip backward, pass to cControl
+ 					state= osUnknown;
+ 					break;
+ 				case kYellow:
+ 					// Skip forward, pass to cControl
+ 					state= osUnknown;
+ 					break;
+ 				case kBlue:
+                                         // end replay
+ 					state= osEnd;
+ 					break;
+                                 default:
+                                         break;
+ 			};
+ 			break;
+ 		case eMEdit:
+ 			switch(Key) {
+ 				case kGreen:
+ 					// add files TODO
+ 					state= osContinue;
+ 					break;
+ 				case kYellow:
+ 					// delete Item
+ 					MENUDEB("Del current %d: %s\n",
+                                                  Current(),
+                                                  playList->GetItemByIndex(Current())->GetName() );
+ 					playList->RemoveItem(
+ 					  playList->GetItemByIndex(Current()));
+ 					MENUDEB("Remove finished\n");
+ 					Del(Current());
+ 					Display();
+ 					state=osContinue;
+ 					break;
+ 				case kBlue:
+                                         // move files TODO
+                                         hold=true;
+                                         origPos=Current();
+                                         SetItemStr(Get(Current()),
+                                                playList->GetItemByIndex(Current()),
+                                                hold);
+                                         DisplayCurrent(true);
+ 					state= osContinue;
+ 					break;
+                                 default:
+                                         break;
+ 			};
+ 			break;
+ 		case eMOptions:
+ 			switch(Key) {
+ 				case kGreen:
+ 					// call options menu
+                                         state = AddSubMenu(
+                                                 new cPlOptionsMenu(playList));
+ 
+ 					break;
+ 				case kYellow:
+ 					// nothing
+ 					state= osContinue;
+ 					break;
+ 				case kBlue:
+                                         // save list TODO
+ 					state= osContinue;
+ 					Softplay->SaveList(playList);
+ 					break;
+                                 default:
+                                         break;
+ 			};
+ 			break;
+                 default:
+                         break;
+ 	};
+         return state;
+ };
+ 
+ 
  
  // ---cPlOptionsMenu-------------------------------------------------------
***************
*** 234,237 ****
--- 426,433 ----
          playList=PlayList;
          playList->GetOptions(playListOptions);
+ 
+         printf("playlistname '%s' \n",playListOptions.name);
+         Add(new cMenuEditStrItem(tr("Name"),playListOptions.name,40,tr(FileNameChars)));
+         
          Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
                                 &playListOptions.shuffle, tr("no"), tr("yes")));

Index: PlayListMenu.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayListMenu.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** PlayListMenu.h	15 Aug 2005 09:07:30 -0000	1.1
--- PlayListMenu.h	12 Mar 2006 20:28:52 -0000	1.2
***************
*** 16,20 ****
  class cAlbumList: public cOsdMenu {
          time_t lastActivity;
-         int displayedCurrIdx;
          cPlayList *playList;
          public:
--- 16,19 ----
***************
*** 29,38 ****
          cPlayList *playList;
  	int lastListItemCount;
          public:
          cReplayList(cPlayList * List);
          ~cReplayList();
! 	void RebuildList();
          eOSState ProcessKey(eKeys Key);
          void UpdateStatus();
  };
  
--- 28,66 ----
          cPlayList *playList;
  	int lastListItemCount;
+ 	
+ 	enum eMode {
+ 		eMNormal,
+ 		eMEdit,
+ 		eMOptions,
+                 eMLast,
+         }; 
+ 	static eMode Mode;
+ 	eMode lastMode;
+         time_t lastModeActivity;
+ 
+         bool hold;
+         int origPos;
+ 
          public:
          cReplayList(cPlayList * List);
          ~cReplayList();
! 	
!         void RebuildList();
!         
!         void PrintItemStr(char *ItemStr, int count,
!                         cPlayListItem *Item, bool hold=false);
!         
!         inline void SetItemStr(cOsdItem *OsdItem, cPlayListItem *Item,
!                         bool hold=false) {
!                 char Str[100];
!                 PrintItemStr(Str,100,Item,hold);
!                 OsdItem->SetText(Str);
!         };
!         
          eOSState ProcessKey(eKeys Key);
+         eOSState ProcessColourKeys(eKeys Key);
+         
          void UpdateStatus();
+         void UpdateHelp();
  };
  

Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** SoftPlayer.c	15 Aug 2005 13:13:14 -0000	1.13
--- SoftPlayer.c	12 Mar 2006 20:28:52 -0000	1.14
***************
*** 13,16 ****
--- 13,19 ----
  #include "softplay.h"
  #include "PlayListMenu.h"
+ #include "FileIndex.h"
+ 
+ #include "vdr/status.h"
  
  #define PLDBG(out...) { printf("PLDBG: ");printf(out);}
***************
*** 28,33 ****
[...1114 lines suppressed...]
+                          if (SoftPlayer->Receiver)
+                                  SoftPlayer->ChannelUpDown(+1);
+                          break;
+                 case k1:
+                          if (SoftPlayer->Receiver)
+                                  SoftPlayer->ChannelUpDown(-1);
+                          break;
+ 
+ 		case kBack:	
+                          Hide();
+                          OsdActive=OsdPrivMenu;
+                          privateMenu=
+                                  cMenuDirectory::OpenLastBrowsedDir();
+                          //privateMenu->Display();
+                          return osContinue;
+ 			break;
+ 
+ 			 
  		default:
  			 break;

Index: SoftPlayer.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** SoftPlayer.h	16 May 2005 19:07:54 -0000	1.5
--- SoftPlayer.h	12 Mar 2006 20:28:52 -0000	1.6
***************
*** 18,26 ****
  #include <avformat.h>
  
! #include "../softdevice/softdevice.h"
  #include "PlayList.h"
  
  class cSoftPlayer : public cPlayer, cThread {
   private:
         bool running;
         bool reading;
--- 18,28 ----
  #include <avformat.h>
  
! #include "SoftHandles.h"
  #include "PlayList.h"
+ #include "Receiver.h"
  
  class cSoftPlayer : public cPlayer, cThread {
   private:
+        friend class cSoftControl;
         bool running;
         bool reading;
***************
*** 36,45 ****
         
         int pollTimeouts;
! 	cSoftDevice *SoftDevice;
         AVFormatContext *ic;
         AVFormatParameters ap;
!    	char title[120];
!    
!        ePlayMode softPlayMode;
   public:
         cSoftPlayer();  
--- 38,57 ----
         
         int pollTimeouts;
!        cDevice *SoftDevice;
!        PacketHandlesV100 SoftHandles;
         AVFormatContext *ic;
         AVFormatParameters ap;
!        cSoftplayReceiver *Receiver;
! 
!        char curr_filename[200];
!        char title[60];
!        char author[60];
!        char album[60];
!        int duration;
!        int start_time;
!        
!        char filename[200];
!        bool newFile;
!        int Streams;
   public:
         cSoftPlayer();  
***************
*** 50,54 ****
         virtual void Action();
  
!        inline bool IsRunning() {return running;};
  	
         inline void SkipSeconds(int Skip) 
--- 62,66 ----
         virtual void Action();
  
!        inline bool IsRunning() {return reading || newFile ;};
  	
         inline void SkipSeconds(int Skip) 
***************
*** 68,73 ****
         void OpenFile(const char *filename);
         void PlayFile(const char *filename);
!        
!        ePlayMode GetPlayMode(AVFormatContext *IC); 
         
         void Stop();
--- 80,89 ----
         void OpenFile(const char *filename);
         void PlayFile(const char *filename);
!       
!        void FileReplay();
! 
!        void RemuxAndQueue( AVPacket &pkt);
! 
!        int GetPlayMode(AVFormatContext *IC); 
         
         void Stop();
***************
*** 81,91 ****
         { pause=false; new_speed=-1;new_forward=true; };
  
!        char * GetTitle(); 
         virtual bool GetIndex(int &Current, int &Total, 
          	bool SnapToIFrame = false);
         virtual bool GetReplayMode(bool &Play, bool &Forward, int &Speed)
         {Play=!pause;Forward=forward;Speed=speed;return true;};
!        int GetDuration(); 
!        int GetCurrPos();
   };
  
--- 97,138 ----
         { pause=false; new_speed=-1;new_forward=true; };
  
!        inline const char * GetTitle()
!        { return title; };
!        inline const char * GetAuthor()
!        { return author; };
!        inline const char * GetAlbum()
!        { return album; };
!        inline const char * GetFilename()
!        { return curr_filename; };
!       
!        inline int GetDuration()
!        { return duration/AV_TIME_BASE; };
!        
!        int GetCurrPos();
!        
         virtual bool GetIndex(int &Current, int &Total, 
          	bool SnapToIFrame = false);
+ 		
         virtual bool GetReplayMode(bool &Play, bool &Forward, int &Speed)
         {Play=!pause;Forward=forward;Speed=speed;return true;};
! 
!        inline bool GetPlay() 
!        { return !pause; };
! 
!        inline bool GetForward()
!        { return forward; };
! 
!        inline int GetSpeed()
!        { return speed; };
! 
!        // -- Receiver controls ----------------------------------
!        void ChannelUpDown(int i);
! 
!  protected:
!        void ResetDevice( int Streams);
!        bool PollDevice( int Streams);
!        void FlushDevice( int Streams);
!        void FreezeDevice( int Streams, bool Freeze);
! 
   };
  
***************
*** 93,96 ****
--- 140,144 ----
    private:
        cSoftPlayer *SoftPlayer;
+       cSoftplayReceiver *Receiver;
        
        cSkinDisplayReplay *displayReplay;
***************
*** 104,108 ****
        bool shouldStop;
        cPlayList *playList;
!       int32_t currTitleHash;
    public:
       cSoftControl( const char * filename );
--- 152,158 ----
        bool shouldStop;
        cPlayList *playList;
! 
!       // to notice when the next file starts
!       bool newFile; 
    public:
       cSoftControl( const char * filename );
***************
*** 112,115 ****
--- 162,166 ----
       virtual eOSState ProcessKey(eKeys Key);
       void ShowProgress();
+      void SendStatus();
  };
  

Index: softplay.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** softplay.c	15 Aug 2005 09:07:30 -0000	1.9
--- softplay.c	12 Mar 2006 20:28:52 -0000	1.10
***************
*** 8,11 ****
--- 8,13 ----
  
  
+ #include <dirent.h>
+ 
  #include "softplay.h"
  #include "SoftPlayer.h"
***************
*** 13,20 ****
  #include "PlayListMenu.h"
  #include "i18n.h"
  
- #include <dirent.h>
- 
- #define NAME_LENGTH 200
  
  static const char *VERSION        = "0.0.2";
--- 15,20 ----
  #include "PlayListMenu.h"
  #include "i18n.h"
+ #include "FileIndex.h"
  
  
  static const char *VERSION        = "0.0.2";
***************
*** 24,28 ****
  static const char *DIR_NAME ="softplay";
  
! //#define PLUGDEB(out...)     {printf("PLUGDEB: ");printf(out...);}
  
  #ifndef PLUGDEB
--- 24,28 ----
  static const char *DIR_NAME ="softplay";
  
! //#define PLUGDEB(out...)     {printf("PLUGDEB: ");printf(out);}
  
  #ifndef PLUGDEB
***************
*** 32,57 ****
  // --- cMenuDirectory -------------------------------------------
  
! class cMenuDirectory : public cOsdMenu {
! private:
!   char start_path[NAME_LENGTH];
!   struct DirEntry {
!       char name[NAME_LENGTH];
!       char title[NAME_LENGTH];
!       int type;
!   } * Entries;
!   int nEntries;
!   int keySelNo;
!   cPlayList *editList;
!   void PrintItemName(char *Name, const struct DirEntry &Entry,int i);
!   eOSState SelectEntry(int No, bool play);
!   
! public:
!   void PrepareDirectory(char * path);
!   cMenuDirectory(char * path, cPlayList *EditList=NULL);
!   virtual ~cMenuDirectory();
!   virtual eOSState ProcessKey(eKeys Key);
! };
! 
! cMenuDirectory::cMenuDirectory(char * path, cPlayList *EditList) 
          : cOsdMenu(tr("Files"),4,2,8) 
  {
--- 32,37 ----
  // --- cMenuDirectory -------------------------------------------
  
! cMenuDirectory::cMenuDirectory(const char * path, cPlayList *EditList, 
! 		const char *ToPos) 
          : cOsdMenu(tr("Files"),4,2,8) 
  {
***************
*** 61,65 ****
    SetHelp(NULL,tr("Play"),tr("Toggle List"),tr("Play List"));
    editList=EditList;
!   PrepareDirectory(path);
  };
  
--- 41,61 ----
    SetHelp(NULL,tr("Play"),tr("Toggle List"),tr("Play List"));
    editList=EditList;
!   if (ToPos) {
! 	  printf("Opening dir '%s' until '%s'\n",path,ToPos);
! 	  char myDir[120];
! 	  char *myToPos;
! 	  strlcpy(myDir,path,
! 	      ((unsigned int)(ToPos-path+1))>(unsigned int)sizeof(myDir)?
! 	      sizeof(myDir): (unsigned int)(ToPos-path+1));
! 	  printf("MyDir '%s'\n",myDir);
! 	  PrepareDirectory(myDir);
! 	  myToPos=index(ToPos+1,'/');
! 	  AddSubMenu(new cMenuDirectory(path,EditList,myToPos));
!   } else  {
! 	  printf("Open only directory '%s'.\n",path);
! 	  PrepareDirectory(path);
! 	  SoftplaySetup.SetLastDir(path);
!   };
! 	  
  };
  
***************
*** 70,73 ****
--- 66,76 ----
  };
  
+ cMenuDirectory * cMenuDirectory::OpenLastBrowsedDir() {
+ 	const char *lastDir=SoftplaySetup.GetLastDir();
+ 	const char *startFrom=lastDir+strlen(Softplay->MediaPath());
+ 	printf("OpenLastBrowsedDir: '%s' startFrom '%s'\n",lastDir,startFrom);
+ 	return new cMenuDirectory(lastDir,Softplay->GetCurrList(),startFrom);
+ };
+ 
  void cMenuDirectory::PrintItemName(char *Name, const struct DirEntry &Entry,int i) {
          char inPlayList=' ';
***************
*** 91,95 ****
  };
  
! void cMenuDirectory::PrepareDirectory(char *path) 
  {
    struct dirent **namelist;
--- 94,98 ----
  };
  
! bool cMenuDirectory::PrepareDirectory(const char *path) 
  {
    struct dirent **namelist;
***************
*** 104,112 ****
    };
  
!   strncpy(start_path,path,NAME_LENGTH);
!   start_path[NAME_LENGTH-1]=0;
  
    //FIXME find a clever way to cut down the directory name
!   PrintCutDownString(Name,&start_path[Softplay->MediaPathLen()],30);
    snprintf(Title,60,tr("Files: %s"),Name);
    SetTitle(Title);
--- 107,114 ----
    };
  
!   strlcpy(start_path,path,sizeof(start_path));
  
    //FIXME find a clever way to cut down the directory name
!   PrintCutDownString(Name,start_path,30);
    snprintf(Title,60,tr("Files: %s"),Name);
    SetTitle(Title);
***************
*** 115,119 ****
    if (n<0) {
  	  printf("scandir error\n");
! 	  return;
    };
    Entries=new DirEntry[n];
--- 117,121 ----
    if (n<0) {
  	  printf("scandir error\n");
! 	  return false;
    };
    Entries=new DirEntry[n];
***************
*** 128,136 ****
  
  	  // fill Entries array and resolve symlinks
! 	  snprintf(Entries[nEntries].name,NAME_LENGTH,"%s/%s",
  	            start_path,namelist[i]->d_name);
! 	  Entries[nEntries].name[NAME_LENGTH-1]=0;
!           strncpy(Entries[nEntries].title,namelist[i]->d_name,NAME_LENGTH);
!           Entries[nEntries].title[NAME_LENGTH-1]=0;
  
  	  Entries[nEntries].type=namelist[i]->d_type;
--- 130,138 ----
  
  	  // fill Entries array and resolve symlinks
! 	  snprintf(Entries[nEntries].name,STR_LENGTH,"%s/%s",
  	            start_path,namelist[i]->d_name);
! 	  Entries[nEntries].name[STR_LENGTH-1]=0;
!           strlcpy(Entries[nEntries].title,namelist[i]->d_name,STR_LENGTH);
!           Entries[nEntries].title[STR_LENGTH-1]=0;
  
  	  Entries[nEntries].type=namelist[i]->d_type;
***************
*** 158,161 ****
--- 160,164 ----
    }
    free(namelist);
+   return true;
  };
  
***************
*** 182,187 ****
                  PLUGDEB("Item %p\n",Item);
                  if (!Item)
!                         PlayList->AddDir(Entries[No].name,
!                                         Entries[No].title,true);
                  else PlayList->RemoveItem(Item);
          } else if (Entries[No].type == DT_REG && 
--- 185,189 ----
                  PLUGDEB("Item %p\n",Item);
                  if (!Item)
!                         PlayList->AddDir(Entries[No].name,true);
                  else PlayList->RemoveItem(Item);
          } else if (Entries[No].type == DT_REG && 
***************
*** 190,195 ****
                  PLUGDEB("Item %p\n",Item);
                  if (!Item)
!                         PlayList->AddM3U(Entries[No].name,
!                                         Entries[No].title);
                  else PlayList->RemoveItem(Item);   
                  refreshAll=true;
--- 192,196 ----
                  PLUGDEB("Item %p\n",Item);
                  if (!Item)
!                         PlayList->AddM3U(Entries[No].name);
                  else PlayList->RemoveItem(Item);   
                  refreshAll=true;
***************
*** 197,207 ****
                  Item=PlayList->GetItemByFilename(Entries[No].name);
                  if (!Item)
!                         PlayList->AddFile(Entries[No].name,
!                                         Entries[No].title);
                  else PlayList->RemoveItem(Item);
          };
          if (play) {
-                 // FIXME remove
-                // Softplay->SaveList(PlayList);
                 cControl::Launch(new cSoftControl(PlayList));
                 return osEnd;
--- 198,205 ----
                  Item=PlayList->GetItemByFilename(Entries[No].name);
                  if (!Item)
!                         PlayList->AddFile(Entries[No].name);
                  else PlayList->RemoveItem(Item);
          };
          if (play) {
                 cControl::Launch(new cSoftControl(PlayList));
                 return osEnd;
***************
*** 232,236 ****
  eOSState cMenuDirectory::ProcessKey(eKeys Key) {
  	eOSState state = cOsdMenu::ProcessKey(Key);
-         cPlayListItem *Item;
  	int No=0;
  
--- 230,233 ----
***************
*** 323,328 ****
    switch (state) {
      case PLAY_FILES:  
!             return AddSubMenu(new cMenuDirectory(Softplay->MediaPath(),
!                                     Softplay->GetCurrList()));
              break;
  
--- 320,327 ----
    switch (state) {
      case PLAY_FILES:  
!             return  ( SoftplaySetup.OpenLastDir() ?
! 		    AddSubMenu(cMenuDirectory::OpenLastBrowsedDir()) :
! 		    AddSubMenu(new cMenuDirectory(Softplay->MediaPath(),
!                                     Softplay->GetCurrList())) );
              break;
  
***************
*** 357,370 ****
  
  bool cSoftPlay::Initialize(void) {
! 	configDir=ConfigDirectory(DIR_NAME);
!         currList=OpenList();
  	return true;
  };
  	
  cSoftPlay::~cSoftPlay() {
          // Clean up after yourself!
          if (currList && currListIsTmp)
                  delete currList;
! }
  
  const char *cSoftPlay::Version(void) { 
--- 356,385 ----
  
  bool cSoftPlay::Initialize(void) {
! 	strlcpy(configDir,ConfigDirectory(DIR_NAME),sizeof(configDir));
!         currList=OpenList("current");
! 	if (!FileIndex)
!                 FileIndex=new cIndexIdx;
! 
!         FileIndex->ReadIndex("/video/plugins/softplay/index");
!         
!         ScanForPlaylists();
  	return true;
  };
  	
  cSoftPlay::~cSoftPlay() {
+         if (currList)
+                 // FIXME remove
+               SaveList(currList,"current");
+ 
          // Clean up after yourself!
          if (currList && currListIsTmp)
                  delete currList;
! 
!         if (FileIndex){
! 		// FIXME remove
! 		FileIndex->SaveIndex("/video/plugins/softplay/index");
!                 delete FileIndex;
! 	};
! };
  
  const char *cSoftPlay::Version(void) { 
***************
*** 396,402 ****
  		i++;
  		if (argc>0) {
! 			strncpy(start_path,argv[i],60);
! 			start_path[59]=0;
!                         start_path_len=strlen(start_path)+1;
  			argc--;
  			i++;
--- 411,415 ----
  		i++;
  		if (argc>0) {
! 			strlcpy(start_path,argv[i],sizeof(start_path));
  			argc--;
  			i++;
***************
*** 412,415 ****
--- 425,429 ----
    // Start any background activities the plugin shall perform.
    RegisterI18n(Phrases);
+   SoftplaySetup.SetPlugin(this);
    return true;
  }
***************
*** 434,438 ****
  {
    // Return a setup menu in case the plugin supports one.
!   return NULL;
  }
  
--- 448,452 ----
  {
    // Return a setup menu in case the plugin supports one.
!   return new cSoftplaySetupMenu(this,&SoftplaySetup);
  }
  
***************
*** 440,444 ****
  {
    // Parse your own setup parameters and store their values.
!   return false;
  }
  
--- 454,458 ----
  {
    // Parse your own setup parameters and store their values.
!   return SoftplaySetup.Parse(Name,Value);
  }
  
***************
*** 449,455 ****
  };
  
! void cSoftPlay::SaveList(cPlayList *List) {
  	char filename[60];
! 	sprintf(filename,"%s/%s",configDir,List->GetName());
  
  	printf("Save list as %s\n",filename);
--- 463,472 ----
  };
  
! void cSoftPlay::SaveList(cPlayList *List, const char* Name) {
  	char filename[60];
! 	if (Name)
!                 sprintf(filename,"%s/%s.playlist",configDir,Name);
! 	else
!                 sprintf(filename,"%s/%s.playlist",configDir,List->GetName());
  
  	printf("Save list as %s\n",filename);
***************
*** 461,473 ****
  };
  
! cPlayList *cSoftPlay::OpenList() {
!         char filename[60];
          char line[500];
! 	sprintf(filename,"%s/%s",configDir,"Liste 1");
! 
  	printf("Read list from %s\n",filename);
  	FILE *out=fopen(filename,"r");
!         if (!out)
                  return NULL;
          fgets(line,500,out);
          
--- 478,504 ----
  };
  
! cPlayList *cSoftPlay::OpenList(const char *Name) {
!         char filename[120];
          char line[500];
!        
!         const char *extension=rindex(Name,'.');
!         if ( !extension || strcmp(".playlist",extension ) ) 
!                 extension=".playlist";
!         else extension=NULL;
!                 
!                         
! 	if (extension)
!                 snprintf(filename,sizeof(filename),
! 			"%s/%s%s",configDir,Name,extension);
!         else
!                 snprintf(filename,sizeof(filename),
!                                 "%s/%s",configDir,Name);
!   
  	printf("Read list from %s\n",filename);
  	FILE *out=fopen(filename,"r");
!         if (!out) {
!                 printf("could not open %s for reading!\n",filename);
                  return NULL;
+         };
          fgets(line,500,out);
          
***************
*** 478,501 ****
  };
  
  VDRPLUGINCREATOR(cSoftPlay); // Don't touch this!
  
  //------------------------------------------------------------------------
! const int32_t Divisor=0xfda9743d;
  //const int32_t Divisor=0xfda97431;
  
! int32_t SimpleHash( char const* str) {
          // just used to fast identify strings. 
          // I guess this can be made much better.
          // FIXME buggy?
          //printf("String: %s",str);
          int result=0;
!         do {
                  result=((result<<8)+*str) % Divisor;
!         } while ( *(++str) );
          //printf(" Hash: 0x%x\n",result);
          return result;
  };
  
! void PrintCutDownString(char *str,char *orig,int len) {
  #define STARTCPY 4 
  // length of the copy at the beginning
--- 509,570 ----
  };
  
+ void cSoftPlay::ScanForPlaylists() {
+         struct dirent **namelist;
+         int n;
+         char Name[60];
+         char Title[60];
+ 
+ 
+         n = scandir(configDir, &namelist, 0, alphasort);
+         if (n<0) {
+                 printf("scandir error. Could not scan for playlists\n");
+                 return;
+         };
+ 
+         for (int i=0; i<n; i++) {
+                 if ( !strcmp("..",namelist[i]->d_name) ||
+                      !strcmp(".",namelist[i]->d_name) ) {
+                         PLUGDEB("ignore %s\n",namelist[i]->d_name);
+                         continue;
+                 };
+ 
+                 char *extension=rindex(namelist[i]->d_name,'.');
+                 if ( !extension || strcmp(".playlist",extension) ) {
+                         PLUGDEB("%s is not a playlist\n",namelist[i]->d_name);
+                         continue;
+                 };
+ 
+                 PLUGDEB("found playlist %s!\n",namelist[i]->d_name);
+                 free(namelist[i]);	  
+         }
+         free(namelist);
+ };
+ 
+ 
+ 
  VDRPLUGINCREATOR(cSoftPlay); // Don't touch this!
  
  //------------------------------------------------------------------------
! const int Divisor=0xfda9743d;
  //const int32_t Divisor=0xfda97431;
  
! int SimpleHash( char const* str) {
          // just used to fast identify strings. 
          // I guess this can be made much better.
          // FIXME buggy?
+         if (!str)
+                 return 0;
+ 
          //printf("String: %s",str);
          int result=0;
!         while ( *(str) ) {
                  result=((result<<8)+*str) % Divisor;
!                 str++;
!         };
          //printf(" Hash: 0x%x\n",result);
          return result;
  };
  
! void PrintCutDownString(char *str, const char *orig, int len) {
  #define STARTCPY 4 
  // length of the copy at the beginning
***************
*** 532,535 ****
--- 601,614 ----
  };
  
+ bool IsStream( const char * const Filename) {
+         const char * const pos=Filename;
+         printf("isstream %s: %d\n",pos,strncmp(pos,"http://",7));
+         if ( !strncmp(pos,"http://",7) ) {
+                 return true;
+         };
+ 
+         return false;
+ };
+ 
  void chomp(const char *const str) {
          char *pos;
***************
*** 541,543 ****
--- 620,661 ----
                  *pos=0;
  };
+ 
+ void stripTrailingSpaces(char *str) {
+         char *pos=str+strlen(str);
+         while ( pos>str && *pos == ' ')
+                 *pos--=0;
+ };
+ 
+ void stripTrailingNonLetters(char *str) {
+         char *pos=str+strlen(str);
+         //printf("start at '%c'(0x%x) ",*pos,*pos);
+         while ( pos>str &&
+                  !(*pos >= '!' && *pos <= '~' ) ) {
+                 //printf(" del '%c'(0x%x) ",*pos,*pos);
+                 *pos--=0;
+         };
+         //printf("\n");
+ };
+ 
+ cIndexIdx *FileIndex=NULL;
+ 
+ 
+ const char *ReadQuotedString(char *out, const char *Str) {
+         int len;
+ 	if ( !Str || !*Str)
+ 		return NULL;
+ 
+         // empty string case
+         if ( !strncmp(Str,"\"\"",2) ) {
+                 out[0]=0;
+                 len=2;
+         } else if ( sscanf(Str,"\"%" TO_STRING(STR_LENGTH) "[^\"]\"%n",
+                                 out,&len) == 0 ) {
+                 fprintf(stderr,"Could not parse quoted string at position '%s'. Ignoring.\n",Str);
+                 out[0]=0;
+                 return NULL;
+         };
+         return &Str[len];
+ };
+ 
  

Index: softplay.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** softplay.h	15 Aug 2005 07:27:42 -0000	1.3
--- softplay.h	12 Mar 2006 20:28:52 -0000	1.4
***************
*** 11,16 ****
--- 11,21 ----
  #include <vdr/plugin.h>
  
+ #include "Setup.h"
  
  class cPlayList;
+ class cIndexIdx;
+ 
+ extern cIndexIdx *FileIndex;
+ 
  //#define STR_LENGTH  120
  #define STR_LENGTH  200
***************
*** 27,31 ****
    // Add any member variables or functions you may need here.
    char start_path[60];
-   int start_path_len;
  
  public:
--- 32,35 ----
***************
*** 43,47 ****
    char currListName[STR_LENGTH];
    
!   const char *configDir;
   
  public:
--- 47,51 ----
    char currListName[STR_LENGTH];
    
!   char configDir[300];
   
  public:
***************
*** 61,81 ****
  
    void SetTmpCurrList(cPlayList *List);
!   void SaveList(cPlayList *List);
!   cPlayList *OpenList();
! 
    inline cPlayList *GetCurrList() 
    { return currList; };
    inline char *MediaPath() {return start_path;};
!   inline int MediaPathLen() {return start_path_len;};
  };
  
  extern cSoftPlay *Softplay;
  
! int32_t SimpleHash( char const* str);
  
! void PrintCutDownString(char *str,char *orig,int len);
  
  bool IsM3UFile(const char *const Filename);
  
  void chomp(const char *const str);
  #endif
--- 65,142 ----
  
    void SetTmpCurrList(cPlayList *List);
!   void SaveList(cPlayList *List, const char *Name=NULL);
!   cPlayList *OpenList(const char *Name);
!   void ScanForPlaylists();
!   
    inline cPlayList *GetCurrList() 
    { return currList; };
    inline char *MediaPath() {return start_path;};
! };
! // --- cMenuDirectory -------------------------------------------
! 
! class cMenuDirectory : public cOsdMenu {
! private:
!   char start_path[STR_LENGTH];
!   struct DirEntry {
!       char name[STR_LENGTH];
!       char title[STR_LENGTH];
!       int type;
!   } * Entries;
!   int nEntries;
!   int keySelNo;
!   cPlayList *editList;
!   void PrintItemName(char *Name, const struct DirEntry &Entry,int i);
!   eOSState SelectEntry(int No, bool play);
!   
! public:
!   bool PrepareDirectory(const char * path);
!   cMenuDirectory(const char * path, cPlayList *EditList=NULL, const char *ToPos=NULL);
!   virtual ~cMenuDirectory();
!   virtual eOSState ProcessKey(eKeys Key);
!   static cMenuDirectory * OpenLastBrowsedDir();
  };
  
  extern cSoftPlay *Softplay;
  
! int SimpleHash( char const* str);
  
! void PrintCutDownString(char *str, const char *orig, int len);
  
  bool IsM3UFile(const char *const Filename);
+ bool IsStream(const char *const Filename);
  
  void chomp(const char *const str);
+ 
+ void stripTrailingSpaces(char *str);
+ void stripTrailingNonLetters(char *str);
+ 
+ 
+ static inline void strlcpy(char *dest, const char *src, size_t n) {
+         while ( *src && --n )
+                 *(dest++)=*(src++);
+         *(dest)=0;
+ };
+ 
+ static inline void skipSpaces(const char *&pos) {
+ 	while ( *pos==' ' )
+ 		pos++;
+ };
+ 
+ static inline void nextField(const char *&pos) {        
+ 	//skip whitespaces and the comma
+ 	skipSpaces(pos);
+ 
+ 	if ( *pos!=',' ) {
+ 		pos=NULL;
+ 		return;
+ 	} else pos++;
+ 
+ 	skipSpaces(pos);
+ };
+ 
+ const char *ReadQuotedString(char *out, 
+ 		const char *Str);
+ // out should be at least STR_LENGTH large
+ 
+ 
  #endif



From nobody at sheep.berlios.de  Tue Mar 21 19:34:29 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 21 Mar 2006 19:34:29 +0100
Subject: [Softdevice-cvs] softdevice video-xv.h,1.15,1.16 video-xv.c,1.45,1.46
Message-ID: <200603211834.k2LIYTt30460@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10853

Modified Files:
	video-xv.h video-xv.c 
Log Message:
 - catch errors on osd and xv image creation
 - support for non-shared memory xv
      


Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video-xv.h	18 Feb 2006 22:20:30 -0000	1.15
--- video-xv.h	21 Mar 2006 18:34:53 -0000	1.16
***************
*** 120,125 ****
    GC                gc;
    XvPortID          port;
-   bool              useShm;
  public:
    XShmSegmentInfo   shminfo, osd_shminfo;
    XvImage           *xv_image;
--- 120,125 ----
    GC                gc;
    XvPortID          port;
  public:
+   bool              useShm;
    XShmSegmentInfo   shminfo, osd_shminfo;
    XvImage           *xv_image;
***************
*** 127,132 ****
    int               osd_max_width,osd_max_height;
  private:
!   unsigned char     *outbuffer,
!                     *osd_buffer,
                      *pixels[3];
    char              *w_name, *i_name;
--- 127,131 ----
    int               osd_max_width,osd_max_height;
  private:
!   unsigned char     *osd_buffer,
                      *pixels[3];
    char              *w_name, *i_name;
***************
*** 134,139 ****
    cXvPortAttributeStore   attributeStore;
  
-   size_t size;
-   int xres, yres;
    uint64_t lastUpdate;
  
--- 133,136 ----
***************
*** 165,168 ****
--- 162,168 ----
    virtual bool Initialize (void);
    virtual bool Reconfigure (int format = FOURCC_YUY2);
+   void CreateXvImage(Display *dpy,XvPortID port,XvImage *&xv_image,
+                   XShmSegmentInfo &shminfo,int format, int &width, int &height);
+   int PutXvImage();
    virtual void YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride);
    virtual void Pause(void);

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** video-xv.c	12 Mar 2006 09:43:28 -0000	1.45
--- video-xv.c	21 Mar 2006 18:34:53 -0000	1.46
***************
*** 36,39 ****
--- 36,55 ----
  static int              events_not_done = 0;
  
+ static XErrorHandler old_handler = 0;
+ static Bool got_error = False;
+ 
+ static int XvError_Handler(Display *dpy, XErrorEvent *error) {
+   esyslog("got error code: %d \n",error->error_code);
+   got_error=true;
+   if ( error->error_code == BadMatch
+        || error->error_code== BadAlloc ) {
+           return 0;
+   };
+ 
+   if (old_handler)
+     return (*old_handler)(dpy,error);
+   else return 0;
+ };
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 636,647 ****
        XClearArea (dpy, win, 0, 0, 0, 0, False);
        ShowOSD();
!       XvShmPutImage(dpy, port,
!                     win, gc,
!                     xv_image,
!                     sxoff, syoff,      /* sx, sy */
!                     swidth, sheight,   /* sw, sh */
!                     lxoff,  lyoff,     /* dx, dy */
!                     lwidth, lheight,   /* dw, dh */
!                     False);
        XSync(dpy, False);
      }
--- 652,656 ----
        XClearArea (dpy, win, 0, 0, 0, 0, False);
        ShowOSD();
!       PutXvImage();
        XSync(dpy, False);
      }
***************
*** 679,683 ****
    format = FOURCC_YV12;
    use_xv_port = 0;
-   outbuffer = NULL;
    w_name = "vdr";
    i_name = "vdr";
--- 688,691 ----
***************
*** 712,715 ****
--- 720,724 ----
      struct timeval      current_time;
      double              displayAspect, displayRatio;
+     int                 retry = 0;
  
    dsyslog("[XvVideoOut]: patch version (%s)", PATCH_VERSION);
***************
*** 823,826 ****
--- 832,839 ----
    osd_max_height=DisplayHeight(dpy,DefaultScreen(dpy));
    useShm=XShmQueryExtension(dpy) && isLocal;
+ 
+   old_handler = XSetErrorHandler(XvError_Handler);
+   
+ init_osd: 
    if (useShm) {
  
***************
*** 878,890 ****
            }
    };
!   Bpp=osd_image->bits_per_pixel;
!   fprintf(stderr,
!           "[XvVideoOut]: got osd_image: width %d height %d, bytes per line %d\n",
!           osd_max_width, osd_max_height,osd_image->bytes_per_line);
!   
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
  
    rc = XSync(dpy, False);
  
    if (!xScreensaver)
    {
--- 891,923 ----
            }
    };
!   if (osd_image) {
!           Bpp=osd_image->bits_per_pixel;
!           fprintf(stderr, "[XvVideoOut]: got osd_image: width"
!                           " %d height %d, bytes per line %d\n",
!                           osd_max_width, osd_max_height,
!                           osd_image->bytes_per_line);
!   }; 
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
  
    rc = XSync(dpy, False);
  
+   if (got_error)
+   {
+     got_error=0;retry++;
+     osd_max_width=720;
+     osd_max_height=536;
+     if (retry<2) {
+             fprintf(stderr,"Error initializing osd image. Retry.\n");
+             goto init_osd;
+     };
+     fprintf(stderr,"Error initializing osd image. Exit.\n");
+     exit(-1);
+   };
+   if (old_handler) {
+           XSetErrorHandler(old_handler);
+           old_handler = NULL;
+   };
+ 
+ 
    if (!xScreensaver)
    {
***************
*** 1054,1117 ****
     * Now we do shared memory allocation etc..
     */
!   xv_image = XvShmCreateImage(dpy, port,
!                               format, (char *) outbuffer,
!                               xvWidth, xvHeight,
!                               &shminfo);
! 
!   if (xv_image) {
!     dsyslog("[XvVideoOut]: XvShmCreateImage Successful (%p)", xv_image);
!   } else {
!     dsyslog("[XvVideoOut]: ERROR: XvShmCreateImage FAILED !");
!   }
! 
!   shminfo.shmid = shmget(IPC_PRIVATE,
!                          len,
!                          IPC_CREAT | 0777);
! 
!   if (shminfo.shmid == -1) {
!     dsyslog("[XvVideoOut]: ERROR: shmget FAILED !");
!   } else {
!     dsyslog("[XvVideoOut]: shmget Successful (%d bytes)",len);
!   }
! 
!   /* compile fix for gcc 3.4.3
!    */
!   shminfo.shmaddr = (char *) shmat(shminfo.shmid, NULL, 0);
!   outbuffer = (unsigned char *) shminfo.shmaddr;
!   xv_image->data = (char *) outbuffer;
! 
!   if (xv_image->data == (char *) -1L) {
!     dsyslog("[XvVideoOut]: ERROR: shmat FAILED !");
!   } else {
!     dsyslog("[XvVideoOut]: shmat Successful");
!   }
!   shminfo.readOnly = False;
! 
!   pixels [0] = outbuffer;
!   pixels [1] = outbuffer + xvWidth * xvHeight;
!   pixels [2] = pixels [1] + xvWidth * xvHeight / 4;
!   
!   rc = XShmAttach(dpy, &shminfo);
!   dsyslog("[XvVideoOut]: XShmAttach    rc = %d %s",
!           rc,(rc == 1) ? "(should be OK)":"(thats NOT OK!)");
  
!   if (shminfo. shmid > 0)
!     shmctl (shminfo. shmid, IPC_RMID, 0);
  
    memset (pixels [0], 0, xvWidth*xvHeight);
    memset (pixels [1], 128, xvWidth*xvHeight/4);
    memset (pixels [2], 128, xvWidth*xvHeight/4);
! //    dv_display_event(dv_dpy);
!   rc = XvShmPutImage(dpy, port,
!                      win, gc,
!                      xv_image,
!                      0, 0,              /* sx, sy */
!                      swidth, sheight,   /* sw, sh */
!                      lxoff,  lyoff,     /* dx, dy */
!                      lwidth, lheight,   /* dw, dh */
!                      False);
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
     
    rc = XSync(dpy, False);
    
    pthread_mutex_unlock(&xv_mutex);
--- 1087,1127 ----
     * Now we do shared memory allocation etc..
     */
!   int retry=0;
!   old_handler = XSetErrorHandler(XvError_Handler);
! retry_image: 
!   CreateXvImage(dpy,port,xv_image,shminfo,
!                   format,xvWidth, xvHeight); 
  
!   pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
!   pixels[1] = (uint8_t *) (xv_image->data + xv_image->offsets[1]);
!   pixels[2] = (uint8_t *) (xv_image->data + xv_image->offsets[2]);
  
    memset (pixels [0], 0, xvWidth*xvHeight);
    memset (pixels [1], 128, xvWidth*xvHeight/4);
    memset (pixels [2], 128, xvWidth*xvHeight/4);
! 
!   rc = PutXvImage();
!   
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
     
    rc = XSync(dpy, False);
+ 
+   if (got_error)
+   {
+     got_error=0;retry++;
+     xvWidth=XV_SRC_WIDTH;
+     xvHeight = XV_SRC_HEIGHT;
+     if (retry<2) {
+             fprintf(stderr,"Error initializing Xv. Retry.\n");
+             goto retry_image;
+     };
+     fprintf(stderr,"Error intializing Xv. Exit.\n");
+     exit(-1);
+   };
+   if (old_handler) {
+           XSetErrorHandler(old_handler);
+           old_handler=NULL;
+   };
+ 
    
    pthread_mutex_unlock(&xv_mutex);
***************
*** 1123,1126 ****
--- 1133,1224 ----
  }
  
+ void cXvVideoOut::CreateXvImage(Display *dpy,XvPortID port,
+                   XvImage *&xv_image,
+                   XShmSegmentInfo &shminfo,
+                   int format, int &width, int &height) {
+   int len=0;
+   if (useShm)
+   {
+     xv_image = XvShmCreateImage(dpy, port,
+         format, NULL,
+         width, height,
+         &shminfo);
+     if (xv_image) {
+       dsyslog("[XvVideoOut]: XvShmCreateImage Successful (%p)", xv_image);
+     } else {
+       dsyslog("[XvVideoOut]: ERROR: XvShmCreateImage FAILED !");
+       exit(-1);
+     }
+ 
+     shminfo.shmid = shmget(IPC_PRIVATE,
+         xv_image->data_size,
+         IPC_CREAT | 0777);
+ 
+     if (shminfo.shmid == -1) {
+       dsyslog("[XvVideoOut]: ERROR: shmget FAILED !");
+     } else {
+       dsyslog("[XvVideoOut]: shmget Successful (%d bytes)",len);
+     }
+ 
+     /* compile fix for gcc 3.4.3
+     */
+     shminfo.shmaddr = (char *) shmat(shminfo.shmid, NULL, 0);
+     xv_image->data = (char *) shminfo.shmaddr;
+ 
+     if (xv_image->data == (char *) -1L) {
+       dsyslog("[XvVideoOut]: ERROR: shmat FAILED !");
+       exit(-1);
+     } else {
+       dsyslog("[XvVideoOut]: shmat Successful");
+     }
+     shminfo.readOnly = False;
+     int rc = XShmAttach(dpy, &shminfo);
+     dsyslog("[XvVideoOut]: XShmAttach    rc = %d %s",
+         rc,(rc == 1) ? "(should be OK)":"(thats NOT OK!)");
+ 
+     // request remove after detaching
+     if (shminfo. shmid > 0)
+       shmctl (shminfo. shmid, IPC_RMID, 0);
+   }else 
+   {
+     xv_image = XvCreateImage(dpy, port,format, NULL,
+         width, height);
+     if (!xv_image) {
+       dsyslog("[XvVideoOut]: ERROR: XvCreateImage FAILED !");
+       exit(-1);
+     };
+       
+     xv_image->data = (char*)malloc(xv_image->data_size);
+     if (!xv_image->data) {
+       dsyslog("[XvVideoOut]: ERROR: malloc xv_image FAILED !");
+       exit(-1);
+     };
+   };
+ };
+ 
+ /*----------------------------------------------------------------------------
+  */
+ 
+ int cXvVideoOut::PutXvImage() {
+   if (useShm)
+     return XvShmPutImage(dpy, port,
+                      win, gc,
+                      xv_image,
+                      0, 0,              /* sx, sy */
+                      swidth, sheight,   /* sw, sh */
+                      lxoff,  lyoff,     /* dx, dy */
+                      lwidth, lheight,   /* dw, dh */
+                      False);
+   else 
+     return XvPutImage(dpy, port,
+                      win, gc,
+                      xv_image,
+                      0, 0,              /* sx, sy */
+                      swidth, sheight,   /* sw, sh */
+                      lxoff,  lyoff,     /* dx, dy */
+                      lwidth, lheight   /* dw, dh */
+                      );
+ };
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 1141,1151 ****
    XvUngrabPort(dpy, port, CurrentTime);
    
-   pthread_mutex_unlock(&xv_mutex);
  
!   if(shminfo.shmaddr)
!   {
!     shmdt(shminfo.shmaddr);
!     shminfo.shmaddr = NULL;
!   }
  
    if (xv_image)
--- 1239,1256 ----
    XvUngrabPort(dpy, port, CurrentTime);
    
  
!   if (xv_image->data) {
!     if(useShm && shminfo.shmaddr)
!     {
!       shmdt(shminfo.shmaddr);
!       shminfo.shmaddr = NULL;
!       XShmDetach(dpy, &shminfo);
!     }
!     if (!useShm) {
!       free(xv_image->data);
!     };
!     xv_image->data = NULL;
!   };
!   pthread_mutex_unlock(&xv_mutex);
  
    if (xv_image)
***************
*** 1213,1217 ****
  void cXvVideoOut::AdjustOSDMode()
  {
!   current_osdMode = setupStore->osdMode;
  }
  
--- 1318,1324 ----
  void cXvVideoOut::AdjustOSDMode()
  {
!   if (xv_initialized)
!           current_osdMode = setupStore->osdMode;
!   else current_osdMode = OSDMODE_PSEUDO;
  }
  
***************
*** 1410,1413 ****
--- 1517,1521 ----
    }
  
+   if ( Py && Pu && Pv ) {
  #if VDRVERSNUM >= 10307
    /* -------------------------------------------------------------------------
***************
*** 1447,1459 ****
          }
  
-         XvShmPutImage(dpy, port,
-                 win, gc,
-                 xv_image,
-                 sxoff, syoff,      /* sx, sy */
-                 swidth, sheight,   /* sw, sh */
-                 lxoff,  lyoff,     /* dx, dy */
-                 lwidth, lheight,   /* dw, dh */
-                 False);
- 
    }
    else
--- 1555,1558 ----
***************
*** 1473,1486 ****
                            Pu + i * UVstride + cutLeft,
                            fwidth / 2 - (cutLeft + cutRight));
- 
-           XvShmPutImage(dpy, port,
-                 win, gc,
-                 xv_image,
-                 sxoff, syoff,      /* sx, sy */
-                 swidth, sheight,   /* sw, sh */
-                 lxoff,  lyoff,     /* dx, dy */
-                 lwidth, lheight,   /* dw, dh */
-                 False);
    }
    ProcessEvents ();
    events_not_done = 0;
--- 1572,1578 ----
                            Pu + i * UVstride + cutLeft,
                            fwidth / 2 - (cutLeft + cutRight));
    }
+   }
+   PutXvImage();
    ProcessEvents ();
    events_not_done = 0;
***************
*** 1506,1509 ****
--- 1598,1602 ----
        shmdt(shminfo.shmaddr);
        shminfo.shmaddr = NULL;
+       shminfo.shmid = -1;
      }
    



From nobody at sheep.berlios.de  Tue Mar 21 19:44:51 2006
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 21 Mar 2006 19:44:51 +0100
Subject: [Softdevice-cvs] softdevice ShmClient.c,1.7,1.8 video-shm.c,1.5,1.6 CHANGELOG,1.161,1.162
Message-ID: <200603211844.k2LIipt31867@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14738

Modified Files:
	ShmClient.c video-shm.c CHANGELOG 
Log Message:
- remove the image copy overhead from the ShmClient



Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** ShmClient.c	19 Feb 2006 16:58:35 -0000	1.7
--- ShmClient.c	21 Mar 2006 18:45:14 -0000	1.8
***************
*** 74,78 ****
   
          int curr_pict_shmid;
!         uint8_t *curr_pict;
          uint8_t *pixel[4];
         
--- 74,79 ----
   
          int curr_pict_shmid;
!         uint8_t *curr_pict=0;
!         uint8_t *curr_osd=0;
          uint8_t *pixel[4];
         
***************
*** 88,128 ****
          };
  
!         
!         // create a picture in shm
!         ctl->max_width=736;
!         ctl->max_height=576;
!         ctl->stride0=ctl->max_width;
!         ctl->stride2=ctl->stride1=ctl->max_width/2;
!         
!         if ( (ctl->pict_shmid = shmget(IPC_PRIVATE,
!                           ctl->max_width*ctl->max_height*2, 
!                           IPC_CREAT | 0666)) < 0 ) {
!                 fprintf(stderr,"error creating  pict_shm!\n");
                  exit(-1);
          };
          
!         if ( (curr_pict = (uint8_t*)shmat(ctl->pict_shmid,NULL,0)) 
!                         == (uint8_t*) -1 ) {
!                 fprintf(stderr,"error attatching shm ctl!\n");
!                 exit(-1);
!         };
  
!         // request removeing after detaching
!         if ( ctl->pict_shmid > 0)
!                 shmctl (ctl->pict_shmid, IPC_RMID, 0);
!  
!         pixel[0]=curr_pict;
!         pixel[1]=curr_pict+ctl->max_height*ctl->stride0;
!         pixel[2]=pixel[1]+ctl->max_height/2*ctl->stride1;
  
          ctl->attached=1;
!         
!         if ( !vout->Initialize() || !vout->Reconfigure(FOURCC_YV12) ) {
!                 fprintf(stderr,"Could not init video out!\n");
!                 exit(-1);
!         };
!         xvRemote->XvRemoteStart();
  
!         ctl->osd_shmid= vout->osd_shminfo.shmid;
          ctl->osd_stride=vout->osd_image->bytes_per_line;
          ctl->osd_depth=vout->osd_image->bits_per_pixel;
--- 89,155 ----
          };
  
!         if ( !vout->Initialize() || !vout->Reconfigure(FOURCC_YV12) ) {
!                 fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
+         xvRemote->XvRemoteStart();
          
!         if (vout->useShm) {
!                 ctl->pict_shmid= vout->shminfo.shmid;  
!                 ctl->max_width=vout->xv_image->width;
!                 ctl->max_height=vout->xv_image->height;
!                 ctl->stride0=vout->xv_image->pitches[0];
!                 ctl->stride1=vout->xv_image->pitches[1];
!                 ctl->stride2=vout->xv_image->pitches[2];
!         } else {
!                 // create a picture in shm
!                 ctl->max_width=736;
!                 ctl->max_height=576;
!                 ctl->stride0=ctl->max_width;
!                 ctl->stride2=ctl->stride1=ctl->max_width/2;
  
!                 if ( (ctl->pict_shmid = shmget(IPC_PRIVATE,
!                                   ctl->max_width*ctl->max_height*2, 
!                                   IPC_CREAT | 0666)) < 0 ) {
!                         fprintf(stderr,"error creating  pict_shm!\n");
!                         exit(-1);
!                 };
! 
!                 if ( (curr_pict = (uint8_t*)shmat(ctl->pict_shmid,NULL,0)) 
!                                 == (uint8_t*) -1 ) {
!                         fprintf(stderr,"error attatching shm ctl!\n");
!                         exit(-1);
!                 };
  
+                 // request removing after detaching
+                 if ( ctl->pict_shmid > 0)
+                         shmctl (ctl->pict_shmid, IPC_RMID, 0);
+ 
+                 pixel[0]=curr_pict;
+                 pixel[1]=curr_pict+ctl->max_height*ctl->stride0;
+                 pixel[2]=pixel[1]+ctl->max_height/2*ctl->stride1;
+         }
          ctl->attached=1;
!         //printf("pict_shmid: %d max: (%d,%d), stride0: %d, stride2: %d\n",
!         //                       ctl->pict_shmid, ctl->max_width,ctl->max_height,
!         //                       ctl->stride0,ctl->stride2);
  
!         if (vout->useShm) {
!                 ctl->osd_shmid= vout->osd_shminfo.shmid;
!         } else {
!                 if ( (ctl->osd_shmid = shmget(IPC_PRIVATE,
!                                  vout->osd_image->bytes_per_line*
!                                  vout->osd_max_width, 
!                                                 IPC_CREAT | 0666)) < 0 ) {
!                         fprintf(stderr,"error creating  osd_shm!\n");
!                         exit(-1);
!                 };
! 
!                 if ( (curr_osd = (uint8_t*)shmat(ctl->osd_shmid,NULL,0)) 
!                                 == (uint8_t*) -1 ) {
!                         fprintf(stderr,"error attatching osd shm!\n");
!                         exit(-1);
!                 };
!         };
          ctl->osd_stride=vout->osd_image->bytes_per_line;
          ctl->osd_depth=vout->osd_image->bits_per_pixel;
***************
*** 131,135 ****
          vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
                                ctl->osd_xPan,ctl->osd_yPan);
!         printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
          
          ctl->key=NO_KEY;
--- 158,162 ----
          vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
                                ctl->osd_xPan,ctl->osd_yPan);
!         //printf("osd_shmid %d stride %d\n",ctl->osd_shmid,ctl->osd_stride);
          
          ctl->key=NO_KEY;
***************
*** 152,162 ****
                          vout->CheckArea(width,height);
                          vout->CheckAspect(ctl->new_afd,ctl->new_asp);
!                         vout->YUV(pixel[0],pixel[1],pixel[2],
                                          width,height,
                                          ctl->stride0,ctl->stride1);
                          ctl->new_pict=0;
                  };
                  if (ctl->new_osd) {
                          SHMDEB("new osd picture\n");
                          vout->CommitUnlockOsdSurface();
                          ctl->new_osd=0;
--- 179,203 ----
                          vout->CheckArea(width,height);
                          vout->CheckAspect(ctl->new_afd,ctl->new_asp);
!                         if ( vout->useShm ) {
!                                 vout->YUV(NULL,NULL,NULL,
!                                                 width,height,
!                                                 ctl->stride0,ctl->stride1);
!                         } else {    
!                                 vout->YUV(pixel[0],pixel[2],pixel[1],
                                          width,height,
                                          ctl->stride0,ctl->stride1);
+                         };
                          ctl->new_pict=0;
                  };
                  if (ctl->new_osd) {
                          SHMDEB("new osd picture\n");
+                         if ( !vout->useShm ) { 
+                                 uint8_t *dest_osd;
+                                 int osd_stride;
+                                 bool *dirtyLines;
+                                 vout->GetLockOsdSurface(dest_osd,osd_stride,
+                                                 dirtyLines);
+                                 memcpy(dest_osd,curr_osd,ctl->osd_height*osd_stride);
+                         };
                          vout->CommitUnlockOsdSurface();
                          ctl->new_osd=0;

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** video-shm.c	19 Feb 2006 18:40:28 -0000	1.5
--- video-shm.c	21 Mar 2006 18:45:14 -0000	1.6
***************
*** 311,315 ****
                                         width );
                  for (int i = 0; i < height / 2; i++)
!                         AlphaBlend(pixels [1] + i * ctl->stride1,
                                          OsdPu+i*OSD_FULL_WIDTH/2,
                                          Pu + i * UVstride ,
--- 311,315 ----
                                         width );
                  for (int i = 0; i < height / 2; i++)
!                         AlphaBlend(pixels [2] + i * ctl->stride1,
                                          OsdPu+i*OSD_FULL_WIDTH/2,
                                          Pu + i * UVstride ,
***************
*** 317,321 ****
                                          width/2);
                  for (int i = 0; i < height / 2 ; i++)
!                         AlphaBlend(pixels [2] + i * ctl->stride2 ,
                                          OsdPv+i*OSD_FULL_WIDTH/2,
                                          Pv + i * UVstride,
--- 317,321 ----
                                          width/2);
                  for (int i = 0; i < height / 2 ; i++)
!                         AlphaBlend(pixels [1] + i * ctl->stride2 ,
                                          OsdPv+i*OSD_FULL_WIDTH/2,
                                          Pv + i * UVstride,
***************
*** 329,337 ****
                                          width );
                  for (int i = 0; i < height / 2; i++)
!                         fast_memcpy (pixels [1] + i * ctl->stride1,
                                          Pu + i * UVstride,
                                          width / 2);
                  for (int i = 0; i < height / 2 ; i++)
!                         fast_memcpy (pixels [2] + i * ctl->stride2 ,
                                          Pv + i * UVstride,
                                          width / 2);
--- 329,337 ----
                                          width );
                  for (int i = 0; i < height / 2; i++)
!                         fast_memcpy (pixels [2] + i * ctl->stride1,
                                          Pu + i * UVstride,
                                          width / 2);
                  for (int i = 0; i < height / 2 ; i++)
!                         fast_memcpy (pixels [1] + i * ctl->stride2 ,
                                          Pv + i * UVstride,
                                          width / 2);

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.161
retrieving revision 1.162
diff -C2 -d -r1.161 -r1.162
*** CHANGELOG	12 Mar 2006 09:47:43 -0000	1.161
--- CHANGELOG	21 Mar 2006 18:45:14 -0000	1.162
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2005-03-21:
+    - remove the image copy overhead from the ShmClient
+    - catch errors on osd and xv image creation
+    - support for non-shared memory xv
  2005-03-12:
     - Fix StillPicture handling when no PES header is sent 



From nobody at sheep.berlios.de  Wed Mar 22 23:51:10 2006
From: nobody at sheep.berlios.de (wachm)
Date: Wed, 22 Mar 2006 23:51:10 +0100
Subject: [Softdevice-cvs] softplay PlayList.c,1.14,1.15
Message-ID: <200603222251.k2MMpAt07028@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv13788

Modified Files:
	PlayList.c 
Log Message:
- fix compile issue with gcc4 (patch by Tobias Grimm)



Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** PlayList.c	20 Mar 2006 20:04:30 -0000	1.14
--- PlayList.c	22 Mar 2006 22:51:34 -0000	1.15
***************
*** 673,677 ****
  		// check for extinfos...
  		char *extInfoPos=line[!swapLine];
! 		skipSpaces((const char *)extInfoPos);
  		if ( *extInfoPos=='#' && FileIndex ) {
  			cIndex *Idx=FileIndex->GetOrAddIndex(ItemFile);
--- 673,680 ----
  		// check for extinfos...
  		char *extInfoPos=line[!swapLine];
! 		//skipSpaces((const char *)extInfoPos);
!                 while ( *extInfoPos==' ' )
!                         extInfoPos++;
! 
  		if ( *extInfoPos=='#' && FileIndex ) {
  			cIndex *Idx=FileIndex->GetOrAddIndex(ItemFile);



From nobody at sheep.berlios.de  Fri Mar 31 21:15:04 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 31 Mar 2006 21:15:04 +0200
Subject: [Softdevice-cvs] softdevice configure,1.9,1.10
Message-ID: <200603311915.k2VJF4t26859@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4984

Modified Files:
	configure 
Log Message:
detection of Xinerama


Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** configure	10 Nov 2005 06:54:07 -0000	1.9
--- configure	31 Mar 2006 19:15:26 -0000	1.10
***************
*** 26,29 ****
--- 26,30 ----
  cc="g++"
  xv="yes"
+ xinerama="yes"
  vidix="yes"
  vidix_path="/usr/local"
***************
*** 184,187 ****
--- 185,209 ----
  
  #########################################################
+ # X11: check if we can use Xinerama extension
+ #
+ if test "${xv}" = "yes" -a "${xinerama}" = "yes" ; then
+   xinerama_libs="-lXinerama"
+   cat > ${TMPC} << EOF
+ #include <stdio.h>
+ #include <X11/Xlib.h>
+ #include <X11/extensions/Xinerama.h>
+ int main(void) {
+     Display             *dpy;
+     XineramaScreenInfo  *screens;
+     int                 numScreens;
+   dpy = XOpenDisplay(NULL);
+   screens = XineramaQueryScreens (dpy, &numScreens);
+   return 0;
+ }
+ EOF
+ $cc $CFLAGS $xv_libs $xinerama_libs -o $TMPE $TMPC > /dev/null 2>&1 || xinerama="no"
+ fi
+ 
+ #########################################################
  broken_gcc_cpp="no"
  cat > ${TMPC} << EOF
***************
*** 300,303 ****
--- 322,330 ----
  if test "${xv}" = "yes" ; then
    echo "XV_SUPPORT       = 1" >> $TMPM
+   if test "${xinerama}" = "yes" ; then
+     echo "XINERAMA_SUPPORT = 1" >> $TMPM
+     echo "#define XINERAMA_SUPPORT       1" >> $TMPH
+     xv_libs="${xv_libs} ${xinerama_libs}"
+   fi
    echo "LIBXDPMS_SUPPORT = 1" >> $TMPM
    echo "XV_LIBS          = ${xv_libs}"  >> $TMPM



From nobody at sheep.berlios.de  Fri Mar 31 21:21:10 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 31 Mar 2006 21:21:10 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.162,1.163 video-xv.c,1.46,1.47 video-xv.h,1.16,1.17
Message-ID: <200603311921.k2VJLAt26996@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9576

Modified Files:
	CHANGELOG video-xv.c video-xv.h 
Log Message:
Xinerama support

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.162
retrieving revision 1.163
diff -C2 -d -r1.162 -r1.163
*** CHANGELOG	21 Mar 2006 18:45:14 -0000	1.162
--- CHANGELOG	31 Mar 2006 19:21:32 -0000	1.163
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2006-03-31:
+    - Xinerama support (detection and build requires to run configure).
  2005-03-21:
     - remove the image copy overhead from the ShmClient

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** video-xv.c	21 Mar 2006 18:34:53 -0000	1.46
--- video-xv.c	31 Mar 2006 19:21:32 -0000	1.47
***************
*** 408,414 ****
      old_dheight = dheight;
  
!     x = y = 0;
!     w = DisplayWidth(dpy,DefaultScreen(dpy));
!     h = DisplayHeight(dpy,DefaultScreen(dpy));
    }
    else
--- 408,427 ----
      old_dheight = dheight;
  
!     if (xin_mode)
!     {
!         int i;
! 
!       i = (xin_screen != -1) ? xin_screen : 0;
!       x = xin_screen_info[i]. x_org;
!       y = xin_screen_info[i]. y_org;
!       w = xin_screen_info[i]. width;
!       h = xin_screen_info[i]. height;
!     }
!     else
!     {
!       x = y = 0;
!       w = DisplayWidth(dpy,DefaultScreen(dpy));
!       h = DisplayHeight(dpy,DefaultScreen(dpy));
!     }
    }
    else
***************
*** 468,471 ****
--- 481,574 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
+ void cXvVideoOut::AdjustDisplayRatio()
+ {
+     double              displayAspect, displayRatio;
+ 
+   /* --------------------------------------------------------------------------
+    * set PAR values
+    */
+   displayAspect = (double) DisplayWidthMM(dpy, DefaultScreen(dpy)) /
+                     (double) DisplayHeightMM(dpy, DefaultScreen(dpy));
+   if (xin_mode)
+     displayRatio  = (double) GetScreenWidth() / (double) GetScreenHeight();
+   else
+     displayRatio  = (double) DisplayWidth(dpy, DefaultScreen(dpy)) /
+                       (double) DisplayHeight(dpy, DefaultScreen(dpy));
+ 
+   SetParValues(displayAspect, displayRatio);
+ 
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cXvVideoOut::AdjustXineramaScreen()
+ {
+ #if XINERAMA_SUPPORT
+     XineramaScreenInfo  *new_screen_info;
+     int                 new_num_screens;
+ 
+   if (!xin_mode)
+     return;
+ 
+   new_screen_info = XineramaQueryScreens (dpy, &new_num_screens);
+   if (new_screen_info)
+   {
+     if (xin_screen_info)
+       XFree(xin_screen_info);
+ 
+     xin_screen_info = new_screen_info;
+     xin_num_screens = new_num_screens;
+   }
+ 
+   for (int i = 0; i < xin_num_screens; ++i)
+   {
+     if (dx >= xin_screen_info[i]. x_org &&
+         dx <= (xin_screen_info[i]. x_org +
+                 xin_screen_info[i]. width) &&
+         dy >= xin_screen_info[i]. y_org &&
+         dy <= (xin_screen_info[i]. y_org +
+                 xin_screen_info[i]. height))
+     {
+       if (i != xin_screen)
+       {
+         fprintf(stderr,
+                 "[XvVideoOut]: Xinerama-Screen changed to %d\n", i);
+         xin_screen = i;
+       }
+       break;
+     }
+   }
+ 
+   AdjustDisplayRatio();
+ 
+ #endif
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ int cXvVideoOut::GetScreenWidth()
+ {
+ #if XINERAMA_SUPPORT
+   if (xin_mode)
+     return xin_screen_info[(xin_screen != -1) ? xin_screen : 0]. width;
+ #endif
+ 
+   return DisplayWidth(dpy,DefaultScreen(dpy));
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ int cXvVideoOut::GetScreenHeight()
+ {
+ #if XINERAMA_SUPPORT
+   if (xin_mode)
+     return xin_screen_info[(xin_screen != -1) ? xin_screen : 0]. height;
+ #endif
+ 
+   return DisplayHeight(dpy,DefaultScreen(dpy));
+ }
+ 
  //#define EVDEB(out...) {printf("EVDEB:");printf(out);}
  #define EVDEB(out...)
***************
*** 516,525 ****
          dwidth = event.xconfigure.width;
          dheight = event.xconfigure.height;
          RecalculateAspect();
  
          if (toggleInProgress &&
              ((fullScreen &&
!                dwidth == DisplayWidth(dpy,DefaultScreen(dpy)) &&
!                dheight == DisplayHeight(dpy,DefaultScreen(dpy))) ||
                (!fullScreen &&
                 dwidth == old_dwidth &&
--- 619,629 ----
          dwidth = event.xconfigure.width;
          dheight = event.xconfigure.height;
+         AdjustXineramaScreen();
          RecalculateAspect();
  
          if (toggleInProgress &&
              ((fullScreen &&
!                dwidth == GetScreenWidth() &&
!                dheight == GetScreenHeight()) ||
                (!fullScreen &&
                 dwidth == old_dwidth &&
***************
*** 694,697 ****
--- 798,808 ----
    Yres=height;
  
+   xin_mode = false;
+   xin_screen = -1;
+ 
+ #if XINERAMA_SUPPORT
+   xin_screen_info = NULL;
+ #endif
+ 
    /*
     * default settings: source, destination and logical widht/height
***************
*** 719,723 ****
      XTextProperty       x_wname, x_iname;
      struct timeval      current_time;
-     double              displayAspect, displayRatio;
      int                 retry = 0;
  
--- 830,833 ----
***************
*** 725,729 ****
  
    if(!(dpy = XOpenDisplay(NULL))) {
! 	fprintf(stderr, "[XvVideoOut]: Could not connect to X-server");
      dsyslog("[XvVideoOut]: Could not connect to X-server");
      return false;
--- 835,839 ----
  
    if(!(dpy = XOpenDisplay(NULL))) {
!     fprintf(stderr, "[XvVideoOut]: Could not connect to X-server");
      dsyslog("[XvVideoOut]: Could not connect to X-server");
      return false;
***************
*** 733,737 ****
--- 843,873 ----
    scn_id = DefaultScreen(dpy);
  
+   /* -------------------------------------------------------------------------
+    * Check if xinerama is active
+    */
+ #if XINERAMA_SUPPORT
+   if (XineramaIsActive(dpy))
+   {
+       int                 i;
  
+     xin_screen_info = XineramaQueryScreens (dpy, &xin_num_screens);
+     if (xin_screen_info)
+     {
+       for (i = 0; i < xin_num_screens; ++i)
+       {
+         fprintf(stderr,
+                 "[XvVideoOut]: Xinerama Screen %d: %d,%d  %dx%d\n",
+                 i,
+                 xin_screen_info[i]. x_org,
+                 xin_screen_info[i]. y_org,
+                 xin_screen_info[i]. width,
+                 xin_screen_info[i]. height);
+       }
+       xin_mode = xin_num_screens > 0;
+     } else {
+       fprintf (stderr, "[XvVideoOut]: NO Xinerama Screens present\n");
+     }
+   }
+ #endif
    /* -------------------------------------------------------------------------
     * default settings which allow arbitraray resizing of the window
***************
*** 752,768 ****
    XStringListToTextProperty(&i_name, 1 ,&x_iname);
  
!   /* --------------------------------------------------------------------------
!    * set PAR values
!    */
!   displayAspect = (double) DisplayWidthMM(dpy, scn_id) /
!                     (double) DisplayHeightMM(dpy, scn_id);
!   displayRatio  = (double) DisplayWidth(dpy, scn_id) /
!                     (double) DisplayHeight(dpy, scn_id);
! 
!   SetParValues(displayAspect, displayRatio);
! 
!   fprintf(stderr,
!           "[XvVideoOut]: displayAspect = %f, displayRatio = %f, PAR = %f\n",
!           displayAspect, displayRatio, parValues[0]);
  
    if (flags & XV_FORMAT_MASK) {
--- 888,892 ----
    XStringListToTextProperty(&i_name, 1 ,&x_iname);
  
!   AdjustDisplayRatio();
  
    if (flags & XV_FORMAT_MASK) {
***************
*** 802,808 ****
    Pixmap cursor_mask;
    XColor dummy_col;
!   
    const char cursor_data[] = { 0x0 };
!   
    cursor_mask = XCreateBitmapFromData(dpy, win, cursor_data, 1, 1);
    hidden_cursor = XCreatePixmapCursor(dpy, cursor_mask, cursor_mask,
--- 926,932 ----
    Pixmap cursor_mask;
    XColor dummy_col;
! 
    const char cursor_data[] = { 0x0 };
! 
    cursor_mask = XCreateBitmapFromData(dpy, win, cursor_data, 1, 1);
    hidden_cursor = XCreatePixmapCursor(dpy, cursor_mask, cursor_mask,
***************
*** 834,839 ****
  
    old_handler = XSetErrorHandler(XvError_Handler);
!   
! init_osd: 
    if (useShm) {
  
--- 958,963 ----
  
    old_handler = XSetErrorHandler(XvError_Handler);
! 
! init_osd:
    if (useShm) {
  
***************
*** 843,847 ****
                            ZPixmap,NULL,
                            &osd_shminfo,
! 			  osd_max_width,osd_max_height);
                            //width, height);
            if (osd_image) {
--- 967,971 ----
                            ZPixmap,NULL,
                            &osd_shminfo,
!                           osd_max_width,osd_max_height);
                            //width, height);
            if (osd_image) {
***************
*** 1089,1095 ****
    int retry=0;
    old_handler = XSetErrorHandler(XvError_Handler);
! retry_image: 
    CreateXvImage(dpy,port,xv_image,shminfo,
!                   format,xvWidth, xvHeight); 
  
    pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
--- 1213,1219 ----
    int retry=0;
    old_handler = XSetErrorHandler(XvError_Handler);
! retry_image:
    CreateXvImage(dpy,port,xv_image,shminfo,
!                   format,xvWidth, xvHeight);
  
    pixels[0] = (uint8_t *) (xv_image->data + xv_image->offsets[0]);
***************
*** 1102,1108 ****
  
    rc = PutXvImage();
!   
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
!    
    rc = XSync(dpy, False);
  
--- 1226,1232 ----
  
    rc = PutXvImage();
! 
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
! 
    rc = XSync(dpy, False);
  
***************
*** 1124,1128 ****
    };
  
!   
    pthread_mutex_unlock(&xv_mutex);
  
--- 1248,1252 ----
    };
  
! 
    pthread_mutex_unlock(&xv_mutex);
  
***************
*** 1600,1604 ****
        shminfo.shmid = -1;
      }
!   
      if (xv_image)
      {
--- 1724,1728 ----
        shminfo.shmid = -1;
      }
! 
      if (xv_image)
      {
***************
*** 1616,1619 ****
--- 1740,1746 ----
  
  
+ #if XINERAMA_SUPPORT
+   XFree(xin_screen_info);
+ #endif
    if (osd_image)
    {

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video-xv.h	21 Mar 2006 18:34:53 -0000	1.16
--- video-xv.h	31 Mar 2006 19:21:32 -0000	1.17
***************
*** 35,38 ****
--- 35,42 ----
  #include <X11/extensions/Xvlib.h>
  
+ #if XINERAMA_SUPPORT
+ # include <X11/extensions/Xinerama.h>
+ #endif
+ 
  #define FOURCC_YV12       0x32315659   /* 4:2:0 Planar: Y + V + U  (3 planes) */
  #define FOURCC_YUY2       0x32595559   /* 4:2:2 Packed: Y0+U0+Y1+V0 (1 plane) */
***************
*** 112,120 ****
                      xv_initialized,
                      /* -------------------------------------------------------
!                      * could be specified via argv or parameters
!                      */
                      xvWidth, xvHeight,
                      width, height,
                      format;
  
    GC                gc;
--- 116,133 ----
                      xv_initialized,
                      /* -------------------------------------------------------
!                         * could be specified via argv or parameters
!                         */
                      xvWidth, xvHeight,
                      width, height,
                      format;
+   /* -------------------------------------------------------------------------
+    * Xinerama specific members (not all depend on Xinerame available)
+    */
+   int               xin_screen,
+                     xin_num_screens;
+   bool              xin_mode;
+ #if XINERAMA_SUPPORT
+   XineramaScreenInfo  *xin_screen_info;
+ #endif
  
    GC                gc;
***************
*** 136,141 ****
  
    bool              fullScreen;
-   void toggleFullScreen(void);
  
  
  public:
--- 149,158 ----
  
    bool              fullScreen;
  
+   void  toggleFullScreen(void),
+         AdjustDisplayRatio(void),
+         AdjustXineramaScreen(void);
+   int   GetScreenWidth(void),
+         GetScreenHeight();
  
  public:



From nobody at sheep.berlios.de  Fri Mar 31 22:40:07 2006
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 31 Mar 2006 22:40:07 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.163,1.164 video-xv.c,1.47,1.48
Message-ID: <200603312040.k2VKe7t29321@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32103

Modified Files:
	CHANGELOG video-xv.c 
Log Message:
- reactivate use of source x/y offsets for Xv*PutImage(..) operations.
- date fix of Changelog


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.163
retrieving revision 1.164
diff -C2 -d -r1.163 -r1.164
*** CHANGELOG	31 Mar 2006 19:21:32 -0000	1.163
--- CHANGELOG	31 Mar 2006 20:40:31 -0000	1.164
***************
*** 2,18 ****
  2006-03-31:
     - Xinerama support (detection and build requires to run configure).
! 2005-03-21:
     - remove the image copy overhead from the ShmClient
     - catch errors on osd and xv image creation
     - support for non-shared memory xv
! 2005-03-12:
     - Fix StillPicture handling when no PES header is sent 
       (for example streamdev-server-plugin)
     - redraw video layer on OSD close in software mode
     - use OsdWidth and OsdHeight for drawing osd layer
! 2005-03-11:
     - MMX version of AYUV_to_AYUV420P()
     - shortcut for AYUV no scale OSD modes
! 2005-03-10:
     - tune some parameters to avoid unecessary rescaling/redrawing of the OSD
  2006-02-19:
--- 2,20 ----
  2006-03-31:
     - Xinerama support (detection and build requires to run configure).
!    - reactivate use of source x/y offsets for Xv*PutImage(..) operations.
!    - date fix of Changelog
! 2006-03-21:
     - remove the image copy overhead from the ShmClient
     - catch errors on osd and xv image creation
     - support for non-shared memory xv
! 2006-03-12:
     - Fix StillPicture handling when no PES header is sent 
       (for example streamdev-server-plugin)
     - redraw video layer on OSD close in software mode
     - use OsdWidth and OsdHeight for drawing osd layer
! 2006-03-11:
     - MMX version of AYUV_to_AYUV420P()
     - shortcut for AYUV no scale OSD modes
! 2006-03-10:
     - tune some parameters to avoid unecessary rescaling/redrawing of the OSD
  2006-02-19:

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.47
retrieving revision 1.48
diff -C2 -d -r1.47 -r1.48
*** video-xv.c	31 Mar 2006 19:21:32 -0000	1.47
--- video-xv.c	31 Mar 2006 20:40:31 -0000	1.48
***************
*** 1329,1333 ****
                       win, gc,
                       xv_image,
!                      0, 0,              /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
--- 1329,1333 ----
                       win, gc,
                       xv_image,
!                      sxoff, syoff,      /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
***************
*** 1338,1345 ****
                       win, gc,
                       xv_image,
!                      0, 0,              /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
!                      lwidth, lheight   /* dw, dh */
                       );
  };
--- 1338,1345 ----
                       win, gc,
                       xv_image,
!                      sxoff, syoff,      /* sx, sy */
                       swidth, sheight,   /* sw, sh */
                       lxoff,  lyoff,     /* dx, dy */
!                      lwidth, lheight    /* dw, dh */
                       );
  };



