From nobody at sheep.berlios.de  Fri Jul  1 21:22:39 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 1 Jul 2005 21:22:39 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.19,1.20
Message-ID: <200507011922.j61JMdI22605@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18032

Modified Files:
	setup-softdevice.c 
Log Message:
compile fix for PP_LIBAVCODEC deactivated in Makefile

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** setup-softdevice.c	12 Jun 2005 20:45:20 -0000	1.19
--- setup-softdevice.c	1 Jul 2005 19:22:36 -0000	1.20
***************
*** 46,58 ****
  
  /*-----------------------------------------------------------------------------
! */
! #ifdef PP_LIBAVCODEC
  char *pp_str[]={
          "none",
          "fast",
          "default",
! 	NULL
! 	};
! #endif //PP_LIBAVCODEC
  
  /* ----------------------------------------------------------------------------
--- 46,56 ----
  
  /*-----------------------------------------------------------------------------
!  */
  char *pp_str[]={
          "none",
          "fast",
          "default",
!         NULL
!       };
  
  /* ----------------------------------------------------------------------------



From nobody at sheep.berlios.de  Sun Jul  3 17:58:33 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 3 Jul 2005 17:58:33 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.42,1.43 mpeg2decoder.h,1.26,1.27
Message-ID: <200507031558.j63FwXI24202@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9594

Modified Files:
	mpeg2decoder.c mpeg2decoder.h 
Log Message:
- improve response time for 60-sec skips (clears)


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** mpeg2decoder.c	30 Jun 2005 19:40:46 -0000	1.42
--- mpeg2decoder.c	3 Jul 2005 15:58:30 -0000	1.43
***************
*** 1101,1105 ****
          if (ret < 0) {
              BUFDEB("cMpeg2Decoder Stream Error!\n");
!             usleep(10000);
              continue;
          }
--- 1101,1106 ----
          if (ret < 0) {
              BUFDEB("cMpeg2Decoder Stream Error!\n");
!             if (ThreadActive)
! 		    usleep(10000);
              continue;
          }
***************
*** 1204,1208 ****
      av_free_packet(&pkt);
    }
! 
  };
  
--- 1205,1209 ----
      av_free_packet(&pkt);
    }
!  BUFDEB("QueuePacket finished...\n");
  };
  
***************
*** 1331,1343 ****
      
      ThreadActive=false;
      StreamBuffer->Clear();
      EnableGetSignal.Signal();
      Cancel(4);
!    
      if (vout) {
        vout->Stop();
        delete(vout);
      }
! 
      if (aout) {
        aout->Stop();
--- 1332,1350 ----
      
      ThreadActive=false;
+     // prepare aout and vout for a stop
+     if (vout)
+        vout->Deactivate();
+     if (aout)
+        aout->Deactivate();
+     
      StreamBuffer->Clear();
      EnableGetSignal.Signal();
      Cancel(4);
!     CMDDEB("stopping video\n"); 
      if (vout) {
        vout->Stop();
        delete(vout);
      }
!     CMDDEB("stopping audio\n");
      if (aout) {
        aout->Stop();

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** mpeg2decoder.h	12 Jun 2005 20:45:20 -0000	1.26
--- mpeg2decoder.h	3 Jul 2005 15:58:31 -0000	1.27
***************
*** 157,160 ****
--- 157,162 ----
      virtual void      Play(void);
      virtual void      Stop();
+     virtual void      Deactivate()
+     { active = false; };
      virtual void      TrickSpeed(int Speed) {return;};
      virtual int       BufferFill(void);



From nobody at sheep.berlios.de  Sun Jul  3 17:59:52 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 3 Jul 2005 17:59:52 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.81,1.82 video-xv.c,1.27,1.28
Message-ID: <200507031559.j63FxqI24222@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9664

Modified Files:
	CHANGELOG video-xv.c 
Log Message:
- fix fullscreen mode for 64-bit architectures



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.81
retrieving revision 1.82
diff -C2 -d -r1.81 -r1.82
*** CHANGELOG	30 Jun 2005 21:46:16 -0000	1.81
--- CHANGELOG	3 Jul 2005 15:59:50 -0000	1.82
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-07-03:
+     - fix fullscreen mode for 64-bit architectures
+     - improve response time for 60-sec skips
  2005-06-30:
      - changed delay clamping low limit and printout "+" if we drop frames

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** video-xv.c	28 Jun 2005 18:07:33 -0000	1.27
--- video-xv.c	3 Jul 2005 15:59:50 -0000	1.28
***************
*** 293,296 ****
--- 293,297 ----
    if (fullScreen)
    {
+     // window -> fullscreen
        XWindowAttributes winAttr;
        Window            dummyWin;
***************
*** 322,325 ****
--- 323,327 ----
    else
    {
+     // fullscreen -> window
      x = old_x;
      y = old_y;
***************
*** 339,343 ****
    if ((wmAtom = XInternAtom (dpy, "_MOTIF_WM_HINTS", False)))
    {
!       int         mwmHints [5];
  
      mwmHints [0] = 2;
--- 341,345 ----
    if ((wmAtom = XInternAtom (dpy, "_MOTIF_WM_HINTS", False)))
    {
!     long  mwmHints [5];
  
      mwmHints [0] = 2;



From nobody at sheep.berlios.de  Fri Jul 15 22:42:18 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 15 Jul 2005 22:42:18 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.82,1.83 Makefile,1.13,1.14 README,1.7,1.8 mpeg2decoder.c,1.43,1.44 setup-softdevice.c,1.20,1.21 setup-softdevice.h,1.14,1.15 utils.c,1.5,1.6 utils.h,1.4,1.5 video-dfb.c,1.31,1.32 video-vidix.c,1.9,1.10 video.c,1.24,1.25 video.h,1.15,1.16
Message-ID: <200507152042.j6FKgII20654@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12979

Modified Files:
	CHANGELOG Makefile README mpeg2decoder.c setup-softdevice.c 
	setup-softdevice.h utils.c utils.h video-dfb.c video-vidix.c 
	video.c video.h 
Log Message:
commit patches by Vadim & Malcolm:
    - by Vadim Catana:
      - fixed a couple of compiler warnings for gcc4 on x86-64
      - the video-vidix.c and video-dfb.c both contain code
        that converts pictures from YV12 format to YUY2. I moved
        this common code to a function in utils.c .
      - Some channels display white dots at the top and bottom of
        the screen due to WSS data encoded in the picture.
        This problem has been mentioned on vdr, linux-dvb and
        dxr3 mailinglists a few times. I added two new items in
        the softdevice menu that allow to cut off a number of lines
        from top and bottom of the picture. It is implemented now
        only for -vo vidix and dfb with i420/YV12 format and hardware
        alpha blending.
    - by Malcolm Caldwell: fix for vdr segfaulting


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.82
retrieving revision 1.83
diff -C2 -d -r1.82 -r1.83
*** CHANGELOG	3 Jul 2005 15:59:50 -0000	1.82
--- CHANGELOG	15 Jul 2005 20:42:16 -0000	1.83
***************
*** 1,3 ****
--- 1,18 ----
  Changelog
+ 2005-07-15:
+     - by Vadim Catana:
+       - fixed a couple of compiler warnings for gcc4 on x86-64
+       - the video-vidix.c and video-dfb.c both contain code
+         that converts pictures from YV12 format to YUY2. I moved
+         this common code to a function in utils.c .
+       - Some channels display white dots at the top and bottom of
+         the screen due to WSS data encoded in the picture.
+         This problem has been mentioned on vdr, linux-dvb and
+         dxr3 mailinglists a few times. I added two new items in
+         the softdevice menu that allow to cut off a number of lines
+         from top and bottom of the picture. It is implemented now
+         only for -vo vidix and dfb with i420/YV12 format and hardware
+         alpha blending.
+     - by Malcolm Caldwell: fix for vdr segfaulting
  2005-07-03:
      - fix fullscreen mode for 64-bit architectures

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** Makefile	5 Jun 2005 20:58:12 -0000	1.13
--- Makefile	15 Jul 2005 20:42:16 -0000	1.14
***************
*** 162,166 ****
    ifdef USE_SUBPLUGINS
      DFB_LIBS  = -L/usr/local/lib -ldfb++
!     DFB_OBJS  = video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libvdr-$(PLUGIN)-dfb.so
--- 162,166 ----
    ifdef USE_SUBPLUGINS
      DFB_LIBS  = -L/usr/local/lib -ldfb++
!     DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
      TARGETS  += libvdr-$(PLUGIN)-dfb.so

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** README	6 Jun 2005 06:26:01 -0000	1.7
--- README	15 Jul 2005 20:42:16 -0000	1.8
***************
*** 102,105 ****
--- 102,106 ----
  - Luca Olivetti
  - Lucian Muresan
+ - Malcolm Caldwell
  - Marko M?kel?
  - Martin Wache

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** mpeg2decoder.c	3 Jul 2005 15:58:30 -0000	1.43
--- mpeg2decoder.c	15 Jul 2005 20:42:16 -0000	1.44
***************
*** 1058,1062 ****
  
  int cMpeg2Decoder::seek(offset_t offset, int whence) {
!    printf("unimplemented: seek offset %lld whence %d\n",offset,whence);
     return -EINVAL;
  };
--- 1058,1062 ----
  
  int cMpeg2Decoder::seek(offset_t offset, int whence) {
!    printf("unimplemented: seek offset %lld whence %d\n", (long long int)offset, whence);
     return -EINVAL;
  };

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** setup-softdevice.c	1 Jul 2005 19:22:36 -0000	1.20
--- setup-softdevice.c	15 Jul 2005 20:42:16 -0000	1.21
***************
*** 60,64 ****
          "I420",
          "YV12",
!         "YUV2",
          NULL
       };
--- 60,64 ----
          "I420",
          "YV12",
!         "YUY2",
          NULL
       };
***************
*** 155,158 ****
--- 155,160 ----
    cropMode      = 0;
    cropModeToggleKey = 0;
+   cropTopLines      = 0;
+   cropBottomLines   = 0;
    deintMethod   = 0;
    ppMethod   = 0;
***************
*** 225,228 ****
--- 227,240 ----
               cropModeToggleKey,
               userKeyUsage [cropModeToggleKey]);
+   } else if(!strcasecmp(Name,"CropTopLines")) {
+     cropTopLines = atoi(Value);
+     cropTopLines = clamp (0, cropTopLines, 100);
+     fprintf(stderr,"[setup-softdevice] Cropping %d lines from top\n",
+             cropTopLines);
+   } else if(!strcasecmp(Name,"CropBottomLines")) {
+     cropBottomLines = atoi(Value);
+     cropBottomLines = clamp (0, cropBottomLines, 100);
+     fprintf(stderr,"[setup-softdevice] Cropping %d lines from bottom\n",
+             cropBottomLines);
    } else if (!strcasecmp(Name,"PixelFormat")) {
      pixelFormat = atoi(Value);
***************
*** 371,374 ****
--- 383,396 ----
                              userKeyUsage));
  
+   Add(new cMenuEditIntItem(tr("Crop lines from top"),
+                             &data->cropTopLines,
+                             0,
+                             100));
+ 
+   Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
+                             &data->cropBottomLines,
+                             0,
+                             100));
+ 
    if (data->outputMethod == VOUT_FB)
    {
***************
*** 484,487 ****
--- 506,511 ----
    SetupStore ("CropMode",           setupStore.cropMode);
    SetupStore ("CropModeToggleKey",     setupStore.cropModeToggleKey);
+   SetupStore ("CropTopLines",        setupStore.cropTopLines);
+   SetupStore ("CropBottomLines",     setupStore.cropBottomLines);  
    SetupStore ("Deinterlace Method", setupStore.deintMethod);
    SetupStore ("Postprocess Method", setupStore.ppMethod);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** setup-softdevice.h	12 Jun 2005 20:45:20 -0000	1.14
--- setup-softdevice.h	15 Jul 2005 20:42:16 -0000	1.15
***************
*** 22,25 ****
--- 22,26 ----
    public:
                    cSetupStore ();
+     virtual       ~cSetupStore () {};
      bool          SetupParse(const char *Name, const char *Value);
      char          *getPPdeintValue(void);
***************
*** 36,39 ****
--- 37,42 ----
      int   cropMode;
      int   cropModeToggleKey;
+     int   cropTopLines;
+     int   cropBottomLines;
      int   deintMethod;
      int   ppMethod;

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** utils.c	26 Jun 2005 20:12:40 -0000	1.5
--- utils.c	15 Jul 2005 20:42:16 -0000	1.6
***************
*** 16,24 ****
   *
   * Author: Olie Lho <ollie at sis.com.tw>
! */    
  
  #include "utils.h"
  #include "setup-softdevice.h"
  
  #define VERT_SCALING
  void (*mmx_unpack)(uint8_t * image, int lines, int stride);
--- 16,98 ----
   *
   * Author: Olie Lho <ollie at sis.com.tw>
! */
  
  #include "utils.h"
  #include "setup-softdevice.h"
  
+ void yv12_to_yuy2(const uint8_t *ysrc, const uint8_t *usrc, const uint8_t *vsrc,
+                   uint8_t *dst, int width, int height,
+                   int lumStride, int chromStride, int dstStride)
+ {
+ #ifndef USE_MMX
+     const unsigned chromWidth = width >> 1;
+ 
+   for(int y=0; y<height; y++)
+   {
+       uint32_t *idst = (uint32_t *) dst;
+       const uint8_t *yc = ysrc, *uc = usrc, *vc = vsrc;
+ 
+     for(unsigned i = 0; i < chromWidth; i++)
+     {
+       *idst++ = (yc[0] << 0)+ (uc[0] << 8) + (yc[1] << 16) + (vc[0] << 24);
+       yc += 2;
+       uc++;
+       vc++;
+     }
+ 
+     if( (y&1) == 1)
+     {
+       usrc += chromStride;
+       vsrc += chromStride;
+     }
+ 
+     ysrc += lumStride;
+     dst  += dstStride;
+   }
+ #else
+   for (int i=0; i<height; i++)
+   {
+       const uint8_t *pu, *pv, *py;
+       uint8_t  *srfc;
+ 
+     pu = usrc;
+     pv = vsrc;
+     py = ysrc;
+ 
+     srfc = dst;
+ 
+     for (int j =0; j < width/8; j++)
+     {
+       movd_m2r(*pu, mm1);       // mm1 = 00 00 00 00 U3 U2 U1 U0
+       movd_m2r(*pv, mm2);       // mm2 = 00 00 00 00 V3 V2 V1 V0
+       movq_m2r(*py, mm0);       // mm0 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
+       punpcklbw_r2r(mm2, mm1);  // mm1 = V3 U3 V2 U2 V1 U1 V0 U0
+       movq_r2r(mm0,mm3);        // mm3 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
+       movq_r2r(mm1,mm4);        // mm4 = V3 U3 V2 U2 V1 U1 V0 U0
+       punpcklbw_r2r(mm1, mm0);  // mm0 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
+       punpckhbw_r2r(mm4, mm3);  // mm3 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
+ 
+       movntq(mm0,*srfc);        // Am Meisten brauchen die Speicherzugriffe
+       srfc+=8;
+       py+=8;
+       pu+=4;
+       pv+=4;
+       movntq(mm3,*srfc);      // wenn movntq nicht geht, dann movq verwenden
+       srfc+=8;
+     }
+ 
+     ysrc += lumStride;;
+ 
+     if (i % 2 == 1)
+     {
+       usrc += chromStride;
+       vsrc += chromStride;
+     }
+ 
+     dst += dstStride;
+   }
+ #endif
+ }
+ 
  #define VERT_SCALING
  void (*mmx_unpack)(uint8_t * image, int lines, int stride);
***************
*** 325,329 ****
  #define MMREG_SIZE 64
  #define BLOCK_SIZE 4096
! #define REG_a "eax"
  #define CONFUSION_FACTOR 0
  
--- 399,409 ----
  #define MMREG_SIZE 64
  #define BLOCK_SIZE 4096
! 
! #ifdef __x86_64__
! # define  REG_a "rax"
! #else
! # define  REG_a "eax"
! #endif
! 
  #define CONFUSION_FACTOR 0
  
***************
*** 342,346 ****
  }
  
!  void * fast_memcpy(void * to, const void * from, size_t len)
  {
  	void *retval;
--- 422,426 ----
  }
  
! void * fast_memcpy(void * to, const void * from, size_t len)
  {
  	void *retval;
***************
*** 381,385 ****
  
  	// Align destination at BLOCK_SIZE boundary
! 	for(; ((int)to & (BLOCK_SIZE-1)) && i>0; i--)
  	{
  		__asm__ __volatile__ (
--- 461,465 ----
  
  	// Align destination at BLOCK_SIZE boundary
! 	for(; ((long)to & (BLOCK_SIZE-1)) && i>0; i--)
  	{
  		__asm__ __volatile__ (
***************
*** 513,516 ****
  	return retval;
  }
- 
- 
--- 593,594 ----

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** utils.h	12 Jun 2005 20:45:20 -0000	1.4
--- utils.h	15 Jul 2005 20:42:16 -0000	1.5
***************
*** 20,27 ****
  #endif
  
! /*    else			\
! 	movq_r2m (src, dest);	\
! } while (0)
! */
  void yuv_to_rgb (uint8_t * image, uint8_t * py,
                   uint8_t * pu, uint8_t * pv,
--- 20,34 ----
  #endif
  
! void yv12_to_yuy2( const uint8_t *ysrc,
!                    const uint8_t *usrc,
!                    const uint8_t *vsrc,
!                    uint8_t *dst,
!                    int width,
!                    int height,
!                    int lumStride,
!                    int chromStride,
!                    int dstStride
!                  );
! 
  void yuv_to_rgb (uint8_t * image, uint8_t * py,
                   uint8_t * pu, uint8_t * pv,

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** video-dfb.c	30 Jun 2005 21:46:16 -0000	1.31
--- video-dfb.c	15 Jul 2005 20:42:16 -0000	1.32
***************
*** 582,590 ****
    if (videoLayer || useStretchBlit)
    {
!     if (!videoSurface ||
!         aspect_changed ||
!         currentPixelFormat != setupStore->pixelFormat)
      {
  
        fprintf(stderr,
                "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
--- 582,594 ----
    if (videoLayer || useStretchBlit)
    {
!     if ( ! videoSurface || aspect_changed ||
!         currentPixelFormat != setupStore->pixelFormat ||
!         cutTop != setupStore->cropTopLines ||
!         cutBottom != setupStore->cropBottomLines )
      {
  
+       cutTop    = setupStore->cropTopLines;
+       cutBottom = setupStore->cropBottomLines;
+ 
        fprintf(stderr,
                "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
***************
*** 795,799 ****
          }
  
-         videoSurface=NULL;
          videoSurface=dfb->CreateSurface(vidDsc);
        }
--- 799,802 ----
***************
*** 1010,1019 ****
    {
  #if HAVE_SetSourceLocation
!     for(hi=0; hi < Height; hi++){
        memcpy(dst, Py, Width);
        Py  += Ystride;
        dst += pitch;
      }
!     for(hi=0; hi < Height/2; hi++) {
        memcpy(dst, Pu, Width/2);
        Pu  += UVstride;
--- 1013,1031 ----
    {
  #if HAVE_SetSourceLocation
!     Py += Ystride  * cutTop * 2;
!     Pv += UVstride * cutTop;
!     Pu += UVstride * cutTop;
! 
!     dst += pitch * cutTop * 2;
! 
!     for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
        memcpy(dst, Py, Width);
        Py  += Ystride;
        dst += pitch;
      }
! 
!     dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
! 
!     for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
        memcpy(dst, Pu, Width/2);
        Pu  += UVstride;
***************
*** 1021,1025 ****
      }
  
!     for(hi=0; hi < Height/2; hi++) {
        memcpy(dst, Pv, Width/2);
        Pv  += UVstride;
--- 1033,1039 ----
      }
  
!     dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
! 
!     for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
        memcpy(dst, Pv, Width/2);
        Pv  += UVstride;
***************
*** 1027,1041 ****
      }
  #else
  
!     Py += (Ystride * syoff);
!     Pv += (UVstride * syoff/2);
!     Pu += (UVstride * syoff/2);
  
!     for(hi=0; hi < sheight; hi++){
        memcpy(dst, Py+sxoff, swidth);
        Py  += Ystride;
        dst += pitch;
      }
!     for(hi=0; hi < sheight/2; hi++) {
        memcpy(dst, Pu+sxoff/2, swidth/2);
        Pu  += UVstride;
--- 1041,1059 ----
      }
  #else
+     Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
+     Pv += (UVstride * syoff/2) + UVstride * cutTop;
+     Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!     dst += pitch * cutTop * 2;
  
!     for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
        memcpy(dst, Py+sxoff, swidth);
        Py  += Ystride;
        dst += pitch;
      }
! 
!     dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
! 
!     for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
        memcpy(dst, Pu+sxoff/2, swidth/2);
        Pu  += UVstride;
***************
*** 1043,1047 ****
      }
  
!     for(hi=0; hi < sheight/2; hi++) {
        memcpy(dst, Pv+sxoff/2, swidth/2);
        Pv  += UVstride;
--- 1061,1067 ----
      }
  
!     dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
! 
!     for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
        memcpy(dst, Pv+sxoff/2, swidth/2);
        Pv  += UVstride;
***************
*** 1051,1107 ****
    } else if (pixelformat == DSPF_YUY2) {
  
! #ifndef USE_MMX
! //#if 1
!     /* reference implementation */
!       int p = pitch - Width*2;
!     for (int i=0; i<Height; i++) {
!       for (int j =0; j < Width/2; j++) {
!         *dst = *(Py + (j*2) + i * Ystride);
!         dst +=1;
!         *dst = *(Pu + j + (i/2) * UVstride);
!         dst +=1;
!         *dst = *(Py + (j*2)+1 + i * Ystride);
!         dst +=1;
!         *dst = *(Pv + j + (i/2) * UVstride);
!         dst +=1;
!       }
!       dst +=p;
!     }
! #else
!     /* deltas */
!     for (int i=0; i<Height; i++) {
!         uint8_t *pu, *pv, *py, *srfc;
! 
!       pu = Pu;
!       pv = Pv;
!       py = Py;
!       srfc = dst;
!       for (int j =0; j < Width/8; j++) {
!         movd_m2r(*pu, mm1);       // mm1 = 00 00 00 00 U3 U2 U1 U0
!         movd_m2r(*pv, mm2);       // mm2 = 00 00 00 00 V3 V2 V1 V0
!         movq_m2r(*py, mm0);       // mm0 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
!         punpcklbw_r2r(mm2, mm1);  // mm1 = V3 U3 V2 U2 V1 U1 V0 U0
!         movq_r2r(mm0,mm3);        // mm3 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
!         movq_r2r(mm1,mm4);        // mm4 = V3 U3 V2 U2 V1 U1 V0 U0
!         punpcklbw_r2r(mm1, mm0);  // mm0 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
!         punpckhbw_r2r(mm4, mm3);  // mm3 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
! 
!         movntq(mm0,*srfc);        // Am Meisten brauchen die Speicherzugriffe
!         srfc+=8;
!         py+=8;
!         pu+=4;
!         pv+=4;
!         movntq(mm3,*srfc);      // wenn movntq nicht geht, dann movq verwenden
!         srfc+=8;
!       }
!       Py += Ystride;;
!       if (i % 2 == 1) {
!         Pu += UVstride;
!         Pv += UVstride;
!       }
!       dst += pitch;
!     }
! #endif
    }
    videoSurface->Unlock();
  
--- 1071,1082 ----
    } else if (pixelformat == DSPF_YUY2) {
  
!     yv12_to_yuy2(Py + Ystride  * cutTop * 2,
!                  Pu + UVstride * cutTop,
!                  Pv + UVstride * cutTop,
!                  dst + pitch * cutTop * 2,
!                  Width, Height - 2 * (cutTop + cutBottom),
!                  Ystride, UVstride, pitch);
    }
+ 
    videoSurface->Unlock();
  

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-vidix.c	5 Jun 2005 20:58:12 -0000	1.9
--- video-vidix.c	15 Jul 2005 20:42:16 -0000	1.10
***************
*** 134,138 ****
      printf("cVidixVideoOut: vidix version: %i\n", vidix_version);
  
!     vidix_handler = vdlOpen(VIDIX_DIR, NULL, TYPE_OUTPUT, 1);
  
      if( !vidix_handler )
--- 134,138 ----
      printf("cVidixVideoOut: vidix version: %i\n", vidix_version);
  
!     vidix_handler = vdlOpen(VIDIX_DIR, NULL, TYPE_OUTPUT, 0);
  
      if( !vidix_handler )
***************
*** 162,166 ****
      screenPixelAspect = -1;
  
-     vdlQueryFourcc(vidix_handler, &vidix_fourcc);
      if (vdlQueryFourcc(vidix_handler, &vidix_fourcc))
      {
--- 162,165 ----
***************
*** 313,320 ****
      uint8_t *dst;
      int hi, wi;
      START;
      TIMINGS("start...\n");
!     if (aspect_changed || currentPixelFormat != setupStore->pixelFormat)
      {
         printf("cVidixVideoOut: Video changed format to %dx%d\n", Width, Height);
  
--- 312,324 ----
      uint8_t *dst;
      int hi, wi;
+     
      START;
      TIMINGS("start...\n");
!     if (aspect_changed || currentPixelFormat != setupStore->pixelFormat ||
!         cutTop != setupStore->cropTopLines || cutBottom != setupStore->cropBottomLines )
      {
+        cutTop    = setupStore->cropTopLines;
+        cutBottom = setupStore->cropBottomLines;
+     
         printf("cVidixVideoOut: Video changed format to %dx%d\n", Width, Height);
  
***************
*** 401,418 ****
      {
  #if VDRVERSNUM >= 10307
!       if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
          for(hi=0; hi < sheight; hi++){
!           AlphaBlend(dst,OsdPy+hi*OSD_FULL_WIDTH,
!               Py + sxoff,
!               OsdPAlphaY+hi*OSD_FULL_WIDTH,swidth);
            Py  += Ystride;
            dst += dstrides.y;
  
          }
-         EMMS;
        } else
  #endif
  
!         for(hi=0; hi < sheight; hi++){
            memcpy(dst, Py+sxoff, swidth);
            Py  += Ystride;
--- 405,446 ----
      {
  #if VDRVERSNUM >= 10307
! 	if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE)
! 	{
          for(hi=0; hi < sheight; hi++){
! 		AlphaBlend(dst, OsdPy+hi*OSD_FULL_WIDTH, Py + sxoff, OsdPAlphaY+hi*OSD_FULL_WIDTH, swidth);
            Py  += Ystride;
            dst += dstrides.y;
+ 	    }
+ 	    
+ 	    // Plane U
+ 	    dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
+ 	    for(hi=0; hi < sheight/2; hi++){
+ 		    AlphaBlend(dst,OsdPu+hi*OSD_FULL_WIDTH/2, Pu + sxoff/2, OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,swidth/2);
+ 		    Pu  += UVstride;
+ 		    dst += dstrides.y / 2;
+ 	    }
  
+ 	    // Plane V
+ 	    dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
+ 	    for(hi=0; hi < sheight/2; hi++) {
+ 		    AlphaBlend(dst, OsdPv+hi*OSD_FULL_WIDTH/2, Pv + sxoff/2, OsdPAlphaUV+hi*OSD_FULL_WIDTH/2, swidth/2);
+ 		    Pv  += UVstride;
+ 		    dst += dstrides.v / 2;
          }
        } else
  #endif
+ 	{	
+ 	    int chromaWidth  = swidth >> 1;
+ 	    int chromaOffset = sxoff >> 1;
  
! 	    Py += Ystride  * cutTop * 2;
! 	    Pv += UVstride * cutTop;
! 	    Pu += UVstride * cutTop;
! 
! 	    dst += dstrides.y * cutTop * 2;
! 
! 
! 	    for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++)
! 	    {
            memcpy(dst, Py+sxoff, swidth);
            Py  += Ystride;
***************
*** 424,537 ****
        if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
        {
!         dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
  
!         for(hi = 0; hi < sheight/2; hi++) {
!           for(wi = 0; wi < swidth/2; wi++) {
!             dst[2*wi+0] = Pu[wi+sxoff/2];
!             dst[2*wi+1] = Pv[wi+sxoff/2];
            }
  
!           dst += dstrides.y;
            Pu += UVstride;
            Pv += UVstride;
          }
        } else {
  
          // Plane U
!         dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
  
! #if VDRVERSNUM >= 10307
!         if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!           for(hi=0; hi < sheight/2; hi++){
!             AlphaBlend(dst,OsdPu+hi*OSD_FULL_WIDTH/2,
!                Pu + sxoff/2,
!                OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,swidth/2);
              Pu  += UVstride;
!             dst += dstrides.y / 2;
            }
  
            // Plane V
!           dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!           for(hi=0; hi < sheight/2; hi++) {
!             AlphaBlend(dst, OsdPv+hi*OSD_FULL_WIDTH/2,
!                    Pv + sxoff/2,
!                    OsdPAlphaUV+hi*OSD_FULL_WIDTH/2, swidth/2);
!             Pv  += UVstride;
!             dst += dstrides.v / 2;
!           }
  
!           EMMS;
!         } else
! #endif
          {
!           for(hi=0; hi < sheight/2; hi++) {
!             memcpy(dst, Pu+sxoff/2, swidth/2);
!             Pu   += UVstride;
!             dst += dstrides.u / 2;
!           }
! 
!           // Plane V
!           dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
!           for(hi=0; hi < sheight/2; hi++) {
!             memcpy(dst, Pv+sxoff/2, swidth/2);
              Pv   += UVstride;
!             dst += dstrides.v / 2;
            }
-         }
-       }
-     } else if (currentPixelFormat == 2) {
- 
- #ifndef USE_MMX
  
-       /* reference implementation */
-       //int p = vidix_play.src.pitch.y - Width*2;
-       for (int i=0; i<Height; i++) {
-         for (int j =0; j < Width/2; j++) {
-           *dst = *(Py + (j*2) + i * Ystride);
-           dst +=1;
-           *dst = *(Pu + j + (i/2) * UVstride);
-           dst +=1;
-           *dst = *(Py + (j*2)+1 + i * Ystride);
-           dst +=1;
-           *dst = *(Pv + j + (i/2) * UVstride);
-           dst +=1;
          }
-         //dst +=p;
        }
! #else
!       /* deltas */
!       for (int i=0; i<Height; i++) {
!           uint8_t *pu, *pv, *py, *srfc;
! 
!         pu = Pu;
!         pv = Pv;
!         py = Py;
!         srfc = dst;
!         for (int j =0; j < Width/8; j++) {
!           movd_m2r(*pu, mm1);       // mm1 = 00 00 00 00 U3 U2 U1 U0
!           movd_m2r(*pv, mm2);       // mm2 = 00 00 00 00 V3 V2 V1 V0
!           movq_m2r(*py, mm0);       // mm0 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
!           punpcklbw_r2r(mm2, mm1);  // mm1 = V3 U3 V2 U2 V1 U1 V0 U0
!           movq_r2r(mm0,mm3);        // mm3 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0
!           movq_r2r(mm1,mm4);        // mm4 = V3 U3 V2 U2 V1 U1 V0 U0
!           punpcklbw_r2r(mm1, mm0);  // mm0 = V1 Y3 U1 Y2 V0 Y1 U0 Y0
!           punpckhbw_r2r(mm4, mm3);  // mm3 = V3 Y7 U3 Y6 V2 Y5 U2 Y4
  
!           movntq(mm0,*srfc);        // Am Meisten brauchen die Speicherzugriffe
!           srfc+=8;
!           py+=8;
!           pu+=4;
!           pv+=4;
!           movntq(mm3,*srfc);      // wenn movntq nicht geht, dann movq verwenden
!           srfc+=8;
!         }
!         Py += Ystride;;
!         if (i % 2 == 1) {
!           Pu += UVstride;
!           Pv += UVstride;
!         }
!         dst += Width*2;
!       }
! #endif
      }
  
--- 452,506 ----
        if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
        {
! 		int dstStride = dstrides.v << 1;
! 		dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v + dstStride * cutTop;
  
! 		for(hi = cutTop; hi < sheight/2; hi++)
! 		{
! 		    uint16_t *idst = (uint16_t *) dst;
! 		    uint8_t  *usrc = Pu + chromaOffset, *vsrc = Pv + chromaOffset;
! 
! 		    for(wi = 0; wi < chromaWidth; wi++)
! 		    {
! 			*idst++ = ( usrc[0] << 8 ) + vsrc[0];
! 			usrc++;
! 			vsrc++;
            }
  
! 		    dst += dstStride;
            Pu += UVstride;
            Pv += UVstride;
          }
+ 
        } else {
  
+ 		int dstStride;
+ 		
          // Plane U
! 		dstStride = dstrides.u >> 1;		
! 		dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u + dstStride * cutTop;
  
! 		for(hi=cutTop; hi < sheight/2 - cutBottom; hi++)
! 		{
!     		    memcpy(dst, Pu+chromaOffset, chromaWidth);
              Pu  += UVstride;
! 		    dst += dstStride;
            }
  
            // Plane V
! 		dstStride = dstrides.v >> 1;
! 		dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v + dstStride * cutTop;
  
! 		for(hi=cutTop; hi < sheight/2 - cutBottom; hi++)
          {
!     		    memcpy(dst, Pv+chromaOffset, chromaWidth);
              Pv   += UVstride;
! 		    dst += dstStride;
            }
  
          }
        }
!     } else if (currentPixelFormat == 2) {
  
! 	yv12_to_yuy2(Py, Pu, Pv, dst, Width, Height, Ystride, UVstride, dstrides.y*2);
      }
  

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** video.c	30 Jun 2005 21:46:16 -0000	1.24
--- video.c	15 Jul 2005 20:42:16 -0000	1.25
***************
*** 23,26 ****
--- 23,28 ----
  #endif
    sxoff = syoff = lxoff = lyoff = 0;
+   cutTop = cutBottom = 0;
+   OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
    PixelMask=NULL;
    OsdRefreshCounter=0;
***************
*** 758,761 ****
--- 760,764 ----
                  dest+=8;
         }
+        EMMS;
  #endif //USE_MMX
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** video.h	30 Jun 2005 21:20:55 -0000	1.15
--- video.h	15 Jul 2005 20:42:16 -0000	1.16
***************
*** 92,95 ****
--- 92,96 ----
              current_aspect,
              currentPixelFormat,
+             cutTop, cutBottom,
              aspect_changed,
              current_afd,



From nobody at sheep.berlios.de  Sat Jul 16 14:52:07 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 16 Jul 2005 14:52:07 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.83,1.84 video-dfb.c,1.32,1.33
Message-ID: <200507161252.j6GCq7I11390@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5111

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
- fix for cropBottom in dfb with YUY2 pixelformat
- some preparations for configure in video-dfb.c


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.83
retrieving revision 1.84
diff -C2 -d -r1.83 -r1.84
*** CHANGELOG	15 Jul 2005 20:42:16 -0000	1.83
--- CHANGELOG	16 Jul 2005 12:52:04 -0000	1.84
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-07-16:
+     - fix for cropBottom in dfb with YUY2 pixelformat
+     - some preparations for configure in video-dfb.c
  2005-07-15:
      - by Vadim Catana:

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** video-dfb.c	15 Jul 2005 20:42:16 -0000	1.32
--- video-dfb.c	16 Jul 2005 12:52:04 -0000	1.33
***************
*** 15,19 ****
  #include "setup-softdevice.h"
  
! #define HAVE_SetSourceLocation 0
  
  //#define COLORKEY 17,8,79
--- 15,33 ----
  #include "setup-softdevice.h"
  
! #ifdef HAVE_CONFIG
! # include "config.h"
! #else
! # define HAVE_SetSourceLocation 0
! # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
! #   define GraphicsDeviceDescription 0
! # else
! #   define GraphicsDeviceDescription 1
! # endif
! # if (DIRECTFB_MAJOR_VERSION > 0 || ((DIRECTFB_MINOR_VERSION == 9) && DIRECTFB_MICRO_VERSION > 22))
! #   define HAVE_DSCAPS_DOUBLE 1
! # else
! #   define HAVE_DSCAPS_DOUBLE 0
! # endif
! #endif
  
  //#define COLORKEY 17,8,79
***************
*** 157,168 ****
  static void reportCardInfo (IDirectFB *dfb)
  {
! #if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
!     DFBCardCapabilities           caps;
! 
!   dfb->GetCardCapabilities(&caps);
! #else
      DFBGraphicsDeviceDescription  caps;
  
    dfb->GetDeviceDescription(&caps);
  #endif
  
--- 171,182 ----
  static void reportCardInfo (IDirectFB *dfb)
  {
! #if HAVE_GraphicsDeviceDescription
      DFBGraphicsDeviceDescription  caps;
  
    dfb->GetDeviceDescription(&caps);
+ #else
+     DFBCardCapabilities           caps;
+ 
+   dfb->GetCardCapabilities(&caps);
  #endif
  
***************
*** 636,640 ****
        dlc.options       = DLOP_FIELD_PARITY;
  
! #if (DIRECTFB_MAJOR_VERSION > 0 || ((DIRECTFB_MINOR_VERSION == 9) && DIRECTFB_MICRO_VERSION > 22))
        dlc.flags = (DFBDisplayLayerConfigFlags)
                        ((int) dlc.flags | DLCONF_SURFACE_CAPS);
--- 650,654 ----
        dlc.options       = DLOP_FIELD_PARITY;
  
! #if HAVE_DSCAPS_DOUBLE
        dlc.flags = (DFBDisplayLayerConfigFlags)
                        ((int) dlc.flags | DLCONF_SURFACE_CAPS);
***************
*** 800,803 ****
--- 814,837 ----
  
          videoSurface=dfb->CreateSurface(vidDsc);
+         /* --------------------------------------------------------------------
+          * Here is probably a bug in DirectFB, as Clear() does _not_ work
+          * the same, as manual wipe out YUY2 surface. I tried Clear() on my
+          * tests, but it did not solve the problem. That happens with my
+          * Matrox G550.
+          * videoSurface->Clear(0,0,0,0);
+          * The workaround code assumes that in case of stretchBlit, pixelformat
+          * YUY2 is used.
+          */
+         {
+             int     *dst, i, j;
+             int     pitch;
+ 
+           videoSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch);
+           for(i = 0; i < vidDsc.height; ++i, dst += pitch/4)
+             for (j = 0; j < vidDsc.width / 2; ++j)
+               dst [j] = 0x80008000;
+           videoSurface->Unlock();
+         }
+ 
        }
        reportSurfaceCapabilities ("videoSurface", videoSurface);



From nobody at sheep.berlios.de  Sun Jul 17 00:37:21 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 17 Jul 2005 00:37:21 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.84,1.85 utils.c,1.6,1.7
Message-ID: <200507162237.j6GMXAI27453@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28741

Modified Files:
	CHANGELOG utils.c 
Log Message:
some preparations for configure in utils.c

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.84
retrieving revision 1.85
diff -C2 -d -r1.84 -r1.85
*** CHANGELOG	16 Jul 2005 12:52:04 -0000	1.84
--- CHANGELOG	16 Jul 2005 22:33:08 -0000	1.85
***************
*** 3,6 ****
--- 3,7 ----
      - fix for cropBottom in dfb with YUY2 pixelformat
      - some preparations for configure in video-dfb.c
+     - some preparations for configure in utils.c
  2005-07-15:
      - by Vadim Catana:

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** utils.c	15 Jul 2005 20:42:16 -0000	1.6
--- utils.c	16 Jul 2005 22:33:08 -0000	1.7
***************
*** 21,24 ****
--- 21,30 ----
  #include "setup-softdevice.h"
  
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #else
+ # define  HAVE_BROKEN_GCC_CPP  0
+ #endif
+ 
  void yv12_to_yuy2(const uint8_t *ysrc, const uint8_t *usrc, const uint8_t *vsrc,
                    uint8_t *dst, int width, int height,
***************
*** 547,551 ****
--- 553,561 ----
  				: "+r" (from), "+r" (to), "+r" (i)
  				: "r" ((long)BLOCK_SIZE), "i" (BLOCK_SIZE/64), "i" ((long)CONFUSION_FACTOR)
+ #if HAVE_BROKEN_GCC_CPP
+ 				: "%eax", "%ebx"
+ #else
  				: "%"REG_a, "%ebx"
+ #endif
  		);
  



From nobody at sheep.berlios.de  Sun Jul 17 09:39:53 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 17 Jul 2005 09:39:53 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.85,1.86 video-xv.c,1.28,1.29
Message-ID: <200507170739.j6H7drI07170@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2269

Modified Files:
	CHANGELOG video-xv.c 
Log Message:
crop Top/Bottom for xv-out

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.85
retrieving revision 1.86
diff -C2 -d -r1.85 -r1.86
*** CHANGELOG	16 Jul 2005 22:33:08 -0000	1.85
--- CHANGELOG	17 Jul 2005 07:39:50 -0000	1.86
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-07-17:
+     - crop Top/Bottom for xv-out
  2005-07-16:
      - fix for cropBottom in dfb with YUY2 pixelformat

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** video-xv.c	3 Jul 2005 15:59:50 -0000	1.28
--- video-xv.c	17 Jul 2005 07:39:50 -0000	1.29
***************
*** 1264,1271 ****
      return;
  
!   if (aspect_changed)
    {
      XClearArea (dpy, win, 0, 0, 0, 0, True);
      aspect_changed = 0;
    }
  
--- 1264,1278 ----
      return;
  
!   if (aspect_changed ||
!       cutTop != setupStore->cropTopLines ||
!       cutBottom != setupStore->cropBottomLines)
    {
      XClearArea (dpy, win, 0, 0, 0, 0, True);
      aspect_changed = 0;
+     cutTop = setupStore->cropTopLines;
+     cutBottom = setupStore->cropBottomLines;
+     memset (pixels [0], 0, xvWidth*xvHeight);
+     memset (pixels [1], 128, xvWidth*xvHeight/4);
+     memset (pixels [2], 128, xvWidth*xvHeight/4);
    }
  
***************
*** 1282,1286 ****
    // if (0) {
    if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         for (int i = 0; i < fheight; i++)
          {
            AlphaBlend(pixels[0]+i*xvWidth,OsdPy+i*OSD_FULL_WIDTH,
--- 1289,1293 ----
    // if (0) {
    if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE) {
!         for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
          {
            AlphaBlend(pixels[0]+i*xvWidth,OsdPy+i*OSD_FULL_WIDTH,
***************
*** 1288,1293 ****
              OsdPAlphaY+i*OSD_FULL_WIDTH,fwidth);
          }
!  
!         for (int i = 0; i < fheight / 2; i++)
          {
            AlphaBlend(pixels[1]+i*xvWidth/2,
--- 1295,1300 ----
              OsdPAlphaY+i*OSD_FULL_WIDTH,fwidth);
          }
! 
!         for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
          {
            AlphaBlend(pixels[1]+i*xvWidth/2,
***************
*** 1296,1300 ****
          }
  
!         for (int i = 0; i < fheight / 2; i++)
          {
            AlphaBlend(pixels[2]+i*xvWidth/2,
--- 1303,1307 ----
          }
  
!         for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
          {
            AlphaBlend(pixels[2]+i*xvWidth/2,
***************
*** 1321,1329 ****
   {
  
!           for (int i = 0; i < fheight; i++)
               fast_memcpy(pixels [0] + i * xvWidth, Py + i * Ystride, fwidth);
!           for (int i = 0; i < fheight / 2; i++)
               fast_memcpy (pixels [1] + i * xvWidth / 2, Pv + i * UVstride, fwidth / 2);
!           for (int i = 0; i < fheight / 2; i++)
               fast_memcpy (pixels [2] + i * xvWidth / 2, Pu + i * UVstride, fwidth / 2);
  
--- 1328,1336 ----
   {
  
!           for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
               fast_memcpy(pixels [0] + i * xvWidth, Py + i * Ystride, fwidth);
!           for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
               fast_memcpy (pixels [1] + i * xvWidth / 2, Pv + i * UVstride, fwidth / 2);
!           for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
               fast_memcpy (pixels [2] + i * xvWidth / 2, Pu + i * UVstride, fwidth / 2);
  



From nobody at sheep.berlios.de  Sun Jul 17 11:10:40 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Jul 2005 11:10:40 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.86,1.87 mpeg2decoder.c,1.44,1.45 mpeg2decoder.h,1.27,1.28
Message-ID: <200507170910.j6H9AeI08639@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5974

Modified Files:
	CHANGELOG mpeg2decoder.c mpeg2decoder.h 
Log Message:
-introduce color space conversions (by Malcom Caldwell)
-fix filters to work with 422 color space as well



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.86
retrieving revision 1.87
diff -C2 -d -r1.86 -r1.87
*** CHANGELOG	17 Jul 2005 07:39:50 -0000	1.86
--- CHANGELOG	17 Jul 2005 09:10:38 -0000	1.87
***************
*** 2,5 ****
--- 2,7 ----
  2005-07-17:
      - crop Top/Bottom for xv-out
+     - introduce colour space conversion (by Malcom Caldwell)
+     - make filters work with YUV422 color space
  2005-07-16:
      - fix for cropBottom in dfb with YUY2 pixelformat

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** mpeg2decoder.c	15 Jul 2005 20:42:16 -0000	1.44
--- mpeg2decoder.c	17 Jul 2005 09:10:38 -0000	1.45
***************
*** 430,434 ****
  {
    width = height = -1;
!   pic_buf_lavc = pic_buf_mirror = pic_buf_pp = NULL;
    currentMirrorMode  = setupStore.mirror;
    currentDeintMethod = setupStore.deintMethod;
--- 430,435 ----
  {
    width = height = -1;
!   pix_fmt = PIX_FMT_NB;
!   pic_buf_lavc = pic_buf_mirror = pic_buf_pp = pic_buf_convert = NULL;
    currentMirrorMode  = setupStore.mirror;
    currentDeintMethod = setupStore.deintMethod;
***************
*** 546,551 ****
      if (setupStore.mirror == 1)
        Mirror();
-     else if (pic_buf_mirror)
-       pic_buf_mirror = freePicBuf(pic_buf_mirror);
  
      if (setupStore.deintMethod == 1)
--- 547,550 ----
***************
*** 560,565 ****
--- 559,571 ----
  #endif //PP_LIBAVCODEC
  
+     // do format conversions if necessary
+     if (context->pix_fmt!=PIX_FMT_YUV420P) 
+       libavcodec_img_convert();
+ 
      width  = context->width;
      height = context->height;
+     pix_fmt = context->pix_fmt;
+ 
+    
      // find decoded pictures pts value
      int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
***************
*** 681,704 ****
  }
  
- 
  //------------------------------------ postproc stuff -------------------------
! uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf)
  {
    // (re)allocate picture buffer for deinterlaced/mirrored picture
    if (pic_buf == NULL)
      fprintf(stderr,
!             "[softdevice] allocating picture buffer for resolution %dx%d\n",
!             context->width, context->height);
    else
      fprintf(stderr,
!             "[softdevice] resolution changed to %dx%d - "
              "reallocating picture buffer\n",
!             context->width, context->height);
  
!   pic_buf = (uchar *)realloc(pic_buf,
!                              context->width *
!                               context->height *
!                                 sizeof(uchar) *
!                                   3 / 2);
  
    return pic_buf;
--- 687,707 ----
  }
  
  //------------------------------------ postproc stuff -------------------------
! uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt)
  {
    // (re)allocate picture buffer for deinterlaced/mirrored picture
    if (pic_buf == NULL)
      fprintf(stderr,
!             "[softdevice] allocating picture buffer for resolution %dx%d "
! 	    "format %d\n",
!             context->width, context->height, pix_fmt);
    else
      fprintf(stderr,
!             "[softdevice] resolution changed to %dx%d, format %d - "
              "reallocating picture buffer\n",
!             context->width, context->height, pix_fmt);
  
!   pic_buf = (uchar *) realloc(pic_buf,
!       avpicture_get_size(pix_fmt, context->width, context->height));
  
    return pic_buf;
***************
*** 720,771 ****
    if (pic_buf_lavc == NULL ||
        context->width != width ||
!       context->height != height)
!     pic_buf_lavc = allocatePicBuf(pic_buf_lavc);
! 
!   if (pic_buf_lavc)
!   {
!     avpic_dest.data[0] = pic_buf_lavc;
!     avpic_dest.data[1] = avpic_dest.data[0] + context->width * context->height;
!     avpic_dest.data[2] = avpic_dest.data[1] + context->width * context->height / 4;
! 
!     avpic_dest.linesize[0] = context->width;
!     avpic_dest.linesize[1] = context->width / 2;
!     avpic_dest.linesize[2] = context->width / 2;
! 
!     avpic_src.data[0]     = picture->data[0];
!     avpic_src.data[1]     = picture->data[1];
!     avpic_src.data[2]     = picture->data[2];
! 
!     avpic_src.linesize[0] = picture->linesize[0];
!     avpic_src.linesize[1] = picture->linesize[1];
!     avpic_src.linesize[2] = picture->linesize[2];
  
!     if (avpicture_deinterlace(&avpic_dest, &avpic_src, context->pix_fmt,
!                               context->width, context->height) < 0)
!     {
!       fprintf(stderr,
!               "[softdevice] error, libavcodec deinterlacer failure\n"
!               "[softdevice] switching deinterlacing off !\n");
!       setupStore.deintMethod = 0;
!     }
!     else
!     {
!       picture->data[0]     = avpic_dest.data[0];
!       picture->data[1]     = avpic_dest.data[1];
!       picture->data[2]     = avpic_dest.data[2];
  
!       picture->linesize[0] = avpic_dest.linesize[0];
!       picture->linesize[1] = avpic_dest.linesize[1];
!       picture->linesize[2] = avpic_dest.linesize[2];
!     }
  
!   }
!   else
    {
      fprintf(stderr,
!             "[softdevice] no picture buffer is allocated for deinterlacing !\n"
              "[softdevice] switching deinterlacing off !\n");
      setupStore.deintMethod = 0;
    }
  }
  
--- 723,790 ----
    if (pic_buf_lavc == NULL ||
        context->width != width ||
!       context->height != height ||
!       context->pix_fmt != pix_fmt)
!     pic_buf_lavc = allocatePicBuf(pic_buf_lavc,context->pix_fmt);
  
!   if ( !pic_buf_lavc ) {
!     fprintf(stderr,
!             "[softdevice] no picture buffer is allocated for deinterlacing !\n"
!             "[softdevice] switching deinterlacing off !\n");
!     setupStore.deintMethod = 0;
!     return;
!   }
!   
!   avpicture_fill(&avpic_dest,pic_buf_lavc,
!                     context->pix_fmt,context->width ,context->height);
  
!   memcpy(avpic_src.data,picture->data,sizeof(avpic_src.data));
!   memcpy(avpic_src.linesize,picture->linesize,sizeof(avpic_src.linesize));
  
!   if (avpicture_deinterlace(&avpic_dest, &avpic_src, context->pix_fmt,
!                               context->width, context->height) < 0) 
    {
      fprintf(stderr,
!             "[softdevice] error, libavcodec deinterlacer failure\n"
              "[softdevice] switching deinterlacing off !\n");
      setupStore.deintMethod = 0;
+     return;
+   } 
+     
+   memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
+   memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
+ }
+ 
+ void cVideoStreamDecoder::libavcodec_img_convert(void)
+ {
+   if (pic_buf_convert == NULL ||
+       context->width != width ||
+       context->height != height) {
+     pic_buf_convert = allocatePicBuf(pic_buf_convert,PIX_FMT_YUV420P);
+     fprintf(stderr,"allocated convert buf\n");
+   }
+ 
+   if ( !pic_buf_convert ) {
+      fprintf(stderr,
+             "[softdevice] no picture buffer is allocated for img_convert !\n"
+             "[softdevice] switching img_convert off !\n");
+      return;
    }
+  
+   avpicture_fill(&avpic_dest,pic_buf_convert,
+                     PIX_FMT_YUV420P,context->width ,context->height);
+ 
+   memcpy(avpic_src.data,picture->data,sizeof(avpic_src.data));
+   memcpy(avpic_src.linesize,picture->linesize,sizeof(avpic_src.linesize));
+   
+   if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
+ 		  &avpic_src, context->pix_fmt,
+                               context->width, context->height) < 0) {
+      fprintf(stderr,
+               "[softdevice] error, libavcodec img_convert failure\n");
+      return;
+   } 
+ 
+   memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
+   memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
  }
  
***************
*** 777,835 ****
    if (pic_buf_mirror == NULL ||
        context->width != width ||
!       context->height != height)
!     pic_buf_mirror = allocatePicBuf(pic_buf_mirror);
! 
!   if (pic_buf_mirror)
!   {
!     avpic_dest.data[0] = pic_buf_mirror;
!     avpic_dest.data[1] = avpic_dest.data[0] + context->width * context->height;
!     avpic_dest.data[2] = avpic_dest.data[1] + context->width * context->height / 4;
  
!     // mirror luminance
!     ptr_src1  = picture->data[0];
!     ptr_dest1 = avpic_dest.data[0];
  
!     for (int h = 0; h < context->height; h++)
!     {
!       for (int w = context->width; w > 0; w--)
!       {
!         *ptr_dest1 = ptr_src1[h * picture->linesize[0] + w - 1];
!         ptr_dest1++;
!       }
!     }
  
!     // mirror chrominance
!     ptr_src1  = picture->data[1];
!     ptr_src2  = picture->data[2];
!     ptr_dest1 = avpic_dest.data[1];
!     ptr_dest2 = avpic_dest.data[2];
  
!     for (int h = 0; h < context->height / 2; h++)
      {
!       for (int w = context->width / 2; w > 0; w--)
!       {
!         *ptr_dest1 = ptr_src1[h * picture->linesize[0] / 2 + w - 1];
!         *ptr_dest2 = ptr_src2[h * picture->linesize[0] / 2 + w - 1];
!         ptr_dest1++;
!         ptr_dest2++;
!       }
      }
  
!     picture->data[0]     = avpic_dest.data[0];
!     picture->data[1]     = avpic_dest.data[1];
!     picture->data[2]     = avpic_dest.data[2];
  
!     picture->linesize[0] = context->width;
!     picture->linesize[1] = context->width / 2;
!     picture->linesize[2] = context->width / 2;
  
!   }
!   else
    {
!     fprintf(stderr,
!             "[softdevice] no picture buffer is allocated for mirroring !\n"
!             "[softdevice] switching mirroring off !\n");
!     setupStore.mirror = 0;
    }
  }
  
--- 796,855 ----
    if (pic_buf_mirror == NULL ||
        context->width != width ||
!       context->height != height ||
!       context->pix_fmt != pix_fmt)
!     pic_buf_mirror = allocatePicBuf(pic_buf_mirror,context->pix_fmt);
  
!   if ( !pic_buf_mirror ) {
!     fprintf(stderr,
!             "[softdevice] no picture buffer is allocated for mirroring !\n"
!             "[softdevice] switching mirroring off !\n");
!     setupStore.mirror = 0;
!     return;
!   }
  
!   avpicture_fill(&avpic_dest,pic_buf_mirror,
!       context->pix_fmt,context->width ,context->height);
  
!   // mirror luminance
!   ptr_src1  = picture->data[0];
!   ptr_dest1 = avpic_dest.data[0];
  
!   for (int h = 0; h < context->height; h++)
!   {
!     for (int w = context->width; w > 0; w--)
      {
!       *ptr_dest1 = ptr_src1[h * picture->linesize[0] + w - 1];
!       ptr_dest1++;
      }
+   }
  
!   // mirror chrominance
!   ptr_src1  = picture->data[1];
!   ptr_src2  = picture->data[2];
!   ptr_dest1 = avpic_dest.data[1];
!   ptr_dest2 = avpic_dest.data[2];
  
!   int h_shift;
!   int v_shift;
!   avcodec_get_chroma_sub_sample(context->pix_fmt,&h_shift,&v_shift);
  
!   for (int h = 0; h < context->height >> v_shift ; h++)
    {
!     for (int w = context->width >> h_shift; w > 0; w--)
!     {
!       *ptr_dest1 = ptr_src1[h * picture->linesize[1] + w - 1];
!       *ptr_dest2 = ptr_src2[h * picture->linesize[2] + w - 1];
!       ptr_dest1++;
!       ptr_dest2++;
!     }
    }
+ 
+   picture->data[0]     = avpic_dest.data[0];
+   picture->data[1]     = avpic_dest.data[1];
+   picture->data[2]     = avpic_dest.data[2];
+ 
+   picture->linesize[0] = context->width;
+   picture->linesize[1] = context->width >> h_shift ;
+   picture->linesize[2] = context->width >> h_shift ;
  }
  
***************
*** 841,851 ****
    if (pic_buf_pp == NULL ||
        context->width != width ||
!       context->height != height)
!     pic_buf_pp = allocatePicBuf(pic_buf_pp);
  
    if (ppcontext == NULL ||
        context->width != width ||
!       context->height != height)
!   {
      if (ppcontext)
      {
--- 861,873 ----
    if (pic_buf_pp == NULL ||
        context->width != width ||
!       context->height != height ||
!       context->pix_fmt != pix_fmt)
!     pic_buf_pp = allocatePicBuf(pic_buf_pp,context->pix_fmt);
  
    if (ppcontext == NULL ||
        context->width != width ||
!       context->height != height||
!       context->pix_fmt != pix_fmt) {
!           // reallocate ppcontext if format or size of picture changed
      if (ppcontext)
      {
***************
*** 857,862 ****
         PP_CPU_CAPS_MMX, PP_CPU_CAPS_MMX2, PP_CPU_CAPS_3DNOW
       */
!     ppcontext = pp_get_context(context->width, context->height,
!         PP_CPU_CAPS_MMX|PP_CPU_CAPS_MMX2);
    }
  
--- 879,897 ----
         PP_CPU_CAPS_MMX, PP_CPU_CAPS_MMX2, PP_CPU_CAPS_3DNOW
       */
!     int flags=0;
! #ifdef USE_MMX
!     flags|=PP_CPU_CAPS_MMX;
! #endif
! #ifdef USE_MMX2
!     flags|=PP_CPU_CAPS_MMX2;
! #endif
!     if (context->pix_fmt == PIX_FMT_YUV420P)
!       flags|=PP_FORMAT_420;
!     else if (context->pix_fmt == PIX_FMT_YUV422P)
!       flags|=PP_FORMAT_422;
!     else if (context->pix_fmt == PIX_FMT_YUV444P)
!       flags|=PP_FORMAT_444;
! 
!     ppcontext = pp_get_context(context->width, context->height,flags);
    }
  
***************
*** 864,869 ****
    if (currentDeintMethod != deintWork || ppmode == NULL 
        || currentppMethod != setupStore.ppMethod 
!       || currentppQuality != setupStore.ppQuality )
!   {
  
      if (ppmode)  {
--- 899,904 ----
    if (currentDeintMethod != deintWork || ppmode == NULL 
        || currentppMethod != setupStore.ppMethod 
!       || currentppQuality != setupStore.ppQuality ) {
!     // reallocate ppmode if method or quality changed
  
      if (ppmode)  {
***************
*** 873,885 ****
      char mode[60]="";
      if (setupStore.getPPdeintValue() && setupStore.getPPValue())
!       sprintf(mode,"%s,%s",setupStore.getPPdeintValue(),setupStore.getPPValue());
!    else if (setupStore.getPPdeintValue() )
        sprintf(mode,"%s",setupStore.getPPdeintValue());
!    else if (setupStore.getPPValue() )
        sprintf(mode,"%s",setupStore.getPPValue());
!      
!     ppmode = pp_get_mode_by_name_and_quality(mode, 
!             setupStore.ppQuality);
!     //ppmode = pp_get_mode_by_name_and_quality(setupStore.getPPValue(), 6);
      currentDeintMethod = deintWork;
      currentppMethod = setupStore.ppMethod;
--- 908,920 ----
      char mode[60]="";
      if (setupStore.getPPdeintValue() && setupStore.getPPValue())
!       sprintf(mode,"%s,%s",setupStore.getPPdeintValue(),
!           setupStore.getPPValue());
!     else if (setupStore.getPPdeintValue() )
        sprintf(mode,"%s",setupStore.getPPdeintValue());
!     else if (setupStore.getPPValue() )
        sprintf(mode,"%s",setupStore.getPPValue());
! 
!     ppmode = pp_get_mode_by_name_and_quality(mode, setupStore.ppQuality);
!     
      currentDeintMethod = deintWork;
      currentppMethod = setupStore.ppMethod;
***************
*** 887,892 ****
    }
  
!   if (ppmode == NULL || ppcontext == NULL)
!   {
      fprintf(stderr,
              "[softdevice] pp-filter %s couldn't be initialized,\n"
--- 922,926 ----
    }
  
!   if (ppmode == NULL || ppcontext == NULL) {
      fprintf(stderr,
              "[softdevice] pp-filter %s couldn't be initialized,\n"
***************
*** 894,942 ****
              setupStore.getPPValue());
      setupStore.deintMethod = 0;
    }
-   else
-   {
-     if (pic_buf_pp)
-     {
-       avpic_dest.data[0] = pic_buf_pp;
-       avpic_dest.data[1] = avpic_dest.data[0] +
-                             context->width * context->height;
-       avpic_dest.data[2] = avpic_dest.data[1] +
-                             context->width * context->height / 4;
  
!       avpic_dest.linesize[0] = context->width;
!       avpic_dest.linesize[1] = context->width / 2;
!       avpic_dest.linesize[2] = context->width / 2;
! 
!       pp_postprocess(picture->data,
!                      picture->linesize,
!                      (uchar **)&avpic_dest.data,
!                      (int *)&avpic_dest.linesize,
!                      context->width,
!                      context->height,
!                      picture->qscale_table,
!                      picture->qstride,
!                      ppmode,
!                      ppcontext,
!                      picture->pict_type);
  
!       picture->data[0]     = avpic_dest.data[0];
!       picture->data[1]     = avpic_dest.data[1];
!       picture->data[2]     = avpic_dest.data[2];
  
!       picture->linesize[0] = avpic_dest.linesize[0];
!       picture->linesize[1] = avpic_dest.linesize[1];
!       picture->linesize[2] = avpic_dest.linesize[2];
!     }
!     else
!     {
!       fprintf(stderr,
!               "[softdevice] no picture buffer is allocated for postprocessing !\n"
!               "[softdevice] switching postprocessing off !\n");
!       setupStore.deintMethod = 0;
!     }
!   }
  }
  #endif //PP_LIBAVCODEC
  //----------------------------- end of postproc stuff ----------------------
  
--- 928,963 ----
              setupStore.getPPValue());
      setupStore.deintMethod = 0;
+     return;
    }
  
!   
!   if ( !pic_buf_pp ) {
!     fprintf(stderr,
!             "[softdevice] no picture buffer is allocated for postprocessing !\n"
!             "[softdevice] switching postprocessing off !\n");
!     setupStore.deintMethod = 0;
!     return;
!   }
!  
!   avpicture_fill(&avpic_dest,pic_buf_pp,
!                     context->pix_fmt,context->width ,context->height);
  
!   pp_postprocess(picture->data,
!       picture->linesize,
!       (uchar **)&avpic_dest.data,
!       (int *)&avpic_dest.linesize,
!       context->width,
!       context->height,
!       picture->qscale_table,
!       picture->qstride,
!       ppmode,
!       ppcontext,
!       picture->pict_type);
  
!   memcpy(picture->data,avpic_dest.data,sizeof(picture->data));
!   memcpy(picture->linesize,avpic_dest.linesize,sizeof(picture->data));
  }
  #endif //PP_LIBAVCODEC
+ 
  //----------------------------- end of postproc stuff ----------------------
  
***************
*** 950,953 ****
--- 971,978 ----
    if (pic_buf_pp)
       pic_buf_pp = freePicBuf(pic_buf_pp);
+   if (pic_buf_convert)
+      pic_buf_convert = freePicBuf(pic_buf_convert);
+   if (pic_buf_mirror)
+      pic_buf_mirror = freePicBuf(pic_buf_mirror);
  
  }

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** mpeg2decoder.h	3 Jul 2005 15:58:31 -0000	1.27
--- mpeg2decoder.h	17 Jul 2005 09:10:38 -0000	1.28
***************
*** 10,14 ****
  #include <avcodec.h>
  #ifdef PP_LIBAVCODEC
!   #include <postproc/postprocess.h>
  #endif //PP_LIBAVCODEC
  
--- 10,14 ----
  #include <avcodec.h>
  #ifdef PP_LIBAVCODEC
!   #include <postprocess.h>
  #endif //PP_LIBAVCODEC
  
***************
*** 213,219 ****
  
      int                 width, height;
      int                 currentDeintMethod, currentMirrorMode;
      int                 currentppMethod, currentppQuality;
!     uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror;
  #ifdef PP_LIBAVCODEC
      pp_mode_t           *ppmode;
--- 213,220 ----
  
      int                 width, height;
+     PixelFormat         pix_fmt;
      int                 currentDeintMethod, currentMirrorMode;
      int                 currentppMethod, currentppQuality;
!     uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror, *pic_buf_convert;
  #ifdef PP_LIBAVCODEC
      pp_mode_t           *ppmode;
***************
*** 232,237 ****
      {return trickspeed*default_frametime;};
  
!     uchar   *allocatePicBuf(uchar *pic_buf);
      void    deintLibavcodec(void);
      uchar   *freePicBuf(uchar *pic_buf);
  #ifdef PP_LIBAVCODEC
--- 233,239 ----
      {return trickspeed*default_frametime;};
  
!     uchar   *allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt);
      void    deintLibavcodec(void);
+     void    libavcodec_img_convert(void);
      uchar   *freePicBuf(uchar *pic_buf);
  #ifdef PP_LIBAVCODEC



From nobody at sheep.berlios.de  Sun Jul 17 13:26:16 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 17 Jul 2005 13:26:16 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.h,1.28,1.29
Message-ID: <200507171126.j6HBQGI12981@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13902

Modified Files:
	mpeg2decoder.h 
Log Message:
- fix postproc.h path



Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** mpeg2decoder.h	17 Jul 2005 09:10:38 -0000	1.28
--- mpeg2decoder.h	17 Jul 2005 11:26:08 -0000	1.29
***************
*** 10,14 ****
  #include <avcodec.h>
  #ifdef PP_LIBAVCODEC
!   #include <postprocess.h>
  #endif //PP_LIBAVCODEC
  
--- 10,14 ----
  #include <avcodec.h>
  #ifdef PP_LIBAVCODEC
!   #include <postproc/postprocess.h>
  #endif //PP_LIBAVCODEC
  



From nobody at sheep.berlios.de  Wed Jul 20 20:45:49 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 20 Jul 2005 20:45:49 +0200
Subject: [Softdevice-cvs] softdevice video-vidix.c,1.10,1.11
Message-ID: <200507201845.j6KIjnI04737@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24870

Modified Files:
	video-vidix.c 
Log Message:
adjusted vidix-out call of yv12_to_yuy2() to dfb-out

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-vidix.c	15 Jul 2005 20:42:16 -0000	1.10
--- video-vidix.c	20 Jul 2005 18:45:47 -0000	1.11
***************
*** 501,506 ****
        }
      } else if (currentPixelFormat == 2) {
! 
! 	yv12_to_yuy2(Py, Pu, Pv, dst, Width, Height, Ystride, UVstride, dstrides.y*2);
      }
  
--- 501,510 ----
        }
      } else if (currentPixelFormat == 2) {
!       yv12_to_yuy2(Py + Ystride  * cutTop * 2,
!                    Pu + UVstride * cutTop,
!                    Pv + UVstride * cutTop,
!                    dst + dstrides.y*2 * cutTop * 2,
!                    Width, Height - 2 * (cutTop + cutBottom),
!                    Ystride, UVstride, dstrides.y*2);
      }
  



From nobody at sheep.berlios.de  Wed Jul 20 20:58:56 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 20 Jul 2005 20:58:56 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.87,1.88 setup-softdevice.c,1.21,1.22 setup-softdevice.h,1.15,1.16 video-xv.c,1.29,1.30 video.c,1.25,1.26 video.h,1.16,1.17
Message-ID: <200507201858.j6KIwuI05017@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25582

Modified Files:
	CHANGELOG setup-softdevice.c setup-softdevice.h video-xv.c 
	video.c video.h 
Log Message:
    - cropLeft/Right for xv-out
    - exclude cropTop/Bottom OSD from fb-out
    - adjusted vidix-out call of yv12_to_yuy2() to dfb-out


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.87
retrieving revision 1.88
diff -C2 -d -r1.87 -r1.88
*** CHANGELOG	17 Jul 2005 09:10:38 -0000	1.87
--- CHANGELOG	20 Jul 2005 18:58:52 -0000	1.88
***************
*** 1,4 ****
--- 1,8 ----
  Changelog
  2005-07-17:
+     - cropLeft/Right for xv-out
+     - exclude cropTop/Bottom OSD from fb-out
+     - adjusted vidix-out call of yv12_to_yuy2() to dfb-out
+ 2005-07-17:
      - crop Top/Bottom for xv-out
      - introduce colour space conversion (by Malcom Caldwell)

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** setup-softdevice.c	15 Jul 2005 20:42:16 -0000	1.21
--- setup-softdevice.c	20 Jul 2005 18:58:52 -0000	1.22
***************
*** 157,160 ****
--- 157,162 ----
    cropTopLines      = 0;
    cropBottomLines   = 0;
+   cropLeftCols      = 0;
+   cropRightCols     = 0;
    deintMethod   = 0;
    ppMethod   = 0;
***************
*** 237,240 ****
--- 239,252 ----
      fprintf(stderr,"[setup-softdevice] Cropping %d lines from bottom\n",
              cropBottomLines);
+   } else if(!strcasecmp(Name,"CropLeftCols")) {
+     cropLeftCols = atoi(Value);
+     cropLeftCols = clamp (0, cropLeftCols, 100);
+     fprintf(stderr,"[setup-softdevice] Cropping %d columns from left\n",
+             cropLeftCols);
+   } else if(!strcasecmp(Name,"CropRightCols")) {
+     cropRightCols = atoi(Value);
+     cropRightCols = clamp (0, cropRightCols, 100);
+     fprintf(stderr,"[setup-softdevice] Cropping %d columns from right\n",
+             cropRightCols);
    } else if (!strcasecmp(Name,"PixelFormat")) {
      pixelFormat = atoi(Value);
***************
*** 383,395 ****
                              userKeyUsage));
  
!   Add(new cMenuEditIntItem(tr("Crop lines from top"),
!                             &data->cropTopLines,
!                             0,
!                             100));
  
!   Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
!                             &data->cropBottomLines,
!                             0,
!                             100));
  
    if (data->outputMethod == VOUT_FB)
--- 395,422 ----
                              userKeyUsage));
  
!   if (data->outputMethod != VOUT_FB)
!   {
!     Add(new cMenuEditIntItem(tr("Crop lines from top"),
!                              &data->cropTopLines,
!                              0,
!                              100));
  
!     Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
!                              &data->cropBottomLines,
!                              0,
!                              100));
!   }                            
! 
!   if (data->outputMethod == VOUT_XV)
!   {
!     Add(new cMenuEditIntItem(tr("Crop columns from left"),
!                              &data->cropLeftCols,
!                              0,
!                              100));
!     Add(new cMenuEditIntItem(tr("Crop columns from right"),
!                              &data->cropRightCols,
!                              0,
!                              100));
!   }
  
    if (data->outputMethod == VOUT_FB)
***************
*** 507,511 ****
    SetupStore ("CropModeToggleKey",     setupStore.cropModeToggleKey);
    SetupStore ("CropTopLines",        setupStore.cropTopLines);
!   SetupStore ("CropBottomLines",     setupStore.cropBottomLines);  
    SetupStore ("Deinterlace Method", setupStore.deintMethod);
    SetupStore ("Postprocess Method", setupStore.ppMethod);
--- 534,540 ----
    SetupStore ("CropModeToggleKey",     setupStore.cropModeToggleKey);
    SetupStore ("CropTopLines",        setupStore.cropTopLines);
!   SetupStore ("CropBottomLines",     setupStore.cropBottomLines);
!   SetupStore ("CropLeftCols",        setupStore.cropLeftCols);
!   SetupStore ("CropRightCols",       setupStore.cropRightCols);
    SetupStore ("Deinterlace Method", setupStore.deintMethod);
    SetupStore ("Postprocess Method", setupStore.ppMethod);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** setup-softdevice.h	15 Jul 2005 20:42:16 -0000	1.15
--- setup-softdevice.h	20 Jul 2005 18:58:52 -0000	1.16
***************
*** 39,42 ****
--- 39,44 ----
      int   cropTopLines;
      int   cropBottomLines;
+     int   cropLeftCols;
+     int   cropRightCols;
      int   deintMethod;
      int   ppMethod;

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** video-xv.c	17 Jul 2005 07:39:50 -0000	1.29
--- video-xv.c	20 Jul 2005 18:58:52 -0000	1.30
***************
*** 1266,1270 ****
    if (aspect_changed ||
        cutTop != setupStore->cropTopLines ||
!       cutBottom != setupStore->cropBottomLines)
    {
      XClearArea (dpy, win, 0, 0, 0, 0, True);
--- 1266,1272 ----
    if (aspect_changed ||
        cutTop != setupStore->cropTopLines ||
!       cutBottom != setupStore->cropBottomLines ||
!       cutLeft != setupStore->cropLeftCols ||
!       cutRight != setupStore->cropRightCols)
    {
      XClearArea (dpy, win, 0, 0, 0, 0, True);
***************
*** 1272,1275 ****
--- 1274,1279 ----
      cutTop = setupStore->cropTopLines;
      cutBottom = setupStore->cropBottomLines;
+     cutLeft = setupStore->cropLeftCols;
+     cutRight = setupStore->cropRightCols;
      memset (pixels [0], 0, xvWidth*xvHeight);
      memset (pixels [1], 128, xvWidth*xvHeight/4);
***************
*** 1291,1311 ****
          for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
          {
!           AlphaBlend(pixels[0]+i*xvWidth,OsdPy+i*OSD_FULL_WIDTH,
!             Py + i * Ystride,
!             OsdPAlphaY+i*OSD_FULL_WIDTH,fwidth);
          }
  
          for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
          {
!           AlphaBlend(pixels[1]+i*xvWidth/2,
!             OsdPv+i*OSD_FULL_WIDTH/2,Pv+ i * UVstride,
!             OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
          }
  
          for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
          {
!           AlphaBlend(pixels[2]+i*xvWidth/2,
!             OsdPu+i*OSD_FULL_WIDTH/2,Pu+i*UVstride,
!             OsdPAlphaUV+i*OSD_FULL_WIDTH/2,fwidth/2);
          }
  #ifdef USE_MMX
--- 1295,1321 ----
          for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
          {
!           AlphaBlend(pixels[0]+i*xvWidth+2*cutLeft,
!                      OsdPy+i*OSD_FULL_WIDTH+2*cutLeft,
!                      Py + i * Ystride+2*cutLeft,
!                      OsdPAlphaY+i*OSD_FULL_WIDTH+2*cutLeft,
!                      fwidth-2*(cutLeft+cutRight));
          }
  
          for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
          {
!           AlphaBlend(pixels[1]+i*xvWidth/2+cutLeft,
!                      OsdPv+i*OSD_FULL_WIDTH/2+cutLeft,
!                      Pv+ i * UVstride+cutLeft,
!                      OsdPAlphaUV+i*OSD_FULL_WIDTH/2+cutLeft,
!                      fwidth/2-(cutLeft+cutRight));
          }
  
          for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
          {
!           AlphaBlend(pixels[2]+i*xvWidth/2+cutLeft,
!                      OsdPu+i*OSD_FULL_WIDTH/2+cutLeft,
!                      Pu+i*UVstride+cutLeft,
!                      OsdPAlphaUV+i*OSD_FULL_WIDTH/2+cutLeft,
!                      fwidth/2-(cutLeft+cutRight));
          }
  #ifdef USE_MMX
***************
*** 1329,1337 ****
  
            for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
!              fast_memcpy(pixels [0] + i * xvWidth, Py + i * Ystride, fwidth);
            for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!              fast_memcpy (pixels [1] + i * xvWidth / 2, Pv + i * UVstride, fwidth / 2);
            for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!              fast_memcpy (pixels [2] + i * xvWidth / 2, Pu + i * UVstride, fwidth / 2);
  
            pthread_mutex_lock(&xv_mutex);
--- 1339,1353 ----
  
            for (int i = cutTop * 2; i < fheight - cutBottom * 2; i++)
!              fast_memcpy(pixels [0] + i * xvWidth + 2 * cutLeft,
!                          Py + i * Ystride + 2 * cutLeft,
!                          fwidth - 2 * (cutLeft + cutRight));
            for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!              fast_memcpy (pixels [1] + i * xvWidth / 2 + cutLeft,
!                           Pv + i * UVstride + cutLeft,
!                           fwidth / 2 - (cutLeft + cutRight));
            for (int i = cutTop; i < fheight / 2 - cutBottom; i++)
!              fast_memcpy (pixels [2] + i * xvWidth / 2 + cutLeft,
!                           Pu + i * UVstride + cutLeft,
!                           fwidth / 2 - (cutLeft + cutRight));
  
            pthread_mutex_lock(&xv_mutex);

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** video.c	15 Jul 2005 20:42:16 -0000	1.25
--- video.c	20 Jul 2005 18:58:52 -0000	1.26
***************
*** 23,27 ****
  #endif
    sxoff = syoff = lxoff = lyoff = 0;
!   cutTop = cutBottom = 0;
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
    PixelMask=NULL;
--- 23,27 ----
  #endif
    sxoff = syoff = lxoff = lyoff = 0;
!   cutTop = cutBottom = cutLeft = cutRight = 0;
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
    PixelMask=NULL;

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video.h	15 Jul 2005 20:42:16 -0000	1.16
--- video.h	20 Jul 2005 18:58:52 -0000	1.17
***************
*** 93,96 ****
--- 93,97 ----
              currentPixelFormat,
              cutTop, cutBottom,
+             cutLeft, cutRight,
              aspect_changed,
              current_afd,



From nobody at sheep.berlios.de  Wed Jul 20 21:13:39 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 20 Jul 2005 21:13:39 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.88,1.89 setup-softdevice.c,1.22,1.23 setup-softdevice.h,1.16,1.17 video-dfb.c,1.33,1.34
Message-ID: <200507201913.j6KJDdI05475@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26700

Modified Files:
	CHANGELOG setup-softdevice.c setup-softdevice.h video-dfb.c 
Log Message:
stretchBlit mode for dfb-out is selectable via OSD

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.88
retrieving revision 1.89
diff -C2 -d -r1.88 -r1.89
*** CHANGELOG	20 Jul 2005 18:58:52 -0000	1.88
--- CHANGELOG	20 Jul 2005 19:13:36 -0000	1.89
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2005-07-17:
+     - stretchBlit mode for dfb-out is selectable via OSD
      - cropLeft/Right for xv-out
      - exclude cropTop/Bottom OSD from fb-out

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** setup-softdevice.c	20 Jul 2005 18:58:52 -0000	1.22
--- setup-softdevice.c	20 Jul 2005 19:13:36 -0000	1.23
***************
*** 167,170 ****
--- 167,171 ----
    ac3Mode       = 0;
    useMGAtv      = 0;
+   useStretchBlit = 0;
    bufferMode    = 0;
    /* --------------------------------------------------------------------------
***************
*** 214,218 ****
    else if(!strcasecmp(Name,"bufferMode")) {
          bufferMode=atoi(Value);
! 	bufferMode=clamp(0,bufferMode,2);
    }
    else if(!strcasecmp(Name,"CropMode")) {
--- 215,219 ----
    else if(!strcasecmp(Name,"bufferMode")) {
          bufferMode=atoi(Value);
!         bufferMode=clamp(0,bufferMode,2);
    }
    else if(!strcasecmp(Name,"CropMode")) {
***************
*** 279,282 ****
--- 280,287 ----
              mirror,
              mirror ? "on" : "off");
+   } else if(!strcasecmp(Name, "UseStretchBlit")) {
+     useStretchBlit = clamp (0, atoi(Value), 1);
+     fprintf(stderr,"[softdevice] UseStretchBlitset to %s\n",
+             useStretchBlit ? "on" : "off");
    } else if (!strcasecmp(Name, "SyncAllFrames")) {
      syncOnFrames = atoi(Value);
***************
*** 460,463 ****
--- 465,474 ----
    }
  
+   if (data->outputMethod == VOUT_DFB)
+   {
+     Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
+                               &data->useStretchBlit, tr("off"), tr("on")));
+   }
+ 
    Add(new cMenuEditBoolItem(tr("Picture mirroring"),
                              &data->mirror, tr("off"), tr("on")));
***************
*** 541,544 ****
--- 552,556 ----
    SetupStore ("Postprocess Quality", setupStore.ppQuality);
    SetupStore ("PixelFormat",        setupStore.pixelFormat);
+   SetupStore ("UseStretchBlit",     setupStore.useStretchBlit);
    SetupStore ("Picture mirroring",  setupStore.mirror);
    SetupStore ("avOffset",           setupStore.avOffset);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** setup-softdevice.h	20 Jul 2005 18:58:52 -0000	1.16
--- setup-softdevice.h	20 Jul 2005 19:13:36 -0000	1.17
***************
*** 49,52 ****
--- 49,53 ----
      int   screenPixelAspect;
      int   useMGAtv;
+     int   useStretchBlit;
      int   shouldSuspend;
      int   osdMode;

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** video-dfb.c	16 Jul 2005 12:52:04 -0000	1.33
--- video-dfb.c	20 Jul 2005 19:13:36 -0000	1.34
***************
*** 302,305 ****
--- 302,307 ----
      layerInfo = &layerList [CRTC2_LAYER_NEW];
      currentPixelFormat = setupStore->pixelFormat = 2;
+     setupStore->useStretchBlit = 1;
+ 
      if (!setupStore->screenPixelAspect)
        setupStore->screenPixelAspect = 1;
***************
*** 441,452 ****
      OSDpseudo_alpha = true;
      if (setupStore->pixelFormat == 0)
        vidDsc.pixelformat = DSPF_I420;
      else if (setupStore->pixelFormat == 1)
        vidDsc.pixelformat = DSPF_YV12;
      else if (setupStore->pixelFormat == 2)
      {
        vidDsc.pixelformat = DSPF_YUY2;
!       useStretchBlit = true;
!       OSDpseudo_alpha = false;
      }
  
--- 443,465 ----
      OSDpseudo_alpha = true;
      if (setupStore->pixelFormat == 0)
+     {
        vidDsc.pixelformat = DSPF_I420;
+       setupStore->useStretchBlit = 0;
+       useStretchBlit = setupStore->useStretchBlit;
+     }
      else if (setupStore->pixelFormat == 1)
+     {
        vidDsc.pixelformat = DSPF_YV12;
+       setupStore->useStretchBlit = 0;
+       useStretchBlit = setupStore->useStretchBlit;
+     }
      else if (setupStore->pixelFormat == 2)
      {
        vidDsc.pixelformat = DSPF_YUY2;
!       if (setupStore->useStretchBlit)
!       {
!         useStretchBlit = true;
!         OSDpseudo_alpha = false;
!       }
      }
  
***************
*** 599,603 ****
          currentPixelFormat != setupStore->pixelFormat ||
          cutTop != setupStore->cropTopLines ||
!         cutBottom != setupStore->cropBottomLines )
      {
  
--- 612,617 ----
          currentPixelFormat != setupStore->pixelFormat ||
          cutTop != setupStore->cropTopLines ||
!         cutBottom != setupStore->cropBottomLines ||
!         useStretchBlit != setupStore->useStretchBlit )
      {
  
***************
*** 613,624 ****
        OSDpseudo_alpha = (isVIAUnichrome) ? false: true;
        if (setupStore->pixelFormat == 0)
          dlc.pixelformat = DSPF_I420;
        else if (setupStore->pixelFormat == 1)
          dlc.pixelformat = DSPF_YV12;
        else if (setupStore->pixelFormat == 2)
        {
          dlc.pixelformat = DSPF_YUY2;
!         useStretchBlit = true;
!         OSDpseudo_alpha = false;
        }
  
--- 627,649 ----
        OSDpseudo_alpha = (isVIAUnichrome) ? false: true;
        if (setupStore->pixelFormat == 0)
+       {
          dlc.pixelformat = DSPF_I420;
+         setupStore->useStretchBlit = 0;
+         useStretchBlit = setupStore->useStretchBlit;
+       }
        else if (setupStore->pixelFormat == 1)
+       {
          dlc.pixelformat = DSPF_YV12;
+         setupStore->useStretchBlit = 0;
+         useStretchBlit = setupStore->useStretchBlit;
+       }
        else if (setupStore->pixelFormat == 2)
        {
          dlc.pixelformat = DSPF_YUY2;
!         if (setupStore->useStretchBlit)
!         {
!           useStretchBlit = true;
!           OSDpseudo_alpha = false;
!         }
        }
  



From nobody at sheep.berlios.de  Wed Jul 20 22:24:12 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 20 Jul 2005 22:24:12 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.89,1.90 mpeg2decoder.c,1.45,1.46 setup-softdevice.c,1.23,1.24 video-dfb.c,1.34,1.35 video-xv.c,1.30,1.31
Message-ID: <200507202024.j6KKOCI07444@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30842

Modified Files:
	CHANGELOG mpeg2decoder.c setup-softdevice.c video-dfb.c 
	video-xv.c 
Log Message:
crop left/right now for dfb-out too
fix for live view at trick speed


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.89
retrieving revision 1.90
diff -C2 -d -r1.89 -r1.90
*** CHANGELOG	20 Jul 2005 19:13:36 -0000	1.89
--- CHANGELOG	20 Jul 2005 20:24:10 -0000	1.90
***************
*** 1,6 ****
  Changelog
  2005-07-17:
      - stretchBlit mode for dfb-out is selectable via OSD
!     - cropLeft/Right for xv-out
      - exclude cropTop/Bottom OSD from fb-out
      - adjusted vidix-out call of yv12_to_yuy2() to dfb-out
--- 1,7 ----
  Changelog
  2005-07-17:
+     - fix for live view at trick speed
      - stretchBlit mode for dfb-out is selectable via OSD
!     - cropLeft/Right for xv-out and dfb-out
      - exclude cropTop/Bottom OSD from fb-out
      - adjusted vidix-out call of yv12_to_yuy2() to dfb-out

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** mpeg2decoder.c	17 Jul 2005 09:10:38 -0000	1.45
--- mpeg2decoder.c	20 Jul 2005 20:24:10 -0000	1.46
***************
*** 1385,1388 ****
--- 1385,1389 ----
    };
  
+   Speed = 1;
    CMDDEB("Stop finished\n");
    if (GetMutex)

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** setup-softdevice.c	20 Jul 2005 19:13:36 -0000	1.23
--- setup-softdevice.c	20 Jul 2005 20:24:10 -0000	1.24
***************
*** 413,417 ****
    }                            
  
!   if (data->outputMethod == VOUT_XV)
    {
      Add(new cMenuEditIntItem(tr("Crop columns from left"),
--- 413,417 ----
    }                            
  
!   if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_DFB)
    {
      Add(new cMenuEditIntItem(tr("Crop columns from left"),

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** video-dfb.c	20 Jul 2005 19:13:36 -0000	1.34
--- video-dfb.c	20 Jul 2005 20:24:10 -0000	1.35
***************
*** 613,616 ****
--- 613,618 ----
          cutTop != setupStore->cropTopLines ||
          cutBottom != setupStore->cropBottomLines ||
+         cutLeft != setupStore->cropLeftCols ||
+         cutRight != setupStore->cropRightCols ||
          useStretchBlit != setupStore->useStretchBlit )
      {
***************
*** 618,621 ****
--- 620,625 ----
        cutTop    = setupStore->cropTopLines;
        cutBottom = setupStore->cropBottomLines;
+       cutLeft   = setupStore->cropLeftCols;
+       cutRight  = setupStore->cropRightCols;
  
        fprintf(stderr,
***************
*** 1072,1083 ****
    {
  #if HAVE_SetSourceLocation
!     Py += Ystride  * cutTop * 2;
!     Pv += UVstride * cutTop;
!     Pu += UVstride * cutTop;
  
      dst += pitch * cutTop * 2;
  
      for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!       memcpy(dst, Py, Width);
        Py  += Ystride;
        dst += pitch;
--- 1076,1087 ----
    {
  #if HAVE_SetSourceLocation
!     Py += Ystride  * cutTop * 2 + cutLeft * 2;
!     Pv += UVstride * cutTop + cutLeft;
!     Pu += UVstride * cutTop + cutLeft;
  
      dst += pitch * cutTop * 2;
  
      for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!       memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
        Py  += Ystride;
        dst += pitch;
***************
*** 1087,1091 ****
  
      for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!       memcpy(dst, Pu, Width/2);
        Pu  += UVstride;
        dst += pitch / 2;
--- 1091,1095 ----
  
      for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!       memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
        Pu  += UVstride;
        dst += pitch / 2;
***************
*** 1095,1099 ****
  
      for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!       memcpy(dst, Pv, Width/2);
        Pv  += UVstride;
        dst += pitch / 2;
--- 1099,1103 ----
  
      for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!       memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
        Pv  += UVstride;
        dst += pitch / 2;
***************
*** 1107,1111 ****
  
      for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!       memcpy(dst, Py+sxoff, swidth);
        Py  += Ystride;
        dst += pitch;
--- 1111,1115 ----
  
      for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!       memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
        Py  += Ystride;
        dst += pitch;
***************
*** 1115,1119 ****
  
      for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!       memcpy(dst, Pu+sxoff/2, swidth/2);
        Pu  += UVstride;
        dst += pitch / 2;
--- 1119,1123 ----
  
      for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!       memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
        Pu  += UVstride;
        dst += pitch / 2;
***************
*** 1123,1127 ****
  
      for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!       memcpy(dst, Pv+sxoff/2, swidth/2);
        Pv  += UVstride;
        dst += pitch / 2;
--- 1127,1131 ----
  
      for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!       memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
        Pv  += UVstride;
        dst += pitch / 2;
***************
*** 1130,1138 ****
    } else if (pixelformat == DSPF_YUY2) {
  
!     yv12_to_yuy2(Py + Ystride  * cutTop * 2,
!                  Pu + UVstride * cutTop,
!                  Pv + UVstride * cutTop,
!                  dst + pitch * cutTop * 2,
!                  Width, Height - 2 * (cutTop + cutBottom),
                   Ystride, UVstride, pitch);
    }
--- 1134,1143 ----
    } else if (pixelformat == DSPF_YUY2) {
  
!     yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
!                  Pu + UVstride * cutTop + cutLeft,
!                  Pv + UVstride * cutTop + cutLeft,
!                  dst + pitch * cutTop * 2 + cutLeft * 4,
!                  Width - 2 * (cutLeft + cutRight),
!                  Height - 2 * (cutTop + cutBottom),
                   Ystride, UVstride, pitch);
    }

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** video-xv.c	20 Jul 2005 18:58:52 -0000	1.30
--- video-xv.c	20 Jul 2005 20:24:10 -0000	1.31
***************
*** 29,33 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2005-03-10"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 29,33 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2005-07-20"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;



From nobody at sheep.berlios.de  Fri Jul 22 10:25:00 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 22 Jul 2005 10:25:00 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.90,1.91 setup-softdevice.h,1.17,1.18 softdevice.c,1.34,1.35 softdevice.h,1.4,1.5
Message-ID: <200507220825.j6M8P0I07743@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8811

Modified Files:
	CHANGELOG setup-softdevice.h softdevice.c softdevice.h 
Log Message:
include patch from Claas Hilbrecht for "-vo dummy:"
some code reorg for subpluging loader


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.90
retrieving revision 1.91
diff -C2 -d -r1.90 -r1.91
*** CHANGELOG	20 Jul 2005 20:24:10 -0000	1.90
--- CHANGELOG	22 Jul 2005 08:24:55 -0000	1.91
***************
*** 1,4 ****
  Changelog
! 2005-07-17:
      - fix for live view at trick speed
      - stretchBlit mode for dfb-out is selectable via OSD
--- 1,7 ----
  Changelog
! 2005-07-22:
!     - include patch from Claas Hilbrecht for "-vo dummy:"
!     - some code reorg for subpluging loader
! 2005-07-20:
      - fix for live view at trick speed
      - stretchBlit mode for dfb-out is selectable via OSD

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** setup-softdevice.h	20 Jul 2005 19:13:36 -0000	1.17
--- setup-softdevice.h	22 Jul 2005 08:24:56 -0000	1.18
***************
*** 14,17 ****
--- 14,18 ----
  #define VOUT_DFB      3
  #define VOUT_VIDIX    4
+ #define VOUT_DUMMY    5
  
  #define ALSA_DEVICE_NAME_LENGTH  64

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** softdevice.c	29 May 2005 10:13:59 -0000	1.34
--- softdevice.c	22 Jul 2005 08:24:56 -0000	1.35
***************
*** 222,225 ****
--- 222,227 ----
  #endif
  
+ /* ----------------------------------------------------------------------------
+  */
  cSoftDevice::cSoftDevice(int method,int audioMethod, char *pluginPath)
  {
***************
*** 233,315 ****
      setupStore.outputMethod = method;
  #ifdef USE_SUBPLUGINS
-   {
-       char  *subPluginFileName = NULL;
-       char  *outMethodName  = NULL;
-       int   reconfigureArg  = 0;
      switch (method) {
!     case VOUT_XV:
  #ifdef XV_SUPPORT
!       outMethodName = "xv";
!       reconfigureArg = FOURCC_YV12;
  #endif
!       break;
!     case VOUT_FB:
  #ifdef FB_SUPPORT
!       outMethodName = "fb";
  #endif
!       break;
!     case VOUT_DFB:
  #ifdef DFB_SUPPORT
!       outMethodName = "dfb";
  #endif
!       break;
!     case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!       outMethodName = "vidix";
  #endif
!       break;
!     default:
!       break;
!     }
! 
!     asprintf (&subPluginFileName,
!               "%s/%s%s.so.%s",
!               pluginPath,
!               "libvdr-softdevice-",
!               outMethodName,
!               VDRVERSION);
!     void *handle = dlopen (subPluginFileName, RTLD_NOW);
!     char *err = dlerror();
!     if (!err)
!     {
!         void  *(*creator)(cSetupStore *store);
! 
!       creator = (void *(*)(cSetupStore *))dlsym(handle,
!                                                 "SubPluginCreator");
!       err = dlerror();
!       if (!err)
!       {
!         videoOut = (cVideoOut *) creator (&setupStore);
!       }
!       else
!       {
!         esyslog("[softdevice] could not load (%s)[%s] exiting\n",
!                 "SubPluginCreator", err);
!         esyslog("[softdevice] Did you use the -L option?\n");
!         fprintf(stderr,"[softdevice] could not load (%s)[%s] exiting\n",
!                 "SubPluginCreator", err);
!         fprintf(stderr,"[softdevice] Did you use the -L option?\n");
          exit(1);
!       }
!       if (videoOut->Initialize () &&
!           videoOut->Reconfigure (reconfigureArg))
!       {
!           printf("Subplugin successfully opend\n");
!           dsyslog("[softdevice] videoOut OK !\n");
!       }
!       else
!       {
!         esyslog("[softdevice] videoOut failure exiting\n");
!         exit (1);
!       }
! 
!     }
!     else
!     {
!       esyslog("[softdevice] could not load (%s)[%s] exiting\n",
!               subPluginFileName, err);
!       exit(1);
!     }
! 
      }
  #else
--- 235,266 ----
      setupStore.outputMethod = method;
  #ifdef USE_SUBPLUGINS
      switch (method) {
!       case VOUT_XV:
  #ifdef XV_SUPPORT
!         LoadSubPlugin ("xv", FOURCC_YV12, pluginPath);
  #endif
!         break;
!       case VOUT_FB:
  #ifdef FB_SUPPORT
!         LoadSubPlugin ("fb", 0, pluginPath);
  #endif
!         break;
!       case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         LoadSubPlugin ("dfb", 0, pluginPath);
  #endif
!         break;
!       case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         LoadSubPlugin ("vidix", 0, pluginPath);
  #endif
!         break;
!       case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(&setupStore);
!         break;
!       default:
!         esyslog("[softdevice] NO video out specified exiting\n");
          exit(1);
!         break;
      }
  #else
***************
*** 342,346 ****
--- 293,302 ----
  #endif
          break;
+       case VOUT_DUMMY:
+         videoOut=new cDummyVideoOut(&setupStore);
+         break;
        default:
+         esyslog("[softdevice] NO video out specified exiting\n");
+         exit(1);
          break;
      }
***************
*** 368,371 ****
--- 324,383 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
+ void cSoftDevice::LoadSubPlugin(char *outMethodName,
+                                 int reconfigureArg,
+                                 char *pluginPath)
+ {
+     char  *subPluginFileName = NULL;
+ 
+   asprintf (&subPluginFileName,
+             "%s/%s%s.so.%s",
+             pluginPath,
+             "libvdr-softdevice-",
+             outMethodName,
+             VDRVERSION);
+   void *handle = dlopen (subPluginFileName, RTLD_NOW);
+   char *err = dlerror();
+   if (!err)
+   {
+       void  *(*creator)(cSetupStore *store);
+ 
+     creator = (void *(*)(cSetupStore *))dlsym(handle, "SubPluginCreator");
+     err = dlerror();
+     if (!err)
+     {
+       videoOut = (cVideoOut *) creator (&setupStore);
+     }
+     else
+     {
+       esyslog("[softdevice] could not load (%s)[%s] exiting\n",
+               "SubPluginCreator", err);
+       esyslog("[softdevice] Did you use the -L option?\n");
+       fprintf(stderr,"[softdevice] could not load (%s)[%s] exiting\n",
+               "SubPluginCreator", err);
+       fprintf(stderr,"[softdevice] Did you use the -L option?\n");
+       exit(1);
+     }
+     if (videoOut->Initialize () && videoOut->Reconfigure (reconfigureArg))
+     {
+       fprintf(stderr,"[softdevice] Subplugin successfully opend\n");
+       dsyslog("[softdevice] videoOut OK !\n");
+     }
+     else
+     {
+       esyslog("[softdevice] videoOut failure exiting\n");
+       exit (1);
+     }
+ 
+   }
+   else
+   {
+     esyslog("[softdevice] could not load (%s)[%s] exiting\n",
+             subPluginFileName, err);
+     exit(1);
+   }
+ }
+ 
  int64_t cSoftDevice::GetSTC(void) {
    return decoder->GetSTC();
***************
*** 670,673 ****
--- 682,686 ----
    "  -vo vidix:               enable output via vidix driver\n"
  #endif
+   "  -vo dummy:               enable output to dummy device\n"
    "  -L <plugin_path_name>    search path for loading subplugins\n"
    "\n";
***************
*** 765,768 ****
--- 778,786 ----
            fprintf(stderr,"[softdevice] vidix support not compiled in\n");
  #endif
+         } else if (!strncmp (vo_argv, "dummy:", 6)) {
+           vo_argv += 6;
+           setupStore.voArgs = vo_argv;
+           voutMethod = VOUT_DUMMY;
+           fprintf(stderr,"[softdevice] using dummy video out\n");
          } else {
                  fprintf(stderr,"[softdevice] ignoring unrecognized option \"%s\"!\n",argv[i]);

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** softdevice.h	2 Apr 2005 12:19:06 -0000	1.4
--- softdevice.h	22 Jul 2005 08:24:56 -0000	1.5
***************
*** 67,70 ****
--- 67,71 ----
    { if (decoder) decoder->ClearPacketQueue(); };
  
+   void LoadSubPlugin(char *outMethodName, int reconfigureArg, char *pluginPath);
  
    virtual bool HasDecoder(void) const;
***************
*** 96,99 ****
--- 97,101 ----
  private:
    cSpuDecoder *spuDecoder;
+ 
  public:
    virtual cSpuDecoder *GetSpuDecoder(void);



From nobody at sheep.berlios.de  Fri Jul 22 19:55:10 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 22 Jul 2005 19:55:10 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.91,1.92 mpeg2decoder.c,1.46,1.47 softdevice.c,1.35,1.36
Message-ID: <200507221755.j6MHtAI32468@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22724

Modified Files:
	CHANGELOG mpeg2decoder.c softdevice.c 
Log Message:
work around for some *.avi files where frametime is zero
fix previously intoduced compile fail without -DUSE_SUBPLUGINS


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.91
retrieving revision 1.92
diff -C2 -d -r1.91 -r1.92
*** CHANGELOG	22 Jul 2005 08:24:55 -0000	1.91
--- CHANGELOG	22 Jul 2005 17:55:05 -0000	1.92
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-07-22:
+     - work around for some *.avi files where frametime is zero
+     - fix previously intoduced compile fail without -DUSE_SUBPLUGINS
      - include patch from Claas Hilbrecht for "-vo dummy:"
      - some code reorg for subpluging loader

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** mpeg2decoder.c	20 Jul 2005 20:24:10 -0000	1.46
--- mpeg2decoder.c	22 Jul 2005 17:55:06 -0000	1.47
***************
*** 537,540 ****
--- 537,547 ----
                   default_frametime=lastDuration/100;
  #endif
+                  if (!default_frametime) {
+                   /* ----------------------------------------------------------
+                    * we should have another/better guess.
+                    */
+                   //fprintf (stderr, " --- setting default frametime !! ---\n");
+                   default_frametime = DEFAULT_FRAMETIME;
+                  }
                   MPGDEB("Set default_frametime to %d\n",default_frametime);
           };
***************
*** 611,617 ****
    int pts_corr;
  
!   // calculate pts correction. Correct 1/10 of offset at a time 
    pts_corr = offset/10;
!   
    //Max. correction is 2/10 frametime.
    if (pts_corr > 2*frametime() / 10 )
--- 618,624 ----
    int pts_corr;
  
!   // calculate pts correction. Correct 1/10 of offset at a time
    pts_corr = offset/10;
! 
    //Max. correction is 2/10 frametime.
    if (pts_corr > 2*frametime() / 10 )
***************
*** 1209,1213 ****
        vout = NULL;
      };
!     vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec, 
                     videoOut, &clock, Speed );
    };
--- 1216,1220 ----
        vout = NULL;
      };
!     vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
                     videoOut, &clock, Speed );
    };

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** softdevice.c	22 Jul 2005 08:24:56 -0000	1.35
--- softdevice.c	22 Jul 2005 17:55:06 -0000	1.36
***************
*** 12,18 ****
  #include <stdlib.h>
  
- #ifdef USE_SUBPLUGINS
  #include <dlfcn.h>
- #endif
  
  #if VDRVERSNUM >= 10307
--- 12,16 ----



From nobody at sheep.berlios.de  Fri Jul 22 23:18:43 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 22 Jul 2005 23:18:43 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.92,1.93 mpeg2decoder.c,1.47,1.48 softdevice.c,1.36,1.37 video.c,1.26,1.27 video.h,1.17,1.18
Message-ID: <200507222118.j6MLIhI04517@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14800

Modified Files:
	CHANGELOG mpeg2decoder.c softdevice.c video.c video.h 
Log Message:
  changed pause OSD handling in software drawing mode
  This may break blanking mode.
  It can be viewed as a hack, as it just keeps a reference to the previous
  decoded picture. By this way, I can reuse this decoded picture during redraw
  of OSD. The reason for this change is, that it is now possible to edit
  recordings (pause, move and jump between cut marks) when viewing
  is done in software OSD mode.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.92
retrieving revision 1.93
diff -C2 -d -r1.92 -r1.93
*** CHANGELOG	22 Jul 2005 17:55:05 -0000	1.92
--- CHANGELOG	22 Jul 2005 21:18:41 -0000	1.93
***************
*** 1,6 ****
  Changelog
  2005-07-22:
      - work around for some *.avi files where frametime is zero
!     - fix previously intoduced compile fail without -DUSE_SUBPLUGINS
      - include patch from Claas Hilbrecht for "-vo dummy:"
      - some code reorg for subpluging loader
--- 1,7 ----
  Changelog
  2005-07-22:
+     - changed pause OSD handling in software drawing mode
      - work around for some *.avi files where frametime is zero
!     - fix previously introduced compile fail without -DUSE_SUBPLUGINS
      - include patch from Claas Hilbrecht for "-vo dummy:"
      - some code reorg for subpluging loader

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.47
retrieving revision 1.48
diff -C2 -d -r1.47 -r1.48
*** mpeg2decoder.c	22 Jul 2005 17:55:06 -0000	1.47
--- mpeg2decoder.c	22 Jul 2005 21:18:41 -0000	1.48
***************
*** 225,229 ****
  };
  
! void cStreamDecoder::Stop(void) 
  {
    if (syncTimer)
--- 225,229 ----
  };
  
! void cStreamDecoder::Stop(void)
  {
    if (syncTimer)
***************
*** 592,596 ****
    // prepare picture for display
    videoOut->CheckAspectDimensions(picture,context);
!   
    if (!hurry_up || frame % 2 ) {
      // sleep ....
--- 592,597 ----
    // prepare picture for display
    videoOut->CheckAspectDimensions(picture,context);
!   videoOut->SetOldPicture(picture,context->width,context->height);
! 
    if (!hurry_up || frame % 2 ) {
      // sleep ....
***************
*** 972,975 ****
--- 973,977 ----
  {
    cClock::AdjustVideoPTS(0);
+   videoOut->InvalidateOldPicture();
    delete(syncTimer);
    free(picture);
***************
*** 1350,1354 ****
    };
  };
!   
  void cMpeg2Decoder::Stop(bool GetMutex)
  {
--- 1352,1356 ----
    };
  };
! 
  void cMpeg2Decoder::Stop(bool GetMutex)
  {

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** softdevice.c	22 Jul 2005 17:55:06 -0000	1.36
--- softdevice.c	22 Jul 2005 21:18:41 -0000	1.37
***************
*** 474,479 ****
      if ( !packetMode ) {
        cDevice::Clear();
!       decoder->Clear();
!     } else decoder->ClearPacketQueue();
  }
  void cSoftDevice::Play(void)
--- 474,479 ----
      if ( !packetMode ) {
        cDevice::Clear();
!     }
!     decoder->ClearPacketQueue();
  }
  void cSoftDevice::Play(void)

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** video.c	20 Jul 2005 18:58:52 -0000	1.26
--- video.c	22 Jul 2005 21:18:41 -0000	1.27
***************
*** 30,33 ****
--- 30,34 ----
    this->setupStore=setupStore;
    freezeMode=false;
+   old_picture = NULL;
  
    for (int i = 0; i < MAX_PAR; ++i)
***************
*** 82,88 ****
  
      OsdRefreshCounter++;
      if (freezeMode && OsdRefreshCounter > 10 )
!     	OsdRefreshCounter=3;
! 
      changeMode=(current_osdMode != setupStore->osdMode);
      newOsdMode=setupStore->osdMode;
--- 83,90 ----
  
      OsdRefreshCounter++;
+ #if 0
      if (freezeMode && OsdRefreshCounter > 10 )
!       OsdRefreshCounter=3;
! #endif
      changeMode=(current_osdMode != setupStore->osdMode);
      newOsdMode=setupStore->osdMode;
***************
*** 94,103 ****
      {
        osdMutex.Lock();
!       YUV(OsdPy,OsdPu, OsdPv, OsdWidth, OsdHeight,
!           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        Osd_changed=0;
        osdMutex.Unlock();
      }
! 
      // freeze mode and osd changed, change osd mode
      if ( Osd_changed && freezeMode && OsdRefreshCounter >  2 ) {
--- 96,114 ----
      {
        osdMutex.Lock();
!       if (old_picture)
!       {
!         YUV(old_picture->data[0], old_picture->data[1], old_picture->data[2],
!             old_width,old_height,
!             old_picture->linesize[0],old_picture->linesize[1]);
!       }
!       else
!       {
!         YUV(OsdPy,OsdPu, OsdPv, OsdWidth, OsdHeight,
!             OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
!       }
        Osd_changed=0;
        osdMutex.Unlock();
      }
! #if 0
      // freeze mode and osd changed, change osd mode
      if ( Osd_changed && freezeMode && OsdRefreshCounter >  2 ) {
***************
*** 105,109 ****
          newOsdMode=OSDMODE_PSEUDO;
      }
!     
      GetOSDDimension(newOsdWidth,newOsdHeight);
      if ( newOsdWidth==-1 || newOsdHeight==-1 )
--- 116,120 ----
          newOsdMode=OSDMODE_PSEUDO;
      }
! #endif
      GetOSDDimension(newOsdWidth,newOsdHeight);
      if ( newOsdWidth==-1 || newOsdHeight==-1 )
***************
*** 139,142 ****
--- 150,173 ----
    }
  #endif
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::InvalidateOldPicture(void)
+ {
+   osdMutex.Lock();
+   old_picture = NULL;
+   osdMutex.Unlock();
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::SetOldPicture(AVFrame *picture, int width, int height)
+ {
+   osdMutex.Lock();
+   old_picture = picture;
+   old_width = width;
+   old_height = height;
+   osdMutex.Unlock();
  }
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video.h	20 Jul 2005 18:58:52 -0000	1.17
--- video.h	22 Jul 2005 21:18:41 -0000	1.18
***************
*** 99,104 ****
      double  parValues[MAX_PAR];
  
      cSetupStore *setupStore;
!                 
      cOsd *osd;
      bool active;
--- 99,107 ----
      double  parValues[MAX_PAR];
  
+     AVFrame *old_picture;
+     int     old_width, old_height;
+ 
      cSetupStore *setupStore;
! 
      cOsd *osd;
      bool active;
***************
*** 136,139 ****
--- 139,145 ----
      void SetOsd(cOsd * Osd) {osd=Osd;};
      // sets a pointer to the current osd. For refreshing of the osd 
+ 
+     virtual void InvalidateOldPicture(void);
+     virtual void SetOldPicture(AVFrame *picture, int width, int height);
  
      uint8_t *PixelMask;



From nobody at sheep.berlios.de  Sat Jul 23 22:14:34 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 23 Jul 2005 22:14:34 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.93,1.94 video-vidix.c,1.11,1.12 video-vidix.h,1.4,1.5
Message-ID: <200507232014.j6NKEYI08264@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16038

Modified Files:
	CHANGELOG video-vidix.c video-vidix.h 
Log Message:
vidix-out:
  some cosmetic cleanups
  force OSD mode pseudo when YUY2 pixelformat is choosen


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.93
retrieving revision 1.94
diff -C2 -d -r1.93 -r1.94
*** CHANGELOG	22 Jul 2005 21:18:41 -0000	1.93
--- CHANGELOG	23 Jul 2005 20:14:31 -0000	1.94
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2005-07-23:
+     - vidix-out:
+       - some cosmetic cleanups
+       - force OSD mode pseudo when YUY2 pixelformat is choosen
  2005-07-22:
      - changed pause OSD handling in software drawing mode

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-vidix.c	20 Jul 2005 18:45:47 -0000	1.11
--- video-vidix.c	23 Jul 2005 20:14:31 -0000	1.12
***************
*** 26,29 ****
--- 26,31 ----
  #endif
  
+ /* ---------------------------------------------------------------------------
+  */
  cVidixVideoOut::cVidixVideoOut(cSetupStore *setupStore)
                    : cVideoOut(setupStore)
***************
*** 216,219 ****
--- 218,306 ----
  /* ----------------------------------------------------------------------------
   */
+ void cVidixVideoOut::SetParams(int Ystride, int UVstride)
+ {
+   if (aspect_changed || currentPixelFormat != setupStore->pixelFormat ||
+       cutTop != setupStore->cropTopLines ||
+       cutBottom != setupStore->cropBottomLines )
+   {
+     cutTop    = setupStore->cropTopLines;
+     cutBottom = setupStore->cropBottomLines;
+ 
+     printf("cVidixVideoOut: Video changed format to %dx%d\n", fwidth, fheight);
+ 
+     if((Xres > fwidth || Yres > fheight) &&
+        (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
+     {
+       esyslog("[cVidixVideoOut] vidix driver can't "
+               "upscale image (%dx%d -> %dx%d) exiting\n",
+               fwidth, fheight, Xres, Yres);
+       exit(1);
+     }
+ 
+     if((Xres < fwidth || Yres < fheight) &&
+        (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
+     {
+       esyslog("[cVidixVideoOut] vidix driver can't "
+               "downscale image (%dx%d -> %dx%d) exiting\n",
+               fwidth, fheight, Xres, Yres);
+       exit(1);
+     }
+ 
+     if (currentPixelFormat != setupStore->pixelFormat)
+     {
+       if (setupStore->pixelFormat == 0)
+         vidix_fourcc.fourcc = IMGFMT_I420;
+       else if(setupStore->pixelFormat == 1)
+         vidix_fourcc.fourcc = IMGFMT_YV12;
+       else if(setupStore->pixelFormat == 2)
+         vidix_fourcc.fourcc = IMGFMT_YUY2;
+ 
+       currentPixelFormat = setupStore->pixelFormat;
+       if (vdlQueryFourcc(vidix_handler, &vidix_fourcc))
+       {
+         if (!MatchPixelFormat())
+         {
+           esyslog("[cVidixVideoOut]: no matching pixel format found exiting\n");
+           exit(1);
+         }
+       }
+     }
+ 
+     vidix_play.fourcc       = vidix_fourcc.fourcc;
+ 
+     vidix_play.src.w  = swidth;
+     vidix_play.src.h  = sheight;
+ 
+     vidix_play.dest.x = lxoff;
+     vidix_play.dest.y = lyoff;
+     vidix_play.dest.w = lwidth;
+     vidix_play.dest.h = lheight;
+ 
+     vidix_play.src.pitch.y=Ystride;
+     vidix_play.src.pitch.u=UVstride;
+     vidix_play.src.pitch.v=UVstride;
+ 
+     AllocLayer();
+ #if 0
+     printf("cVidixVideoOut : num_frames=%d \n", vidix_play.num_frames);
+     printf("cVidixVideoOut : frame_size=%d\n",  vidix_play.frame_size);
+ 
+     printf("cVidixVideoOut : src pitches y=%d\n", vidix_play.src.pitch.y);
+     printf("cVidixVideoOut : src pitches u=%d\n", vidix_play.src.pitch.u);
+     printf("cVidixVideoOut : src pitches v=%d\n", vidix_play.src.pitch.v);
+ 
+     printf("cVidixVideoOut : dst pitches y=%d\n", vidix_play.dest.pitch.y);
+     printf("cVidixVideoOut : dst pitches u=%d\n", vidix_play.dest.pitch.u);
+     printf("cVidixVideoOut : dst pitches v=%d\n", vidix_play.dest.pitch.v);
+ 
+     printf("cVidixVideoOut : dstrides.y=%d\n", dstrides.y);
+     printf("cVidixVideoOut : dstrides.u=%d\n", dstrides.u);
+     printf("cVidixVideoOut : dstrides.v=%d\n", dstrides.v);
+ #endif
+   }
+ }
+ 
+ /* ----------------------------------------------------------------------------
+  */
  void cVidixVideoOut::AllocLayer(void)
  {
***************
*** 308,450 ****
  /* ----------------------------------------------------------------------------
   */
! void cVidixVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv, int Width, int Height, int Ystride, int UVstride)
  {
      uint8_t *dst;
      int hi, wi;
-     
-     START;
-     TIMINGS("start...\n");
-     if (aspect_changed || currentPixelFormat != setupStore->pixelFormat ||
-         cutTop != setupStore->cropTopLines || cutBottom != setupStore->cropBottomLines )
-     {
-        cutTop    = setupStore->cropTopLines;
-        cutBottom = setupStore->cropBottomLines;
-     
-        printf("cVidixVideoOut: Video changed format to %dx%d\n", Width, Height);
- 
-        if((Xres > Width || Yres > Height) &&
-           (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
-        {
-            esyslog("[cVidixVideoOut] vidix driver can't upscale image (%dx%d -> %dx%d) exiting\n",
-                    Width, Height, Xres, Yres);
-            exit(1);
-        }
- 
-        if((Xres < Width || Yres < Height) &&
-           (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
-        {
-            esyslog("[cVidixVideoOut] vidix driver can't downscale image (%dx%d -> %dx%d) exiting\n",
-                    Width, Height, Xres, Yres);
-            exit(1);
-        }
- 
-        if (currentPixelFormat != setupStore->pixelFormat)
-        {
-          if (setupStore->pixelFormat == 0)
-            vidix_fourcc.fourcc = IMGFMT_I420;
-          else if(setupStore->pixelFormat == 1)
-            vidix_fourcc.fourcc = IMGFMT_YV12;
-          else if(setupStore->pixelFormat == 2)
-            vidix_fourcc.fourcc = IMGFMT_YUY2;
- 
-          currentPixelFormat = setupStore->pixelFormat;
-          if (vdlQueryFourcc(vidix_handler, &vidix_fourcc))
-          {
-           if (!MatchPixelFormat())
-           {
-             esyslog("[cVidixVideoOut]: no matching pixel format found exiting\n");
-             exit(1);
-           }
-          }
-        }
- 
-        vidix_play.fourcc       = vidix_fourcc.fourcc;
  
!        vidix_play.src.w  = swidth;
!        vidix_play.src.h  = sheight;
  
!        vidix_play.dest.x = lxoff;
!        vidix_play.dest.y = lyoff;
!        vidix_play.dest.w = lwidth;
!        vidix_play.dest.h = lheight;
  
!        vidix_play.src.pitch.y=Ystride;
!        vidix_play.src.pitch.u=UVstride;
!        vidix_play.src.pitch.v=UVstride;
  
!        AllocLayer();
! #if 0
!        printf("cVidixVideoOut : num_frames=%d \n", vidix_play.num_frames);
!        printf("cVidixVideoOut : frame_size=%d\n",  vidix_play.frame_size);
  
!        printf("cVidixVideoOut : src pitches y=%d\n", vidix_play.src.pitch.y);
!        printf("cVidixVideoOut : src pitches u=%d\n", vidix_play.src.pitch.u);
!        printf("cVidixVideoOut : src pitches v=%d\n", vidix_play.src.pitch.v);
  
!        printf("cVidixVideoOut : dst pitches y=%d\n", vidix_play.dest.pitch.y);
!        printf("cVidixVideoOut : dst pitches u=%d\n", vidix_play.dest.pitch.u);
!        printf("cVidixVideoOut : dst pitches v=%d\n", vidix_play.dest.pitch.v);
  
!        printf("cVidixVideoOut : dstrides.y=%d\n", dstrides.y);
!        printf("cVidixVideoOut : dstrides.u=%d\n", dstrides.u);
!        printf("cVidixVideoOut : dstrides.v=%d\n", dstrides.v);
  #endif
-     }
-     TIMINGS("after if, before Y\n");
- 
-     // Plane Y
-     dst = (uint8_t *) vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.y;
- 
-     Py += (Ystride * syoff);
-     Pv += (UVstride * syoff/2);
-     Pu += (UVstride * syoff/2);
- 
-     OsdRefreshCounter=0;
- 
-     if (currentPixelFormat == 0 || currentPixelFormat == 1)
      {
! #if VDRVERSNUM >= 10307
! 	if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE)
! 	{
!         for(hi=0; hi < sheight; hi++){
! 		AlphaBlend(dst, OsdPy+hi*OSD_FULL_WIDTH, Py + sxoff, OsdPAlphaY+hi*OSD_FULL_WIDTH, swidth);
!           Py  += Ystride;
!           dst += dstrides.y;
! 	    }
! 	    
! 	    // Plane U
! 	    dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u;
! 	    for(hi=0; hi < sheight/2; hi++){
! 		    AlphaBlend(dst,OsdPu+hi*OSD_FULL_WIDTH/2, Pu + sxoff/2, OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,swidth/2);
! 		    Pu  += UVstride;
! 		    dst += dstrides.y / 2;
! 	    }
! 
! 	    // Plane V
! 	    dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v;
! 	    for(hi=0; hi < sheight/2; hi++) {
! 		    AlphaBlend(dst, OsdPv+hi*OSD_FULL_WIDTH/2, Pv + sxoff/2, OsdPAlphaUV+hi*OSD_FULL_WIDTH/2, swidth/2);
! 		    Pv  += UVstride;
! 		    dst += dstrides.v / 2;
!         }
!       } else
! #endif
! 	{	
! 	    int chromaWidth  = swidth >> 1;
! 	    int chromaOffset = sxoff >> 1;
! 
! 	    Py += Ystride  * cutTop * 2;
! 	    Pv += UVstride * cutTop;
! 	    Pu += UVstride * cutTop;
  
! 	    dst += dstrides.y * cutTop * 2;
  
  
! 	    for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++)
! 	    {
!           memcpy(dst, Py+sxoff, swidth);
!           Py  += Ystride;
!           dst += dstrides.y;
!         }
  
        TIMINGS("Before YUV\n");
--- 395,481 ----
  /* ----------------------------------------------------------------------------
   */
! void cVidixVideoOut::YUV(uint8_t *Py, uint8_t *Pu, uint8_t *Pv,
!                          int Width, int Height,
!                          int Ystride, int UVstride)
  {
      uint8_t *dst;
      int hi, wi;
  
!   START;
!   TIMINGS("start...\n");
!   SetParams(Ystride, UVstride);
!   TIMINGS("after if, before Y\n");
  
!   // Plane Y
!   dst = (uint8_t *) vidix_play.dga_addr +
!         vidix_play.offsets[next_frame] +
!         vidix_play.offset.y;
  
!   Py += (Ystride * syoff);
!   Pv += (UVstride * syoff/2);
!   Pu += (UVstride * syoff/2);
  
!   OsdRefreshCounter=0;
  
!   if (currentPixelFormat == 0 || currentPixelFormat == 1)
!   {
! #if VDRVERSNUM >= 10307
!     if (OSDpresent && current_osdMode==OSDMODE_SOFTWARE)
!     {
!       for (hi=0; hi < sheight; hi++){
!         AlphaBlend(dst,
!                    OsdPy+hi*OSD_FULL_WIDTH,
!                    Py + sxoff,
!                    OsdPAlphaY+hi*OSD_FULL_WIDTH,
!                    swidth);
!         Py  += Ystride;
!         dst += dstrides.y;
!       }
  
!       // Plane U
!       dst = (uint8_t *)vidix_play.dga_addr +
!             vidix_play.offsets[next_frame] +
!             vidix_play.offset.u;
!       for (hi=0; hi < sheight/2; hi++) {
!         AlphaBlend(dst,
!                    OsdPu+hi*OSD_FULL_WIDTH/2,
!                    Pu + sxoff/2,
!                    OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,
!                    swidth/2);
!         Pu  += UVstride;
!         dst += dstrides.y / 2;
!       }
  
!       // Plane V
!       dst = (uint8_t *)vidix_play.dga_addr +
!             vidix_play.offsets[next_frame] +
!             vidix_play.offset.v;
!       for (hi=0; hi < sheight/2; hi++) {
!         AlphaBlend(dst,
!                    OsdPv+hi*OSD_FULL_WIDTH/2,
!                    Pv + sxoff/2,
!                    OsdPAlphaUV+hi*OSD_FULL_WIDTH/2,
!                    swidth/2);
!         Pv  += UVstride;
!         dst += dstrides.v / 2;
!       }
!     } else
  #endif
      {
!         int chromaWidth  = swidth >> 1;
!         int chromaOffset = sxoff >> 1;
  
!       Py += Ystride  * cutTop * 2;
!       Pv += UVstride * cutTop;
!       Pu += UVstride * cutTop;
  
+       dst += dstrides.y * cutTop * 2;
  
!       for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++)
!       {
!         memcpy(dst, Py+sxoff, swidth);
!         Py  += Ystride;
!         dst += dstrides.y;
!       }
  
        TIMINGS("Before YUV\n");
***************
*** 452,516 ****
        if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
        {
! 		int dstStride = dstrides.v << 1;
! 		dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v + dstStride * cutTop;
  
! 		for(hi = cutTop; hi < sheight/2; hi++)
! 		{
! 		    uint16_t *idst = (uint16_t *) dst;
! 		    uint8_t  *usrc = Pu + chromaOffset, *vsrc = Pv + chromaOffset;
  
! 		    for(wi = 0; wi < chromaWidth; wi++)
! 		    {
! 			*idst++ = ( usrc[0] << 8 ) + vsrc[0];
! 			usrc++;
! 			vsrc++;
            }
  
! 		    dst += dstStride;
            Pu += UVstride;
            Pv += UVstride;
          }
- 
        } else {
  
- 		int dstStride;
- 		
          // Plane U
! 		dstStride = dstrides.u >> 1;		
! 		dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.u + dstStride * cutTop;
  
! 		for(hi=cutTop; hi < sheight/2 - cutBottom; hi++)
! 		{
!     		    memcpy(dst, Pu+chromaOffset, chromaWidth);
!             Pu  += UVstride;
! 		    dst += dstStride;
!           }
  
!           // Plane V
! 		dstStride = dstrides.v >> 1;
! 		dst = (uint8_t *)vidix_play.dga_addr + vidix_play.offsets[next_frame] + vidix_play.offset.v + dstStride * cutTop;
  
! 		for(hi=cutTop; hi < sheight/2 - cutBottom; hi++)
          {
!     		    memcpy(dst, Pv+chromaOffset, chromaWidth);
!             Pv   += UVstride;
! 		    dst += dstStride;
!           }
! 
          }
        }
-     } else if (currentPixelFormat == 2) {
-       yv12_to_yuy2(Py + Ystride  * cutTop * 2,
-                    Pu + UVstride * cutTop,
-                    Pv + UVstride * cutTop,
-                    dst + dstrides.y*2 * cutTop * 2,
-                    Width, Height - 2 * (cutTop + cutBottom),
-                    Ystride, UVstride, dstrides.y*2);
      }
  
!     TIMINGS("After UV\n");
!     vdlPlaybackFrameSelect(vidix_handler, next_frame);
!     next_frame = (next_frame+1) % vidix_play.num_frames;
!     TIMINGS("End\n");
  }
  
--- 483,556 ----
        if (vidix_play.flags & VID_PLAY_INTERLEAVED_UV)
        {
!           int dstStride = dstrides.v << 1;
  
!         dst = (uint8_t *)vidix_play.dga_addr +
!               vidix_play.offsets[next_frame] +
!               vidix_play.offset.v +
!               dstStride * cutTop;
  
!         for(hi = cutTop; hi < sheight/2; hi++)
!         {
!             uint16_t  *idst = (uint16_t *) dst;
!             uint8_t   *usrc = Pu + chromaOffset,
!                       *vsrc = Pv + chromaOffset;
! 
!           for(wi = 0; wi < chromaWidth; wi++)
!           {
!             *idst++ = ( usrc[0] << 8 ) + vsrc[0];
!             usrc++;
!             vsrc++;
            }
  
!           dst += dstStride;
            Pu += UVstride;
            Pv += UVstride;
          }
        } else {
+           int dstStride;
  
          // Plane U
!         dstStride = dstrides.u >> 1;
!         dst = (uint8_t *)vidix_play.dga_addr +
!               vidix_play.offsets[next_frame] +
!               vidix_play.offset.u +
!               dstStride * cutTop;
  
!         for(hi=cutTop; hi < sheight/2 - cutBottom; hi++)
!         {
!           memcpy(dst, Pu+chromaOffset, chromaWidth);
!           Pu  += UVstride;
!           dst += dstStride;
!         }
  
!         // Plane V
!         dstStride = dstrides.v >> 1;
!         dst = (uint8_t *)vidix_play.dga_addr +
!               vidix_play.offsets[next_frame] +
!               vidix_play.offset.v +
!               dstStride * cutTop;
  
!         for(hi=cutTop; hi < sheight/2 - cutBottom; hi++)
          {
!           memcpy(dst, Pv+chromaOffset, chromaWidth);
!           Pv   += UVstride;
!           dst += dstStride;
          }
        }
      }
+   } else if (currentPixelFormat == 2) {
+     current_osdMode = setupStore->osdMode = OSDMODE_PSEUDO;
+     yv12_to_yuy2(Py + Ystride  * cutTop * 2,
+                  Pu + UVstride * cutTop,
+                  Pv + UVstride * cutTop,
+                  dst + dstrides.y*2 * cutTop * 2,
+                  Width, Height - 2 * (cutTop + cutBottom),
+                  Ystride, UVstride, dstrides.y*2);
+   }
  
!   TIMINGS("After UV\n");
!   vdlPlaybackFrameSelect(vidix_handler, next_frame);
!   next_frame = (next_frame+1) % vidix_play.num_frames;
!   TIMINGS("End\n");
  }
  
***************
*** 542,545 ****
--- 582,587 ----
  
  
+ /* ---------------------------------------------------------------------------
+  */
  void cVidixVideoOut::Refresh(cBitmap *Bitmap)
  {
***************
*** 556,559 ****
--- 598,603 ----
  #else
  
+ /* ---------------------------------------------------------------------------
+  */
  void cVidixVideoOut::Refresh()
  {
***************
*** 561,565 ****
      for (int i = 0; i < MAXNUMWINDOWS; i++)
      {
!         if (layer[i] && layer[i]->visible) layer[i]->Draw(fb, fb_line_len, NULL);
      }
  }
--- 605,610 ----
      for (int i = 0; i < MAXNUMWINDOWS; i++)
      {
!         if (layer[i] && layer[i]->visible)
!           layer[i]->Draw(fb, fb_line_len, NULL);
      }
  }
***************
*** 567,570 ****
--- 612,617 ----
  #endif
  
+ /* ---------------------------------------------------------------------------
+  */
  void cVidixVideoOut::CloseOSD()
  {
***************
*** 573,576 ****
--- 620,625 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
  cVidixVideoOut::~cVidixVideoOut()
  {

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-vidix.h	5 Jun 2005 20:58:12 -0000	1.4
--- video-vidix.h	23 Jul 2005 20:14:32 -0000	1.5
***************
*** 39,42 ****
--- 39,44 ----
      uint8_t            next_frame;
  
+     void SetParams(int Ystride, int UVstride);
+ 
  public:
    cVidixVideoOut(cSetupStore *setupStore);



From nobody at sheep.berlios.de  Sun Jul 24 22:16:40 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 24 Jul 2005 22:16:40 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.94,1.95 README,1.8,1.9 i18n.c,1.4,1.5
Message-ID: <200507242016.j6OKGeI11502@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15100

Modified Files:
	CHANGELOG README i18n.c 
Log Message:
finnish translations by Rolf Ahrenberg

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.94
retrieving revision 1.95
diff -C2 -d -r1.94 -r1.95
*** CHANGELOG	23 Jul 2005 20:14:31 -0000	1.94
--- CHANGELOG	24 Jul 2005 20:16:38 -0000	1.95
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-07-24:
+     - finnish translations by Rolf Ahrenberg
  2005-07-23:
      - vidix-out:

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** README	15 Jul 2005 20:42:16 -0000	1.8
--- README	24 Jul 2005 20:16:38 -0000	1.9
***************
*** 107,110 ****
--- 107,111 ----
  - Nicolas Huillard
  - Roland Praml
+ - Rolf Ahrenberg
  - Stefan Lucke
  - Torgeir Veimo

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** i18n.c	29 May 2005 19:50:44 -0000	1.4
--- i18n.c	24 Jul 2005 20:16:38 -0000	1.5
***************
*** 18,22 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 18,22 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "N?ytt?laite",  //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 33,36 ****
--- 33,59 ----
  #endif
    },
+   { "A software emulated MPEG2 device", //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO   
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "Ohjelmistopohjainen n?ytt?laite",  //  9
+     "",             // 10 TODO
+     "",             // 11 TODO   
+     "",             // 12 TODO   
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO   
+ #endif
+   },
    { "Xv startup aspect",   //  1
      "Xv Startgr??e",       //  2
***************
*** 41,45 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 64,68 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Xv-kuvasuhde k?ynnistett?ess?",   //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 64,68 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 87,91 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvan leikkaus",   //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 87,91 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 110,114 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Lomituksen poisto",    //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 110,114 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 133,137 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Pikseliformaatti", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 133,137 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 156,160 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvan peilaus",//  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 156,160 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 179,183 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "A/V-viive",    //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 171,175 ****
  #endif
    },
!   { "Screen Aspect",       //  1
      "Bildschirmformat",   //  2
      "",             //  3 TODO
--- 194,198 ----
  #endif
    },
!   { "Screen Aspect",      //  1
      "Bildschirmformat",   //  2
      "",             //  3 TODO
***************
*** 179,183 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 202,206 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "N?yt?n kuvasuhde",   //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 202,206 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 225,229 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Toisto",       //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 225,229 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 248,252 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvaruutun?yt?n l?pin?kyvyys", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 240,245 ****
  #endif
    },
!   { "on",       //  1
!     "ein",      //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 263,268 ----
  #endif
    },
!   { "on",           //  1
!     "ein",          //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 248,252 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 271,275 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "p??ll?",       //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 271,275 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 294,298 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "pois",         //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 286,291 ****
  #endif
    },
!   { "AC3 Mode",          //  1
!     "AC3 Modus",          //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 309,314 ----
  #endif
    },
!   { "AC3 Mode",     //  1
!     "AC3 Modus",    //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 294,298 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 317,528 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "AC3-tapa",     //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Buffer Mode",  //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Puskurointi",  //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO 
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "CropModeToggleKey", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "N?pp?in kuvan leikkaukselle", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Crop lines from top", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Leikkaa kuvaa ylh??lt?", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Crop lines from bottom", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Leikkaa kuvaa alhaalta", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Crop lines from left", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Leikkaa kuvaa vasemmalta", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Crop lines from right", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Leikkaa kuvaa oikealta", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Postprocessing Method", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Kuvan j?lkik?sittely", //  9                                                                                                      
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO   
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Postprocessing Quality", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Kuvan j?lkik?sittelyn laatu", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Use StretchBlit", //  1
!     "",             //  2 TODO
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "K?yt? StretchBlit-metodia", //  9
      "",             // 10 TODO
      "",             // 11 TODO



From nobody at sheep.berlios.de  Sun Jul 24 22:40:06 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 24 Jul 2005 22:40:06 +0200
Subject: [Softdevice-cvs] softieee1394 HISTORY,1.1.1.1,1.2 i18n.c,1.1.1.1,1.2 softieee1394.c,1.1.1.1,1.2
Message-ID: <200507242040.j6OKe6I11905@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394
In directory sheep:/tmp/cvs-serv16354

Modified Files:
	HISTORY i18n.c softieee1394.c 
Log Message:
finnish translations by Rolf Ahrenberg

Index: HISTORY
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/HISTORY,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** HISTORY	1 May 2005 22:05:08 -0000	1.1.1.1
--- HISTORY	24 Jul 2005 20:40:04 -0000	1.2
***************
*** 1,5 ****
  VDR Plugin 'softieee1394' Revision History
  ------------------------------------------
! 
  2005-04-09: Version 0.0.1
  
--- 1,6 ----
  VDR Plugin 'softieee1394' Revision History
  ------------------------------------------
! 2005-07-24:
!     - finnish translations by Rolf Ahrenberg
  2005-04-09: Version 0.0.1
  

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/i18n.c,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** i18n.c	1 May 2005 22:05:08 -0000	1.1.1.1
--- i18n.c	24 Jul 2005 20:40:04 -0000	1.2
***************
*** 10,15 ****
  
  const tI18nPhrase Phrases[] = {
!   { "Devices",            //  1
!     "Ger?te",             //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 10,15 ----
  
  const tI18nPhrase Phrases[] = {
!   { "Softieee1394", //  1
!     "Softieee1394", //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 18,22 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 18,22 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "DV-kamera",    //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 33,38 ****
  #endif
    },
!   { "New FireWire Device",            //  1
!     "Neues FireWire Ger?t",           //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 33,38 ----
  #endif
    },
!   { "Plugin for DV firewire devices", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 41,45 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 41,91 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Laajennos DV FireWire -laitteille", //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "Devices",      //  1
!     "Ger?te",       //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Laitteet",     //  9
!     "",             // 10 TODO
!     "",             // 11 TODO
!     "",             // 12 TODO
!     "",             // 13 TODO
!     "",             // 14 TODO
!     "",             // 15 TODO
!     "",             // 16 TODO
! #if VDRVERSNUM >= 10316
!     "",             // 17 TODO
!     "",             // 18 TODO
!     "",             // 19 TODO
!     "",             // 20 TODO
! #endif
!   },
!   { "New FireWire Device",  //  1
!     "Neues FireWire Ger?t", //  2
!     "",             //  3 TODO
!     "",             //  4 TODO
!     "",             //  5 TODO
!     "",             //  6 TODO
!     "",             //  7 TODO
!     "",             //  8 TODO
!     "Uusi FireWire-laite", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 64,68 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO
--- 110,114 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "FireWire-laite poistettu", //  9
      "",             // 10 TODO
      "",             // 11 TODO

Index: softieee1394.c
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/softieee1394.c,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** softieee1394.c	1 May 2005 22:05:08 -0000	1.1.1.1
--- softieee1394.c	24 Jul 2005 20:40:04 -0000	1.2
***************
*** 90,94 ****
    virtual ~cPluginSoftieee1394();
    virtual const char *Version(void) { return VERSION; }
!   virtual const char *Description(void) { return DESCRIPTION; }
    virtual const char *CommandLineHelp(void);
    virtual bool ProcessArgs(int argc, char *argv[]);
--- 90,94 ----
    virtual ~cPluginSoftieee1394();
    virtual const char *Version(void) { return VERSION; }
!   virtual const char *Description(void) { return tr(DESCRIPTION); }
    virtual const char *CommandLineHelp(void);
    virtual bool ProcessArgs(int argc, char *argv[]);
***************
*** 97,101 ****
    virtual void Stop(void);
    virtual void Housekeeping(void);
!   virtual const char *MainMenuEntry(void) { return MAINMENUENTRY; }
    virtual cOsdObject *MainMenuAction(void);
    virtual cMenuSetupPage *SetupMenu(void);
--- 97,101 ----
    virtual void Stop(void);
    virtual void Housekeeping(void);
!   virtual const char *MainMenuEntry(void) { return tr(MAINMENUENTRY); }
    virtual cOsdObject *MainMenuAction(void);
    virtual cMenuSetupPage *SetupMenu(void);



From nobody at sheep.berlios.de  Wed Jul 27 22:57:03 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 27 Jul 2005 22:57:03 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.95,1.96 i18n.c,1.5,1.6 mpeg2decoder.c,1.48,1.49 setup-softdevice.c,1.24,1.25 video-dfb.c,1.35,1.36
Message-ID: <200507272057.j6RKv3I27113@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25045

Modified Files:
	CHANGELOG i18n.c mpeg2decoder.c setup-softdevice.c video-dfb.c 
Log Message:
compile fix for newer ffmpeg versions (> 2005-07-17 22:24:35) by Antonio
fix for video-dfb.c change from 2005-07-16 by Rolf Ahrenberg
more OSD entries translateable by Rolf Ahrenberg
more finnish translations by Rolf Ahrenberg
limit cropping amount to 50 each


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.95
retrieving revision 1.96
diff -C2 -d -r1.95 -r1.96
*** CHANGELOG	24 Jul 2005 20:16:38 -0000	1.95
--- CHANGELOG	27 Jul 2005 20:57:00 -0000	1.96
***************
*** 1,3 ****
--- 1,9 ----
  Changelog
+ 2005-07-27:
+     - compile fix for newer ffmpeg versions (> 2005-07-17 22:24:35) by Antonio
+     - fix for video-dfb.c change from 2005-07-16 by Rolf Ahrenberg
+     - more OSD entries translateable by Rolf Ahrenberg
+     - more finnish translations by Rolf Ahrenberg
+     - limit cropping amount to 50 each
  2005-07-24:
      - finnish translations by Rolf Ahrenberg

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** i18n.c	24 Jul 2005 20:16:38 -0000	1.5
--- i18n.c	27 Jul 2005 20:57:00 -0000	1.6
***************
*** 87,91 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvan leikkaus",   //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 87,91 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvan rajaustapa", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 317,321 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "AC3-tapa",     //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 317,321 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "AC3-??net",    //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 340,344 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Puskurointi",  //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 340,344 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Puskurointitapa", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 363,367 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "N?pp?in kuvan leikkaukselle", //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 363,367 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "N?pp?in kuvan rajaukselle", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 386,390 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Leikkaa kuvaa ylh??lt?", //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 386,390 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Rajaa kuvaa ylh??lt?", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 409,413 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Leikkaa kuvaa alhaalta", //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 409,413 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Rajaa kuvaa alhaalta", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 432,436 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Leikkaa kuvaa vasemmalta", //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 432,436 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Rajaa kuvaa vasemmalta", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 455,459 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Leikkaa kuvaa oikealta", //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 455,459 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Rajaa kuvaa oikealta", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 478,482 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvan j?lkik?sittely", //  9                                                                                                      
      "",             // 10 TODO
      "",             // 11 TODO
--- 478,482 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "Kuvan j?lkik?sittely", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 525,528 ****
--- 525,804 ----
      "",             //  8 TODO
      "K?yt? StretchBlit-metodia", //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "none",         //  1
+     "keine",        //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "ei",           //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "fast",         //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "nopea",        //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "default",      //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "oletus",       //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "playing",      //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "p??ll?",       //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "suspended",    //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "keskeytetty",  //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "pseudo",       //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "n?enn?inen",   //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "software",     //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "ohjelmallinen",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "save",         //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "tallennus",    //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "good seeking", //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "nopea haku",   //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "HDTV",         //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "HDTV",         //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "16:9 wide",    //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "16:9 laaja",   //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "4:3 normal",   //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "4:3 normaali", //  9
      "",             // 10 TODO
      "",             // 11 TODO

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** mpeg2decoder.c	22 Jul 2005 21:18:41 -0000	1.48
--- mpeg2decoder.c	27 Jul 2005 20:57:00 -0000	1.49
***************
*** 1192,1198 ****
    // check if there are new streams
    if (AudioIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
!       ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO && 
        AudioIdx != pkt.stream_index) {
!    
      CMDDEB("new Audio stream index.. old %d new %d\n",
        AudioIdx,pkt.stream_index);
--- 1192,1202 ----
    // check if there are new streams
    if (AudioIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
! #if LIBAVFORMAT_BUILD > 4628
!       ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_AUDIO &&
! #else
!       ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO &&
! #endif
        AudioIdx != pkt.stream_index) {
! 
      CMDDEB("new Audio stream index.. old %d new %d\n",
        AudioIdx,pkt.stream_index);
***************
*** 1203,1213 ****
        aout=NULL;
      };
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
                   audioOut, audioMode );
!   } else 
    if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
!       ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO && 
        VideoIdx!=pkt.stream_index) {
!   
      CMDDEB("new Video stream index.. old %d new %d\n",
        VideoIdx,pkt.stream_index);
--- 1207,1225 ----
        aout=NULL;
      };
+ #if LIBAVFORMAT_BUILD > 4628
+     aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
+ #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
+ #endif
                   audioOut, audioMode );
!   } else
    if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
! #if LIBAVFORMAT_BUILD > 4628
!       ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO &&
! #else
!       ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO &&
! #endif
        VideoIdx!=pkt.stream_index) {
! 
      CMDDEB("new Video stream index.. old %d new %d\n",
        VideoIdx,pkt.stream_index);
***************
*** 1218,1222 ****
--- 1230,1238 ----
        vout = NULL;
      };
+ #if LIBAVFORMAT_BUILD > 4628
+     vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
+ #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
+ #endif
                     videoOut, &clock, Speed );
    };

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** setup-softdevice.c	20 Jul 2005 20:24:10 -0000	1.24
--- setup-softdevice.c	27 Jul 2005 20:57:00 -0000	1.25
***************
*** 14,44 ****
  #define MAXAVOFFSET (250)
  
  /* ----------------------------------------------------------------------------
   * index to this array correspond to AFD values
   */
! char *crop_str [] = {
!         "none",
!         "4:3",
!         "16:9",
!         "14:9",
!         NULL
!      };
! #define CROPMODEMAX 3
! #define CROPMODES (CROPMODEMAX+1)
  
  /* ---------------------------------------------------------------------------
   */
! char *deint_str [] = {
!         "none",
!         "lavc",
  #ifdef FB_SUPPORT
!         "FB-intern",
  #endif        
  #ifdef PP_LIBAVCODEC
!         "linblend",
!         "linipol",
!         "cubicipol",
!         "median",
!         "ffmpeg",
  #endif //PP_LIBAVCODEC
          NULL
--- 14,41 ----
  #define MAXAVOFFSET (250)
  
+ #define MAX_CROP_LINES  50
+ #define MAX_CROP_COLS   50
+ 
  /* ----------------------------------------------------------------------------
   * index to this array correspond to AFD values
   */
! #define SETUP_CROPMODES 5
! const char *crop_str[SETUP_CROPMODES];
  
  /* ---------------------------------------------------------------------------
   */
! #define SETUP_DEINTMODES 9
! const char *deint_str[SETUP_DEINTMODES] = {
!         "none",      // translated in cMenuSetupSoftdevice::cMenuSetupSoftdevice()
!         "lavc",      // no need to translate
  #ifdef FB_SUPPORT
!         "FB-intern", // no need to translate
  #endif        
  #ifdef PP_LIBAVCODEC
!         "linblend",  // no need to translate
!         "linipol",   // no need to translate
!         "cubicipol", // no need to translate
!         "median",    // no need to translate
!         "ffmpeg",    // no need to translate
  #endif //PP_LIBAVCODEC
          NULL
***************
*** 47,136 ****
  /*-----------------------------------------------------------------------------
   */
! char *pp_str[]={
!         "none",
!         "fast",
!         "default",
!         NULL
!       };
  
  /* ----------------------------------------------------------------------------
   * allow changing of output pixfmt
   */
! char *pix_fmt [] = {
!         "I420",
!         "YV12",
!         "YUY2",
!         NULL
!      };
  
  /* ----------------------------------------------------------------------------
   * give some readable values for aspect ratio selection instead fo 0, 1 values
   */
! char *xv_startup_aspect [] = {
!         "16:9 wide",
!         "4:3 normal",
!         NULL
!      };
  
! /* ----------------------------------------------------------------------------
   */
! char *suspendVideo [] = {
!         "playing",
!         "suspended",
!         NULL
!      };
  
! /* ----------------------------------------------------------------------------
   */
! char *osdMode [] = {
!         "pseudo",
!         "software",
!         NULL
!      };
  
! /* ----------------------------------------------------------------------------
   */
! char *videoAspectNames [] = {
!         "Default",
!         "5:4",
!         "4:3",
!         "16:9",
!         "16:10",
!         NULL
!      };
! /* ----------------------------------------------------------------------------
   */
! char *bufferModes [] = {
!         "save",
!         "good seeking",
!         "HDTV",
!         NULL
!      };
  
! /* ----------------------------------------------------------------------------
   */
! char *ac3ModeNames [] = {
!         "Stereo (2CH)",
!         "5.1 S/P-DIF",
!         "5.1 Analog (4CH)",
!         "5.1 Analog (6CH)",
!         NULL
!      };
  
! /* ----------------------------------------------------------------------------
   */
! char *userKeyUsage [] = {
!         "none",
!         "User1",
!         "User2",
!         "User3",
!         "User4",
!         "User5",
!         "User6",
!         "User7",
!         "User8",
!         "User9",
!         NULL
!      };
  /* ----------------------------------------------------------------------------
   */
--- 44,94 ----
  /*-----------------------------------------------------------------------------
   */
! #ifdef PP_LIBAVCODEC
! #define SETUP_PPMODES 4
! const char *pp_str[SETUP_PPMODES];
! #endif //PP_LIBAVCODEC
  
  /* ----------------------------------------------------------------------------
   * allow changing of output pixfmt
   */
! #define SETUP_PIXFMT 4
! const char *pix_fmt[SETUP_PIXFMT];
  
  /* ----------------------------------------------------------------------------
   * give some readable values for aspect ratio selection instead fo 0, 1 values
   */
! #define SETUP_XVSTARTUPASPECT 3
! const char *xv_startup_aspect[SETUP_XVSTARTUPASPECT];
  
! /*-----------------------------------------------------------------------------
   */
! #define SETUP_SUSPENDVIDEO 3
! const char *suspendVideo[SETUP_SUSPENDVIDEO];
  
! /*-----------------------------------------------------------------------------
   */
! #define SETUP_OSDMODES 3
! const char *osdMode[SETUP_OSDMODES];
  
! /*-----------------------------------------------------------------------------
   */
! #define SETUP_VIDEOASPECTNAMES 6
! const char *videoAspectNames[SETUP_VIDEOASPECTNAMES];
! 
! /*-----------------------------------------------------------------------------
   */
! #define SETUP_BUFFERMODES 4
! const char *bufferModes[SETUP_BUFFERMODES];
  
! /*-----------------------------------------------------------------------------
   */
! #define SETUP_AC3MODENAMES 5
! const char *ac3ModeNames[SETUP_AC3MODENAMES];
  
! /*-----------------------------------------------------------------------------
   */
! #define SETUP_USERKEYS 11
! const char *userKeyUsage[SETUP_USERKEYS];
! 
  /* ----------------------------------------------------------------------------
   */
***************
*** 219,223 ****
    else if(!strcasecmp(Name,"CropMode")) {
      cropMode = atoi(Value);
!     cropMode = clamp (0, cropMode, CROPMODEMAX);
      fprintf (stderr, "[setup-softdevice] cropping mode set to %d (%s)\n",
               cropMode,
--- 177,181 ----
    else if(!strcasecmp(Name,"CropMode")) {
      cropMode = atoi(Value);
!     cropMode = clamp (0, cropMode, (SETUP_CROPMODES-1));
      fprintf (stderr, "[setup-softdevice] cropping mode set to %d (%s)\n",
               cropMode,
***************
*** 232,251 ****
    } else if(!strcasecmp(Name,"CropTopLines")) {
      cropTopLines = atoi(Value);
!     cropTopLines = clamp (0, cropTopLines, 100);
      fprintf(stderr,"[setup-softdevice] Cropping %d lines from top\n",
              cropTopLines);
    } else if(!strcasecmp(Name,"CropBottomLines")) {
      cropBottomLines = atoi(Value);
!     cropBottomLines = clamp (0, cropBottomLines, 100);
      fprintf(stderr,"[setup-softdevice] Cropping %d lines from bottom\n",
              cropBottomLines);
    } else if(!strcasecmp(Name,"CropLeftCols")) {
      cropLeftCols = atoi(Value);
!     cropLeftCols = clamp (0, cropLeftCols, 100);
      fprintf(stderr,"[setup-softdevice] Cropping %d columns from left\n",
              cropLeftCols);
    } else if(!strcasecmp(Name,"CropRightCols")) {
      cropRightCols = atoi(Value);
!     cropRightCols = clamp (0, cropRightCols, 100);
      fprintf(stderr,"[setup-softdevice] Cropping %d columns from right\n",
              cropRightCols);
--- 190,209 ----
    } else if(!strcasecmp(Name,"CropTopLines")) {
      cropTopLines = atoi(Value);
!     cropTopLines = clamp (0, cropTopLines, MAX_CROP_LINES);
      fprintf(stderr,"[setup-softdevice] Cropping %d lines from top\n",
              cropTopLines);
    } else if(!strcasecmp(Name,"CropBottomLines")) {
      cropBottomLines = atoi(Value);
!     cropBottomLines = clamp (0, cropBottomLines, MAX_CROP_LINES);
      fprintf(stderr,"[setup-softdevice] Cropping %d lines from bottom\n",
              cropBottomLines);
    } else if(!strcasecmp(Name,"CropLeftCols")) {
      cropLeftCols = atoi(Value);
!     cropLeftCols = clamp (0, cropLeftCols, MAX_CROP_COLS);
      fprintf(stderr,"[setup-softdevice] Cropping %d columns from left\n",
              cropLeftCols);
    } else if(!strcasecmp(Name,"CropRightCols")) {
      cropRightCols = atoi(Value);
!     cropRightCols = clamp (0, cropRightCols, MAX_CROP_COLS);
      fprintf(stderr,"[setup-softdevice] Cropping %d columns from right\n",
              cropRightCols);
***************
*** 326,337 ****
    else return NULL;
  }
  /* ---------------------------------------------------------------------------
   */
- 
  char *cSetupStore::getPPValue(void)
  {
!   if (strcmp(pp_str[ppMethod], "none") == 0) return "";
!   else if (strcmp(pp_str[ppMethod], "fast") == 0) return "fa";
!   else if (strcmp(pp_str[ppMethod], "default") == 0) return "de";
    else return NULL;
  }
--- 284,295 ----
    else return NULL;
  }
+ 
  /* ---------------------------------------------------------------------------
   */
  char *cSetupStore::getPPValue(void)
  {
!   if (strcmp(pp_str[ppMethod], tr("none")) == 0) return "";
!   else if (strcmp(pp_str[ppMethod], tr("fast")) == 0) return "fa";
!   else if (strcmp(pp_str[ppMethod], tr("default")) == 0) return "de";
    else return NULL;
  }
***************
*** 341,345 ****
  void cSetupStore::CropModeNext(void)
  {
!   cropMode = (cropMode == CROPMODEMAX) ? 0 : cropMode + 1;
  }
  
--- 299,303 ----
  void cSetupStore::CropModeNext(void)
  {
!   cropMode = (cropMode == (SETUP_CROPMODES-1)) ? 0 : cropMode + 1;
  }
  
***************
*** 365,370 ****
  }
  
! /* ---------------------------------------------------------------------------
!  */
  cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
  {
--- 323,327 ----
  }
  
! /* --------------------------------------------------------------------------- */
  cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
  {
***************
*** 377,383 ****
    if (data->outputMethod == VOUT_XV)
    {
      Add(new cMenuEditStraItem(tr("Xv startup aspect"),
                               &data->xvAspect,
!                              2,
                               xv_startup_aspect));
  
--- 334,343 ----
    if (data->outputMethod == VOUT_XV)
    {
+     xv_startup_aspect[0] = tr("16:9 wide");
+     xv_startup_aspect[1] = tr("4:3 normal");
+     xv_startup_aspect[2] = NULL;
      Add(new cMenuEditStraItem(tr("Xv startup aspect"),
                               &data->xvAspect,
!                              (SETUP_XVSTARTUPASPECT-1),
                               xv_startup_aspect));
  
***************
*** 390,401 ****
    }
  
    Add(new cMenuEditStraItem(tr("CropMode"),
                              &data->cropMode,
!                             CROPMODES,
                              crop_str));
  
    Add(new cMenuEditStraItem(tr("CropModeToggleKey"),
                              &data->cropModeToggleKey,
!                             10,
                              userKeyUsage));
  
--- 350,377 ----
    }
  
+   crop_str[0] = tr("none");
+   crop_str[1] = "4:3";  // no need to translate
+   crop_str[2] = "16:9"; // no need to translate
+   crop_str[3] = "14:9"; // no need to translate
+   crop_str[4] = NULL;
    Add(new cMenuEditStraItem(tr("CropMode"),
                              &data->cropMode,
!                             (SETUP_CROPMODES-1),
                              crop_str));
  
+   userKeyUsage[0] = tr("none");
+   userKeyUsage[1] = "User1"; // no need to translate
+   userKeyUsage[2] = "User2"; // no need to translate
+   userKeyUsage[3] = "User3"; // no need to translate
+   userKeyUsage[4] = "User4"; // no need to translate
+   userKeyUsage[5] = "User5"; // no need to translate
+   userKeyUsage[6] = "User6"; // no need to translate
+   userKeyUsage[7] = "User7"; // no need to translate
+   userKeyUsage[8] = "User8"; // no need to translate
+   userKeyUsage[9] = "User9"; // no need to translate
+   userKeyUsage[10] = NULL;
    Add(new cMenuEditStraItem(tr("CropModeToggleKey"),
                              &data->cropModeToggleKey,
!                             (SETUP_USERKEYS-1),
                              userKeyUsage));
  
***************
*** 405,415 ****
                               &data->cropTopLines,
                               0,
!                              100));
  
      Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
                               &data->cropBottomLines,
                               0,
!                              100));
!   }                            
  
    if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_DFB)
--- 381,391 ----
                               &data->cropTopLines,
                               0,
!                              MAX_CROP_LINES));
  
      Add(new cMenuEditIntItem(tr("Crop lines from bottom"),
                               &data->cropBottomLines,
                               0,
!                              MAX_CROP_LINES));
!   }
  
    if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_DFB)
***************
*** 418,428 ****
                               &data->cropLeftCols,
                               0,
!                              100));
      Add(new cMenuEditIntItem(tr("Crop columns from right"),
                               &data->cropRightCols,
                               0,
!                              100));
    }
  
    if (data->outputMethod == VOUT_FB)
    {
--- 394,405 ----
                               &data->cropLeftCols,
                               0,
!                              MAX_CROP_COLS));
      Add(new cMenuEditIntItem(tr("Crop columns from right"),
                               &data->cropRightCols,
                               0,
!                              MAX_CROP_COLS));
    }
  
+   deint_str[0] = tr("none");
    if (data->outputMethod == VOUT_FB)
    {
***************
*** 449,465 ****
    
  #ifdef PP_LIBAVCODEC
    Add(new cMenuEditStraItem(tr("Postprocessing Method"),
!                               &data->ppMethod,3,pp_str));
    Add(new cMenuEditIntItem(tr("Postprocessing Quality"),
                                &data->ppQuality,0,6));
  #endif
    Add(new cMenuEditStraItem(tr("Buffer Mode"),
!                               &data->bufferMode,3,bufferModes));
    
    if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
    {
      Add(new cMenuEditStraItem(tr("Pixel Format"),
                                &data->pixelFormat,
!                               3,
                                pix_fmt));
    }
--- 426,455 ----
    
  #ifdef PP_LIBAVCODEC
+   pp_str[0] = tr("none");
+   pp_str[1] = tr("fast");
+   pp_str[2] = tr("default");
+   pp_str[3] = NULL;
    Add(new cMenuEditStraItem(tr("Postprocessing Method"),
!                               &data->ppMethod,(SETUP_PPMODES-1),pp_str));
    Add(new cMenuEditIntItem(tr("Postprocessing Quality"),
                                &data->ppQuality,0,6));
  #endif
+ 
+   bufferModes[0] = tr("save");
+   bufferModes[1] = tr("good seeking");
+   bufferModes[2] = tr("HDTV");
+   bufferModes[3] = NULL;
    Add(new cMenuEditStraItem(tr("Buffer Mode"),
!                               &data->bufferMode,(SETUP_BUFFERMODES-1),bufferModes));
    
    if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
    {
+     pix_fmt[0] = "I420"; // no need to translate
+     pix_fmt[1] = "YV12"; // no need to translate
+     pix_fmt[2] = "YUY2"; // no need to translate
+     pix_fmt[3] = NULL;
      Add(new cMenuEditStraItem(tr("Pixel Format"),
                                &data->pixelFormat,
!                               (SETUP_PIXFMT-1),
                                pix_fmt));
    }
***************
*** 478,498 ****
                             MINAVOFFSET, MAXAVOFFSET));
  
    Add(new cMenuEditStraItem(tr("Screen Aspect"),
                              &data->screenPixelAspect,
!                             5,
                              videoAspectNames));
  
    Add(new cMenuEditStraItem(tr("Playback"),
                              &data->shouldSuspend,
!                             2,
                              suspendVideo));
    Add(new cMenuEditStraItem(tr("OSD alpha blending"),
                              &data->osdMode,
!                             2,
                              osdMode));
  
    Add(new cMenuEditStraItem(tr("AC3 Mode"),
                              &data->ac3Mode,
!                             4,
                              ac3ModeNames));
  }
--- 468,506 ----
                             MINAVOFFSET, MAXAVOFFSET));
  
+   videoAspectNames[0] = tr("default");
+   videoAspectNames[1] = "5:4";   // no need to translate
+   videoAspectNames[2] = "4:3";   // no need to translate
+   videoAspectNames[3] = "16:9";  // no need to translate
+   videoAspectNames[4] = "16:10"; // no need to translate
+   videoAspectNames[5] = NULL;
    Add(new cMenuEditStraItem(tr("Screen Aspect"),
                              &data->screenPixelAspect,
!                             (SETUP_VIDEOASPECTNAMES-1),
                              videoAspectNames));
  
+   suspendVideo[0] = tr("playing");
+   suspendVideo[1] = tr("suspended");
+   suspendVideo[2] = NULL;
    Add(new cMenuEditStraItem(tr("Playback"),
                              &data->shouldSuspend,
!                             (SETUP_SUSPENDVIDEO-1),
                              suspendVideo));
+ 
+   osdMode[0] = tr("pseudo");
+   osdMode[1] = tr("software");
+   osdMode[2] = NULL;
    Add(new cMenuEditStraItem(tr("OSD alpha blending"),
                              &data->osdMode,
!                             (SETUP_OSDMODES-1),
                              osdMode));
  
+   ac3ModeNames[0] = "Stereo (2CH)";     // no need to translate?
+   ac3ModeNames[1] = "5.1 S/P-DIF";      // no need to translate?
+   ac3ModeNames[2] = "5.1 Analog (4CH)"; // no need to translate?
+   ac3ModeNames[3] = "5.1 Analog (6CH)"; // no need to translate?
+   ac3ModeNames[4] = NULL;
    Add(new cMenuEditStraItem(tr("AC3 Mode"),
                              &data->ac3Mode,
!                             (SETUP_AC3MODENAMES-1),
                              ac3ModeNames));
  }

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** video-dfb.c	20 Jul 2005 20:24:10 -0000	1.35
--- video-dfb.c	27 Jul 2005 20:57:00 -0000	1.36
***************
*** 20,26 ****
  # define HAVE_SetSourceLocation 0
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
! #   define GraphicsDeviceDescription 0
  # else
! #   define GraphicsDeviceDescription 1
  # endif
  # if (DIRECTFB_MAJOR_VERSION > 0 || ((DIRECTFB_MINOR_VERSION == 9) && DIRECTFB_MICRO_VERSION > 22))
--- 20,26 ----
  # define HAVE_SetSourceLocation 0
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
! #   define HAVE_GraphicsDeviceDescription 0
  # else
! #   define HAVE_GraphicsDeviceDescription 1
  # endif
  # if (DIRECTFB_MAJOR_VERSION > 0 || ((DIRECTFB_MINOR_VERSION == 9) && DIRECTFB_MICRO_VERSION > 22))



From nobody at sheep.berlios.de  Fri Jul 29 22:45:43 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 29 Jul 2005 22:45:43 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.96,1.97 i18n.c,1.6,1.7 setup-softdevice.c,1.25,1.26
Message-ID: <200507292045.j6TKjhI16971@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13645

Modified Files:
	CHANGELOG i18n.c setup-softdevice.c 
Log Message:
some small changes on finnish translations by Rolf Ahrenberg
fix for segfaults in setup-softdevice.c by previous change


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.96
retrieving revision 1.97
diff -C2 -d -r1.96 -r1.97
*** CHANGELOG	27 Jul 2005 20:57:00 -0000	1.96
--- CHANGELOG	29 Jul 2005 20:45:40 -0000	1.97
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-07-29:
+     - some small changes on finnish translations by Rolf Ahrenberg
+     - fix for segfaults in setup-softdevice.c by previous change
  2005-07-27:
      - compile fix for newer ffmpeg versions (> 2005-07-17 22:24:35) by Antonio

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** i18n.c	27 Jul 2005 20:57:00 -0000	1.6
--- i18n.c	29 Jul 2005 20:45:40 -0000	1.7
***************
*** 225,229 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "Toisto",       //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 225,229 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "N?yt?n ulostulo", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 616,620 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "p??ll?",       //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 616,620 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "toiminnassa",  //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 639,643 ****
      "",             //  7 TODO
      "",             //  8 TODO
!     "keskeytetty",  //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 639,643 ----
      "",             //  7 TODO
      "",             //  8 TODO
!     "pys?ytetty",   //  9
      "",             // 10 TODO
      "",             // 11 TODO

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** setup-softdevice.c	27 Jul 2005 20:57:00 -0000	1.25
--- setup-softdevice.c	29 Jul 2005 20:45:40 -0000	1.26
***************
*** 44,51 ****
  /*-----------------------------------------------------------------------------
   */
- #ifdef PP_LIBAVCODEC
  #define SETUP_PPMODES 4
  const char *pp_str[SETUP_PPMODES];
- #endif //PP_LIBAVCODEC
  
  /* ----------------------------------------------------------------------------
--- 44,49 ----
***************
*** 69,73 ****
   */
  #define SETUP_OSDMODES 3
! const char *osdMode[SETUP_OSDMODES];
  
  /*-----------------------------------------------------------------------------
--- 67,71 ----
   */
  #define SETUP_OSDMODES 3
! const char *osdModeNames[SETUP_OSDMODES];
  
  /*-----------------------------------------------------------------------------
***************
*** 136,139 ****
--- 134,197 ----
    strcpy (alsaSPDIFDevice, "hw:0,2");
    voArgs = aoArgs = NULL;
+ 
+   xv_startup_aspect[0] = tr("16:9 wide");
+   xv_startup_aspect[1] = tr("4:3 normal");
+   xv_startup_aspect[2] = NULL;
+ 
+   deint_str[0] = tr("none");
+ 
+   pp_str[0] = tr("none");
+   pp_str[1] = tr("fast");
+   pp_str[2] = tr("default");
+   pp_str[3] = NULL;
+ 
+   bufferModes[0] = tr("save");
+   bufferModes[1] = tr("good seeking");
+   bufferModes[2] = tr("HDTV");
+   bufferModes[3] = NULL;
+ 
+   pix_fmt[0] = "I420"; // no need to translate
+   pix_fmt[1] = "YV12"; // no need to translate
+   pix_fmt[2] = "YUY2"; // no need to translate
+   pix_fmt[3] = NULL;
+ 
+   crop_str[0] = tr("none");
+   crop_str[1] = "4:3";  // no need to translate
+   crop_str[2] = "16:9"; // no need to translate
+   crop_str[3] = "14:9"; // no need to translate
+   crop_str[4] = NULL;
+ 
+   userKeyUsage[0] = tr("none");
+   userKeyUsage[1] = "User1"; // no need to translate
+   userKeyUsage[2] = "User2"; // no need to translate
+   userKeyUsage[3] = "User3"; // no need to translate
+   userKeyUsage[4] = "User4"; // no need to translate
+   userKeyUsage[5] = "User5"; // no need to translate
+   userKeyUsage[6] = "User6"; // no need to translate
+   userKeyUsage[7] = "User7"; // no need to translate
+   userKeyUsage[8] = "User8"; // no need to translate
+   userKeyUsage[9] = "User9"; // no need to translate
+   userKeyUsage[10] = NULL;
+ 
+   videoAspectNames[0] = tr("default");
+   videoAspectNames[1] = "5:4";   // no need to translate
+   videoAspectNames[2] = "4:3";   // no need to translate
+   videoAspectNames[3] = "16:9";  // no need to translate
+   videoAspectNames[4] = "16:10"; // no need to translate
+   videoAspectNames[5] = NULL;
+ 
+   suspendVideo[0] = tr("playing");
+   suspendVideo[1] = tr("suspended");
+   suspendVideo[2] = NULL;
+ 
+   osdModeNames[0] = tr("pseudo");
+   osdModeNames[1] = tr("software");
+   osdModeNames[2] = NULL;
+ 
+   ac3ModeNames[0] = "Stereo (2CH)";     // no need to translate?
+   ac3ModeNames[1] = "5.1 S/P-DIF";      // no need to translate?
+   ac3ModeNames[2] = "5.1 Analog (4CH)"; // no need to translate?
+   ac3ModeNames[3] = "5.1 Analog (6CH)"; // no need to translate?
+   ac3ModeNames[4] = NULL;
  }
  
***************
*** 336,340 ****
      xv_startup_aspect[0] = tr("16:9 wide");
      xv_startup_aspect[1] = tr("4:3 normal");
-     xv_startup_aspect[2] = NULL;
      Add(new cMenuEditStraItem(tr("Xv startup aspect"),
                               &data->xvAspect,
--- 394,397 ----
***************
*** 351,358 ****
  
    crop_str[0] = tr("none");
-   crop_str[1] = "4:3";  // no need to translate
-   crop_str[2] = "16:9"; // no need to translate
-   crop_str[3] = "14:9"; // no need to translate
-   crop_str[4] = NULL;
    Add(new cMenuEditStraItem(tr("CropMode"),
                              &data->cropMode,
--- 408,411 ----
***************
*** 361,374 ****
  
    userKeyUsage[0] = tr("none");
-   userKeyUsage[1] = "User1"; // no need to translate
-   userKeyUsage[2] = "User2"; // no need to translate
-   userKeyUsage[3] = "User3"; // no need to translate
-   userKeyUsage[4] = "User4"; // no need to translate
-   userKeyUsage[5] = "User5"; // no need to translate
-   userKeyUsage[6] = "User6"; // no need to translate
-   userKeyUsage[7] = "User7"; // no need to translate
-   userKeyUsage[8] = "User8"; // no need to translate
-   userKeyUsage[9] = "User9"; // no need to translate
-   userKeyUsage[10] = NULL;
    Add(new cMenuEditStraItem(tr("CropModeToggleKey"),
                              &data->cropModeToggleKey,
--- 414,417 ----
***************
*** 429,433 ****
    pp_str[1] = tr("fast");
    pp_str[2] = tr("default");
-   pp_str[3] = NULL;
    Add(new cMenuEditStraItem(tr("Postprocessing Method"),
                                &data->ppMethod,(SETUP_PPMODES-1),pp_str));
--- 472,475 ----
***************
*** 439,443 ****
    bufferModes[1] = tr("good seeking");
    bufferModes[2] = tr("HDTV");
-   bufferModes[3] = NULL;
    Add(new cMenuEditStraItem(tr("Buffer Mode"),
                                &data->bufferMode,(SETUP_BUFFERMODES-1),bufferModes));
--- 481,484 ----
***************
*** 445,452 ****
    if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
    {
-     pix_fmt[0] = "I420"; // no need to translate
-     pix_fmt[1] = "YV12"; // no need to translate
-     pix_fmt[2] = "YUY2"; // no need to translate
-     pix_fmt[3] = NULL;
      Add(new cMenuEditStraItem(tr("Pixel Format"),
                                &data->pixelFormat,
--- 486,489 ----
***************
*** 469,477 ****
  
    videoAspectNames[0] = tr("default");
-   videoAspectNames[1] = "5:4";   // no need to translate
-   videoAspectNames[2] = "4:3";   // no need to translate
-   videoAspectNames[3] = "16:9";  // no need to translate
-   videoAspectNames[4] = "16:10"; // no need to translate
-   videoAspectNames[5] = NULL;
    Add(new cMenuEditStraItem(tr("Screen Aspect"),
                              &data->screenPixelAspect,
--- 506,509 ----
***************
*** 481,485 ****
    suspendVideo[0] = tr("playing");
    suspendVideo[1] = tr("suspended");
-   suspendVideo[2] = NULL;
    Add(new cMenuEditStraItem(tr("Playback"),
                              &data->shouldSuspend,
--- 513,516 ----
***************
*** 487,503 ****
                              suspendVideo));
  
!   osdMode[0] = tr("pseudo");
!   osdMode[1] = tr("software");
!   osdMode[2] = NULL;
    Add(new cMenuEditStraItem(tr("OSD alpha blending"),
                              &data->osdMode,
                              (SETUP_OSDMODES-1),
!                             osdMode));
  
-   ac3ModeNames[0] = "Stereo (2CH)";     // no need to translate?
-   ac3ModeNames[1] = "5.1 S/P-DIF";      // no need to translate?
-   ac3ModeNames[2] = "5.1 Analog (4CH)"; // no need to translate?
-   ac3ModeNames[3] = "5.1 Analog (6CH)"; // no need to translate?
-   ac3ModeNames[4] = NULL;
    Add(new cMenuEditStraItem(tr("AC3 Mode"),
                              &data->ac3Mode,
--- 518,528 ----
                              suspendVideo));
  
!   osdModeNames[0] = tr("pseudo");
!   osdModeNames[1] = tr("software");
    Add(new cMenuEditStraItem(tr("OSD alpha blending"),
                              &data->osdMode,
                              (SETUP_OSDMODES-1),
!                             osdModeNames));
  
    Add(new cMenuEditStraItem(tr("AC3 Mode"),
                              &data->ac3Mode,



From nobody at sheep.berlios.de  Sun Jul 31 09:58:25 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 31 Jul 2005 09:58:25 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.97,1.98 setup-softdevice.c,1.26,1.27
Message-ID: <200507310758.j6V7wPI07061@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25277

Modified Files:
	CHANGELOG setup-softdevice.c 
Log Message:
- return NULL in getPPValue when compiled without libpostproc



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.97
retrieving revision 1.98
diff -C2 -d -r1.97 -r1.98
*** CHANGELOG	29 Jul 2005 20:45:40 -0000	1.97
--- CHANGELOG	31 Jul 2005 07:58:20 -0000	1.98
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-07-31:
+     - return NULL in getPPValue when compiled without postproc lib 
+       (suggested by Antonio)
  2005-07-29:
      - some small changes on finnish translations by Rolf Ahrenberg

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** setup-softdevice.c	29 Jul 2005 20:45:40 -0000	1.26
--- setup-softdevice.c	31 Jul 2005 07:58:20 -0000	1.27
***************
*** 347,354 ****
  char *cSetupStore::getPPValue(void)
  {
    if (strcmp(pp_str[ppMethod], tr("none")) == 0) return "";
    else if (strcmp(pp_str[ppMethod], tr("fast")) == 0) return "fa";
    else if (strcmp(pp_str[ppMethod], tr("default")) == 0) return "de";
!   else return NULL;
  }
  
--- 347,356 ----
  char *cSetupStore::getPPValue(void)
  {
+ #ifdef PP_LIBAVCODEC
    if (strcmp(pp_str[ppMethod], tr("none")) == 0) return "";
    else if (strcmp(pp_str[ppMethod], tr("fast")) == 0) return "fa";
    else if (strcmp(pp_str[ppMethod], tr("default")) == 0) return "de";
! #endif
!   return NULL;
  }
  



From nobody at sheep.berlios.de  Sun Jul 31 10:21:25 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 31 Jul 2005 10:21:25 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.98,1.99 softdevice.c,1.37,1.38
Message-ID: <200507310821.j6V8LPI07407@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv926

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
- introduce SOFTDEB
- call decoder->Clear in clear...


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.98
retrieving revision 1.99
diff -C2 -d -r1.98 -r1.99
*** CHANGELOG	31 Jul 2005 07:58:20 -0000	1.98
--- CHANGELOG	31 Jul 2005 08:21:22 -0000	1.99
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-07-31:
+     - introduce SOFTDEB, more checks agains NULL dereferences
+     - call decoder->Clear in Clear
      - return NULL in getPPValue when compiled without postproc lib 
        (suggested by Antonio)

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** softdevice.c	22 Jul 2005 21:18:41 -0000	1.37
--- softdevice.c	31 Jul 2005 08:21:22 -0000	1.38
***************
*** 78,81 ****
--- 78,87 ----
  #define AOUT_DUMMY  2
  
+ //#define SOFTDEB(out...) {printf("softdeb[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
+ 
+ #ifndef SOFTDEB
+ #define SOFTDEB(out...)
+ #endif
+ 
  #if VDRVERSNUM >= 10307
  
***************
*** 379,383 ****
  
  int64_t cSoftDevice::GetSTC(void) {
!   return decoder->GetSTC();
  };
  
--- 385,389 ----
  
  int64_t cSoftDevice::GetSTC(void) {
!   return (decoder?decoder->GetSTC():NULL);
  };
  
***************
*** 430,433 ****
--- 436,442 ----
  bool cSoftDevice::SetPlayMode(ePlayMode PlayMode)
  {
+     if (!decoder)
+        return false;
+     
      packetMode=PlayMode < 0;
      PlayMode=(ePlayMode) abs(PlayMode);
***************
*** 463,472 ****
  void cSoftDevice::TrickSpeed(int Speed)
  {
!     //fprintf(stderr,"[softdevice] Trickspeed(%d) ...\n",Speed);
!     decoder->TrickSpeed(Speed);
  }
  void cSoftDevice::Clear(void)
  {
!     //fprintf(stderr,"[softdevice] Clear ...\n");
      if ( ! decoder )
        return;
--- 472,482 ----
  void cSoftDevice::TrickSpeed(int Speed)
  {
!     SOFTDEB("Trickspeed(%d) ...\n",Speed);
!     if (decoder)
!       decoder->TrickSpeed(Speed);
  }
  void cSoftDevice::Clear(void)
  {
!     SOFTDEB("Clear ...\n");
      if ( ! decoder )
        return;
***************
*** 474,498 ****
      if ( !packetMode ) {
        cDevice::Clear();
!     }
!     decoder->ClearPacketQueue();
  }
  void cSoftDevice::Play(void)
  {
!     //fprintf(stderr,"[softdevice] Play...\n");
      cDevice::Play();
!     decoder->TrickSpeed(1);
!     decoder->Play();
  }
  
  void cSoftDevice::Freeze(void)
  {
!     //fprintf(stderr,"[softdevice] Freeze...\n");
      cDevice::Freeze();
!     decoder->Freeze();
  }
  
  void cSoftDevice::Mute(void)
  {
!     //fprintf(stderr,"[softdevice] Mute not implemented yet...\n");
      cDevice::Mute();
  }
--- 484,511 ----
      if ( !packetMode ) {
        cDevice::Clear();
!       decoder->Clear();
!     } else decoder->ClearPacketQueue();
  }
  void cSoftDevice::Play(void)
  {
!     SOFTDEB("Play...\n");
      cDevice::Play();
!     if (decoder) {
!       decoder->TrickSpeed(1);
!       decoder->Play();
!     };
  }
  
  void cSoftDevice::Freeze(void)
  {
!     SOFTDEB("Freeze...\n");
      cDevice::Freeze();
!     if (decoder)
!       decoder->Freeze();
  }
  
  void cSoftDevice::Mute(void)
  {
!     SOFTDEB("Mute not implemented yet...\n");
      cDevice::Mute();
  }
***************
*** 500,504 ****
  void cSoftDevice::SetVolumeDevice(int Volume)
  {
!   //fprintf (stderr, "[softdevice] should set volume to %d\n", Volume);
    audioOut->SetVolume(Volume);
  }
--- 513,517 ----
  void cSoftDevice::SetVolumeDevice(int Volume)
  {
!   SOFTDEB("should set volume to %d\n", Volume);
    audioOut->SetVolume(Volume);
  }
***************
*** 506,511 ****
  void cSoftDevice::StillPicture(const uchar *Data, int Length)
  {
!     //fprintf(stderr,"[softdevice] StillPicture...\n");
!     decoder->StillPicture((uchar *)Data,Length);
  }
  
--- 519,525 ----
  void cSoftDevice::StillPicture(const uchar *Data, int Length)
  {
!     SOFTDEB("StillPicture...\n");
!     if (decoder)
!       decoder->StillPicture((uchar *)Data,Length);
  }
  
***************
*** 578,582 ****
  void cSoftDevice::SetAudioTrackDevice(eTrackType Type)
  {
!   //fprintf (stderr, "[SetAudioTrackDevice] (%d)\n",Type);
  }
  
--- 592,596 ----
  void cSoftDevice::SetAudioTrackDevice(eTrackType Type)
  {
!   SOFTDEB("SetAudioTrackDevice (%d)\n",Type);
  }
  
***************
*** 585,589 ****
  void cSoftDevice::SetDigitalAudioDevice(bool On)
  {
!   //fprintf (stderr, "[SetDigitalAudioDevice] (%s)\n",(On)? "TRUE":"FALSE");
  }
  
--- 599,603 ----
  void cSoftDevice::SetDigitalAudioDevice(bool On)
  {
!   SOFTDEB("SetDigitalAudioDevice (%s)\n",(On)? "TRUE":"FALSE");
  }
  
***************
*** 704,707 ****
--- 718,722 ----
            char *vo_argv = argv[i];
  
+ 	  printf("vo_argv: %s \n",vo_argv);
          if (!strncmp (vo_argv, "xv:", 3)) {
            vo_argv += 3;
***************
*** 846,850 ****
  {
    // Perform the action when selected from the main VDR menu.
!   fprintf (stderr, "[MainMenuAction]\n");
    return new cMenuSetupSoftdevice(this);
  //  return NULL;
--- 861,865 ----
  {
    // Perform the action when selected from the main VDR menu.
!   SOFTDEB("MainMenuAction\n");
    return new cMenuSetupSoftdevice(this);
  //  return NULL;



From nobody at sheep.berlios.de  Sun Jul 31 10:38:43 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 31 Jul 2005 10:38:43 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.49,1.50 mpeg2decoder.h,1.29,1.30 CHANGELOG,1.99,1.100
Message-ID: <200507310838.j6V8chI07721@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4083

Modified Files:
	mpeg2decoder.c mpeg2decoder.h CHANGELOG 
Log Message:
-free ppmode && ppcontext
-remove Deactivate(), instead fix Stop() and Clear


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** mpeg2decoder.c	27 Jul 2005 20:57:00 -0000	1.49
--- mpeg2decoder.c	31 Jul 2005 08:38:41 -0000	1.50
***************
*** 227,230 ****
--- 227,231 ----
  void cStreamDecoder::Stop(void)
  {
+   active=false;
    if (syncTimer)
      syncTimer->Signal();
***************
*** 233,237 ****
    mutex.Unlock();
    PacketQueue.EnablePutSignal();
-   active=false;
    Cancel(3);
  }
--- 234,237 ----
***************
*** 240,243 ****
--- 240,248 ----
  {
    CMDDEB("cStreamDecoder clear type: %d\n",context->codec_type);
+ 
+   // stop playback bevore clear
+   bool oldfreezeMode=freezeMode;
+   Freeze();
+   
    mutex.Lock();
    if (codec && context)
***************
*** 245,248 ****
--- 250,257 ----
    PacketQueue.Clear();
    mutex.Unlock();
+ 
+   // restore old freezeMode
+   freezeMode=oldfreezeMode;
+   
    CMDDEB("cStreamDecoder clear finished type: %d\n",context->codec_type);
  }
***************
*** 357,362 ****
      }
    }
!   while ( size > 0 ) {
!     BUFDEB("start decode audio\n");
      len=avcodec_decode_audio(context, (short *)audiosamples,
                   &audio_size, data, size);
--- 366,371 ----
      }
    }
!   while ( size > 0 && active ) {
!     BUFDEB("start decode audio. pkt size: %d \n",size);
      len=avcodec_decode_audio(context, (short *)audiosamples,
                   &audio_size, data, size);
***************
*** 985,988 ****
--- 994,1008 ----
       pic_buf_mirror = freePicBuf(pic_buf_mirror);
  
+ #ifdef PP_LIBAVCODEC
+   if (ppcontext) {
+      pp_free_context(ppcontext);
+      ppcontext = NULL;
+   }
+ 
+   if (ppmode)  {
+       pp_free_mode (ppmode);
+       ppmode = NULL;
+   }
+ #endif  
  }
  
***************
*** 1380,1391 ****
    {
      running=false;
-     
      ThreadActive=false;
!     // prepare aout and vout for a stop
!     if (vout)
!        vout->Deactivate();
!     if (aout)
!        aout->Deactivate();
!     
      StreamBuffer->Clear();
      EnableGetSignal.Signal();
--- 1400,1405 ----
    {
      running=false;
      ThreadActive=false;
! 
      StreamBuffer->Clear();
      EnableGetSignal.Signal();

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** mpeg2decoder.h	17 Jul 2005 11:26:08 -0000	1.29
--- mpeg2decoder.h	31 Jul 2005 08:38:41 -0000	1.30
***************
*** 144,148 ****
  
      cMutex            mutex;
!     bool              active, running;
      
      virtual void      Action(void);
--- 144,149 ----
  
      cMutex            mutex;
!     volatile bool     active;
!     bool              running;
      
      virtual void      Action(void);
***************
*** 157,162 ****
      virtual void      Play(void);
      virtual void      Stop();
-     virtual void      Deactivate()
-     { active = false; };
      virtual void      TrickSpeed(int Speed) {return;};
      virtual int       BufferFill(void);
--- 158,161 ----

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.99
retrieving revision 1.100
diff -C2 -d -r1.99 -r1.100
*** CHANGELOG	31 Jul 2005 08:21:22 -0000	1.99
--- CHANGELOG	31 Jul 2005 08:38:41 -0000	1.100
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-07-31:
+     - remove Deactivate(), instead deactive at start of Stop()
+     - stop playback in Clear() while clearing the packet buffer
      - introduce SOFTDEB, more checks agains NULL dereferences
      - call decoder->Clear in Clear



From nobody at sheep.berlios.de  Thu Aug  4 10:50:53 2005
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 4 Aug 2005 10:50:53 +0200
Subject: [Softdevice-cvs] softplay SoftPlayer.c,1.9,1.10
Message-ID: <200508040850.j748orI25504@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv3099

Modified Files:
	SoftPlayer.c 
Log Message:
- compile fix for recent ffmpeg version (patch by Seppo Ingalsuo)
- check filename for NULL reference



Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** SoftPlayer.c	22 May 2005 10:16:25 -0000	1.9
--- SoftPlayer.c	4 Aug 2005 08:50:49 -0000	1.10
***************
*** 171,181 ****
                  // set audio index if not yet set
                  if ( AudioIdx== -1 &&
!                      ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO )
!                         AudioIdx=pkt.stream_index;
                     
                  // set video index if not yet set
                  if ( VideoIdx== -1 &&
!                      ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO )
!                         VideoIdx=pkt.stream_index;
                  // skip packets which do not belong to the current streams
                  if ( pkt.stream_index != VideoIdx &&
--- 171,192 ----
                  // set audio index if not yet set
                  if ( AudioIdx== -1 &&
! #if LIBAVFORMAT_BUILD > 4628
!                      ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_AUDIO 
! #else 
!                      ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO 
! #endif
!                         )
!                      AudioIdx=pkt.stream_index;
                     
                  // set video index if not yet set
                  if ( VideoIdx== -1 &&
! #if LIBAVFORMAT_BUILD > 4628
!                      ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO 
! #else 
!                      ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO 
! #endif
!                         )
!                     VideoIdx=pkt.stream_index;
!                     
                  // skip packets which do not belong to the current streams
                  if ( pkt.stream_index != VideoIdx &&
***************
*** 220,224 ****
--- 231,239 ----
  			fprintf(stderr,"Streams: %d\n",nStreams);
  			for (int i=0; i <nStreams; i++ ) {
+ #if LIBAVFORMAT_BUILD > 4628
+ 				printf("Codec %d ID: %d\n",i,ic->streams[i]->codec->codec_id);
+ #else 
  				printf("Codec %d ID: %d\n",i,ic->streams[i]->codec.codec_id);
+ #endif
  			};
  		};
***************
*** 246,253 ****
  		PLDBG("GetPlayMode stream %d codec_type %d\n",
  			i, IC->streams[i]->codec.codec_type);
  		if (IC->streams[i]->codec.codec_type == CODEC_TYPE_AUDIO)
  			hasAudio=true;
! 		else if (IC->streams[i]->codec.codec_type == CODEC_TYPE_VIDEO)
! 			hasVideo=true;
  	};
  
--- 261,276 ----
  		PLDBG("GetPlayMode stream %d codec_type %d\n",
  			i, IC->streams[i]->codec.codec_type);
+ #if LIBAVFORMAT_BUILD > 4628
+ 		if (IC->streams[i]->codec->codec_type == CODEC_TYPE_AUDIO)
+ #else
  		if (IC->streams[i]->codec.codec_type == CODEC_TYPE_AUDIO)
+ #endif
  			hasAudio=true;
! #if LIBAVFORMAT_BUILD > 4628                        
! 		else if (IC->streams[i]->codec->codec_type == CODEC_TYPE_VIDEO)
! #else
!                 else if (IC->streams[i]->codec.codec_type == CODEC_TYPE_VIDEO)
! #endif
!                         hasVideo=true;
  	};
  
***************
*** 264,267 ****
--- 287,295 ----
  void cSoftPlayer::OpenFile(const char *filename) {
          int ret;
+ 	if (!filename) {
+                 printf("Filname is NULL!!\n");
+                 ic=0;
+                 return;
+         };
          printf("open file %s\n",filename);
          char str[60];



From nobody at sheep.berlios.de  Thu Aug  4 17:20:43 2005
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 4 Aug 2005 17:20:43 +0200
Subject: [Softdevice-cvs] softplay i18n.c,NONE,1.1 i18n.h,NONE,1.1 getFFmpegLibs.c,NONE,1.1 Makefile,1.2,1.3 PlayList.c,1.6,1.7
Message-ID: <200508041520.j74FKhI11846@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv9652

Modified Files:
	Makefile PlayList.c 
Added Files:
	i18n.c i18n.h getFFmpegLibs.c 
Log Message:
- finish translation by Rolf Ahrenberg
- german translation
- fix compilation with ffmpeg cvs version
- add helper program to determine the necessary ffmpeg libraries



--- NEW FILE: i18n.c ---
/*
 * i18n.c: Internationalization
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: i18n.c,v 1.1 2005/08/04 15:20:40 wachm Exp $
 */

#include "i18n.h"

const tI18nPhrase Phrases[] = {
  { "SoftPlay",     //  1
    "SoftPlay",     //  2 German 
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Mediasoitin",  //  9 finnish
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "SoftPlay play media files with the softdevice", //  1
    "SoftPlay spielt Multimediadateien mit dem Softdevice", //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Mediasoitin ohjelmistopohjaiselle n?ytt?laitteelle", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Files",        //  1
    "Datei",        //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Tiedostot",    //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Play",         //  1
    "",             //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Toista",       //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Play Files",   //  1
    "Spiel Dateien",//  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Toista tiedostot", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Toggle List",  //  1
    "Liste",        //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Vaihda lista", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Play List",    //  1
    "Spiel Liste",  //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Toista lista", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Files: %s",    //  1
    "Dateien: %s",  //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Tiedostot: %s",//  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "current playlist", //  1
    "aktuelle Liste",   //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "nykyinen soittolista", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Options",      //  1
    "Optionen",    //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Asetukset",    //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Shuffle Mode", //  1
    "Zufallsmodus", //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Satunnaissoitto", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Auto Repeat",  //  1
    "automatisches Wiederh.", //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Uudelleentoisto", //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "(Add Files)",  //  1
    "(Hinzuf?gen)", //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "(Lis??)",      //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "(Add)",        //  1
    "(Hinzuf?gen)", //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "(Lis??)",      //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Delete",       //  1
    "L?schen",      //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Poista",       //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Stop",         //  1
    "Stopp",        //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Pys?yt?",      //  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { "Playlist 1",   //  1
    "Liste 1",      //  2 TODO
    "",             //  3 TODO
    "",             //  4 TODO
    "",             //  5 TODO
    "",             //  6 TODO
    "",             //  7 TODO
    "",             //  8 TODO
    "Soittolista 1",//  9
    "",             // 10 TODO
    "",             // 11 TODO
    "",             // 12 TODO
    "",             // 13 TODO
    "",             // 14 TODO
    "",             // 15 TODO
    "",             // 16 TODO
#if VDRVERSNUM >= 10316
    "",             // 17 TODO
    "",             // 18 TODO
    "",             // 19 TODO
    "",             // 20 TODO
#endif
  },
  { NULL }
  };

--- NEW FILE: i18n.h ---
/*
 * i18n.h: Internationalization
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: i18n.h,v 1.1 2005/08/04 15:20:40 wachm Exp $
 */

#ifndef _I18N__H
#define _I18N__H

#include <vdr/i18n.h>

extern const tI18nPhrase Phrases[];

#endif //_I18N__H

--- NEW FILE: getFFmpegLibs.c ---
#include <stdio.h>
#include <avcodec.h>

int main() {
        if ( LIBAVCODEC_BUILD > 4795 )
	  printf("-lavutil\n");
        };

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softplay/Makefile,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** Makefile	7 May 2005 20:17:30 -0000	1.2
--- Makefile	4 Aug 2005 15:20:40 -0000	1.3
***************
*** 10,14 ****
  PLUGIN = softplay
  
! LIBAVCODEC=/usr/local/include/ffmpeg/
  
  ### The version number of this plugin (taken from the main source file):
--- 10,16 ----
  PLUGIN = softplay
  
! #LIBFFMPEG=/home/martin/ffmpeg_cvs
! #LIBFFMPEG=/home/martin/vdr/ffmpeg-0.4.9-pre1
! LIBFFMPEG=/usr/local/include/ffmpeg/
  
  ### The version number of this plugin (taken from the main source file):
***************
*** 19,23 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -Wall -Woverloaded-virtual
  
  ### The directory environment:
--- 21,25 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -Wall -Woverloaded-virtual -L$(LIBFFMPEG) -L$(LIBFFMPEG)/libavformat -L$(LIBFFMPEG)/libavcodec -L$(LIBFFMPEG)/libavutil 
  
  ### The directory environment:
***************
*** 43,55 ****
  ### Includes and Defines (add further entries here):
  
! INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include -I$(LIBAVCODEC)
  
  DEFINES += -D_GNU_SOURCE -DPLUGIN_NAME_I18N='"$(PLUGIN)"'
  
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o
  
! LIBS = -lavformat #-lvdr-softdevice -L$(VDRDIR)/PLUGINS/src/softdevice
  
  ### Implicit rules:
--- 45,62 ----
  ### Includes and Defines (add further entries here):
  
! INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include -I$(LIBFFMPEG) -I$(LIBFFMPEG)/libavformat -I$(LIBFFMPEG)/libavcodec -I$(LIBFFMPEG)/libavutil 
  
  DEFINES += -D_GNU_SOURCE -DPLUGIN_NAME_I18N='"$(PLUGIN)"'
  
+ 
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o i18n.o
  
! LIBS = -lavformat -lavcodec -lz
! 
! ### recent ffmpegs require -lavutil: 
! 
! LIBS += $(shell $(CXX) $(CXXFLAGS) $(INCLUDES) getFFmpegLibs.c -o getFFmpegLibs ; ./getFFmpegLibs)
  
  ### Implicit rules:

Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** PlayList.c	22 May 2005 10:14:16 -0000	1.6
--- PlayList.c	4 Aug 2005 15:20:40 -0000	1.7
***************
*** 28,48 ****
  
  cPlOptionsMenu::cPlOptionsMenu(cPlayList *PlayList)
!         : cOsdMenu("Options",33) {
          playList=PlayList;
          playList->GetOptions(playListOptions);
!         Add(new cMenuEditBoolItem("Shuffle Mode",
                                 &playListOptions.shuffle, tr("no"), tr("yes")));
!         Add(new cMenuEditBoolItem("Auto Repeat",
                                 &playListOptions.autoRepeat, tr("no"), tr("yes")));
  };                                   
  
  cPlOptionsMenu::cPlOptionsMenu(sPlayListOptions *Options)
!         : cOsdMenu("Options",33) {
          playList=NULL;
          playListOptions=*Options;
          options=Options;
!         Add(new cMenuEditBoolItem("Shuffle Mode",
                                 &playListOptions.shuffle, tr("no"), tr("yes")));
!         Add(new cMenuEditBoolItem("Auto Repeat",
                                 &playListOptions.autoRepeat, tr("no"), tr("yes")));
  };          
--- 28,48 ----
  
  cPlOptionsMenu::cPlOptionsMenu(cPlayList *PlayList)
!         : cOsdMenu(tr("Options"),33) {
          playList=PlayList;
          playList->GetOptions(playListOptions);
!         Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
                                 &playListOptions.shuffle, tr("no"), tr("yes")));
!         Add(new cMenuEditBoolItem(tr("Auto Repeat"),
                                 &playListOptions.autoRepeat, tr("no"), tr("yes")));
  };                                   
  
  cPlOptionsMenu::cPlOptionsMenu(sPlayListOptions *Options)
!         : cOsdMenu(tr("Options"),33) {
          playList=NULL;
          playListOptions=*Options;
          options=Options;
!         Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
                                 &playListOptions.shuffle, tr("no"), tr("yes")));
!         Add(new cMenuEditBoolItem(tr("Auto Repeat"),
                                 &playListOptions.autoRepeat, tr("no"), tr("yes")));
  };          
***************
*** 111,115 ****
                  Item=Item->GetNext();
          };
!         SetHelp("Options","(Add Files)","Delete","Stop");
          lastActivity=time(NULL);
  };
--- 111,115 ----
                  Item=Item->GetNext();
          };
!         SetHelp(tr("Options"),tr("(Add Files)"),tr("Delete"),tr("Stop"));
          lastActivity=time(NULL);
  };
***************
*** 172,176 ****
  cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->ListName) {
          playList=List;
!         SetHelp("Options","(Add)","Delete","Stop");
          RebuildList();
  };
--- 172,176 ----
  cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->ListName) {
          playList=List;
!         SetHelp(tr("Options"),tr("(Add)"),tr("Delete"),tr("Stop"));
          RebuildList();
  };
***************
*** 309,313 ****
          options.autoRepeat=false;
          
!         strncpy(ListName,"Playlist 1",STR_LENGTH);
          ListName[STR_LENGTH-1]=0;
          if (!ShuffleIdx) {
--- 309,313 ----
          options.autoRepeat=false;
          
!         strncpy(ListName,tr("Playlist 1"),STR_LENGTH);
          ListName[STR_LENGTH-1]=0;
          if (!ShuffleIdx) {



From nobody at sheep.berlios.de  Thu Aug  4 17:29:34 2005
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 4 Aug 2005 17:29:34 +0200
Subject: [Softdevice-cvs] softplay softplay.c,1.6,1.7
Message-ID: <200508041529.j74FTYI12069@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv10116

Modified Files:
	softplay.c 
Log Message:
- finnish translation by Rolf Ahrenberg



Index: softplay.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** softplay.c	22 May 2005 10:14:59 -0000	1.6
--- softplay.c	4 Aug 2005 15:29:32 -0000	1.7
***************
*** 11,14 ****
--- 11,15 ----
  #include "SoftPlayer.h"
  #include "PlayList.h"
+ #include "i18n.h"
  
  #include <dirent.h>
***************
*** 50,59 ****
  
  cMenuDirectory::cMenuDirectory(char * path, cPlayList *EditList) 
!         : cOsdMenu("Files",4,2,8) 
  {
    Entries=NULL;
    nEntries=0;
    keySelNo=0;
!   SetHelp(NULL,"Play","Toggle List","Play List");
    editList=EditList;
    PrepareDirectory(path);
--- 51,60 ----
  
  cMenuDirectory::cMenuDirectory(char * path, cPlayList *EditList) 
!         : cOsdMenu(tr("Files"),4,2,8) 
  {
    Entries=NULL;
    nEntries=0;
    keySelNo=0;
!   SetHelp(NULL,tr("Play"),tr("Toggle List"),tr("Play List"));
    editList=EditList;
    PrepareDirectory(path);
***************
*** 100,104 ****
    //FIXME find a clever way to cut down the directory name
    PrintCutDownString(Name,&start_path[Softplay->MediaPathLen()],30);
!   snprintf(Title,60,"Files: %s",Name);
    SetTitle(Title);
  
--- 101,105 ----
    //FIXME find a clever way to cut down the directory name
    PrintCutDownString(Name,&start_path[Softplay->MediaPathLen()],30);
!   snprintf(Title,60,tr("Files: %s"),Name);
    SetTitle(Title);
  
***************
*** 265,272 ****
  
  cMainMenu::cMainMenu(cPlayList **CurrList,cSoftPlay::sPlayLists **Lists)
!         : cOsdMenu("SoftPlay")  {
          currList=CurrList;
          lists=Lists;
!         SetHelp(NULL,NULL,NULL,"Play List");
  };
    
--- 266,273 ----
  
  cMainMenu::cMainMenu(cPlayList **CurrList,cSoftPlay::sPlayLists **Lists)
!         : cOsdMenu(tr("SoftPlay"))  {
          currList=CurrList;
          lists=Lists;
!         SetHelp(NULL,NULL,NULL,tr("Play List"));
  };
    
***************
*** 275,281 ****
  
  void cMainMenu::PrepareMenu() {
!         Add(new cOsdItem("Play Files",PLAY_FILES),false);
          if ( *currList )
!           Add(new cOsdItem("current playlist",CURR_PLAYLIST),false);
  }
  
--- 276,282 ----
  
  void cMainMenu::PrepareMenu() {
!         Add(new cOsdItem(tr("Play Files"),PLAY_FILES),false);
          if ( *currList )
!           Add(new cOsdItem(tr("current playlist"),CURR_PLAYLIST),false);
  }
  
***************
*** 329,337 ****
  
  const char *cSoftPlay::Description(void) { 
!         return DESCRIPTION; 
  };
    
  const char *cSoftPlay::MainMenuEntry(void) { 
!         return MAINMENUENTRY; 
  };
  
--- 330,338 ----
  
  const char *cSoftPlay::Description(void) { 
!         return tr(DESCRIPTION); 
  };
    
  const char *cSoftPlay::MainMenuEntry(void) { 
!         return tr(MAINMENUENTRY); 
  };
  
***************
*** 367,370 ****
--- 368,372 ----
  {
    // Start any background activities the plugin shall perform.
+   RegisterI18n(Phrases);
    return true;
  }



From nobody at sheep.berlios.de  Mon Aug  8 10:36:14 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 8 Aug 2005 10:36:14 +0200
Subject: [Softdevice-cvs] softplay PlayList.c,1.7,1.8 PlayList.h,1.5,1.6
Message-ID: <200508080836.j788aEJ02616@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv22743

Modified Files:
	PlayList.c PlayList.h 
Log Message:
- fix memset call (avoids segfaults)
- only zero timeout if cursor has been moved
- add private copy constructor and = operator


Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** PlayList.c	4 Aug 2005 15:20:40 -0000	1.7
--- PlayList.c	8 Aug 2005 08:36:05 -0000	1.8
***************
*** 18,22 ****
  #include "vdr/player.h"
  
! //#define LISTDEB(out...) {printf("LISTDEB: ");printf(out);}
  
  #ifndef LISTDEB
--- 18,22 ----
  #include "vdr/player.h"
  
! #define LISTDEB(out...) {printf("LISTDEB: ");printf(out);}
  
  #ifndef LISTDEB
***************
*** 166,169 ****
--- 166,170 ----
                          break;
          }
+ 
          return state;
  }
***************
*** 236,240 ****
  eOSState cReplayList::ProcessKey(eKeys Key) {
          eOSState state = cOsdMenu::ProcessKey(Key);
!         if (Key!=kNone) 
                  lastActivity=time(NULL);
          
--- 237,244 ----
  eOSState cReplayList::ProcessKey(eKeys Key) {
          eOSState state = cOsdMenu::ProcessKey(Key);
! 
! 	// don't move cursor when it has been moved by the user
! 	// a short while ago
!         if ( Key==kUp  || Key==kDown  || Key==kRight || Key==kLeft ) 
                  lastActivity=time(NULL);
          
***************
*** 272,275 ****
--- 276,283 ----
                          state= osEnd;
                          break;
+                 case kGreen:
+ 			// not yet implemented
+                         state= osContinue;
+                         break;
                  case kRed:
                          return AddSubMenu(new cPlOptionsMenu(playList));
***************
*** 297,300 ****
--- 305,309 ----
          if (!HasSubMenu())
                  UpdateStatus();
+ 		
          return state;
  }
***************
*** 316,323 ****
                  shuffleIdx->nIdx=0;
                  shuffleIdx->Idx=new sIdx[MAX_ITEMS];
!                 memset(shuffleIdx->Idx,0,sizeof(shuffleIdx->Idx));
                  shuffleIdx->nAlbum=0;
                  shuffleIdx->Album=new sIdx[MAX_ITEMS/10];
!                 memset(shuffleIdx->Album,0,sizeof(shuffleIdx->Album));
                  shuffleIdxOwner=true;
          } else {
--- 325,332 ----
                  shuffleIdx->nIdx=0;
                  shuffleIdx->Idx=new sIdx[MAX_ITEMS];
!                 memset(shuffleIdx->Idx,0,sizeof(sIdx[MAX_ITEMS]));
                  shuffleIdx->nAlbum=0;
                  shuffleIdx->Album=new sIdx[MAX_ITEMS/10];
!                 memset(shuffleIdx->Album,0,sizeof(sIdx[MAX_ITEMS/10]));
                  shuffleIdxOwner=true;
          } else {
***************
*** 573,576 ****
--- 582,587 ----
          LISTDEB("NextFile currShuffleIdx %d\n",
                          shuffleIdx->currShuffleIdx);
+         int saveCurrShuffleIdx=shuffleIdx->currShuffleIdx;
+ 
          do {
  		++shuffleIdx->currShuffleIdx;
***************
*** 585,589 ****
                          && !shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item );
  	
!         LISTDEB("NextFile currShuffleIdx %d\n",shuffleIdx->currShuffleIdx);
  
          if ( shuffleIdx->currShuffleIdx > shuffleIdx->nIdx )
--- 596,601 ----
                          && !shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item );
  	
!         LISTDEB("NextFile currShuffleIdx %d nIdx %d\n",
!                         shuffleIdx->currShuffleIdx,shuffleIdx->nIdx);
  
          if ( shuffleIdx->currShuffleIdx > shuffleIdx->nIdx )
***************
*** 592,595 ****
--- 604,609 ----
  	if ( shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item )
  		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
+ 
+         shuffleIdx->currShuffleIdx=saveCurrShuffleIdx;
  	return NULL;
  };
***************
*** 620,623 ****
--- 634,639 ----
          LISTDEB("NextAlbumFile currShuIdx %d currAlbum %p\n",
                          shuffleIdx->currShuffleIdx,currAlbum);
+         int saveCurrShuffleIdx=shuffleIdx->currShuffleIdx;
+ 
          do {
  		++shuffleIdx->currShuffleIdx;
***************
*** 642,645 ****
--- 658,663 ----
  	if (shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item)
  		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
+ 
+         shuffleIdx->currShuffleIdx=saveCurrShuffleIdx;
  	return NULL;
  };

Index: PlayList.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** PlayList.h	21 May 2005 15:35:01 -0000	1.5
--- PlayList.h	8 Aug 2005 08:36:06 -0000	1.6
***************
*** 129,132 ****
--- 129,136 ----
          cPlayList(char *Filename=NULL, char *Name=NULL,
                          sItemIdx *shuffleIdx=NULL);
+   private:
+ 	cPlayList(const cPlayList &List) {};
+ 	cPlayList &operator=(const cPlayList & List) {return *this;};
+   public:
          virtual ~cPlayList();
  



From nobody at sheep.berlios.de  Mon Aug  8 10:39:36 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 8 Aug 2005 10:39:36 +0200
Subject: [Softdevice-cvs] softplay SoftPlayer.c,1.10,1.11
Message-ID: <200508080839.j788daJ02740@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv22921

Modified Files:
	SoftPlayer.c 
Log Message:
- fix debug output with recent ffmpeg cvs
- stop when requesting next file, but playback is already at the last file



Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** SoftPlayer.c	4 Aug 2005 08:50:49 -0000	1.10
--- SoftPlayer.c	8 Aug 2005 08:39:33 -0000	1.11
***************
*** 13,17 ****
  #include "softplay.h"
  
! //#define PLDBG(out...) { printf("PLDBG: ");printf(out);}
  //#define PKTDBG(out...) {printf("PKTDBG: ");printf(out);}
  
--- 13,17 ----
  #include "softplay.h"
  
! #define PLDBG(out...) { printf("PLDBG: ");printf(out);}
  //#define PKTDBG(out...) {printf("PKTDBG: ");printf(out);}
  
***************
*** 259,264 ****
  	PLDBG("GetPlayMode nb_streams %d\n",IC->nb_streams);
  	for (i = 0; i<IC->nb_streams; i++) {
! 		PLDBG("GetPlayMode stream %d codec_type %d\n",
  			i, IC->streams[i]->codec.codec_type);
  #if LIBAVFORMAT_BUILD > 4628
  		if (IC->streams[i]->codec->codec_type == CODEC_TYPE_AUDIO)
--- 259,270 ----
  	PLDBG("GetPlayMode nb_streams %d\n",IC->nb_streams);
  	for (i = 0; i<IC->nb_streams; i++) {
! #if LIBAVFORMAT_BUILD > 4628
!             PLDBG("GetPlayMode stream %d codec_type %d\n",
! 			i, IC->streams[i]->codec->codec_type);
! #else
! 	    PLDBG("GetPlayMode stream %d codec_type %d\n",
  			i, IC->streams[i]->codec.codec_type);
+ #endif
+ 
  #if LIBAVFORMAT_BUILD > 4628
  		if (IC->streams[i]->codec->codec_type == CODEC_TYPE_AUDIO)
***************
*** 482,487 ****
                          return osContinue;
                  };
!                         
!                 return state;
          };
  
--- 488,494 ----
                          return osContinue;
                  };
!                 
! 		if ( state != osUnknown )
!                         return state;
          };
  
***************
*** 523,526 ****
--- 530,534 ----
  			else SoftPlayer->SkipSeconds( 15);
  			break;
+ 		case kStop:
  		case kBlue:    
  			SoftPlayer->Stop(); 
***************
*** 548,551 ****
--- 556,564 ----
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
+                                  else {  // last file
+                                          SoftPlayer->Stop();
+                                          shouldStop=true;  
+                                          return osEnd;
+                                  };
  			 };
  			 break;
***************
*** 561,565 ****
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
! 			 };
  			 break;
  		case k4: if (playList) {
--- 574,583 ----
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
!                                  else {  // last file
!                                          SoftPlayer->Stop();
!                                          shouldStop=true;  
!                                          return osEnd;
!                                  };
!                          };
  			 break;
  		case k4: if (playList) {



From nobody at sheep.berlios.de  Mon Aug  8 10:40:13 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 8 Aug 2005 10:40:13 +0200
Subject: [Softdevice-cvs] softplay README,1.4,1.5
Message-ID: <200508080840.j788eDJ02779@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv23570

Modified Files:
	README 
Log Message:
- add Rolf Ahrenberg



Index: README
===================================================================
RCS file: /cvsroot/softdevice/softplay/README,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** README	22 May 2005 10:15:25 -0000	1.4
--- README	8 Aug 2005 08:40:10 -0000	1.5
***************
*** 107,111 ****
  - Nicolas Huillard and Stefan Lucke for the suggestions and the discussion
    about the user interface
  - all who contributed to ffmpeg, a really great video/audio library
  
- Martin Wache
--- 107,111 ----
  - Nicolas Huillard and Stefan Lucke for the suggestions and the discussion
    about the user interface
+ - Rolf Ahrenberg for the finnish translation
  - all who contributed to ffmpeg, a really great video/audio library
  



From nobody at sheep.berlios.de  Mon Aug  8 12:25:05 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 8 Aug 2005 12:25:05 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.50,1.51 mpeg2decoder.h,1.30,1.31
Message-ID: <200508081025.j78AP5J07027@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2845

Modified Files:
	mpeg2decoder.c mpeg2decoder.h 
Log Message:
- stop the clock in pause mode (for Softplay)



Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** mpeg2decoder.c	31 Jul 2005 08:38:41 -0000	1.50
--- mpeg2decoder.c	8 Aug 2005 10:25:03 -0000	1.51
***************
*** 118,128 ****
  int64_t cClock::videoOffset=0;
  int64_t cClock::videoPTS=0;
  
  int64_t  cClock::GetPTS() {
    //MPGDEB("audioOffset %lld time %lld\n",audioOffset,GetTime());
    if ( audioOffset )
!      return GetTime()+audioOffset;
    else if ( videoOffset )
!      return GetTime()+videoOffset;
    else return 0;
  };
--- 118,129 ----
  int64_t cClock::videoOffset=0;
  int64_t cClock::videoPTS=0;
+ bool cClock::freezeMode=true;
  
  int64_t  cClock::GetPTS() {
    //MPGDEB("audioOffset %lld time %lld\n",audioOffset,GetTime());
    if ( audioOffset )
!      return freezeMode ? audioPTS : GetTime()+audioOffset;
    else if ( videoOffset )
!      return freezeMode ? videoPTS : GetTime()+videoOffset;
    else return 0;
  };
***************
*** 1349,1352 ****
--- 1350,1355 ----
      if (vout)
        vout->Play();
+ 
+     cClock::SetFreezeMode(false);
    };
  };
***************
*** 1386,1389 ****
--- 1389,1394 ----
      if (vout)
        vout->Freeze();
+ 
+     cClock::SetFreezeMode(true);
    };
  };

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** mpeg2decoder.h	31 Jul 2005 08:38:41 -0000	1.30
--- mpeg2decoder.h	8 Aug 2005 10:25:03 -0000	1.31
***************
*** 52,58 ****
      static int64_t videoOffset;
      static int64_t videoPTS;
  
  public:
!     cClock() {audioOffset=0;videoOffset=0;};
      virtual ~cClock() {};
  
--- 52,60 ----
      static int64_t videoOffset;
      static int64_t videoPTS;
+     static bool freezeMode;
  
  public:
!     cClock() {audioOffset=0;videoOffset=0;audioPTS=0;videoPTS=0;
!         freezeMode=true;};
      virtual ~cClock() {};
  
***************
*** 79,82 ****
--- 81,88 ----
      };
     
+     static inline void SetFreezeMode(bool FreezeMode) {
+       freezeMode=FreezeMode;
+     };
+ 
      int64_t GetPTS();
  };	



From nobody at sheep.berlios.de  Mon Aug  8 20:43:43 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 8 Aug 2005 20:43:43 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.100,1.101 softdevice.c,1.38,1.39 video-dfb.c,1.36,1.37
Message-ID: <200508081843.j78Ihhk22536@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4920

Modified Files:
	CHANGELOG softdevice.c video-dfb.c 
Log Message:
dfb-out: enclose all dfb calls by try{}catch{} by Marko M?kel?

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.100
retrieving revision 1.101
diff -C2 -d -r1.100 -r1.101
*** CHANGELOG	31 Jul 2005 08:38:41 -0000	1.100
--- CHANGELOG	8 Aug 2005 18:43:41 -0000	1.101
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-08-08:
+     - dfb-out: enclose all dfb calls by try{}catch{} by Marko M?kel?
  2005-07-31:
      - remove Deactivate(), instead deactive at start of Stop()

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** softdevice.c	31 Jul 2005 08:21:22 -0000	1.38
--- softdevice.c	8 Aug 2005 18:43:41 -0000	1.39
***************
*** 385,389 ****
  
  int64_t cSoftDevice::GetSTC(void) {
!   return (decoder?decoder->GetSTC():NULL);
  };
  
--- 385,389 ----
  
  int64_t cSoftDevice::GetSTC(void) {
!   return (decoder?decoder->GetSTC():(int64_t)NULL);
  };
  

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** video-dfb.c	27 Jul 2005 20:57:00 -0000	1.36
--- video-dfb.c	8 Aug 2005 18:43:41 -0000	1.37
***************
*** 274,525 ****
    OSDpresent = false;
  
!   DirectFB::Init();
!   dfb = DirectFB::Create();
!   if (!setupStore->useMGAtv)
!     dfb->SetCooperativeLevel(DFSCL_FULLSCREEN);
! 
!   reportCardInfo (dfb);
  
!   fprintf(stderr,"[dfb] Supported video Modes are: ");
[...1141 lines suppressed...]
      {
***************
*** 1203,1208 ****
        videoSurface->Flip(NULL, DSFLIP_ONSYNC);
      }
!   } catch (DFBException *ex){
!     fprintf(stderr,"Flip failed\n");
    }
    ProcessEvents ();
--- 1253,1262 ----
        videoSurface->Flip(NULL, DSFLIP_ONSYNC);
      }
!   }
!   catch (DFBException *ex)
!   {
!     fprintf (stderr, "[dfb] YUV: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
!     delete ex;
    }
    ProcessEvents ();



From nobody at sheep.berlios.de  Wed Aug 10 19:31:23 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 10 Aug 2005 19:31:23 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.37,1.38
Message-ID: <200508101731.j7AHVNf00812@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2234

Modified Files:
	video-dfb.c 
Log Message:
remaing try{}catch{} by Marko M?kel?


Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** video-dfb.c	8 Aug 2005 18:43:41 -0000	1.37
--- video-dfb.c	10 Aug 2005 17:31:18 -0000	1.38
***************
*** 1002,1018 ****
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
!   tmpSurface->Clear(0,0,0,clearAlpha);
!   tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
!   for (int i = 0; i < MAXNUMWINDOWS; i++)
    {
!     if (layer[i] && layer[i]->visible)
!       layer[i]->Draw(dst, pitch, NULL);
!   }
!   tmpSurface->Unlock();
  
!   if (useStretchBlit)
!     OSDpresent = true;
  
!   tmpSurface->Flip();
  }
  #endif
--- 1002,1027 ----
    tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
  
!   try
    {
!     tmpSurface->Clear(0,0,0,clearAlpha);
!     tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
!     for (int i = 0; i < MAXNUMWINDOWS; i++)
!     {
!       if (layer[i] && layer[i]->visible)
!         layer[i]->Draw(dst, pitch, NULL);
!     }
!     tmpSurface->Unlock();
  
!     if (useStretchBlit)
!       OSDpresent = true;
  
!     tmpSurface->Flip();
!   }
!   catch (DFBException *ex)
!   {
!     fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
!     delete ex;
!   }
  }
  #endif



From nobody at sheep.berlios.de  Mon Aug 15 09:27:48 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Aug 2005 09:27:48 +0200
Subject: [Softdevice-cvs] softplay PlayList.c,1.8,1.9 PlayList.h,1.6,1.7 softplay.c,1.7,1.8 softplay.h,1.2,1.3
Message-ID: <200508150727.j7F7Rm507478@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv9127

Modified Files:
	PlayList.c PlayList.h softplay.c softplay.h 
Log Message:
- playlist saving and loading support (not yet in the user interface)
- .m3u loading support
- small fixes etc.



Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** PlayList.c	8 Aug 2005 08:36:05 -0000	1.8
--- PlayList.c	15 Aug 2005 07:27:41 -0000	1.9
***************
*** 70,82 ****
  
  // ---cPlayListItem--------------------------------------------------------
! cPlayListItem::cPlayListItem(char *Filename, char *Name) {
          if (Name) {
!                 strncpy(name,Name,SHORT_STR);
!                 name[SHORT_STR-1]=0;
          } else name[0]=0;
  
          if (Filename) {
!                 strncpy(filename,Filename,STR_LENGTH);
!                 filename[STR_LENGTH-1]=0;
          } else filename[0]=0;
          next=previous=NULL;
--- 70,80 ----
  
  // ---cPlayListItem--------------------------------------------------------
! cPlayListItem::cPlayListItem(const char *Filename, const char *Name) {
          if (Name) {
!                 SetName(Name);
          } else name[0]=0;
  
          if (Filename) {
!                 SetFilename(Filename);
          } else filename[0]=0;
          next=previous=NULL;
***************
*** 101,106 ****
  };
  
  // ----cEditList------------------------------------------------------------
! cEditList::cEditList(cPlayList * List) : cOsdMenu(List->ListName) {
          playList=List;
          cPlayListItem * Item=playList->first;
--- 99,155 ----
  };
  
+ const char *cPlayListItem::ParseTypeFilenameName(const char *pos, 
+                 char *Type, char *Filename, char *Name) {
+         int len;
+         // read entry type
+         if ( sscanf(pos,"%20[^:]:%n",Type,&len) == 0 ) {
+                 LISTDEB("Ignoring invalid line in list file: \"%s\"!\n",pos);
+                 return NULL;
+         };
+         pos = &pos[len];
+ 
+         //skip whitespaces
+         while (pos[0] && pos[0]==' ')
+                 pos++;
+         // read file name (should be always present)
+         if ( !strncmp(pos,"\"\",",3) ) {
+                 filename[0]=0;
+                 len=3;
+         } else if ( sscanf(pos,"\"%" TO_STRING(STR_LENGTH) 
+                                 "[^\"]\",%n",Filename,&len) == 0 ) {
+                 LISTDEB("Could not parse filename at pos \"%s\". Ignoring.\n",pos);
+                 return NULL;
+         };
+         pos = &pos[len];
+ 
+         // skip whitespaces
+         while (pos[0] && pos[0]==' ')
+                 pos++;
+ 
+         // read name (should be always present)
+         if ( !strncmp(pos,"\"\",",3) ) {
+                 name[0]=0;
+                 len=3;
+         } else if ( sscanf(pos,"\"%" TO_STRING(SHORT_STR) 
+                                 "[^\"]\",%n",Name,&len) == 0 ) {
+                 LISTDEB("Could not parse name at pos \"%s\". Ignoring.\n",pos);
+                 return NULL;
+         };
+         pos = &pos[len];
+ 
+         return pos;
+ };
+  
+ //-----cPlayListRegular-----------------------------------------------------
+ 
+ void cPlayListRegular::Save(FILE *out) {
+ 	fprintf(out,"File: ");
+         fprintf(out,"\"%s\",",GetFilename());
+         fprintf(out,"\"%s\",",GetName());
+         fprintf(out,"\n");
+ };
+ 
  // ----cEditList------------------------------------------------------------
! cEditList::cEditList(cPlayList * List) : cOsdMenu(List->GetName()) {
          playList=List;
          cPlayListItem * Item=playList->first;
***************
*** 171,175 ****
  
  // ----cReplayList------------------------------------------------------------
! cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->ListName) {
          playList=List;
          SetHelp(tr("Options"),tr("(Add)"),tr("Delete"),tr("Stop"));
--- 220,224 ----
  
  // ----cReplayList------------------------------------------------------------
! cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->GetName()) {
          playList=List;
          SetHelp(tr("Options"),tr("(Add)"),tr("Delete"),tr("Stop"));
***************
*** 226,230 ****
                  if (Item) {
                          PrintCutDownString(Name,Item->GetName(),30);
!                         snprintf(Status,60,"%s: %s",playList->ListName,
                                                  Name);
                          SetTitle(Status);
--- 275,279 ----
                  if (Item) {
                          PrintCutDownString(Name,Item->GetName(),30);
!                         snprintf(Status,60,"%s: %s",playList->GetName(),
                                                  Name);
                          SetTitle(Status);
***************
*** 240,244 ****
  	// don't move cursor when it has been moved by the user
  	// a short while ago
!         if ( Key==kUp  || Key==kDown  || Key==kRight || Key==kLeft ) 
                  lastActivity=time(NULL);
          
--- 289,293 ----
  	// don't move cursor when it has been moved by the user
  	// a short while ago
!         if ( Key==kUp || Key==kDown || Key==kRight || Key==kLeft ) 
                  lastActivity=time(NULL);
          
***************
*** 311,316 ****
  
  // -----cPlayList------------------------------------------------------------
! cPlayList::cPlayList(char *Filename, char *Name,sItemIdx *ShuffleIdx) 
!                       : cPlayListItem(Filename,Name) {
          first=NULL;
          last=NULL;
--- 360,366 ----
  
  // -----cPlayList------------------------------------------------------------
! cPlayList::cPlayList(const char *Filename, const char *Name,
!                 sItemIdx *ShuffleIdx) 
!                 : cPlayListItem(Filename,(Name ? Name : tr("Playlist 1"))) {
          first=NULL;
          last=NULL;
***************
*** 318,323 ****
          options.autoRepeat=false;
          
-         strncpy(ListName,tr("Playlist 1"),STR_LENGTH);
-         ListName[STR_LENGTH-1]=0;
          if (!ShuffleIdx) {
  	        shuffleIdx=new sItemIdx;
--- 368,371 ----
***************
*** 486,495 ****
  };
  
! cPlayListItem *cPlayList::GetItemByName(const char *name) {
! 	int32_t hash=SimpleHash(name);
          
          for (int i=0; i<shuffleIdx->nIdx;i++) 
                  if ( hash==shuffleIdx->Idx[i].Hash && shuffleIdx->Idx[i].Item
!                         && strcmp(name,shuffleIdx->Idx[i].Item->GetFilename()) ==0)
                          return shuffleIdx->Idx[i].Item;
          return NULL;
--- 534,543 ----
  };
  
! cPlayListItem *cPlayList::GetItemByFilename(const char *Filename) {
! 	int32_t hash=SimpleHash(Filename);
          
          for (int i=0; i<shuffleIdx->nIdx;i++) 
                  if ( hash==shuffleIdx->Idx[i].Hash && shuffleIdx->Idx[i].Item
!                         && strcmp(Filename,shuffleIdx->Idx[i].Item->GetFilename()) ==0)
                          return shuffleIdx->Idx[i].Item;
          return NULL;
***************
*** 503,512 ****
  };
  
! cPlayListItem *cPlayList::GetAlbumByName(const char *name) {
! 	int32_t hash=SimpleHash(name);
          
          for (int i=0; i<shuffleIdx->nAlbum;i++) 
                  if ( hash==shuffleIdx->Album[i].Hash && shuffleIdx->Album[i].Item
!                         && strcmp(name,shuffleIdx->Album[i].Item->GetFilename())==0)
  
                          return shuffleIdx->Album[i].Item;
--- 551,560 ----
  };
  
! cPlayListItem *cPlayList::GetAlbumByFilename(const char *Filename) {
! 	int32_t hash=SimpleHash(Filename);
          
          for (int i=0; i<shuffleIdx->nAlbum;i++) 
                  if ( hash==shuffleIdx->Album[i].Hash && shuffleIdx->Album[i].Item
!                         && strcmp(Filename,shuffleIdx->Album[i].Item->GetFilename())==0)
  
                          return shuffleIdx->Album[i].Item;
***************
*** 533,536 ****
--- 581,593 ----
  };
  
+ bool cPlayList::AddM3U(char * Filename, char * title) {
+         LISTDEB("AddM3U %s\n",Filename);
+         cPlayList *Item= new cPlayList(Filename,title,shuffleIdx);
+         Item->LoadM3U(Filename,title);
+         AddItemAtEnd(Item);
+ 
+         return true;
+ };
+ 
  bool cPlayList::ScanDir(char * dirname, bool recursive) {
          struct dirent **namelist;
***************
*** 778,781 ****
--- 835,977 ----
  
          options=Options;
+ };
+ 
+ void cPlayList::Save(FILE *out) {
+         cPlayListItem *Item;
+         
+         fprintf(out,"Start_List: ");
+         fprintf(out,"\"%s\",",filename);
+         fprintf(out,"\"%s\",",name);
+         fprintf(out,"\n");
+         
+         Item=first;
+         while (Item) {
+                 Item->Save(out);
+                 Item=Item->next;
+         };
+ 
+         fprintf(out,"End_List: ");
+         fprintf(out,"\"%s\",",filename);
+         fprintf(out,"\"%s\",",name);
+         fprintf(out,"\n");
+ };
+         
+       
+ int cPlayList::Load(FILE *in, const char *StartLine) {
+         char line[500];
+         const char *pos;
+         char Type[STR_LENGTH];
+         char Filename[STR_LENGTH];
+         char Name[SHORT_STR];
+        
+         if (StartLine) {
+                 if ( !(pos=ParseTypeFilenameName(StartLine,Type,Filename,Name)) ) {
+                         LISTDEB("Could not parse Startline. Returning. \n");
+                         return -1;
+                 };
+ 
+                 if ( strcmp(Type,"Start_List")!=0 ) {
+                         LISTDEB("Startline not a List startline! Returning.\n");
+                         return -1;
+                 };
+                 
+                 SetName(Name);
+                 SetFilename(Filename);
+         };              
+                 
+         while( !feof(in) && fgets(line,500,in)) {
+                 chomp(line);
+ 
+                 LISTDEB("read line %s \n",line); 
+ 
+                 if ( !(pos=ParseTypeFilenameName(line,Type,Filename,Name)) )
+                         continue;
+                        
+                 LISTDEB("filename \"%s\" name \"%s\" \n",Filename,Name); 
+                 if ( !strcmp(Type,"Start_List") ) {
+                         LISTDEB("Found start of list\n");
+                         cPlayList *Item = new cPlayList(Filename,Name,shuffleIdx);
+                         if ( Item->Load(in,line)<0 )
+                                 return -1;
+ 
+                         AddItemAtEnd(Item);
+                 } else if ( !strcmp(Type,"End_List") ) {
+                         LISTDEB("Found end of list \n");
+                         if ( strcmp(Filename,GetFilename()) ||
+                                         strcmp(Name,GetName()) ) {
+                                 LISTDEB("End of list doesn't match! Returning!\n");
+                                 return -1; 
+                         };
+                         return 0;
+                 } else if ( !strcmp(Type,"File") ) {
+                         LISTDEB("Found file \n");
+                         cPlayListItem *Item = new cPlayListRegular(Filename,Name);
+                         Item->ParseSaveLine(line);
+                         AddItemAtEnd(Item);
+                 } else {
+                         LISTDEB("Unknown type \"%s\"\n",Type);
+                 };
+         };
+         return 0;
+ };
+ 
+ int cPlayList::LoadM3U(const char *Filename, const char *Name) {
+         FILE *list;
+         char line[500];
+         char dir[STR_LENGTH];
+         LISTDEB("LoadM3U: %s\n",Filename);
+         
+         list = fopen( Filename, "r");
+         
+         if (!list) {
+                 LISTDEB("Could not open .m3u file!\n");
+                 return -1;
+         };
+         
+         SetName(Name);
+         SetFilename(Filename);
+         char *ncopy=rindex(Filename,'/');
+         int count=(int) (ncopy-Filename);
+         if ( ncopy && count > STR_LENGTH) {
+                 fprintf(stderr,"Could not extract directory!\n");
+                 return -1;
+         };
+         strncpy(dir,Filename,count);
+         dir[count]=0;
+         LISTDEB("dir: %s\n",dir);
+ 
+         while ( !feof(list)  && fgets(line,500,list) ) {
+                 chomp(line);
+                 printf("read line \"%s\"\n",line);
+                 if (line[0]=='#')
+                         continue;
+ 
+                 // poor man's windows to linux filename transformation
+                 char *pos=line;
+                 while ( (pos=index(pos,'\\')) )
+                         *pos='/';
+     
+                 ncopy=line;
+                 // don't copy leading "./"
+                 if (ncopy[0]=='.' && ncopy[1]=='/')
+                         ncopy+=2;
+                 
+                 char ItemName[SHORT_STR];
+                 char ItemFile[STR_LENGTH];
+                 snprintf(ItemFile,STR_LENGTH,"%s/%s",dir,ncopy);
+ 
+                 // strip off all directories to extract the name
+                 ncopy = rindex(line,'/');
+                 if (!ncopy)
+                         ncopy=line;
+                 else ncopy++;
+                 snprintf(ItemName,SHORT_STR,"%s",ncopy);
+                 printf("Name %s \n",ncopy);
+                 
+                 cPlayListItem *Item = new cPlayListRegular(ItemFile,ItemName);
+                 AddItemAtEnd(Item);
+         };
+ 
+         return 0;
  };
  

Index: PlayList.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** PlayList.h	8 Aug 2005 08:36:06 -0000	1.6
--- PlayList.h	15 Aug 2005 07:27:42 -0000	1.7
***************
*** 38,49 ****
  class cPlayListItem {
          friend class cPlayList;
!         protected:
                  char name[SHORT_STR];
                  char filename[STR_LENGTH];
                  int idx;
                  cPlayListItem *next;
                  cPlayListItem *previous;
          public:
!                 cPlayListItem(char *Filename=NULL,  char *Name=NULL);
                  virtual ~cPlayListItem();
  
--- 38,50 ----
  class cPlayListItem {
          friend class cPlayList;
!         private:
                  char name[SHORT_STR];
                  char filename[STR_LENGTH];
+         protected:
                  int idx;
                  cPlayListItem *next;
                  cPlayListItem *previous;
          public:
!                 cPlayListItem(const char *Filename=NULL,  const char *Name=NULL);
                  virtual ~cPlayListItem();
  
***************
*** 57,60 ****
--- 58,72 ----
                  { return filename; };
  
+         protected:
+                 inline void SetName(const char *Name) {
+                         strncpy(name,Name,SHORT_STR);
+                         name[SHORT_STR-1]=0;
+                 };
+                 inline void SetFilename(const char *Filename) {
+                         strncpy(filename,Filename,STR_LENGTH);
+                         filename[STR_LENGTH-1]=0;
+                 };
+ 
+         public:
                  virtual void BuildIdx(sItemIdx *shuffleIdx);
                          
***************
*** 73,76 ****
--- 85,96 ----
                  inline cPlayListItem *GetPrev()
                  {return previous;};
+ 
+ 		virtual void Save(FILE *out)
+ 		{};
+ 
+                 virtual void ParseSaveLine(const char *Line)
+                 {};
+         protected:
+                 const char *ParseTypeFilenameName(const char *Str, char *Type, char *Filename, char *Name);
  };
  
***************
*** 80,87 ****
--- 100,144 ----
                  char album[STR_LENGTH];
                  char author[STR_LENGTH];
+ 
+                 int duration;
          public:
                  cPlayListRegular(char *Filename,  char *Name) :
                          cPlayListItem(Filename,Name) {};
                  virtual ~cPlayListRegular() {};
+ 
+ 		virtual void Save(FILE *out);
+ 
+                 virtual void ParseSaveLine(const char *Line){};
+ 
+                 inline char *GetTitle() 
+                 { return title; };
+ 
+                 inline char *SetTitle( const char *const Title) { 
+                         strncpy(title,Title,STR_LENGTH);
+                         title[STR_LENGTH-1]=0;
+                 };
+ 
+                 inline char *GetAlbum()
+                 { return album; };
+ 
+                 inline char *SetAlbum( const char *const Album) {
+                         strncpy(album,Album,STR_LENGTH);
+                         album[STR_LENGTH-1]=0;
+                 };
+ 
+                 inline char *GetAuthor()
+                 { return author; };
+ 
+                 inline char *SetAuthor( const char *const Author) {
+                         strncpy(author,Author,STR_LENGTH);
+                         author[STR_LENGTH-1]=0;
+                 };
+ 
+                 inline int GetDuration()
+                 { return duration; };
+ 
+                 inline int SetDuration(int Duration) {
+                         duration=Duration;
+                 };
  }; 
  
***************
*** 118,122 ****
  	friend class cReplayList;
  	
! 	char ListName[STR_LENGTH];
  private:
          cPlayListItem *first;
--- 175,179 ----
  	friend class cReplayList;
  	
! 	//char ListName[STR_LENGTH];
  private:
          cPlayListItem *first;
***************
*** 127,131 ****
          sPlayListOptions options;
    public:
!         cPlayList(char *Filename=NULL, char *Name=NULL,
                          sItemIdx *shuffleIdx=NULL);
    private:
--- 184,188 ----
          sPlayListOptions options;
    public:
!         cPlayList(const char *Filename=NULL, const char *Name=NULL,
                          sItemIdx *shuffleIdx=NULL);
    private:
***************
*** 149,154 ****
                  return shuffleIdx->Idx[Index].Item; 
          };
!         cPlayListItem *GetItemByName(const char *name);
!         cPlayListItem *GetAlbumByName(const char *name);
          int GetIndexByItem(const cPlayListItem *Item);
  
--- 206,211 ----
                  return shuffleIdx->Idx[Index].Item; 
          };
!         cPlayListItem *GetItemByFilename(const char *Filename);
!         cPlayListItem *GetAlbumByFilename(const char *Filename);
          int GetIndexByItem(const cPlayListItem *Item);
  
***************
*** 168,171 ****
--- 225,229 ----
          bool ScanDir(char * dirname, bool recursive = true);
          bool AddDir(char * dirname,char *Title = NULL, bool recursive = true);
+         bool AddM3U(char * Filename,char *Title = NULL);
  
  	void Shuffle();
***************
*** 177,180 ****
--- 235,242 ----
  	char *PrevAlbumFile();
  	
+ 	virtual void Save(FILE *out);
+ 	int Load(FILE *out, const char * StartLine=NULL);
+ 
+         int LoadM3U(const char *Filename, const char *Name);
  };
  

Index: softplay.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** softplay.c	4 Aug 2005 15:29:32 -0000	1.7
--- softplay.c	15 Aug 2005 07:27:42 -0000	1.8
***************
*** 21,24 ****
--- 21,26 ----
  static const char *MAINMENUENTRY  = "SoftPlay";
  
+ static const char *DIR_NAME ="softplay";
+ 
  //#define PLUGDEB(out...)     {printf("PLUGDEB: ");printf(out...);}
  
***************
*** 69,81 ****
  void cMenuDirectory::PrintItemName(char *Name, const struct DirEntry &Entry,int i) {
          char inPlayList=' ';
!         if (Entry.type == DT_DIR) {  
!                 if (editList && editList->GetAlbumByName(Entry.name))
!                         inPlayList='P';
  
                  snprintf(Name,60,"%4d\t%c\t[%s]",
                                  i+1,inPlayList,Entry.title);
!         } else {  
!                 if (editList && editList->GetItemByName(Entry.name))
!                         inPlayList='P';
                  snprintf(Name,60,"%4d\t%c\t%s",
                                  i+1,inPlayList,Entry.title);
--- 71,88 ----
  void cMenuDirectory::PrintItemName(char *Name, const struct DirEntry &Entry,int i) {
          char inPlayList=' ';
!         if (Entry.type == DT_DIR ) {  
!                 if (editList && editList->GetAlbumByFilename(Entry.name))
!                         inPlayList='*';
  
                  snprintf(Name,60,"%4d\t%c\t[%s]",
                                  i+1,inPlayList,Entry.title);
!         } else {
!                 if ( IsM3UFile(Entry.name) ) {
!                         if (editList && editList->GetAlbumByFilename(Entry.name))
!                                 inPlayList='*';
!                 } else {  
!                         if (editList && editList->GetItemByFilename(Entry.name))
!                                 inPlayList='*';
!                 }
                  snprintf(Name,60,"%4d\t%c\t%s",
                                  i+1,inPlayList,Entry.title);
***************
*** 110,114 ****
    };
    Entries=new DirEntry[n];
!   nEntries=0;;
    
    for (int i=0; i<n; i++) {
--- 117,121 ----
    };
    Entries=new DirEntry[n];
!   nEntries=0;
    
    for (int i=0; i<n; i++) {
***************
*** 153,160 ****
  
  eOSState cMenuDirectory::SelectEntry(int No, bool play) {
          if (No>nEntries)
                  return osContinue;
  
!         if ( Entries[No].type == DT_REG && play ) { 
                  cControl::Launch(new cSoftControl(Entries[No].name));
                  return osEnd;
--- 160,170 ----
  
  eOSState cMenuDirectory::SelectEntry(int No, bool play) {
+         bool refreshAll=false;
+         
          if (No>nEntries)
                  return osContinue;
  
!         if ( Entries[No].type == DT_REG && play
!                         && !IsM3UFile(Entries[No].name) ) { 
                  cControl::Launch(new cSoftControl(Entries[No].name));
                  return osEnd;
***************
*** 168,172 ****
          };
          if (Entries[No].type == DT_DIR) {
!                 Item=PlayList->GetAlbumByName(Entries[No].name);
                  PLUGDEB("Item %p\n",Item);
                  if (!Item)
--- 178,182 ----
          };
          if (Entries[No].type == DT_DIR) {
!                 Item=PlayList->GetAlbumByFilename(Entries[No].name);
                  PLUGDEB("Item %p\n",Item);
                  if (!Item)
***************
*** 174,179 ****
                                          Entries[No].title,true);
                  else PlayList->RemoveItem(Item);
          } else if (Entries[No].type == DT_REG){
!                 Item=PlayList->GetItemByName(Entries[No].name);
                  if (!Item)
                          PlayList->AddFile(Entries[No].name,
--- 184,198 ----
                                          Entries[No].title,true);
                  else PlayList->RemoveItem(Item);
+         } else if (Entries[No].type == DT_REG && 
+                         IsM3UFile(Entries[No].name) ) {
+                 Item=PlayList->GetAlbumByFilename(Entries[No].name);
+                 PLUGDEB("Item %p\n",Item);
+                 if (!Item)
+                         PlayList->AddM3U(Entries[No].name,
+                                         Entries[No].title);
+                 else PlayList->RemoveItem(Item);   
+                 refreshAll=true;
          } else if (Entries[No].type == DT_REG){
!                 Item=PlayList->GetItemByFilename(Entries[No].name);
                  if (!Item)
                          PlayList->AddFile(Entries[No].name,
***************
*** 182,188 ****
--- 201,223 ----
          };
          if (play) {
+                 // FIXME remove
+                Softplay->SaveList(PlayList);
                 cControl::Launch(new cSoftControl(PlayList));
                 return osEnd;
          };
+ 
+         if (refreshAll) {
+                 char Name[60];
+                 int current=Current();
+                 Clear();
+                 //PrepareDirectory(start_path);
+                 for (int i=0; i<nEntries; i++) {
+                         PrintItemName(Name, Entries[i],i);
+                         Add(new cOsdItem(strdup(Name),osUnknown),false);
+                 };
+                 SetCurrent(Get(current));        
+                 Display();
+                 return osContinue;
+         };
                         
          char str[60];
***************
*** 216,226 ****
                          }
  		case kOk: 
! 			sscanf(Get(Current())->Text(),"%d ",&No);
! 			No--;
  			if (No>nEntries)
  				break;
! 			if ( Entries[No].type == DT_REG ) { 
! 				cControl::Launch(new cSoftControl(Entries[No].name));
! 				return osEnd;
  			} else if ( Entries[No].type == DT_DIR ) { 
  				return AddSubMenu(
--- 251,260 ----
                          }
  		case kOk: 
! 			No=Current();
  			if (No>nEntries)
  				break;
! 			if ( Entries[No].type == DT_REG ) {
!                                 // play current entry
! 				return SelectEntry(Current(),true);
  			} else if ( Entries[No].type == DT_DIR ) { 
  				return AddSubMenu(
***************
*** 230,236 ****
--- 264,272 ----
  			break;
  		case kGreen:
+                         // play current entry
  			state=SelectEntry(Current(),true);
                          break;
                  case kYellow: 
+                         // add / remove current entry 
                          state=SelectEntry(Current(),false);
                          break;
***************
*** 319,322 ****
--- 355,364 ----
  }
  
+ bool cSoftPlay::Initialize(void) {
+ 	configDir=ConfigDirectory(DIR_NAME);
+         currList=OpenList();
+ 	return true;
+ };
+ 	
  cSoftPlay::~cSoftPlay() {
          // Clean up after yourself!
***************
*** 406,409 ****
--- 448,480 ----
  };
  
+ void cSoftPlay::SaveList(cPlayList *List) {
+ 	char filename[60];
+ 	sprintf(filename,"%s/%s",configDir,List->GetName());
+ 
+ 	printf("Save list as %s\n",filename);
+ 	FILE *out=fopen(filename,"w");
+ 	if (!out)
+ 		return;
+ 	List->Save(out);
+ 	fclose(out);
+ };
+ 
+ cPlayList *cSoftPlay::OpenList() {
+         char filename[60];
+         char line[500];
+ 	sprintf(filename,"%s/%s",configDir,"Liste 1");
+ 
+ 	printf("Read list from %s\n",filename);
+ 	FILE *out=fopen(filename,"r");
+         if (!out)
+                 return NULL;
+         fgets(line,500,out);
+         
+         cPlayList *List=new cPlayList();
+ 	List->Load(out,line);
+ 	fclose(out);
+         return List;
+ };
+ 
  VDRPLUGINCREATOR(cSoftPlay); // Don't touch this!
  
***************
*** 447,449 ****
          PLUGDEB("before end copy %s\n",str);
  };
!                 
--- 518,542 ----
          PLUGDEB("before end copy %s\n",str);
  };
!  
! bool IsM3UFile( const char * const Filename) {
!         char * pos;
!         pos = rindex(Filename,'.');
!         if ( !pos )
!                 return false;
!         if ( !strcmp(pos,".m3u") ) {
!                 return true;
!         };
! 
!         return false;
! };
! 
! void chomp(const char *const str) {
!         char *pos;
!         pos = index(str,'\n');
!         if (pos)
!               *pos=0;
!         pos = index(str,'\r');
!         if (pos)
!                 *pos=0;
! };
! 

Index: softplay.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** softplay.h	16 May 2005 19:07:54 -0000	1.2
--- softplay.h	15 Aug 2005 07:27:42 -0000	1.3
***************
*** 16,19 ****
--- 16,21 ----
  #define STR_LENGTH  200
  #define SHORT_STR   60
+ #define TO_STRING(x) STRINGIFY(x)
+ #define STRINGIFY(x) #x
  
  #define PLAY_FILES      osUser1
***************
*** 41,44 ****
--- 43,48 ----
    char currListName[STR_LENGTH];
    
+   const char *configDir;
+  
  public:
    cSoftPlay(void);
***************
*** 48,51 ****
--- 52,56 ----
    virtual const char *CommandLineHelp(void);
    virtual bool ProcessArgs(int argc, char *argv[]);
+   virtual bool Initialize(void);
    virtual bool Start(void);
    virtual void Housekeeping(void);
***************
*** 56,59 ****
--- 61,67 ----
  
    void SetTmpCurrList(cPlayList *List);
+   void SaveList(cPlayList *List);
+   cPlayList *OpenList();
+ 
    inline cPlayList *GetCurrList() 
    { return currList; };
***************
*** 67,69 ****
--- 75,81 ----
  
  void PrintCutDownString(char *str,char *orig,int len);
+ 
+ bool IsM3UFile(const char *const Filename);
+ 
+ void chomp(const char *const str);
  #endif



From nobody at sheep.berlios.de  Mon Aug 15 10:05:18 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Aug 2005 10:05:18 +0200
Subject: [Softdevice-cvs] softplay PlayList.c,1.9,1.10 PlayList.h,1.7,1.8
Message-ID: <200508150805.j7F85I508277@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv24508

Modified Files:
	PlayList.c PlayList.h 
Log Message:
- remove unused Idx
- fix types of Set*() Methods



Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** PlayList.c	15 Aug 2005 07:27:41 -0000	1.9
--- PlayList.c	15 Aug 2005 08:05:15 -0000	1.10
***************
*** 96,100 ****
  
  void cPlayListItem::BuildIdx(sItemIdx *ShuffleIdx) {
-         idx=ShuffleIdx->nIdx;
  };
  
--- 96,99 ----
***************
*** 201,206 ****
                          break;
                  case kYellow:
!                         LISTDEB("Del current %d (idx: %d): %s\n",
!                                         Current(),playList->GetItem(Current())->GetIdx(),
                                          playList->GetItem(Current())->GetName() );
                          playList->RemoveItem(
--- 200,205 ----
                          break;
                  case kYellow:
!                         LISTDEB("Del current %d: %s\n",
!                                         Current(),
                                          playList->GetItem(Current())->GetName() );
                          playList->RemoveItem(
***************
*** 338,343 ****
                                  break;
                          };
!                         LISTDEB("Del current %d (idx: %d): %s\n",
!                                         Current(),Item->GetIdx(),
                                          Item->GetName() );
                          playList->RemoveItem(Item);
--- 337,342 ----
                                  break;
                          };
!                         LISTDEB("Del current %d: %s\n",
!                                         Current(),
                                          Item->GetName() );
                          playList->RemoveItem(Item);
***************
*** 523,535 ****
  	};
          */
- };
- 
- cPlayListItem *cPlayList::GetItemByIndex(int Index) {
-         
-         for (int i=0; i<shuffleIdx->nIdx;i++) 
-                 if ( shuffleIdx->Idx[i].Item 
-                         && Index==shuffleIdx->Idx[i].Item->GetIdx() )
-                         return shuffleIdx->Idx[i].Item;
-         return NULL;
  };
  
--- 522,525 ----

Index: PlayList.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** PlayList.h	15 Aug 2005 07:27:42 -0000	1.7
--- PlayList.h	15 Aug 2005 08:05:15 -0000	1.8
***************
*** 42,46 ****
                  char filename[STR_LENGTH];
          protected:
-                 int idx;
                  cPlayListItem *next;
                  cPlayListItem *previous;
--- 42,45 ----
***************
*** 71,80 ****
                  virtual void BuildIdx(sItemIdx *shuffleIdx);
                          
-                 inline int GetIdx()
-                 { return idx; };
- 
-                 virtual cPlayListItem *GetItemByIndex(int Index)
-                 {if (Index==idx) return this; else return NULL;};
- 
                  virtual int GetNoItems()
                  {return 1; };
--- 70,73 ----
***************
*** 114,118 ****
                  { return title; };
  
!                 inline char *SetTitle( const char *const Title) { 
                          strncpy(title,Title,STR_LENGTH);
                          title[STR_LENGTH-1]=0;
--- 107,111 ----
                  { return title; };
  
!                 inline void SetTitle( const char *const Title) { 
                          strncpy(title,Title,STR_LENGTH);
                          title[STR_LENGTH-1]=0;
***************
*** 122,126 ****
                  { return album; };
  
!                 inline char *SetAlbum( const char *const Album) {
                          strncpy(album,Album,STR_LENGTH);
                          album[STR_LENGTH-1]=0;
--- 115,119 ----
                  { return album; };
  
!                 inline void SetAlbum( const char *const Album) {
                          strncpy(album,Album,STR_LENGTH);
                          album[STR_LENGTH-1]=0;
***************
*** 130,134 ****
                  { return author; };
  
!                 inline char *SetAuthor( const char *const Author) {
                          strncpy(author,Author,STR_LENGTH);
                          author[STR_LENGTH-1]=0;
--- 123,127 ----
                  { return author; };
  
!                 inline void SetAuthor( const char *const Author) {
                          strncpy(author,Author,STR_LENGTH);
                          author[STR_LENGTH-1]=0;
***************
*** 138,142 ****
                  { return duration; };
  
!                 inline int SetDuration(int Duration) {
                          duration=Duration;
                  };
--- 131,135 ----
                  { return duration; };
  
!                 inline void SetDuration(int Duration) {
                          duration=Duration;
                  };
***************
*** 201,205 ****
  	{ Options=options; };
          
-         virtual cPlayListItem *GetItemByIndex(int Index);
          inline cPlayListItem *GetShuffledItemByIndex(int Index) {   
                  if (!shuffleIdx) return NULL;
--- 194,197 ----



From nobody at sheep.berlios.de  Mon Aug 15 11:07:33 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Aug 2005 11:07:33 +0200
Subject: [Softdevice-cvs] softplay PlayListMenu.c,NONE,1.1 PlayListMenu.h,NONE,1.1 PlayList.c,1.10,1.11 PlayList.h,1.8,1.9 softplay.c,1.8,1.9 SoftPlayer.c,1.11,1.12
Message-ID: <200508150907.j7F97X510425@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv30572

Modified Files:
	PlayList.c PlayList.h softplay.c SoftPlayer.c 
Added Files:
	PlayListMenu.c PlayListMenu.h 
Log Message:
- moved all playlist menus into seperate files PlayListMenu.[ch]
- renamed cEditList to cAlbumList



--- NEW FILE: PlayListMenu.c ---
/*
 * Media Player plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: PlayListMenu.c,v 1.1 2005/08/15 09:07:30 wachm Exp $
 */
#include "vdr/player.h"

#include "PlayListMenu.h"

#define MENUDEB(out...) {printf("MENUDEB: ");printf(out);}

#ifndef MENUDEB
#define MENUDEB(out...)
#endif


// ----cAlbumList------------------------------------------------------------
cAlbumList::cAlbumList(cPlayList * List) : cOsdMenu(List->GetName()) {
        playList=List;
        cPlayListItem * Item=playList->GetFirst();
        while (Item) {
                MENUDEB("EditList add %s: %p\n",Item->GetName(),Item);
                Add(new cOsdItem(Item->GetName(),
                   osUnknown),false);
                Item=Item->GetNext();
        };
        SetHelp(tr("Options"),tr("(Add Files)"),tr("Delete"),tr("Stop"));
        lastActivity=time(NULL);
};

cAlbumList::~cAlbumList() {
};

eOSState cAlbumList::ProcessKey(eKeys Key) {
        eOSState state = cOsdMenu::ProcessKey(Key);
        if (state != osUnknown ) 
                return state;

        cPlayList *List;
        cPlayListItem *Item;
        switch (Key) {
                case kOk:
                        MENUDEB("Current %d GetItem %p\n",Current(),playList->GetItem(Current()));
                        Item=playList->GetItem(Current());
                        List=dynamic_cast<cPlayList*>(Item);
                        MENUDEB("Item %p\n",Item);

                        if (List) {
                                cAlbumList *Menu=new cAlbumList(List);
                                return AddSubMenu(Menu);
                        }  else {
                                // skip to current track
                                playList->SetCurrShuffleIdx(
                                        playList->GetIndexByItem(Item) );
                                state = PLAY_CURR_FILE;
                        };
                        break;
                case kBack:
                        state= osBack;
                        break;
                case kBlue:
                        state= osEnd;
                        break;
                case kRed:
                        return AddSubMenu(new cPlOptionsMenu(playList));
                        break;
                case kYellow:
                        MENUDEB("Del current %d: %s\n",
                                        Current(),
                                        playList->GetItem(Current())->GetName() );
                        playList->RemoveItem(
                                        playList->GetItem(Current()));
                        MENUDEB("Remove finished\n");
                        Del(Current());
                        Display();
                        state=osContinue;
                        break;

                default:    
                        break;
        }

        return state;
}

// ----cReplayList------------------------------------------------------------
cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->GetName()) {
        playList=List;
        SetHelp(tr("Options"),tr("(Add)"),tr("Delete"),tr("Stop"));
        RebuildList();
};

cReplayList::~cReplayList() {
};

void cReplayList::RebuildList() {
        int nItems=playList->GetNoItemsRecursive();
        MENUDEB("RebuildList nItems %d \n",nItems);

        cPlayListItem * Item;
        for (int i = 0 ; i<nItems; i++) {
		Item=playList->GetShuffledItemByIndex(i);
                if (!Item) {
                        printf("Error getting all files for list index %d\n",
                                        i);
                        continue;
                };
                
		MENUDEB("Add item %d (%p)  %s\n",
                                i,Item,Item->GetName());
                Add(new cOsdItem(Item->GetName(),
                   osUnknown),false);
        };
        lastListItemCount = playList->GetNoItemsRecursive();
	playList->SetClean();
        SetCurrent(Get(playList->GetCurrShuffleIdx()));
        lastActivity=time(NULL)-600;
};

void cReplayList::UpdateStatus() {
        int current;
        int total;
        char Status[60];
        char Name[60];
        
        if (!cControl::Control() || 
                        !cControl::Control()->GetIndex(current,total))
                return;
        
        snprintf(Status,60,"Time %02d:%02d:%02d/%02d:%02d:%02d Title %d/%d",
                        current/3600,current/60%60,current%60,
                        total/3600,total/60%60,total%60,
                        playList->GetCurrShuffleIdx()+1,
			playList->GetShuffleNIdx());
        SetStatus(Status);

        if (displayedCurrIdx != playList->GetCurrShuffleIdx()){
                cPlayListItem *Item=playList->GetShuffledItemByIndex(
                                playList->GetCurrShuffleIdx());
                if (Item) {
                        PrintCutDownString(Name,Item->GetName(),30);
                        snprintf(Status,60,"%s: %s",playList->GetName(),
                                                Name);
                        SetTitle(Status);
                        Display();
                        displayedCurrIdx=playList->GetCurrShuffleIdx();
                } else printf("Didn't get currShuffleIdx %d!\n",playList->GetCurrShuffleIdx());
        };
};

eOSState cReplayList::ProcessKey(eKeys Key) {
        eOSState state = cOsdMenu::ProcessKey(Key);

	// don't move cursor when it has been moved by the user
	// a short while ago
        if ( Key==kUp || Key==kDown || Key==kRight || Key==kLeft ) 
                lastActivity=time(NULL);
        
        if (state != osUnknown ) 
                return state;

        if ( lastListItemCount != playList->GetNoItemsRecursive()
	     || playList->IsDirty() ) {
                Clear();
                RebuildList();
                Display();
        };
        
        if (Current() != playList->GetCurrShuffleIdx() && 
                        time(NULL) - lastActivity > 120 ) {
                MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
                                playList->GetCurrShuffleIdx(),time(NULL),lastActivity);
                SetCurrent(Get(playList->GetCurrShuffleIdx()));
                Display();
        };

        cPlayListItem *Item;
        switch (Key) {
                case kOk:
                        // skip to current track
                        playList->SetCurrShuffleIdx( Current() );
                        state = PLAY_CURR_FILE;
                        // want to have automatic track change
                        lastActivity=time(NULL)-300;
                        break;
                case kBack:
                        state= osBack;
                        break;
                case kBlue:
                        state= osEnd;
                        break;
                case kGreen:
			// not yet implemented
                        state= osContinue;
                        break;
                case kRed:
                        return AddSubMenu(new cPlOptionsMenu(playList));
                        break;
                case kYellow:
                        Item=playList->GetShuffledItemByIndex(Current());
                        if (!Item) {
                                printf("No current Item %d!\n",Current());
                                break;
                        };
                        MENUDEB("Del current %d: %s\n",
                                        Current(),
                                        Item->GetName() );
                        playList->RemoveItem(Item);
			//playList->CleanShuffleIdx();
			lastListItemCount = playList->GetNoItemsRecursive();
                        Del(Current());
                        Display();
                        state=osContinue;
                        break;

                default:    
                        break;
        }
        if (!HasSubMenu())
                UpdateStatus();
		
        return state;
}


// ---cPlOptionsMenu-------------------------------------------------------

cPlOptionsMenu::cPlOptionsMenu(cPlayList *PlayList)
        : cOsdMenu(tr("Options"),33) {
        playList=PlayList;
        playList->GetOptions(playListOptions);
        Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
                               &playListOptions.shuffle, tr("no"), tr("yes")));
        Add(new cMenuEditBoolItem(tr("Auto Repeat"),
                               &playListOptions.autoRepeat, tr("no"), tr("yes")));
};                                   

cPlOptionsMenu::cPlOptionsMenu(sPlayListOptions *Options)
        : cOsdMenu(tr("Options"),33) {
        playList=NULL;
        playListOptions=*Options;
        options=Options;
        Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
                               &playListOptions.shuffle, tr("no"), tr("yes")));
        Add(new cMenuEditBoolItem(tr("Auto Repeat"),
                               &playListOptions.autoRepeat, tr("no"), tr("yes")));
};          

cPlOptionsMenu::~cPlOptionsMenu() {
};

eOSState cPlOptionsMenu::ProcessKey(eKeys Key)
{
  eOSState state = cOsdMenu::ProcessKey(Key);
                                                                                
  if (state == osUnknown) {
     switch (Key) {
       case kOk: if (playList)
                         playList->SetOptions(playListOptions);
                 else *options=playListOptions;
                 state = osBack;
                 break;
       default: break;
       }
     }
  return state;
}
                                                                                



--- NEW FILE: PlayListMenu.h ---
/*
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: PlayListMenu.h,v 1.1 2005/08/15 09:07:30 wachm Exp $
 */

#ifndef __PLAYLISTMENU_H__
#define __PLAYLISTMENU_H__

#include "vdr/osdbase.h"
#include "PlayList.h"

class cAlbumList: public cOsdMenu {
        time_t lastActivity;
        int displayedCurrIdx;
        cPlayList *playList;
        public:
        cAlbumList(cPlayList * List);
        ~cAlbumList();
        eOSState ProcessKey(eKeys Key);
};

class cReplayList: public cOsdMenu {
        time_t lastActivity;
        int displayedCurrIdx;
        cPlayList *playList;
	int lastListItemCount;
        public:
        cReplayList(cPlayList * List);
        ~cReplayList();
	void RebuildList();
        eOSState ProcessKey(eKeys Key);
        void UpdateStatus();
};

class cPlOptionsMenu : public cOsdMenu {
        protected:
                sPlayListOptions playListOptions;
                sPlayListOptions *options;
                cPlayList *playList;
        public:
                cPlOptionsMenu(cPlayList *PlayList);
                cPlOptionsMenu(sPlayListOptions *Options);
                ~cPlOptionsMenu();
                eOSState ProcessKey(eKeys Key);
};
        


#endif


Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** PlayList.c	15 Aug 2005 08:05:15 -0000	1.10
--- PlayList.c	15 Aug 2005 09:07:30 -0000	1.11
***************
*** 24,72 ****
  #endif
  
- // ---cPlOptionsMenu-------------------------------------------------------
- 
- 
- cPlOptionsMenu::cPlOptionsMenu(cPlayList *PlayList)
-         : cOsdMenu(tr("Options"),33) {
-         playList=PlayList;
-         playList->GetOptions(playListOptions);
-         Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
-                                &playListOptions.shuffle, tr("no"), tr("yes")));
-         Add(new cMenuEditBoolItem(tr("Auto Repeat"),
-                                &playListOptions.autoRepeat, tr("no"), tr("yes")));
- };                                   
- 
- cPlOptionsMenu::cPlOptionsMenu(sPlayListOptions *Options)
-         : cOsdMenu(tr("Options"),33) {
-         playList=NULL;
-         playListOptions=*Options;
-         options=Options;
-         Add(new cMenuEditBoolItem(tr("Shuffle Mode"),
-                                &playListOptions.shuffle, tr("no"), tr("yes")));
-         Add(new cMenuEditBoolItem(tr("Auto Repeat"),
-                                &playListOptions.autoRepeat, tr("no"), tr("yes")));
- };          
- 
- cPlOptionsMenu::~cPlOptionsMenu() {
- };
- 
- eOSState cPlOptionsMenu::ProcessKey(eKeys Key)
- {
-   eOSState state = cOsdMenu::ProcessKey(Key);
-                                                                                 
-   if (state == osUnknown) {
-      switch (Key) {
-        case kOk: if (playList)
-                          playList->SetOptions(playListOptions);
-                  else *options=playListOptions;
-                  state = osBack;
-                  break;
-        default: break;
-        }
-      }
-   return state;
- }
-                                                                                 
- 
  // ---cPlayListItem--------------------------------------------------------
  cPlayListItem::cPlayListItem(const char *Filename, const char *Name) {
--- 24,27 ----
***************
*** 148,360 ****
          fprintf(out,"\n");
  };
- 
- // ----cEditList------------------------------------------------------------
- cEditList::cEditList(cPlayList * List) : cOsdMenu(List->GetName()) {
-         playList=List;
-         cPlayListItem * Item=playList->first;
-         while (Item) {
-                 LISTDEB("EditList add %s: %p\n",Item->GetName(),Item);
-                 Add(new cOsdItem(Item->GetName(),
-                    osUnknown),false);
-                 Item=Item->GetNext();
-         };
-         SetHelp(tr("Options"),tr("(Add Files)"),tr("Delete"),tr("Stop"));
-         lastActivity=time(NULL);
- };
- 
- cEditList::~cEditList() {
- };
- 
- eOSState cEditList::ProcessKey(eKeys Key) {
-         eOSState state = cOsdMenu::ProcessKey(Key);
-         if (state != osUnknown ) 
-                 return state;
- 
-         cPlayList *List;
-         cPlayListItem *Item;
-         switch (Key) {
-                 case kOk:
-                         LISTDEB("Current %d GetItem %p\n",Current(),playList->GetItem(Current()));
-                         Item=playList->GetItem(Current());
-                         List=dynamic_cast<cPlayList*>(Item);
-                         LISTDEB("Item %p\n",Item);
- 
-                         if (List) {
-                                 cEditList *Menu=new cEditList(List);
-                                 return AddSubMenu(Menu);
-                         }  else {
-                                 // skip to current track
-                                 playList->shuffleIdx->currShuffleIdx = 
-                                         playList->GetIndexByItem(Item);
-                                 state = PLAY_CURR_FILE;
-                         };
-                         break;
-                 case kBack:
-                         state= osBack;
-                         break;
-                 case kBlue:
-                         state= osEnd;
-                         break;
-                 case kRed:
-                         return AddSubMenu(new cPlOptionsMenu(playList));
-                         break;
-                 case kYellow:
-                         LISTDEB("Del current %d: %s\n",
-                                         Current(),
-                                         playList->GetItem(Current())->GetName() );
-                         playList->RemoveItem(
-                                         playList->GetItem(Current()));
-                         LISTDEB("Remove finished\n");
-                         Del(Current());
-                         Display();
-                         state=osContinue;
-                         break;
- 
-                 default:    
-                         break;
-         }
- 
-         return state;
- }
- 
- // ----cReplayList------------------------------------------------------------
- cReplayList::cReplayList(cPlayList * List) : cOsdMenu(List->GetName()) {
-         playList=List;
-         SetHelp(tr("Options"),tr("(Add)"),tr("Delete"),tr("Stop"));
-         RebuildList();
- };
- 
- cReplayList::~cReplayList() {
- };
- 
- void cReplayList::RebuildList() {
-         int nItems=playList->GetNoItemsRecursive();
-         LISTDEB("RebuildList nItems %d nIdx %d \n",
-                         nItems,playList->shuffleIdx->nIdx);
- 
-         cPlayListItem * Item;
-         for (int i = 0 ; i<nItems; i++) {
- 		Item=playList->GetShuffledItemByIndex(i);
-                 if (!Item) {
-                         printf("Error getting all files for list index %d shuffleIdx %d\n",
-                                         i,playList->shuffleIdx[i]);
-                         continue;
-                 };
-                 
- 		LISTDEB("Add item %d (%p)  %s\n",
-                                 i,Item,Item->GetName());
-                 Add(new cOsdItem(Item->GetName(),
-                    osUnknown),false);
-         };
-         lastListItemCount = playList->GetNoItemsRecursive();
- 	playList->shuffleIdx->reshuffled = false;
-         SetCurrent(Get(playList->shuffleIdx->currShuffleIdx));
-         lastActivity=time(NULL)-600;
- };
- 
- void cReplayList::UpdateStatus() {
-         int current;
-         int total;
-         char Status[60];
-         char Name[60];
-         
-         if (!cControl::Control() || 
-                         !cControl::Control()->GetIndex(current,total))
-                 return;
-         
-         snprintf(Status,60,"Time %02d:%02d:%02d/%02d:%02d:%02d Title %d/%d",
-                         current/3600,current/60%60,current%60,
-                         total/3600,total/60%60,total%60,
-                         playList->shuffleIdx->currShuffleIdx+1,playList->shuffleIdx->nIdx);
-         SetStatus(Status);
- 
-         if (displayedCurrIdx != playList->shuffleIdx->currShuffleIdx){
-                 cPlayListItem *Item=playList->GetShuffledItemByIndex(
-                                 playList->shuffleIdx->currShuffleIdx);
-                 if (Item) {
-                         PrintCutDownString(Name,Item->GetName(),30);
-                         snprintf(Status,60,"%s: %s",playList->GetName(),
-                                                 Name);
-                         SetTitle(Status);
-                         Display();
-                         displayedCurrIdx=playList->shuffleIdx->currShuffleIdx;
-                 } else printf("Didn't get currShuffleIdx %d!\n",playList->shuffleIdx->currShuffleIdx);
-         };
- };
- 
- eOSState cReplayList::ProcessKey(eKeys Key) {
-         eOSState state = cOsdMenu::ProcessKey(Key);
- 
- 	// don't move cursor when it has been moved by the user
- 	// a short while ago
-         if ( Key==kUp || Key==kDown || Key==kRight || Key==kLeft ) 
-                 lastActivity=time(NULL);
-         
-         if (state != osUnknown ) 
-                 return state;
- 
-         if ( lastListItemCount != playList->GetNoItemsRecursive()
- 	     || playList->shuffleIdx->reshuffled ) {
-                 Clear();
-                 RebuildList();
-                 Display();
-         };
-         
-         if (Current() != playList->shuffleIdx->currShuffleIdx && 
-                         time(NULL) - lastActivity > 120 ) {
-                 LISTDEB("SetCurrent current title %d  time %d lastActivity %d\n",
-                                 playList->shuffleIdx->currShuffleIdx,time(NULL),lastActivity);
-                 SetCurrent(Get(playList->shuffleIdx->currShuffleIdx));
-                 Display();
-         };
- 
-         cPlayListItem *Item;
-         switch (Key) {
-                 case kOk:
-                         // skip to current track
-                         playList->shuffleIdx->currShuffleIdx = Current();
-                         state = PLAY_CURR_FILE;
-                         // want to have automatic track change
-                         lastActivity=time(NULL)-300;
-                         break;
-                 case kBack:
-                         state= osBack;
-                         break;
-                 case kBlue:
-                         state= osEnd;
-                         break;
-                 case kGreen:
- 			// not yet implemented
-                         state= osContinue;
-                         break;
-                 case kRed:
-                         return AddSubMenu(new cPlOptionsMenu(playList));
-                         break;
-                 case kYellow:
-                         Item=playList->GetShuffledItemByIndex(Current());
-                         if (!Item) {
-                                 printf("No current Item %d!\n",Current());
-                                 break;
-                         };
-                         LISTDEB("Del current %d: %s\n",
-                                         Current(),
-                                         Item->GetName() );
-                         playList->RemoveItem(Item);
- 			//playList->CleanShuffleIdx();
- 			lastListItemCount = playList->GetNoItemsRecursive();
-                         Del(Current());
-                         Display();
-                         state=osContinue;
-                         break;
- 
-                 default:    
-                         break;
-         }
-         if (!HasSubMenu())
-                 UpdateStatus();
- 		
-         return state;
- }
- 
  
  // -----cPlayList------------------------------------------------------------
--- 103,106 ----

Index: PlayList.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** PlayList.h	15 Aug 2005 08:05:15 -0000	1.8
--- PlayList.h	15 Aug 2005 09:07:30 -0000	1.9
***************
*** 13,17 ****
  #define __PLAYLIST_H__
  
- #include "vdr/osdbase.h"
  #include "softplay.h"
  
--- 13,16 ----
***************
*** 136,162 ****
  }; 
  
- class cEditList: public cOsdMenu {
-         time_t lastActivity;
-         int displayedCurrIdx;
-         cPlayList *playList;
-         public:
-         cEditList(cPlayList * List);
-         ~cEditList();
-         eOSState ProcessKey(eKeys Key);
- };
- 
- class cReplayList: public cOsdMenu {
-         time_t lastActivity;
-         int displayedCurrIdx;
-         cPlayList *playList;
- 	int lastListItemCount;
-         public:
-         cReplayList(cPlayList * List);
-         ~cReplayList();
- 	void RebuildList();
-         eOSState ProcessKey(eKeys Key);
-         void UpdateStatus();
- };
- 
  struct sPlayListOptions {
  	int shuffle;
--- 135,138 ----
***************
*** 165,172 ****
  
  class cPlayList : public cPlayListItem {
! 	friend class cEditList;
! 	friend class cReplayList;
  	
- 	//char ListName[STR_LENGTH];
  private:
          cPlayListItem *first;
--- 141,147 ----
  
  class cPlayList : public cPlayListItem {
! //	friend class cEditList;
! //	friend class cReplayList;
  	
  private:
          cPlayListItem *first;
***************
*** 212,215 ****
--- 187,193 ----
  
          cPlayListItem *GetItem(int No);
+ 	inline cPlayListItem *GetFirst()
+ 	{ return first; };
+ 
  	int GetNoItems();
  	int GetNoItemsRecursive();
***************
*** 220,225 ****
  
  	void Shuffle();
  
!         char *CurrFile();
          char *NextFile();
  	char *PrevFile();
--- 198,216 ----
  
  	void Shuffle();
+ 	inline bool IsDirty()
+ 	{ return shuffleIdx ? shuffleIdx->reshuffled : 0; };
  
! 	inline void SetClean()
! 	{ if (shuffleIdx)  shuffleIdx->reshuffled = false; };
! 
!         inline int GetCurrShuffleIdx()
! 	{ return shuffleIdx ? shuffleIdx->currShuffleIdx : -1; };
!         inline void SetCurrShuffleIdx(int Idx)
! 	{ if (shuffleIdx) shuffleIdx->currShuffleIdx = Idx; };
! 
! 	inline int GetShuffleNIdx()
! 	{ return shuffleIdx ? shuffleIdx->nIdx : -1; };
! 	
! 	char *CurrFile();
          char *NextFile();
  	char *PrevFile();
***************
*** 232,248 ****
          int LoadM3U(const char *Filename, const char *Name);
  };
- 
- class cPlOptionsMenu : public cOsdMenu {
-         protected:
-                 sPlayListOptions playListOptions;
-                 sPlayListOptions *options;
-                 cPlayList *playList;
-         public:
-                 cPlOptionsMenu(cPlayList *PlayList);
-                 cPlOptionsMenu(sPlayListOptions *Options);
-                 ~cPlOptionsMenu();
-                 eOSState ProcessKey(eKeys Key);
- };
-         
          
  #endif
--- 223,226 ----

Index: softplay.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/softplay.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** softplay.c	15 Aug 2005 07:27:42 -0000	1.8
--- softplay.c	15 Aug 2005 09:07:30 -0000	1.9
***************
*** 11,14 ****
--- 11,15 ----
  #include "SoftPlayer.h"
  #include "PlayList.h"
+ #include "PlayListMenu.h"
  #include "i18n.h"
  
***************
*** 146,150 ****
            };
  	  
! 	  // add to menu using original names
            PrintItemName(Name, Entries[nEntries],nEntries);
  
--- 147,151 ----
            };
  	  
! 	  // add to menu useing original names
            PrintItemName(Name, Entries[nEntries],nEntries);
  
***************
*** 202,206 ****
          if (play) {
                  // FIXME remove
!                Softplay->SaveList(PlayList);
                 cControl::Launch(new cSoftControl(PlayList));
                 return osEnd;
--- 203,207 ----
          if (play) {
                  // FIXME remove
!                // Softplay->SaveList(PlayList);
                 cControl::Launch(new cSoftControl(PlayList));
                 return osEnd;
***************
*** 326,330 ****
              break;
  
!     case CURR_PLAYLIST: return AddSubMenu(new cEditList(*currList));
              break;
  
--- 327,331 ----
              break;
  
!     case CURR_PLAYLIST: return AddSubMenu(new cAlbumList(*currList));
              break;
  

Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** SoftPlayer.c	8 Aug 2005 08:39:33 -0000	1.11
--- SoftPlayer.c	15 Aug 2005 09:07:30 -0000	1.12
***************
*** 12,15 ****
--- 12,16 ----
  #include "SoftPlayer.h"
  #include "softplay.h"
+ #include "PlayListMenu.h"
  
  #define PLDBG(out...) { printf("PLDBG: ");printf(out);}
***************
*** 513,517 ****
  				Hide();
  				OsdActive=OsdPrivMenu;
! 				privateMenu=new cEditList(Softplay->currList);
  				privateMenu->Display();
  				return osContinue;
--- 514,518 ----
  				Hide();
  				OsdActive=OsdPrivMenu;
! 				privateMenu=new cAlbumList(Softplay->currList);
  				privateMenu->Display();
  				return osContinue;



From nobody at sheep.berlios.de  Mon Aug 15 11:13:42 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Aug 2005 11:13:42 +0200
Subject: [Softdevice-cvs] softplay Makefile,1.3,1.4
Message-ID: <200508150913.j7F9Dg510556@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv31167

Modified Files:
	Makefile 
Log Message:
- add PlayListMenu.o
- default to -g compile



Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softplay/Makefile,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** Makefile	4 Aug 2005 15:20:40 -0000	1.3
--- Makefile	15 Aug 2005 09:13:39 -0000	1.4
***************
*** 21,25 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -Wall -Woverloaded-virtual -L$(LIBFFMPEG) -L$(LIBFFMPEG)/libavformat -L$(LIBFFMPEG)/libavcodec -L$(LIBFFMPEG)/libavutil 
  
  ### The directory environment:
--- 21,25 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -Woverloaded-virtual -L$(LIBFFMPEG) -L$(LIBFFMPEG)/libavformat -L$(LIBFFMPEG)/libavcodec -L$(LIBFFMPEG)/libavutil 
  
  ### The directory environment:
***************
*** 52,56 ****
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o i18n.o
  
  LIBS = -lavformat -lavcodec -lz
--- 52,56 ----
  ### The object files (add further files here):
  
! OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o PlayListMenu.o i18n.o
  
  LIBS = -lavformat -lavcodec -lz



From nobody at sheep.berlios.de  Mon Aug 15 15:13:16 2005
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Aug 2005 15:13:16 +0200
Subject: [Softdevice-cvs] softplay PlayList.c,1.11,1.12 PlayList.h,1.9,1.10 PlayListMenu.c,1.1,1.2 SoftPlayer.c,1.12,1.13
Message-ID: <200508151313.j7FDDG517586@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv701

Modified Files:
	PlayList.c PlayList.h PlayListMenu.c SoftPlayer.c 
Log Message:
- made ItemIdx a class instead of a struct
- moved all methods concerning ItmIdx from cPlayList to cItemIdx
- removed unused functions



Index: PlayList.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** PlayList.c	15 Aug 2005 09:07:30 -0000	1.11
--- PlayList.c	15 Aug 2005 13:13:14 -0000	1.12
***************
*** 24,27 ****
--- 24,259 ----
  #endif
  
+ // ---cItemIdx-------------------------------------------------------------
+ 
+ cItemIdx::cItemIdx(cPlayList *Owner ) {
+         owner = Owner;
+ 	currShuffleIdx=-1;
+ 	nIdx=0;
+ 	Idx=new sIdx[MAX_ITEMS];
+ 	memset(Idx,0,sizeof(sIdx[MAX_ITEMS]));
+ 	nAlbum=0;
+ 	Album=new sIdx[MAX_ITEMS/10];
+ 	memset(Album,0,sizeof(sIdx[MAX_ITEMS/10]));
+ };
+ 
+ cItemIdx::~cItemIdx() {
+         delete Idx;
+         delete Album;
+ };
+ 
+ cPlayList *cItemIdx::RemoveItem(cPlayListItem *Item) {
+         cPlayList *album;
+         if ( dynamic_cast <cPlayList*>(Item) ) {
+                 // remove a album 
+                 for (int i=0; i<nAlbum; i++) 
+                         if (Album[i].Item==Item) {
+                                 album=Album[i].Album;
+                                 memmove(&Album[i],&Album[i+1],
+                                         sizeof(Album[i])*(nAlbum-i));
+                                 nAlbum--;
+                                 return album;
+                         };
+ 
+         } else {
+                 // remove a track
+                 for (int i=0; i<nIdx; i++) 
+                         if (Idx[i].Item==Item) {
+                                 album=Idx[i].Album;
+                                 memmove(&Idx[i],&Idx[i+1],
+                                         sizeof(Idx[i])*(nIdx-i));
+                                 nIdx--;
+                                 if (i<currShuffleIdx)
+                                         currShuffleIdx--;
+                                 return album;
+                         };
+         };
+         return NULL;
+ };     
+ 
+ void cItemIdx::AddItemAtEnd(cPlayList *album, cPlayListItem *Item) {
+         if ( dynamic_cast <cPlayList*>(Item) ) {
+                 Album[nAlbum].Album=album;
+                 Album[nAlbum].Item=Item;
+                 Album[nAlbum].Hash=SimpleHash(Item->GetFilename());
+                 LISTDEB("Hash %x Filename %s\n",Album[nAlbum].Hash,Item->GetFilename());
+                 nAlbum++;
+         } else {
+                 Idx[nIdx].Album=album;
+                 Idx[nIdx].Item=Item;
+                 Idx[nIdx].Hash=SimpleHash(Item->GetFilename());
+                 LISTDEB("Hash %x Filename %s\n",
+                                 Idx[nIdx].Hash,Item->GetFilename());
+                 nIdx++;
+         }
+ }; 
+ 
+ cPlayListItem *cItemIdx::GetTrackByFilename(const char *Filename) {
+ 	int32_t hash=SimpleHash(Filename);
+         
+         for ( int i=0; i < nIdx; i++ ) 
+                 if ( hash==Idx[i].Hash && Idx[i].Item
+                         && strcmp(Filename,Idx[i].Item->GetFilename()) ==0)
+                         return Idx[i].Item;
+         return NULL;
+ };
+ 
+ cPlayListItem *cItemIdx::GetAlbumByFilename(const char *Filename) {
+ 	int32_t hash=SimpleHash(Filename);
+         
+         for ( int i=0; i < nAlbum; i++ ) 
+                 if ( hash==Album[i].Hash && Album[i].Item
+                         && strcmp(Filename,Album[i].Item->GetFilename())==0)
+                         return Album[i].Item;
+         return NULL;
+ };
+ 
+ int cItemIdx::GetIndexByItem(const cPlayListItem *Item) {
+         for ( int i=0; i < nIdx; i++ ) 
+                 if ( Item == Idx[i].Item )
+                         return i;
+         return -1;
+ };
+ 
+ const char * cItemIdx::NextFile() {
+         LISTDEB("NextFile currShuffleIdx %d\n",currShuffleIdx);
+         int saveCurrShuffleIdx=currShuffleIdx;
+ 
+         do {
+ 		++currShuffleIdx;
+                 if ( owner->options.autoRepeat && currShuffleIdx >= nIdx ) {
+                         currShuffleIdx=-1;
+                         if (owner->options.shuffle)
+                                 Shuffle();
+                         currShuffleIdx=0;
+                 };
+         } while ( currShuffleIdx < nIdx 
+                         && !Idx[currShuffleIdx].Item );
+ 	
+         LISTDEB("NextFile currShuffleIdx %d nIdx %d\n",currShuffleIdx,nIdx);
+ 
+         if ( currShuffleIdx > nIdx )
+                 currShuffleIdx=nIdx;
+ 
+ 	if ( Idx[currShuffleIdx].Item )
+ 		return Idx[currShuffleIdx].Item->GetFilename();
+ 
+         currShuffleIdx=saveCurrShuffleIdx;
+ 	return NULL;
+ };
+ 
+ const char * cItemIdx::PrevFile() {
+         LISTDEB("PrevFile currShuffleIdx %d\n",currShuffleIdx);
+         do {
+ 		--currShuffleIdx;
+                 if (owner->options.autoRepeat && currShuffleIdx<0)
+                         currShuffleIdx=nIdx-1;
+ 
+         } while ( currShuffleIdx > 0
+                         && !Idx[currShuffleIdx].Item );
+ 	
+         LISTDEB("PrevFile currShuffleIdx %d\n",currShuffleIdx);
+  
+         if ( currShuffleIdx < 0 )
+                 currShuffleIdx=0;
+ 
+ 	if ( Idx[ currShuffleIdx ].Item)
+ 		return Idx[ currShuffleIdx ].Item->GetFilename();
+ 	return NULL;
+ };
+ 
+ const char * cItemIdx::NextAlbumFile() {
+         cPlayList *currAlbum=Idx[currShuffleIdx].Album;
+         LISTDEB("NextAlbumFile currShuIdx %d currAlbum %p\n",
+                         currShuffleIdx,currAlbum);
+         int saveCurrShuffleIdx=currShuffleIdx;
+ 
+         do {
+ 		++currShuffleIdx;
+                 if ( owner->options.autoRepeat && 
+                      currShuffleIdx >= nIdx ) {
+                         if (owner->options.shuffle)
+                                 Shuffle();
+                         currShuffleIdx=0;
+                 };
+         } while ( currShuffleIdx < nIdx 
+                  && ( !Idx[currShuffleIdx].Item 
+                     || currAlbum==Idx[currShuffleIdx].Album ) );
+ 	
+         LISTDEB("NextAlbumFile currShuffleIdx %d \n",currShuffleIdx);
+         
+         if ( currShuffleIdx > nIdx )
+                 currShuffleIdx=nIdx;
+         
+ 	if ( Idx[ currShuffleIdx ].Item )
+ 		return Idx[ currShuffleIdx ].Item->GetFilename();
+ 
+         currShuffleIdx=saveCurrShuffleIdx;
+ 	return NULL;
+ };
+ 
+ const char * cItemIdx::PrevAlbumFile() {
+         LISTDEB("PrevAlbumFile currShuffleIdx %d\n",currShuffleIdx);
+         cPlayList *currAlbum=Idx[currShuffleIdx].Album;
+         do {
+ 	        --currShuffleIdx;
+                 if ( owner->options.autoRepeat && currShuffleIdx < 0 )
+                         currShuffleIdx = nIdx - 1;
+         } while ( currShuffleIdx > 0  
+                   && ( !Idx[currShuffleIdx].Item 
+                     || currAlbum == Idx[currShuffleIdx].Album ) );
+ 	
+         LISTDEB("PrevFile currShuffleIdx %d\n",currShuffleIdx);
+ 
+         if (currShuffleIdx < 0 )
+                 currShuffleIdx=0;
+         
+ 	if (Idx[currShuffleIdx].Item)
+ 		return Idx[currShuffleIdx].Item->GetFilename();
+ 	return NULL;
+ };
+ 
+ const char * cItemIdx::CurrFile() {
+         LISTDEB("CurrFile currShuffleIdx %d\n",currShuffleIdx);
+         
+ 	while ( !Idx[currShuffleIdx].Item && currShuffleIdx < nIdx )
+                 currShuffleIdx++;
+         
+         LISTDEB("CurrFile currShuffleIdx %d\n",currShuffleIdx);
+ 
+ 	if (Idx[currShuffleIdx].Item)
+ 		return Idx[currShuffleIdx].Item->GetFilename();
+ 	return NULL;
+ };
+ 
+ void cItemIdx::Shuffle() {
+         LISTDEB("Shuffle playlist nIdx %d currShuffleIdx %d\n",
+                         nIdx,currShuffleIdx);
+ 
+         sIdx index;
+         for (int i=0; i<2*nIdx ; i++) {
+ 		//FIXME - I guess the ranges are not completly correct
+                 int xchange1=(int)( (float)(random())*(float)(nIdx-1-currShuffleIdx)/(float)(RAND_MAX))
+ 			+currShuffleIdx+1;
+                 int xchange2=(int)( (float)(random())*(float)(nIdx-1-currShuffleIdx)/(float)(RAND_MAX))
+ 			+currShuffleIdx+1;
+                 if (xchange1 >=nIdx)
+                         LISTDEB("Martin, depp!! %d\n",xchange1);
+                 if (xchange2 >=nIdx)
+                         LISTDEB("Martin, depp!! %d\n",xchange2);
+                 
+ 		LISTDEB("Shuffle %4d(%4d) - %4d(%4d) \n",
+                    xchange1,Idx[xchange1],xchange2,Idx[xchange2]);
+                 index=Idx[xchange1];
+                 Idx[xchange1]=Idx[xchange2];
+                 Idx[xchange2]=index;
+         };
+ 	reshuffled=true;
+ /*
+ 	for (int i=0; i<nItems ; i++) 
+ 		LISTDEB("shuffleIdx[%d]: %d\n",i,shuffleIdx->Idx[i]);       
+ */
+ };
+ 
+ 
  // ---cPlayListItem--------------------------------------------------------
  cPlayListItem::cPlayListItem(const char *Filename, const char *Name) {
***************
*** 50,54 ****
  
  
! void cPlayListItem::BuildIdx(sItemIdx *ShuffleIdx) {
  };
  
--- 282,286 ----
  
  
! void cPlayListItem::BuildIdx(cItemIdx *ShuffleIdx) {
  };
  
***************
*** 106,110 ****
  // -----cPlayList------------------------------------------------------------
  cPlayList::cPlayList(const char *Filename, const char *Name,
!                 sItemIdx *ShuffleIdx) 
                  : cPlayListItem(Filename,(Name ? Name : tr("Playlist 1"))) {
          first=NULL;
--- 338,342 ----
  // -----cPlayList------------------------------------------------------------
  cPlayList::cPlayList(const char *Filename, const char *Name,
!                 cItemIdx *ShuffleIdx) 
                  : cPlayListItem(Filename,(Name ? Name : tr("Playlist 1"))) {
          first=NULL;
***************
*** 114,125 ****
          
          if (!ShuffleIdx) {
! 	        shuffleIdx=new sItemIdx;
!                 shuffleIdx->currShuffleIdx=-1;
!                 shuffleIdx->nIdx=0;
!                 shuffleIdx->Idx=new sIdx[MAX_ITEMS];
!                 memset(shuffleIdx->Idx,0,sizeof(sIdx[MAX_ITEMS]));
!                 shuffleIdx->nAlbum=0;
!                 shuffleIdx->Album=new sIdx[MAX_ITEMS/10];
!                 memset(shuffleIdx->Album,0,sizeof(sIdx[MAX_ITEMS/10]));
                  shuffleIdxOwner=true;
          } else {
--- 346,350 ----
          
          if (!ShuffleIdx) {
! 	        shuffleIdx=new cItemIdx(this);
                  shuffleIdxOwner=true;
          } else {
***************
*** 133,137 ****
                  RemoveItem(first);
          if (shuffleIdxOwner) {
-                 delete shuffleIdx->Idx;
                  delete shuffleIdx;
                  shuffleIdx=NULL;
--- 358,361 ----
***************
*** 139,175 ****
  };
  
- bool cPlayList::RemoveItem(cPlayListItem *Item) {
-         cPlayList *playList=dynamic_cast <cPlayList*>(Item);
-         if (playList) {
-                 for (int i=0; i<shuffleIdx->nAlbum; i++) 
-                         if (shuffleIdx->Album[i].Item==Item) {
-                                 shuffleIdx->Album[i].Album->
-                                         RemoveItemFromList(Item);
-                                 memmove(&shuffleIdx->Album[i],
-                                                 &shuffleIdx->Album[i+1],
-                                                 sizeof(shuffleIdx->Album[i])*
-                                                 (shuffleIdx->nAlbum-i));
-                                 shuffleIdx->nAlbum--;
-                                 return true;
-                         };
- 
-         } else {
-                 for (int i=0; i<shuffleIdx->nIdx; i++) 
-                         if (shuffleIdx->Idx[i].Item==Item) {
-                                 shuffleIdx->Idx[i].Album->
-                                         RemoveItemFromList(Item);
-                                 memmove(&shuffleIdx->Idx[i],
-                                                 &shuffleIdx->Idx[i+1],
-                                                 sizeof(shuffleIdx->Idx[i])*
-                                                 (shuffleIdx->nIdx-i));
-                                 shuffleIdx->nIdx--;
-                                 if (i<shuffleIdx->currShuffleIdx)
-                                         shuffleIdx->currShuffleIdx--;
-                                 return true;
-                         };
-         };
-         return true;
- };
- 
  bool cPlayList::RemoveItemFromList(cPlayListItem *Item) {
          LISTDEB("RemoveItemFromList %p, first %p last %p\n",Item,first,last);
--- 363,366 ----
***************
*** 191,216 ****
  };
  
! cPlayList *cPlayList::GetItemAlbum(cPlayListItem *Item) {
!         LISTDEB("GetItemAlbum %p, first %p last %p\n",Item,first,last);
! 	cPlayListItem *listItem=first;
! 	cPlayList *List=NULL;
!         cPlayList *Ret=NULL;
! 	// find Item in list or in sublist
! 	while (listItem && listItem!=Item) {
! 		// if listItem is a list ask list if it owns item 
!                 if ( (List=dynamic_cast <cPlayList*>(listItem)) 
! 			&& (Ret=List->GetItemAlbum(Item)) )
! 			// return sublist if it owns Item
! 			return Ret;
!                 listItem=listItem->GetNext();
! 	};
! 	// item is in this list
! 	if (listItem == Item)
! 		return this;
! 	
!         return NULL;
! };
! 
! void cPlayList::AddItemAtEnd(cPlayListItem *Item) {
          if (!last) {
                  Item->InsertSelfIntoList(NULL,NULL);
--- 382,386 ----
  };
  
! void cPlayList::AddItemAtEndToList(cPlayListItem *Item) {
          if (!last) {
                  Item->InsertSelfIntoList(NULL,NULL);
***************
*** 222,299 ****
                  last = Item;
          };
-         if ( dynamic_cast <cPlayList*>(Item) ) {
-                 shuffleIdx->Album[shuffleIdx->nAlbum].Album=this;
-                 shuffleIdx->Album[shuffleIdx->nAlbum].Item=Item;
-                 shuffleIdx->Album[shuffleIdx->nAlbum].Hash=
-                         SimpleHash(Item->GetFilename());
-                 LISTDEB("Hash %x Filename %s\n",shuffleIdx->Album[shuffleIdx->nAlbum].Hash,Item->GetFilename());
-                 shuffleIdx->nAlbum++;
-         } else {
-                 shuffleIdx->Idx[shuffleIdx->nIdx].Album=this;
-                 shuffleIdx->Idx[shuffleIdx->nIdx].Item=Item;
-                 shuffleIdx->Idx[shuffleIdx->nIdx].Hash=
-                         SimpleHash(Item->GetFilename());
-                 LISTDEB("Hash %x Filename %s\n",shuffleIdx->Idx[shuffleIdx->nIdx].Hash,Item->GetFilename());
-                 shuffleIdx->nIdx++;
-         }
- };                    
- 
- void cPlayList::BuildIdx(sItemIdx *ShuffleIdx) {
-         shuffleIdx=ShuffleIdx;
- 	cPlayListItem *currItem=NULL;
- 	if (shuffleIdx->currShuffleIdx!=-1) {
- 		// while playback rember current item, if this has been
- 		// deleted find the next not deleted item
- 		while ( ! (currItem=GetShuffledItemByIndex(shuffleIdx->currShuffleIdx) ) && 
- 				shuffleIdx->currShuffleIdx<shuffleIdx->nIdx)
- 			shuffleIdx->currShuffleIdx++;
- 	};
- 			
-         cPlayListItem *Item=first;
- 
-         while (Item) {
-                 LISTDEB("Item %p Item->GetNext() %p \n",Item,Item->GetNext());
-                 Item->BuildIdx(shuffleIdx);
-                 Item=Item->GetNext();
-         };
- /*	
- 	if (currItem) {
- 		// FIXME if currItem has been deleted do I have to subtract one?
- 		currItemIdx=Item->GetIdx();
- 		for (int i=0; i<nItems; i++) 
- 			if ( currItemIdx==shuffleIdx[i] ) {
- 				currShuffleIdx=i;
- 				break;
- 			};
- 	};
-         */
  };
  
! cPlayListItem *cPlayList::GetItemByFilename(const char *Filename) {
! 	int32_t hash=SimpleHash(Filename);
!         
!         for (int i=0; i<shuffleIdx->nIdx;i++) 
!                 if ( hash==shuffleIdx->Idx[i].Hash && shuffleIdx->Idx[i].Item
!                         && strcmp(Filename,shuffleIdx->Idx[i].Item->GetFilename()) ==0)
!                         return shuffleIdx->Idx[i].Item;
!         return NULL;
! };
  
! int cPlayList::GetIndexByItem(const cPlayListItem *Item) {
!         for (int i=0; i<shuffleIdx->nIdx;i++) 
!                 if ( Item==shuffleIdx->Idx[i].Item )
!                         return i;
!         return -1;
  };
  
! cPlayListItem *cPlayList::GetAlbumByFilename(const char *Filename) {
! 	int32_t hash=SimpleHash(Filename);
!         
!         for (int i=0; i<shuffleIdx->nAlbum;i++) 
!                 if ( hash==shuffleIdx->Album[i].Hash && shuffleIdx->Album[i].Item
!                         && strcmp(Filename,shuffleIdx->Album[i].Item->GetFilename())==0)
! 
!                         return shuffleIdx->Album[i].Item;
!         return NULL;
  };
  
--- 392,413 ----
                  last = Item;
          };
  };
  
! void cPlayList::AddItemAtEnd(cPlayListItem *Item) {
!         AddItemAtEndToList(Item);
!         if (shuffleIdx)
!                 shuffleIdx->AddItemAtEnd(this,Item);        
! };                    
  
! bool cPlayList::RemoveItem(cPlayListItem *Item) { 
!         cPlayList *album=NULL;
!         if (shuffleIdx )
!                 album=shuffleIdx->RemoveItem(Item);
!         if (album)
!                 return album->RemoveItemFromList(Item);
!         return false; 
  };
  
! void cPlayList::BuildIdx(cItemIdx *ShuffleIdx) {
  };
  
***************
*** 326,329 ****
--- 440,471 ----
  };
  
+ cPlayListItem *cPlayList::GetItem(int No) {
+         int count=0;
+         cPlayListItem *Item=first;
+         while ( Item && count!=No ) {
+                 count++;
+                 Item=Item->GetNext();
+         };
+         return Item;
+ };
+   
+ void cPlayList::PrepareForPlayback() {
+ 	LISTDEB("PrepareForPlayback\n");
+ 	shuffleIdx->currShuffleIdx=-1;
+ 
+         BuildIdx();
+         if (options.shuffle)
+                 shuffleIdx->Shuffle();
+ };
+ 
+ void cPlayList::SetOptions( sPlayListOptions &Options) {
+ 
+         if (Options.shuffle != options.shuffle 
+                         && Options.shuffle)
+                 shuffleIdx->Shuffle();
+ 
+         options=Options;
+ };
+ 
  bool cPlayList::ScanDir(char * dirname, bool recursive) {
          struct dirent **namelist;
***************
*** 352,356 ****
  
                  // check type (non ext2/3 and symlinks)
!                 if ( namelist[i]->d_type == 0 || namelist[i]->d_type == DT_LNK ) {
                          struct stat stbuf;
                          if ( !stat(Name,&stbuf) ) {
--- 494,499 ----
  
                  // check type (non ext2/3 and symlinks)
!                 if ( namelist[i]->d_type == 0 || 
!                                 namelist[i]->d_type == DT_LNK ) {
                          struct stat stbuf;
                          if ( !stat(Name,&stbuf) ) {
***************
*** 372,575 ****
  };
  
- char * cPlayList::NextFile() {
-         LISTDEB("NextFile currShuffleIdx %d\n",
-                         shuffleIdx->currShuffleIdx);
-         int saveCurrShuffleIdx=shuffleIdx->currShuffleIdx;
- 
-         do {
- 		++shuffleIdx->currShuffleIdx;
-                 if ( options.autoRepeat && 
-                      shuffleIdx->currShuffleIdx >= shuffleIdx->nIdx ) {
-                         shuffleIdx->currShuffleIdx=-1;
-                         if (options.shuffle)
-                                 Shuffle();
-                         shuffleIdx->currShuffleIdx=0;
-                 };
-         } while ( shuffleIdx->currShuffleIdx<shuffleIdx->nIdx 
-                         && !shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item );
- 	
-         LISTDEB("NextFile currShuffleIdx %d nIdx %d\n",
-                         shuffleIdx->currShuffleIdx,shuffleIdx->nIdx);
- 
-         if ( shuffleIdx->currShuffleIdx > shuffleIdx->nIdx )
-                 shuffleIdx->currShuffleIdx=shuffleIdx->nIdx;
- 
- 	if ( shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item )
- 		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
- 
-         shuffleIdx->currShuffleIdx=saveCurrShuffleIdx;
- 	return NULL;
- };
- 
- char * cPlayList::PrevFile() {
-         LISTDEB("PrevFile currShuffleIdx %d\n",
-                         shuffleIdx->currShuffleIdx);
-         do {
- 		--shuffleIdx->currShuffleIdx;
-                 if (options.autoRepeat && shuffleIdx->currShuffleIdx<0)
-                         shuffleIdx->currShuffleIdx=shuffleIdx->nIdx-1;
- 
-         } while ( shuffleIdx->currShuffleIdx > 0
-                         &&!shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item );
- 	
-         LISTDEB("PrevFile currShuffleIdx %d\n",shuffleIdx->currShuffleIdx);
-  
-         if ( shuffleIdx->currShuffleIdx < 0 )
-                 shuffleIdx->currShuffleIdx=0;
- 
- 	if ( shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item)
- 		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
- 	return NULL;
- };
- 
- char * cPlayList::NextAlbumFile() {
-         cPlayList *currAlbum=shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Album;
-         LISTDEB("NextAlbumFile currShuIdx %d currAlbum %p\n",
-                         shuffleIdx->currShuffleIdx,currAlbum);
-         int saveCurrShuffleIdx=shuffleIdx->currShuffleIdx;
- 
-         do {
- 		++shuffleIdx->currShuffleIdx;
-                 if ( options.autoRepeat && 
-                      shuffleIdx->currShuffleIdx >= shuffleIdx->nIdx ) {
-                         shuffleIdx->currShuffleIdx=-1;
-                         if (options.shuffle)
-                                 Shuffle();
-                         shuffleIdx->currShuffleIdx=0;
-                 };
-         } while ( shuffleIdx->currShuffleIdx<shuffleIdx->nIdx 
-                         && ( !shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item 
-                     || currAlbum==shuffleIdx->Idx[
-                     shuffleIdx->currShuffleIdx].Album ) );
- 	
-         LISTDEB("NextAlbumFile currShuffleIdx %d \n",
-                         shuffleIdx->currShuffleIdx);
-         
-         if ( shuffleIdx->currShuffleIdx > shuffleIdx->nIdx )
-                 shuffleIdx->currShuffleIdx=shuffleIdx->nIdx;
-         
- 	if (shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item)
- 		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
- 
-         shuffleIdx->currShuffleIdx=saveCurrShuffleIdx;
- 	return NULL;
- };
- 
- char * cPlayList::PrevAlbumFile() {
-         LISTDEB("PrevAlbumFile currShuffleIdx %d\n",
-                         shuffleIdx->currShuffleIdx);
-         cPlayList *currAlbum=shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Album;
-         do {
- 	        --shuffleIdx->currShuffleIdx;
-                 if (options.autoRepeat && shuffleIdx->currShuffleIdx<0)
-                         shuffleIdx->currShuffleIdx=shuffleIdx->nIdx-1;
-         } while ( shuffleIdx->currShuffleIdx > 0  
-                   && ( !shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item 
-                     || currAlbum==shuffleIdx->Idx[
-                     shuffleIdx->currShuffleIdx].Album ) );
- 	
-         LISTDEB("PrevFile currShuffleIdx %d\n",shuffleIdx->currShuffleIdx);
- 
-         if (shuffleIdx->currShuffleIdx < 0 )
-                 shuffleIdx->currShuffleIdx=0;
-         
- 	if (shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item)
- 		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
- 	return NULL;
- };
- 
- char * cPlayList::CurrFile() {
-         LISTDEB("CurrFile shuffleIdx->currShuffleIdx %d\n",
-                         shuffleIdx->currShuffleIdx);
- 	while (!shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item
-                         && shuffleIdx->currShuffleIdx<shuffleIdx->nIdx )
-                 shuffleIdx->currShuffleIdx++;
-         LISTDEB("CurrFile currShuffleIdx %d\n",shuffleIdx->currShuffleIdx);
- 
- 	if (shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item)
- 		return shuffleIdx->Idx[shuffleIdx->currShuffleIdx].Item->GetFilename();
- 	return NULL;
- };
- 
- cPlayListItem *cPlayList::GetItem(int No) {
-         int count=0;
-         cPlayListItem *Item=first;
-         while ( Item && count!=No ) {
-                 count++;
-                 Item=Item->GetNext();
-         };
-         return Item;
- };
- 
- int cPlayList::GetNoItems() {
-         int count=0;
-         cPlayListItem *Item=first;
-         while ( Item ) {
-                 count++;
-                 Item=Item->GetNext();
-         };
-         return count;
- };
- 
- int cPlayList::GetNoItemsRecursive() {
-         int count=0;
-         cPlayListItem *Item=first;
-         cPlayList *List;
-         while ( Item ) {
-                 // count items of lists instead of list
-                 if ( (List=dynamic_cast <cPlayList*>(Item)) )
-                         count+=List->GetNoItemsRecursive();
-                 else count++;
-                 Item=Item->GetNext();
-         };
-         return count;
- };
-   
- void cPlayList::PrepareForPlayback() {
- 	LISTDEB("PrepareForPlayback\n");
- 	shuffleIdx->currShuffleIdx=-1;
- 
-         BuildIdx();
-         if (options.shuffle)
-                 Shuffle();
- };
- 
- void cPlayList::Shuffle() {
-         LISTDEB("Shuffle playlist nIdx %d currShuffleIdx %d\n",
-                         shuffleIdx->nIdx,shuffleIdx->currShuffleIdx);
- 
-         sIdx index;
-         for (int i=0; i<2*shuffleIdx->nIdx ; i++) {
- 		//FIXME - I guess the ranges are not completly correct
-                 int xchange1=(int)( (float)(random())*(float)(shuffleIdx->nIdx-1-shuffleIdx->currShuffleIdx)/(float)(RAND_MAX))
- 			+shuffleIdx->currShuffleIdx+1;
-                 int xchange2=(int)( (float)(random())*(float)(shuffleIdx->nIdx-1-shuffleIdx->currShuffleIdx)/(float)(RAND_MAX))
- 			+shuffleIdx->currShuffleIdx+1;
-                 if (xchange1 >=shuffleIdx->nIdx)
-                         LISTDEB("Martin, depp!! %d\n",xchange1);
-                 if (xchange2 >=shuffleIdx->nIdx)
-                         LISTDEB("Martin, depp!! %d\n",xchange2);
-                 
- 		LISTDEB("Shuffle %4d(%4d) - %4d(%4d) \n",
-                    xchange1,shuffleIdx[xchange1],xchange2,shuffleIdx[xchange2]);
-                 index=shuffleIdx->Idx[xchange1];
-                 shuffleIdx->Idx[xchange1]=shuffleIdx->Idx[xchange2];
-                 shuffleIdx->Idx[xchange2]=index;
-         };
- 	shuffleIdx->reshuffled=true;
- /*
- 	for (int i=0; i<nItems ; i++) 
- 		LISTDEB("shuffleIdx[%d]: %d\n",i,shuffleIdx->Idx[i]);       
- */
- };
- 
- void cPlayList::SetOptions( sPlayListOptions &Options) {
- 
-         if (Options.shuffle != options.shuffle 
-                         && Options.shuffle)
-                 Shuffle();
- 
-         options=Options;
- };
  
  void cPlayList::Save(FILE *out) {
--- 515,518 ----

Index: PlayList.h
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayList.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** PlayList.h	15 Aug 2005 09:07:30 -0000	1.9
--- PlayList.h	15 Aug 2005 13:13:14 -0000	1.10
***************
*** 26,36 ****
  };
                  
! struct sItemIdx {
!         int currShuffleIdx;
!         int nIdx;
!         sIdx *Idx;
!         int nAlbum;
!         sIdx *Album;
! 	bool reshuffled;
  };      
  
--- 26,66 ----
  };
                  
! class cItemIdx {
!         private:
!                 cPlayList *owner;
!                 
!                 int nIdx;
!                 sIdx *Idx;
!                 int nAlbum;
!                 sIdx *Album;
!         public: 
!                 bool reshuffled;
!                 int currShuffleIdx;
!                 
!                 cItemIdx(cPlayList *Owner);
!                 ~cItemIdx();
! 
!                 cPlayList *RemoveItem(cPlayListItem *Item);
! 
!                 void AddItemAtEnd(cPlayList *Album, cPlayListItem *Item);
! 
!                 cPlayListItem * GetTrackByFilename(const char *Filename);
!                 cPlayListItem * GetAlbumByFilename(const char *Filename);
!   
!                 inline cPlayListItem* GetItemByIndex(int Index) 
!                 { return Idx[Index].Item; };
!                 
!                 int GetIndexByItem(const cPlayListItem *Item);
!                
!                 const char *CurrFile();
!                 const char *NextFile();
!                 const char *PrevFile();
!                 const char *NextAlbumFile();
!                 const char *PrevAlbumFile();
! 
!                 inline int GetNIdx() 
!                 { return nIdx; };
! 
!                 void Shuffle();
  };      
  
***************
*** 44,48 ****
                  cPlayListItem *previous;
          public:
!                 cPlayListItem(const char *Filename=NULL,  const char *Name=NULL);
                  virtual ~cPlayListItem();
  
--- 74,78 ----
                  cPlayListItem *previous;
          public:
!                 cPlayListItem(const char *Filename=NULL, const char *Name=NULL);
                  virtual ~cPlayListItem();
  
***************
*** 67,75 ****
  
          public:
!                 virtual void BuildIdx(sItemIdx *shuffleIdx);
                          
-                 virtual int GetNoItems()
-                 {return 1; };
- 
                  inline cPlayListItem *GetNext()
                  {return next;};
--- 97,102 ----
  
          public:
!                 virtual void BuildIdx(cItemIdx *shuffleIdx);
                          
                  inline cPlayListItem *GetNext()
                  {return next;};
***************
*** 84,88 ****
                  {};
          protected:
!                 const char *ParseTypeFilenameName(const char *Str, char *Type, char *Filename, char *Name);
  };
  
--- 111,116 ----
                  {};
          protected:
!                 const char *ParseTypeFilenameName(const char *Str, 
!                                 char *Type, char *Filename, char *Name);
  };
  
***************
*** 141,157 ****
  
  class cPlayList : public cPlayListItem {
- //	friend class cEditList;
- //	friend class cReplayList;
- 	
  private:
          cPlayListItem *first;
          cPlayListItem *last;
          bool shuffleIdxOwner;
!         sItemIdx *shuffleIdx;
         
-         sPlayListOptions options;
    public:
          cPlayList(const char *Filename=NULL, const char *Name=NULL,
!                         sItemIdx *shuffleIdx=NULL);
    private:
  	cPlayList(const cPlayList &List) {};
--- 169,182 ----
  
  class cPlayList : public cPlayListItem {
  private:
          cPlayListItem *first;
          cPlayListItem *last;
          bool shuffleIdxOwner;
!         cItemIdx *shuffleIdx;
         
    public:
+         sPlayListOptions options;
          cPlayList(const char *Filename=NULL, const char *Name=NULL,
!                         cItemIdx *shuffleIdx=NULL);
    private:
  	cPlayList(const cPlayList &List) {};
***************
*** 160,164 ****
          virtual ~cPlayList();
  
!         virtual void BuildIdx(sItemIdx *ShuffleIdx);
          inline void BuildIdx()
          {BuildIdx(shuffleIdx);}; 
--- 185,189 ----
          virtual ~cPlayList();
  
!         virtual void BuildIdx(cItemIdx *ShuffleIdx);
          inline void BuildIdx()
          {BuildIdx(shuffleIdx);}; 
***************
*** 169,188 ****
  	{ Options=options; };
          
-         inline cPlayListItem *GetShuffledItemByIndex(int Index) {   
-                 if (!shuffleIdx) return NULL;
-                 return shuffleIdx->Idx[Index].Item; 
-         };
-         cPlayListItem *GetItemByFilename(const char *Filename);
-         cPlayListItem *GetAlbumByFilename(const char *Filename);
-         int GetIndexByItem(const cPlayListItem *Item);
- 
    private:
          bool RemoveItemFromList(cPlayListItem *Item);
    public:
!         bool RemoveItem(cPlayListItem *Item);
          void AddItemAtEnd(cPlayListItem *Item);
- 	cPlayList *GetItemAlbum(cPlayListItem *Item);
-         
-         bool AddFile(char * Filename,char *Title = NULL);
  
          cPlayListItem *GetItem(int No);
--- 194,207 ----
  	{ Options=options; };
          
    private:
+ 
+         void AddItemAtEndToList(cPlayListItem *Item);
+ 
          bool RemoveItemFromList(cPlayListItem *Item);
+ 
    public:
!         bool RemoveItem(cPlayListItem *Item); 
! 
          void AddItemAtEnd(cPlayListItem *Item);
  
          cPlayListItem *GetItem(int No);
***************
*** 190,201 ****
  	{ return first; };
  
! 	int GetNoItems();
! 	int GetNoItemsRecursive();
! 
!         bool ScanDir(char * dirname, bool recursive = true);
          bool AddDir(char * dirname,char *Title = NULL, bool recursive = true);
          bool AddM3U(char * Filename,char *Title = NULL);
  
! 	void Shuffle();
  	inline bool IsDirty()
  	{ return shuffleIdx ? shuffleIdx->reshuffled : 0; };
--- 209,224 ----
  	{ return first; };
  
!         bool AddFile(char * Filename,char *Title = NULL);
          bool AddDir(char * dirname,char *Title = NULL, bool recursive = true);
          bool AddM3U(char * Filename,char *Title = NULL);
  
!         virtual void Save(FILE *out);
! 	int Load(FILE *out, const char * StartLine=NULL);
! 
!         bool ScanDir(char * dirname, bool recursive = true);
!         
!         int LoadM3U(const char *Filename, const char *Name);
! 
!         // interface to cItemIdx        
  	inline bool IsDirty()
  	{ return shuffleIdx ? shuffleIdx->reshuffled : 0; };
***************
*** 204,225 ****
  	{ if (shuffleIdx)  shuffleIdx->reshuffled = false; };
  
!         inline int GetCurrShuffleIdx()
  	{ return shuffleIdx ? shuffleIdx->currShuffleIdx : -1; };
          inline void SetCurrShuffleIdx(int Idx)
  	{ if (shuffleIdx) shuffleIdx->currShuffleIdx = Idx; };
  
! 	inline int GetShuffleNIdx()
! 	{ return shuffleIdx ? shuffleIdx->nIdx : -1; };
  	
! 	char *CurrFile();
!         char *NextFile();
! 	char *PrevFile();
! 	char *NextAlbumFile();
! 	char *PrevAlbumFile();
  	
! 	virtual void Save(FILE *out);
! 	int Load(FILE *out, const char * StartLine=NULL);
  
-         int LoadM3U(const char *Filename, const char *Name);
  };
          
--- 227,269 ----
  	{ if (shuffleIdx)  shuffleIdx->reshuffled = false; };
  
!         inline int GetCurrIdx()
  	{ return shuffleIdx ? shuffleIdx->currShuffleIdx : -1; };
          inline void SetCurrShuffleIdx(int Idx)
  	{ if (shuffleIdx) shuffleIdx->currShuffleIdx = Idx; };
  
! 	inline int GetNIdx()
! 	{ return shuffleIdx ? shuffleIdx->GetNIdx() : -1; };
  	
! 	inline const char *CurrFile()
!         { return shuffleIdx ? shuffleIdx->CurrFile() : NULL; };
!         inline const char *NextFile()
!         { return shuffleIdx ? shuffleIdx->NextFile() : NULL; };
! 	inline const char *PrevFile()
!         { return shuffleIdx ? shuffleIdx->PrevFile() : NULL; };
! 	inline const char *NextAlbumFile()
!         { return shuffleIdx ? shuffleIdx->NextAlbumFile() : NULL; };
! 	inline const char *PrevAlbumFile()
!         { return shuffleIdx ? shuffleIdx->PrevAlbumFile() : NULL; };
  	
!         inline cPlayListItem *GetShuffledItemByIndex(int Index) {   
!                 return shuffleIdx ?
!                         shuffleIdx->GetItemByIndex(Index) : NULL; 
!         };
!         
!         inline cPlayListItem *GetItemByFilename(const char *Filename) { 
!                 return shuffleIdx ?
!                         shuffleIdx->GetTrackByFilename(Filename) : NULL; 
!         };
! 
!         inline cPlayListItem *GetAlbumByFilename(const char *Filename) {
!                 return shuffleIdx ?
!                         shuffleIdx->GetAlbumByFilename(Filename) : NULL; 
!         };
! 
!         inline int GetIndexByItem(const cPlayListItem *Item) {
!                 return shuffleIdx ? 
!                         shuffleIdx->GetIndexByItem(Item) : -1; 
!         };
  
  };
          

Index: PlayListMenu.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/PlayListMenu.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** PlayListMenu.c	15 Aug 2005 09:07:30 -0000	1.1
--- PlayListMenu.c	15 Aug 2005 13:13:14 -0000	1.2
***************
*** 100,104 ****
  
  void cReplayList::RebuildList() {
!         int nItems=playList->GetNoItemsRecursive();
          MENUDEB("RebuildList nItems %d \n",nItems);
  
--- 100,104 ----
  
  void cReplayList::RebuildList() {
!         int nItems=playList->GetNIdx();
          MENUDEB("RebuildList nItems %d \n",nItems);
  
***************
*** 117,123 ****
                     osUnknown),false);
          };
!         lastListItemCount = playList->GetNoItemsRecursive();
  	playList->SetClean();
!         SetCurrent(Get(playList->GetCurrShuffleIdx()));
          lastActivity=time(NULL)-600;
  };
--- 117,123 ----
                     osUnknown),false);
          };
!         lastListItemCount = playList->GetNIdx();
  	playList->SetClean();
!         SetCurrent(Get(playList->GetCurrIdx()));
          lastActivity=time(NULL)-600;
  };
***************
*** 136,146 ****
                          current/3600,current/60%60,current%60,
                          total/3600,total/60%60,total%60,
!                         playList->GetCurrShuffleIdx()+1,
! 			playList->GetShuffleNIdx());
          SetStatus(Status);
  
!         if (displayedCurrIdx != playList->GetCurrShuffleIdx()){
                  cPlayListItem *Item=playList->GetShuffledItemByIndex(
!                                 playList->GetCurrShuffleIdx());
                  if (Item) {
                          PrintCutDownString(Name,Item->GetName(),30);
--- 136,146 ----
                          current/3600,current/60%60,current%60,
                          total/3600,total/60%60,total%60,
!                         playList->GetCurrIdx()+1,
! 			playList->GetNIdx());
          SetStatus(Status);
  
!         if (displayedCurrIdx != playList->GetCurrIdx()){
                  cPlayListItem *Item=playList->GetShuffledItemByIndex(
!                                 playList->GetCurrIdx());
                  if (Item) {
                          PrintCutDownString(Name,Item->GetName(),30);
***************
*** 149,154 ****
                          SetTitle(Status);
                          Display();
!                         displayedCurrIdx=playList->GetCurrShuffleIdx();
!                 } else printf("Didn't get currShuffleIdx %d!\n",playList->GetCurrShuffleIdx());
          };
  };
--- 149,154 ----
                          SetTitle(Status);
                          Display();
!                         displayedCurrIdx=playList->GetCurrIdx();
!                 } else printf("Didn't get currShuffleIdx %d!\n",playList->GetCurrIdx());
          };
  };
***************
*** 162,169 ****
                  lastActivity=time(NULL);
          
!         if (state != osUnknown ) 
!                 return state;
! 
!         if ( lastListItemCount != playList->GetNoItemsRecursive()
  	     || playList->IsDirty() ) {
                  Clear();
--- 162,166 ----
                  lastActivity=time(NULL);
          
!         if ( lastListItemCount != playList->GetNIdx()
  	     || playList->IsDirty() ) {
                  Clear();
***************
*** 172,183 ****
          };
          
!         if (Current() != playList->GetCurrShuffleIdx() && 
!                         time(NULL) - lastActivity > 120 ) {
                  MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
!                                 playList->GetCurrShuffleIdx(),time(NULL),lastActivity);
!                 SetCurrent(Get(playList->GetCurrShuffleIdx()));
                  Display();
          };
  
          cPlayListItem *Item;
          switch (Key) {
--- 169,183 ----
          };
          
!         if (Current() != playList->GetCurrIdx() && 
!                         time(NULL) - lastActivity > 12 ) {
                  MENUDEB("SetCurrent current title %d  time %d lastActivity %d\n",
!                                 playList->GetCurrIdx(),time(NULL),lastActivity);
!                 SetCurrent(Get(playList->GetCurrIdx()));
                  Display();
          };
  
+ 	if (state != osUnknown ) 
+ 		return state;
+ 
          cPlayListItem *Item;
          switch (Key) {
***************
*** 212,217 ****
                                          Item->GetName() );
                          playList->RemoveItem(Item);
! 			//playList->CleanShuffleIdx();
! 			lastListItemCount = playList->GetNoItemsRecursive();
                          Del(Current());
                          Display();
--- 212,216 ----
                                          Item->GetName() );
                          playList->RemoveItem(Item);
! 			lastListItemCount = playList->GetNIdx();
                          Del(Current());
                          Display();

Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** SoftPlayer.c	15 Aug 2005 09:07:30 -0000	1.12
--- SoftPlayer.c	15 Aug 2005 13:13:14 -0000	1.13
***************
*** 386,390 ****
    playList->PrepareForPlayback();
    SoftPlayer = dynamic_cast<cSoftPlayer*> (player);
!   char *nextfile=PlayList->NextFile();
    if (nextfile)
  	  SoftPlayer->OpenFile(nextfile);
--- 386,390 ----
    playList->PrepareForPlayback();
    SoftPlayer = dynamic_cast<cSoftPlayer*> (player);
!   const char *nextfile=PlayList->NextFile();
    if (nextfile)
  	  SoftPlayer->OpenFile(nextfile);
***************
*** 457,461 ****
  	if ( !SoftPlayer->IsRunning()  ) {
  		PLDBG("SoftPlayer not runnig. Looking for next file\n");
!                 char * nextFile;
                  if (!playList || !(nextFile=playList->NextFile())) {
                          PLDBG("No playlist or no next file. Ending.\n");
--- 457,461 ----
  	if ( !SoftPlayer->IsRunning()  ) {
  		PLDBG("SoftPlayer not runnig. Looking for next file\n");
!                 const char * nextFile;
                  if (!playList || !(nextFile=playList->NextFile())) {
                          PLDBG("No playlist or no next file. Ending.\n");
***************
*** 470,474 ****
                  state = privateMenu->ProcessKey(Key);
                  if (state == PLAY_CURR_FILE ) {
!                         char * nextFile;
                          if (!playList || !(nextFile=playList->CurrFile())) {
                                  PLDBG("No playlist or no curr file. Ending.\n");
--- 470,474 ----
                  state = privateMenu->ProcessKey(Key);
                  if (state == PLAY_CURR_FILE ) {
!                         const char * nextFile;
                          if (!playList || !(nextFile=playList->CurrFile())) {
                                  PLDBG("No playlist or no curr file. Ending.\n");
***************
*** 554,558 ****
  			break;
  		case k9: if (playList) {
! 				 char * nextFile=playList->NextFile();
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
--- 554,558 ----
  			break;
  		case k9: if (playList) {
! 				 const char * nextFile=playList->NextFile();
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
***************
*** 565,569 ****
  			 break;
  		case k7: if (playList) {
! 				 char * prevFile=playList->PrevFile();
  				 printf("play PrevFile %p\n",prevFile);
  				 if (prevFile)
--- 565,569 ----
  			 break;
  		case k7: if (playList) {
! 				 const char * prevFile=playList->PrevFile();
  				 printf("play PrevFile %p\n",prevFile);
  				 if (prevFile)
***************
*** 572,576 ****
  			 break;
  		case k6: if (playList) {
! 				 char * nextFile=playList->NextAlbumFile();
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
--- 572,576 ----
  			 break;
  		case k6: if (playList) {
! 				 const char * nextFile=playList->NextAlbumFile();
  				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
***************
*** 583,587 ****
  			 break;
  		case k4: if (playList) {
! 				 char * prevFile=playList->PrevAlbumFile();
  				 if (prevFile)
  					 SoftPlayer->PlayFile(prevFile);
--- 583,587 ----
  			 break;
  		case k4: if (playList) {
! 				 const char * prevFile=playList->PrevAlbumFile();
  				 if (prevFile)
  					 SoftPlayer->PlayFile(prevFile);



From nobody at sheep.berlios.de  Tue Aug 16 10:59:38 2005
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 16 Aug 2005 10:59:38 +0200
Subject: [Softdevice-cvs] softdevice video-xv.c,1.31,1.32 video-xv.h,1.8,1.9
Message-ID: <200508160859.j7G8xc515734@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19801

Modified Files:
	video-xv.c video-xv.h 
Log Message:
- make OSD work without shm ( OSD now works now with X11 forwarding)



Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** video-xv.c	20 Jul 2005 20:24:10 -0000	1.31
--- video-xv.c	16 Aug 2005 08:59:36 -0000	1.32
***************
*** 209,213 ****
      }
    }
!   XSync(dpy,False);
  }
  
--- 209,214 ----
      }
    }
!   if (portAttributes)
!     XSync(dpy,False);
  }
  
***************
*** 599,602 ****
--- 600,604 ----
    initialized = 0;
    toggleInProgress = 0;
+   xv_initialized=false;
    /* -------------------------------------------------------------------------
     * could be specified by argv ! TODO
***************
*** 751,801 ****
     * now let's do some OSD initialisations
     */
!   osd_image = XShmCreateImage (dpy,
!                                XDefaultVisual (dpy, scn_id),
!                                XDefaultDepth (dpy, scn_id),
!                                ZPixmap,NULL,
!                                &osd_shminfo,
!                                width, height);
!   if (osd_image) {
!     dsyslog("[XvVideoOut]: Initialize XShmCreateImage Successful (%p)", osd_image);
!   } else {
!     dsyslog("[XvVideoOut]: Initialize ERROR: XShmCreateImage FAILED !");
!   }
  
!   Bpp=osd_image->bits_per_pixel;
  
!   osd_shminfo.shmid = shmget (IPC_PRIVATE,
!                               osd_image->bytes_per_line*height,
!                               IPC_CREAT | 0777);
!   if (osd_shminfo.shmid == -1) {
!     dsyslog("[XvVideoOut]: Initialize ERROR: shmget FAILED !");
!   } else {
!     dsyslog("[XvVideoOut]: Initialize shmget Successful (%d bytes)",
!             osd_image->bytes_per_line*height);
!   }
  
!   /* compile fix for gcc 3.4.3
!    */
!   osd_shminfo.shmaddr = (char *) shmat(osd_shminfo.shmid, NULL, 0);
!   osd_buffer = (unsigned char *) osd_shminfo.shmaddr;
!   osd_image->data = (char *) osd_buffer;
  
!   if (osd_image->data == (char *) -1L) {
!     dsyslog("[XvVideoOut]: Initialize ERROR: shmat FAILED !");
!   } else {
!     dsyslog("[XvVideoOut]: Initialize shmat Successful");
!   }
  
!   osd_shminfo.readOnly = False;
  
!   rc = XShmAttach(dpy, &osd_shminfo);
  
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
  
    rc = XSync(dpy, False);
  
-   if (osd_shminfo. shmid > 0)
-     shmctl (osd_shminfo. shmid, IPC_RMID, 0);
- 
    if (!xScreensaver)
    {
--- 753,820 ----
     * now let's do some OSD initialisations
     */
!   char *dispName=XDisplayName(NULL);
!   bool isLocal=true;
  
!   dispName=rindex(dispName,':');
!   if ( dispName && atoi(dispName + 1) > 9 )
!           isLocal = false;
  
!   useShm=XShmQueryExtension(dpy) && isLocal;
!   if (useShm) {
!           osd_image = XShmCreateImage (dpy,
!                           XDefaultVisual (dpy, scn_id),
!                           XDefaultDepth (dpy, scn_id),
!                           ZPixmap,NULL,
!                           &osd_shminfo,
!                           width, height);
!           if (osd_image) {
!                   dsyslog("[XvVideoOut]: Initialize XShmCreateImage Successful (%p)", osd_image);
!           } else {
!                   dsyslog("[XvVideoOut]: Initialize ERROR: XShmCreateImage FAILED !");
!           }
  
!           osd_shminfo.shmid = shmget (IPC_PRIVATE,
!                           osd_image->bytes_per_line*height,
!                           IPC_CREAT | 0777);
!           if (osd_shminfo.shmid == -1) {
!                   dsyslog("[XvVideoOut]: Initialize ERROR: shmget FAILED !");
!           } else {
!                   dsyslog("[XvVideoOut]: Initialize shmget Successful (%d bytes)",
!                                   osd_image->bytes_per_line*height);
!           }
  
!           osd_shminfo.shmaddr = (char *) shmat(osd_shminfo.shmid, NULL, 0);
!           osd_buffer = (unsigned char *) osd_shminfo.shmaddr;
!           osd_image->data = (char *) osd_buffer;
  
!           if (osd_image->data == (char *) -1L) {
!                   dsyslog("[XvVideoOut]: Initialize ERROR: shmat FAILED !");
!           } else {
!                   dsyslog("[XvVideoOut]: Initialize shmat Successful");
!           }
  
!           osd_shminfo.readOnly = False;
  
+           rc = XShmAttach(dpy, &osd_shminfo);
+ 
+           if (osd_shminfo. shmid > 0)
+                   shmctl (osd_shminfo. shmid, IPC_RMID, 0);
+   } else {
+           osd_image = XGetImage(dpy, win, 0, 0,
+                           width, height, AllPlanes,
+                           ZPixmap);
+           if (osd_image) {
+                   dsyslog("[XvVideoOut]: Initialize XGetImage Successful (%p)", osd_image);
+           } else {
+                   dsyslog("[XvVideoOut]: Initialize ERROR: XGetImage FAILED !");
+           }
+           osd_buffer = (unsigned char *) osd_image->data;
+   };
+   Bpp=osd_image->bits_per_pixel;
+   
    rc = XClearArea (dpy, win, 0, 0, 0, 0, True);
  
    rc = XSync(dpy, False);
  
    if (!xScreensaver)
    {
***************
*** 820,823 ****
--- 839,844 ----
      setupStore->xvFullscreen=0;
    };
+ 
+   initialized=true;
    return true;
  }
***************
*** 936,949 ****
    } else {
      /* Xv extension probably not present */
!     return false;
    } /* else */
  
    if(!ad_cnt) {
!     dsyslog("[XvVideoOut]: (ERROR) no adaptor found!");
!     return false;
    }
    if(!got_port) {
!     dsyslog("[XvVideoOut]: (ERROR) could not grab any port!");
!     return false;
    }
  
--- 957,974 ----
    } else {
      /* Xv extension probably not present */
!     esyslog("[XvVideoOut]: (ERROR) no Xv extensions found! No video possible!");
!     pthread_mutex_unlock(&xv_mutex);
!     return true;
    } /* else */
  
    if(!ad_cnt) {
!     esyslog("[XvVideoOut]: (ERROR) no adaptor found! No video possible!");
!     pthread_mutex_unlock(&xv_mutex);
!     return true;
    }
    if(!got_port) {
!     esyslog("[XvVideoOut]: (ERROR) could not grab any port! No video possible!");
!     pthread_mutex_unlock(&xv_mutex);
!     return true;
    }
  
***************
*** 1151,1155 ****
              break;
      };
!     
      pthread_mutex_lock(&xv_mutex);
      ++osd_refresh_counter;
--- 1176,1180 ----
              break;
      };
!    
      pthread_mutex_lock(&xv_mutex);
      ++osd_refresh_counter;
***************
*** 1237,1246 ****
                  lyoff + (osd_y * lheight/OSD_FULL_HEIGHT *9/10);
  
!         XShmPutImage (dpy, win, gc, osd_image,
!                       osd_x,
!                       osd_y,
!                       x,y,
!                       osd_w, osd_h,
!                       False);
  
          if (do_sync)
--- 1262,1278 ----
                  lyoff + (osd_y * lheight/OSD_FULL_HEIGHT *9/10);
  
! 	if (useShm) 
! 		XShmPutImage (dpy, win, gc, osd_image,
! 				osd_x,
! 				osd_y,
! 				x,y,
! 				osd_w, osd_h,
! 				False);
! 	else
! 		XPutImage (dpy, win, gc, osd_image,
! 				osd_x,
! 				osd_y,
! 				x,y,
! 				osd_w, osd_h);
  
          if (do_sync)

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** video-xv.h	28 Jun 2005 18:07:33 -0000	1.8
--- video-xv.h	16 Aug 2005 08:59:36 -0000	1.9
***************
*** 123,126 ****
--- 123,127 ----
    XShmSegmentInfo   shminfo, osd_shminfo;
    XvImage           *xv_image;
+   bool              useShm;
    XImage            *osd_image;
    unsigned char     *outbuffer,



From nobody at sheep.berlios.de  Tue Aug 16 11:22:21 2005
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 16 Aug 2005 11:22:21 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.27,1.28
Message-ID: <200508160922.j7G9ML516552@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21660

Modified Files:
	setup-softdevice.c 
Log Message:
- report alpha blend mode setup


Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** setup-softdevice.c	31 Jul 2005 07:58:20 -0000	1.27
--- setup-softdevice.c	16 Aug 2005 09:22:18 -0000	1.28
***************
*** 318,321 ****
--- 318,323 ----
      osdMode = atoi (Value);
      osdMode = clamp (0, osdMode, 1);
+     fprintf(stderr,"[setup-softdevice] setting alpha blend mode to %s\n",
+ 		    osdModeNames[osdMode]);
    } else if (!strcasecmp(Name, "Suspend")) {
      shouldSuspend = atoi (Value);



From nobody at sheep.berlios.de  Tue Aug 16 11:45:20 2005
From: nobody at sheep.berlios.de (wachm)
Date: Tue, 16 Aug 2005 11:45:20 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.27,1.28 video.h,1.18,1.19
Message-ID: <200508160945.j7G9jK517046@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22601

Modified Files:
	video.c video.h 
Log Message:
- improve prefetching for software alpha blending



Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** video.c	22 Jul 2005 21:18:41 -0000	1.27
--- video.c	16 Aug 2005 09:45:17 -0000	1.28
***************
*** 749,763 ****
                  PREFETCH"(%1)\n"
                  PREFETCH"(%2)\n"
  #endif //USE_MMX2
                  : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
  
          // I guess this can be further improved...
          while (count>8 ) {
-          __asm__(
  #ifdef USE_MMX2
!                 PREFETCH" 32(%0)\n"
!                 PREFETCH" 32(%1)\n"
!                 PREFETCH" 32(%2)\n"
  #endif //USE_MMX2
                  "  movq  (%0),%%mm0\n"
                  "  movq  (%1),%%mm1\n"
--- 749,776 ----
                  PREFETCH"(%1)\n"
                  PREFETCH"(%2)\n"
+                 PREFETCH"64(%0)\n"
+                 PREFETCH"64(%1)\n"
+                 PREFETCH"64(%2)\n"
+                 PREFETCH"128(%0)\n"
+                 PREFETCH"128(%1)\n"
+                 PREFETCH"128(%2)\n"
  #endif //USE_MMX2
                  : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
  
          // I guess this can be further improved...
+ 	// Useing prefetch makes it slower on Athlon64,
+ 	// but faster on the Athlon Tbird...
+ 	// Why is prefetching slower on Athlon64????
          while (count>8 ) {
  #ifdef USE_MMX2
!           if (! (count%8 ) )
!                __asm__(
!                   PREFETCH" 192(%0)\n"
!                   PREFETCH" 192(%1)\n"
!                   PREFETCH" 192(%2)\n"
!                   : : "r" (P1), "r" (P2), "r" (alpha) : "memory");
! 
  #endif //USE_MMX2
+          __asm__(
                  "  movq  (%0),%%mm0\n"
                  "  movq  (%1),%%mm1\n"
***************
*** 783,787 ****
                  "  paddw %%mm5, %%mm4 \n"
                  "  packuswb %%mm4, %%mm0 \n"
!                 "  movq %%mm0,(%3)\n"
                  : : "r" (P1), "r" (P2), "r" (alpha),"r"(dest) : "memory");
                  count-=8;
--- 796,800 ----
                  "  paddw %%mm5, %%mm4 \n"
                  "  packuswb %%mm4, %%mm0 \n"
!                 MOVQ " %%mm0,(%3)\n"
                  : : "r" (P1), "r" (P2), "r" (alpha),"r"(dest) : "memory");
                  count-=8;

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video.h	22 Jul 2005 21:18:41 -0000	1.18
--- video.h	16 Aug 2005 09:45:17 -0000	1.19
***************
*** 36,47 ****
--- 36,50 ----
  //#warning Using 3Dnow! extensions
  #define PREFETCH "prefetch "
+ #define MOVQ     "movntq "
  #define EMMS     __asm__ (" femms \n": :  )
  #elif defined ( USE_MMX2 )
  //#warning Using MMX2 extensions
  #define PREFETCH "prefetchnta "
+ #define MOVQ     "movntq "
  #define EMMS     __asm__ (" emms \n": :  )
  #else
  //#warning Using MMX extensions
  #define PREFETCH
+ #define MOVQ     "movq "
  #define EMMS     __asm__ (" emms \n": :  )
  #endif



From nobody at sheep.berlios.de  Wed Aug 17 23:27:26 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 17 Aug 2005 23:27:26 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.101,1.102 audio.c,1.18,1.19
Message-ID: <200508172127.j7HLRQ613429@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28882

Modified Files:
	CHANGELOG audio.c 
Log Message:
changed retrieval of audio delay

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.101
retrieving revision 1.102
diff -C2 -d -r1.101 -r1.102
*** CHANGELOG	8 Aug 2005 18:43:41 -0000	1.101
--- CHANGELOG	17 Aug 2005 21:27:24 -0000	1.102
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-08-20:
+     - audio-out: changed retrieval of audio delay with newer alsa versions on
+                  "default" device. should fix bug #2971 too.
  2005-08-08:
      - dfb-out: enclose all dfb calls by try{}catch{} by Marko M?kel?

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** audio.c	7 Jun 2005 19:13:20 -0000	1.18
--- audio.c	17 Aug 2005 21:27:24 -0000	1.19
***************
*** 202,218 ****
  
  int cAlsaAudioOut::GetDelay(void) {
! 	snd_pcm_status_t *status;
! 	snd_pcm_status_alloca(&status);
! 	int res;
! 	handleMutex.Lock();
! 	if ((res = snd_pcm_status(handle, status))<0) {
!     esyslog("[softdevice-audio]: GetDelay status error: %s FATAL exiting",
!             snd_strerror(res));
! 		exit(EXIT_FAILURE);
! 	}
!         res=snd_pcm_status_get_delay(status) *10000 /
! 	  currContext.samplerate;
! 	handleMutex.Unlock();
! 	return res;
  }
  
--- 202,215 ----
  
  int cAlsaAudioOut::GetDelay(void) {
!     int               res = 0;
!     snd_pcm_sframes_t r;
! 
!   handleMutex.Lock();
!   if (!snd_pcm_delay(handle, &r)) {
!     // successfully got delay
!     res = (long) r * 10000 / currContext.samplerate;
!   }
!   handleMutex.Unlock();
!   return res;
  }
  



From nobody at sheep.berlios.de  Fri Aug 19 11:02:10 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 19 Aug 2005 11:02:10 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.28,1.29 CHANGELOG,1.102,1.103
Message-ID: <200508190902.j7J92A611282@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6895

Modified Files:
	video.c CHANGELOG 
Log Message:
- fix possible segfault in ToYUV()



Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** video.c	16 Aug 2005 09:45:17 -0000	1.28
--- video.c	19 Aug 2005 09:02:05 -0000	1.29
***************
*** 522,525 ****
--- 522,530 ----
  //      printf("minPX %d, maxPX %d, minPY %d maxPY %d, weightX %d,weightYf %d \n",
  //       minPX,maxPX,minPY,maxPY,weightX,weightYf);
+       if ( i > Bitmap->Width() )
+               continue;
+       if ( j > Bitmap->Height() )
+               continue;
+                       
        adr = Bitmap->Data(i,j);
        *((uint32_t *) &pixel) = (uint32_t) Bitmap->Color(*adr);
***************
*** 695,699 ****
  
    y1=SCALEY(y1); 
!   y2=SCALEY(y2);
    x1=SCALEX(x1);
    x2=SCALEX(x2);
--- 700,704 ----
  
    y1=SCALEY(y1); 
!   y2=SCALEY(y2); 
    x1=SCALEX(x1);
    x2=SCALEX(x2);
***************
*** 703,707 ****
    // we need a even starting point
    y1&=~1;
!   y2+=y2!=Bitmap->Height()?1:0;//FIXME funzt nicht mehr
    // two rows at a time...
    for (int y = y1; y < y2; y+=2) 
--- 708,713 ----
    // we need a even starting point
    y1&=~1;
!   y2= (y2+2) & ~1;
!   y2= ( y2 > Bitmap->Height()-1 ? Bitmap->Height()-1 : y2);
    // two rows at a time...
    for (int y = y1; y < y2; y+=2) 

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.102
retrieving revision 1.103
diff -C2 -d -r1.102 -r1.103
*** CHANGELOG	17 Aug 2005 21:27:24 -0000	1.102
--- CHANGELOG	19 Aug 2005 09:02:05 -0000	1.103
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-08-19:
+     - fix possible segfault in ToYUV()
  2005-08-20:
      - audio-out: changed retrieval of audio delay with newer alsa versions on



From nobody at sheep.berlios.de  Fri Aug 19 11:09:25 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 19 Aug 2005 11:09:25 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.51,1.52 CHANGELOG,1.103,1.104
Message-ID: <200508190909.j7J99P611517@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8564

Modified Files:
	mpeg2decoder.c CHANGELOG 
Log Message:
- change #ifdefs to contain closing brackets (stops my editor from complaining...)
	    


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** mpeg2decoder.c	8 Aug 2005 10:25:03 -0000	1.51
--- mpeg2decoder.c	19 Aug 2005 09:09:22 -0000	1.52
***************
*** 1017,1024 ****
      
  #if LIBAVFORMAT_BUILD >4625
! static offset_t seek_RingBuffer(void *opaque, offset_t offset, int whence) {
  #else
! static int seek_RingBuffer(void *opaque, offset_t offset, int whence) {
  #endif
       cMpeg2Decoder *Dec=(cMpeg2Decoder *)(opaque);
       if (Dec) 
--- 1017,1025 ----
      
  #if LIBAVFORMAT_BUILD >4625
! static offset_t seek_RingBuffer(void *opaque, offset_t offset, int whence) 
  #else
! static int seek_RingBuffer(void *opaque, offset_t offset, int whence) 
  #endif
+ {
       cMpeg2Decoder *Dec=(cMpeg2Decoder *)(opaque);
       if (Dec) 
***************
*** 1230,1246 ****
  #if LIBAVFORMAT_BUILD > 4628
      aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
  #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
- #endif
                   audioOut, audioMode );
    } else
-   if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
  #if LIBAVFORMAT_BUILD > 4628
        ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO &&
  #else
        ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO &&
  #endif
!       VideoIdx!=pkt.stream_index) {
! 
      CMDDEB("new Video stream index.. old %d new %d\n",
        VideoIdx,pkt.stream_index);
--- 1231,1250 ----
  #if LIBAVFORMAT_BUILD > 4628
      aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
+                  audioOut, audioMode );
  #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
                   audioOut, audioMode );
+ #endif
    } else
  #if LIBAVFORMAT_BUILD > 4628
+   if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
        ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO &&
+       VideoIdx!=pkt.stream_index) 
  #else
+   if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
        ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO &&
+       VideoIdx!=pkt.stream_index) 
  #endif
!   {
      CMDDEB("new Video stream index.. old %d new %d\n",
        VideoIdx,pkt.stream_index);
***************
*** 1253,1260 ****
  #if LIBAVFORMAT_BUILD > 4628
      vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
  #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
- #endif
                     videoOut, &clock, Speed );
    };
    
--- 1257,1265 ----
  #if LIBAVFORMAT_BUILD > 4628
      vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
+                    videoOut, &clock, Speed );
  #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
                     videoOut, &clock, Speed );
+ #endif
    };
    

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.103
retrieving revision 1.104
diff -C2 -d -r1.103 -r1.104
*** CHANGELOG	19 Aug 2005 09:02:05 -0000	1.103
--- CHANGELOG	19 Aug 2005 09:09:22 -0000	1.104
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-08-19:
+     - change #ifdefs to contain closing brackets 
+         (stops my editor from complaining...)
      - fix possible segfault in ToYUV()
  2005-08-20:



From nobody at sheep.berlios.de  Thu Aug 25 20:39:48 2005
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 25 Aug 2005 20:39:48 +0200
Subject: [Softdevice-cvs] softdevice utils.c,1.7,1.8
Message-ID: <200508251839.j7PIdm622350@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27643

Modified Files:
	utils.c 
Log Message:
- comment part of fast_memcpy which continously makes problems with various
  compilers



Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** utils.c	16 Jul 2005 22:33:08 -0000	1.7
--- utils.c	25 Aug 2005 18:39:45 -0000	1.8
***************
*** 493,497 ****
  		to=((unsigned char *)to)+64;
  	}
! 
  //	printf(" %d %d\n", (int)from&1023, (int)to&1023);
  	// Pure Assembly cuz gcc is a bit unpredictable ;)
--- 493,497 ----
  		to=((unsigned char *)to)+64;
  	}
! #if 0
  //	printf(" %d %d\n", (int)from&1023, (int)to&1023);
  	// Pure Assembly cuz gcc is a bit unpredictable ;)
***************
*** 559,563 ****
  #endif
  		);
! 
  	for(; i>0; i--)
  	{
--- 559,563 ----
  #endif
  		);
! #endif
  	for(; i>0; i--)
  	{



From nobody at sheep.berlios.de  Sun Sep  4 07:49:30 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 4 Sep 2005 07:49:30 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.104,1.105 softdevice.c,1.39,1.40 video-dfb.c,1.38,1.39 video-dfb.h,1.9,1.10
Message-ID: <200509040549.j845nU130621@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20321

Modified Files:
	CHANGELOG softdevice.c video-dfb.c video-dfb.h 
Log Message:
softdevice-0.1.3
- dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.104
retrieving revision 1.105
diff -C2 -d -r1.104 -r1.105
*** CHANGELOG	19 Aug 2005 09:09:22 -0000	1.104
--- CHANGELOG	4 Sep 2005 05:49:17 -0000	1.105
***************
*** 1,8 ****
  Changelog
  2005-08-19:
      - change #ifdefs to contain closing brackets 
          (stops my editor from complaining...)
      - fix possible segfault in ToYUV()
! 2005-08-20:
      - audio-out: changed retrieval of audio delay with newer alsa versions on
                   "default" device. should fix bug #2971 too.
--- 1,10 ----
  Changelog
+ 2005-09-04: softdevice-0.1.3
+     - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)
  2005-08-19:
      - change #ifdefs to contain closing brackets 
          (stops my editor from complaining...)
      - fix possible segfault in ToYUV()
! 2005-08-17:
      - audio-out: changed retrieval of audio delay with newer alsa versions on
                   "default" device. should fix bug #2971 too.
***************
*** 99,103 ****
        (thanks to Marko M?kel?)
      - buffering is now complety signal triggered
!     - made buffersizes variable 
  2005-05-22: softdevice-0.1.2
  2005-05-20:
--- 101,105 ----
        (thanks to Marko M?kel?)
      - buffering is now complety signal triggered
!     - made buffersizes variable
  2005-05-22: softdevice-0.1.2
  2005-05-20:

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** softdevice.c	8 Aug 2005 18:43:41 -0000	1.39
--- softdevice.c	4 Sep 2005 05:49:18 -0000	1.40
***************
*** 69,73 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.1.2";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 69,73 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.1.3";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** video-dfb.c	10 Aug 2005 17:31:18 -0000	1.38
--- video-dfb.c	4 Sep 2005 05:49:18 -0000	1.39
***************
*** 87,93 ****
  /* ---------------------------------------------------------------------------
   */
! void cDFBRemote::PutKey(DFBInputDeviceKeySymbol key)
  {
!   Put ((int) key);
  }
  
--- 87,93 ----
  /* ---------------------------------------------------------------------------
   */
! void cDFBRemote::PutKey(DFBInputDeviceKeySymbol key, bool repeat)
  {
!   Put ((int) key, repeat, false);
  }
  
***************
*** 566,569 ****
--- 566,572 ----
      {
        case DIET_KEYPRESS:
+ #ifdef DFB_SUPPORTS_REPEAT
+       case DIET_KEYREPEAT:
+ #endif /* DFB_SUPPORTS_REPEAT */
          if (dfbRemote)
          {
***************
*** 574,581 ****
                break;
              default:
!               if (!setupStore->CatchRemoteKey(dfbRemote->Name(),
                                                event.key_symbol))
                {
!                 dfbRemote->PutKey(event.key_symbol);
                }
                break;
--- 577,586 ----
                break;
              default:
!               if (event.type != DIET_KEYPRESS ||
!                   !setupStore->CatchRemoteKey(dfbRemote->Name(),
                                                event.key_symbol))
                {
!                 dfbRemote->PutKey(event.key_symbol,
!                                   event.type != DIET_KEYPRESS);
                }
                break;

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-dfb.h	30 Jun 2005 21:20:55 -0000	1.9
--- video-dfb.h	4 Sep 2005 05:49:18 -0000	1.10
***************
*** 82,86 ****
                    ~cDFBRemote();
      void          DFBRemoteStart (void);
!     void          PutKey (DFBInputDeviceKeySymbol key);
  };
  
--- 82,86 ----
                    ~cDFBRemote();
      void          DFBRemoteStart (void);
!     void          PutKey (DFBInputDeviceKeySymbol key, bool repeat);
  };
  



From nobody at sheep.berlios.de  Tue Sep  6 23:55:30 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 6 Sep 2005 23:55:30 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.105,1.106 audio.c,1.19,1.20 mpeg2decoder.c,1.52,1.53
Message-ID: <200509062155.j86LtU120676@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26853

Modified Files:
	CHANGELOG audio.c mpeg2decoder.c 
Log Message:
video-out (all methods): fix for missing actions upon aspect ratio change
audio-out: fix potentially div by zero.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.105
retrieving revision 1.106
diff -C2 -d -r1.105 -r1.106
*** CHANGELOG	4 Sep 2005 05:49:17 -0000	1.105
--- CHANGELOG	6 Sep 2005 21:55:27 -0000	1.106
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-09-06:
+     - video-out (all methods): fix for missing actions upon aspect ratio change
+     - audio-out: fix potentially div by zero.
  2005-09-04: softdevice-0.1.3
      - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** audio.c	17 Aug 2005 21:27:24 -0000	1.19
--- audio.c	6 Sep 2005 21:55:27 -0000	1.20
***************
*** 206,210 ****
  
    handleMutex.Lock();
!   if (!snd_pcm_delay(handle, &r)) {
      // successfully got delay
      res = (long) r * 10000 / currContext.samplerate;
--- 206,211 ----
  
    handleMutex.Lock();
!   if (!snd_pcm_delay(handle, &r) &&
!       currContext.samplerate) {
      // successfully got delay
      res = (long) r * 10000 / currContext.samplerate;

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** mpeg2decoder.c	19 Aug 2005 09:09:22 -0000	1.52
--- mpeg2decoder.c	6 Sep 2005 21:55:27 -0000	1.53
***************
*** 600,608 ****
       };
    
-   // prepare picture for display
-   videoOut->CheckAspectDimensions(picture,context);
-   videoOut->SetOldPicture(picture,context->width,context->height);
- 
    if (!hurry_up || frame % 2 ) {
      // sleep ....
      delay-=syncTimer->GetRelTime();
--- 600,608 ----
       };
    
    if (!hurry_up || frame % 2 ) {
+     // prepare picture for display
+     videoOut->CheckAspectDimensions(picture,context);
+     videoOut->SetOldPicture(picture,context->width,context->height);
+ 
      // sleep ....
      delay-=syncTimer->GetRelTime();



From nobody at sheep.berlios.de  Sat Sep 10 18:14:38 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Sep 2005 18:14:38 +0200
Subject: [Softdevice-cvs] softdevice i18n.c,1.7,1.8
Message-ID: <200509101614.j8AGEc112656@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10785

Modified Files:
	i18n.c 
Log Message:
description fix for crop left/right by Rolf Ahrenberg

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** i18n.c	29 Jul 2005 20:45:40 -0000	1.7
--- i18n.c	10 Sep 2005 16:14:36 -0000	1.8
***************
*** 424,428 ****
  #endif
    },
!   { "Crop lines from left", //  1
      "",             //  2 TODO
      "",             //  3 TODO
--- 424,428 ----
  #endif
    },
!   { "Crop columns from left", //  1
      "",             //  2 TODO
      "",             //  3 TODO
***************
*** 447,451 ****
  #endif
    },
!   { "Crop lines from right", //  1
      "",             //  2 TODO
      "",             //  3 TODO
--- 447,451 ----
  #endif
    },
!   { "Crop columns from right", //  1
      "",             //  2 TODO
      "",             //  3 TODO



From nobody at sheep.berlios.de  Sat Sep 10 21:43:24 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Sep 2005 21:43:24 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.h,1.31,1.32 softdevice.c,1.40,1.41 video.h,1.19,1.20 xscreensaver.h,1.2,1.3
Message-ID: <200509101943.j8AJhO119256@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10594

Modified Files:
	mpeg2decoder.h softdevice.c video.h xscreensaver.h 
Log Message:
configure preparation

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** mpeg2decoder.h	8 Aug 2005 10:25:03 -0000	1.31
--- mpeg2decoder.h	10 Sep 2005 19:43:21 -0000	1.32
***************
*** 8,12 ****
--- 8,18 ----
  #ifndef MPEG2DECODER_H
  #define MPEG2DECODER_H
+ 
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif
+ 
  #include <avcodec.h>
+ 
  #ifdef PP_LIBAVCODEC
    #include <postproc/postprocess.h>

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** softdevice.c	4 Sep 2005 05:49:18 -0000	1.40
--- softdevice.c	10 Sep 2005 19:43:21 -0000	1.41
***************
*** 29,32 ****
--- 29,36 ----
  #undef  VOUT_DEFAULT
  
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif
+ 
  #ifdef VIDIX_SUPPORT
  #include "video-vidix.h"

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** video.h	16 Aug 2005 09:45:17 -0000	1.19
--- video.h	10 Sep 2005 19:43:21 -0000	1.20
***************
*** 11,14 ****
--- 11,19 ----
  
  #include <vdr/plugin.h>
+ 
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif
+ 
  #include "setup-softdevice.h"
  #include "sync-timer.h"

Index: xscreensaver.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/xscreensaver.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** xscreensaver.h	25 Oct 2004 02:36:18 -0000	1.2
--- xscreensaver.h	10 Sep 2005 19:43:21 -0000	1.3
***************
*** 13,16 ****
--- 13,20 ----
  #include <X11/Xatom.h>
  
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif
+ 
  #ifdef LIBXDPMS_SUPPORT
  



From nobody at sheep.berlios.de  Sat Sep 10 21:52:24 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Sep 2005 21:52:24 +0200
Subject: [Softdevice-cvs] softdevice Makefile,1.14,1.15
Message-ID: <200509101952.j8AJqO119536@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11068

Modified Files:
	Makefile 
Log Message:
changes for configure

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** Makefile	15 Jul 2005 20:42:16 -0000	1.14
--- Makefile	10 Sep 2005 19:52:22 -0000	1.15
***************
*** 16,19 ****
--- 16,42 ----
  ### The C++ compiler and options:
  
+ # -----------------------------------------------------------------------------
+ #
+ #DVBDIR 	   = ../../../../dvb-kernel
+ #DVBDIR 	   = ../../../../DVB
+ 
+ DVBDIR 	   = ../../../../DVB
+ 
+ VDRDIR     = ../../..
+ LIBDIR     = ../../lib
+ TMPDIR     = /tmp
+ 
+ -include config.mak
+ 
+ ifndef WITH_CONFIGURE
+ 
+ # -----------------------------------------------------------------------------
+ # framebuffer device name
+ #
+ #FBDEV = /dev/fb/0
+ #FBDEV = /dev/fb0
+ 
+ FBDEV = /dev/fb0
+ 
  # uncomment ONE of these lines if you want to enable the support
  
***************
*** 59,70 ****
  
  # -----------------------------------------------------------------------------
- # framebuffer device name
- #
- #FBDEV = /dev/fb/0
- #FBDEV = /dev/fb0
- 
- FBDEV = /dev/fb0
- 
- # -----------------------------------------------------------------------------
  # VIDIX specific definitions
  # installation directory
--- 82,85 ----
***************
*** 78,91 ****
  # Set up these paths to your enviroment!
  #
! #LIBAVCODEC=/opt/ffmpeg
! #LIBAVCODEC = ../../../../ffmpeg/libavcodec
  #
  # If you installed ffmpeg's lib (make installlib)
! LIBAVCODEC=/usr/local/include/ffmpeg/
! #LIBAVCODEC= /home/extra/src/video/ffmpeg-0.4.8/libavcodec
  #
  #
  # DON'T touch this:
! FFMPEGLIBS = -lavcodec -lavformat
  #
  # -----------------------------------------------------------------------------
--- 93,106 ----
  # Set up these paths to your enviroment!
  #
! #FFMPEGCFLAGS=-I/opt/ffmpeg
! #FFMPEGCFLAGS=-I../../../../ffmpeg/libavcodec
  #
  # If you installed ffmpeg's lib (make installlib)
! FFMPEGCFLAGS=-I/usr/local/include/ffmpeg/
! #FFMPEGCFLAGS=-I/home/extra/src/video/ffmpeg-0.4.8/libavcodec
  #
  #
  # DON'T touch this:
! FFMPEGLIBS = -lavcodec -lavformat -lz
  #
  # -----------------------------------------------------------------------------
***************
*** 100,114 ****
  #FFMPEGLIBS += -lvorbisenc -lvorbis
  
- # -----------------------------------------------------------------------------
- #
- #DVBDIR 	   = ../../../../dvb-kernel
- #DVBDIR 	   = ../../../../DVB
- 
- DVBDIR 	   = ../../../../DVB
- 
- VDRDIR     = ../../..
- LIBDIR     = ../../lib
- TMPDIR     = /tmp
- 
  #tuning options
  
--- 115,118 ----
***************
*** 119,127 ****
  DEFINES	   += -DUSE_MMX2
  
  
  ### normally you shoudn't have to touch something below this line
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -Woverloaded-virtual -L$(LIBAVCODEC)
  
  ### The directory environment:
--- 123,181 ----
  DEFINES	   += -DUSE_MMX2
  
+ # #############################################################################
+ # moved some defines to this section, as they are generated by
+ # configure too.
+ #
+ 
+ ifdef USE_SUBPLUGINS
+   DEFINES += -DUSE_SUBPLUGINS
+ endif
+ 
+ ifdef DFB_SUPPORT
+   DFB_LIBS  = -L/usr/local/lib -ldfb++
+   DFB_CFLAGS = -I/usr/local/include/dfb++ -I/usr/local/include/directfb
+   DEFINES  += -DDFB_SUPPORT
+ endif
+ 
+ ifdef XV_SUPPORT
+   XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
+   ifdef LIBXDPMS_SUPPORT
+     DEFINES += -DLIBXDPMS_SUPPORT
+   endif
+   DEFINES += -DXV_SUPPORT
+ endif
+ 
+ ifdef FB_SUPPORT
+   DEFINES += -DFB_SUPPORT -DFBDEV=\"$(FBDEV)\"
+ endif
+ 
+ ifdef PP_LIBAVCODEC
+   DEFINES     += -DPP_LIBAVCODEC
+   FFMPEGLIBS  += -lpostproc
+ endif
+ 
+ ifdef SUSPEND_BY_KEY
+   DEFINES     += -DSUSPEND_BY_KEY
+ endif
+ 
+ ifdef VIDIX_SUPPORT
+   VIDIX_LIBS  = -L$(VIDIX_DIR)/lib -lvidix
+   VIDIX_CFLAGS = -I$(VIDIX_DIR)/include/vidix
+   DEFINES     += -DVIDIX_SUPPORT -DVIDIX_DIR=\"$(VIDIX_DIR)/lib/vidix/\" -DFBDEV=\"$(FBDEV)\"
+ endif
+ 
+ # #############################################################################
+ # end of section without configure
+ #
+ else
+ 
+   DEFINES += -DHAVE_CONFIG
+ 
+ endif  # WITH_CONFIGURE
  
  ### normally you shoudn't have to touch something below this line
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -Woverloaded-virtual
  
  ### The directory environment:
***************
*** 143,147 ****
  ### Includes and Defines (add further entries here):
  
! INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include -I$(LIBAVCODEC)
  
  DEFINES += -DPLUGIN_NAME_I18N='"$(PLUGIN)"' -D_GNU_SOURCE
--- 197,201 ----
  ### Includes and Defines (add further entries here):
  
! INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include $(FFMPEGCFLAGS)
  
  DEFINES += -DPLUGIN_NAME_I18N='"$(PLUGIN)"' -D_GNU_SOURCE
***************
*** 150,159 ****
  ### The object files (add further files here):
  
- ifdef USE_SUBPLUGINS
-   DEFINES += -DUSE_SUBPLUGINS
- endif
- 
  TARGETS = libvdr-$(PLUGIN).so
! LIBS = $(FFMPEGLIBS) -lasound -lz
  OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o sync-timer.o
  ALL_OBJS = $(OBJS)
--- 204,209 ----
  ### The object files (add further files here):
  
  TARGETS = libvdr-$(PLUGIN).so
! LIBS = $(FFMPEGLIBS) -lasound
  OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o sync-timer.o
  ALL_OBJS = $(OBJS)
***************
*** 161,165 ****
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
-     DFB_LIBS  = -L/usr/local/lib -ldfb++
      DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
--- 211,214 ----
***************
*** 167,174 ****
    else
      OBJS     += video-dfb.o
!     LIBS     += -L/usr/local/lib -ldfb++
    endif
!   DEFINES  += -DDFB_SUPPORT
!   INCLUDES += -I/usr/local/include/dfb++ -I/usr/local/include/directfb
  endif
  
--- 216,222 ----
    else
      OBJS     += video-dfb.o
!     LIBS     += $(DFB_LIBS)
    endif
!   INCLUDES += $(DFB_CFLAGS)
  endif
  
***************
*** 182,191 ****
      OBJS 	+= video-fb.o
    endif
-   DEFINES += -DFB_SUPPORT -DFBDEV=\"$(FBDEV)\"
  endif
  
  ifdef XV_SUPPORT
    ifdef USE_SUBPLUGINS
-     XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
      XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
--- 230,237 ----
***************
*** 193,202 ****
    else
      OBJS 	+= video-xv.o xscreensaver.o
!     LIBS 	+= -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
!   endif
!   ifdef LIBXDPMS_SUPPORT
!     DEFINES += -DLIBXDPMS_SUPPORT
    endif
-   DEFINES += -DXV_SUPPORT
  endif
  
--- 239,244 ----
    else
      OBJS 	+= video-xv.o xscreensaver.o
!     LIBS 	+= $(XV_LIBS)
    endif
  endif
  
***************
*** 204,208 ****
    ifdef USE_SUBPLUGINS
      VIDIX_OBJS  = utils.o video.o video-vidix.o
-     VIDIX_LIBS  = -lvidix
      ALL_OBJS    += $(VIDIX_OBJS)
      TARGETS     += libvdr-$(PLUGIN)-vidix.so
--- 246,249 ----
***************
*** 211,226 ****
      LIBS        += -lvidix
    endif
!   CXXFLAGS    += -L$(VIDIX_DIR)/lib
!   INCLUDES    += -I$(VIDIX_DIR)/include/vidix
!   DEFINES     += -DVIDIX_SUPPORT -DVIDIX_DIR=\"$(VIDIX_DIR)/lib/vidix/\" -DFBDEV=\"$(FBDEV)\"
! endif
! 
! ifdef PP_LIBAVCODEC
!   DEFINES     += -DPP_LIBAVCODEC
!   FFMPEGLIBS  += -lpostproc
! endif
! 
! ifdef SUSPEND_BY_KEY
!   DEFINES     += -DSUSPEND_BY_KEY
  endif
  
--- 252,257 ----
      LIBS        += -lvidix
    endif
!   LIBS        += $(VIDIX_LIBS)
!   INCLUDES    += $(VIDIX_CFLAGS)
  endif
  
***************
*** 275,278 ****
--- 306,312 ----
  	@-rm -rf $(TMPDIR)/$(ARCHIVE)
  	@echo Distribution package created as $(PACKAGE).tgz
+ 
+ dist-clean: clean
+ 	@-rm -f config.h config.mak
  
  clean:



From nobody at sheep.berlios.de  Sat Sep 10 21:54:17 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Sep 2005 21:54:17 +0200
Subject: [Softdevice-cvs] softdevice configure,NONE,1.1
Message-ID: <200509101954.j8AJsH119564@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11206

Added Files:
	configure 
Log Message:
1st try of configure

--- NEW FILE: configure ---
#!/bin/bash
#
# simple configure script for softdevice
#
# $Id: configure,v 1.1 2005/09/10 19:54:15 lucke Exp $
#

TMPDIR1="/tmp"
TMPC="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.c"
TMPE="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}"
TMPH="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.h"
TMPM="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.mak"

PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig/

dfb="yes"
libpostproc="no"
cc="g++"
xv="yes"
vidix="yes"
vidix_path="/usr/local"
subplugins="yes"
with_fb="yes"
fb_dev_name="/dev/fb0"
with_subplugins="yes"
with_mmx="yes"
with_mmx2="yes"

#########################################################
# start ffmpeg test
#
ffmpeg_l1="libavcodec libavformat"

# pkg-config --libs libavutil 2>/dev/null && ffmpeg_l1="$ffmpeg_l1 libavutil"
pkg-config --libs libpostproc >/dev/null 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }

ffmpeg_libs=`pkg-config --libs $ffmpeg_l1`
ffmpeg_cflags=`pkg-config --cflags $ffmpeg_l1`

#########################################################
# start of DirectFB specific tests
#
if test "${dfb}" = "yes" ; then

dfb_cflags=`pkg-config --cflags directfb dfb++` || dfb="no"

if test "${dfb}" = "yes" ; then

dfb_libs=`pkg-config --libs directfb dfb++`
dfb_opts="${dfb_cflags} ${dfb_libs}"
dfb_device_desc="yes"
dfb_sourcelocation="yes"
dfb_dscaps_double="yes"

cat > ${TMPC} << EOF
#include <directfb.h>
int main(void) {
    DFBGraphicsDeviceDescription caps;
  return 0;
}
EOF
$cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_device_desc="no"

cat > ${TMPC} << EOF
#include <stdio.h>
#include <dfb++.h>
#include <directfb.h>
int main(void) {
    IDirectFBDisplayLayer *videoLayer;
  videoLayer->SetSourceRectangle (0, 0, 128, 128);
  return 0;
}
EOF
$cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_sourcelocation="no"

cat > ${TMPC} << EOF
#include <stdio.h>
#include <dfb++.h>
#include <directfb.h>
int main(void) {

    DFBDisplayLayerConfig       dlc;

  dlc.flags = (DFBDisplayLayerConfigFlags)
                  ((int) dlc.flags | DLCONF_SURFACE_CAPS);
  dlc.surface_caps  = DSCAPS_DOUBLE;

  return 0;
}
EOF
$cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dscaps_double="no"

  fi
fi
# end of DirectFB specific tests

## echo ${dfb_opts}
## echo dfb_device_desc = ${dfb_device_desc}

###########
broken_gcc_cpp="no"
cat > ${TMPC} << EOF

#include <stdio.h>
#define BLOCK_SIZE 4096

#ifdef __x86_64__
# define  REG_a "rax"
#else
# define  REG_a "eax"
#endif

#define CONFUSION_FACTOR 0

int main(void) {
    void    *to, *from;
    size_t  i;

  asm volatile(
    "xor %%"REG_a", %%"REG_a"	\n\t"
    "xor %%"REG_a", %%"REG_a"	\n\t"
    "add %3, %0		\n\t"
    "add %3, %1		\n\t"
    "sub %4, %2		\n\t"
    "cmp %4, %2		\n\t"
      : "+r" (from),
        "+r" (to),
        "+r" (i)
      : "r" ((long)BLOCK_SIZE),
        "i" (BLOCK_SIZE/64),
        "i" ((long)CONFUSION_FACTOR)
      : "%"REG_a,
        "%ebx"
    );
  return 0;
}
EOF
$cc $CFLAGS -o $TMPE $TMPC > /dev/null 2>&1 || broken_gcc_cpp="yes"
###########

echo "Creating temporay config.h and config.mak"
echo "/* Generated by configure - do not modify */" > $TMPH
echo "# Generated by configure - do not modify" > $TMPM
echo "WITH_CONFIGURE = 1" >> $TMPM


###############################################################################
# generating some global defines
#
if test "${with_subplugins}" = "yes" ; then
  echo "USE_SUBPLUGINS = 1" >> $TMPM
  echo "#define USE_SUBPLUGINS 1" >> $TMPH
fi

if test "${with_mmx}" = "yes" ; then
  echo "#define USE_MMX 1" >> $TMPH
fi

if test "${with_mmx2}" = "yes" ; then
  echo "#define USE_MMX2 1" >> $TMPH
fi



###############################################################################
# generating DirectFB specific defines
#
if test "${dfb}" = "yes" ; then
  echo "DFB_SUPPORT=1" >> $TMPM
  echo "#define DFB_SUPPORT                       1" >> $TMPH
  echo "DFB_LIBS = ${dfb_libs}" >> $TMPM
  echo "DFB_CFLAGS = ${dfb_cflags}" >> $TMPM

  if test "${dfb_sourcelocation}" = "yes" ; then
    echo "#define HAVE_SetSourceLocation          1" >> $TMPH
  else
    echo "#define HAVE_SetSourceLocation          0" >> $TMPH
  fi

  if test "${dfb_device_desc}" = "yes" ; then
    echo "#define HAVE_GraphicsDeviceDescription  1" >> $TMPH
  else
    echo "#define HAVE_GraphicsDeviceDescription  0" >> $TMPH
  fi

  if test "${dfb_dscaps_double}" = "yes" ; then
    echo "#define HAVE_DSCAPS_DOUBLE              1" >> $TMPH
  else
    echo "#define HAVE_DSCAPS_DOUBLE              0" >> $TMPH
  fi
fi

###############################################################################
# generating vidix specific defines
#
if test "${vidix}" = "yes" ; then
  echo "VIDIX_SUPPORT = 1" >> $TMPM
  echo "VIDIX_DIR     = ${vidix_path}" >> $TMPM
  echo "VIDIX_LIBS    = -L${vidix_path}/lib -lvidix" >> $TMPM
  echo "VIDIX_CFLAGS  = -I${vidix_path}/include/vidix" >> $TMPM
  echo "#define VIDIX_SUPPORT 1" >> $TMPH
  echo "#define VIDIX_DIR     \"${vidix_path}/lib/vidix\"" >> $TMPH
  echo "#define FBDEV         \"${fb_dev_name}\"" >> $TMPH
fi

###############################################################################
# generating X11 specific defines
#
if test "${xv}" = "yes" ; then
  echo "XV_SUPPORT       = 1" >> $TMPM
  echo "LIBXDPMS_SUPPORT = 1" >> $TMPM
  echo "XV_LIBS          = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv"  >> $TMPM
  echo "#define XV_SUPPORT       1" >> $TMPH
  echo "#define LIBXDPMS_SUPPORT 1" >> $TMPH
fi

###############################################################################
# generating framebuffer specific defines
#
if test "${with_fb}" = "yes" ; then
  echo "FB_SUPPORT = 1" >> $TMPM
  echo "#define FB_SUPPORT  1" >> $TMPH
  echo "#ifndef FBDEV" >> $TMPH
  echo "# define FBDEV      \"${fb_dev_name}\"" >> $TMPH
  echo "#endif" >> $TMPH
fi

###############################################################################
# generating utils.c specific specific defines
#
if test "${broken_gcc_cpp}" = "yes" ; then
  echo "#define HAVE_BROKEN_GCC_CPP  1" >> $TMPH
else
  echo "#define HAVE_BROKEN_GCC_CPP  0" >> $TMPH
fi

###############################################################################
# generating ffmpeg specific defines
#
if test "${libpostproc}" = "yes" ; then
  echo "#define PP_LIBAVCODEC" >> $TMPH
else
  echo "#undef PP_LIBAVCODEC" >> $TMPH
fi

echo "FFMPEGLIBS = ${ffmpeg_libs}" >> $TMPM
echo "FFMPEGCFLAGS = ${ffmpeg_cflags}" >> $TMPM

###############################################################################
# checking for differences to previous results
#
diff $TMPH config.h >/dev/null 2>&1
if test $? -ne 0 ; then
  mv -f $TMPH config.h
  echo "updated config.h"
else
  echo "config.h is unchanged"
fi

diff $TMPM config.mak >/dev/null 2>&1
if test $? -ne 0 ; then
  mv -f $TMPM config.mak
  echo "updated config.mak"
else
  echo "config.mak is unchanged"
fi

rm -f $TMPC $TMPE $TMPH $TMPM



From nobody at sheep.berlios.de  Sun Sep 11 10:22:42 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 11 Sep 2005 10:22:42 +0200
Subject: [Softdevice-cvs] softdevice configure,1.1,1.2
Message-ID: <200509110822.j8B8Mg105973@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv771

Modified Files:
	configure 
Log Message:
added some configure parameters

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** configure	10 Sep 2005 19:54:15 -0000	1.1
--- configure	11 Sep 2005 08:22:39 -0000	1.2
***************
*** 27,30 ****
--- 27,55 ----
  with_mmx2="yes"
  
+ function help () {
+   echo "Usage: configure [options]"
+   echo "available options are:"
+   echo "  --disable-vidix"
+   echo "  --disable-dfb"
+   echo "  --disable-xv"
+   echo "  --with-vidix-path YOUR_VIDIX_PATH"
+   echo "  --help"
+ }
+ 
+ while [ $# -gt 0 ]
+ do
+   case $1 in
+     --disable-vidix) shift; vidix="no" ;;
+     --disable-dfb) shift; dfb="no" ;;
+     --disable-xv) shift; xv="no" ;;
+     --with-vidix-path) shift;
+       vidix_path=$1 ;
+       echo "vidix path set to: $vidix_path" ;
+       shift ;;
+     --help) help; exit ;;
+     *) echo "ERROR: unknown parameter $1"; help; exit ;;
+   esac
+ done
+ 
  #########################################################
  # start ffmpeg test



From nobody at sheep.berlios.de  Sun Sep 11 11:22:32 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 11 Sep 2005 11:22:32 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.106,1.107 mpeg2decoder.c,1.53,1.54 video.c,1.29,1.30 video.h,1.20,1.21
Message-ID: <200509110922.j8B9MW107136@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3239

Modified Files:
	CHANGELOG mpeg2decoder.c video.c video.h 
Log Message:
fix for segfaults with some OSD activity

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.106
retrieving revision 1.107
diff -C2 -d -r1.106 -r1.107
*** CHANGELOG	6 Sep 2005 21:55:27 -0000	1.106
--- CHANGELOG	11 Sep 2005 09:22:30 -0000	1.107
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-09-11:
+     - fix for segfaults with some OSD activity
+     - introduced configure script: try ./configure --help
  2005-09-06:
      - video-out (all methods): fix for missing actions upon aspect ratio change

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** mpeg2decoder.c	6 Sep 2005 21:55:27 -0000	1.53
--- mpeg2decoder.c	11 Sep 2005 09:22:30 -0000	1.54
***************
*** 577,581 ****
  
      // do format conversions if necessary
!     if (context->pix_fmt!=PIX_FMT_YUV420P) 
        libavcodec_img_convert();
  
--- 577,581 ----
  
      // do format conversions if necessary
!     if (context->pix_fmt!=PIX_FMT_YUV420P)
        libavcodec_img_convert();
  
***************
*** 584,588 ****
      pix_fmt = context->pix_fmt;
  
!    
      // find decoded pictures pts value
      int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
--- 584,588 ----
      pix_fmt = context->pix_fmt;
  
! 
      // find decoded pictures pts value
      int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
***************
*** 599,618 ****
            pts = pts_values[findPTS].pts;
       };
-   
-   if (!hurry_up || frame % 2 ) {
-     // prepare picture for display
-     videoOut->CheckAspectDimensions(picture,context);
-     videoOut->SetOldPicture(picture,context->width,context->height);
  
!     // sleep ....
!     delay-=syncTimer->GetRelTime();
!     MPGDEB("Frame# %-5d  aPTS: %lld offset: %d delay %d \n",frame,clock->GetPTS(),offset,delay );
! 
!     videoOut->Sync(syncTimer, &delay);
!     // display picture
!     videoOut->YUV(picture->data[0], picture->data[1],picture->data[2],
!         context->width,context->height,
!         picture->linesize[0],picture->linesize[1]);
!   } else fprintf(stderr,"+");
    // we just displayed a frame, now it's the right time to
    // measure the A-V offset
--- 599,607 ----
            pts = pts_values[findPTS].pts;
       };
  
!   if (!hurry_up || frame % 2 )
!     videoOut->DrawVideo_420pl(syncTimer, &delay, picture,context);
!   else
!     fprintf(stderr,"+");
    // we just displayed a frame, now it's the right time to
    // measure the A-V offset

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** video.c	19 Aug 2005 09:02:05 -0000	1.29
--- video.c	11 Sep 2005 09:22:30 -0000	1.30
***************
*** 95,110 ****
           OsdRefreshCounter>10 && Osd_changed))
      {
-       osdMutex.Lock();
        if (old_picture)
        {
!         YUV(old_picture->data[0], old_picture->data[1], old_picture->data[2],
!             old_width,old_height,
!             old_picture->linesize[0],old_picture->linesize[1]);
        }
        else
        {
!         YUV(OsdPy,OsdPu, OsdPv, OsdWidth, OsdHeight,
!             OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
        Osd_changed=0;
        osdMutex.Unlock();
--- 95,113 ----
           OsdRefreshCounter>10 && Osd_changed))
      {
        if (old_picture)
        {
!         DrawStill_420pl (old_picture->data[0],
!                          old_picture->data[1],
!                          old_picture->data[2],
!                          old_width, old_height,
!                          old_picture->linesize[0],
!                          old_picture->linesize[1]);
        }
        else
        {
!         DrawStill_420pl (OsdPy,OsdPu, OsdPv, OsdWidth, OsdHeight,
!                          OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
+       osdMutex.Lock();
        Osd_changed=0;
        osdMutex.Unlock();
***************
*** 359,366 ****
--- 362,418 ----
  /* ---------------------------------------------------------------------------
   */
+ void cVideoOut::CheckArea(int w, int h)
+ {
+   if (fwidth != w || fheight != h)
+   {
+     dsyslog("[VideoOut]: resolution changed: W(%d -> %d); H(%d ->%d)\n",
+              fwidth, w, fheight, h);
+     fwidth = w;
+     fheight = h;
+     aspect_changed = 1;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cVideoOut::Sync(cSyncTimer *syncTimer, int *delay)
  {
+   *delay-=syncTimer->GetRelTime();
    syncTimer->Sleep(delay,displayTimeUS);
    *delay -= syncTimer->GetRelTime();
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::DrawVideo_420pl(cSyncTimer *syncTimer, int *delay,
+                                 AVFrame *picture, AVCodecContext *context)
+ {
+   areaMutex. Lock();
+   CheckAspectDimensions(picture,context);
+   SetOldPicture(picture,context->width,context->height);
+   Sync(syncTimer, delay);
+   // display picture
+   YUV(picture->data[0], picture->data[1],picture->data[2],
+       context->width,context->height,
+       picture->linesize[0],picture->linesize[1]);
+ 
+   /* --------------------------------------------------------------------------
+    * Unlocking could be done a bit earlier in YUV(), after video is displayed
+    * and before event processing starts. For now it is easier to do it here.
+    * Same applies for DrawStill_420pl() below.
+    */
+   areaMutex. Unlock();
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::DrawStill_420pl(uint8_t *pY, uint8_t *pU, uint8_t *pV,
+                                 int w, int h, int yPitch, int uvPitch)
+ {
+   areaMutex. Lock();
+   CheckArea(w, h);
+   // display picture
+   YUV (pY, pU, pV, w, h, yPitch, uvPitch);
+   areaMutex. Unlock();
  }
  

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** video.h	10 Sep 2005 19:43:21 -0000	1.20
--- video.h	11 Sep 2005 09:22:30 -0000	1.21
***************
*** 80,84 ****
  private:
  protected:
!     cMutex  osdMutex;
      int     OSDxOfs, OSDyOfs,
              OSDw, OSDh;
--- 80,85 ----
  private:
  protected:
!     cMutex  osdMutex,
!             areaMutex;
      int     OSDxOfs, OSDyOfs,
              OSDw, OSDh;
***************
*** 130,133 ****
--- 131,139 ----
      virtual void CheckAspect(int new_afd, float new_asp);
      virtual void CheckAspectDimensions (AVFrame *picture, AVCodecContext *context);
+     virtual void CheckArea(int w, int h);
+     virtual void DrawVideo_420pl (cSyncTimer *syncTimer, int *delay,
+                                   AVFrame *picture, AVCodecContext *context);
+     virtual void DrawStill_420pl (uint8_t *pY, uint8_t *pU, uint8_t *pV,
+                                   int w, int h, int yPitch, int uvPitch);
      virtual bool Initialize(void) {return 1;};
      virtual bool Reconfigure (int format) {return 1;};



From nobody at sheep.berlios.de  Sun Sep 11 22:09:34 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 11 Sep 2005 22:09:34 +0200
Subject: [Softdevice-cvs] softieee1394 .cvsignore,NONE,1.1
Message-ID: <200509112009.j8BK9Y127023@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394
In directory sheep:/tmp/cvs-serv17755

Added Files:
	.cvsignore 
Log Message:
ignore some files

--- NEW FILE: .cvsignore ---
.dependencies
.#*.c.*
.#*.h.*
config.mak
config.h


From nobody at sheep.berlios.de  Sun Sep 11 22:10:19 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 11 Sep 2005 22:10:19 +0200
Subject: [Softdevice-cvs] softieee1394/patches - New directory
Message-ID: <200509112010.j8BKAJ127040@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394/patches
In directory sheep:/tmp/cvs-serv17800/patches

Log Message:
Directory /cvsroot/softdevice/softieee1394/patches added to the repository




From nobody at sheep.berlios.de  Sun Sep 11 22:21:41 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 11 Sep 2005 22:21:41 +0200
Subject: [Softdevice-cvs] softieee1394/patches libavc1394-0.5.0-read-mic-03.diff,NONE,1.1
Message-ID: <200509112021.j8BKLf127316@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394/patches
In directory sheep:/tmp/cvs-serv19234

Added Files:
	libavc1394-0.5.0-read-mic-03.diff 
Log Message:
include patch for libavc1394-0.5.0

--- NEW FILE: libavc1394-0.5.0-read-mic-03.diff ---
? INSTALL
? Makefile
? Makefile.in
? aclocal.m4
? autom4te.cache
? config.guess
? config.h
? config.h.in
? config.log
? config.status
? config.sub
? configure
? depcomp
? dv.1999.mic
? dv.2005-schule.mic
? dv.2005-stl.mic
? install-sh
? libavc1394.pc
? libavc1394.spec
? libtool
? missing
? mkinstalldirs
? stamp-h1
? common/.deps
? common/.libs
? common/Makefile
? common/Makefile.in
? common/libraw1394util.la
? common/raw1394util.lo
? libavc1394/.deps
? libavc1394/.libs
? libavc1394/Makefile
? libavc1394/Makefile.in
? libavc1394/avc1394_internal.lo
? libavc1394/avc1394_simple.lo
? libavc1394/avc1394_vcr.lo
? libavc1394/libavc1394.la
? librom1394/.deps
? librom1394/.libs
? librom1394/Makefile
? librom1394/Makefile.in
? librom1394/librom1394.la
? librom1394/rom1394_internal.lo
? librom1394/rom1394_main.lo
? test/.deps
? test/.libs
? test/Makefile
? test/Makefile.in
? test/avc_vcr
? test/dvcont
? test/mkrfc2734
? test/romtest
? test/setrom
Index: bootstrap
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/bootstrap,v
retrieving revision 1.2
diff -U3 -r1.2 bootstrap
--- bootstrap	23 Apr 2003 05:04:06 -0000	1.2
+++ bootstrap	11 Sep 2005 20:03:33 -0000
@@ -1,7 +1,7 @@
 #! /bin/sh
 aclocal \
+&& libtoolize --automake \
 && autoheader \
 && automake --gnu --add-missing --copy \
-&& autoconf \
-&& libtoolize --force --copy
+&& autoconf
 
Index: libavc1394/avc1394.h
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/libavc1394/avc1394.h,v
retrieving revision 1.5
diff -U3 -r1.5 avc1394.h
--- libavc1394/avc1394.h	11 Jan 2005 02:51:01 -0000	1.5
+++ libavc1394/avc1394.h	11 Sep 2005 20:03:35 -0000
@@ -329,6 +329,14 @@
 #define AVC1394_VCR_OPERAND_TRANSPORT_STATE 0x7F
 #define AVC1394_VCR_OPERAND_RECORDING_TIME_STATUS 0x71
 
+#define AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_SEEK    0x20
+#define AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_STATUS  0x71
+
+#define AVC1394_VCR_OPERAND_MIC_CLOSE       0x00
+#define AVC1394_VCR_OPERAND_MIC_READ_OPEN   0x01
+#define AVC1394_VCR_OPERAND_MIC_STATE       0xFF
+#define AVC1394_VCR_OPERAND_MIC_WRITE_OPEN  0x03
+
 /* recording speed */
 #define AVC1394_VCR_OPERAND_RECORDING_SPEED_STANDARD 0x6F
 
@@ -367,6 +375,34 @@
 #define AVC1394_TUNER_COMMAND_CA_ENABLE 0xCC
 #define AVC1394_TUNER_COMMAND_AVC1394_TUNER_STATUS 0xCD
 
+#define MAX_MIC_SIZE      (64*1024)
+#define MIC_HEADER_SIZE   16
+#define MIC_ADDINFO_SIZE  10
+#define MIC_ENTRY_SIZE    10
+
+#define MIC_TAG_ATN       0x0B
+#define MIC_TAG_NAME      0x18
+#define MIC_TAG_INFO      0x42
+
+#define MIC_TAG_INFO_DT         0x00
+#define MIC_TAG_INFO_TAPE_NAME  0x06
+#define MIC_TAG_INFO_NONE       0x07
+
+typedef struct {
+  int atn;
+  int year;
+  int day;
+  int hour;
+  int minute;
+} t_mic_jump_mark;
+
+typedef struct {
+  int uatn;
+  int eom_atn;
+  t_mic_jump_mark jump_mark[(MAX_MIC_SIZE-(MIC_HEADER_SIZE+MIC_ADDINFO_SIZE)) /
+                            MIC_ENTRY_SIZE];
+} t_mic_directory;
+
 enum avc1394_measurement_unit {
     AVC1394_VCR_MEASUREMENT_VIDEO_FRAME = 0,
     AVC1394_VCR_MEASUREMENT_VIDEO_SCENE,
@@ -396,7 +432,11 @@
 avc1394_transaction_block(raw1394handle_t handle, nodeid_t node,
 	quadlet_t *buf, int len, int retry);
 
-int 
+quadlet_t *
+avc1394_transaction_block_byte(raw1394handle_t handle, nodeid_t node,
+	quadlet_t *buf, int len, int retry);
+
+int
 avc1394_open_descriptor(raw1394handle_t handle, nodeid_t node,
 	quadlet_t ctype, quadlet_t subunit,
 	unsigned char *descriptor_identifier, int len_descriptor_identifier,
Index: libavc1394/avc1394_internal.c
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/libavc1394/avc1394_internal.c,v
retrieving revision 1.4
diff -U3 -r1.4 avc1394_internal.c
--- libavc1394/avc1394_internal.c	24 Nov 2002 06:01:17 -0000	1.4
+++ libavc1394/avc1394_internal.c	11 Sep 2005 20:03:35 -0000
@@ -25,6 +25,7 @@
 #include <string.h>
 
 unsigned char g_fcp_response[MAX_RESPONSE_SIZE];
+int           g_fcp_response_length;
 
 void htonl_block(quadlet_t *buf, int len)
 {
@@ -67,9 +68,11 @@
                     size_t length, unsigned char *data)
 {
     if ( response && length > 3 )
-	{
-		if ( *((quadlet_t*)data) != 0 ) 
-			memcpy(g_fcp_response, data, length);
+    {
+      if ( *((quadlet_t*)data) != 0 ) {
+        g_fcp_response_length = length;
+        memcpy(g_fcp_response, data, length);
+      }
     }
 
     return 0;
Index: libavc1394/avc1394_simple.c
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/libavc1394/avc1394_simple.c,v
retrieving revision 1.12
diff -U3 -r1.12 avc1394_simple.c
--- libavc1394/avc1394_simple.c	10 Jul 2004 00:50:47 -0000	1.12
+++ libavc1394/avc1394_simple.c	11 Sep 2005 20:03:36 -0000
@@ -43,6 +43,7 @@
 #include <sys/poll.h>
 #include <unistd.h>
 #include <time.h>
+#include <ctype.h>
 
 #include <string.h>
 #include <netinet/in.h>
@@ -50,6 +51,7 @@
 #include <stdio.h>	//DEBUG
 
 extern unsigned char g_fcp_response[];
+extern int           g_fcp_response_length;
 
 int avc1394_send_command(raw1394handle_t handle, nodeid_t node, quadlet_t command)
 {
@@ -69,6 +71,16 @@
                             command_len*4, command);
 }
 
+int avc1394_send_command_block2(raw1394handle_t handle, nodeid_t node,
+                           quadlet_t *command, int command_len)
+{
+
+    htonl_block(command, command_len);
+
+    return cooked1394_write(handle, 0xffc0 | node, FCP_COMMAND_ADDR,
+                            command_len, command);
+}
+
 
 /*
  * Send an AV/C request to a device, wait for the corresponding AV/C
@@ -197,17 +209,84 @@
 			fprintf(stderr, " (%s)\n", decode_response(response[0]));
         }
 #endif
-		
+
 		if (response != 0) {
 			stop_avc_response_handler(handle);
 			return response;
 		}
     } while (--retry >= 0);
-	
+
     stop_avc_response_handler(handle);
     return NULL;
 }
 
+quadlet_t *avc1394_transaction_block_byte(raw1394handle_t handle, nodeid_t node,
+                                 quadlet_t *buf, int len, int retry)
+{
+
+    quadlet_t *response = NULL;
+    struct pollfd raw1394_poll;
+    raw1394_poll.fd = raw1394_get_fd(handle);
+    raw1394_poll.events = POLLIN;
+
+  init_avc_response_handler(handle);
+
+  do {
+    if (avc1394_send_command_block2(handle, node, buf, len) < 0) {
+         struct timespec ts = {0, AVC1394_SLEEP};
+      fprintf(stderr,"send oops\n");
+      nanosleep(&ts, NULL);
+      continue;
+    }
+
+    if ( poll( &raw1394_poll, 1, AVC1394_POLL_TIMEOUT) > 0 ) {
+      if (raw1394_poll.revents & POLLIN) {
+        raw1394_loop_iterate(handle);
+        response = (quadlet_t *)g_fcp_response;
+        ntohl_block(response, 1);
+      }
+    }
+    if (response != NULL) {
+      while (AVC1394_MASK_RESPONSE(response[0]) == AVC1394_RESPONSE_INTERIM) {
+#ifdef DEBUG
+        fprintf(stderr,"INTERIM\n");
+#endif
+        if ( poll( &raw1394_poll, 1, AVC1394_POLL_TIMEOUT) > 0 ) {
+          if (raw1394_poll.revents & POLLIN) {
+            raw1394_loop_iterate(handle);
+            response = (quadlet_t *)g_fcp_response;
+            ntohl_block(response, 1);
+          }
+        }
+      }
+    }
+
+#ifdef DEBUG
+    if (response != NULL) {
+        int i;
+      fprintf(stderr, "avc1394_transaction_block_byte received response: \n");
+      for (i=0; i<g_fcp_response_length; i++)
+        fprintf(stderr, "%02X ",
+        g_fcp_response[i]);
+      fprintf(stderr, " (%s)\n", decode_response(response[0]));
+
+      for (i=0; i<g_fcp_response_length; i++)
+        fprintf(stderr, " %c ",
+        isprint(g_fcp_response[i]) ? g_fcp_response[i]:'.');
+      fprintf(stderr, " (%s)\n", decode_response(response[0]));
+    }
+#endif
+
+    if (response != 0) {
+      stop_avc_response_handler(handle);
+      return response;
+    }
+  } while (--retry >= 0);
+
+  stop_avc_response_handler(handle);
+  return NULL;
+}
+
 /*---------------------
  * HIGH-LEVEL-FUNCTIONS
  * --------------------
Index: libavc1394/avc1394_vcr.c
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/libavc1394/avc1394_vcr.c,v
retrieving revision 1.7
diff -U3 -r1.7 avc1394_vcr.c
--- libavc1394/avc1394_vcr.c	10 Jul 2004 16:07:08 -0000	1.7
+++ libavc1394/avc1394_vcr.c	11 Sep 2005 20:03:37 -0000
@@ -22,6 +22,7 @@
 #include <unistd.h>
 #include <stdio.h>
 #include <stdlib.h>
+#include <string.h>
 #include "avc1394_vcr.h"
 #include "avc1394.h"
 
@@ -178,7 +179,7 @@
 {
     quadlet_t request[2];
 	if (avc1394_vcr_is_playing(handle, node)) {
-	    request[0] = CTLVCR0 | AVC1394_VCR_COMMAND_FORWARD | 
+	    request[0] = CTLVCR0 | AVC1394_VCR_COMMAND_FORWARD |
 	        AVC1394_VCR_MEASUREMENT_INDEX;
 	    request[1] = 0x01FFFFFF;
 		avc1394_send_command_block(handle, node, request, 2);
@@ -302,12 +303,12 @@
 {
     quadlet_t  request[2];
     quadlet_t *response;
-        
-    request[0] = STATVCR0 | AVC1394_VCR_COMMAND_TIME_CODE | 
+
+    request[0] = STATVCR0 | AVC1394_VCR_COMMAND_TIME_CODE |
         AVC1394_VCR_OPERAND_TIME_CODE_STATUS;
     request[1] = 0xFFFFFFFF;
     response = avc1394_transaction_block( handle, node, request, 2, AVC1394_RETRY);
-    if (response == NULL) 
+    if (response == NULL)
 		return -1;
 
     // consumer timecode format
@@ -316,7 +317,7 @@
         (response[1] >> 8) & 0x000000ff,
         (response[1] >> 16) & 0x000000ff,
         (response[1] >> 24) & 0x000000ff);
-    
+
     return 0;
 }
 
@@ -327,18 +328,339 @@
 {
     quadlet_t  request[2];
 	unsigned int hh,mm,ss,ff;
-        
-    request[0] = CTLVCR0 | AVC1394_VCR_COMMAND_TIME_CODE | 
+
+    request[0] = CTLVCR0 | AVC1394_VCR_COMMAND_TIME_CODE |
         AVC1394_VCR_OPERAND_TIME_CODE_CONTROL;
 
     // consumer timecode format
     sscanf(timecode, "%2x:%2x:%2x:%2x", &hh, &mm, &ss, &ff);
-	request[1] = 
+	request[1] =
 		((ff & 0x000000ff) << 24) |
 		((ss & 0x000000ff) << 16) |
 		((mm & 0x000000ff) <<  8) |
 		((hh & 0x000000ff) <<  0) ;
 	printf("timecode: %08x\n", request[1]);
-    
+
     avc1394_send_command_block( handle, node, request, 2);
 }
+
+/* ----------------------------------------------------------------------------
+ */
+void
+avc1394_vcr_seek_atn(raw1394handle_t handle, nodeid_t node,
+                     int atn, int mt, int mtd, int sfbf)
+{
+    quadlet_t request[2];
+    quadlet_t *response;
+
+  request[0] = CTLVCR0 |
+                AVC1394_VCR_COMMAND_ABSOLUTE_TRACK_NUMBER |
+                AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_SEEK;
+
+  if (mt == 0x1f) {
+    atn <<= 1;
+    atn |= (sfbf & 1);
+    request[1] = (atn << 24) |
+                 ((atn & 0x0000ff00) << 8) |
+                 ((atn & 0x00ff0000) >> 8) |
+                 (mt << 3) |
+                 (mtd & 7);
+  } else if (mt == 0x01) {
+  ;
+  } else {
+    return;
+  }
+  response = avc1394_transaction_block( handle, node, request, 2, AVC1394_RETRY);
+}
+
+/* ----------------------------------------------------------------------------
+ */
+int
+avc1394_vcr_get_atn(raw1394handle_t handle, nodeid_t node,
+                    int *atn, int *mt, int *mtd, int *sfbf)
+{
+    quadlet_t request[2];
+    quadlet_t *response;
+
+  request[0] = STATVCR0 |
+                AVC1394_VCR_COMMAND_ABSOLUTE_TRACK_NUMBER |
+                AVC1394_VCR_OPERAND_ABSOLUTE_TRACK_NUMBER_STATUS;
+  request[1] = 0xFFFFFFFF;
+
+  response = avc1394_transaction_block( handle, node, request, 2, AVC1394_RETRY);
+  if (response == NULL)
+    return -1;
+
+  *mt = (response[1] & 0x000000F8) >> 3;
+  *mtd = response[1] & 0x00000007;
+  if (*mt == 0x1F) {
+    *atn = (response[1] & 0xff000000) >> 24 |
+           (response[1] & 0x00ff0000) >>  8 |
+           (response[1] & 0x0000ff00) <<  8;
+    *atn >>= 1; /* shift out bf flag */
+    *sfbf = (response[1] & 0x01000000) >> 24;
+    /* to get the real tape position in h:mm:ss:ff, calculation depends
+     * on PAL/NTSC
+     * for PAL: *atn /= 12; for NTSC *atn /= 10 (number of DIF sequences ?)
+     * *atn /= fps (25 or 30) to get the absolute frame number on tape
+     */
+  } else if (*mt == 0x01) {
+    *atn = (response[1] & 0x3f000000) >> 23 | /* ignore sf flag */
+           (response[1] & 0x00ff0000) >>  7 |
+           (response[1] & 0x0000ff00) >>  7;
+    *sfbf = (response[1] & 0xC0000000) >> 30;
+  } else {
+    return -2;
+  }
+
+  fprintf(stderr," ATN_raw = 0x%08x\n", response[1]);
+  return 0;
+}
+
+/* ----------------------------------------------------------------------------
+ */
+int
+avc1394_vcr_get_mic_status(raw1394handle_t handle, nodeid_t node)
+{
+    quadlet_t response;
+  /* --------------------------------------------------------------------------
+   * check current status of MIC
+   */
+  response = avc1394_transaction(handle, node,
+                                 STATVCR0 |
+                                    AVC1394_VCR_COMMAND_OPEN_MIC |
+                                    AVC1394_VCR_OPERAND_MIC_STATE,
+                                 AVC1394_RETRY);
+
+  fprintf (stderr, "MIC status = %02x \n", AVC1394_GET_OPERAND0(response));
+  return AVC1394_GET_OPERAND0(response);
+}
+
+int
+avc1394_vcr_mic_open_read(raw1394handle_t handle, nodeid_t node)
+{
+    quadlet_t response;
+  /* --------------------------------------------------------------------------
+   * open mic for read access
+   */
+  response = avc1394_transaction(handle, node,
+                                 CTLVCR0 |
+                                    AVC1394_VCR_COMMAND_OPEN_MIC |
+                                    AVC1394_VCR_OPERAND_MIC_READ_OPEN,
+                                 AVC1394_RETRY);
+
+  fprintf (stderr, "MIC open read status = %02x \n",
+           AVC1394_GET_OPERAND0(response));
+  return AVC1394_GET_OPERAND0(response);
+}
+
+int
+avc1394_vcr_mic_close(raw1394handle_t handle, nodeid_t node)
+{
+    quadlet_t response;
+  /* --------------------------------------------------------------------------
+   * close mic
+   */
+  response = avc1394_transaction(handle, node,
+                                 CTLVCR0 |
+                                    AVC1394_VCR_COMMAND_OPEN_MIC |
+                                    AVC1394_VCR_OPERAND_MIC_CLOSE,
+                                 AVC1394_RETRY);
+
+  fprintf (stderr, "MIC close status = %02x \n", AVC1394_GET_OPERAND0(response));
+  return AVC1394_GET_OPERAND0(response);
+}
+
+void
+avc1394_make_atn (unsigned char *p)
+{
+}
+
+void
+avc1394_mic_atn2str(unsigned char *p, char *strP, char *strN)
+{
+    int atn = 0;
+
+  if (*(p + 4) >> 3 == 0x1f) {
+    atn = (*(p+1) | *(p+2) << 8 | *(p+3) << 16) >> 1;
+  } else if (*(p + 4) >> 3 == 0x1f) {
+    atn = (*(p+3) << 1 | *(p+2) << 9 | (*(p+1) & 0x3f) << 17);
+  }
+  sprintf (strP,
+           "%02d:%02d:%02d.%02d",
+           (atn / (12 * 25 * 60 * 60)) % 24,
+           (atn / (12 * 25 * 60)) % 60,
+           (atn / (12 * 25)) % 60,
+           (atn / 12) % 25);
+  sprintf (strN,
+           "%02d:%02d:%02d.%02d",
+           (atn / (10 * 30 * 60 * 60)) % 24,
+           (atn / (10 * 30 * 60)) % 60 ,
+           (atn / (10 * 30) % 60),
+           (atn / 10) % 30);
+}
+
+void
+avc1394_mic_datetime2str(unsigned char *p, char *d, char *t)
+{
+  sprintf (d,
+           "%02d-%02d-%02d",
+           (*(p+3) & 0xE0) >> 1 | (*(p+4) & 0xF0) >> 4,
+           *(p+4) & 0x0f,
+           *(p+3) & 0x1f);
+  sprintf (t,
+           "%02d:%02d",
+           *(p+2) & 0x1F,
+           *(p+1) & 0x3F);
+}
+
+/*
+ */
+int
+avc1394_vcr_parse_mic_info (unsigned char *mic_data, int len, int prt)
+{
+    unsigned char *p;
+    int           l,
+                  marker;
+    char          buf1 [16],
+                  buf2 [16];
+
+
+  if (prt)
+    fprintf(stderr, "MIC info start\n");
+  p = mic_data;
+  l = len;
+  /* check header */
+
+  p += 11;
+  l -= 11;
+  /* get tape end ATN */
+  if (l < len && *p == 0x1F) {
+    if ((len - l) > 5) {
+      if (prt) {
+        avc1394_mic_atn2str (p, buf1, buf2);
+        fprintf (stderr, "  tape end : %s\n", buf1);
+      }
+    }
+    p += 5; l -= 5;
+  }
+
+  p += 5; l -= 5;
+
+  marker = 1;
+  while (l < len && *p == 0x0b) {
+    if ((len-l) > 10) {
+      if (prt) {
+        avc1394_mic_atn2str (p, buf1, buf2);
+        fprintf (stderr, "  %2d.      : %s ", marker, buf1);
+      }
+      p += 5; l -= 5;
+      if (*p == 0x42) {
+        if (prt) {
+          avc1394_mic_datetime2str(p, buf1, buf2);
+          fprintf (stderr, "%s %s\n", buf1, buf2);
+        }
+      } else {
+        if (prt) {
+          fprintf(stderr,"\n");
+        }
+      }
+      marker++;
+      p += 5; l -= 5;
+      continue;
+    }
+    p++; l--;
+  }
+  if (l < len && *p == 0x18) {
+    if (prt) {
+      fprintf (stderr,"  tape name: %*.*s\n", *(p+1),*(p+1), p+4);
+    }
+  }
+  if (prt)
+    fprintf(stderr, "MIC info done!\n");
+  return 0;
+}
+
+/* Get all data from mic */
+void
+avc1394_vcr_get_mic_info(raw1394handle_t handle, nodeid_t node,
+                         unsigned char **mic_data, int *datalen)
+{
+    int           i,
+                  addr,
+                  count;
+    unsigned char buf[MAX_MIC_SIZE],
+                  *p;
+    quadlet_t     request[512],
+                  *response;
+
+  if (mic_data) {
+    if (*mic_data) {
+      free(*mic_data);
+    }
+    *mic_data = NULL;
+  }
+  if (datalen) {
+    *datalen = 0;
+  }
+
+  count = 0;
+
+  avc1394_vcr_get_mic_status (handle, node);
+
+  /* --------------------------------------------------------------------------
+   * next steps are:
+   * - open mic for read only
+   * - read all mic data
+   * - close mic
+   */
+  avc1394_vcr_mic_open_read (handle, node);
+  avc1394_vcr_get_mic_status (handle, node);
+  for (i = 0, addr = 0; i < 34; i++) {
+    request[0] = CTLVCR0 | AVC1394_VCR_COMMAND_READ_MIC | 0x30;
+    request[1] = addr << 16;
+    response = avc1394_transaction_block_byte(handle, node,
+                                              request, 6, AVC1394_RETRY);
+    if (response) {
+      if (AVC1394_MASK_RESPONSE(*response) != AVC1394_RESPONSE_ACCEPTED)
+        break;
+      p = (unsigned char *) response;
+      memcpy (buf+addr, p+6, AVC1394_MASK_RESPONSE_OPERAND(*response,3));
+      count += AVC1394_MASK_RESPONSE_OPERAND(*response,3);
+      addr += AVC1394_MASK_RESPONSE_OPERAND(*response,3);
+    }
+  }
+  fprintf (stderr, " got %d bytes from MIC\n", count);
+  if (count) {
+    if (datalen) {
+      *datalen = count;
+    }
+    if (mic_data) {
+      if ((*mic_data = malloc (count))) {
+        memcpy (*mic_data, buf, count);
+      }
+    }
+  }
+
+  avc1394_vcr_mic_close (handle, node);
+  //avc1394_vcr_get_mic_status (handle, node);
+}
+
+void
+avc1394_vcr_medium_info(raw1394handle_t handle, nodeid_t node,
+                         unsigned char *medium_info, unsigned char *medium_type)
+{
+    unsigned char *p;
+    quadlet_t     request[2],
+                  *response;
+
+  request[0] = STATVCR0 | AVC1394_VCR_COMMAND_MEDIUM_INFO | 0x7F;
+  request[1] = 0x7F000000;
+  response = avc1394_transaction_block_byte(handle, node,
+                                            request, 5, AVC1394_RETRY);
+  if (response) {
+      p = (unsigned char *) response;
+
+    fprintf(stderr," -- type(%02x) grade(%02x)\n", p[0], p[4]);
+  }
+}
Index: libavc1394/avc1394_vcr.h
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/libavc1394/avc1394_vcr.h,v
retrieving revision 1.5
diff -U3 -r1.5 avc1394_vcr.h
--- libavc1394/avc1394_vcr.h	10 Jul 2004 16:07:08 -0000	1.5
+++ libavc1394/avc1394_vcr.h	11 Sep 2005 20:03:37 -0000
@@ -113,6 +113,17 @@
 void
 avc1394_vcr_seek_timecode(raw1394handle_t handle, nodeid_t node, char *timecode);
 
+void
+avc1394_vcr_get_mic_info(raw1394handle_t handle, nodeid_t node,
+                         unsigned char **mic_data, int *datalen);
+
+int
+avc1394_vcr_get_atn(raw1394handle_t handle, nodeid_t node,
+                    int *atn, int *mt, int *mtd, int *sfbf);
+
+void
+avc1394_vcr_seek_atn(raw1394handle_t handle, nodeid_t node,
+                     int atn, int mt, int mtd, int sfbf);
 #ifdef __cplusplus
 }
 #endif
Index: test/dvcont.c
===================================================================
RCS file: /cvsroot/libavc1394/libavc1394/test/dvcont.c,v
retrieving revision 1.13
diff -U3 -r1.13 dvcont.c
--- test/dvcont.c	17 Feb 2005 15:20:46 -0000	1.13
+++ test/dvcont.c	11 Sep 2005 20:03:38 -0000
@@ -8,9 +8,9 @@
  *
  * This code is based off a GNU project called gscanbus by Andreas Micklei
  * -- Thanks Andreas for the great code! --
- * 
+ *
  * Thanks to Dan Dennedy for patching this version to get it to work
- * with his camera.  (Panasonic PV-DV910) 
+ * with his camera.  (Panasonic PV-DV910)
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -44,6 +44,27 @@
 
 #define version "Version 0.4"
 
+unsigned char demo_mic[512] =
+  {
+0x1F, 0x00, 0xE4, 0x1F, 0x00, 0x70, 0x01, 0x01, 0xF5, 0x20, 0xFF, 0x1F, 0xA1, 0xBB, 0x01, 0xFF,
+0x0B, 0xA1, 0xBB, 0x01, 0xF7, 0x0B, 0x01, 0x00, 0x00, 0xF8, 0x42, 0x86, 0xE9, 0x09, 0x54, 0x0B,
+0x89, 0x64, 0x01, 0xF8, 0x42, 0xAF, 0xF4, 0x03, 0x55, 0x18, 0x09, 0xFE, 0x42, 0x53, 0x54, 0x4C,
+0x27, 0x53, 0x20, 0x54, 0x45, 0x53, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
+  };
+int           demo_mic_len = 512;
+
 void show_help() {
 
 printf("\n--- DVCONT HELP ---");
@@ -71,6 +92,9 @@
 printf("\nhelp - Tell the program to show you this screen");
 printf("\ndev <number> - Select device number on chain to use.");
 printf("\n               (use the dev command BEFORE any other commands)");
+printf("\nmic      - read out MIC eeprom of cassete if present");
+printf("\natn      - read out ATN Absolute Track Number (position of tape)");
+printf("\natn_seek - seek to given ATN");
 printf("\n\n");
 
 }
@@ -84,7 +108,7 @@
     int i, j;
 	int speed;
 	char timecode[12];
-
+avc1394_vcr_parse_mic_info (demo_mic, demo_mic_len, 1);
 	if (argc < 2)
 	{
 		show_help();
@@ -176,7 +200,7 @@
 	    
 	    } else if (strcmp("pause", argv[i]) == 0) {
 		    avc1394_vcr_pause(handle, device);
-	    
+
 	    } else if (strcmp("record", argv[i]) == 0) {
     		avc1394_vcr_record(handle, device);
 	    
@@ -246,9 +270,50 @@
 				fprintf(stderr, "pluginfo: 0x%08X 0x%08X\n", response[0], response[1]);
 #endif
 			}
+		} else if (strcmp("mic", argv[i]) == 0) {
+				unsigned char *mic_data = NULL;
+				int           len = 0;
+
+			avc1394_vcr_get_mic_info (handle, device,
+			                          &mic_data, &len);
+			avc1394_vcr_parse_mic_info (mic_data, len, 1);
+		} else if (strcmp("atn", argv[i]) == 0) {
+				int atn, med, med_dep, sfbf;
+			if (avc1394_vcr_get_atn (handle, device, &atn, &med, &med_dep, &sfbf) == 0)
+			{
+				fprintf (stderr,
+				         "atn = %08x, "
+				          "(tape position [PAL/NTSC] = "
+				              "%02d:%02d:%02d:%02d/%02d:%02d:%02d:%02d) "
+				          "media = %s, (%sontigous numbers)\n",
+				         atn,
+				         (atn / (12 * 25 * 60 * 60)) % 24,
+				         (atn / (12 * 25 * 60)) % 60,
+				         (atn / (12 * 25)) % 60,
+				         (atn / 12) % 25,
+				         (atn / (10 * 30 * 60 * 60)) % 24,
+				         (atn / (10 * 30 * 60)) % 60 ,
+				         (atn / (10 * 30) % 60),
+				         (atn / 10) % 30,
+				         (med == 0x1f) ? "DVCR" :
+				            (med == 0x01) ? "D-VHS": "unknown",
+				         (!sfbf) ? "NOT C" : "C");
+			}
+		} else if (strcmp("atn_seek", argv[i]) == 0) {
+				int atn, mt, mtd, sfbf;
+			atn = 0x00005160;
+			mt  = 0x1f;
+			mtd = 7;
+			sfbf = 1;
+			avc1394_vcr_seek_atn (handle, device,
+			                      atn, mt, mtd, sfbf);
+		} else if (strcmp("medium", argv[i]) == 0) {
+				unsigned char m, g;
+			avc1394_vcr_medium_info (handle, device, &m, &g);
+fprintf(stderr, "----\n");     
 		}
 	}
-		
+
     raw1394_destroy_handle(handle);
 	return 0;
 }



From nobody at sheep.berlios.de  Mon Sep 12 14:17:10 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 12 Sep 2005 14:17:10 +0200
Subject: [Softdevice-cvs] softieee1394 HISTORY,1.2,1.3 Makefile,1.1.1.1,1.2 README,1.1.1.1,1.2 avc-handler.c,1.1.1.1,1.2 avc-handler.h,1.1.1.1,1.2 softieee1394.c,1.2,1.3
Message-ID: <200509121217.j8CCHA126096@bat.berlios.de>

Update of /cvsroot/softdevice/softieee1394
In directory sheep:/tmp/cvs-serv8939

Modified Files:
	HISTORY Makefile README avc-handler.c avc-handler.h 
	softieee1394.c 
Log Message:
sync cvs with work version

Index: HISTORY
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/HISTORY,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** HISTORY	24 Jul 2005 20:40:04 -0000	1.2
--- HISTORY	12 Sep 2005 12:17:07 -0000	1.3
***************
*** 1,7 ****
  VDR Plugin 'softieee1394' Revision History
  ------------------------------------------
  2005-07-24:
      - finnish translations by Rolf Ahrenberg
! 2005-04-09: Version 0.0.1
  
  - Initial revision.
--- 1,12 ----
  VDR Plugin 'softieee1394' Revision History
  ------------------------------------------
+ 2005-09-12:
+   - do not offer a mainmenu entry if there are no ieee1394 devices.
+   - some cleanups
+   - depends on a patch for libavc
+ 
  2005-07-24:
      - finnish translations by Rolf Ahrenberg
! 2005-04-09:
  
  - Initial revision.

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/Makefile,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** Makefile	1 May 2005 22:05:08 -0000	1.1.1.1
--- Makefile	12 Sep 2005 12:17:07 -0000	1.2
***************
*** 19,23 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -Wall -Woverloaded-virtual
  
  ### The directory environment:
--- 19,23 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -Woverloaded-virtual
  
  ### The directory environment:

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/README,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** README	1 May 2005 22:05:08 -0000	1.1.1.1
--- README	12 Sep 2005 12:17:07 -0000	1.2
***************
*** 1,7 ****
  This is a "plugin" for the Video Disk Recorder (VDR).
  
! Written by:                  Stefan Lucke <stefan at lucke.in-berlin.de>
  
! Project's homepage:          http://softdevice.berlios.de
  
  Latest version available at: via cvs
--- 1,7 ----
  This is a "plugin" for the Video Disk Recorder (VDR).
  
! Written by:                  Stefan Lucke <stefan at lucke.in-berlin.de>
  
! Project's homepage:          http://softdevice.berlios.de/softieee1394
  
  Latest version available at: via cvs
***************
*** 21,29 ****
    pause
  
  
  Additional required software:
    kernel configured with a working firewire subsystem
  
!   softdevice-0.1.1
      http://softdevice.berlios.de
  
--- 21,38 ----
    pause
  
+ Patches:
+   You need to patch libavc1394. Therefore the only supported version
+   is 0.5.0. The patch required is in directory patches. The usual procedure
+   for doing this is:
+   1. cd to_your_libavc1394_directory
+   2. patch --dry-run <path_to_patch_directory/patch_file
+   3. if that was succesfully (no rejects or failed messages)
+      patch <path_to_patch_directory/patch_file
+ 
  
  Additional required software:
    kernel configured with a working firewire subsystem
  
!   softdevice-0.1.3
      http://softdevice.berlios.de
  
***************
*** 35,37 ****
  
    ffmpeg-0.4.9-pre1
!     http://ffmpeg.sourceforge.net/download.php
\ No newline at end of file
--- 44,46 ----
  
    ffmpeg-0.4.9-pre1
!     http://ffmpeg.sourceforge.net/download.php

Index: avc-handler.c
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/avc-handler.c,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** avc-handler.c	1 May 2005 22:05:08 -0000	1.1.1.1
--- avc-handler.c	12 Sep 2005 12:17:07 -0000	1.2
***************
*** 37,41 ****
    for (int i = 0; i < MAX_IEEE1394_DEVICES; ++i)
    {
!     deviceId [i] = 0;
    }
  
--- 37,43 ----
    for (int i = 0; i < MAX_IEEE1394_DEVICES; ++i)
    {
!     deviceId[i] = 0;
!     micSize[i] = 0;
!     micData[i] = NULL;
    }
  
***************
*** 70,74 ****
  /* ---------------------------------------------------------------------------
   */
! void cAVCHandler::checkDevices(void)
  {
      int               i, j;
--- 72,77 ----
  /* ---------------------------------------------------------------------------
   */
! void
! cAVCHandler::checkDevices(void)
  {
      int               i, j;
***************
*** 98,101 ****
--- 101,106 ----
         */
        if (j >= numDevices) {
+ #if 0
+ // disabled since it may cause segfaults Skins.Message()
            char msg[100];
            //static int once = 1;
***************
*** 104,111 ****
--- 109,119 ----
                    tr("New FireWire Device"),newRomDirs[i].label);
          Skins.Message(mtInfo,msg);
+ #endif
+         avc1394_vcr_get_mic_info (handle, i, NULL, NULL);
        }
      }
    }
  
+ #if 0 // disabled since it may cause segfaults Skins.Message()
    for (j = 0; j < numDevices; j++) {
      if (deviceId[j]) {
***************
*** 117,120 ****
--- 125,129 ----
      }
    }
+ #endif
  
    if (newDevices != numDevices) {
***************
*** 134,138 ****
  }
  
! const char * cAVCHandler::GetDeviceNameAt(int i)
  {
      const char *name = NULL;
--- 143,150 ----
  }
  
! /* ---------------------------------------------------------------------------
!  */
! const char *
! cAVCHandler::GetDeviceNameAt(int i)
  {
      const char *name = NULL;
***************
*** 149,153 ****
  /* ---------------------------------------------------------------------------
   */
! octlet_t cAVCHandler::GetGuidForName(const char *name)
  {
      octlet_t  ret = 0;
--- 161,166 ----
  /* ---------------------------------------------------------------------------
   */
! octlet_t
! cAVCHandler::GetGuidForName(const char *name)
  {
      octlet_t  ret = 0;
***************
*** 168,172 ****
  /* ---------------------------------------------------------------------------
   */
! void cAVCHandler::Action()
  {
      int               fd, pollRc;
--- 181,220 ----
  /* ---------------------------------------------------------------------------
   */
! bool
! cAVCHandler::HasMicInfo(int i)
! {
!   return micSize[i] > 0;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! const char *
! cAVCHandler::TapePosition(int i, char *pos)
! {
!     int atn, m, mt, sfbf;
! 
!   if (avc1394_vcr_get_atn (handle, i, &atn, &m, &mt, &sfbf) == 0) {
!     snprintf(pos, 16,
!             "%02d:%02d:%02d.%02d",
!             (atn / (12 * 25 * 60 * 60)) % 24,
!             (atn / (12 * 25 * 60)) % 60,
!             (atn / (12 * 25)) % 60,
!             (atn / 12) % 25);
!   }
!   return pos;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! int
! cAVCHandler::NumDevices(void)
! {
!   return numDevices;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void
! cAVCHandler::Action()
  {
      int               fd, pollRc;
***************
*** 268,272 ****
  /* ----------------------------------------------------------------------------
   */
! void cAVCPlayer::Stop()
  {
    dsyslog("[AVCPlayer-Stop]\n");
--- 316,321 ----
  /* ----------------------------------------------------------------------------
   */
! void
! cAVCPlayer::Stop()
  {
    dsyslog("[AVCPlayer-Stop]\n");
***************
*** 277,281 ****
  /* ----------------------------------------------------------------------------
   */
! void cAVCPlayer::Activate(bool On)
  {
    dsyslog("[AVCPlayer-Activate]: %s", (On) ? "ON" : "OFF");
--- 326,331 ----
  /* ----------------------------------------------------------------------------
   */
! void
! cAVCPlayer::Activate(bool On)
  {
    dsyslog("[AVCPlayer-Activate]: %s", (On) ? "ON" : "OFF");
***************
*** 291,295 ****
  /* ---------------------------------------------------------------------------
   */
! void cAVCPlayer::Action(void)
  {
      int               rc, packetCount = 0;
--- 341,346 ----
  /* ---------------------------------------------------------------------------
   */
! void
! cAVCPlayer::Action(void)
  {
      int               rc, packetCount = 0;
***************
*** 333,338 ****
        break;
      }
!     if (paused)
        continue;
  
      av_dup_packet(&pkt);
--- 384,395 ----
        break;
      }
!     if (paused) {
!       DeviceFreeze();
!       cPlayer::DeviceClear();
!       while (paused && running)
!         usleep(10000);
!       DevicePlay();
        continue;
+     }
  
      av_dup_packet(&pkt);
***************
*** 343,347 ****
      }
  
-     // length = -2 : queue packet
      pDevice->PlayVideo((uchar *)&pkt,-2);
  
--- 400,403 ----
***************
*** 375,379 ****
  /* ---------------------------------------------------------------------------
   */
! void cAVCPlayer::Command(eKeys key)
  {
  
--- 431,436 ----
  /* ---------------------------------------------------------------------------
   */
! void
! cAVCPlayer::Command(eKeys key)
  {
  
***************
*** 465,469 ****
  /* ---------------------------------------------------------------------------
   */
! void cAVCControl::Hide(void)
  {
    dsyslog("[AVCControl-Hide]");
--- 522,527 ----
  /* ---------------------------------------------------------------------------
   */
! void
! cAVCControl::Hide(void)
  {
    dsyslog("[AVCControl-Hide]");
***************
*** 472,476 ****
  /* ---------------------------------------------------------------------------
   */
! eOSState cAVCControl::ProcessKey(eKeys key)
  {
      eOSState state = cOsdObject::ProcessKey(key);
--- 530,535 ----
  /* ---------------------------------------------------------------------------
   */
! eOSState
! cAVCControl::ProcessKey(eKeys key)
  {
      eOSState state = cOsdObject::ProcessKey(key);
***************
*** 488,492 ****
  
      switch (key) {
!       case kPause: case kPlay: case kFastFwd: case kFastRew:
          player->Command(key);
          break;
--- 547,551 ----
  
      switch (key) {
!       case kPause: case kPlay: case kFastFwd: case kFastRew: case kStop:
          player->Command(key);
          break;

Index: avc-handler.h
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/avc-handler.h,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -C2 -d -r1.1.1.1 -r1.2
*** avc-handler.h	1 May 2005 22:05:08 -0000	1.1.1.1
--- avc-handler.h	12 Sep 2005 12:17:07 -0000	1.2
***************
*** 34,37 ****
--- 34,39 ----
      octlet_t          deviceId[MAX_IEEE1394_DEVICES];
      bool              active;
+     int               micSize[MAX_IEEE1394_DEVICES];
+     unsigned char     *micData[MAX_IEEE1394_DEVICES];
      rom1394_directory romDirs[MAX_IEEE1394_DEVICES];
      raw1394handle_t   handle;
***************
*** 48,52 ****
  
      octlet_t        GetGuidForName(const char *name);
!     const char      *GetDeviceNameAt(int i);
      virtual void    Action(void);
  
--- 50,57 ----
  
      octlet_t        GetGuidForName(const char *name);
!     const char      *GetDeviceNameAt(int i),
!                     *TapePosition(int i, char *pos);
!     int             NumDevices(void);
!     bool            HasMicInfo(int i);
      virtual void    Action(void);
  

Index: softieee1394.c
===================================================================
RCS file: /cvsroot/softdevice/softieee1394/softieee1394.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** softieee1394.c	24 Jul 2005 20:40:04 -0000	1.2
--- softieee1394.c	12 Sep 2005 12:17:07 -0000	1.3
***************
*** 17,20 ****
--- 17,57 ----
  static const char *MAINMENUENTRY  = "Softieee1394";
  
+ #define DEVICE_UNKNOWN    0
+ #define DEVICE_IEEE1394   1
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ class cDeviceOsdItem : public cOsdItem
+ {
+   private:
+     char  *deviceName;
+     int   deviceType;
+ 
+   public:
+     cDeviceOsdItem(const char *name, int type, char *text,
+                    eOSState state = osUnknown);
+     virtual ~cDeviceOsdItem();
+ 
+     char *DeviceName() { return deviceName; }
+     int  DeviceType() { return deviceType; }
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ cDeviceOsdItem::cDeviceOsdItem(const char *name, int type,
+                                char *text, eOSState state)
+                                : cOsdItem (text, state)
+ {
+   deviceName = strdup (name);
+   deviceType = type;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ cDeviceOsdItem::~cDeviceOsdItem()
+ {
+   free(deviceName);
+ }
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 37,72 ****
  {
    this->avcHandler = avcHandler;
! };
  
  /* ---------------------------------------------------------------------------
   */
! cMenuDevices::~cMenuDevices(void) {};
  
  /* ---------------------------------------------------------------------------
   */
! void cMenuDevices::GetDeviceNames(void)
  {
      int         i = 0;
      const char  *name;
  
!   while ((name = avcHandler->GetDeviceNameAt(i++)))
!   {
!     Add(new cOsdItem(name,osUnknown),false);
    }
  }
  
! eOSState cMenuDevices::ProcessKey(eKeys key)
  {
      eOSState  state = cOsdMenu::ProcessKey(key);
      octlet_t  devId;
  
!   if (state == osUnknown)
!   {
!     switch (key)
!     {
        case kOk:
!         devId = avcHandler->GetGuidForName(Get(Current())->Text());
!         if (devId)
!         {
            cControl::Launch(new cAVCControl(devId));
          }
--- 74,120 ----
  {
    this->avcHandler = avcHandler;
! }
  
  /* ---------------------------------------------------------------------------
   */
! cMenuDevices::~cMenuDevices(void)
! {
! }
  
  /* ---------------------------------------------------------------------------
   */
! void
! cMenuDevices::GetDeviceNames(void)
  {
      int         i = 0;
      const char  *name;
  
!   while ((name = avcHandler->GetDeviceNameAt(i))) {
!       char  buf[100],
!             tapePos [16];
! 
!     snprintf (buf, 100, "%11.11s            %s",
!               avcHandler->TapePosition(i, tapePos),
!               name);
!     Add(new cDeviceOsdItem(name, DEVICE_IEEE1394, buf,osUnknown),false);
!     ++i;
    }
  }
  
! /* ---------------------------------------------------------------------------
!  */
! eOSState
! cMenuDevices::ProcessKey(eKeys key)
  {
      eOSState  state = cOsdMenu::ProcessKey(key);
      octlet_t  devId;
+     cDeviceOsdItem  *osdItem;
  
!   if (state == osUnknown) {
!     switch (key) {
        case kOk:
!         osdItem = (cDeviceOsdItem *) (Get(Current()));
!         devId = avcHandler->GetGuidForName(osdItem->DeviceName());
!         if (devId) {
            cControl::Launch(new cAVCControl(devId));
          }
***************
*** 81,105 ****
  /* ---------------------------------------------------------------------------
   */
! class cPluginSoftieee1394 : public cPlugin {
! private:
!   // Add any member variables or functions you may need here.
!   cAVCHandler   *avcHandler;
  
! public:
!   cPluginSoftieee1394(void);
!   virtual ~cPluginSoftieee1394();
!   virtual const char *Version(void) { return VERSION; }
!   virtual const char *Description(void) { return tr(DESCRIPTION); }
!   virtual const char *CommandLineHelp(void);
!   virtual bool ProcessArgs(int argc, char *argv[]);
!   virtual bool Initialize(void);
!   virtual bool Start(void);
!   virtual void Stop(void);
!   virtual void Housekeeping(void);
!   virtual const char *MainMenuEntry(void) { return tr(MAINMENUENTRY); }
!   virtual cOsdObject *MainMenuAction(void);
!   virtual cMenuSetupPage *SetupMenu(void);
!   virtual bool SetupParse(const char *Name, const char *Value);
!   };
  
  /* ---------------------------------------------------------------------------
--- 129,154 ----
  /* ---------------------------------------------------------------------------
   */
! class cPluginSoftieee1394 : public cPlugin
! {
!   private:
!     // Add any member variables or functions you may need here.
!     cAVCHandler   *avcHandler;
  
!   public:
!     cPluginSoftieee1394(void);
!     virtual ~cPluginSoftieee1394();
!     virtual const char *Version(void) { return VERSION; }
!     virtual const char *Description(void) { return tr(DESCRIPTION); }
!     virtual const char *CommandLineHelp(void);
!     virtual bool ProcessArgs(int argc, char *argv[]);
!     virtual bool Initialize(void);
!     virtual bool Start(void);
!     virtual void Stop(void);
!     virtual void Housekeeping(void);
!     virtual const char *MainMenuEntry(void);
!     virtual cOsdObject *MainMenuAction(void);
!     virtual cMenuSetupPage *SetupMenu(void);
!     virtual bool SetupParse(const char *Name, const char *Value);
! };
  
  /* ---------------------------------------------------------------------------
***************
*** 121,125 ****
  /* ---------------------------------------------------------------------------
   */
! const char *cPluginSoftieee1394::CommandLineHelp(void)
  {
    // Return a string that describes all known command line options.
--- 170,175 ----
  /* ---------------------------------------------------------------------------
   */
! const char *
! cPluginSoftieee1394::CommandLineHelp(void)
  {
    // Return a string that describes all known command line options.
***************
*** 129,133 ****
  /* ---------------------------------------------------------------------------
   */
! bool cPluginSoftieee1394::ProcessArgs(int argc, char *argv[])
  {
    // Implement command line argument processing here if applicable.
--- 179,184 ----
  /* ---------------------------------------------------------------------------
   */
! bool
! cPluginSoftieee1394::ProcessArgs(int argc, char *argv[])
  {
    // Implement command line argument processing here if applicable.
***************
*** 137,141 ****
  /* ---------------------------------------------------------------------------
   */
! bool cPluginSoftieee1394::Initialize(void)
  {
    // Initialize any background activities the plugin shall perform.
--- 188,193 ----
  /* ---------------------------------------------------------------------------
   */
! bool
! cPluginSoftieee1394::Initialize(void)
  {
    // Initialize any background activities the plugin shall perform.
***************
*** 146,150 ****
  /* ---------------------------------------------------------------------------
   */
! bool cPluginSoftieee1394::Start(void)
  {
    // Start any background activities the plugin shall perform.
--- 198,203 ----
  /* ---------------------------------------------------------------------------
   */
! bool
! cPluginSoftieee1394::Start(void)
  {
    // Start any background activities the plugin shall perform.
***************
*** 155,159 ****
  /* ---------------------------------------------------------------------------
   */
! void cPluginSoftieee1394::Stop(void)
  {
    // Stop any background activities the plugin shall perform.
--- 208,213 ----
  /* ---------------------------------------------------------------------------
   */
! void
! cPluginSoftieee1394::Stop(void)
  {
    // Stop any background activities the plugin shall perform.
***************
*** 162,166 ****
  /* ---------------------------------------------------------------------------
   */
! void cPluginSoftieee1394::Housekeeping(void)
  {
    // Perform any cleanup or other regular tasks.
--- 216,221 ----
  /* ---------------------------------------------------------------------------
   */
! void
! cPluginSoftieee1394::Housekeeping(void)
  {
    // Perform any cleanup or other regular tasks.
***************
*** 169,173 ****
  /* ---------------------------------------------------------------------------
   */
! cOsdObject *cPluginSoftieee1394::MainMenuAction(void)
  {
      cMenuDevices *Menu=new cMenuDevices (avcHandler);
--- 224,238 ----
  /* ---------------------------------------------------------------------------
   */
! const char *cPluginSoftieee1394::MainMenuEntry(void)
! {
!   if (avcHandler && avcHandler->NumDevices() > 0)
!     return MAINMENUENTRY;
!   return NULL;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! cOsdObject *
! cPluginSoftieee1394::MainMenuAction(void)
  {
      cMenuDevices *Menu=new cMenuDevices (avcHandler);
***************
*** 184,188 ****
  /* ---------------------------------------------------------------------------
   */
! cMenuSetupPage *cPluginSoftieee1394::SetupMenu(void)
  {
    // Return a setup menu in case the plugin supports one.
--- 249,254 ----
  /* ---------------------------------------------------------------------------
   */
! cMenuSetupPage *
! cPluginSoftieee1394::SetupMenu(void)
  {
    // Return a setup menu in case the plugin supports one.
***************
*** 192,196 ****
  /* ---------------------------------------------------------------------------
   */
! bool cPluginSoftieee1394::SetupParse(const char *Name, const char *Value)
  {
    // Parse your own setup parameters and store their values.
--- 258,263 ----
  /* ---------------------------------------------------------------------------
   */
! bool
! cPluginSoftieee1394::SetupParse(const char *Name, const char *Value)
  {
    // Parse your own setup parameters and store their values.



From nobody at sheep.berlios.de  Thu Sep 15 20:23:08 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 15 Sep 2005 20:23:08 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.107,1.108 configure,1.2,1.3 video-dfb.c,1.39,1.40
Message-ID: <200509151823.j8FIN8104352@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20129

Modified Files:
	CHANGELOG configure video-dfb.c 
Log Message:
video-dfb: keyrepeat handling + configure check for DIET_REPEAT

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.107
retrieving revision 1.108
diff -C2 -d -r1.107 -r1.108
*** CHANGELOG	11 Sep 2005 09:22:30 -0000	1.107
--- CHANGELOG	15 Sep 2005 18:23:05 -0000	1.108
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-09-15:
+     - video-dfb: keyrepeat handling + configure check for DIET_REPEAT
  2005-09-11:
      - fix for segfaults with some OSD activity

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** configure	11 Sep 2005 08:22:39 -0000	1.2
--- configure	15 Sep 2005 18:23:05 -0000	1.3
***************
*** 77,80 ****
--- 77,81 ----
  dfb_sourcelocation="yes"
  dfb_dscaps_double="yes"
+ dfb_dief_repeat="yes"
  
  cat > ${TMPC} << EOF
***************
*** 116,119 ****
--- 117,132 ----
  $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dscaps_double="no"
  
+ cat > ${TMPC} << EOF
+ #include <stdio.h>
+ #include <dfb++.h>
+ #include <directfb.h>
+ int main(void) {
+     DFBInputEvent event;
+   event.flags |= DIEF_REPEAT;
+   return 0;
+ }
+ EOF
+ $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dief_repeat="no"
+ 
    fi
  fi
***************
*** 213,216 ****
--- 226,235 ----
    else
      echo "#define HAVE_DSCAPS_DOUBLE              0" >> $TMPH
+   fi
+ 
+   if test "${dfb_dfb_dief_repeat}" = "yes" ; then
+     echo "#define HAVE_DIEF_REPEAT                1" >> $TMPH
+   else
+     echo "#define HAVE_DIEF_REPEAT                0" >> $TMPH
    fi
  fi

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** video-dfb.c	4 Sep 2005 05:49:18 -0000	1.39
--- video-dfb.c	15 Sep 2005 18:23:05 -0000	1.40
***************
*** 21,26 ****
--- 21,28 ----
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
  #   define HAVE_GraphicsDeviceDescription 0
+ #   define HAVE_DIEF_REPEAT               0
  # else
  #   define HAVE_GraphicsDeviceDescription 1
+ #   define HAVE_DIEF_REPEAT               1
  # endif
  # if (DIRECTFB_MAJOR_VERSION > 0 || ((DIRECTFB_MINOR_VERSION == 9) && DIRECTFB_MICRO_VERSION > 22))
***************
*** 563,593 ****
    while (events->GetEvent( DFB_EVENT(&event) ))
    {
!     switch (event.type)
      {
!       case DIET_KEYPRESS:
! #ifdef DFB_SUPPORTS_REPEAT
!       case DIET_KEYREPEAT:
! #endif /* DFB_SUPPORTS_REPEAT */
!         if (dfbRemote)
!         {
!           switch (event.key_symbol)
!           {
!             case DIKS_SHIFT: case DIKS_CONTROL: case DIKS_ALT:
!             case DIKS_ALTGR: case DIKS_META: case DIKS_SUPER: case DIKS_HYPER:
!               break;
!             default:
!               if (event.type != DIET_KEYPRESS ||
!                   !setupStore->CatchRemoteKey(dfbRemote->Name(),
!                                               event.key_symbol))
!               {
!                 dfbRemote->PutKey(event.key_symbol,
!                                   event.type != DIET_KEYPRESS);
!               }
!               break;
!           }
!         }
          break;
        default:
          break;
      }
    }
--- 565,586 ----
    while (events->GetEvent( DFB_EVENT(&event) ))
    {
!     if (event.type == DIET_KEYPRESS && dfbRemote)
      {
!       switch (event.key_symbol)
!       {
!       case DIKS_SHIFT: case DIKS_CONTROL: case DIKS_ALT:
!       case DIKS_ALTGR: case DIKS_META: case DIKS_SUPER: case DIKS_HYPER:
          break;
        default:
+         if (!setupStore->CatchRemoteKey(dfbRemote->Name(), event.key_symbol))
+         {
+ #if HAVE_DIEF_REPEAT
+           dfbRemote->PutKey(event.key_symbol, event.flags & DIEF_REPEAT);
+ #else
+           dfbRemote->PutKey(event.key_symbol, false);
+ #endif
+         }
          break;
+       }
      }
    }



From nobody at sheep.berlios.de  Thu Sep 15 21:08:25 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 15 Sep 2005 21:08:25 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.108,1.109 video.c,1.30,1.31 video.h,1.21,1.22
Message-ID: <200509151908.j8FJ8P105466@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24932

Modified Files:
	CHANGELOG video.c video.h 
Log Message:
modified previous OSD redraw handling (timed redraw after _all_ OSD bitmaps have been drawn)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.108
retrieving revision 1.109
diff -C2 -d -r1.108 -r1.109
*** CHANGELOG	15 Sep 2005 18:23:05 -0000	1.108
--- CHANGELOG	15 Sep 2005 19:08:22 -0000	1.109
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-09-15:
+     - modified previous OSD redraw handling (timed redraw after _all_ OSD bitmaps
+       have been drawn)
      - video-dfb: keyrepeat handling + configure check for DIET_REPEAT
  2005-09-11:

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** video.c	11 Sep 2005 09:22:30 -0000	1.30
--- video.c	15 Sep 2005 19:08:22 -0000	1.31
***************
*** 25,28 ****
--- 25,29 ----
    cutTop = cutBottom = cutLeft = cutRight = 0;
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
+   Osd_changed = Osd_Bitmap_changed = 0;
    PixelMask=NULL;
    OsdRefreshCounter=0;
***************
*** 109,112 ****
--- 110,114 ----
                           OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
        }
+       
        osdMutex.Lock();
        Osd_changed=0;
***************
*** 465,468 ****
--- 467,477 ----
    OSDdirty=false;
    OSDpresent=true;
+ #if VDRVERSNUM >= 10307
+   if (Osd_Bitmap_changed)
+   {
+     Osd_Bitmap_changed = 0;
+     Osd_changed = 1;
+   }
+ #endif
    osdMutex.Unlock();
  }
***************
*** 472,476 ****
  void cVideoOut::ClearOSD()
  {
!   //if (current_osdMode==OSDMODE_SOFTWARE) 
    {
      if (OsdPy)
--- 481,485 ----
  void cVideoOut::ClearOSD()
  {
!   //if (current_osdMode==OSDMODE_SOFTWARE)
    {
      if (OsdPy)
***************
*** 727,731 ****
    
   // printf( "YUV:OSDWidth %d %d Bitmap %d %d \n",
!  //   OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
   
      int           x1,x2,y1,y2;
--- 736,740 ----
    
   // printf( "YUV:OSDWidth %d %d Bitmap %d %d \n",
!  //   OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height());
   
      int           x1,x2,y1,y2;
***************
*** 734,738 ****
        return;
      
!   Osd_changed=1;
     //printf( "----------------------------\nOSDWidth %d %d Bitmap %d %d \n",
     //     OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 
--- 743,747 ----
        return;
      
!   Osd_Bitmap_changed=1;
     //printf( "----------------------------\nOSDWidth %d %d Bitmap %d %d \n",
     //     OsdWidth,OsdHeight,Bitmap->Width(),Bitmap->Height()); 

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** video.h	11 Sep 2005 09:22:30 -0000	1.21
--- video.h	15 Sep 2005 19:08:22 -0000	1.22
***************
*** 158,162 ****
  
      uint8_t *PixelMask;
!     int Osd_changed;
      uint8_t *OsdPy;
      uint8_t *OsdPu; 
--- 158,163 ----
  
      uint8_t *PixelMask;
!     int     Osd_changed,
!             Osd_Bitmap_changed;
      uint8_t *OsdPy;
      uint8_t *OsdPu; 



From nobody at sheep.berlios.de  Fri Sep 16 18:13:20 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 16 Sep 2005 18:13:20 +0200
Subject: [Softdevice-cvs] softdevice audio.c,1.20,1.21
Message-ID: <200509161613.j8GGDK116064@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4393

Modified Files:
	audio.c 
Log Message:
- add audio debug
- return 0 if pcm is not running



Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** audio.c	6 Sep 2005 21:55:27 -0000	1.20
--- audio.c	16 Sep 2005 16:13:18 -0000	1.21
***************
*** 16,23 ****
--- 16,31 ----
  #include <alsa/asoundlib.h>
  #include "audio.h"
+ #include "utils.h"
  
  
  #define PCM_FMT SND_PCM_FORMAT_S16_LE
  
+ //#define AUDIODEB(out...) {printf("AUDIO[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
+ 
+ #ifndef AUDIODEB
+ #define AUDIODEB(out...)
+ #endif
+ 
+ 
  cAudioOut::~cAudioOut() {
  }
***************
*** 81,84 ****
--- 89,93 ----
      int err;
      size_t size;
+     AUDIODEB("Write %p %d\n",Data,Length);
  
    if (ac3PassThrough)
***************
*** 90,104 ****
--- 99,120 ----
    while (size) {
      while (paused) usleep(1000); // block
+     AUDIODEB("pcm_mmap_writei  handle %p Data %p size %d\n",handle,Data,size);
      err = snd_pcm_mmap_writei(handle,Data, size);
+     AUDIODEB("pcm_mmap_writeei return value %d Data %p size %d \n",
+                    err,Data,size);
      if (err == -EAGAIN || (err >= 0 && (size_t)err < size)) {
+       AUDIODEB("wait \n");
        snd_pcm_wait(handle, 1000);
      } else if (err == -EPIPE) {
+       AUDIODEB("Xrun \n");
        Xrun();
        dsyslog("[softdevice-audio]: xrun");
      } else if (err == -ESTRPIPE) {
        //suspend();
+       AUDIODEB("Suspend \n");
        dsyslog("[softdevice-audio]: Suspend");
      } else if (err == -EINTR) {
        dsyslog ("[softdevice-audio]: EINTR");
+       AUDIODEB("EINTR \n");
        return;
      } else if (err < 0) {
***************
*** 113,116 ****
--- 129,133 ----
      };
    }
+   AUDIODEB("Write end\n");
  }
  
***************
*** 206,213 ****
--- 223,241 ----
  
    handleMutex.Lock();
+   if (!handle) {
+           handleMutex.Unlock();
+           return 0;
+   };
+   
+   if ( snd_pcm_state(handle) != SND_PCM_STATE_RUNNING ) {
+           handleMutex.Unlock();
+           return 0;
+   };
+           
    if (!snd_pcm_delay(handle, &r) &&
        currContext.samplerate) {
      // successfully got delay
      res = (long) r * 10000 / currContext.samplerate;
+     AUDIODEB("GetDelay %d\n",res);
    }
    handleMutex.Unlock();



From nobody at sheep.berlios.de  Fri Sep 16 18:16:41 2005
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 16 Sep 2005 18:16:41 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.109,1.110
Message-ID: <200509161616.j8GGGf116211@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4664

Modified Files:
	CHANGELOG 
Log Message:
- add audio debug
- return 0 in GetDelay() if pcm is not running


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.109
retrieving revision 1.110
diff -C2 -d -r1.109 -r1.110
*** CHANGELOG	15 Sep 2005 19:08:22 -0000	1.109
--- CHANGELOG	16 Sep 2005 16:16:38 -0000	1.110
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-09-16:
+     - introduce audio debug
+     - return 0 in GetDelay if pcm is not running
  2005-09-15:
      - modified previous OSD redraw handling (timed redraw after _all_ OSD bitmaps



From nobody at sheep.berlios.de  Sat Sep 17 18:17:17 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 17 Sep 2005 18:17:17 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.110,1.111 configure,1.3,1.4
Message-ID: <200509171617.j8HGHH124773@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28580

Modified Files:
	CHANGELOG configure 
Log Message:
check if vidix compiles, optionally disable fb-out via command line "--disable-fb" and/or subplugins via "--disable-subplugins"


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.110
retrieving revision 1.111
diff -C2 -d -r1.110 -r1.111
*** CHANGELOG	16 Sep 2005 16:16:38 -0000	1.110
--- CHANGELOG	17 Sep 2005 16:17:15 -0000	1.111
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-09-17
+     - configure: check if vidix compiles, optionally disable fb-out via
+                  command line "--disable-fb" and/or subplugins via "--disable-subplugins"
  2005-09-16:
      - introduce audio debug

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** configure	15 Sep 2005 18:23:05 -0000	1.3
--- configure	17 Sep 2005 16:17:15 -0000	1.4
***************
*** 20,24 ****
  vidix="yes"
  vidix_path="/usr/local"
- subplugins="yes"
  with_fb="yes"
  fb_dev_name="/dev/fb0"
--- 20,23 ----
***************
*** 31,36 ****
--- 30,37 ----
    echo "available options are:"
    echo "  --disable-vidix"
+   echo "  --disable-fb"
    echo "  --disable-dfb"
    echo "  --disable-xv"
+   echo "  --disable-subplugins"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
    echo "  --help"
***************
*** 41,46 ****
--- 42,49 ----
    case $1 in
      --disable-vidix) shift; vidix="no" ;;
+     --disable-fb) shift; with_fb="no" ;;
      --disable-dfb) shift; dfb="no" ;;
      --disable-xv) shift; xv="no" ;;
+     --disable-subplugins) shift; with_subplugins="no" ;;
      --with-vidix-path) shift;
        vidix_path=$1 ;
***************
*** 57,61 ****
  ffmpeg_l1="libavcodec libavformat"
  
- # pkg-config --libs libavutil 2>/dev/null && ffmpeg_l1="$ffmpeg_l1 libavutil"
  pkg-config --libs libpostproc >/dev/null 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
--- 60,63 ----
***************
*** 133,140 ****
  # end of DirectFB specific tests
  
! ## echo ${dfb_opts}
! ## echo dfb_device_desc = ${dfb_device_desc}
  
! ###########
  broken_gcc_cpp="no"
  cat > ${TMPC} << EOF
--- 135,156 ----
  # end of DirectFB specific tests
  
! #########################################################
! # vidix: check if we could compile with specified options
! #
! if test "${vidix}" = "yes" ; then
!   vidix_cflags="-I${vidix_path}/include/vidix"
!   vidix_libs="-L${vidix_path}/lib -lvidix"
!   cat > ${TMPC} << EOF
! #include <stdio.h>
! #include "vidixlib.h"
! int main(void) {
!     vidix_capability_t vidix_cap;
!   return 0;
! }
! EOF
! $cc $CFLAGS $vidix_cflags $vidix_libs -o $TMPE $TMPC > /dev/null 2>&1 || vidix="no"
! fi
  
! #########################################################
  broken_gcc_cpp="no"
  cat > ${TMPC} << EOF
***************
*** 177,181 ****
  ###########
  
! echo "Creating temporay config.h and config.mak"
  echo "/* Generated by configure - do not modify */" > $TMPH
  echo "# Generated by configure - do not modify" > $TMPM
--- 193,197 ----
  ###########
  
! echo "Creating temporary config.h and config.mak"
  echo "/* Generated by configure - do not modify */" > $TMPH
  echo "# Generated by configure - do not modify" > $TMPM
***************
*** 241,246 ****
    echo "VIDIX_SUPPORT = 1" >> $TMPM
    echo "VIDIX_DIR     = ${vidix_path}" >> $TMPM
!   echo "VIDIX_LIBS    = -L${vidix_path}/lib -lvidix" >> $TMPM
!   echo "VIDIX_CFLAGS  = -I${vidix_path}/include/vidix" >> $TMPM
    echo "#define VIDIX_SUPPORT 1" >> $TMPH
    echo "#define VIDIX_DIR     \"${vidix_path}/lib/vidix\"" >> $TMPH
--- 257,262 ----
    echo "VIDIX_SUPPORT = 1" >> $TMPM
    echo "VIDIX_DIR     = ${vidix_path}" >> $TMPM
!   echo "VIDIX_LIBS    = ${vidix_libs}" >> $TMPM
!   echo "VIDIX_CFLAGS  = ${vidix_cflags}" >> $TMPM
    echo "#define VIDIX_SUPPORT 1" >> $TMPH
    echo "#define VIDIX_DIR     \"${vidix_path}/lib/vidix\"" >> $TMPH



From nobody at sheep.berlios.de  Sun Sep 18 07:55:35 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 18 Sep 2005 07:55:35 +0200
Subject: [Softdevice-cvs] softdevice Makefile,1.15,1.16 CHANGELOG,1.111,1.112
Message-ID: <200509180555.j8I5tZ113290@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27612

Modified Files:
	Makefile CHANGELOG 
Log Message:
compatibility for build without configure


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** Makefile	10 Sep 2005 19:52:22 -0000	1.15
--- Makefile	18 Sep 2005 05:55:32 -0000	1.16
***************
*** 123,126 ****
--- 123,130 ----
  DEFINES	   += -DUSE_MMX2
  
+ ### Allow user defined options to overwrite defaults:
+ 
+ -include $(VDRDIR)/Make.config
+ 
  # #############################################################################
  # moved some defines to this section, as they are generated by
***************
*** 172,175 ****
--- 176,183 ----
    DEFINES += -DHAVE_CONFIG
  
+ ### Allow user defined options to overwrite defaults:
+ 
+ -include $(VDRDIR)/Make.config
+ 
  endif  # WITH_CONFIGURE
  
***************
*** 181,188 ****
  ### The directory environment:
  
- 
- ### Allow user defined options to overwrite defaults:
- 
- -include $(VDRDIR)/Make.config
  
  ### The version number of VDR (taken from VDR's "config.h"):
--- 189,192 ----

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.111
retrieving revision 1.112
diff -C2 -d -r1.111 -r1.112
*** CHANGELOG	17 Sep 2005 16:17:15 -0000	1.111
--- CHANGELOG	18 Sep 2005 05:55:32 -0000	1.112
***************
*** 1,4 ****
  Changelog
! 2005-09-17
      - configure: check if vidix compiles, optionally disable fb-out via
                   command line "--disable-fb" and/or subplugins via "--disable-subplugins"
--- 1,6 ----
  Changelog
! 2005-09-18:
!     - Makefile: compatibility for build without configure
! 2005-09-17:
      - configure: check if vidix compiles, optionally disable fb-out via
                   command line "--disable-fb" and/or subplugins via "--disable-subplugins"



From nobody at sheep.berlios.de  Sun Sep 18 17:17:47 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 18 Sep 2005 17:17:47 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.112,1.113 Makefile,1.16,1.17 softdevice.c,1.41,1.42
Message-ID: <200509181517.j8IFHl128640@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22877

Modified Files:
	CHANGELOG Makefile softdevice.c 
Log Message:
changed prefix from libvdr to libsubvdr. so it doesn't interfere with vdr's "load all plugins" for plain help command.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.112
retrieving revision 1.113
diff -C2 -d -r1.112 -r1.113
*** CHANGELOG	18 Sep 2005 05:55:32 -0000	1.112
--- CHANGELOG	18 Sep 2005 15:17:44 -0000	1.113
***************
*** 2,5 ****
--- 2,7 ----
  2005-09-18:
      - Makefile: compatibility for build without configure
+     - subplugin targets: changed prefix from libvdr to libsubvdr. so it doesn't
+       interfere with vdr's "load all plugins" for plain help command.
  2005-09-17:
      - configure: check if vidix compiles, optionally disable fb-out via

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** Makefile	18 Sep 2005 05:55:32 -0000	1.16
--- Makefile	18 Sep 2005 15:17:44 -0000	1.17
***************
*** 217,221 ****
      DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
!     TARGETS  += libvdr-$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
--- 217,221 ----
      DFB_OBJS  = utils.o video.o video-dfb.o
      ALL_OBJS += $(DFB_OBJS)
!     TARGETS  += libsubvdr-$(PLUGIN)-dfb.so
    else
      OBJS     += video-dfb.o
***************
*** 230,234 ****
      FB_OBJS   = utils.o video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
!     TARGETS   += libvdr-$(PLUGIN)-fb.so
    else
      OBJS 	+= video-fb.o
--- 230,234 ----
      FB_OBJS   = utils.o video.o video-fb.o
      ALL_OBJS  += $(FB_OBJS)
!     TARGETS   += libsubvdr-$(PLUGIN)-fb.so
    else
      OBJS 	+= video-fb.o
***************
*** 240,244 ****
      XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
!     TARGETS   += libvdr-$(PLUGIN)-xv.so
    else
      OBJS 	+= video-xv.o xscreensaver.o
--- 240,244 ----
      XV_OBJS   = utils.o video.o video-xv.o xscreensaver.o
      ALL_OBJS  += $(XV_OBJS)
!     TARGETS   += libsubvdr-$(PLUGIN)-xv.so
    else
      OBJS 	+= video-xv.o xscreensaver.o
***************
*** 251,255 ****
      VIDIX_OBJS  = utils.o video.o video-vidix.o
      ALL_OBJS    += $(VIDIX_OBJS)
!     TARGETS     += libvdr-$(PLUGIN)-vidix.so
    else
      OBJS        += video-vidix.o
--- 251,255 ----
      VIDIX_OBJS  = utils.o video.o video-vidix.o
      ALL_OBJS    += $(VIDIX_OBJS)
!     TARGETS     += libsubvdr-$(PLUGIN)-vidix.so
    else
      OBJS        += video-vidix.o
***************
*** 285,301 ****
  ifdef USE_SUBPLUGINS
  
! libvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
! libvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
! libvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
! libvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
--- 285,301 ----
  ifdef USE_SUBPLUGINS
  
! libsubvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
! libsubvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
! libsubvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
  
! libsubvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
  	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** softdevice.c	10 Sep 2005 19:43:21 -0000	1.41
--- softdevice.c	18 Sep 2005 15:17:44 -0000	1.42
***************
*** 343,347 ****
              "%s/%s%s.so.%s",
              pluginPath,
!             "libvdr-softdevice-",
              outMethodName,
              VDRVERSION);
--- 343,347 ----
              "%s/%s%s.so.%s",
              pluginPath,
!             "libsubvdr-softdevice-",
              outMethodName,
              VDRVERSION);



