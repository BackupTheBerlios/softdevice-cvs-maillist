From nobody at sheep.berlios.de  Tue Apr  3 21:08:11 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:08:11 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c, 1.72,
	1.73 mpeg2decoder.h, 1.41, 1.42 VideoFilter.c, 1.3,
	1.4 VideoFilter.h, 1.1, 1.2 setup-softdevice-menu.c, 1.10,
	1.11 setup-softdevice.c, 1.50, 1.51 setup-softdevice.h, 1.38,
	1.39 CHANGELOG, 1.301, 1.302
Message-ID: <20070403190811.62DBA2D233@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4342

Modified Files:
	mpeg2decoder.c mpeg2decoder.h VideoFilter.c VideoFilter.h 
	setup-softdevice-menu.c setup-softdevice.c setup-softdevice.h 
	CHANGELOG 
Log Message:
- add automatic border detection, based on a patch by Roland Praml.


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.72
retrieving revision 1.73
diff -C2 -d -r1.72 -r1.73
*** mpeg2decoder.c	26 Feb 2007 23:00:34 -0000	1.72
--- mpeg2decoder.c	3 Apr 2007 19:06:17 -0000	1.73
***************
*** 553,561 ****
  
      pic->base[i]= buf->pixel[i];
!     if(EmuEdge) {
        pic->data[i] = buf->pixel[i];
!       buf->edge_width=buf->edge_height=0;
!     } else {
!       buf->edge_width=buf->edge_height=EDGE_WIDTH;
        pic->data[i] = buf->pixel[i] + (buf->stride[i]*
            EDGE_WIDTH>>v_shift) + (EDGE_WIDTH>>h_shift);
--- 553,559 ----
  
      pic->base[i]= buf->pixel[i];
!     if(EmuEdge) 
        pic->data[i] = buf->pixel[i];
!      else 
        pic->data[i] = buf->pixel[i] + (buf->stride[i]*
            EDGE_WIDTH>>v_shift) + (EDGE_WIDTH>>h_shift);
***************
*** 563,569 ****
        //              EDGE_WIDTH>>v_shift) + (EDGE_WIDTH>>h_shift),
        //              STRIDE_ALIGN);
-     };
      pic->linesize[i]= buf->stride[i];
    }
    pic->age=buf->age;
  
--- 561,570 ----
        //              EDGE_WIDTH>>v_shift) + (EDGE_WIDTH>>h_shift),
        //              STRIDE_ALIGN);
      pic->linesize[i]= buf->stride[i];
    }
+   if(EmuEdge) 
+     buf->edge_width=buf->edge_height=0;
+   else 
+     buf->edge_width=buf->edge_height=EDGE_WIDTH;
    pic->age=buf->age;
  
***************
*** 588,592 ****
                                           bool packetMode)
       : cStreamDecoder(Context, packetMode), Mirror(VideoOut),
!        DeintLibav(VideoOut)
  #ifdef PP_LIBAVCODEC
         ,LibAvPostProc(VideoOut)
--- 589,593 ----
                                           bool packetMode)
       : cStreamDecoder(Context, packetMode), Mirror(VideoOut),
!        DeintLibav(VideoOut), BorderDetect(VideoOut)
  #ifdef PP_LIBAVCODEC
         ,LibAvPostProc(VideoOut)
***************
*** 878,881 ****
--- 879,885 ----
        DeintLibav.Filter(pic,pic);
  
+     if (setupStore.autodetectAspect)
+             BorderDetect.Filter(pic,pic);
+     
  #ifdef PP_LIBAVCODEC
  #ifdef FB_SUPPORT

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** mpeg2decoder.h	25 Mar 2007 08:54:12 -0000	1.41
--- mpeg2decoder.h	3 Apr 2007 19:06:17 -0000	1.42
***************
*** 232,235 ****
--- 232,236 ----
      cVideoMirror        Mirror;
      cDeintLibav         DeintLibav;
+     cBorderDetect       BorderDetect;
  #ifdef PP_LIBAVCODEC
      cLibAvPostProc      LibAvPostProc;

Index: VideoFilter.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** VideoFilter.c	30 May 2006 18:57:21 -0000	1.3
--- VideoFilter.c	3 Apr 2007 19:06:17 -0000	1.4
***************
*** 42,45 ****
--- 42,46 ----
                          return false;
          };
+         dest->edge_width=dest->edge_height=0;
          return true;
  };
***************
*** 269,272 ****
--- 270,409 ----
          }
      CopyPicBufferContext(dest,orig);
+ }
+ 
+ /*---------------------------cBorderDetect---------------------------------*/
+ /*
+ 
+ Based on a patch by Roland Praml.
+ 
+ How Borderdetection works:
+ Scan the picture from top and bottom to the middle for bright lines, omitting
+ 1/6 of the width on left and right side. After BODER_MIN_SIZE lines which are
+ on average brigther than BORDER_BLACK, stop scanning. During the scan, edges
+ are detected by subtracting the top (bottom) pixel from the current pixel. 
+ If more than 1/6*width of the differences are greater than EDGE_DIFF, the
+ position is marked as an edge.
+ 
+ */
+ #define BORDER_MIN_SIZE 4
+ #define FRAMES_BEFORE_SWITCH 25
+ #define BORDER_BLACK 10
+ #define EDGE_DIFF 30
+ 
+ cBorderDetect::cBorderDetect(cVideoOut *vOut) 
+         : cVideoFilter(vOut), currOrigAspect(-1.0), currDetAspect(-1.0),
+           newDetAspect(-1.0),currBlackBorder(0),frame_count(0) {
+         
+ };
+ 
+ cBorderDetect::~cBorderDetect() {
+ };
+ 
+ void cBorderDetect::Filter(sPicBuffer *&dest, sPicBuffer *orig) {
+     int black_border=0;
+ 
+     dest = orig; // "copy" do not modify
+ 
+     double tmp_asp = currDetAspect;
+     
+     if (orig->aspect_ratio > 1.43) 
+             // 16/9 Frame
+             return;
+ 
+     int width=orig->width/6;
+     int height=orig->height/4;
+     int not_black_count=0;
+         
+     // 4/3 Frame
+     // start of first line
+     uint8_t *pic_start=orig->pixel[0]
+             +(orig->edge_height+1)*orig->stride[0]
+             +orig->edge_width;
+     // start of last line
+     uint8_t *pic_end=orig->pixel[0]
+             +(orig->edge_height+orig->height-2)*orig->stride[0]
+             +orig->edge_width;
+ 
+     int brightness;
+     int edge_pixel;
+     int edge_pos=-1;
+     int stride=orig->stride[0];
+     // scan 1/6 from top and bottom border
+     for (black_border=1; black_border < height; black_border++) {
+             brightness=0;
+             edge_pixel=0;
+ 
+             // scan 4/6 of line
+             for (int y = width ; y < width*5; y++) {
+                     // scan upper border (4/6)
+                     brightness += *(pic_start+y);
+                     edge_pixel += !!(((int)*(pic_start-stride+y))
+                                     -((int)*(pic_start+y)) < -EDGE_DIFF);
+                     // scan lower border (4/6)
+                     brightness += *(pic_end+y);
+                     edge_pixel += !!(((int)*(pic_end+stride+y))
+                                     -((int)*(pic_end+y))  < -EDGE_DIFF);
+             }
+             brightness -= width*8*16;
+             brightness /= width * 8;
+ 
+             if (edge_pixel > width)
+                     edge_pos=black_border;
+ 
+             if (brightness > BORDER_BLACK) 
+                     not_black_count++;
+             else not_black_count=0;
+ 
+             // break if we have found BORDER_MIN_SIZE non black lines
+             if (not_black_count>BORDER_MIN_SIZE)
+                     break;
+ 
+             // next lines
+             pic_start+=stride;
+             pic_end-=stride;
+     }
+     if (edge_pos>0) {
+ #if 0
+             // show detected edge
+             memset(orig->pixel[1]
+                 +(orig->edge_height+edge_pos)/2*orig->stride[1]
+                 +(orig->edge_width+width)/2,0xFF,4*width/2);
+             memset(orig->pixel[1]
+                 +(orig->edge_height+orig->height-edge_pos-1)/2*orig->stride[1]
+                 +(orig->edge_width+width)/2,0xFF,4*width/2);
+ #endif
+             //printf("Picture is bright enough\n");
+             // calculate new aspect with the detected borders
+             float new_aspect = orig->aspect_ratio * float(orig->height) 
+                     / (float)(orig->height - edge_pos * 2);
+ 
+             // 4/3 = 1.33  16/9 = 1.77  mid = 1,55
+             if (new_aspect > 1.65) 
+                     tmp_asp = 16.0 / 9.0;
+             else if (new_aspect > 1.45) 
+                     tmp_asp = 14.0 / 9.0; //4.0 / 3.0;
+             else tmp_asp = 4.0 / 3.0;
+             //printf("Bordersize: %d  Calculated aspect %f\n",edge_pos, new_aspect);
+     }
+ 
+     if (tmp_asp == newDetAspect && newDetAspect != currDetAspect ) {
+             frame_count++;
+             if ( frame_count > FRAMES_BEFORE_SWITCH ) { 
+                     currDetAspect=tmp_asp;
+                     currBlackBorder=edge_pos;
+                     fprintf(stderr,"new Aspect detected %f\n", tmp_asp);
+             };
+     } else  frame_count=0;
+     newDetAspect=tmp_asp;
+ #if 1
+     if (currDetAspect>0.0) {
+             orig->aspect_ratio=currDetAspect;
+             orig->edge_height+=currBlackBorder;
+             orig->height-=2*currBlackBorder;
+ /*            printf("%f %d edge_height %d height %d\n",
+                             currDetAspect,currBlackBorder, 
+                             orig->edge_height, orig->height);*/  
+     }
+ #endif
  }
  

Index: VideoFilter.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** VideoFilter.h	27 May 2006 19:12:41 -0000	1.1
--- VideoFilter.h	3 Apr 2007 19:06:17 -0000	1.2
***************
*** 69,72 ****
--- 69,87 ----
  };
  
+ class cBorderDetect : public cVideoFilter {
+ private:
+         double currOrigAspect;
+         double currDetAspect;
+         double newDetAspect;
+         int currBlackBorder;
+         int frame_count;
+ 
+ public:
+         cBorderDetect(cVideoOut *VideoOut);
+         virtual ~cBorderDetect();
+    
+         virtual void Filter(sPicBuffer *&dest, sPicBuffer *orig);
+ };
+ 
  #ifdef PP_LIBAVCODEC
  class cLibAvPostProc : public cVideoFilter {

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** setup-softdevice-menu.c	4 Mar 2007 17:45:38 -0000	1.10
--- setup-softdevice-menu.c	3 Apr 2007 19:06:17 -0000	1.11
***************
*** 312,315 ****
--- 312,318 ----
                              videoAspectNames));
  
+   Add(new cMenuEditBoolItem(tr("Autodetect Movie Aspect"),
+                             &data->autodetectAspect, tr("no"), tr("yes")));
+ 
    if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_VIDIX
        || data->outputMethod == VOUT_SHM )
***************
*** 484,486 ****
--- 487,492 ----
    SetupStore ("vidHue",               setupStore.vidHue);
    SetupStore ("vidSaturation",        setupStore.vidSaturation);
+   SetupStore ("ExpandTopBottomLines", setupStore.expandTopBottomLines);
+   SetupStore ("ExpandLeftRightCols",  setupStore.expandLeftRightCols);
+   SetupStore ("autodetectAspect",     setupStore.autodetectAspect);
  }

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** setup-softdevice.c	4 Mar 2007 17:45:38 -0000	1.50
--- setup-softdevice.c	3 Apr 2007 19:06:17 -0000	1.51
***************
*** 92,95 ****
--- 92,96 ----
    expandTopBottomLines = 0;
    expandLeftRightCols = 0;
+   autodetectAspect = 0;
    deintMethod   = 0;
    ppMethod   = 0;
***************
*** 280,283 ****
--- 281,289 ----
      fprintf(stderr,"[setup-softdevice] Expanding %d columns at left and right\n",
              expandLeftRightCols);
+   } else if(!strcasecmp(Name,"autodetectAspect")) {
+     autodetectAspect = atoi(Value);
+     autodetectAspect = clamp (0, autodetectAspect, 1);
+     fprintf(stderr,"[setup-softdevice] autodetectAspect %d\n",
+             autodetectAspect);
    } else if (!strcasecmp(Name,"PixelFormat")) {
      pixelFormat = atoi(Value);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** setup-softdevice.h	4 Mar 2007 17:45:38 -0000	1.38
--- setup-softdevice.h	3 Apr 2007 19:06:17 -0000	1.39
***************
*** 141,144 ****
--- 141,145 ----
      int   expandTopBottomLines;
      int   expandLeftRightCols;
+     int   autodetectAspect;
      int   deintMethod;
      int   ppMethod;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.301
retrieving revision 1.302
diff -C2 -d -r1.301 -r1.302
*** CHANGELOG	25 Mar 2007 09:08:22 -0000	1.301
--- CHANGELOG	3 Apr 2007 19:06:17 -0000	1.302
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2007-04-03:
+    - add automatic border detection, based on a patch by Roland Praml.
  2007-03-25:
     - fix types in GetTime().



From nobody at sheep.berlios.de  Tue Apr  3 21:23:08 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:23:08 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice VdrReplacements.c,1.1,1.2
Message-ID: <20070403192308.45C25E12E7@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6693

Modified Files:
	VdrReplacements.c 
Log Message:
- compile fix for Darwin


Index: VdrReplacements.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VdrReplacements.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** VdrReplacements.c	23 Apr 2006 19:55:53 -0000	1.1
--- VdrReplacements.c	3 Apr 2007 19:21:10 -0000	1.2
***************
*** 17,21 ****
--- 17,25 ----
          pthread_mutexattr_t attr;
          pthread_mutexattr_init(&attr);
+ #ifdef __APPLE__
+         pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_ERRORCHECK);
+ #else
          pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_ERRORCHECK_NP);
+ #endif
          pthread_mutex_init(&mutex, &attr);
  };
***************
*** 43,46 ****
--- 47,51 ----
  cThread::cThread() {
          active=false;
+         childTid=0;
  };
  
***************
*** 73,76 ****
--- 78,82 ----
  
          if (active) {
+                 fprintf(stderr,"Thread %d won't end. Canceling it.\n",childTid);
                  pthread_cancel(childTid);
                  childTid=0;



From nobody at sheep.berlios.de  Tue Apr  3 21:25:24 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:25:24 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c, 1.73, 1.74 CHANGELOG,
	1.302, 1.303
Message-ID: <20070403192524.2C8E5E12B2@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7265

Modified Files:
	mpeg2decoder.c CHANGELOG 
Log Message:
- altivec needs 16 byte alignment


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.73
retrieving revision 1.74
diff -C2 -d -r1.73 -r1.74
*** mpeg2decoder.c	3 Apr 2007 19:06:17 -0000	1.73
--- mpeg2decoder.c	3 Apr 2007 19:23:30 -0000	1.74
***************
*** 521,526 ****
    avcodec_align_dimensions(c, &w, &h);
  #endif
! 
  #define EDGE_WIDTH 16
    bool EmuEdge=c->flags&CODEC_FLAG_EMU_EDGE;
    if(!EmuEdge){
--- 521,531 ----
    avcodec_align_dimensions(c, &w, &h);
  #endif
!  
! #ifdef USE_ALTIVEC 
! #define EDGE_WIDTH 32
! #else
  #define EDGE_WIDTH 16
+ #endif
+ 
    bool EmuEdge=c->flags&CODEC_FLAG_EMU_EDGE;
    if(!EmuEdge){

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.302
retrieving revision 1.303
diff -C2 -d -r1.302 -r1.303
*** CHANGELOG	3 Apr 2007 19:06:17 -0000	1.302
--- CHANGELOG	3 Apr 2007 19:23:30 -0000	1.303
***************
*** 2,5 ****
--- 2,7 ----
  2007-04-03:
     - add automatic border detection, based on a patch by Roland Praml.
+    - altivec needs 16 byte alignment
+    - compile fix for Darwin
  2007-03-25:
     - fix types in GetTime().



From nobody at sheep.berlios.de  Tue Apr  3 21:26:24 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:26:24 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice setup-softlog.c, 1.5, 1.6 shm-common.h,
	1.7, 1.8
Message-ID: <20070403192624.20456D3C0F@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7373

Modified Files:
	setup-softlog.c shm-common.h 
Log Message:
- compile fix for darwin


Index: setup-softlog.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** setup-softlog.c	26 Feb 2007 21:01:14 -0000	1.5
--- setup-softlog.c	3 Apr 2007 19:24:31 -0000	1.6
***************
*** 9,12 ****
--- 9,15 ----
  #include "setup-softlog.h"
  
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif 
  #include <stdarg.h>
  #include <stdlib.h>
***************
*** 210,213 ****
--- 213,227 ----
  /* ---------------------------------------------------------------------------
   */
+ int SoftdeviceGetTid() 
+ {
+ #ifdef __APPLE__ 
+   return getpid();
+ #else
+   return syscall(__NR_gettid);
+ #endif
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cSetupSoftlog::Log(int currPriority, int traceFlags, char *format, ...)
  {
***************
*** 221,225 ****
    va_start(argList, format);
    priority = LogPriority(currPriority);
!   snprintf(fmt, sizeof(fmt), "[%ld] %s", syscall(__NR_gettid), format);
  
    if (priority != NO_LOG)
--- 235,239 ----
    va_start(argList, format);
    priority = LogPriority(currPriority);
!   snprintf(fmt, sizeof(fmt), "[%ld] %s",SoftdeviceGetTid(), format);
  
    if (priority != NO_LOG)
***************
*** 235,239 ****
               tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
               Priority2Char(currPriority),
!              syscall(__NR_gettid), format);
      vfprintf(logFile, fmt, argList);
      fflush(logFile);
--- 249,253 ----
               tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
               Priority2Char(currPriority),
!              SoftdeviceGetTid(), format);
      vfprintf(logFile, fmt, argList);
      fflush(logFile);

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** shm-common.h	26 Nov 2006 19:00:17 -0000	1.7
--- shm-common.h	3 Apr 2007 19:24:31 -0000	1.8
***************
*** 21,24 ****
--- 21,25 ----
  #define CTL_KEY 5680
  
+ #ifndef __APPLE__ // should rather be #ifdef LINUX
  union semun {
          int val;                  
***************
*** 26,30 ****
          unsigned short *array;    
  };
! 
  
  #define PICT_SIG 0
--- 27,31 ----
          unsigned short *array;    
  };
! #endif
  
  #define PICT_SIG 0



From nobody at sheep.berlios.de  Tue Apr  3 21:33:41 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:33:41 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice Makefile,1.38,1.39
Message-ID: <20070403193341.D59968B407@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7982

Modified Files:
	Makefile 
Log Message:
- make flag for shared linking a variable


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** Makefile	12 Mar 2007 20:00:00 -0000	1.38
--- Makefile	3 Apr 2007 19:31:48 -0000	1.39
***************
*** 199,207 ****
  ### normally you shoudn't have to touch something below this line
  
! CXX      ?= g++
  CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual 
  CXXFLAGS += $(ADD_CXXFLAGS)
  DEFINES  += -D__STDC_CONSTANT_MACROS
  
  ### The directory environment:
  
--- 199,210 ----
  ### normally you shoudn't have to touch something below this line
  
! CXX      ?= g++-2.95
! #CXXFLAGS ?=  -g -Wall -fPIC -Woverloaded-virtual 
  CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual 
  CXXFLAGS += $(ADD_CXXFLAGS)
  DEFINES  += -D__STDC_CONSTANT_MACROS
  
+ SHARED_FLAG ?= -shared
+ 
  ### The directory environment:
  
***************
*** 318,323 ****
  MAKEDEP = g++ -MM -MG
  DEPFILE = .dependencies
! $(DEPFILE): Makefile
! 	@$(MAKEDEP) $(DEFINES) $(INCLUDES) $(OBJS:%.o=%.c) > $@
  
  -include $(DEPFILE)
--- 321,326 ----
  MAKEDEP = g++ -MM -MG
  DEPFILE = .dependencies
! $(DEPFILE): Makefile 
! 	$(MAKEDEP) $(DEFINES) $(INCLUDES) $(OBJS:%.o=%.c) > $@
  
  -include $(DEPFILE)
***************
*** 328,332 ****
  
  libvdr-$(PLUGIN).so: $(OBJS)
! 	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
  	@cp $(CPOTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
--- 331,335 ----
  
  libvdr-$(PLUGIN).so: $(OBJS)
! 	$(CXX) $(CXXFLAGS) $(SHARED_FLAG) $(OBJS) $(LIBS) -o $@
  	@cp $(CPOTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
***************
*** 334,354 ****
  
  lib$(PLUGIN)-dfb.so: $(DFB_OBJS)
! 	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-fb.so: $(FB_OBJS)
! 	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-xv.so: $(XV_OBJS)
! 	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
! 	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-shm.so: $(SHM_OBJS)
! 	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
--- 337,357 ----
  
  lib$(PLUGIN)-dfb.so: $(DFB_OBJS)
! 	$(CXX) $(CXXFLAGS) $(SHARED_FLAG) $(DFB_OBJS) $(DFB_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-fb.so: $(FB_OBJS)
! 	$(CXX) $(CXXFLAGS) $(SHARED_FLAG) $(FB_OBJS) $(FB_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-xv.so: $(XV_OBJS)
! 	$(CXX) $(CXXFLAGS) $(SHARED_FLAG) $(XV_OBJS) $(XV_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
! 	$(CXX) $(CXXFLAGS) $(SHARED_FLAG) $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-shm.so: $(SHM_OBJS)
! 	$(CXX) $(CXXFLAGS) $(SHARED_FLAG) $(SHM_OBJS) $(SHM_LIBS) -o $@
  	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  



From nobody at sheep.berlios.de  Tue Apr  3 21:42:22 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:42:22 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.303, 1.304 SoftOsd.c, 1.26,
	1.27 SoftOsd.h, 1.12, 1.13
Message-ID: <20070403194222.47A602D108@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8523

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
- compile fix for darwin
- add BGRA32 mode to SoftOsd


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.303
retrieving revision 1.304
diff -C2 -d -r1.303 -r1.304
*** CHANGELOG	3 Apr 2007 19:23:30 -0000	1.303
--- CHANGELOG	3 Apr 2007 19:40:29 -0000	1.304
***************
*** 4,7 ****
--- 4,8 ----
     - altivec needs 16 byte alignment
     - compile fix for Darwin
+    - add BGRA32 mode to SoftOsd
  2007-03-25:
     - fix types in GetTime().

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** SoftOsd.c	28 Jan 2007 19:36:50 -0000	1.26
--- SoftOsd.c	3 Apr 2007 19:40:29 -0000	1.27
***************
*** 191,196 ****
          }
  
!         if (modeChanged)
                  videoOut->ClearOSD();
  
          if (IsYUV) {
--- 191,198 ----
          }
  
!         if (modeChanged) {
!                 OSDDEB("mode changed\n");
                  videoOut->ClearOSD();
+         };
  
          if (IsYUV) {
***************
*** 230,233 ****
--- 232,236 ----
                          Clear();
                          FlushBitmaps(false);
+                         OSDDEB("SetMode switched to YUV mode\n");
                          return true;
                  };
***************
*** 267,271 ****
          if (old_bitmap_Format != bitmap_Format) {
                  Clear();
!                 FlushBitmaps(false);
                  return true;
          };
--- 270,276 ----
          if (old_bitmap_Format != bitmap_Format) {
                  Clear();
! 		FlushBitmaps(false);
!                 OSDDEB("SetMode switched old_bitmap_Format %d -> bitmap_Format %d\n",
!                         old_bitmap_Format,bitmap_Format);
                  return true;
          };
***************
*** 290,294 ****
--- 295,302 ----
  
          // give priority to the other threads
+ #ifndef __APPLE__
          pthread_yield();
+ #endif
+ 
          if (!active && !close)
                  Start();
***************
*** 502,505 ****
--- 510,527 ----
   
  /*---------------------------------------------------------------------*/
+ void cSoftOsd::ARGB_to_BGRA32(uint8_t * dest1, color * pixmap, int Pixel,
+                 int odd) {
+         unsigned int c;
+         uint32_t *dest=(uint32_t*) dest1;
+         while (Pixel>0) {
+                 c=*pixmap;
+                 *dest++ = SET_A(GET_R(c)) | SET_R(GET_G(c)) | SET_G(GET_B(c)) | SET_B(GET_A(c));
+                 pixmap++;
+                 Pixel--;
+         };
+ };
+ 
+ 
+ /*---------------------------------------------------------------------*/
  void cSoftOsd::ARGB_to_ARGB32(uint8_t * dest, color * pixmap, int Pixel,
                  int odd) {
***************
*** 1349,1354 ****
                  int dest_Width, int dest_Height, bool RefreshAll,
                  bool *dest_dirtyLines) {
! 
!         OSDDEB("CopyToBitmap RGB down\n");
          if ( bitmap_Format == PF_AYUV ) {
                  fprintf(stderr,"cSoftOsd error did not call SetMode()!\n");
--- 1371,1376 ----
                  int dest_Width, int dest_Height, bool RefreshAll,
                  bool *dest_dirtyLines) {
!         OSDDEB("CopyToBitmap RGB no scale\n");
! 	
          if ( bitmap_Format == PF_AYUV ) {
                  fprintf(stderr,"cSoftOsd error did not call SetMode()!\n");

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** SoftOsd.h	28 Jan 2007 19:36:50 -0000	1.12
--- SoftOsd.h	3 Apr 2007 19:40:29 -0000	1.13
***************
*** 76,84 ****
      uint8_t *pixelMask;
      enum PixFormat {
! 	    PF_None,
! 	    PF_ARGB32,
! 	    PF_inverseAlpha_ARGB32,
! 	    PF_pseudoAlpha_ARGB32,
! 	    PF_AYUV
      };
      PixFormat bitmap_Format;
--- 76,85 ----
      uint8_t *pixelMask;
      enum PixFormat {
!             PF_None,
!             PF_ARGB32,
!             PF_inverseAlpha_ARGB32,
!             PF_pseudoAlpha_ARGB32,
!             PF_AYUV,
!             PF_BGRA32
      };
      PixFormat bitmap_Format;
***************
*** 118,121 ****
--- 119,124 ----
      static void ARGB_to_AYUV(uint32_t * dest, color * pixmap, int Pixel);
      static void ARGB_to_ARGB32(uint8_t * dest, color * pixmap, int Pixel,
+                     int odd);
+     static void ARGB_to_BGRA32(uint8_t * dest, color * pixmap, int Pixel,
                      int odd);
      static void ARGB_to_RGB32(uint8_t * dest, color * pixmap, int Pixel,



From nobody at sheep.berlios.de  Tue Apr  3 21:46:32 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:46:32 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice Makefile,1.39,1.40
Message-ID: <20070403194632.6222D4B8EE@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9248

Modified Files:
	Makefile 
Log Message:
- revert change of default g++ compiler and options


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** Makefile	3 Apr 2007 19:31:48 -0000	1.39
--- Makefile	3 Apr 2007 19:44:39 -0000	1.40
***************
*** 199,204 ****
  ### normally you shoudn't have to touch something below this line
  
! CXX      ?= g++-2.95
! #CXXFLAGS ?=  -g -Wall -fPIC -Woverloaded-virtual 
  CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual 
  CXXFLAGS += $(ADD_CXXFLAGS)
--- 199,203 ----
  ### normally you shoudn't have to touch something below this line
  
! CXX      ?= g++
  CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual 
  CXXFLAGS += $(ADD_CXXFLAGS)



From nobody at sheep.berlios.de  Tue Apr  3 21:52:53 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 21:52:53 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.304, 1.305 configure, 1.35,
	1.36 sync-timer.c, 1.6, 1.7
Message-ID: <20070403195253.BCE6A2D38A@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11517

Modified Files:
	CHANGELOG configure sync-timer.c 
Log Message:
- compile linux RTC syncing mode support only on Linux.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.304
retrieving revision 1.305
diff -C2 -d -r1.304 -r1.305
*** CHANGELOG	3 Apr 2007 19:40:29 -0000	1.304
--- CHANGELOG	3 Apr 2007 19:51:00 -0000	1.305
***************
*** 4,8 ****
--- 4,10 ----
     - altivec needs 16 byte alignment
     - compile fix for Darwin
+    - make flag for shared linking a variable
     - add BGRA32 mode to SoftOsd
+    - compile linux RTC syncing mode support only on Linux.
  2007-03-25:
     - fix types in GetTime().

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** configure	12 Mar 2007 20:00:00 -0000	1.35
--- configure	3 Apr 2007 19:51:00 -0000	1.36
***************
*** 591,594 ****
--- 591,598 ----
  fi
  
+ if test "${system}" = "Linux"; then
+   echo "#define LINUX_RTC 1" >> $TMPH
+ fi  
+ 
  ###############################################################################
  # alsa defines

Index: sync-timer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/sync-timer.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** sync-timer.c	3 Oct 2006 19:50:43 -0000	1.6
--- sync-timer.c	3 Apr 2007 19:51:00 -0000	1.7
***************
*** 13,17 ****
--- 13,24 ----
  
  #include <sys/ioctl.h>
+ 
+ #ifdef HAVE_CONFIG
+ # include "config.h"
+ #endif
+ 
+ #ifdef LINUX_RTC
  #include <linux/rtc.h>
+ #endif
  
  #include "sync-timer.h"
***************
*** 92,95 ****
--- 99,103 ----
    switch (mode)
    {
+ #ifdef LINUX_RTC
      case emRtcTimer:
        if ( (rtcFd = open("/dev/rtc",O_RDONLY)) < 0 )
***************
*** 115,119 ****
--- 123,129 ----
          syncMode = emUsleepTimer;
        break;
+ #endif
      default:
+         syncMode = emUsleepTimer;
        break;
    }



From nobody at sheep.berlios.de  Tue Apr  3 22:05:34 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 22:05:34 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.305, 1.306 configure, 1.36,
	1.37
Message-ID: <20070403200534.E594B213F2@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12676

Modified Files:
	CHANGELOG configure 
Log Message:
- detect cpu endianness and define CPU_BIGENDIAN if necessary.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.305
retrieving revision 1.306
diff -C2 -d -r1.305 -r1.306
*** CHANGELOG	3 Apr 2007 19:51:00 -0000	1.305
--- CHANGELOG	3 Apr 2007 20:03:41 -0000	1.306
***************
*** 7,10 ****
--- 7,11 ----
     - add BGRA32 mode to SoftOsd
     - compile linux RTC syncing mode support only on Linux.
+    - detect cpu endianness and define CPU_BIGENDIAN if necessary.
  2007-03-25:
     - fix types in GetTime().

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** configure	3 Apr 2007 19:51:00 -0000	1.36
--- configure	3 Apr 2007 20:03:41 -0000	1.37
***************
*** 44,47 ****
--- 44,48 ----
  oss="yes"
  yaepg="auto"
+ cpu_bigendian="no"
  
  function help () {
***************
*** 123,126 ****
--- 124,128 ----
          with_mmx2="no"
          with_altivec="yes"
+         cpu_bigendian="yes"
          ;;
    *)
***************
*** 585,588 ****
--- 587,594 ----
    echo "#define USE_ALTIVEC 1" >> $TMPH
    echo "ADD_CXXFLAGS += -faltivec" >> $TMPM
+ fi
+ 
+ if test "${cpu_bigendian}" = "yes" ; then
+   echo "#define CPU_BIGENDIAN 1" >> $TMPH
  fi
  



From nobody at sheep.berlios.de  Tue Apr  3 22:16:29 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 22:16:29 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice/MacVdrClient.app - New directory
Message-ID: <20070403201629.D6BCBDB746@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice/MacVdrClient.app
In directory sheep:/tmp/cvs-serv13790/MacVdrClient.app

Log Message:
Directory /cvsroot/softdevice/softdevice/MacVdrClient.app added to the repository




From nobody at sheep.berlios.de  Tue Apr  3 22:16:52 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 22:16:52 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice/MacVdrClient.app/Contents - New
	directory
Message-ID: <20070403201652.8E4E6DB746@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice/MacVdrClient.app/Contents
In directory sheep:/tmp/cvs-serv13825/MacVdrClient.app/Contents

Log Message:
Directory /cvsroot/softdevice/softdevice/MacVdrClient.app/Contents added to the repository




From nobody at sheep.berlios.de  Tue Apr  3 22:17:41 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 22:17:41 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice/MacVdrClient.app/Contents/MacOS - New
	directory
Message-ID: <20070403201741.E11F7DB746@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice/MacVdrClient.app/Contents/MacOS
In directory sheep:/tmp/cvs-serv13919/MacVdrClient.app/Contents/MacOS

Log Message:
Directory /cvsroot/softdevice/softdevice/MacVdrClient.app/Contents/MacOS added to the repository




From nobody at sheep.berlios.de  Tue Apr  3 22:22:58 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 22:22:58 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-quartz.c, NONE, 1.1 video-quartz.h,
	NONE, 1.1 audio-macos.c, NONE, 1.1 audio-macos.h, NONE,
	1.1 Makefile, 1.40, 1.41 configure, 1.37, 1.38 softdevice.c,
	1.79, 1.80 video-shm.c, 1.16, 1.17
Message-ID: <20070403202258.06DFFDB746@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14563

Modified Files:
	Makefile configure softdevice.c video-shm.c 
Added Files:
	video-quartz.c video-quartz.h audio-macos.c audio-macos.h 
Log Message:
- add video-quartz and audio-macos for Mac Os X support


--- NEW FILE: video-quartz.c ---
/*
 *
 * video-quartz.c: A plugin for the Video Disk Recorder
 *
 * Copyright (c) Martin Wache 2006
 *
 * 
 * This file is based on MPlayers vo_quartz with the original copyright notice:
 */

/*
	vo_quartz.c
	
	by Nicolas Plourde <nicolasplourde at gmail.com>
	
	Copyright (c) Nicolas Plourde - April 2004

	YUV support Copyright (C) 2004 Romain Dolbeau <romain at dolbeau.org>
	
[...990 lines suppressed...]
			device_width = deviceRect.right;
			device_height = deviceRect.bottom;
			restoreState = NULL;
		}*/
		SetSystemUIMode( kUIModeNormal, NULL);

		//show mouse cursor
		CGDisplayShowCursor(kCGDirectMainDisplay);
		//mouseHide = FALSE;
		
                QDEB("Going into windowed mode pos %d,%d size: %d,%d \n",
                        oldWinBounds.left,oldWinBounds.top,oldWinRect.right,oldWinRect.bottom);
		//revert window to previous setting
		ChangeWindowAttributes(theWindow, 0, kWindowNoShadowAttribute);
		MoveWindow(theWindow, oldWinBounds.left, oldWinBounds.top, 1);
		SizeWindow(theWindow, oldWinRect.right, oldWinRect.bottom,1);
	}
	WindowResized();
};


--- NEW FILE: video-quartz.h ---
/*
 *
 * video-quartz.h: A plugin for the Video Disk Recorder
 *
 * Copyright Martin Wache 2006
 *
 * 
 */
#ifndef __VIDEO_QUARTZ_H__
#define __VIDEO_QUARTZ_H__

#include "video.h"

#undef always_inline
namespace MacOs {
#include <Carbon/Carbon.h>
#include <OpenGL/gl.h>
#include <OpenGL/glext.h>
#include <AGL/agl.h>
};

using namespace std;
using namespace MacOs;

#define IMAGE_WIDTH 720
#define IMAGE_HEIGHT 576
extern cSoftRemote *quartzRemote;

class cQuartzVideoOut : public cVideoOut {
private:
        cMutex glMutex;

        WindowRef theWindow;
        WindowGroupRef winGroup;
        CGContextRef context;
        MenuRef windMenu;
        MenuRef movMenu;
        MenuRef aspectMenu;
       
        Rect imgRect; // size of the original image (unscaled)
        Rect dstRect; // size of the displayed image (after scaling)
        Rect winRect; // size of the window containg the displayed image (include padding)
        Rect oldWinRect; // size of the window containg the displayed image (include padding) when NOT in FS mode
        Rect deviceRect; // size of the display device
        Rect oldWinBounds;

        int winLevel;

        unsigned char *image_data[2];
        unsigned int image_size;
        unsigned int image_buffer_size;

        GLuint osd_texture;
        unsigned char * osd_image_data;

        void CreateWindow( uint32_t d_width, uint32_t d_height, 
                WindowAttributes windowAttrs);

        void InitGl();
        bool glInitialized;
        AGLContext    aglCtx;
        AGLPixelFormat	aglFmt;
        bool isFullscreen;
        GLuint p_textures[2];
        int curr_index; 
        int image_width;
        int image_height;
        GDHandle deviceHdl;
        int lastTime;
 
        sPicBuffer privBuffer;
public:
        int osd_shm_id;
        int pic_shm_id;
        cQuartzVideoOut(cSetupStore *setupStore);
        virtual ~cQuartzVideoOut();

        virtual void ProcessEvents();
        virtual void YUV(sPicBuffer *buf);
        void Render();
        
        virtual void GetLockOsdSurface(uint8_t *&osd, int &stride, bool *&dirtyLines); 
        virtual void CommitUnlockOsdSurface();
 
        void WindowResized();
        void ToggleFullscreen();
        inline bool IsOpen()
        { return (theWindow); }
        
        void RmShmMemory();

        OSStatus MouseEventHandler(EventHandlerCallRef nextHandler, EventRef event, void *userData);

        OSStatus WindowEventHandler(EventHandlerCallRef nextHandler, EventRef event, void *userData);

};

#endif

--- NEW FILE: audio-macos.c ---
/*
 * audio-macos.c: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: audio-macos.c,v 1.1 2007/04/03 20:21:04 wachm Exp $
 */

/*
 * This file is based on MPlayers ao_macosx.c with the original copyright 
 * notice:
 * 
 *      Original Copyright (C) Timothy J. Wood - Aug 2000
 *
 */

#include "audio-macos.h"


#define AUDIODEB(out...) {printf("AUDIO-MACOS: ");printf(out);}


#ifndef AUDIODEB
#define AUDIODEB(out...)
#endif

/* This is large, but best (maybe it should be even larger).
 * CoreAudio supposedly has an internal latency in the order of 2ms */
#define NUM_BUFS 32

static cMacOsAudioOut *macosAO = NULL;

/**
 * \brief return number of free bytes in the buffer
 *    may only be called by mplayer's thread
 * \return minimum number of free bytes in buffer, value may change between
 *    two immediately following calls, and the real number of free bytes
 *    might actually be larger!
 */
int cMacOsAudioOut::buf_free() {
  int free = buf_read_pos - buf_write_pos - chunk_size;
  if (free < 0) free += buffer_len;
  return free;
}

/**
 * \brief return number of buffered bytes
 *    may only be called by playback thread
 * \return minimum number of buffered bytes, value may change between
 *    two immediately following calls, and the real number of buffered bytes
 *    might actually be larger!
 */
int cMacOsAudioOut::buf_used() {
  int used = buf_write_pos - buf_read_pos;
  if (used < 0) used += buffer_len;
  return used;
}

/**
 * \brief add data to ringbuffer
 */
int cMacOsAudioOut::write_buffer(unsigned char* data, int len){
  int first_len = buffer_len - buf_write_pos;
  int free = buf_free();
  if (len > free) {
          len = free;
          //AUDIODEB("write_buffer buffer full!\n");
  }
  if (first_len > len) first_len = len;
  // till end of buffer
  memcpy (&buffer[buf_write_pos], data, first_len);
  if (len > first_len) { // we have to wrap around
    // remaining part from beginning of buffer
    //AUDIODEB("write_buffer wrap around len %d first_len %d\n",len,first_len);
    memcpy (buffer, &data[first_len], len - first_len);
  }
  buf_write_pos = (buf_write_pos + len) % buffer_len;
  return len;
}

/**
 * \brief remove data from ringbuffer
 */
int cMacOsAudioOut::read_buffer(unsigned char* data,int len){
  int first_len = buffer_len - buf_read_pos;
  int buffered = buf_used();
  if (len > buffered) len = buffered;
  if (first_len > len) first_len = len;
  // till end of buffer
  memcpy (data, &buffer[buf_read_pos], first_len);
  if (len > first_len) { // we have to wrap around
    // remaining part from beginning of buffer
    //AUDIODEB("read_buffer wrap around len %d first_len %d\n",len,first_len);
    memcpy (&data[first_len], buffer, len - first_len);
  }
  buf_read_pos = (buf_read_pos + len) % buffer_len;
  return len;
}

OSStatus theRenderProc(void *inRefCon, AudioUnitRenderActionFlags *inActionFlags, const AudioTimeStamp *inTimeStamp, UInt32 inBusNumber, UInt32 inNumFrames, AudioBufferList *ioData) {
       return  (macosAO ? macosAO->Render(inNumFrames,ioData) : -1 );
};


OSStatus cMacOsAudioOut::Render(UInt32 inNumFrames, AudioBufferList *ioData) {
        int amt=buf_used();
        int req=(inNumFrames)*packetSize;

	if(amt>req)
 		amt=req;

	if(amt)
		read_buffer((unsigned char *)ioData->mBuffers[0].mData, amt);
	else Pause();
	ioData->mBuffers[0].mDataByteSize = amt;

 	return noErr;
}

cMacOsAudioOut::cMacOsAudioOut(cSetupStore *store) : cAudioOut() {
        ComponentDescription desc; 
        Component comp; 
        OSStatus err;

        if (macosAO) {
                fprintf(stderr,"MacOsAudioOut already initialized!\n");
                exit(-1);
        };
        macosAO=this;	
        buffer = NULL;

        desc.componentType = kAudioUnitType_Output;
	desc.componentSubType = kAudioUnitSubType_DefaultOutput;
	desc.componentManufacturer = kAudioUnitManufacturer_Apple;
	desc.componentFlags = 0;
	desc.componentFlagsMask = 0;
				
	comp = FindNextComponent(NULL, &desc);  //Finds an component that meets the desc spec's
	if (comp == NULL) {
		fprintf(stderr, "Unable to find Output Unit component\n");
		exit(-1);
	}
		
	err = OpenAComponent(comp, &(theOutputUnit));  //gains access to the services provided by the component
	if (err) {
		fprintf(stderr,"Unable to open Output Unit component (err=%d)\n", err);
		exit(-1);
	}

	// Initialize AudioUnit 
	err = AudioUnitInitialize(theOutputUnit);
	if (err) {
		fprintf(stderr, "Unable to initialize Output Unit component (err=%d)\n", err);
		exit(-1);
	}
        scale_Factor=0x7FFF;
}


cMacOsAudioOut::~cMacOsAudioOut() {
        AudioOutputUnitStop(theOutputUnit);
        AudioUnitUninitialize(theOutputUnit);
        CloseComponent(theOutputUnit);

        free(buffer);
}

int cMacOsAudioOut::SetParams(SampleContext &context) {

        if (currContext.samplerate == context.samplerate &&
                        currContext.channels == context.channels ) {
                context=currContext;
                return 0;
        };
        AUDIODEB("alsa-macos : SetParams samplerate %d channels %d\n",context.samplerate,context.channels);
        currContext=context;

        AudioStreamBasicDescription inDesc, outDesc;
        AURenderCallbackStruct renderCallback;
        OSStatus err;
        UInt32 size, maxFrames;

	// Build Description for the input format
	inDesc.mSampleRate=currContext.samplerate;
	inDesc.mFormatID=kAudioFormatLinearPCM;
	inDesc.mChannelsPerFrame=currContext.channels;
        inDesc.mBitsPerChannel=16;

        inDesc.mFormatFlags = kAudioFormatFlagIsSignedInteger|kAudioFormatFlagIsPacked;
        /*if((format&AF_FORMAT_POINT_MASK)==AF_FORMAT_F) {
	// float
                inDesc.mFormatFlags = kAudioFormatFlagIsFloat|kAudioFormatFlagIsPacked;
        }
        else if((format&AF_FORMAT_SIGN_MASK)==AF_FORMAT_SI) {
                // signed int
                inDesc.mFormatFlags = kAudioFormatFlagIsSignedInteger|kAudioFormatFlagIsPacked;
        }
        else {
                // unsigned int
                inDesc.mFormatFlags = kAudioFormatFlagIsPacked;
        }*/

#ifdef CPU_BIGENDIAN 
        inDesc.mFormatFlags |= kAudioFormatFlagIsBigEndian; //Intel processors???
#endif
        inDesc.mFramesPerPacket = 1;
        packetSize = inDesc.mBytesPerPacket = inDesc.mBytesPerFrame = inDesc.mFramesPerPacket*currContext.channels*(inDesc.mBitsPerChannel/8);


	size =  sizeof(AudioStreamBasicDescription);
	err = AudioUnitSetProperty(theOutputUnit, kAudioUnitProperty_StreamFormat, kAudioUnitScope_Input, 0, &inDesc, size);

	if (err) {
		printf( "Unable to set the input format (err=%d)\n", err);
		exit(-1);
	}

	size = sizeof(UInt32);
	err = AudioUnitGetProperty(theOutputUnit, kAudioDevicePropertyBufferSize, kAudioUnitScope_Input, 0, &maxFrames, &size);
	
	if (err) {
		printf( "AudioUnitGetProperty returned %d when getting kAudioDevicePropertyBufferSize\n", (int)err);
		exit(-1);
	}

	chunk_size = maxFrames;//*inDesc.mBytesPerFrame;
	printf("%5d chunk size\n", (int)chunk_size);
    
	num_chunks = NUM_BUFS;
        buffer_len = (num_chunks + 1) * chunk_size;
        buffer = buffer ? (unsigned char *)realloc(buffer,(num_chunks + 1)*chunk_size)
			: (unsigned char *)calloc(num_chunks + 1, chunk_size);

        buf_read_pos=0;
	buf_write_pos=0;
    
/*	
        ao_data.samplerate = inDesc.mSampleRate;
        ao_data.channels = inDesc.mChannelsPerFrame;
        ao_data.outburst = ao_data.buffersize = ao->chunk_size;
        ao_data.bps = ao_data.samplerate * inDesc.mBytesPerFrame;
*/
        renderCallback.inputProc = theRenderProc;
        renderCallback.inputProcRefCon = 0;
        err = AudioUnitSetProperty(theOutputUnit, kAudioUnitProperty_SetRenderCallback, kAudioUnitScope_Input, 0, &renderCallback, sizeof(AURenderCallbackStruct));
	if (err) {
		fprintf(stderr, "Unable to set the render callback (err=%d)\n", err);
		exit(-1);
	}

        return 0;
}

/* stop playing, keep buffers (for pause) */
void cMacOsAudioOut::Pause() {
  OSErr status=noErr;

  /* stop callback */
  status=AudioOutputUnitStop(theOutputUnit);
  if (status)
    fprintf(stderr, "AudioOutputUnitStop returned %d\n",(int)status);
}


/* resume playing, after audio_pause() */
void cMacOsAudioOut::Play() {
  OSErr status=noErr;
  
  status=AudioOutputUnitStart(theOutputUnit);
  if (status)
    fprintf(stderr,"AudioOutputUnitStart returned %d\n",(int)status);
}

void cMacOsAudioOut::Write(uchar *Data, int Length) {
        Play();
        Scale((int16_t*)Data,Length/2,scale_Factor);
        while (Length >0) {
                int len = write_buffer(Data,Length);
                Data +=len;
                Length-=len;
                usleep(13000);
        }
};

int cMacOsAudioOut::GetDelay() {
        if ( ! currContext.samplerate*currContext.channels )
                return -1;

        int res = buffer_len - chunk_size - buf_free();
        res = res*10000 / (currContext.samplerate*currContext.channels*2) ;
        //AUDIODEB("GetDelay %d\n",res);
        return res;
};

void cMacOsAudioOut::SetVolume( int vol ) {
        scale_Factor = CalcScaleFactor(vol);
};

--- NEW FILE: audio-macos.h ---
/*
 * audio-macos.h: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: audio-macos.h,v 1.1 2007/04/03 20:21:04 wachm Exp $
 */
#ifndef __AUDIO_MACOS_H__
#define __AUDIO_MACOS_H__
#include <vdr/plugin.h>
#include "audio.h"


namespace MacOs {
#include <CoreServices/CoreServices.h>
#include <AudioUnit/AudioUnit.h>
#include <AudioToolbox/AudioToolbox.h>
}


using namespace MacOs;

/* ---------------------------------------------------------------------------
 */
class cMacOsAudioOut : public cAudioOut  {
        private:
                int scale_Factor;

                /* AudioUnit */
                AudioUnit theOutputUnit;
                int packetSize;

                /* Ring-buffer */
                /* does not need explicit synchronization, but needs to allocate
                 * (num_chunks + 1) * chunk_size memory to store num_chunks * chunk_size
                 * data */
                unsigned char *buffer;
                unsigned int buffer_len; ///< must always be (num_chunks + 1) * chunk_size
                unsigned int num_chunks;
                unsigned int chunk_size;

                unsigned int buf_read_pos;
                unsigned int buf_write_pos;
        protected:
                int buf_free();
                int buf_used();
                int write_buffer(unsigned char* data, int len);
                int read_buffer(unsigned char* data, int len);

        public:
                cMacOsAudioOut(cSetupStore *setupStore);
                virtual ~cMacOsAudioOut();
                OSStatus Render(UInt32 inNumFrames, AudioBufferList *ioData); 

                virtual void  Write(uchar *Data, int Length);
                virtual void  WriteAC3(uchar *Data, int Length)
                {};
                virtual int   SetParams(SampleContext &context);
                virtual int   GetDelay(void);
                virtual void  Pause(void);
                virtual void  Play(void);
                virtual void  SetVolume(int vol);
/*                virtual void  Suspend(void);
                virtual bool  Resume(void);
*/};


#endif 

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** Makefile	3 Apr 2007 19:44:39 -0000	1.40
--- Makefile	3 Apr 2007 20:21:04 -0000	1.41
***************
*** 241,244 ****
--- 241,254 ----
  ALL_OBJS = $(OBJS)
  
+ ifdef MACOSAO_SUPPORT
+   OBJS += audio-macos.o
+   LIBS += -framework Carbon -framework CoreAudio -framework AudioUnit -framework AudioToolbox 
+ endif
+ 
+ ifdef QUARTZ_SUPPORT
+   OBJS += video-quartz.o
+   LIBS += -framework Carbon -framework AGL -framework OpenGL 
+ endif
+ 
  ifdef ALSA_SUPPORT
    LIBS += -lasound
***************
*** 306,313 ****
      OBJS += video-shm.o
    endif
-   TARGETS += ShmClient
    DEFINES += -DSHM_SUPPORT
  endif
  
  ### Implicit rules:
  
--- 316,330 ----
      OBJS += video-shm.o
    endif
    DEFINES += -DSHM_SUPPORT
  endif
  
+ ifdef SHMCLIENT_SUPPORT
+   TARGETS += ShmClient
+ endif
+ 
+ ifdef MACVDRCLIENT_SUPPORT
+   TARGETS += MacVdrClient
+ endif
+ 
  ### Implicit rules:
  
***************
*** 369,373 ****
  
  clean:
! 	@-rm -f $(OBJS) $(DEPFILE) ShmClient *.so *.o *.tgz core* *~
  
  VDR_SHM_CLIENT_OBJS = ../../../tools.o ../../../thread.o \
--- 386,390 ----
  
  clean:
! 	@-rm -f $(OBJS) $(DEPFILE) ShmClient MacVdrClient *.so *.o *.tgz core* *~
  
  VDR_SHM_CLIENT_OBJS = ../../../tools.o ../../../thread.o \
***************
*** 385,386 ****
--- 402,409 ----
  ShmClient: $(SHM_CLIENT_OBJS)
  	$(CXX) $(CXXFLAGS) $(XV_LIBS)  $(SHM_CLIENT_OBJS) -lpthread -o $@
+ 
+ 
+ MacVdrClient_obj = video_shm.o video-quartz_shm.o setup-softdevice_shm.o utils_shm.o VdrReplacements_shm.o PicBuffer_shm.o setup-softlog_shm.o MacVdrClient_shm.o
+ MacVdrClient: $(MacVdrClient_obj)
+ 	$(CXX) $(LDFLAGS) $(MacVdrClient_obj)  -framework Carbon -framework AGL -framework OpenGL -lpthread -o $@
+ 	cp $@ ./MacVdrClient.app/Contents/MacOS/MacVdrClient

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** configure	3 Apr 2007 20:03:41 -0000	1.37
--- configure	3 Apr 2007 20:21:04 -0000	1.38
***************
*** 110,114 ****
  case "$system" in
    Linux) system="Linux";;
!   Darwin) system="Darwin";;
    *) system="unknown";;
  esac
--- 110,117 ----
  case "$system" in
    Linux) system="Linux";;
!   Darwin) 
!         system="Darwin"
!         #with_subplugins="no"
!         ;;
    *) system="unknown";;
  esac
***************
*** 602,605 ****
--- 605,620 ----
  
  ###############################################################################
+ # Darwin defines
+ #
+ if test "${system}" = "Darwin"; then
+   echo "SHARED_FLAG = -dynamiclib -Wl,-single_module,-undefined,dynamic_lookup " >> $TMPM
+   echo "QUARTZ_SUPPORT = 1" >> $TMPM
+   echo "#define QUARTZ_SUPPORT 1 ">> $TMPH
+   echo "MACOSAO_SUPPORT = 1" >> $TMPM
+   echo "#define MACOSAO_SUPPORT 1 ">> $TMPH
+   echo "MACVDRCLIENT_SUPPORT = 1" >> $TMPM
+ fi
+ 
+ ###############################################################################
  # alsa defines
  #
***************
*** 678,682 ****
    echo "XV_SUPPORT       = 1" >> $TMPM
    if test "${with_shm}" = "yes" ; then
!     echo "SHM_SUPPORT = 1" >> $TMPM
    fi
    if test "${xinerama}" = "yes" ; then
--- 693,697 ----
    echo "XV_SUPPORT       = 1" >> $TMPM
    if test "${with_shm}" = "yes" ; then
!     echo "SHMCLIENT_SUPPORT = 1" >> $TMPM
    fi
    if test "${xinerama}" = "yes" ; then
***************
*** 689,692 ****
--- 704,714 ----
    echo "#define XV_SUPPORT       1" >> $TMPH
    echo "#define LIBXDPMS_SUPPORT 1" >> $TMPH
+ fi
+ 
+ ###############################################################################
+ # generate defines for shared memory server
+ #
+ if test "${with_shm}" = "yes" ; then
+   echo "SHM_SUPPORT = 1" >> $TMPM
  fi
  

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.79
retrieving revision 1.80
diff -C2 -d -r1.79 -r1.80
*** softdevice.c	12 Mar 2007 20:10:54 -0000	1.79
--- softdevice.c	3 Apr 2007 20:21:04 -0000	1.80
***************
*** 6,10 ****
   * $Id$
   */
- 
  #include "softdevice.h"
  
--- 6,9 ----
***************
*** 68,71 ****
--- 67,81 ----
  #endif
  
+ #ifdef QUARTZ_SUPPORT
+ #include "video-quartz.h"
+ 
+ #ifndef VOUT_DEFAULT
+ #define VOUT_DEFAULT  VOUT_QUARTZ
+ #endif
+ 
+ #endif
+ 
+ #include "audio.h"
+ 
  #ifdef ALSA_SUPPORT
  #include "audio-alsa.h"
***************
*** 76,80 ****
  #endif
  
! #include "audio.h"
  #include "mpeg2decoder.h"
  #include "utils.h"
--- 86,93 ----
  #endif
  
! #ifdef MACOSAO_SUPPORT
! #include "audio-macos.h"
! #endif
! 
  #include "mpeg2decoder.h"
  #include "utils.h"
***************
*** 91,94 ****
--- 104,108 ----
  #define AOUT_DUMMY  2
  #define AOUT_OSS    3
+ #define AOUT_MACOS  4 
  
  //#define SOFTDEB(out...) {printf("softdeb[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
***************
*** 224,227 ****
--- 238,246 ----
          videoOut->Initialize();
  #endif
+       case VOUT_QUARTZ:
+ #ifdef QUARTZ_SUPPORT
+         videoOut=new cQuartzVideoOut(&setupStore);
+         videoOut->Initialize();
+ #endif
          break;
        case VOUT_DUMMY:
***************
*** 246,250 ****
          break;
  #else
!         fprintf(stderr,"[softdevice] No alsa support compiled in. Using dummy-audio\n");
  #endif
        case AOUT_OSS:
--- 265,276 ----
          break;
  #else
!         fprintf(stderr,"[softdevice] audio-alsa not compiled in. Using audio dummy!\n");
! #endif
!       case AOUT_MACOS:
! #ifdef MACOSAO_SUPPORT
!         audioOut=new cMacOsAudioOut(&setupStore);
!         break;
! #else
!         fprintf(stderr,"[softdevice] audio-macos not compiled in. Using audio dummy!\n");
  #endif
        case AOUT_OSS:
***************
*** 262,265 ****
--- 288,292 ----
      fprintf(stderr,"[softdevice] A/V devices initialized, now initializing MPEG2 Decoder\n");
      decoder= new cMpeg2Decoder(audioOut, videoOut);
+     videoOut->Start();
  }
  
***************
*** 297,301 ****
  
    void *handle = dlopen (subPluginFileName, RTLD_NOW);
!   char *err = dlerror();
    if (!err)
    {
--- 324,328 ----
  
    void *handle = dlopen (subPluginFileName, RTLD_NOW);
!   const char *err = dlerror();
    if (!err)
    {
***************
*** 959,962 ****
--- 986,997 ----
            fprintf(stderr,"[softdevice] vidix support not compiled in\n");
            ret = false;
+ #endif
+         } else if (!strncmp (vo_argv, "quartz:", 7)) {
+           vo_argv += 6;
+           setupStore.voArgs = vo_argv;
+ #ifdef QUARTZ_SUPPORT
+           voutMethod = VOUT_QUARTZ;
+ #else
+           fprintf(stderr,"[softdevice] quartz support not compiled in\n");
  #endif
          } else if (!strncmp (vo_argv, "dummy:", 6)) {

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** video-shm.c	14 Dec 2006 22:33:07 -0000	1.16
--- video-shm.c	3 Apr 2007 20:21:04 -0000	1.17
***************
*** 131,138 ****
--- 131,143 ----
          osd_surface=NULL;
          ctl->key=NO_KEY;
+ #ifdef __APPLE__ // FIXME... should be decided at run time
+         remote = new cShmRemote("softdevice-quartz",this);
+ #else
          remote = new cShmRemote("softdevice-xv",this);
+ #endif
  };
  
  cShmVideoOut::~cShmVideoOut() {
+         SHMDEB("cShmVideoOut destructor\n");
          // stop&delete remote
          remote->Stop();
***************
*** 160,163 ****
--- 165,172 ----
  
  void cShmVideoOut::AdjustOSDMode() {
+   if ( curr_osd_shmid==-1 ) {
+         current_osdMode=OSDMODE_SOFTWARE;
+         return;
+   }
    current_osdMode = setupStore->osdMode;
  }
***************
*** 184,188 ****
  void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                  bool &IsYUV, uint8_t *&PixelMask) {
!         if (current_osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  PixelMask=NULL;
--- 193,197 ----
  void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
                  bool &IsYUV, uint8_t *&PixelMask) {
!         if ( current_osdMode==OSDMODE_SOFTWARE ) {
                  IsYUV=true;
                  PixelMask=NULL;
***************
*** 194,197 ****
--- 203,207 ----
          HasAlpha=false;
          PixelMask=NULL;
+         AlphaInversed=false;
  };       
  



From nobody at sheep.berlios.de  Tue Apr  3 22:24:07 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 22:24:07 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice/MacVdrClient.app/Contents Info.plist,
	NONE, 1.1 PkgInfo, NONE, 1.1
Message-ID: <20070403202407.7F0FA21240@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice/MacVdrClient.app/Contents
In directory sheep:/tmp/cvs-serv14721/MacVdrClient.app/Contents

Added Files:
	Info.plist PkgInfo 
Log Message:
- add Info.plist and PkgInfo


--- NEW FILE: Info.plist ---
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>CFBundleDevelopmentRegion</key>
	<string>English</string>
	<key>CFBundleExecutable</key>
	<string>MacVdrClient</string>
	<key>CFBundleIconFile</key>
	<string></string>
	<key>CFBundleIdentifier</key>
	<string>org.defyne.iTele</string>
	<key>CFBundleInfoDictionaryVersion</key>
	<string>6.0</string>
	<key>CFBundlePackageType</key>
	<string>APPL</string>
	<key>CFBundleSignature</key>
	<string>????</string>
	<key>CFBundleVersion</key>
	<string>0.6.3</string>
	<key>NSAppleScriptEnabled</key>
	<string>YES</string>
	<key>NSMainNibFile</key>
	<string>MainMenu</string>
	<key>NSPrincipalClass</key>
	<string>NSApplication</string>
</dict>
</plist>

--- NEW FILE: PkgInfo ---
APPL????



From nobody at sheep.berlios.de  Tue Apr  3 23:02:39 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 23:02:39 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.306,
	1.307 setup-softdevice.h, 1.39, 1.40
Message-ID: <20070403210239.09C0DD31AE@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17824

Modified Files:
	CHANGELOG setup-softdevice.h 
Log Message:
- add video-quartz and audio-macos for Mac Os X support


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.306
retrieving revision 1.307
diff -C2 -d -r1.306 -r1.307
*** CHANGELOG	3 Apr 2007 20:03:41 -0000	1.306
--- CHANGELOG	3 Apr 2007 21:00:40 -0000	1.307
***************
*** 8,11 ****
--- 8,12 ----
     - compile linux RTC syncing mode support only on Linux.
     - detect cpu endianness and define CPU_BIGENDIAN if necessary.
+    - add video-quartz and audio-macos for Mac Os X support
  2007-03-25:
     - fix types in GetTime().

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** setup-softdevice.h	3 Apr 2007 19:06:17 -0000	1.39
--- setup-softdevice.h	3 Apr 2007 21:00:40 -0000	1.40
***************
*** 31,34 ****
--- 31,35 ----
  #define VOUT_DUMMY    5
  #define VOUT_SHM      6
+ #define VOUT_QUARTZ   7
  
  #define ALSA_DEVICE_NAME_LENGTH  64



From nobody at sheep.berlios.de  Tue Apr  3 23:45:28 2007
From: nobody at sheep.berlios.de (wachm)
Date: Tue,  3 Apr 2007 23:45:28 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice MacVdrClient.c,NONE,1.1
Message-ID: <20070403214528.7EA92DDDA7@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20161

Added Files:
	MacVdrClient.c 
Log Message:
- add MacVdrClient


--- NEW FILE: MacVdrClient.c ---
/*
 * softdevice plugin for VDR
 *
 * Copyright (C) 2005 Martin Wache
 *
 * This code is distributed under the terms and conditions of the
 * GNU GENERAL PUBLIC LICENSE. See the file COPYING for details.
 *
 * $Id: MacVdrClient.c,v 1.1 2007/04/03 21:43:35 wachm Exp $
 */

#include <signal.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#include "video-quartz.h"
#include "shm-common.h"
#include "utils.h"

//#define SHMDEB(out...) {printf("MCVDR[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}

#ifndef SHMDEB
#define SHMDEB(out...)
#endif

ShmCtlBlock * ctl;
bool active=true;

void sig_handler(int signal) {
        printf("got signal, ending\n");
        active=false;
};

class cShmRemote : public cSoftRemote, public cThread {
        private:
                bool running;
        public:
                cShmRemote(const char *Name)
                        : cSoftRemote(Name), running(false)
                        {};

                ~cShmRemote()
                {};

                virtual bool PutKey(uint64_t Code, bool Repeat = false,
                                bool Release = false);

                virtual void Action();
};

bool cShmRemote::PutKey(uint64_t Code, bool Repeat,
                                bool Release) {
        if (ctl)
        {
                SHMDEB("get lock for the key\n");
                sem_wait_lock(ctl->semid,KEY_MUT);
                SHMDEB("got lock for the key\n");

                ctl->key=Code;

                // release lock
                sem_sig_unlock(ctl->semid,KEY_MUT);
                // signal new key
                sem_sig_unlock(ctl->semid,KEY_SIG);
                SHMDEB("signal new key\n");
        };
        return true;
};

void cShmRemote::Action() {
        running=true;
        while (running) {
                // I don't know if there is a timeout mechanism (which would probably the better solution),
                // so we just signal every once and a while so that the client processes its events.
                if (ctl)
                        sem_sig_unlock(ctl->semid,PICT_SIG);
                usleep(113000);
        };
};

int main(int argc, char **argv) {
        cSetupStore SetupStore;
        int pict_shmid_sav;
        int osd_shmid_sav;
        SetupStore.xvFullscreen=0;
        cQuartzVideoOut *vout=new cQuartzVideoOut(&SetupStore);
        quartzRemote= new cShmRemote("softdevice-quartz");

        signal(SIGINT,sig_handler);
        signal(SIGQUIT,sig_handler);

        int ctl_shmid;
        key_t ctl_key=CTL_KEY;

        //int curr_pict_shmid;
        uint8_t *curr_pict=0;
        uint8_t *curr_osd=0;
        sPicBuffer picture;
        //uint8_t *pixel[4];

        if ((ctl_shmid = shmget(ctl_key, sizeof( ShmCtlBlock ), 0666)) < 0) {
                fprintf(stderr,"ctl_shmid error in shmget!\n");
                fprintf(stderr,"Check if the Vdr is running with the softdevice and the option \"-vo shm:\"!\n");
                delete vout;
                exit(1);
        }

        if ( (ctl = (ShmCtlBlock *)shmat(ctl_shmid,NULL,0))
                        == (ShmCtlBlock *) -1 ) {
                fprintf(stderr,"ctl_shmid error attatching shm ctl %d!\n",ctl_shmid);
                delete vout;
                exit(-1);
        };

        if ( !vout->Initialize() ) {
                fprintf(stderr,"Could not init video out!\n");
                delete vout;
                exit(-1);
        };

#if  0 
        // create a picture in shm
        ctl->max_width=736;
        ctl->max_height=576;
        ctl->stride0=ctl->max_width;
        ctl->stride2=ctl->stride1=ctl->max_width/2;
        ctl->format=PIX_FMT_YUV420P;

        if ( (pict_shmid_sav = ctl->pict_shmid = shmget(IPC_PRIVATE,
                                        ctl->max_width*ctl->max_height*2,
                                        IPC_CREAT | 0666)) < 0 ) {
                fprintf(stderr,"error creating  pict_shm! width %d height %d\n",
                        ctl->max_width,ctl->max_height);
                delete vout;
                exit(-1);
        };

        if ( (curr_pict = (uint8_t*)shmat(ctl->pict_shmid,NULL,0))
                        == (uint8_t*) -1 ) {
                fprintf(stderr,"error attatching shm ctl!\n");
                delete vout;
                exit(-1);
        };
/*
        // request removing after detaching
        if ( ctl->pict_shmid > 0)
                shmctl (ctl->pict_shmid, IPC_RMID, 0);
*/
        picture.format=PIX_FMT_YUV420P;
        picture.stride[0]=ctl->stride0;
        picture.stride[1]=ctl->stride1;
        picture.stride[2]=ctl->stride1;
        picture.pixel[0]=curr_pict;
        picture.pixel[1]=curr_pict+ctl->max_height*ctl->stride0;
        picture.pixel[2]=picture.pixel[1]+ctl->max_height/2*ctl->stride1;
        picture.edge_width=picture.edge_height=0;
#else
        // put quartz image into ctl shm
        ctl->max_width=IMAGE_WIDTH;
        ctl->max_height=IMAGE_HEIGHT;
        ctl->stride0=ctl->max_width*2;
        ctl->format=PIX_FMT_YUV422;

        pict_shmid_sav=ctl->pict_shmid=vout->pic_shm_id;

        picture.format=PIX_FMT_YUV422;
        picture.stride[0]=ctl->stride0;
        picture.pixel[0]=NULL;
        
#endif
        
        osd_shmid_sav=ctl->osd_shmid=vout->osd_shm_id;
        ctl->osd_stride=IMAGE_WIDTH*4;
        ctl->osd_max_width=ctl->osd_width=IMAGE_WIDTH;
        ctl->osd_max_height=ctl->osd_height=IMAGE_HEIGHT;
        ctl->osd_depth=32;
        
        ctl->attached=1;
        //printf("pict_shmid: %d max: (%d,%d), stride0: %d, stride2: %d\n",
        //                       ctl->pict_shmid, ctl->max_width,ctl->max_height,
        //                       ctl->stride0,ctl->stride2);

        ctl->key=NO_KEY;
        (dynamic_cast<cShmRemote*>(quartzRemote))->Start();        
        // wakeup remote thread to unsuspend video/audio
        sem_sig_unlock(ctl->semid,KEY_SIG);

        while (active && vout->IsOpen() ) {
                if (!ctl->attached) {
                        ctl->pict_shmid=pict_shmid_sav;
                        ctl->osd_shmid=osd_shmid_sav;
                        ctl->attached=1;
                };

                //SHMDEB("wait for signal\n");
                sem_wait_lock(ctl->semid,PICT_SIG);
                //SHMDEB("got signal\n");
                sem_wait_lock(ctl->semid,PICT_MUT,SEM_UNDO);
                //SHMDEB("got lock\n");

                if (ctl->new_pict) {
                        int width=ctl->width>ctl->max_width?
                                ctl->max_width:ctl->width;
                        int height=ctl->height>ctl->max_height?
                                ctl->max_height:ctl->height;

                        picture.width=ctl->width;
                        picture.height=ctl->height;
                        picture.dtg_active_format=ctl->new_afd;
                        picture.aspect_ratio=ctl->new_asp;

                        vout->CheckArea(width,height);
                        //vout->CheckAspect(ctl->new_afd,ctl->new_asp);
                        vout->DrawStill_420pl(&picture);
                        ctl->new_pict=0;
                };
                if (ctl->new_osd) {
                        SHMDEB("new osd picture\n");
/*                        if ( !vout->useShm ) {
                                uint8_t *dest_osd;
                                int osd_stride;
                                bool *dirtyLines;
                                vout->GetLockOsdSurface(dest_osd,osd_stride,
                                                dirtyLines);
                                memcpy(dest_osd,curr_osd,ctl->osd_height*osd_stride);
                        };
  */                      vout->CommitUnlockOsdSurface();
                        ctl->new_osd=0;
                };

                vout->GetOSDDimension(ctl->osd_width,ctl->osd_height,
                                      ctl->osd_xPan,ctl->osd_yPan);
                // consumed all pictures - set semaphore to 0
                sem_zero(ctl->semid,PICT_SIG);
                // unlock picture ctl
                sem_sig_unlock(ctl->semid,PICT_MUT,SEM_UNDO);
                //SHMDEB("released the lock\n");
                vout->ProcessEvents();
                // in case there are no semaphores (no vdr connected)
                usleep(3000);
        };
        ctl->attached=0;
        // request removing after detaching
        if ( ctl->pict_shmid > 0)
                shmctl (ctl->pict_shmid, IPC_RMID, 0);
        ctl->pict_shmid=-1;
        delete vout;
};




From nobody at sheep.berlios.de  Wed Apr 11 10:17:32 2007
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 11 Apr 2007 10:17:32 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice configure,1.38,1.39
Message-ID: <20070411081732.C4E922156A@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22808

Modified Files:
	configure 
Log Message:
activate suspend/resume key (r/R) via configure (by Artur Skawina)

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** configure	3 Apr 2007 20:21:04 -0000	1.38
--- configure	11 Apr 2007 08:15:36 -0000	1.39
***************
*** 44,47 ****
--- 44,48 ----
  oss="yes"
  yaepg="auto"
+ suspendkey="yes"
  cpu_bigendian="no"
  
***************
*** 60,63 ****
--- 61,65 ----
    echo "  --disable-alsa"
    echo "  --disable-oss"
+   echo "  --disable-suspendkey"
    echo "  --disable-yaepg / --enable-yapg (yaepg patch support)"
    echo "  --with-ffmpeg-path YOUR_FFMPEG_PATH"
***************
*** 83,86 ****
--- 85,89 ----
      --disable-alsa) shift; alsa="no";;
      --disable-oss) shift; oss="no";;
+     --disable-suspendkey) shift; suspendkey="no";;
      --disable-yaepg) shift; yaepg="no";;
      --enable-yaepg) shift; yaepg="yes";;
***************
*** 110,114 ****
  case "$system" in
    Linux) system="Linux";;
!   Darwin) 
          system="Darwin"
          #with_subplugins="no"
--- 113,117 ----
  case "$system" in
    Linux) system="Linux";;
!   Darwin)
          system="Darwin"
          #with_subplugins="no"
***************
*** 592,595 ****
--- 595,602 ----
  fi
  
+ if test "${suspendkey}" = "yes" ; then
+   echo "#define SUSPEND_BY_KEY 1" >> $TMPH
+ fi
+ 
  if test "${cpu_bigendian}" = "yes" ; then
    echo "#define CPU_BIGENDIAN 1" >> $TMPH
***************
*** 602,606 ****
  if test "${system}" = "Linux"; then
    echo "#define LINUX_RTC 1" >> $TMPH
! fi  
  
  ###############################################################################
--- 609,613 ----
  if test "${system}" = "Linux"; then
    echo "#define LINUX_RTC 1" >> $TMPH
! fi
  
  ###############################################################################



From nobody at sheep.berlios.de  Wed Apr 11 10:25:51 2007
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 11 Apr 2007 10:25:51 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice i18n.c,1.19,1.20
Message-ID: <20070411082551.DB8B22D15D@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23344

Modified Files:
	i18n.c 
Log Message:
some german translations

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** i18n.c	21 Apr 2006 05:47:24 -0000	1.19
--- i18n.c	11 Apr 2007 08:23:55 -0000	1.20
***************
*** 678,682 ****
    },
    { "software",     //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 678,682 ----
    },
    { "software",     //  1
!     "software",     //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 723,728 ****
  #endif
    },
!   { "good seeking", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 723,728 ----
  #endif
    },
!   { "good seeking",         //  1
!     "suchlauf optimiert",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 908,912 ****
    },
    { "Video out",    //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 908,912 ----
    },
    { "Video out",    //  1
!     "Videoausgabe", //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 977,981 ****
    },
    { "Hue",          //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 977,981 ----
    },
    { "Hue",          //  1
!     "Farbart",      //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 1000,1004 ****
    },
    { "Saturation",   //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 1000,1004 ----
    },
    { "Saturation",   //  1
!     "Farbkontrast", //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 1092,1096 ****
    },
    { "Expand top/bottom lines",   //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 1092,1096 ----
    },
    { "Expand top/bottom lines",   //  1
!     "Zeilen vergr??ern (ob./un.)", //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 1115,1119 ****
    },
    { "Expand left/right columns",   //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 1115,1119 ----
    },
    { "Expand left/right columns",   //  1
!     "Spalten vergr??en (li./re.)", //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 1123,1126 ****
--- 1123,1287 ----
      "",             //  8 TODO
      "Levit? reunimmaiset sarakkeet",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Logging",         //  1
+     "Protokollierung", //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Info Messages",         //  1
+     "Info Nachrichten",      //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Debug Messages",         //  1
+     "Debug Nachrichten",      //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Trace Messages",        //  1
+     "Test Nachrichten",      //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Logfile",         //  1
+     "Protokolldatei",  //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Append PID",   //  1
+     "PID erg?nzen", //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Autodetect Movie Aspect",   //  1
+     "Formaterkennung (16:9/4:3)", //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "",             //  9 TODO
      "",             // 10 TODO
      "",             // 11 TODO



From nobody at sheep.berlios.de  Wed Apr 11 10:28:01 2007
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 11 Apr 2007 10:28:01 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice setup-softdevice-menu.c,1.11,1.12
Message-ID: <20070411082801.3DB64214D8@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23556

Modified Files:
	setup-softdevice-menu.c 
Log Message:
moved aspect detection entry to "Cropping" sub menu

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** setup-softdevice-menu.c	3 Apr 2007 19:06:17 -0000	1.11
--- setup-softdevice-menu.c	11 Apr 2007 08:26:05 -0000	1.12
***************
*** 102,105 ****
--- 102,108 ----
                              userKeyUsage));
  
+   Add(new cMenuEditBoolItem(tr("Autodetect Movie Aspect"),
+                             &data->autodetectAspect, tr("no"), tr("yes")));
+ 
  #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
***************
*** 311,317 ****
                              SETUP_VIDEOASPECTNAMES_COUNT,
                              videoAspectNames));
- 
-   Add(new cMenuEditBoolItem(tr("Autodetect Movie Aspect"),
-                             &data->autodetectAspect, tr("no"), tr("yes")));
  
    if (data->outputMethod == VOUT_XV || data->outputMethod == VOUT_VIDIX
--- 314,317 ----



From nobody at sheep.berlios.de  Wed Apr 11 10:37:53 2007
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 11 Apr 2007 10:37:53 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.307, 1.308 README, 1.23,
	1.24 softdevice.c, 1.80, 1.81
Message-ID: <20070411083753.EF136DC93A@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24524

Modified Files:
	CHANGELOG README softdevice.c 
Log Message:
softdevice-0.4.0

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.307
retrieving revision 1.308
diff -C2 -d -r1.307 -r1.308
*** CHANGELOG	3 Apr 2007 21:00:40 -0000	1.307
--- CHANGELOG	11 Apr 2007 08:35:57 -0000	1.308
***************
*** 1,3 ****
--- 1,7 ----
  Changelog
+ 2007-04-11: softdevice-0.4.0
+    - xv-out: activate suspend/resume key (r/R) via configure (by Artur Skawina).
+    - i18n: some german translations.
+    - osd: moved aspect detection entry to "Cropping" sub menu.
  2007-04-03:
     - add automatic border detection, based on a patch by Roland Praml.
***************
*** 6,12 ****
     - make flag for shared linking a variable
     - add BGRA32 mode to SoftOsd
!    - compile linux RTC syncing mode support only on Linux.
!    - detect cpu endianness and define CPU_BIGENDIAN if necessary.
!    - add video-quartz and audio-macos for Mac Os X support
  2007-03-25:
     - fix types in GetTime().
--- 10,16 ----
     - make flag for shared linking a variable
     - add BGRA32 mode to SoftOsd
!    - compile linux RTC syncing mode support only on Linux.
!    - detect cpu endianness and define CPU_BIGENDIAN if necessary.
!    - add video-quartz and audio-macos for Mac Os X support
  2007-03-25:
     - fix types in GetTime().

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** README	11 Nov 2006 08:50:21 -0000	1.23
--- README	11 Apr 2007 08:35:57 -0000	1.24
***************
*** 311,314 ****
--- 311,315 ----
  - Andre Neumann
  - Antti Sepp?l?
+ - Artur Skawina
  - Chris Elsworth
  - Colin Paton

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.80
retrieving revision 1.81
diff -C2 -d -r1.80 -r1.81
*** softdevice.c	3 Apr 2007 20:21:04 -0000	1.80
--- softdevice.c	11 Apr 2007 08:35:57 -0000	1.81
***************
*** 95,99 ****
  #include "setup-softdevice-menu.h"
  
! static const char *VERSION        = "0.3.1";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 95,99 ----
  #include "setup-softdevice-menu.h"
  
! static const char *VERSION        = "0.4.0";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";



From nobody at sheep.berlios.de  Thu Apr 12 10:00:19 2007
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 12 Apr 2007 10:00:19 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice configure,1.39,1.40
Message-ID: <20070412080019.CD677D6DEE@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4153

Modified Files:
	configure 
Log Message:
fix typo (yaepg), rm .dependencies in case of changes

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** configure	11 Apr 2007 08:15:36 -0000	1.39
--- configure	12 Apr 2007 07:58:18 -0000	1.40
***************
*** 62,66 ****
    echo "  --disable-oss"
    echo "  --disable-suspendkey"
!   echo "  --disable-yaepg / --enable-yapg (yaepg patch support)"
    echo "  --with-ffmpeg-path YOUR_FFMPEG_PATH"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
--- 62,66 ----
    echo "  --disable-oss"
    echo "  --disable-suspendkey"
!   echo "  --disable-yaepg / --enable-yaepg (yaepg patch support)"
    echo "  --with-ffmpeg-path YOUR_FFMPEG_PATH"
    echo "  --with-vidix-path YOUR_VIDIX_PATH"
***************
*** 743,749 ****
--- 743,752 ----
  # checking for differences to previous results
  #
+ clean_dep_file="no"
+ 
  diff $TMPH config.h >/dev/null 2>&1
  if test $? -ne 0 ; then
    mv -f $TMPH config.h
+   clean_dep_file="yes"
    echo "updated config.h"
  else
***************
*** 754,760 ****
--- 757,768 ----
  if test $? -ne 0 ; then
    mv -f $TMPM config.mak
+   clean_dep_file="yes"
    echo "updated config.mak"
  else
    echo "config.mak is unchanged"
+ fi
+ 
+ if test "${clean_dep_file}" = "yes" ; then
+   rm -f .dependencies
  fi
  



From nobody at sheep.berlios.de  Thu Apr 12 10:03:27 2007
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 12 Apr 2007 10:03:27 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice configure,1.40,1.41
Message-ID: <20070412080327.A086721847@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4357

Modified Files:
	configure 
Log Message:
new opt: --disable-xinerama

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** configure	12 Apr 2007 07:58:18 -0000	1.40
--- configure	12 Apr 2007 08:01:25 -0000	1.41
***************
*** 60,63 ****
--- 60,64 ----
    echo "  --disable-mmx2"
    echo "  --disable-alsa"
+   echo "  --disable-xinerama"
    echo "  --disable-oss"
    echo "  --disable-suspendkey"
***************
*** 84,87 ****
--- 85,89 ----
      --disable-mmx2) shift; with_mmx2="no";;
      --disable-alsa) shift; alsa="no";;
+     --disable-xinerama) shift; xinerama="no";;
      --disable-oss) shift; oss="no";;
      --disable-suspendkey) shift; suspendkey="no";;



From nobody at sheep.berlios.de  Thu Apr 12 10:11:11 2007
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 12 Apr 2007 10:11:11 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.51,1.52
Message-ID: <20070412081111.939AED98B0@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4890

Modified Files:
	setup-softdevice.c 
Log Message:
fix uninit osdMode: now 1

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** setup-softdevice.c	3 Apr 2007 19:06:17 -0000	1.51
--- setup-softdevice.c	12 Apr 2007 08:09:15 -0000	1.52
***************
*** 114,117 ****
--- 114,118 ----
    vidCaps = 0;
    vidBrightness = vidHue = vidContrast = vidSaturation = -1;
+   osdMode = 1;
  
    /* --------------------------------------------------------------------------



From nobody at sheep.berlios.de  Thu Apr 12 10:33:29 2007
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 12 Apr 2007 10:33:29 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice ShmClient.c,1.21,1.22
Message-ID: <20070412083329.91697DC7CE@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6562

Modified Files:
	ShmClient.c 
Log Message:
fullscreen start option for ShmClient

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** ShmClient.c	15 Jan 2007 19:37:08 -0000	1.21
--- ShmClient.c	12 Apr 2007 08:31:33 -0000	1.22
***************
*** 83,86 ****
--- 83,99 ----
          cSetupStore SetupStore;
          SetupStore.xvFullscreen=0;
+ 
+         if (argc > 1) {
+                 if (strcmp(argv[1], "-f") == 0) {
+                         SetupStore.xvFullscreen=1;
+                 } else {
+                         // unknown or -h option: report available options.
+                         printf ("Shared-Memory-Client for vdr-softdevice\n");
+                         printf ("Options:\n");
+                         printf ("  -f   Start fullscreen\n");
+                         return 0;
+                 }
+         }
+ 
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
          xvRemote= new cShmRemote("softdevice-xv");
***************
*** 110,123 ****
                  exit(-1);
          };
!         
          if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
!        
!         while (!vout->Reconfigure(SetupStore.pixelFormat) 
                          && SetupStore.pixelFormat < 3 )
                  SetupStore.pixelFormat++;
!         
          if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;
--- 123,136 ----
                  exit(-1);
          };
! 
          if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
! 
!         while (!vout->Reconfigure(SetupStore.pixelFormat)
                          && SetupStore.pixelFormat < 3 )
                  SetupStore.pixelFormat++;
! 
          if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;
***************
*** 149,153 ****
                                  break;
                  };
!                 
                  picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
                  picture.stride[0]=picture.stride[1]=picture.stride[2]=0;
--- 162,166 ----
                                  break;
                  };
! 
                  picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
                  picture.stride[0]=picture.stride[1]=picture.stride[2]=0;



From nobody at sheep.berlios.de  Thu Apr 12 10:35:22 2007
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 12 Apr 2007 10:35:22 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.308,1.309
Message-ID: <20070412083522.1982520BF0@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6819

Modified Files:
	CHANGELOG 
Log Message:
update recent changes

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.308
retrieving revision 1.309
diff -C2 -d -r1.308 -r1.309
*** CHANGELOG	11 Apr 2007 08:35:57 -0000	1.308
--- CHANGELOG	12 Apr 2007 08:33:25 -0000	1.309
***************
*** 1,3 ****
--- 1,9 ----
  Changelog
+ 2007-04-12:
+    - configure: fix typo (yaepg),
+                 rm .dependencies in case of changes,
+                 new opt: --disable-xinerama (by Matthias Schwarzott)
+    - fix osdMode not initialized (by Matthias Schwarzott)
+    - ShmClient: full screann start option (by Matthias Schwarzott)
  2007-04-11: softdevice-0.4.0
     - xv-out: activate suspend/resume key (r/R) via configure (by Artur Skawina).



From nobody at sheep.berlios.de  Thu Apr 12 20:00:08 2007
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 12 Apr 2007 20:00:08 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice ShmClient.c, 1.22, 1.23 CHANGELOG, 1.309,
	1.310
Message-ID: <20070412180008.C4B4CE1F6A@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20702

Modified Files:
	ShmClient.c CHANGELOG 
Log Message:
revertet previous change, as it breaks argument style of softdevice

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** ShmClient.c	12 Apr 2007 08:31:33 -0000	1.22
--- ShmClient.c	12 Apr 2007 17:58:11 -0000	1.23
***************
*** 83,99 ****
          cSetupStore SetupStore;
          SetupStore.xvFullscreen=0;
- 
-         if (argc > 1) {
-                 if (strcmp(argv[1], "-f") == 0) {
-                         SetupStore.xvFullscreen=1;
-                 } else {
-                         // unknown or -h option: report available options.
-                         printf ("Shared-Memory-Client for vdr-softdevice\n");
-                         printf ("Options:\n");
-                         printf ("  -f   Start fullscreen\n");
-                         return 0;
-                 }
-         }
- 
          cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
          xvRemote= new cShmRemote("softdevice-xv");
--- 83,86 ----
***************
*** 123,136 ****
                  exit(-1);
          };
! 
          if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
! 
!         while (!vout->Reconfigure(SetupStore.pixelFormat)
                          && SetupStore.pixelFormat < 3 )
                  SetupStore.pixelFormat++;
! 
          if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;
--- 110,123 ----
                  exit(-1);
          };
!         
          if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
                  exit(-1);
          };
!        
!         while (!vout->Reconfigure(SetupStore.pixelFormat) 
                          && SetupStore.pixelFormat < 3 )
                  SetupStore.pixelFormat++;
!         
          if ( vout->useShm && vout->xv_image ) {
                  ctl->pict_shmid= vout->shminfo.shmid;
***************
*** 162,166 ****
                                  break;
                  };
! 
                  picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
                  picture.stride[0]=picture.stride[1]=picture.stride[2]=0;
--- 149,153 ----
                                  break;
                  };
!                 
                  picture.pixel[0]=picture.pixel[1]=picture.pixel[2]=NULL;
                  picture.stride[0]=picture.stride[1]=picture.stride[2]=0;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.309
retrieving revision 1.310
diff -C2 -d -r1.309 -r1.310
*** CHANGELOG	12 Apr 2007 08:33:25 -0000	1.309
--- CHANGELOG	12 Apr 2007 17:58:11 -0000	1.310
***************
*** 1,9 ****
  Changelog
  2007-04-12:
     - configure: fix typo (yaepg),
                  rm .dependencies in case of changes,
                  new opt: --disable-xinerama (by Matthias Schwarzott)
     - fix osdMode not initialized (by Matthias Schwarzott)
!    - ShmClient: full screann start option (by Matthias Schwarzott)
  2007-04-11: softdevice-0.4.0
     - xv-out: activate suspend/resume key (r/R) via configure (by Artur Skawina).
--- 1,11 ----
  Changelog
  2007-04-12:
+    - ShmClient: revertet previous change, as it breaks argument style
+                 of softdevice.
     - configure: fix typo (yaepg),
                  rm .dependencies in case of changes,
                  new opt: --disable-xinerama (by Matthias Schwarzott)
     - fix osdMode not initialized (by Matthias Schwarzott)
!    - ShmClient: full screen start option (by Matthias Schwarzott)
  2007-04-11: softdevice-0.4.0
     - xv-out: activate suspend/resume key (r/R) via configure (by Artur Skawina).



From nobody at sheep.berlios.de  Thu May 10 21:59:27 2007
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 10 May 2007 21:59:27 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice MacVdrClient.c,1.1,1.2
Message-ID: <20070510195927.4CA69F0264@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18963

Modified Files:
	MacVdrClient.c 
Log Message:
- adapt MacVdrClient.c to the setupStore in shared memory.


Index: MacVdrClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/MacVdrClient.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** MacVdrClient.c	3 Apr 2007 21:43:35 -0000	1.1
--- MacVdrClient.c	10 May 2007 19:57:19 -0000	1.2
***************
*** 81,91 ****
  
  int main(int argc, char **argv) {
!         cSetupStore SetupStore;
          int pict_shmid_sav;
          int osd_shmid_sav;
-         SetupStore.xvFullscreen=0;
-         cQuartzVideoOut *vout=new cQuartzVideoOut(&SetupStore);
-         quartzRemote= new cShmRemote("softdevice-quartz");
- 
          signal(SIGINT,sig_handler);
          signal(SIGQUIT,sig_handler);
--- 81,88 ----
  
  int main(int argc, char **argv) {
!         cSetupStore *SetupStore=NULL;
!         cSetupSoftlog *softlog=new cSetupSoftlog();
          int pict_shmid_sav;
          int osd_shmid_sav;
          signal(SIGINT,sig_handler);
          signal(SIGQUIT,sig_handler);
***************
*** 103,107 ****
                  fprintf(stderr,"ctl_shmid error in shmget!\n");
                  fprintf(stderr,"Check if the Vdr is running with the softdevice and the option \"-vo shm:\"!\n");
-                 delete vout;
                  exit(1);
          }
--- 100,103 ----
***************
*** 110,116 ****
                          == (ShmCtlBlock *) -1 ) {
                  fprintf(stderr,"ctl_shmid error attatching shm ctl %d!\n",ctl_shmid);
-                 delete vout;
                  exit(-1);
          };
  
          if ( !vout->Initialize() ) {
--- 106,122 ----
                          == (ShmCtlBlock *) -1 ) {
                  fprintf(stderr,"ctl_shmid error attatching shm ctl %d!\n",ctl_shmid);
                  exit(-1);
          };
+ 
+         if ( (SetupStore = (cSetupStore *) shmat(ctl->setup_shmid,NULL,0))
+                         == (cSetupStore *) -1 ) {
+                 fprintf(stderr,"Error attatching to setupStore shm (id: %d)!\n",
+                                 ctl->setup_shmid);
+                 exit(-1);
+         };
+ 
+         cQuartzVideoOut *vout=new cQuartzVideoOut(SetupStore,softlog);
+         quartzRemote= new cShmRemote("softdevice-quartz");
+         SetupStore->xvFullscreen=0;
  
          if ( !vout->Initialize() ) {



From nobody at sheep.berlios.de  Thu May 10 21:51:59 2007
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 10 May 2007 21:51:59 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.310, 1.311 ShmClient.c,
	1.23, 1.24 VideoFilter.c, 1.4, 1.5 mpeg2decoder.c, 1.74,
	1.75 setup-softdevice-menu.c, 1.12, 1.13 setup-softdevice.c,
	1.52, 1.53 setup-softdevice.h, 1.40, 1.41 setup-softlog-menu.c,
	1.2, 1.3 shm-common.h, 1.8, 1.9 softdevice.c, 1.81,
	1.82 utils.c, 1.25, 1.26 utils.h, 1.16, 1.17 video-dfb.c, 1.79,
	1.80 video-xv.c, 1.68, 1.69
Message-ID: <20070510195159.52CE2D7E48@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17487

Modified Files:
	CHANGELOG ShmClient.c VideoFilter.c mpeg2decoder.c 
	setup-softdevice-menu.c setup-softdevice.c setup-softdevice.h 
	setup-softlog-menu.c shm-common.h softdevice.c utils.c utils.h 
	video-dfb.c video-xv.c 
Log Message:
- move setupStore into a shared memory block. This allows ShmClient to
  have acces to the setupStore.
- move CatchRemoteKey() into utils.c, else setup-softdevice.o would
  have to be linked into libsoftdevice-xv.so and -dfb.so



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.310
retrieving revision 1.311
diff -C2 -d -r1.310 -r1.311
*** CHANGELOG	12 Apr 2007 17:58:11 -0000	1.310
--- CHANGELOG	10 May 2007 19:49:51 -0000	1.311
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2007-05-10:
+    - move setupStore into a shared memory block. This allows ShmClient to
+      have acces to the setupStore.
+    - move CatchRemoteKey() into utils.c, else setup-softdevice.o would
+      have to be linked into libsoftdevice-xv.so and -dfb.so
  2007-04-12:
     - ShmClient: revertet previous change, as it breaks argument style

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** ShmClient.c	12 Apr 2007 17:58:11 -0000	1.23
--- ShmClient.c	10 May 2007 19:49:51 -0000	1.24
***************
*** 81,88 ****
  
  int main(int argc, char **argv) {
!         cSetupStore SetupStore;
!         SetupStore.xvFullscreen=0;
!         cXvVideoOut *vout=new cXvVideoOut(&SetupStore);
!         xvRemote= new cShmRemote("softdevice-xv");
  
          signal(SIGINT,sig_handler);
--- 81,85 ----
  
  int main(int argc, char **argv) {
!         cSetupStore *SetupStore=NULL;
  
          signal(SIGINT,sig_handler);
***************
*** 110,114 ****
                  exit(-1);
          };
!         
          if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
--- 107,123 ----
                  exit(-1);
          };
! 
!         if ( (SetupStore = (cSetupStore *) shmat(ctl->setup_shmid,NULL,0))
!                         == (cSetupStore *) -1 ) {
!                 fprintf(stderr,"Error attatching to setupStore shm (id: %d)!\n",
!                                 ctl->setup_shmid);
!                 exit(-1);
!         };
! 
!         cXvVideoOut *vout=new cXvVideoOut(SetupStore);
!         xvRemote= new cShmRemote("softdevice-xv");
!         //SetupStore.InitSetupStore();
!         SetupStore->xvFullscreen=0;
! 
          if ( !vout->Initialize()  ) {
                  fprintf(stderr,"Could not init video out!\n");
***************
*** 116,122 ****
          };
         
!         while (!vout->Reconfigure(SetupStore.pixelFormat) 
!                         && SetupStore.pixelFormat < 3 )
!                 SetupStore.pixelFormat++;
          
          if ( vout->useShm && vout->xv_image ) {
--- 125,131 ----
          };
         
!         while (!vout->Reconfigure(SetupStore->pixelFormat) 
!                         && SetupStore->pixelFormat < 3 )
!                 SetupStore->pixelFormat++;
          
          if ( vout->useShm && vout->xv_image ) {

Index: VideoFilter.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** VideoFilter.c	3 Apr 2007 19:06:17 -0000	1.4
--- VideoFilter.c	10 May 2007 19:49:51 -0000	1.5
***************
*** 91,95 ****
                  "[softdevice] no picture buffer is allocated for mirroring !\n"
                  "[softdevice] switching mirroring off !\n");
!             setupStore.mirror = 0;
              return;
      }
--- 91,95 ----
                  "[softdevice] no picture buffer is allocated for mirroring !\n"
                  "[softdevice] switching mirroring off !\n");
!             setupStore->mirror = 0;
              return;
      }
***************
*** 160,164 ****
                  "[softdevice] no picture buffer is allocated for deinterlacing!\n"
                  "[softdevice] switching deinterlacing off !\n");
!             setupStore.deintMethod = 0;
              return;
      }
--- 160,164 ----
                  "[softdevice] no picture buffer is allocated for deinterlacing!\n"
                  "[softdevice] switching deinterlacing off !\n");
!             setupStore->deintMethod = 0;
              return;
      }
***************
*** 191,195 ****
                              "[softdevice] error, libavcodec deinterlacer failure\n"
                              "[softdevice] switching deinterlacing off !\n");
!             setupStore.deintMethod = 0;
              return;
      }
--- 191,195 ----
                              "[softdevice] error, libavcodec deinterlacer failure\n"
                              "[softdevice] switching deinterlacing off !\n");
!             setupStore->deintMethod = 0;
              return;
      }
***************
*** 441,445 ****
                                  "[softdevice] no picture buffer is allocated for post processing!\n"
                                  "[softdevice] switching post processing off !\n");
!                 setupStore.deintMethod = setupStore.ppMethod = 0;
                  return;
          }
--- 441,445 ----
                                  "[softdevice] no picture buffer is allocated for post processing!\n"
                                  "[softdevice] switching post processing off !\n");
!                 setupStore->deintMethod = setupStore->ppMethod = 0;
                  return;
          }
***************
*** 480,490 ****
          
          if ( ppmode == NULL 
!                         || currentDeintMethod != setupStore.deintMethod 
!                         || currentppMethod != setupStore.ppMethod
!                         || currentppQuality != setupStore.ppQuality ) {
                  // reallocate ppmode if method or quality changed
!                 currentDeintMethod = setupStore.deintMethod;
!                 currentppMethod = setupStore.ppMethod;
!                 currentppQuality = setupStore.ppQuality;
  
                  if (ppmode)  {
--- 480,490 ----
          
          if ( ppmode == NULL 
!                         || currentDeintMethod != setupStore->deintMethod 
!                         || currentppMethod != setupStore->ppMethod
!                         || currentppQuality != setupStore->ppQuality ) {
                  // reallocate ppmode if method or quality changed
!                 currentDeintMethod = setupStore->deintMethod;
!                 currentppMethod = setupStore->ppMethod;
!                 currentppQuality = setupStore->ppQuality;
  
                  if (ppmode)  {
***************
*** 493,503 ****
                  }
                  char mode[60]="";
!                 if (setupStore.getPPdeintValue() && setupStore.getPPValue())
!                         sprintf(mode,"%s,%s",setupStore.getPPdeintValue(),
!                                         setupStore.getPPValue());
!                 else if (setupStore.getPPdeintValue() )
!                         sprintf(mode,"%s",setupStore.getPPdeintValue());
!                 else if (setupStore.getPPValue() )
!                         sprintf(mode,"%s",setupStore.getPPValue());
  
                  ppmode = pp_get_mode_by_name_and_quality(mode, currentppQuality);
--- 493,503 ----
                  }
                  char mode[60]="";
!                 if (setupStore->getPPdeintValue() && setupStore->getPPValue())
!                         sprintf(mode,"%s,%s",setupStore->getPPdeintValue(),
!                                         setupStore->getPPValue());
!                 else if (setupStore->getPPdeintValue() )
!                         sprintf(mode,"%s",setupStore->getPPdeintValue());
!                 else if (setupStore->getPPValue() )
!                         sprintf(mode,"%s",setupStore->getPPValue());
  
                  ppmode = pp_get_mode_by_name_and_quality(mode, currentppQuality);
***************
*** 508,513 ****
                          "[softdevice] pp-filter %s couldn't be initialized,\n"
                          "[softdevice] switching postprocessing off !\n",
!                         setupStore.getPPValue());
!                 setupStore.deintMethod = setupStore.ppMethod = 0;
                  return;
          }
--- 508,513 ----
                          "[softdevice] pp-filter %s couldn't be initialized,\n"
                          "[softdevice] switching postprocessing off !\n",
!                         setupStore->getPPValue());
!                 setupStore->deintMethod = setupStore->ppMethod = 0;
                  return;
          }

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.74
retrieving revision 1.75
diff -C2 -d -r1.74 -r1.75
*** mpeg2decoder.c	3 Apr 2007 19:23:30 -0000	1.74
--- mpeg2decoder.c	10 May 2007 19:49:51 -0000	1.75
***************
*** 137,141 ****
  
  cStreamDecoder::cStreamDecoder(AVCodecContext *Context, bool packetMode)
!         : PacketQueue(packet_buf_size[setupStore.bufferMode])
  {
    context=Context;
--- 137,141 ----
  
  cStreamDecoder::cStreamDecoder(AVCodecContext *Context, bool packetMode)
!         : PacketQueue(packet_buf_size[setupStore->bufferMode])
  {
    context=Context;
***************
*** 335,339 ****
  {
    MPGDEB("pts %lld aDelay: %d ",pts,audioOut->GetDelay());
!   uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset*10;
   return PTS;
  };
--- 335,339 ----
  {
    MPGDEB("pts %lld aDelay: %d ",pts,audioOut->GetDelay());
!   uint64_t PTS= pts - audioOut->GetDelay() + setupStore->avOffset*10;
   return PTS;
  };
***************
*** 376,380 ****
    if (context->codec_id == CODEC_ID_AC3)
    {
!     switch(setupStore.ac3Mode)
      {
        case 0:
--- 376,380 ----
    if (context->codec_id == CODEC_ID_AC3)
    {
!     switch(setupStore->ac3Mode)
      {
        case 0:
***************
*** 406,410 ****
            pkt->pts=AV_NOPTS_VALUE;
          }
!         PTS = pts - audioOut->GetDelay() + setupStore.avOffset*10;
  #if AC3_PTS_TRACE
          fprintf (stderr, "audio pts offset %lld %d\n",
--- 406,410 ----
            pkt->pts=AV_NOPTS_VALUE;
          }
!         PTS = pts - audioOut->GetDelay() + setupStore->avOffset*10;
  #if AC3_PTS_TRACE
          fprintf (stderr, "audio pts offset %lld %d\n",
***************
*** 487,491 ****
        pkt->pts=AV_NOPTS_VALUE;
      }
!     uint64_t PTS= pts - audioOut->GetDelay() + setupStore.avOffset*10;
  
      MPGDEB("audio pts offset %lld\n",cClock::GetTime()-PTS);
--- 487,491 ----
        pkt->pts=AV_NOPTS_VALUE;
      }
!     uint64_t PTS= pts - audioOut->GetDelay() + setupStore->avOffset*10;
  
      MPGDEB("audio pts offset %lld\n",cClock::GetTime()-PTS);
***************
*** 607,611 ****
    // init A-V syncing variables
    offset=0;
!   syncTimer = new cSyncTimer ((eSyncMode) setupStore.syncTimerMode);
    syncTimer->Reset();
    videoOut->ResetDelay();
--- 607,611 ----
    // init A-V syncing variables
    offset=0;
!   syncTimer = new cSyncTimer ((eSyncMode) setupStore->syncTimerMode);
    syncTimer->Reset();
    videoOut->ResetDelay();
***************
*** 833,837 ****
          pkt->stream_index,data,size);
  #ifdef HAVE_CLE266_MPEG_DECODER
!     if (setupStore.cle266HWdecode && context->codec_id == CODEC_ID_MPEG2VIDEO)
              len = DecodePicture_cle266(pic, got_picture,
                                  data, size, pkt->pts);
--- 833,837 ----
          pkt->stream_index,data,size);
  #ifdef HAVE_CLE266_MPEG_DECODER
!     if (setupStore->cle266HWdecode && context->codec_id == CODEC_ID_MPEG2VIDEO)
              len = DecodePicture_cle266(pic, got_picture,
                                  data, size, pkt->pts);
***************
*** 878,895 ****
  
      // postproc stuff....
!     if (setupStore.mirror == 1)
        Mirror.Filter(pic,pic);
  
!     if (setupStore.deintMethod == 1)
        DeintLibav.Filter(pic,pic);
  
!     if (setupStore.autodetectAspect)
              BorderDetect.Filter(pic,pic);
      
  #ifdef PP_LIBAVCODEC
  #ifdef FB_SUPPORT
!     if (setupStore.deintMethod > 2 || setupStore.ppMethod!=0 )
  #else
!     if (setupStore.deintMethod > 1 || setupStore.ppMethod!=0 )
  #endif //FB_SUPPORT
        LibAvPostProc.Filter(pic,pic);
--- 878,895 ----
  
      // postproc stuff....
!     if (setupStore->mirror == 1)
        Mirror.Filter(pic,pic);
  
!     if (setupStore->deintMethod == 1)
        DeintLibav.Filter(pic,pic);
  
!     if (setupStore->autodetectAspect)
              BorderDetect.Filter(pic,pic);
      
  #ifdef PP_LIBAVCODEC
  #ifdef FB_SUPPORT
!     if (setupStore->deintMethod > 2 || setupStore->ppMethod!=0 )
  #else
!     if (setupStore->deintMethod > 1 || setupStore->ppMethod!=0 )
  #endif //FB_SUPPORT
        LibAvPostProc.Filter(pic,pic);
***************
*** 1101,1105 ****
     };
  
!    init_put_byte(&ic->pb, NULL,dvb_buf_size[setupStore.bufferMode]/2, 0, this,
         read_packet_RingBuffer,NULL,seek_RingBuffer);
     ic->pb.buf_end=NULL;
--- 1101,1105 ----
     };
  
!    init_put_byte(&ic->pb, NULL,dvb_buf_size[setupStore->bufferMode]/2, 0, this,
         read_packet_RingBuffer,NULL,seek_RingBuffer);
     ic->pb.buf_end=NULL;
***************
*** 1310,1314 ****
  	StreamBuffer=NULL;
    };
!   StreamBuffer=new cSoftRingBufferLinear(dvb_buf_size[setupStore.bufferMode],0);
    StreamBuffer->Clear();
    initStream();
--- 1310,1314 ----
  	StreamBuffer=NULL;
    };
!   StreamBuffer=new cSoftRingBufferLinear(dvb_buf_size[setupStore->bufferMode],0);
    StreamBuffer->Clear();
    initStream();
***************
*** 1341,1345 ****
          fprintf(stderr,"Could not open video out! Sleeping again...\n");
          videoOut->Suspend();
!         setupStore.shouldSuspend=true;
          IsSuspended=true;
          return;
--- 1341,1345 ----
          fprintf(stderr,"Could not open video out! Sleeping again...\n");
          videoOut->Suspend();
!         setupStore->shouldSuspend=true;
          IsSuspended=true;
          return;
***************
*** 1348,1352 ****
    if (!audioOut->Resume()) {
          fprintf(stderr,"Could not open audio out! Sleeping again...\n");
!         setupStore.shouldSuspend=true;
          IsSuspended=true;
          videoOut->Suspend();
--- 1348,1352 ----
    if (!audioOut->Resume()) {
          fprintf(stderr,"Could not open audio out! Sleeping again...\n");
!         setupStore->shouldSuspend=true;
          IsSuspended=true;
          videoOut->Suspend();
***************
*** 1617,1625 ****
    BUFDEB("Decode %p, Length %d\n",Data,Length);
  
!   if (running && !IsSuspended && setupStore.shouldSuspend)
       // still running and should suspend
       Suspend();
  
!   if (!running && IsSuspended && !setupStore.shouldSuspend)
       // not running and should resume
       Resume();
--- 1617,1625 ----
    BUFDEB("Decode %p, Length %d\n",Data,Length);
  
!   if (running && !IsSuspended && setupStore->shouldSuspend)
       // still running and should suspend
       Suspend();
  
!   if (!running && IsSuspended && !setupStore->shouldSuspend)
       // not running and should resume
       Resume();

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** setup-softdevice-menu.c	11 Apr 2007 08:26:05 -0000	1.12
--- setup-softdevice-menu.c	10 May 2007 19:49:51 -0000	1.13
***************
*** 15,20 ****
  cMenuSetupVideoParm::cMenuSetupVideoParm(const char *name) : cOsdMenu(name, 33)
  {
!   copyData = setupStore;
!   data = &setupStore;
  
    if (data->vidCaps & CAP_BRIGHTNESS)
--- 15,20 ----
  cMenuSetupVideoParm::cMenuSetupVideoParm(const char *name) : cOsdMenu(name, 33)
  {
!   copyData = *setupStore;
!   data = setupStore;
  
    if (data->vidCaps & CAP_BRIGHTNESS)
***************
*** 74,78 ****
        break;
      case osBack:
!       setupStore = copyData;
        fprintf (stderr, "[setup-videoparm] restoring setup state\n");
        break;
--- 74,78 ----
        break;
      case osBack:
!       *setupStore = copyData;
        fprintf (stderr, "[setup-videoparm] restoring setup state\n");
        break;
***************
*** 87,92 ****
  cMenuSetupCropping::cMenuSetupCropping(const char *name) : cOsdMenu(name, 33)
  {
!   copyData = setupStore;
!   data = &setupStore;
  
    crop_str[0] = tr("none");
--- 87,92 ----
  cMenuSetupCropping::cMenuSetupCropping(const char *name) : cOsdMenu(name, 33)
  {
!   copyData = *setupStore;
!   data = setupStore;
  
    crop_str[0] = tr("none");
***************
*** 189,193 ****
        break;
      case osBack:
!       setupStore = copyData;
        fprintf (stderr, "[setup-cropping] restoring setup state\n");
        break;
--- 189,193 ----
        break;
      case osBack:
!       *setupStore = copyData;
        fprintf (stderr, "[setup-cropping] restoring setup state\n");
        break;
***************
*** 202,207 ****
  cMenuSetupPostproc::cMenuSetupPostproc(const char *name) : cOsdMenu(name, 33)
  {
!   copyData = setupStore;
!   data = &setupStore;
  
    deint_str[0] = tr("none");
--- 202,207 ----
  cMenuSetupPostproc::cMenuSetupPostproc(const char *name) : cOsdMenu(name, 33)
  {
!   copyData = *setupStore;
!   data = setupStore;
  
    deint_str[0] = tr("none");
***************
*** 263,267 ****
        break;
      case osBack:
!       setupStore = copyData;
        fprintf (stderr, "[setup-postproc] restoring setup state\n");
        break;
--- 263,267 ----
        break;
      case osBack:
!       *setupStore = copyData;
        fprintf (stderr, "[setup-postproc] restoring setup state\n");
        break;
***************
*** 280,285 ****
    this->plugin = plugin;
  
!   copyData = setupStore;
!   data = &setupStore;
  
    Add(new cOsdItem(tr("Cropping")));
--- 280,285 ----
    this->plugin = plugin;
  
!   copyData = *setupStore;
!   data = setupStore;
  
    Add(new cOsdItem(tr("Cropping")));
***************
*** 433,437 ****
        break;
      case osBack:
!       setupStore = copyData;
        fprintf (stderr, "[setup-softdevice] restoring setup state\n");
        break;
--- 433,437 ----
        break;
      case osBack:
!       *setupStore = copyData;
        fprintf (stderr, "[setup-softdevice] restoring setup state\n");
        break;
***************
*** 447,451 ****
  {
  #if 0
!   if (setupStore.deintMethod != data.deintMethod) {
      fprintf(stderr,
              "[setup-softdevice] deinterlace method changed to (%d) %s\n",
--- 447,451 ----
  {
  #if 0
!   if (setupStore->deintMethod != data.deintMethod) {
      fprintf(stderr,
              "[setup-softdevice] deinterlace method changed to (%d) %s\n",
***************
*** 457,492 ****
    fprintf (stderr, "[setup-softdevice] storing data\n");
  //  setupStore = data;
!   SetupStore ("Xv-Aspect",          setupStore.xvAspect);
    // don't save max area value as it is ignored on load
!   //SetupStore ("Xv-MaxArea",         setupStore.xvMaxArea);
!   SetupStore ("CropMode",           setupStore.cropMode);
!   SetupStore ("CropModeToggleKey",     setupStore.cropModeToggleKey);
!   SetupStore ("CropTopLines",        setupStore.cropTopLines);
!   SetupStore ("CropBottomLines",     setupStore.cropBottomLines);
!   SetupStore ("CropLeftCols",        setupStore.cropLeftCols);
!   SetupStore ("CropRightCols",       setupStore.cropRightCols);
!   SetupStore ("Deinterlace Method", setupStore.deintMethod);
!   SetupStore ("Postprocess Method", setupStore.ppMethod);
!   SetupStore ("Postprocess Quality", setupStore.ppQuality);
!   SetupStore ("PixelFormat",        setupStore.pixelFormat);
!   SetupStore ("UseStretchBlit",     setupStore.useStretchBlit);
!   SetupStore ("UseSetSourceRectangle",     setupStore.useSetSourceRectangle);
!   SetupStore ("Picture mirroring",  setupStore.mirror);
!   SetupStore ("avOffset",           setupStore.avOffset);
!   SetupStore ("AlsaDevice",         setupStore.alsaDevice);
!   SetupStore ("AlsaAC3Device",      setupStore.alsaAC3Device);
!   SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
!   SetupStore ("Suspend",            setupStore.shouldSuspend);
!   SetupStore ("OSDalphablend",      setupStore.osdMode);
!   SetupStore ("AC3Mode",            setupStore.ac3Mode);
!   SetupStore ("bufferMode",           setupStore.bufferMode);
!   SetupStore ("mainMenu",             setupStore.mainMenu);
!   SetupStore ("syncTimerMode",        setupStore.syncTimerMode);
!   SetupStore ("vidBrightness",        setupStore.vidBrightness);
!   SetupStore ("vidContrast",          setupStore.vidContrast);
!   SetupStore ("vidHue",               setupStore.vidHue);
!   SetupStore ("vidSaturation",        setupStore.vidSaturation);
!   SetupStore ("ExpandTopBottomLines", setupStore.expandTopBottomLines);
!   SetupStore ("ExpandLeftRightCols",  setupStore.expandLeftRightCols);
!   SetupStore ("autodetectAspect",     setupStore.autodetectAspect);
  }
--- 457,492 ----
    fprintf (stderr, "[setup-softdevice] storing data\n");
  //  setupStore = data;
!   SetupStore ("Xv-Aspect",          setupStore->xvAspect);
    // don't save max area value as it is ignored on load
!   //SetupStore ("Xv-MaxArea",         setupStore->xvMaxArea);
!   SetupStore ("CropMode",           setupStore->cropMode);
!   SetupStore ("CropModeToggleKey",     setupStore->cropModeToggleKey);
!   SetupStore ("CropTopLines",        setupStore->cropTopLines);
!   SetupStore ("CropBottomLines",     setupStore->cropBottomLines);
!   SetupStore ("CropLeftCols",        setupStore->cropLeftCols);
!   SetupStore ("CropRightCols",       setupStore->cropRightCols);
!   SetupStore ("Deinterlace Method", setupStore->deintMethod);
!   SetupStore ("Postprocess Method", setupStore->ppMethod);
!   SetupStore ("Postprocess Quality", setupStore->ppQuality);
!   SetupStore ("PixelFormat",        setupStore->pixelFormat);
!   SetupStore ("UseStretchBlit",     setupStore->useStretchBlit);
!   SetupStore ("UseSetSourceRectangle",     setupStore->useSetSourceRectangle);
!   SetupStore ("Picture mirroring",  setupStore->mirror);
!   SetupStore ("avOffset",           setupStore->avOffset);
!   SetupStore ("AlsaDevice",         setupStore->alsaDevice);
!   SetupStore ("AlsaAC3Device",      setupStore->alsaAC3Device);
!   SetupStore ("PixelAspect",        setupStore->screenPixelAspect);
!   SetupStore ("Suspend",            setupStore->shouldSuspend);
!   SetupStore ("OSDalphablend",      setupStore->osdMode);
!   SetupStore ("AC3Mode",            setupStore->ac3Mode);
!   SetupStore ("bufferMode",           setupStore->bufferMode);
!   SetupStore ("mainMenu",             setupStore->mainMenu);
!   SetupStore ("syncTimerMode",        setupStore->syncTimerMode);
!   SetupStore ("vidBrightness",        setupStore->vidBrightness);
!   SetupStore ("vidContrast",          setupStore->vidContrast);
!   SetupStore ("vidHue",               setupStore->vidHue);
!   SetupStore ("vidSaturation",        setupStore->vidSaturation);
!   SetupStore ("ExpandTopBottomLines", setupStore->expandTopBottomLines);
!   SetupStore ("ExpandLeftRightCols",  setupStore->expandLeftRightCols);
!   SetupStore ("autodetectAspect",     setupStore->autodetectAspect);
  }

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** setup-softdevice.c	12 Apr 2007 08:09:15 -0000	1.52
--- setup-softdevice.c	10 May 2007 19:49:51 -0000	1.53
***************
*** 75,81 ****
  /* ----------------------------------------------------------------------------
   */
! cSetupStore setupStore;
  
! cSetupStore::cSetupStore ()
  {
    xvAspect      = 1;   // XV_FORMAT_NORMAL;
--- 75,82 ----
  /* ----------------------------------------------------------------------------
   */
! cSetupStore *setupStore=NULL;
! int setupStoreShmId=-1;
  
! void cSetupStore::InitSetupStore()
  {
    xvAspect      = 1;   // XV_FORMAT_NORMAL;
***************
*** 131,135 ****
    strcpy (alsaDevice, "");
    strcpy (alsaAC3Device, "");
-   voArgs = aoArgs = NULL;
  
    xv_startup_aspect[0] = tr("16:9 wide");
--- 132,135 ----
***************
*** 413,444 ****
  }
  
- /* ---------------------------------------------------------------------------
-  */
- void cSetupStore::CropModeNext(void)
- {
-   cropMode = (cropMode == (SETUP_CROPMODES-1)) ? 0 : cropMode + 1;
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- bool cSetupStore::CatchRemoteKey(const char *remoteName, uint64_t key)
- {
- #ifndef STAND_ALONE
-     char  buffer[32];
-     eKeys keySym;
- 
-   snprintf(buffer, sizeof(buffer), "%016LX", (uint64_t) key);
-   keySym = Keys.Get(remoteName, buffer);
-   if (keySym >= kUser1 && keySym <= kUser9)
-   {
-     keySym = (eKeys) (keySym - kUser1 + 1);
-     if (cropModeToggleKey && cropModeToggleKey == keySym)
-     {
-       CropModeNext();
-       return true;
-     }
-   }
- #endif
-   return false;
- }
  
--- 413,415 ----

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** setup-softdevice.h	3 Apr 2007 21:00:40 -0000	1.40
--- setup-softdevice.h	10 May 2007 19:49:51 -0000	1.41
***************
*** 116,129 ****
  /* ---------------------------------------------------------------------------
   */
! class cSetupStore {
    public:
!                   cSetupStore ();
!     virtual       ~cSetupStore () {};
      bool          SetupParse(const char *Name, const char *Value);
      char          *getPPdeintValue(void);
      char          *getPPValue(void);
!     void          CropModeNext(void);
! 
!     virtual bool  CatchRemoteKey(const char *remoteName, uint64_t key);
  
      int   xvAspect;
--- 116,128 ----
  /* ---------------------------------------------------------------------------
   */
! struct cSetupStore {
    public:
!     void InitSetupStore();
      bool          SetupParse(const char *Name, const char *Value);
      char          *getPPdeintValue(void);
      char          *getPPValue(void);
!     inline void CropModeNext(void) {
!        cropMode = (cropMode == (SETUP_CROPMODES-1)) ? 0 : cropMode + 1;
!     };
  
      int   xvAspect;
***************
*** 177,182 ****
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
      char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];
-     char  *voArgs;
-     char  *aoArgs;
  
      cSetupSoftlog *softlog;
--- 176,179 ----
***************
*** 197,201 ****
  }
  
! extern cSetupStore setupStore;
  
  #endif //__SETUP_SOFTDEVICE_H
--- 194,199 ----
  }
  
! extern cSetupStore *setupStore;
! extern int setupStoreShmId;
  
  #endif //__SETUP_SOFTDEVICE_H

Index: setup-softlog-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog-menu.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** setup-softlog-menu.c	11 Feb 2007 10:31:27 -0000	1.2
--- setup-softlog-menu.c	10 May 2007 19:49:51 -0000	1.3
***************
*** 16,22 ****
      SetPlugin(plugin);
  
!   strncpy(newLogFileName, setupStore.softlog->GetLogFileName(), 256);
!   newLogPriorities = setupStore.softlog->GetLogPriorities();
!   newAppendMode = setupStore.softlog->GetAppendMode();
  
    Add(new cMenuEditBitItem(tr("Info Messages"),
--- 16,22 ----
      SetPlugin(plugin);
  
!   strncpy(newLogFileName, setupStore->softlog->GetLogFileName(), 256);
!   newLogPriorities = setupStore->softlog->GetLogPriorities();
!   newAppendMode = setupStore->softlog->GetAppendMode();
  
    Add(new cMenuEditBitItem(tr("Info Messages"),
***************
*** 77,90 ****
  void cMenuSetupSoftlog::Store(void)
  {
!   if (strcmp(newLogFileName, setupStore.softlog->GetLogFileName()))
!     setupStore.softlog->SetLogFile(newLogFileName);
!   SetupStore ("softlog-file",       setupStore.softlog->GetLogFileName());
  
!   setupStore.softlog->SetAppendMode(newAppendMode);
!   SetupStore ("softlog-appendpid",  setupStore.softlog->GetAppendMode());
  
!   if (newLogPriorities != setupStore.softlog->GetLogPriorities())
!     setupStore.softlog->SetLogPriorities(newLogPriorities);
!   SetupStore ("softlog-priorities", setupStore.softlog->GetLogPriorities());
  
  }
--- 77,90 ----
  void cMenuSetupSoftlog::Store(void)
  {
!   if (strcmp(newLogFileName, setupStore->softlog->GetLogFileName()))
!     setupStore->softlog->SetLogFile(newLogFileName);
!   SetupStore ("softlog-file",       setupStore->softlog->GetLogFileName());
  
!   setupStore->softlog->SetAppendMode(newAppendMode);
!   SetupStore ("softlog-appendpid",  setupStore->softlog->GetAppendMode());
  
!   if (newLogPriorities != setupStore->softlog->GetLogPriorities())
!     setupStore->softlog->SetLogPriorities(newLogPriorities);
!   SetupStore ("softlog-priorities", setupStore->softlog->GetLogPriorities());
  
  }

Index: shm-common.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/shm-common.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** shm-common.h	3 Apr 2007 19:24:31 -0000	1.8
--- shm-common.h	10 May 2007 19:49:51 -0000	1.9
***************
*** 19,23 ****
  
  
! #define CTL_KEY 5680
  
  #ifndef __APPLE__ // should rather be #ifdef LINUX
--- 19,23 ----
  
  
! #define CTL_KEY 5681
  
  #ifndef __APPLE__ // should rather be #ifdef LINUX
***************
*** 77,80 ****
--- 77,83 ----
          /* keypress events */
          uint64_t key;
+ 
+         /* setupStore shm id */
+         int setup_shmid;
  };
  

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.81
retrieving revision 1.82
diff -C2 -d -r1.81 -r1.82
*** softdevice.c	11 Apr 2007 08:35:57 -0000	1.81
--- softdevice.c	10 May 2007 19:49:51 -0000	1.82
***************
*** 153,157 ****
              "[softdevice] ffmpeg build(%d)\n",
               LIBAVCODEC_BUILD);
!     setupStore.outputMethod = method;
  #ifdef USE_SUBPLUGINS
      switch (method) {
--- 153,157 ----
              "[softdevice] ffmpeg build(%d)\n",
               LIBAVCODEC_BUILD);
!     setupStore->outputMethod = method;
  #ifdef USE_SUBPLUGINS
      switch (method) {
***************
*** 183,187 ****
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(&setupStore);
          break;
        default:
--- 183,187 ----
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(setupStore);
          break;
        default:
***************
*** 194,209 ****
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         videoOut = new cXvVideoOut (&setupStore);
          if ( videoOut->Initialize() ) {
  
            if (!videoOut->Reconfigure()) {
                    // XVideo intialization failed, try different pix formats
!                   setupStore.pixelFormat=0;
!                   while (!videoOut->Reconfigure(setupStore.pixelFormat)
!                                   && setupStore.pixelFormat < 3)
!                           setupStore.pixelFormat++;
                    // reset to default if all failed...
!                   if (setupStore.pixelFormat == 3)
!                           setupStore.pixelFormat = 0;
            };
  
--- 194,209 ----
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         videoOut = new cXvVideoOut(setupStore);
          if ( videoOut->Initialize() ) {
  
            if (!videoOut->Reconfigure()) {
                    // XVideo intialization failed, try different pix formats
!                   setupStore->pixelFormat=0;
!                   while (!videoOut->Reconfigure(setupStore->pixelFormat)
!                                   && setupStore->pixelFormat < 3)
!                           setupStore->pixelFormat++;
                    // reset to default if all failed...
!                   if (setupStore->pixelFormat == 3)
!                           setupStore->pixelFormat = 0;
            };
  
***************
*** 217,221 ****
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         videoOut=new cFBVideoOut(&setupStore);
          videoOut->Initialize();
  #endif
--- 217,221 ----
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         videoOut=new cFBVideoOut(setupStore);
          videoOut->Initialize();
  #endif
***************
*** 223,227 ****
        case VOUT_SHM:
  #ifdef SHM_SUPPORT
!         videoOut=new cShmVideoOut(&setupStore);
          videoOut->Initialize();
  #endif
--- 223,227 ----
        case VOUT_SHM:
  #ifdef SHM_SUPPORT
!         videoOut=new cShmVideoOut(setupStore);
          videoOut->Initialize();
  #endif
***************
*** 229,233 ****
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         videoOut=new cDFBVideoOut(&setupStore);
          videoOut->Initialize();
  #endif
--- 229,233 ----
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         videoOut=new cDFBVideoOut(setupStore);
          videoOut->Initialize();
  #endif
***************
*** 235,249 ****
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         videoOut=new cVidixVideoOut(&setupStore);
          videoOut->Initialize();
  #endif
        case VOUT_QUARTZ:
  #ifdef QUARTZ_SUPPORT
!         videoOut=new cQuartzVideoOut(&setupStore);
          videoOut->Initialize();
  #endif
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(&setupStore);
          videoOut->Initialize();
          break;
--- 235,249 ----
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         videoOut=new cVidixVideoOut(setupStore);
          videoOut->Initialize();
  #endif
        case VOUT_QUARTZ:
  #ifdef QUARTZ_SUPPORT
!         videoOut=new cQuartzVideoOut(setupStore);
          videoOut->Initialize();
  #endif
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(setupStore);
          videoOut->Initialize();
          break;
***************
*** 262,266 ****
        case AOUT_ALSA:
  #ifdef ALSA_SUPPORT
!         audioOut=new cAlsaAudioOut(&setupStore);
          break;
  #else
--- 262,266 ----
        case AOUT_ALSA:
  #ifdef ALSA_SUPPORT
!         audioOut=new cAlsaAudioOut(setupStore);
          break;
  #else
***************
*** 269,273 ****
        case AOUT_MACOS:
  #ifdef MACOSAO_SUPPORT
!         audioOut=new cMacOsAudioOut(&setupStore);
          break;
  #else
--- 269,273 ----
        case AOUT_MACOS:
  #ifdef MACOSAO_SUPPORT
!         audioOut=new cMacOsAudioOut(setupStore);
          break;
  #else
***************
*** 276,280 ****
        case AOUT_OSS:
  #ifdef OSS_SUPPORT
!         audioOut=new cOSSAudioOut(&setupStore);
          break;
  #else
--- 276,280 ----
        case AOUT_OSS:
  #ifdef OSS_SUPPORT
!         audioOut=new cOSSAudioOut(setupStore);
          break;
  #else
***************
*** 282,286 ****
  #endif
        case AOUT_DUMMY:
!         audioOut=new cDummyAudioOut(&setupStore);
          break;
      }
--- 282,286 ----
  #endif
        case AOUT_DUMMY:
!         audioOut=new cDummyAudioOut(setupStore);
          break;
      }
***************
*** 333,337 ****
      if (!err)
      {
!       videoOut = (cVideoOut *) creator (&setupStore);
      }
      else
--- 333,337 ----
      if (!err)
      {
!       videoOut = (cVideoOut *) creator(setupStore);
      }
      else
***************
*** 554,558 ****
    SOFTDEB("PlayAudio... %p length %d\n",Data,Length);
  #if VDRVERSNUM >= 10342
!   if (setupStore.shouldSuspend && !Transferring()) {
      usleep(10000); // avoid burning CPU
      return 0;
--- 554,558 ----
    SOFTDEB("PlayAudio... %p length %d\n",Data,Length);
  #if VDRVERSNUM >= 10342
!   if (setupStore->shouldSuspend && !Transferring()) {
      usleep(10000); // avoid burning CPU
      return 0;
***************
*** 615,619 ****
    SOFTDEB("PlayVideo %x length %d\n",Data,Length);
  #if VDRVERSNUM >= 10342
!   if (setupStore.shouldSuspend && !Transferring()) {
      usleep(10000); // avoid burning CPU
      return 0;
--- 615,619 ----
    SOFTDEB("PlayVideo %x length %d\n",Data,Length);
  #if VDRVERSNUM >= 10342
!   if (setupStore->shouldSuspend && !Transferring()) {
      usleep(10000); // avoid burning CPU
      return 0;
***************
*** 785,788 ****
--- 785,852 ----
    pluginPath = PLUGINLIBDIR;
    runtimePluginPath = GetLibPath();
+ 
+ #ifndef VOUT_SHM 
+   setupStore = (cSetupStore *) malloc( sizeof(cSetupStore) );
+   setupStore->InitSetupStore();
+ #else
+   int ctl_shmid;
+   ShmCtlBlock *ctl=NULL;
+   key_t ctl_key=CTL_KEY;
+ 
+   // try to get an existing ShmCltBlock
+   if  ( (ctl_shmid = shmget(ctl_key,sizeof(ShmCtlBlock), 0666)) >= 0 ) {
+           fprintf(stderr,"softdevice: Got ctl_shmid %d shm ctl!\n",ctl_shmid);
+   }; 
+ 
+   // attach to the control block
+   if ( ctl_shmid>0 && ( (ctl = (ShmCtlBlock*)shmat(ctl_shmid,NULL,0)) 
+                           == (ShmCtlBlock*) -1 )) {
+           fprintf(stderr,"softdevice: Error attatching shm ctl!\n");
+           ctl=NULL;
+   };
+ 
+   if ( ctl && ctl->setup_shmid>0 ) {
+           setupStoreShmId=ctl->setup_shmid;
+           // try to attach to an existing setupStore
+           if ( (setupStore = (cSetupStore*)shmat(setupStoreShmId,NULL,0)) 
+                           == (cSetupStore*) -1 ) {
+                   fprintf(stderr,"softdevice: Error attatching existing setupStore shm!\n");
+                   setupStoreShmId=-1;
+                   setupStore=NULL;
+                   printf("setupStoreShmId %d setupStore %p\n",
+                                   setupStoreShmId,setupStore);
+           } else fprintf(stderr,"softdevice: Attatched to setupStore %d at %p\n",
+                           setupStoreShmId,setupStore);
+                                  
+   };
+ 
+   if ( !setupStore ) {
+           if ( (setupStoreShmId = shmget(IPC_PRIVATE,sizeof(cSetupStore), 
+                                           IPC_CREAT | 0666)) >= 0 ) {
+                   fprintf(stderr,"softdevice: Created setupStoreId %d!\n",
+                                   setupStoreShmId);
+           };
+           // try to attach to the new setupStore
+           if ( (setupStore = (cSetupStore*)shmat(setupStoreShmId,NULL,0)) 
+                           == (cSetupStore*) -1 ) {
+                   fprintf(stderr,"softdevice: Error attatching setupStore shm!\n");
+                   exit(-1);
+           } else 
+                   fprintf(stderr,"softdevice: Attatched to setupStoreId %d at %p.\n",
+                           setupStoreShmId,setupStore);
+           
+           if (ctl>0)
+                   ctl->setup_shmid=setupStoreShmId;
+                           // request removing after detaching
+           if ( setupStoreShmId > 0)
+                         shmctl(setupStoreShmId, IPC_RMID, 0);
+ 
+   };
+   if ( ctl>0 ) {
+           shmdt(ctl);
+           ctl=NULL;
+   };
+   setupStore->InitSetupStore();
+ #endif
  }
  
***************
*** 800,804 ****
  const char *cPluginSoftDevice::MainMenuEntry(void)
  {
!   if (setupStore.mainMenu)
      return tr(MAINMENUENTRY);
    return NULL;
--- 864,868 ----
  const char *cPluginSoftDevice::MainMenuEntry(void)
  {
!   if (setupStore->mainMenu)
      return tr(MAINMENUENTRY);
    return NULL;
***************
*** 873,877 ****
          if (!strncmp (vo_argv, "xv:", 3)) {
            vo_argv += 3;
-           setupStore.voArgs = vo_argv;
  #ifdef XV_SUPPORT
            voutMethod = VOUT_XV;
--- 937,940 ----
***************
*** 885,894 ****
                  fprintf (stderr,
                           "[ProcessArgs] xv: startup aspect ratio set to wide (16:9)\n");
!                 setupStore. xvAspect = XV_FORMAT_WIDE;
                  vo_argv += 4;
                } else if (!strncmp (vo_argv, "normal", 6)) {
                  fprintf (stderr,
                           "[ProcessArgs] xv: startup aspect ratio set to normal (4:3)\n");
!                 setupStore. xvAspect = XV_FORMAT_NORMAL;
                  vo_argv += 6;
                } else {
--- 948,957 ----
                  fprintf (stderr,
                           "[ProcessArgs] xv: startup aspect ratio set to wide (16:9)\n");
!                 setupStore->xvAspect = XV_FORMAT_WIDE;
                  vo_argv += 4;
                } else if (!strncmp (vo_argv, "normal", 6)) {
                  fprintf (stderr,
                           "[ProcessArgs] xv: startup aspect ratio set to normal (4:3)\n");
!                 setupStore->xvAspect = XV_FORMAT_NORMAL;
                  vo_argv += 6;
                } else {
***************
*** 900,909 ****
                }
              } else if (!strncmp (vo_argv, "max-area", 8)) {
!               setupStore.xvMaxArea = 1;
                fprintf (stderr,
                         "[ProcessArgs] xv: using max available area\n");
                vo_argv += 8;
              } else if (!strncmp (vo_argv, "full", 4)) {
!               setupStore.xvFullscreen = 1;
                fprintf (stderr,
                         "[ProcessArgs] xv: start up fullscreen\n");
--- 963,972 ----
                }
              } else if (!strncmp (vo_argv, "max-area", 8)) {
!               setupStore->xvMaxArea = 1;
                fprintf (stderr,
                         "[ProcessArgs] xv: using max available area\n");
                vo_argv += 8;
              } else if (!strncmp (vo_argv, "full", 4)) {
!               setupStore->xvFullscreen = 1;
                fprintf (stderr,
                         "[ProcessArgs] xv: start up fullscreen\n");
***************
*** 912,916 ****
                fprintf (stderr,
                         "[ProcessArgs] xv: don't change brigtness etc on startup\n");
!               setupStore.xvUseDefaults=true;
                vo_argv += 12;
              } else {
--- 975,979 ----
                fprintf (stderr,
                         "[ProcessArgs] xv: don't change brigtness etc on startup\n");
!               setupStore->xvUseDefaults=true;
                vo_argv += 12;
              } else {
***************
*** 927,931 ****
          } else if (!strncmp (vo_argv, "fb:", 3)) {
            vo_argv += 3;
-           setupStore.voArgs = vo_argv;
  #ifdef FB_SUPPORT
            voutMethod = VOUT_FB;
--- 990,993 ----
***************
*** 935,939 ****
          } else if (!strncmp (vo_argv, "shm:", 3)) {
            vo_argv += 4;
-           setupStore.voArgs = vo_argv;
  #ifdef SHM_SUPPORT
            voutMethod = VOUT_SHM;
--- 997,1000 ----
***************
*** 943,947 ****
          } else if (!strncmp (vo_argv, "dfb:", 4)) {
            vo_argv += 4;
-           setupStore.voArgs = vo_argv;
  #ifdef DFB_SUPPORT
            voutMethod = VOUT_DFB;
--- 1004,1007 ----
***************
*** 951,968 ****
  
              if (!strncmp (vo_argv, "mgatv", 5)) {
!               setupStore.useMGAtv = 1;
                vo_argv += 5;
              } else if (!strncmp (vo_argv, "viatv", 5)) {
!               setupStore.viaTv = 1;
                fprintf(stderr,"[softdevice] enabling field parity\n");
                vo_argv += 5;
  #ifdef HAVE_CLE266_MPEG_DECODER
              } else if (!strncmp (vo_argv, "cle266", 6)) {
!               setupStore.cle266HWdecode = 1;
                vo_argv += 6;
                fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
  #endif // HAVE_CLE266_MPEG_DECODER
              } else if (!strncmp (vo_argv, "triple", 6)) {
!               setupStore.tripleBuffering = 1;
                vo_argv += 6;
                fprintf(stderr,"[softdevice] enabling triple buffering\n");
--- 1011,1028 ----
  
              if (!strncmp (vo_argv, "mgatv", 5)) {
!               setupStore->useMGAtv = 1;
                vo_argv += 5;
              } else if (!strncmp (vo_argv, "viatv", 5)) {
!               setupStore->viaTv = 1;
                fprintf(stderr,"[softdevice] enabling field parity\n");
                vo_argv += 5;
  #ifdef HAVE_CLE266_MPEG_DECODER
              } else if (!strncmp (vo_argv, "cle266", 6)) {
!               setupStore->cle266HWdecode = 1;
                vo_argv += 6;
                fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
  #endif // HAVE_CLE266_MPEG_DECODER
              } else if (!strncmp (vo_argv, "triple", 6)) {
!               setupStore->tripleBuffering = 1;
                vo_argv += 6;
                fprintf(stderr,"[softdevice] enabling triple buffering\n");
***************
*** 980,984 ****
          } else if (!strncmp (vo_argv, "vidix:", 6)) {
            vo_argv += 6;
-           setupStore.voArgs = vo_argv;
  #ifdef VIDIX_SUPPORT
            voutMethod = VOUT_VIDIX;
--- 1040,1043 ----
***************
*** 989,993 ****
          } else if (!strncmp (vo_argv, "quartz:", 7)) {
            vo_argv += 6;
-           setupStore.voArgs = vo_argv;
  #ifdef QUARTZ_SUPPORT
            voutMethod = VOUT_QUARTZ;
--- 1048,1051 ----
***************
*** 997,1001 ****
          } else if (!strncmp (vo_argv, "dummy:", 6)) {
            vo_argv += 6;
-           setupStore.voArgs = vo_argv;
            voutMethod = VOUT_DUMMY;
            fprintf(stderr,"[softdevice] using dummy video out\n");
--- 1055,1058 ----
***************
*** 1014,1018 ****
          if (!strncmp(ao_argv, "alsa:", 5)) {
            ao_argv += 5;
-           setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_ALSA;
            while (strlen(ao_argv) > 1) {
--- 1071,1074 ----
***************
*** 1035,1042 ****
                        ALSA_DEVICE_NAME_LENGTH : len;
                if (len) {
!                 strncpy(setupStore.alsaDevice, ao_argv, len);
!                 setupStore.alsaDevice [len] = 0;
                  fprintf (stderr, "[softdevice] using PCM alsa device %s\n",
!                          setupStore.alsaDevice);
                }
                ao_argv += len;
--- 1091,1098 ----
                        ALSA_DEVICE_NAME_LENGTH : len;
                if (len) {
!                 strncpy(setupStore->alsaDevice, ao_argv, len);
!                 setupStore->alsaDevice[len]= 0;
                  fprintf (stderr, "[softdevice] using PCM alsa device %s\n",
!                          setupStore->alsaDevice);
                }
                ao_argv += len;
***************
*** 1047,1064 ****
                        ALSA_DEVICE_NAME_LENGTH : len;
                if (len) {
!                 strncpy(setupStore.alsaAC3Device, ao_argv, len);
!                 setupStore.alsaAC3Device [len] = 0;
                  fprintf (stderr, "[softdevice] using AC3 alsa device %s\n",
!                          setupStore.alsaAC3Device);
                }
                ao_argv += len;
              } else if (!strncmp(ao_argv, "mixer", 5)) {
                ao_argv += 5;
!               setupStore.useMixer = 1;
                fprintf(stderr,
                        "[softdevice] using alsa mixer for volume control\n");
              } else {
                fprintf(stderr, "[softdevice] using alsa device %s\n", ao_argv);
!               strncpy(setupStore.alsaDevice, ao_argv, ALSA_DEVICE_NAME_LENGTH);
                ao_argv += strlen(ao_argv);
              }
--- 1103,1120 ----
                        ALSA_DEVICE_NAME_LENGTH : len;
                if (len) {
!                 strncpy(setupStore->alsaAC3Device, ao_argv, len);
!                 setupStore->alsaAC3Device[len] = 0;
                  fprintf (stderr, "[softdevice] using AC3 alsa device %s\n",
!                          setupStore->alsaAC3Device);
                }
                ao_argv += len;
              } else if (!strncmp(ao_argv, "mixer", 5)) {
                ao_argv += 5;
!               setupStore->useMixer = 1;
                fprintf(stderr,
                        "[softdevice] using alsa mixer for volume control\n");
              } else {
                fprintf(stderr, "[softdevice] using alsa device %s\n", ao_argv);
!               strncpy(setupStore->alsaDevice, ao_argv, ALSA_DEVICE_NAME_LENGTH);
                ao_argv += strlen(ao_argv);
              }
***************
*** 1067,1080 ****
          } else if (!strncmp(ao_argv, "oss:", 4)) {
            ao_argv += 4;
-           setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_OSS;
            if (!strncmp(ao_argv, "mixer", 5)) {
                  printf("mixer argv: '%s' \n",ao_argv);
                ao_argv += 5;
!               setupStore.useMixer = 1;
            }
          } else if (!strncmp(ao_argv, "dummy:", 6)) {
            ao_argv += 6;
-           setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_DUMMY;
          } else {
--- 1123,1134 ----
          } else if (!strncmp(ao_argv, "oss:", 4)) {
            ao_argv += 4;
            aoutMethod = AOUT_OSS;
            if (!strncmp(ao_argv, "mixer", 5)) {
                  printf("mixer argv: '%s' \n",ao_argv);
                ao_argv += 5;
!               setupStore->useMixer = 1;
            }
          } else if (!strncmp(ao_argv, "dummy:", 6)) {
            ao_argv += 6;
            aoutMethod = AOUT_DUMMY;
          } else {
***************
*** 1188,1192 ****
  {
    // Parse your own setup parameters and store their values.
!   return setupStore.SetupParse(Name, Value);
  }
  
--- 1242,1246 ----
  {
    // Parse your own setup parameters and store their values.
!   return setupStore->SetupParse(Name, Value);
  }
  

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** utils.c	15 Jan 2007 19:35:13 -0000	1.25
--- utils.c	10 May 2007 19:49:51 -0000	1.26
***************
*** 1290,1293 ****
--- 1290,1314 ----
  }
  
+ /* ---------------------------------------------------------------------------
+  */
+ bool CatchRemoteKey(const char *remoteName, uint64_t key,
+                 const int cropModeToggleKey)
+ {
+ #ifndef STAND_ALONE
+   char  buffer[32];
+   eKeys keySym;
+ 
+   snprintf(buffer, sizeof(buffer), "%016LX", (uint64_t) key);
+   keySym = Keys.Get(remoteName, buffer);
+   if (keySym >= kUser1 && keySym <= kUser9)
+   {
+     keySym = (eKeys) (keySym - kUser1 + 1);
+     if (cropModeToggleKey && cropModeToggleKey == keySym)
+       return true;
+   }
+ #endif
+   return false;
+ }
+ 
  /* taken from MPlayer's aclib */
  

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.16
retrieving revision 1.17
diff -C2 -d -r1.16 -r1.17
*** utils.h	15 Jan 2007 19:35:13 -0000	1.16
--- utils.h	10 May 2007 19:49:51 -0000	1.17
***************
*** 139,142 ****
--- 139,144 ----
  uint64_t  getTimeMilis(void);
  char      *getFBName(void);
+ bool  CatchRemoteKey(const char *remoteName, uint64_t key, 
+                 const int ToggleKey);
  
  void mmx_unpack_16rgb (uint8_t * image, int lines, int stride);

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.79
retrieving revision 1.80
diff -C2 -d -r1.79 -r1.80
*** video-dfb.c	4 Mar 2007 17:45:38 -0000	1.79
--- video-dfb.c	10 May 2007 19:49:51 -0000	1.80
***************
*** 700,705 ****
          break;
        default:
!         if (!setupStore->CatchRemoteKey(dfbRemote->Name(), event.key_symbol))
!         {
  #if HAVE_DIEF_REPEAT
            dfbRemote->PutKey(event.key_symbol, event.flags & DIEF_REPEAT);
--- 700,707 ----
          break;
        default:
!         if ( CatchRemoteKey(dfbRemote->Name(), event.key_symbol,
!                         setupStore->cropModeToggleKey) ) {
!                 setupStore->CropModeNext();
!         } else {
  #if HAVE_DIEF_REPEAT
            dfbRemote->PutKey(event.key_symbol, event.flags & DIEF_REPEAT);

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.68
retrieving revision 1.69
diff -C2 -d -r1.68 -r1.69
*** video-xv.c	14 Dec 2006 22:31:57 -0000	1.68
--- video-xv.c	10 May 2007 19:49:51 -0000	1.69
***************
*** 696,702 ****
  #endif
            default:
!             if (xvRemote &&
!                 !setupStore->CatchRemoteKey(xvRemote->Name(), keysym)) {
!               xvRemote->PutKey (keysym);
              }
              break;
--- 696,706 ----
  #endif
            default:
!             if (xvRemote) {
!               if ( CatchRemoteKey(xvRemote->Name(), keysym,
!                                   setupStore->cropModeToggleKey) ) {
!                  setupStore->CropModeNext();
!               } else {
!                  xvRemote->PutKey(keysym);
!               };
              }
              break;



From nobody at sheep.berlios.de  Thu May 10 21:56:53 2007
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 10 May 2007 21:56:53 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.311, 1.312 ShmClient.c,
	1.24, 1.25 audio-alsa.c, 1.5, 1.6 audio-alsa.h, 1.3,
	1.4 audio-macos.c, 1.1, 1.2 audio-macos.h, 1.1,
	1.2 audio-oss.c, 1.3, 1.4 audio-oss.h, 1.2, 1.3 audio.c, 1.27,
	1.28 audio.h, 1.14, 1.15 setup-softdevice.c, 1.53,
	1.54 setup-softdevice.h, 1.41, 1.42 setup-softlog-menu.c, 1.3,
	1.4 softdevice.c, 1.82, 1.83 video-dfb.c, 1.80,
	1.81 video-dfb.h, 1.26, 1.27 video-dummy.c, 1.4,
	1.5 video-dummy.h, 1.4, 1.5 video-fb.c, 1.18, 1.19 video-fb.h,
	1.10, 1.11 video-quartz.c, 1.1, 1.2 video-quartz.h, 1.1,
	1.2 video-shm.c, 1.17, 1.18 video-shm.h, 1.9,
	1.10 video-vidix.c, 1.25, 1.26 video-vidix.h, 1.12,
	1.13 video-xv.c, 1.69, 1.70 video-xv.h, 1.26, 1.27 video.c,
	1.74, 1.75 video.h, 1.52, 1.53
Message-ID: <20070510195653.0FCDE21572@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18050

Modified Files:
	CHANGELOG ShmClient.c audio-alsa.c audio-alsa.h audio-macos.c 
	audio-macos.h audio-oss.c audio-oss.h audio.c audio.h 
	setup-softdevice.c setup-softdevice.h setup-softlog-menu.c 
	softdevice.c video-dfb.c video-dfb.h video-dummy.c 
	video-dummy.h video-fb.c video-fb.h video-quartz.c 
	video-quartz.h video-shm.c video-shm.h video-vidix.c 
	video-vidix.h video-xv.c video-xv.h video.c video.h 
Log Message:
- remove softlog from setupStore. Pointers aren't valid in a shared memory
  block.
- remove private variable setupStore from audio out methods. They can 
  access the global variable.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.311
retrieving revision 1.312
diff -C2 -d -r1.311 -r1.312
*** CHANGELOG	10 May 2007 19:49:51 -0000	1.311
--- CHANGELOG	10 May 2007 19:54:44 -0000	1.312
***************
*** 1,4 ****
--- 1,8 ----
  Changelog
  2007-05-10:
+    - remove softlog from setupStore. Pointers aren't valid in a shared memory
+      block.
+    - remove private variable setupStore from audio out methods. They can 
+      access the global variable.
     - move setupStore into a shared memory block. This allows ShmClient to
       have acces to the setupStore.

Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** ShmClient.c	10 May 2007 19:49:51 -0000	1.24
--- ShmClient.c	10 May 2007 19:54:44 -0000	1.25
***************
*** 82,85 ****
--- 82,86 ----
  int main(int argc, char **argv) {
          cSetupStore *SetupStore=NULL;
+         cSetupSoftlog *softlog=new cSetupSoftlog();
  
          signal(SIGINT,sig_handler);
***************
*** 115,119 ****
          };
  
!         cXvVideoOut *vout=new cXvVideoOut(SetupStore);
          xvRemote= new cShmRemote("softdevice-xv");
          //SetupStore.InitSetupStore();
--- 116,120 ----
          };
  
!         cXvVideoOut *vout=new cXvVideoOut(SetupStore, softlog);
          xvRemote= new cShmRemote("softdevice-xv");
          //SetupStore.InitSetupStore();

Index: audio-alsa.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-alsa.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** audio-alsa.c	10 Feb 2007 00:05:45 -0000	1.5
--- audio-alsa.c	10 May 2007 19:54:44 -0000	1.6
***************
*** 23,27 ****
  /*--------------------------------------------------------------------------
  */
! cAlsaAudioOut::cAlsaAudioOut(cSetupStore *setupStore) {
      int err;
  
--- 23,27 ----
  /*--------------------------------------------------------------------------
  */
! cAlsaAudioOut::cAlsaAudioOut() {
      int err;
  
***************
*** 50,54 ****
      dsyslog("[softdevice-audio] Device opened! Ready to play");
      scale_Factor=0x7FFF;
-     this->setupStore = setupStore;
  }
  
--- 50,53 ----
***************
*** 255,259 ****
      snd_pcm_status_get_trigger_tstamp(status, &tstamp);
      timersub(&now, &tstamp, &diff);
!     setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                               "[softdevice-audio]: Xrun (at least %.3f ms long)\n",
                               diff.tv_sec * 1000 + diff.tv_usec / 1000.0);
--- 254,258 ----
      snd_pcm_status_get_trigger_tstamp(status, &tstamp);
      timersub(&now, &tstamp, &diff);
!     softlog->Log(SOFT_LOG_DEBUG, 0,
                               "[softdevice-audio]: Xrun (at least %.3f ms long)\n",
                               diff.tv_sec * 1000 + diff.tv_usec / 1000.0);

Index: audio-alsa.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-alsa.h,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** audio-alsa.h	10 Feb 2007 00:05:45 -0000	1.3
--- audio-alsa.h	10 May 2007 19:54:44 -0000	1.4
***************
*** 33,37 ****
    SampleContext     oldContext;
    cAlsaAC3pt        ac3pt;
-   cSetupStore       *setupStore;
  
    bool  SetAC3PassThroughMode(bool on);
--- 33,36 ----
***************
*** 41,45 ****
  protected:
  public:
!   cAlsaAudioOut(cSetupStore *setupStore);
    virtual ~cAlsaAudioOut();
  
--- 40,44 ----
  protected:
  public:
!   cAlsaAudioOut();
    virtual ~cAlsaAudioOut();
  

Index: audio-macos.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-macos.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** audio-macos.c	3 Apr 2007 20:21:04 -0000	1.1
--- audio-macos.c	10 May 2007 19:54:44 -0000	1.2
***************
*** 118,122 ****
  }
  
! cMacOsAudioOut::cMacOsAudioOut(cSetupStore *store) : cAudioOut() {
          ComponentDescription desc; 
          Component comp; 
--- 118,122 ----
  }
  
! cMacOsAudioOut::cMacOsAudioOut() : cAudioOut() {
          ComponentDescription desc; 
          Component comp; 

Index: audio-macos.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-macos.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** audio-macos.h	3 Apr 2007 20:21:04 -0000	1.1
--- audio-macos.h	10 May 2007 19:54:44 -0000	1.2
***************
*** 49,53 ****
  
          public:
!                 cMacOsAudioOut(cSetupStore *setupStore);
                  virtual ~cMacOsAudioOut();
                  OSStatus Render(UInt32 inNumFrames, AudioBufferList *ioData); 
--- 49,53 ----
  
          public:
!                 cMacOsAudioOut();
                  virtual ~cMacOsAudioOut();
                  OSStatus Render(UInt32 inNumFrames, AudioBufferList *ioData); 

Index: audio-oss.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-oss.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** audio-oss.c	12 Mar 2007 20:10:54 -0000	1.3
--- audio-oss.c	10 May 2007 19:54:44 -0000	1.4
***************
*** 18,25 ****
  #define MIXER_DEVICE "/dev/mixer"
  
! cOSSAudioOut::cOSSAudioOut(cSetupStore *SetupStore)
  {
      struct stat file_info;
-     setupStore=SetupStore;
  
      if (-1 == stat(DSP_DEVICE, &file_info))
--- 18,24 ----
  #define MIXER_DEVICE "/dev/mixer"
  
! cOSSAudioOut::cOSSAudioOut()
  {
      struct stat file_info;
  
      if (-1 == stat(DSP_DEVICE, &file_info))

Index: audio-oss.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-oss.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** audio-oss.h	12 Mar 2007 20:10:54 -0000	1.2
--- audio-oss.h	10 May 2007 19:54:44 -0000	1.3
***************
*** 20,26 ****
      int fdMixer;
      int scale_Factor;
-     cSetupStore *setupStore;
  public:
!     cOSSAudioOut(cSetupStore *setupStore);
      virtual ~cOSSAudioOut();
      virtual void Write(uchar *Data, int Length);
--- 20,25 ----
      int fdMixer;
      int scale_Factor;
  public:
!     cOSSAudioOut();
      virtual ~cOSSAudioOut();
      virtual void Write(uchar *Data, int Length);

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** audio.c	12 Mar 2007 20:27:03 -0000	1.27
--- audio.c	10 May 2007 19:54:44 -0000	1.28
***************
*** 42,46 ****
  /* ---------------------------------------------------------------------------
   */
! cDummyAudioOut::cDummyAudioOut(cSetupStore *setupStore)
  {
    paused=false;
--- 42,46 ----
  /* ---------------------------------------------------------------------------
   */
! cDummyAudioOut::cDummyAudioOut()
  {
    paused=false;

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** audio.h	12 Mar 2007 20:27:03 -0000	1.14
--- audio.h	10 May 2007 19:54:44 -0000	1.15
***************
*** 60,64 ****
    volatile bool paused;
  public:
!   cDummyAudioOut(cSetupStore *setupStore);
    virtual ~cDummyAudioOut() { return; };
    virtual void Write(uchar *Data, int Length);
--- 60,64 ----
    volatile bool paused;
  public:
!   cDummyAudioOut();
    virtual ~cDummyAudioOut() { return; };
    virtual void Write(uchar *Data, int Length);

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** setup-softdevice.c	10 May 2007 19:49:51 -0000	1.53
--- setup-softdevice.c	10 May 2007 19:54:44 -0000	1.54
***************
*** 76,79 ****
--- 76,80 ----
   */
  cSetupStore *setupStore=NULL;
+ cSetupSoftlog *softlog=NULL;
  int setupStoreShmId=-1;
  
***************
*** 198,203 ****
    syncTimerNames[2] = "sig";
    syncTimerNames[3] = NULL;
- 
-   softlog = new cSetupSoftlog();
  }
  
--- 199,202 ----

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** setup-softdevice.h	10 May 2007 19:49:51 -0000	1.41
--- setup-softdevice.h	10 May 2007 19:54:44 -0000	1.42
***************
*** 176,181 ****
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
      char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];
- 
-     cSetupSoftlog *softlog;
  };
  
--- 176,179 ----
***************
*** 194,197 ****
--- 192,196 ----
  }
  
+ extern cSetupSoftlog *softlog;
  extern cSetupStore *setupStore;
  extern int setupStoreShmId;

Index: setup-softlog-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog-menu.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** setup-softlog-menu.c	10 May 2007 19:49:51 -0000	1.3
--- setup-softlog-menu.c	10 May 2007 19:54:44 -0000	1.4
***************
*** 16,22 ****
      SetPlugin(plugin);
  
!   strncpy(newLogFileName, setupStore->softlog->GetLogFileName(), 256);
!   newLogPriorities = setupStore->softlog->GetLogPriorities();
!   newAppendMode = setupStore->softlog->GetAppendMode();
  
    Add(new cMenuEditBitItem(tr("Info Messages"),
--- 16,22 ----
      SetPlugin(plugin);
  
!   strncpy(newLogFileName, softlog->GetLogFileName(), 256);
!   newLogPriorities = softlog->GetLogPriorities();
!   newAppendMode = softlog->GetAppendMode();
  
    Add(new cMenuEditBitItem(tr("Info Messages"),
***************
*** 77,90 ****
  void cMenuSetupSoftlog::Store(void)
  {
!   if (strcmp(newLogFileName, setupStore->softlog->GetLogFileName()))
!     setupStore->softlog->SetLogFile(newLogFileName);
!   SetupStore ("softlog-file",       setupStore->softlog->GetLogFileName());
  
!   setupStore->softlog->SetAppendMode(newAppendMode);
!   SetupStore ("softlog-appendpid",  setupStore->softlog->GetAppendMode());
  
!   if (newLogPriorities != setupStore->softlog->GetLogPriorities())
!     setupStore->softlog->SetLogPriorities(newLogPriorities);
!   SetupStore ("softlog-priorities", setupStore->softlog->GetLogPriorities());
  
  }
--- 77,90 ----
  void cMenuSetupSoftlog::Store(void)
  {
!   if (strcmp(newLogFileName, softlog->GetLogFileName()))
!     softlog->SetLogFile(newLogFileName);
!   SetupStore ("softlog-file",       softlog->GetLogFileName());
  
!   softlog->SetAppendMode(newAppendMode);
!   SetupStore ("softlog-appendpid",  softlog->GetAppendMode());
  
!   if (newLogPriorities != softlog->GetLogPriorities())
!     softlog->SetLogPriorities(newLogPriorities);
!   SetupStore ("softlog-priorities", softlog->GetLogPriorities());
  
  }

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.82
retrieving revision 1.83
diff -C2 -d -r1.82 -r1.83
*** softdevice.c	10 May 2007 19:49:51 -0000	1.82
--- softdevice.c	10 May 2007 19:54:44 -0000	1.83
***************
*** 183,187 ****
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(setupStore);
          break;
        default:
--- 183,187 ----
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(setupStore,softlog);
          break;
        default:
***************
*** 194,198 ****
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         videoOut = new cXvVideoOut(setupStore);
          if ( videoOut->Initialize() ) {
  
--- 194,198 ----
        case VOUT_XV:
  #ifdef XV_SUPPORT
!         videoOut = new cXvVideoOut(setupStore,softlog);
          if ( videoOut->Initialize() ) {
  
***************
*** 217,221 ****
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         videoOut=new cFBVideoOut(setupStore);
          videoOut->Initialize();
  #endif
--- 217,221 ----
        case VOUT_FB:
  #ifdef FB_SUPPORT
!         videoOut=new cFBVideoOut(setupStore,softlog);
          videoOut->Initialize();
  #endif
***************
*** 223,227 ****
        case VOUT_SHM:
  #ifdef SHM_SUPPORT
!         videoOut=new cShmVideoOut(setupStore);
          videoOut->Initialize();
  #endif
--- 223,227 ----
        case VOUT_SHM:
  #ifdef SHM_SUPPORT
!         videoOut=new cShmVideoOut(setupStore,softlog);
          videoOut->Initialize();
  #endif
***************
*** 229,233 ****
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         videoOut=new cDFBVideoOut(setupStore);
          videoOut->Initialize();
  #endif
--- 229,233 ----
        case VOUT_DFB:
  #ifdef DFB_SUPPORT
!         videoOut=new cDFBVideoOut(setupStore,softlog);
          videoOut->Initialize();
  #endif
***************
*** 235,249 ****
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         videoOut=new cVidixVideoOut(setupStore);
          videoOut->Initialize();
  #endif
        case VOUT_QUARTZ:
  #ifdef QUARTZ_SUPPORT
!         videoOut=new cQuartzVideoOut(setupStore);
          videoOut->Initialize();
  #endif
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(setupStore);
          videoOut->Initialize();
          break;
--- 235,249 ----
        case VOUT_VIDIX:
  #ifdef VIDIX_SUPPORT
!         videoOut=new cVidixVideoOut(setupStore,softlog);
          videoOut->Initialize();
  #endif
        case VOUT_QUARTZ:
  #ifdef QUARTZ_SUPPORT
!         videoOut=new cQuartzVideoOut(setupStore,softlog);
          videoOut->Initialize();
  #endif
          break;
        case VOUT_DUMMY:
!         videoOut=new cDummyVideoOut(setupStore,softlog);
          videoOut->Initialize();
          break;
***************
*** 262,266 ****
        case AOUT_ALSA:
  #ifdef ALSA_SUPPORT
!         audioOut=new cAlsaAudioOut(setupStore);
          break;
  #else
--- 262,266 ----
        case AOUT_ALSA:
  #ifdef ALSA_SUPPORT
!         audioOut=new cAlsaAudioOut();
          break;
  #else
***************
*** 269,273 ****
        case AOUT_MACOS:
  #ifdef MACOSAO_SUPPORT
!         audioOut=new cMacOsAudioOut(setupStore);
          break;
  #else
--- 269,273 ----
        case AOUT_MACOS:
  #ifdef MACOSAO_SUPPORT
!         audioOut=new cMacOsAudioOut();
          break;
  #else
***************
*** 276,280 ****
        case AOUT_OSS:
  #ifdef OSS_SUPPORT
!         audioOut=new cOSSAudioOut(setupStore);
          break;
  #else
--- 276,280 ----
        case AOUT_OSS:
  #ifdef OSS_SUPPORT
!         audioOut=new cOSSAudioOut();
          break;
  #else
***************
*** 282,286 ****
  #endif
        case AOUT_DUMMY:
!         audioOut=new cDummyAudioOut(setupStore);
          break;
      }
--- 282,286 ----
  #endif
        case AOUT_DUMMY:
!         audioOut=new cDummyAudioOut();
          break;
      }
***************
*** 327,337 ****
    if (!err)
    {
!       void  *(*creator)(cSetupStore *store);
  
!     creator = (void *(*)(cSetupStore *))dlsym(handle, "SubPluginCreator");
      err = dlerror();
      if (!err)
      {
!       videoOut = (cVideoOut *) creator(setupStore);
      }
      else
--- 327,337 ----
    if (!err)
    {
!       void  *(*creator)(cSetupStore *store, cSetupSoftlog *log);
  
!     creator = (void *(*)(cSetupStore *, cSetupSoftlog *log))dlsym(handle, "SubPluginCreator");
      err = dlerror();
      if (!err)
      {
!       videoOut = (cVideoOut *) creator(setupStore, softlog);
      }
      else
***************
*** 786,789 ****
--- 786,790 ----
    runtimePluginPath = GetLibPath();
  
+   softlog = new cSetupSoftlog();
  #ifndef VOUT_SHM 
    setupStore = (cSetupStore *) malloc( sizeof(cSetupStore) );
***************
*** 838,844 ****
            if (ctl>0)
                    ctl->setup_shmid=setupStoreShmId;
!                           // request removing after detaching
            if ( setupStoreShmId > 0)
                          shmctl(setupStoreShmId, IPC_RMID, 0);
  
    };
--- 839,847 ----
            if (ctl>0)
                    ctl->setup_shmid=setupStoreShmId;
! #ifndef __APPLE__
! 	  // request removing after detaching
            if ( setupStoreShmId > 0)
                          shmctl(setupStoreShmId, IPC_RMID, 0);
+ #endif
  
    };

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.80
retrieving revision 1.81
diff -C2 -d -r1.80 -r1.81
*** video-dfb.c	10 May 2007 19:49:51 -0000	1.80
--- video-dfb.c	10 May 2007 19:54:44 -0000	1.81
***************
*** 183,192 ****
  /* ---------------------------------------------------------------------------
   */
! cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore)
!               : cVideoOut(setupStore)
  {
      tLayerSelectItem              *layerInfo;
  
!   setupStore->softlog->Log(SOFT_LOG_INFO, 0, "[dfb] init\n");
    /* --------------------------------------------------------------------------
     * default settings: source, destination and logical widht/height
--- 183,192 ----
  /* ---------------------------------------------------------------------------
   */
! cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore, cSetupSoftlog *softlog)
!               : cVideoOut(setupStore, softlog)
  {
      tLayerSelectItem              *layerInfo;
  
!   softlog->Log(SOFT_LOG_INFO, 0, "[dfb] init\n");
    /* --------------------------------------------------------------------------
     * default settings: source, destination and logical widht/height
***************
*** 229,233 ****
      reportCardInfo (dfb);
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] Supported video Modes are:\n");
      dfb->EnumVideoModes(EnumVideoModeCallback, NULL);
--- 229,233 ----
      reportCardInfo (dfb);
  
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] Supported video Modes are:\n");
      dfb->EnumVideoModes(EnumVideoModeCallback, NULL);
***************
*** 238,247 ****
       */
      DFBWrapper=dfb;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] Enumerating display Layers\n");
  
      osdLayer=dfb->GetDisplayLayer(DLID_PRIMARY);
      if (!osdLayer) {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb] no OSD layer exiting\n");
        exit(EXIT_FAILURE);
--- 238,247 ----
       */
      DFBWrapper=dfb;
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] Enumerating display Layers\n");
  
      osdLayer=dfb->GetDisplayLayer(DLID_PRIMARY);
      if (!osdLayer) {
!       softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb] no OSD layer exiting\n");
        exit(EXIT_FAILURE);
***************
*** 250,254 ****
      if (!setupStore->useMGAtv)
      {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Configuring CooperativeLevel for OSD\n");
        osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
--- 250,254 ----
      if (!setupStore->useMGAtv)
      {
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Configuring CooperativeLevel for OSD\n");
        osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
***************
*** 278,282 ****
      if (setupStore->useMGAtv && !videoLayer) {
        layerInfo = &layerList [CRTC2_LAYER_OLD];
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
        dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
--- 278,282 ----
      if (setupStore->useMGAtv && !videoLayer) {
        layerInfo = &layerList [CRTC2_LAYER_OLD];
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
        dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
***************
*** 286,290 ****
      if (!videoLayer)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb]: could not find suitable videolayer\n");
        exit(EXIT_FAILURE);
--- 286,290 ----
      if (!videoLayer)
      {
!       softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb]: could not find suitable videolayer\n");
        exit(EXIT_FAILURE);
***************
*** 308,312 ****
  #ifdef HAVE_CLE266_MPEG_DECODER
          setupStore->cle266HWdecode = false;
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                    "[dfb] disabling hw-decode support for this layer\n");
  #endif
--- 308,312 ----
  #ifdef HAVE_CLE266_MPEG_DECODER
          setupStore->cle266HWdecode = false;
!         softlog->Log(SOFT_LOG_INFO, 0,
                    "[dfb] disabling hw-decode support for this layer\n");
  #endif
***************
*** 320,324 ****
        else if (setupStore->cle266HWdecode) {
            if (!SetupCle266Buffers(swidth, sheight)) {
!               setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                          "[dfb] Error allocating hardware buffers for "
                          "CLE266 decoding: reverting to software decoding\n");
--- 320,324 ----
        else if (setupStore->cle266HWdecode) {
            if (!SetupCle266Buffers(swidth, sheight)) {
!               softlog->Log(SOFT_LOG_ERROR, 0,
                          "[dfb] Error allocating hardware buffers for "
                          "CLE266 decoding: reverting to software decoding\n");
***************
*** 339,348 ****
      ReportLayerInfo(osdLayer, "osdLayer");
      if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL) {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] osdLayer has alpha channel\n");
        osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
        videoLayerLevel = -1;
      } else {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] osdLayer without !! alpha channel\n");
      }
--- 339,348 ----
      ReportLayerInfo(osdLayer, "osdLayer");
      if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL) {
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] osdLayer has alpha channel\n");
        osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
        videoLayerLevel = -1;
      } else {
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] osdLayer without !! alpha channel\n");
      }
***************
*** 366,370 ****
  
        scrSurface->GetSize(&Xres,&Yres);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] width = %d, height = %d\n",
                  Xres, Yres);
--- 366,370 ----
  
        scrSurface->GetSize(&Xres,&Yres);
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] width = %d, height = %d\n",
                  Xres, Yres);
***************
*** 376,380 ****
  
        fmt = scrSurface->GetPixelFormat();
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] got fmt = 0x%08x bpp = %d\n",
                  fmt, DFB_BITS_PER_PIXEL(fmt));
--- 376,380 ----
  
        fmt = scrSurface->GetPixelFormat();
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] got fmt = 0x%08x bpp = %d\n",
                  fmt, DFB_BITS_PER_PIXEL(fmt));
***************
*** 432,436 ****
        osdSurface->Clear(0,0,0,clearAlpha); //clear and
  
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Using this layer for OSD: (%s - [%dx%d])\n",
                  osdLayerDescription.name,
--- 432,436 ----
        osdSurface->Clear(0,0,0,clearAlpha); //clear and
  
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Using this layer for OSD: (%s - [%dx%d])\n",
                  osdLayerDescription.name,
***************
*** 450,454 ****
        if (!setupStore->useMGAtv)
        {
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                    "[dfb] Configuring CooperativeLevel for Overlay\n");
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
--- 450,454 ----
        if (!setupStore->useMGAtv)
        {
!         softlog->Log(SOFT_LOG_INFO, 0,
                    "[dfb] Configuring CooperativeLevel for Overlay\n");
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
***************
*** 474,481 ****
        ReportSurfaceCapabilities (videoSurface, "videoSurface");
  
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Using this layer for OSD:        %s\n",
                  osdLayerDescription.name);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Using this layer for Video out:  %s\n",
                  videoLayerDescription.name);
--- 474,481 ----
        ReportSurfaceCapabilities (videoSurface, "videoSurface");
  
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Using this layer for OSD:        %s\n",
                  osdLayerDescription.name);
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[dfb] Using this layer for Video out:  %s\n",
                  videoLayerDescription.name);
***************
*** 489,493 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] init EXITING:action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 489,493 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] init EXITING:action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 505,509 ****
  
    scaps = surf->GetCapabilities();
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
              "[dfb] surface capabilities for (%s): "
              "%s%s%s%s%s%s%s%s%s%s%sPixelFormat = 0x%08x\n",
--- 505,509 ----
  
    scaps = surf->GetCapabilities();
!   softlog->Log(SOFT_LOG_DEBUG, 0,
              "[dfb] surface capabilities for (%s): "
              "%s%s%s%s%s%s%s%s%s%s%sPixelFormat = 0x%08x\n",
***************
*** 539,543 ****
      catch (DFBException *ex)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb] BES-%s: action=%s, result=%s\n",
                  (state) ? "ON" : "OFF",
--- 539,543 ----
      catch (DFBException *ex)
      {
!       softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb] BES-%s: action=%s, result=%s\n",
                  (state) ? "ON" : "OFF",
***************
*** 556,560 ****
    if (!layer)
    {
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] no layer info. layer == NULL\n");
      return;
--- 556,560 ----
    if (!layer)
    {
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] no layer info. layer == NULL\n");
      return;
***************
*** 563,567 ****
    layer->GetConfiguration(&layerConfiguration);
    {
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
              "[dfb] (%s): flags, options, pixelformat: %08x, %08x %08x\n",
              name,
--- 563,567 ----
    layer->GetConfiguration(&layerConfiguration);
    {
!     softlog->Log(SOFT_LOG_INFO, 0,
              "[dfb] (%s): flags, options, pixelformat: %08x, %08x %08x\n",
              name,
***************
*** 569,573 ****
              layerConfiguration.options,
              layerConfiguration.pixelformat);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
              "[dfb] (%s): width, height:               %d %d\n",
              name,
--- 569,573 ----
              layerConfiguration.options,
              layerConfiguration.pixelformat);
!     softlog->Log(SOFT_LOG_INFO, 0,
              "[dfb] (%s): width, height:               %d %d\n",
              name,
***************
*** 589,593 ****
                  (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
    dlc.buffermode = DLBM_TRIPLE;
!   setupStore->softlog->Log(SOFT_LOG_INFO, 0,
              "[dfb] Set DLBM_TRIPLE for layer [%s]\n", desc.name);
  
--- 589,593 ----
                  (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
    dlc.buffermode = DLBM_TRIPLE;
!   softlog->Log(SOFT_LOG_INFO, 0,
              "[dfb] Set DLBM_TRIPLE for layer [%s]\n", desc.name);
  
***************
*** 598,602 ****
    {
      dlc.options = DLOP_FIELD_PARITY;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] DLOP_FIELD_PARITY supported by layer [%s]\n",
                desc.name);
--- 598,602 ----
    {
      dlc.options = DLOP_FIELD_PARITY;
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] DLOP_FIELD_PARITY supported by layer [%s]\n",
                desc.name);
***************
*** 605,609 ****
    {
      dlc.options = DLOP_NONE;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] DLOP_FIELD_PARITY not supported by layer [%s]\n",
                desc.name);
--- 605,609 ----
    {
      dlc.options = DLOP_NONE;
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] DLOP_FIELD_PARITY not supported by layer [%s]\n",
                desc.name);
***************
*** 620,624 ****
    catch(DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] EnableFieldParity: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 620,624 ----
    catch(DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] EnableFieldParity: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 645,649 ****
      catch (DFBException *ex)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb] GetDisplayFrameTime: action=%s, result=%s\n",
                  ex->GetAction(), ex->GetResult());
--- 645,649 ----
      catch (DFBException *ex)
      {
!       softlog->Log(SOFT_LOG_ERROR, 0,
                  "[dfb] GetDisplayFrameTime: action=%s, result=%s\n",
                  ex->GetAction(), ex->GetResult());
***************
*** 653,657 ****
      t1 = (tv1.tv_sec & 1) * 1000000 + tv1.tv_usec;
      t2 = (tv2.tv_sec & 1) * 1000000 + tv2.tv_usec;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] Display frame time is %d microseconds\n", t2 - t1);
      displayTimeUS = t2 - t1;
--- 653,657 ----
      t1 = (tv1.tv_sec & 1) * 1000000 + tv1.tv_usec;
      t2 = (tv2.tv_sec & 1) * 1000000 + tv2.tv_usec;
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[dfb] Display frame time is %d microseconds\n", t2 - t1);
      displayTimeUS = t2 - t1;
***************
*** 740,744 ****
        cutRight  = setupStore->cropRightCols;
  
!       setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                  "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
                  fwidth,fheight,swidth,sheight);
--- 740,744 ----
        cutRight  = setupStore->cropRightCols;
  
!       softlog->Log(SOFT_LOG_DEBUG, 0,
                  "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
                  fwidth,fheight,swidth,sheight);
***************
*** 836,840 ****
            catch (DFBException *ex)
            {
!             setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                        "[dfb] SetParams: action=%s, result=%s Failed: SetLevel()\n",
                        ex->GetAction(), ex->GetResult());
--- 836,840 ----
            catch (DFBException *ex)
            {
!             softlog->Log(SOFT_LOG_ERROR, 0,
                        "[dfb] SetParams: action=%s, result=%s Failed: SetLevel()\n",
                        ex->GetAction(), ex->GetResult());
***************
*** 865,869 ****
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
!           setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                      "[dfb] SetParams: Enabling DLOP_FIELD_PARITY\n");
          }
--- 865,869 ----
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
!           softlog->Log(SOFT_LOG_DEBUG, 0,
                      "[dfb] SetParams: Enabling DLOP_FIELD_PARITY\n");
          }
***************
*** 888,892 ****
              if (failed & DLCONF_BUFFERMODE)
              {
!               setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                          "[dfb]: SetParms (): failed to set buffermode "
                          "to triple, will try back video\n");
--- 888,892 ----
              if (failed & DLCONF_BUFFERMODE)
              {
!               softlog->Log(SOFT_LOG_DEBUG, 0,
                          "[dfb]: SetParms (): failed to set buffermode "
                          "to triple, will try back video\n");
***************
*** 907,916 ****
              if (failed & DLCONF_BUFFERMODE)
              {
!               setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                        "[dfb]: SetParams: failed to set buffermode "
                        "to back video, reverting to normal\n");
                dlc.buffermode = DLBM_FRONTONLY;
              } else {
!               setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                          "[dfb]: Testconfiguration failed flags: %08x "
                          "(disabling failed flags)\n",
--- 907,916 ----
              if (failed & DLCONF_BUFFERMODE)
              {
!               softlog->Log(SOFT_LOG_DEBUG, 0,
                        "[dfb]: SetParams: failed to set buffermode "
                        "to back video, reverting to normal\n");
                dlc.buffermode = DLBM_FRONTONLY;
              } else {
!               softlog->Log(SOFT_LOG_INFO, 0,
                          "[dfb]: Testconfiguration failed flags: %08x "
                          "(disabling failed flags)\n",
***************
*** 935,939 ****
          catch (DFBException *ex)
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                      "[dfb] SetParams: action=%s, result=%s\n",
                      ex->GetAction(), ex->GetResult());
--- 935,939 ----
          catch (DFBException *ex)
          {
!           softlog->Log(SOFT_LOG_ERROR, 0,
                      "[dfb] SetParams: action=%s, result=%s\n",
                      ex->GetAction(), ex->GetResult());
***************
*** 956,960 ****
            catch (DFBException *ex)
            {
!             setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                        "[dfb] SetParams() SetScreenLocation(): "
                        "action=%s, result=%s\n",
--- 956,960 ----
            catch (DFBException *ex)
            {
!             softlog->Log(SOFT_LOG_ERROR, 0,
                        "[dfb] SetParams() SetScreenLocation(): "
                        "action=%s, result=%s\n",
***************
*** 965,969 ****
          else
          {
!           setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                      "Can't configure ScreenLocation. Hope it is Fullscreen\n");
          }
--- 965,969 ----
          else
          {
!           softlog->Log(SOFT_LOG_INFO, 0,
                      "Can't configure ScreenLocation. Hope it is Fullscreen\n");
          }
***************
*** 983,987 ****
          catch (DFBException *ex)
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                      "[dfb] SetParams (a) EXITING: action=%s, result=%s\n",
                      ex->GetAction(), ex->GetResult());
--- 983,987 ----
          catch (DFBException *ex)
          {
!           softlog->Log(SOFT_LOG_ERROR, 0,
                      "[dfb] SetParams (a) EXITING: action=%s, result=%s\n",
                      ex->GetAction(), ex->GetResult());
***************
*** 992,996 ****
        else
        {
!         setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                    "[dfb] creating new surface (stretchBlit)\n");
          try
--- 992,996 ----
        else
        {
!         softlog->Log(SOFT_LOG_DEBUG, 0,
                    "[dfb] creating new surface (stretchBlit)\n");
          try
***************
*** 1035,1039 ****
          catch (DFBException *ex)
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                      "[dfb] SetParams (b) EXITING: action=%s, result=%s\n",
                      ex->GetAction(), ex->GetResult());
--- 1035,1039 ----
          catch (DFBException *ex)
          {
!           softlog->Log(SOFT_LOG_ERROR, 0,
                      "[dfb] SetParams (b) EXITING: action=%s, result=%s\n",
                      ex->GetAction(), ex->GetResult());
***************
*** 1044,1048 ****
        ReportSurfaceCapabilities (videoSurface, "videoSurface");
  
!       setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                  "[dfb] (re)configured 0x%08x\n",pixelformat);
      }
--- 1044,1048 ----
        ReportSurfaceCapabilities (videoSurface, "videoSurface");
  
!       softlog->Log(SOFT_LOG_DEBUG, 0,
                  "[dfb] (re)configured 0x%08x\n",pixelformat);
      }
***************
*** 1050,1054 ****
    else
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "No Videolayer available. Exiting...\n");
      exit(EXIT_FAILURE);
--- 1050,1054 ----
    else
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "No Videolayer available. Exiting...\n");
      exit(EXIT_FAILURE);
***************
*** 1081,1085 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] OpenOSD: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 1081,1085 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] OpenOSD: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 1104,1108 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] OSDStart: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 1104,1108 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] OSDStart: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 1139,1143 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] Refresh: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 1139,1143 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] Refresh: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 1188,1192 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] Refresh: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 1188,1192 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] Refresh: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 1262,1266 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] CloseOSD: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 1262,1266 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] CloseOSD: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 1483,1487 ****
    }
    catch (DFBException *ex) {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] YUV: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
--- 1483,1487 ----
    }
    catch (DFBException *ex) {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[dfb] YUV: action=%s, result=%s\n",
                ex->GetAction(), ex->GetResult());
***************
*** 1501,1505 ****
  
    if (!CLE266MPEGInitialise(fbName)) {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "Initialising CLE266 decoder (%s): failed!\n", fbName);
        free(fbName);
--- 1501,1505 ----
  
    if (!CLE266MPEGInitialise(fbName)) {
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "Initialising CLE266 decoder (%s): failed!\n", fbName);
        free(fbName);
***************
*** 1507,1511 ****
    } else {
        free(fbName);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "Initialising CLE266 decoder (%s): success!\n", fbName);
    }
--- 1507,1511 ----
    } else {
        free(fbName);
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "Initialising CLE266 decoder (%s): success!\n", fbName);
    }
***************
*** 1522,1526 ****
  
  /* Create the 4 MPEG buffers for decoding */
!   setupStore->softlog->Log(SOFT_LOG_INFO, 0,
              "CLE266: Creating buffers for decoder\n");
    for (int j=0; j < LAST_PICBUF; j++)
--- 1522,1526 ----
  
  /* Create the 4 MPEG buffers for decoding */
!   softlog->Log(SOFT_LOG_INFO, 0,
              "CLE266: Creating buffers for decoder\n");
    for (int j=0; j < LAST_PICBUF; j++)
***************
*** 1529,1533 ****
    try {
      for (i = 0; i < 4; i++) {
!       setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                  "CLE266: Creating buffer number %i\n", i);
        mpegfb[i] = dfb->CreateSurface(dsc);
--- 1529,1533 ----
    try {
      for (i = 0; i < 4; i++) {
!       softlog->Log(SOFT_LOG_DEBUG, 0,
                  "CLE266: Creating buffer number %i\n", i);
        mpegfb[i] = dfb->CreateSurface(dsc);
***************
*** 1539,1543 ****
        if ( PicBuffer[i].use_count>0 ||
             PicBuffer[i].max_width>0 || PicBuffer[i].max_height>0) {
!               setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                          "Fatal error setting up CLE266 buffers!\n");
                exit(-1);
--- 1539,1543 ----
        if ( PicBuffer[i].use_count>0 ||
             PicBuffer[i].max_width>0 || PicBuffer[i].max_height>0) {
!               softlog->Log(SOFT_LOG_ERROR, 0,
                          "Fatal error setting up CLE266 buffers!\n");
                exit(-1);
***************
*** 1560,1564 ****
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "CLE266: Error creating buffer: action=%s, result=%s\n",
                    ex->GetAction(), ex->GetResult());
--- 1560,1564 ----
    catch (DFBException *ex)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "CLE266: Error creating buffer: action=%s, result=%s\n",
                    ex->GetAction(), ex->GetResult());
***************
*** 1568,1572 ****
  
    /* Pass info to the decoder...*/
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
              "CLE266: passing mpegfb_stride\n");
    CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride >> 1 );
--- 1568,1572 ----
  
    /* Pass info to the decoder...*/
!   softlog->Log(SOFT_LOG_DEBUG, 0,
              "CLE266: passing mpegfb_stride\n");
    CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride >> 1 );
***************
*** 1575,1579 ****
    width  = (width  + 15) & ~15;
  
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
              "CLE266: passing buffers to decoder\n");
    for (i = 0; i < 4; i++) {
--- 1575,1579 ----
    width  = (width  + 15) & ~15;
  
!   softlog->Log(SOFT_LOG_DEBUG, 0,
              "CLE266: passing buffers to decoder\n");
    for (i = 0; i < 4; i++) {
***************
*** 1591,1595 ****
  cDFBVideoOut::~cDFBVideoOut()
  {
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0, "Releasing DFB\n");
  
    setupStore->osdMode = prevOsdMode;
--- 1591,1595 ----
  cDFBVideoOut::~cDFBVideoOut()
  {
!   softlog->Log(SOFT_LOG_DEBUG, 0, "Releasing DFB\n");
  
    setupStore->osdMode = prevOsdMode;
***************
*** 1620,1626 ****
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s)
  {
!   return new cDFBVideoOut(s);
  }
  #endif
--- 1620,1626 ----
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s, cSetupSoftlog *log)
  {
!   return new cDFBVideoOut(s,log);
  }
  #endif

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** video-dfb.h	4 Mar 2007 17:45:38 -0000	1.26
--- video-dfb.h	10 May 2007 19:54:44 -0000	1.27
***************
*** 68,72 ****
    public:
      IDirectFB	*dfb;
!     cDFBVideoOut(cSetupStore *setupStore);
      virtual ~cDFBVideoOut();
      void ProcessEvents ();
--- 68,72 ----
    public:
      IDirectFB	*dfb;
!     cDFBVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog);
      virtual ~cDFBVideoOut();
      void ProcessEvents ();

Index: video-dummy.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dummy.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-dummy.c	11 Nov 2006 08:45:17 -0000	1.4
--- video-dummy.c	10 May 2007 19:54:44 -0000	1.5
***************
*** 13,18 ****
  
  
! cDummyVideoOut::cDummyVideoOut(cSetupStore *setupStore)
!                 : cVideoOut(setupStore)
  {
      printf("[video-dummy] Initializing Driver, no output supported. You have to configure a driver IN the Makefile\n");
--- 13,18 ----
  
  
! cDummyVideoOut::cDummyVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog)
!                 : cVideoOut(setupStore,Softlog)
  {
      printf("[video-dummy] Initializing Driver, no output supported. You have to configure a driver IN the Makefile\n");

Index: video-dummy.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dummy.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** video-dummy.h	11 Nov 2006 08:45:17 -0000	1.4
--- video-dummy.h	10 May 2007 19:54:44 -0000	1.5
***************
*** 14,18 ****
  private:
  public:
!   cDummyVideoOut(cSetupStore *setupStore);
    virtual ~cDummyVideoOut();
  
--- 14,18 ----
  private:
  public:
!   cDummyVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog);
    virtual ~cDummyVideoOut();
  

Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-fb.c	25 Mar 2007 09:08:22 -0000	1.18
--- video-fb.c	10 May 2007 19:54:44 -0000	1.19
***************
*** 21,26 ****
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
  // --- cFrameBuffer --------------------------------------------------------
! cFBVideoOut::cFBVideoOut(cSetupStore *setupStore)
!               : cVideoOut(setupStore)
  {
      char    *fbName = getFBName();
--- 21,26 ----
  static  pthread_mutex_t fb_mutex = PTHREAD_MUTEX_INITIALIZER;
  // --- cFrameBuffer --------------------------------------------------------
! cFBVideoOut::cFBVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog)
!               : cVideoOut(setupStore, Softlog)
  {
      char    *fbName = getFBName();
***************
*** 226,232 ****
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s)
  {
!   return new cFBVideoOut(s);
  }
  #endif
--- 226,232 ----
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s, cSetupSoftlog *log)
  {
!   return new cFBVideoOut(s,log);
  }
  #endif

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-fb.h	25 Mar 2007 09:08:22 -0000	1.10
--- video-fb.h	10 May 2007 19:54:44 -0000	1.11
***************
*** 27,31 ****
    sPicBuffer privBuf;
  public:
!   cFBVideoOut(cSetupStore *setupStore);
    virtual ~cFBVideoOut();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
--- 27,31 ----
    sPicBuffer privBuf;
  public:
!   cFBVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog);
    virtual ~cFBVideoOut();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,

Index: video-quartz.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-quartz.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** video-quartz.c	3 Apr 2007 20:21:04 -0000	1.1
--- video-quartz.c	10 May 2007 19:54:44 -0000	1.2
***************
*** 484,488 ****
  
  
! cQuartzVideoOut::cQuartzVideoOut(cSetupStore *store) : cVideoOut(store),
          theWindow(NULL), winGroup(NULL), winLevel(1) {
          QDEB("cQuartVideoOut\n");
--- 484,489 ----
  
  
! cQuartzVideoOut::cQuartzVideoOut(cSetupStore *store, cSetupSoftlog* Softlog) 
! 		: cVideoOut(store, Softlog),
          theWindow(NULL), winGroup(NULL), winLevel(1) {
          QDEB("cQuartVideoOut\n");

Index: video-quartz.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-quartz.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** video-quartz.h	3 Apr 2007 20:21:04 -0000	1.1
--- video-quartz.h	10 May 2007 19:54:44 -0000	1.2
***************
*** 73,77 ****
          int osd_shm_id;
          int pic_shm_id;
!         cQuartzVideoOut(cSetupStore *setupStore);
          virtual ~cQuartzVideoOut();
  
--- 73,77 ----
          int osd_shm_id;
          int pic_shm_id;
!         cQuartzVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog);
          virtual ~cQuartzVideoOut();
  

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-shm.c	3 Apr 2007 20:21:04 -0000	1.17
--- video-shm.c	10 May 2007 19:54:44 -0000	1.18
***************
*** 61,66 ****
  
  /*----------------------------------------------------------------------------*/
! cShmVideoOut::cShmVideoOut(cSetupStore *setupStore) 
!         : cVideoOut(setupStore) {
          ctl_key = CTL_KEY;
          bool Clear_Ctl=false;
--- 61,66 ----
  
  /*----------------------------------------------------------------------------*/
! cShmVideoOut::cShmVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog) 
!         : cVideoOut(setupStore, Softlog) {
          ctl_key = CTL_KEY;
          bool Clear_Ctl=false;
***************
*** 423,429 ****
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s)
  {
!   return new cShmVideoOut(s);
  }
  #endif
--- 423,429 ----
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s, cSetupSoftlog *log)
  {
!   return new cShmVideoOut(s,log);
  }
  #endif

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-shm.h	26 Nov 2006 19:00:17 -0000	1.9
--- video-shm.h	10 May 2007 19:54:44 -0000	1.10
***************
*** 41,45 ****
  
          public:
!         cShmVideoOut(cSetupStore *setupStore);
          ~cShmVideoOut();
          
--- 41,45 ----
  
          public:
!         cShmVideoOut(cSetupStore *setupStore, cSetupSoftlog *softlog);
          ~cShmVideoOut();
          

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** video-vidix.c	24 Feb 2007 14:04:14 -0000	1.25
--- video-vidix.c	10 May 2007 19:54:44 -0000	1.26
***************
*** 28,33 ****
  /* ---------------------------------------------------------------------------
   */
! cVidixVideoOut::cVidixVideoOut(cSetupStore *setupStore)
!                   : cVideoOut(setupStore)
  {
      int     err;
--- 28,33 ----
  /* ---------------------------------------------------------------------------
   */
! cVidixVideoOut::cVidixVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog)
!                   : cVideoOut(setupStore,Softlog)
  {
      int     err;
***************
*** 36,40 ****
  
      if ((fbdev = open(fbName, O_RDWR)) == -1) {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] Can't open framebuffer exiting\n");
          free(fbName);
--- 36,40 ----
  
      if ((fbdev = open(fbName, O_RDWR)) == -1) {
!         softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] Can't open framebuffer exiting\n");
          free(fbName);
***************
*** 44,53 ****
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] Can't get VSCREENINFO exiting\n");
          exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] Can't get FSCREENINFO exiting\n");
          exit(1);
--- 44,53 ----
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] Can't get VSCREENINFO exiting\n");
          exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] Can't get FSCREENINFO exiting\n");
          exit(1);
***************
*** 57,61 ****
  
         case FB_VISUAL_TRUECOLOR:
!            setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                       "[cVidixVideoOut] Truecolor FB found\n");
             break;
--- 57,61 ----
  
         case FB_VISUAL_TRUECOLOR:
!            softlog->Log(SOFT_LOG_INFO, 0,
                       "[cVidixVideoOut] Truecolor FB found\n");
             break;
***************
*** 66,70 ****
             __u16 red[256], green[256], blue[256];
  
!            setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                       "[cVidixVideoOut] DirectColor FB found\n");
  
--- 66,70 ----
             __u16 red[256], green[256], blue[256];
  
!            softlog->Log(SOFT_LOG_INFO, 0,
                       "[cVidixVideoOut] DirectColor FB found\n");
  
***************
*** 73,77 ****
  
             if ( orig_cmap == NULL ) {
!                setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                           "[cVidixVideoOut] Can't alloc memory for cmap exiting\n");
                 exit(1);
--- 73,77 ----
  
             if ( orig_cmap == NULL ) {
!                softlog->Log(SOFT_LOG_ERROR, 0,
                           "[cVidixVideoOut] Can't alloc memory for cmap exiting\n");
                 exit(1);
***************
*** 85,89 ****
  
             if ( ioctl(fbdev, FBIOGETCMAP, &cmap)) {
!                setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                           "[cVidixVideoOut] Can't get cmap\n");
             }
--- 85,89 ----
  
             if ( ioctl(fbdev, FBIOGETCMAP, &cmap)) {
!                softlog->Log(SOFT_LOG_ERROR, 0,
                           "[cVidixVideoOut] Can't get cmap\n");
             }
***************
*** 101,105 ****
  
             if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                           "[cVidixVideoOut] Can't put cmap\n");
             }
--- 101,105 ----
  
             if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                softlog->Log(SOFT_LOG_ERROR, 0,
                           "[cVidixVideoOut] Can't put cmap\n");
             }
***************
*** 108,112 ****
  
         default:
!            setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                       "[cVidixVideoOut] Unsupported FB. Don't know if it will work.\n");
      }
--- 108,112 ----
  
         default:
!            softlog->Log(SOFT_LOG_ERROR, 0,
                       "[cVidixVideoOut] Unsupported FB. Don't know if it will work.\n");
      }
***************
*** 130,138 ****
      SetParValues(displayRatio, displayRatio);
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] xres = %d yres= %d \n", fb_vinfo.xres, fb_vinfo.yres);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] line length = %d \n", fb_line_len);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] bpp = %d\n", fb_vinfo.bits_per_pixel);
  
--- 130,138 ----
      SetParValues(displayRatio, displayRatio);
  
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] xres = %d yres= %d \n", fb_vinfo.xres, fb_vinfo.yres);
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] line length = %d \n", fb_line_len);
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] bpp = %d\n", fb_vinfo.bits_per_pixel);
  
***************
*** 140,144 ****
  
      if ( fb == (uint8_t *) -1 ) {
!        setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                   "[cVidixVideoOut] Can't mmap framebuffer memory exiting\n");
         exit(1);
--- 140,144 ----
  
      if ( fb == (uint8_t *) -1 ) {
!        softlog->Log(SOFT_LOG_ERROR, 0,
                   "[cVidixVideoOut] Can't mmap framebuffer memory exiting\n");
         exit(1);
***************
*** 149,153 ****
      vidix_version = vdlGetVersion();
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] vidix version: %i\n", vidix_version);
  
--- 149,153 ----
      vidix_version = vdlGetVersion();
  
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] vidix version: %i\n", vidix_version);
  
***************
*** 156,160 ****
      if( !vidix_handler )
      {
!        setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                   "[cVidixVideoOut] Couldn't find working VIDIX driver exiting\n");
         exit(1);
--- 156,160 ----
      if( !vidix_handler )
      {
!        softlog->Log(SOFT_LOG_ERROR, 0,
                   "[cVidixVideoOut] Couldn't find working VIDIX driver exiting\n");
         exit(1);
***************
*** 163,172 ****
      if( (err = vdlGetCapability(vidix_handler,&vidix_cap)) != 0)
      {
!        setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                   "[cVidixVideoOut] Couldn't get capability: %s exiting\n",
                   strerror(err) );
         exit(1);
      }
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] capabilities:  0x%0x\n", vidix_cap.flags );
  
--- 163,172 ----
      if( (err = vdlGetCapability(vidix_handler,&vidix_cap)) != 0)
      {
!        softlog->Log(SOFT_LOG_ERROR, 0,
                   "[cVidixVideoOut] Couldn't get capability: %s exiting\n",
                   strerror(err) );
         exit(1);
      }
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] capabilities:  0x%0x\n", vidix_cap.flags );
  
***************
*** 187,191 ****
        if (!MatchPixelFormat())
        {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] no matching pixel format found exiting\n");
          exit(1);
--- 187,191 ----
        if (!MatchPixelFormat())
        {
!         softlog->Log(SOFT_LOG_ERROR, 0,
                    "[cVidixVideoOut] no matching pixel format found exiting\n");
          exit(1);
***************
*** 211,215 ****
      vidix_play.num_frames   = 2;
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] fourcc.flags:  0x%0x\n",vidix_fourcc.flags);
      AllocLayer();
--- 211,215 ----
      vidix_play.num_frames   = 2;
  
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] fourcc.flags:  0x%0x\n",vidix_fourcc.flags);
      AllocLayer();
***************
*** 219,232 ****
       */
      vidix_video_eq_t tmpeq;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] capabilities\n");
  
      if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {
          vidix_curr_eq=tmpeq;
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                    "[cVidixVideoOut] EQ cap: %x:\n",
                    vidix_curr_eq.cap);
          if (vidix_curr_eq.cap & VEQ_CAP_BRIGHTNESS) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  brightness (%d)\n",
                        vidix_curr_eq.brightness);
--- 219,232 ----
       */
      vidix_video_eq_t tmpeq;
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] capabilities\n");
  
      if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {
          vidix_curr_eq=tmpeq;
!         softlog->Log(SOFT_LOG_INFO, 0,
                    "[cVidixVideoOut] EQ cap: %x:\n",
                    vidix_curr_eq.cap);
          if (vidix_curr_eq.cap & VEQ_CAP_BRIGHTNESS) {
!             softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  brightness (%d)\n",
                        vidix_curr_eq.brightness);
***************
*** 234,238 ****
          }
          if (vidix_curr_eq.cap & VEQ_CAP_CONTRAST) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  contrast (%d)\n",
                        vidix_curr_eq.contrast);
--- 234,238 ----
          }
          if (vidix_curr_eq.cap & VEQ_CAP_CONTRAST) {
!             softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  contrast (%d)\n",
                        vidix_curr_eq.contrast);
***************
*** 240,244 ****
          }
          if (vidix_curr_eq.cap & VEQ_CAP_SATURATION) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  saturation (%d)\n",
                        vidix_curr_eq.saturation);
--- 240,244 ----
          }
          if (vidix_curr_eq.cap & VEQ_CAP_SATURATION) {
!             softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  saturation (%d)\n",
                        vidix_curr_eq.saturation);
***************
*** 246,250 ****
          }
          if (vidix_curr_eq.cap & VEQ_CAP_HUE) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  hue (%d)\n",
                        vidix_curr_eq.hue);
--- 246,250 ----
          }
          if (vidix_curr_eq.cap & VEQ_CAP_HUE) {
!             softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  hue (%d)\n",
                        vidix_curr_eq.hue);
***************
*** 252,256 ****
          }
          if (vidix_curr_eq.cap & VEQ_CAP_RGB_INTENSITY) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  RGB-intensity (%d, %d, %d)\n",
                        vidix_curr_eq.red_intensity,
--- 252,256 ----
          }
          if (vidix_curr_eq.cap & VEQ_CAP_RGB_INTENSITY) {
!             softlog->Log(SOFT_LOG_INFO, 0,
                        "[cVidixVideoOut]  RGB-intensity (%d, %d, %d)\n",
                        vidix_curr_eq.red_intensity,
***************
*** 259,263 ****
          }
      } else {
!        setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                   "[cVidixVideoOut] Couldn't get EQ capability\n");
      }
--- 259,263 ----
          }
      } else {
!        softlog->Log(SOFT_LOG_INFO, 0,
                   "[cVidixVideoOut] Couldn't get EQ capability\n");
      }
***************
*** 270,274 ****
      if (!vdlPlaybackGetDeint(vidix_handler, &vidix_deint) &&
          !vdlPlaybackSetDeint(vidix_handler, &vidix_deint)) {
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                    "[cVidixVideoOut]  HW-deinterlace (%x,%x)\n",
                    vidix_deint.flags,
--- 270,274 ----
      if (!vdlPlaybackGetDeint(vidix_handler, &vidix_deint) &&
          !vdlPlaybackSetDeint(vidix_handler, &vidix_deint)) {
!         softlog->Log(SOFT_LOG_INFO, 0,
                    "[cVidixVideoOut]  HW-deinterlace (%x,%x)\n",
                    vidix_deint.flags,
***************
*** 314,318 ****
      cutBottom = setupStore->cropBottomLines;
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] Video changed format to %dx%d\n",
                fwidth, fheight);
--- 314,318 ----
      cutBottom = setupStore->cropBottomLines;
  
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] Video changed format to %dx%d\n",
                fwidth, fheight);
***************
*** 321,325 ****
         (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                  "[cVidixVideoOut] vidix driver can't "
                  "upscale image (%dx%d -> %dx%d) exiting\n",
--- 321,325 ----
         (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
      {
!       softlog->Log(SOFT_LOG_ERROR, 0,
                  "[cVidixVideoOut] vidix driver can't "
                  "upscale image (%dx%d -> %dx%d) exiting\n",
***************
*** 331,335 ****
         (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                  "[cVidixVideoOut] vidix driver can't "
                  "downscale image (%dx%d -> %dx%d) exiting\n",
--- 331,335 ----
         (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
      {
!       softlog->Log(SOFT_LOG_ERROR, 0,
                  "[cVidixVideoOut] vidix driver can't "
                  "downscale image (%dx%d -> %dx%d) exiting\n",
***************
*** 352,356 ****
          if (!MatchPixelFormat())
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                      "[cVidixVideoOut]: no matching pixel "
                      "format found exiting\n");
--- 352,356 ----
          if (!MatchPixelFormat())
          {
!           softlog->Log(SOFT_LOG_ERROR, 0,
                      "[cVidixVideoOut]: no matching pixel "
                      "format found exiting\n");
***************
*** 405,413 ****
        vidix_curr_eq.hue != vidix_video_eq.hue ) {
  
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[cVidixVideoOut] set eq values\n");
        vidix_curr_eq = vidix_video_eq;
        if( (err = vdlPlaybackSetEq(vidix_handler, &vidix_curr_eq)) != 0) {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                      "[cVidixVideoOut] Couldn't set EQ "
                      "capability: %s (FAILED)\n",
--- 405,413 ----
        vidix_curr_eq.hue != vidix_video_eq.hue ) {
  
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[cVidixVideoOut] set eq values\n");
        vidix_curr_eq = vidix_video_eq;
        if( (err = vdlPlaybackSetEq(vidix_handler, &vidix_curr_eq)) != 0) {
!           softlog->Log(SOFT_LOG_ERROR, 0,
                      "[cVidixVideoOut] Couldn't set EQ "
                      "capability: %s (FAILED)\n",
***************
*** 460,464 ****
        vdlPlaybackSetDeint(vidix_handler, &vidix_deint);
        vdlPlaybackGetDeint(vidix_handler, &vidix_deint);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[cVidixVideoOut] Deinterlacer: %x %x\n",
                  vidix_deint.flags,
--- 460,464 ----
        vdlPlaybackSetDeint(vidix_handler, &vidix_deint);
        vdlPlaybackGetDeint(vidix_handler, &vidix_deint);
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[cVidixVideoOut] Deinterlacer: %x %x\n",
                  vidix_deint.flags,
***************
*** 480,484 ****
    if ((err = vdlPlaybackOff(vidix_handler)) != 0)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[cVidixVideoOut] Can't stop playback: %s exiting\n",
                strerror(err));
--- 480,484 ----
    if ((err = vdlPlaybackOff(vidix_handler)) != 0)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[cVidixVideoOut] Can't stop playback: %s exiting\n",
                strerror(err));
***************
*** 488,492 ****
    if ((err = vdlConfigPlayback(vidix_handler, &vidix_play)) != 0)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                 "[cVidixVideoOut] Can't configure playback: %s exiting\n",
                 strerror(err));
--- 488,492 ----
    if ((err = vdlConfigPlayback(vidix_handler, &vidix_play)) != 0)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                 "[cVidixVideoOut] Can't configure playback: %s exiting\n",
                 strerror(err));
***************
*** 496,500 ****
    if ((err = vdlPlaybackOn(vidix_handler)) != 0)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                "[cVidixVideoOut] Can't start playback: %s exiting\n",
                strerror(err));
--- 496,500 ----
    if ((err = vdlPlaybackOn(vidix_handler)) != 0)
    {
!     softlog->Log(SOFT_LOG_ERROR, 0,
                "[cVidixVideoOut] Can't start playback: %s exiting\n",
                strerror(err));
***************
*** 506,510 ****
      int res = 0;
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] set colorkey\n");
      vdlGetGrKeys(vidix_handler, &gr_key);
--- 506,510 ----
      int res = 0;
  
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] set colorkey\n");
      vdlGetGrKeys(vidix_handler, &gr_key);
***************
*** 523,527 ****
      gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
      res = vdlSetGrKeys(vidix_handler, &gr_key);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] vdlSetGrKeys() = %d\n", res);
  
--- 523,527 ----
      gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
      res = vdlSetGrKeys(vidix_handler, &gr_key);
!     softlog->Log(SOFT_LOG_INFO, 0,
                "[cVidixVideoOut] vdlSetGrKeys() = %d\n", res);
  
***************
*** 529,533 ****
        gr_key.ckey.op = CKEY_TRUE;
        res = vdlSetGrKeys(vidix_handler, &gr_key);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
                  "[cVidixVideoOut] vdlSetGrKeys() = %d (noAlpha)\n", res);
        useVidixAlpha = false;
--- 529,533 ----
        gr_key.ckey.op = CKEY_TRUE;
        res = vdlSetGrKeys(vidix_handler, &gr_key);
!       softlog->Log(SOFT_LOG_INFO, 0,
                  "[cVidixVideoOut] vdlSetGrKeys() = %d (noAlpha)\n", res);
        useVidixAlpha = false;
***************
*** 846,855 ****
      int err;
  
!     setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                "[cVidixVideoOut] destructor\n");
  
      if(vidix_handler) {
          if((err = vdlPlaybackOff(vidix_handler)) != 0) {
!            setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                       "[cVidixVideoOut] Can't stop playback: %s\n",
                       strerror(err));
--- 846,855 ----
      int err;
  
!     softlog->Log(SOFT_LOG_DEBUG, 0,
                "[cVidixVideoOut] destructor\n");
  
      if(vidix_handler) {
          if((err = vdlPlaybackOff(vidix_handler)) != 0) {
!            softlog->Log(SOFT_LOG_ERROR, 0,
                       "[cVidixVideoOut] Can't stop playback: %s\n",
                       strerror(err));
***************
*** 872,876 ****
  
                 if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                    setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
                               "[cVidixVideoOut] Can't put cmap\n");
                 }
--- 872,876 ----
  
                 if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                    softlog->Log(SOFT_LOG_ERROR, 0,
                               "[cVidixVideoOut] Can't put cmap\n");
                 }
***************
*** 890,896 ****
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s)
  {
!   return new cVidixVideoOut(s);
  }
  #endif
--- 890,896 ----
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s, cSetupSoftlog *log)
  {
!   return new cVidixVideoOut(s,log);
  }
  #endif

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** video-vidix.h	11 Nov 2006 08:45:17 -0000	1.12
--- video-vidix.h	10 May 2007 19:54:44 -0000	1.13
***************
*** 43,47 ****
  
  public:
!   cVidixVideoOut(cSetupStore *setupStore);
    virtual ~cVidixVideoOut();
  
--- 43,47 ----
  
  public:
!   cVidixVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog);
    virtual ~cVidixVideoOut();
  

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.69
retrieving revision 1.70
diff -C2 -d -r1.69 -r1.70
*** video-xv.c	10 May 2007 19:49:51 -0000	1.69
--- video-xv.c	10 May 2007 19:54:44 -0000	1.70
***************
*** 761,766 ****
  /* ---------------------------------------------------------------------------
   */
! cXvVideoOut::cXvVideoOut(cSetupStore *setupStore)
!               : cVideoOut(setupStore)
  {
    OSDpresent = false;
--- 761,766 ----
  /* ---------------------------------------------------------------------------
   */
! cXvVideoOut::cXvVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog)
!               : cVideoOut(setupStore, Softlog)
  {
    OSDpresent = false;
***************
*** 1902,1908 ****
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s)
  {
!   return new cXvVideoOut(s);
  }
  #endif
--- 1902,1908 ----
   */
  extern "C" void *
! SubPluginCreator(cSetupStore *s, cSetupSoftlog *log)
  {
!   return new cXvVideoOut(s,log);
  }
  #endif

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** video-xv.h	26 Nov 2006 19:00:17 -0000	1.26
--- video-xv.h	10 May 2007 19:54:44 -0000	1.27
***************
*** 170,174 ****
  
  public:
!   cXvVideoOut(cSetupStore *setupStore);
    virtual ~cXvVideoOut();
    virtual void ProcessEvents ();
--- 170,174 ----
  
  public:
!   cXvVideoOut(cSetupStore *setupStore, cSetupSoftlog *softlog);
    virtual ~cXvVideoOut();
    virtual void ProcessEvents ();

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.74
retrieving revision 1.75
diff -C2 -d -r1.74 -r1.75
*** video.c	25 Mar 2007 09:00:11 -0000	1.74
--- video.c	10 May 2007 19:54:44 -0000	1.75
***************
*** 27,31 ****
  /* ---------------------------------------------------------------------------
   */
! cVideoOut::cVideoOut(cSetupStore *setupStore)
  {
    OsdWidth=OSD_FULL_WIDTH;
--- 27,31 ----
  /* ---------------------------------------------------------------------------
   */
! cVideoOut::cVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog)
  {
    OsdWidth=OSD_FULL_WIDTH;
***************
*** 49,52 ****
--- 49,53 ----
    displayTimeUS = 0;
    this->setupStore=setupStore;
+   softlog=Softlog;
    freezeMode=false;
    videoInitialized = false;
***************
*** 540,544 ****
    offsetIndex %= AVRG_OFF_CNT;
  
!   setupStore->softlog->Log(SOFT_LOG_TRACE, 0,
                    "[VideoOut] A/V (%d - %d) off = %d avoff = %d\n",
                    aPTS, pts, offset, offsetAverage);
--- 541,545 ----
    offsetIndex %= AVRG_OFF_CNT;
  
!   softlog->Log(SOFT_LOG_TRACE, 0,
                    "[VideoOut] A/V (%d - %d) off = %d avoff = %d\n",
                    aPTS, pts, offset, offsetAverage);
***************
*** 581,585 ****
  
    if (frame < 100) {
!     setupStore->softlog->Log(SOFT_LOG_TRACE, 0,
                    "[VideoOut] %d %d %d \n",
                    frame, offset, offsetAverage);
--- 582,586 ----
  
    if (frame < 100) {
!     softlog->Log(SOFT_LOG_TRACE, 0,
                    "[VideoOut] %d %d %d \n",
                    frame, offset, offsetAverage);
***************
*** 590,594 ****
        if (abs(offset) < frametime) {
          offsetInHold = true;
!         setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                    "[VideoOut] video now synced (%d - %d)\n",
                    frame, offset);
--- 591,595 ----
        if (abs(offset) < frametime) {
          offsetInHold = true;
!         softlog->Log(SOFT_LOG_DEBUG, 0,
                    "[VideoOut] video now synced (%d - %d)\n",
                    frame, offset);
***************
*** 597,601 ****
    }
    if (frame && !(frame % 7500)) {
!     setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
                "[VideoOut] sync info: repF = %d, drpF = %d, totF = %d\n",
                repeatedFrames, droppedFrames, frame);
--- 598,602 ----
    }
    if (frame && !(frame % 7500)) {
!     softlog->Log(SOFT_LOG_DEBUG, 0,
                "[VideoOut] sync info: repF = %d, drpF = %d, totF = %d\n",
                repeatedFrames, droppedFrames, frame);
***************
*** 614,618 ****
    memset (offsetHistory, 0, sizeof(offsetHistory));
  
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
              "[VideoOut] reset: sync info: repF = %d, drpF = %d, totF = %d\n",
              repeatedFrames, droppedFrames, frame);
--- 615,619 ----
    memset (offsetHistory, 0, sizeof(offsetHistory));
  
!   softlog->Log(SOFT_LOG_DEBUG, 0,
              "[VideoOut] reset: sync info: repF = %d, drpF = %d, totF = %d\n",
              repeatedFrames, droppedFrames, frame);

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.52
retrieving revision 1.53
diff -C2 -d -r1.52 -r1.53
*** video.h	25 Mar 2007 09:05:56 -0000	1.52
--- video.h	10 May 2007 19:54:44 -0000	1.53
***************
*** 108,111 ****
--- 108,112 ----
  
      cSetupStore *setupStore;
+     cSetupSoftlog *softlog;
  
      bool active;
***************
*** 146,150 ****
  
  public:
!     cVideoOut(cSetupStore *setupStore);
      virtual ~cVideoOut();
  
--- 147,151 ----
  
  public:
!     cVideoOut(cSetupStore *setupStore, cSetupSoftlog *Softlog);
      virtual ~cVideoOut();
  



From nobody at sheep.berlios.de  Thu May 10 23:59:34 2007
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 10 May 2007 23:59:34 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.312, 1.313 SoftOsd.c, 1.27,
	1.28 SoftOsd.h, 1.13, 1.14 utils.c, 1.26, 1.27 utils.h, 1.17,
	1.18 video-dfb.c, 1.81, 1.82 video-dfb.h, 1.27,
	1.28 video-fb.h, 1.11, 1.12 video-shm.c, 1.18,
	1.19 video-shm.h, 1.10, 1.11 video-vidix.c, 1.26,
	1.27 video-vidix.h, 1.13, 1.14 video-xv.c, 1.70,
	1.71 video-xv.h, 1.27, 1.28 video.h, 1.53, 1.54
Message-ID: <20070510215934.D402EEFFEB@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27371

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h utils.c utils.h video-dfb.c 
	video-dfb.h video-fb.h video-shm.c video-shm.h video-vidix.c 
	video-vidix.h video-xv.c video-xv.h video.h 
Log Message:
- remove left over code from the old video-fb.
- remove pixel mask option from SoftOsd.[hc] and video*, which was only used
  by the old video-fb.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.312
retrieving revision 1.313
diff -C2 -d -r1.312 -r1.313
*** CHANGELOG	10 May 2007 19:54:44 -0000	1.312
--- CHANGELOG	10 May 2007 21:57:26 -0000	1.313
***************
*** 1,4 ****
--- 1,8 ----
  Changelog
  2007-05-10:
+    - remove left over code from the old video-fb.
+    - remove pixel mask option from SoftOsd.[hc] and video*, which was only used
+      by the old video-fb.
+    - adapt MacVdrClient.c to the setupStore in shared memory.
     - remove softlog from setupStore. Pointers aren't valid in a shared memory
       block.

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** SoftOsd.c	3 Apr 2007 19:40:29 -0000	1.27
--- SoftOsd.c	10 May 2007 21:57:26 -0000	1.28
***************
*** 51,55 ****
          OSDDEB("cSoftOsd constructor\n");
          OutputConvert=&cSoftOsd::ARGB_to_ARGB32;
-         pixelMask=NULL;
          bitmap_Format=PF_None; // forces a clear after first SetMode
          OSD_Bitmap=new uint32_t[OSD_STRIDE*(OSD_HEIGHT+4)];
--- 51,54 ----
***************
*** 65,74 ****
          ScreenOsdWidth=ScreenOsdHeight=0;
          int Depth=16; bool HasAlpha=false; bool AlphaInversed=false;
!         bool IsYUV=false; uint8_t *PixelMask=NULL;
          videoOut->AdjustOSDMode();
!         videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
!                         IsYUV,PixelMask);
!         SetMode(Depth,HasAlpha,AlphaInversed,
!                         IsYUV,PixelMask);
          voutMutex.Unlock();
  };
--- 64,71 ----
          ScreenOsdWidth=ScreenOsdHeight=0;
          int Depth=16; bool HasAlpha=false; bool AlphaInversed=false;
!         bool IsYUV=false; 
          videoOut->AdjustOSDMode();
!         videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV);
!         SetMode(Depth,HasAlpha,AlphaInversed,IsYUV);
          voutMutex.Unlock();
  };
***************
*** 132,140 ****
  
                  int Depth=16; bool HasAlpha=false; bool AlphaInversed=false;
!                 bool IsYUV=false; uint8_t *PixelMask=NULL;
!                 videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,
!                                 IsYUV,PixelMask);
!                 bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,
!                                 IsYUV,PixelMask);
  
                  if (newXPan != xPan || newYPan != yPan) {
--- 129,135 ----
  
                  int Depth=16; bool HasAlpha=false; bool AlphaInversed=false;
!                 bool IsYUV=false; 
!                 videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV);
!                 bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV);
  
                  if (newXPan != xPan || newYPan != yPan) {
***************
*** 180,186 ****
  
          int Depth=16; bool HasAlpha=false; bool AlphaInversed=false;
!         bool IsYUV=false; uint8_t *PixelMask=NULL;
!         videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
!         bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV,PixelMask);
  
          if (newXPan != xPan || newYPan != yPan) {
--- 175,181 ----
  
          int Depth=16; bool HasAlpha=false; bool AlphaInversed=false;
!         bool IsYUV=false; 
!         videoOut->GetOSDMode(Depth,HasAlpha,AlphaInversed,IsYUV);
!         bool modeChanged=SetMode(Depth,HasAlpha,AlphaInversed,IsYUV);
  
          if (newXPan != xPan || newYPan != yPan) {
***************
*** 222,228 ****
  /* --------------------------------------------------------------------------*/
  bool cSoftOsd::SetMode(int Depth, bool HasAlpha, bool AlphaInversed,
!                 bool IsYUV,uint8_t *PixelMask) {
!         //OSDDEB("SetMode Depth %d HasAlpha %d IsYUV %d AlphaInversed %d PixelMask %p\n",
!         //                Depth,HasAlpha,IsYUV,AlphaInversed,PixelMask);
  
          if (IsYUV) {
--- 217,223 ----
  /* --------------------------------------------------------------------------*/
  bool cSoftOsd::SetMode(int Depth, bool HasAlpha, bool AlphaInversed,
!                 bool IsYUV) {
!         //OSDDEB("SetMode Depth %d HasAlpha %d IsYUV %d AlphaInversed %d\n",
!         //                Depth,HasAlpha,IsYUV,AlphaInversed);
  
          if (IsYUV) {
***************
*** 238,242 ****
          };
  
-         pixelMask=PixelMask;
          switch (Depth) {
                  case 32: if (HasAlpha)
--- 233,236 ----
***************
*** 250,257 ****
                  case 16:
                           HasAlpha=false;
!                          if (PixelMask)
!                                  OutputConvert=&cSoftOsd::ARGB_to_RGB16_PixelMask;
!                          else
!                                  OutputConvert=&cSoftOsd::ARGB_to_RGB16;
                           break;
                  default:
--- 244,248 ----
                  case 16:
                           HasAlpha=false;
!                          OutputConvert=&cSoftOsd::ARGB_to_RGB16;
                           break;
                  default:
***************
*** 921,962 ****
          };
  };
- /*---------------------------------------------------------------------------*/
- 
- void cSoftOsd::ARGB_to_RGB16_PixelMask(uint8_t * dest, color * pixmap,
-                 int Pixel, int odd) {
-         uint8_t *end_dest=dest+2*Pixel;
-         int PixelCount=0;
-         int c;
-         while (end_dest>dest) {
-                 c=*pixmap;
-                 if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)pixmap) & 0x4)
-                                 || IS_TRANSPARENT(GET_A(c)) ) {
-                         // transparent, don't draw anything !
-                 } else {
-                         // FIXME 15/16bit mode? Probably broken!
-                         dest[0] = ((GET_B(c) >> 3)& 0x1F) |
-                                 ((GET_G(c) & 0x1C) << 3);
-                         dest[1] = ((GET_R(c) ) & 0xF8)
-                                 | ((GET_G(c) >> 5) );
-                 }
-                 dest+=2;
-                 pixmap++;
-                 PixelCount++;
-         };
- };
  
- void cSoftOsd::CreatePixelMask(uint8_t * dest, color * pixmap, int Pixel) {
-         int CurrPixel=0;
-         int c;
-         while (CurrPixel<Pixel) {
-                 c = *pixmap;
-                 if ( (IS_BACKGROUND(GET_A(c)) && !(((intptr_t)pixmap) & 0x4)  )
-                                 || IS_OPAQUE(GET_A(c)) )
-                         dest[CurrPixel/8]|=(1<<CurrPixel%8);
-                  else dest[CurrPixel/8]&=~(1<<CurrPixel%8);
-                 pixmap++;
-                 CurrPixel++;
-         };
- };
  //---------------------------YUV modes ----------------------
  void cSoftOsd::CopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
--- 912,916 ----
***************
*** 1340,1346 ****
                  buf=dest+y*linesize;
                  (*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2,y&1);
!                 if (pixelMask)
!                         CreatePixelMask(pixelMask+y*linesize/16,
!                                         tmp_pixmap+1,dest_Width-2);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
--- 1294,1298 ----
                  buf=dest+y*linesize;
                  (*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2,y&1);
!                 
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
***************
*** 1353,1359 ****
                          buf=dest+y*linesize;
                          (*OutputConvert)(buf,((color*)src)+1,dest_Width-2,y&1);
!                         if (pixelMask)
!                                 CreatePixelMask(pixelMask+y*linesize/16,
!                                                 ((color*)src)+1,dest_Width-2);
                          if (dest_dirtyLines)
                                  dest_dirtyLines[y]=true;
--- 1305,1309 ----
                          buf=dest+y*linesize;
                          (*OutputConvert)(buf,((color*)src)+1,dest_Width-2,y&1);
!                         
                          if (dest_dirtyLines)
                                  dest_dirtyLines[y]=true;
***************
*** 1407,1413 ****
                  //printf("copy to destination %d\n",y);
                  (*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2,y&1);
-                 if (pixelMask)
-                         CreatePixelMask(pixelMask+y*linesize/16,
-                                         tmp_pixmap+1,dest_Width-2);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
--- 1357,1360 ----
***************
*** 1483,1489 ****
                  //printf("copy to destination %d\n",y);
                  (*OutputConvert)(buf,tmp_pixmap+1,dest_Width-2,y&1);
-                 if (pixelMask)
-                         CreatePixelMask(pixelMask+y*linesize/16,
-                                         tmp_pixmap+1,dest_Width-2);
                  if (dest_dirtyLines)
                          dest_dirtyLines[y]=true;
--- 1430,1433 ----

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** SoftOsd.h	3 Apr 2007 19:40:29 -0000	1.13
--- SoftOsd.h	10 May 2007 21:57:26 -0000	1.14
***************
*** 74,78 ****
  
      void (*OutputConvert)(uint8_t * dest, color * pixmap, int Pixel, int odd);
-     uint8_t *pixelMask;
      enum PixFormat {
              PF_None,
--- 74,77 ----
***************
*** 105,110 ****
  
  protected:
!     bool SetMode(int Depth, bool HasAlpha, bool AlphaInversed,
!                  bool IsYUV, uint8_t *PixelMask=NULL);
  
      bool FlushBitmaps(bool OnlyDirty);
--- 104,108 ----
  
  protected:
!     bool SetMode(int Depth, bool HasAlpha, bool AlphaInversed, bool IsYUV);
  
      bool FlushBitmaps(bool OnlyDirty);
***************
*** 128,136 ****
      static void ARGB_to_RGB16(uint8_t * dest, color * pixmap, int Pixel,
                      int odd);
-     static void ARGB_to_RGB16_PixelMask(uint8_t * dest, color * pixmap,
-                     int Pixel, int odd);
- 
-     void CreatePixelMask(uint8_t * dest, color * pixmap, int Pixel);
- 
  
      static void AYUV_to_AYUV420P(uint8_t *PY1,uint8_t *PY2,
--- 126,129 ----

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** utils.c	10 May 2007 19:49:51 -0000	1.26
--- utils.c	10 May 2007 21:57:26 -0000	1.27
***************
*** 10,20 ****
  
  
- /*
-  * MMX conversion functions taken from the mpeg2dec project
-  * Copyright (C) 2000-2002 Silicon Integrated System Corp.
-  * All Rights Reserved.
-  *
-  * Author: Olie Lho <ollie at sis.com.tw>
- */
  #include <unistd.h>
  #include <stdlib.h>
--- 10,13 ----
***************
*** 27,32 ****
  #ifdef HAVE_CONFIG
  # include "config.h"
- #else
- # define  HAVE_BROKEN_GCC_CPP  0
  #endif
  
--- 20,23 ----
***************
*** 387,680 ****
  }
  
- #ifdef USE_MMX
- 
- #define VERT_SCALING
- void (*mmx_unpack)(uint8_t * image, int lines, int stride);
- 
- static inline void mmx_yuv2rgb (uint8_t * py, uint8_t * pu, uint8_t * pv)
- {
-     static mmx_t mmx_80w = {0x0080008000800080LL};
-     static mmx_t mmx_U_green = {0xf37df37df37df37dLL};
-     static mmx_t mmx_U_blue = {0x4093409340934093LL};
-     static mmx_t mmx_V_red = {0x3312331233123312LL};
-     static mmx_t mmx_V_green = {0xe5fce5fce5fce5fcLL};
-     static mmx_t mmx_10w = {0x1010101010101010LL};
-     static mmx_t mmx_00ffw = {0x00ff00ff00ff00ffLL};
-     static mmx_t mmx_Y_coeff = {0x253f253f253f253fLL};
- 
-     movd_m2r (*pu, mm0);		/* mm0 = 00 00 00 00 u3 u2 u1 u0 */
-     movd_m2r (*pv, mm1);		/* mm1 = 00 00 00 00 v3 v2 v1 v0 */
-     movq_m2r (*py, mm6);		/* mm6 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0 */
-     pxor_r2r (mm4, mm4);		/* mm4 = 0 */
-     /* XXX might do cache preload for image here */
- 
-     /*
-      * Do the multiply part of the conversion for even and odd pixels
-      * register usage:
-      * mm0 -> Cblue, mm1 -> Cred, mm2 -> Cgreen even pixels
-      * mm3 -> Cblue, mm4 -> Cred, mm5 -> Cgreen odd  pixels
-      * mm6 -> Y even, mm7 -> Y odd
-      */
- 
-     punpcklbw_r2r (mm4, mm0);		/* mm0 = u3 u2 u1 u0 */
-     punpcklbw_r2r (mm4, mm1);		/* mm1 = v3 v2 v1 v0 */
-     psubsw_m2r (mmx_80w, mm0);		/* u -= 128 */
-     psubsw_m2r (mmx_80w, mm1);		/* v -= 128 */
-     psllw_i2r (3, mm0);			/* promote precision */
-     psllw_i2r (3, mm1);			/* promote precision */
-     movq_r2r (mm0, mm2);		/* mm2 = u3 u2 u1 u0 */
-     movq_r2r (mm1, mm3);		/* mm3 = v3 v2 v1 v0 */
-     pmulhw_m2r (mmx_U_green, mm2);	/* mm2 = u * u_green */
-     pmulhw_m2r (mmx_V_green, mm3);	/* mm3 = v * v_green */
-     pmulhw_m2r (mmx_U_blue, mm0);	/* mm0 = chroma_b */
-     pmulhw_m2r (mmx_V_red, mm1);	/* mm1 = chroma_r */
-     paddsw_r2r (mm3, mm2);		/* mm2 = chroma_g */
- 
-     psubusb_m2r (mmx_10w, mm6);		/* Y -= 16 */
-     movq_r2r (mm6, mm7);		/* mm7 = Y7 Y6 Y5 Y4 Y3 Y2 Y1 Y0 */
-     pand_m2r (mmx_00ffw, mm6);		/* mm6 =    Y6    Y4    Y2    Y0 */
-     psrlw_i2r (8, mm7);			/* mm7 =    Y7    Y5    Y3    Y1 */
-     psllw_i2r (3, mm6);			/* promote precision */
-     psllw_i2r (3, mm7);			/* promote precision */
-     pmulhw_m2r (mmx_Y_coeff, mm6);	/* mm6 = luma_rgb even */
-     pmulhw_m2r (mmx_Y_coeff, mm7);	/* mm7 = luma_rgb odd */
- 
-     /*
-      * Do the addition part of the conversion for even and odd pixels
-      * register usage:
-      * mm0 -> Cblue, mm1 -> Cred, mm2 -> Cgreen even pixels
-      * mm3 -> Cblue, mm4 -> Cred, mm5 -> Cgreen odd  pixels
-      * mm6 -> Y even, mm7 -> Y odd
-      */
- 
-     movq_r2r (mm0, mm3);		/* mm3 = chroma_b */
-     movq_r2r (mm1, mm4);		/* mm4 = chroma_r */
-     movq_r2r (mm2, mm5);		/* mm5 = chroma_g */
-     paddsw_r2r (mm6, mm0);		/* mm0 = B6 B4 B2 B0 */
-     paddsw_r2r (mm7, mm3);		/* mm3 = B7 B5 B3 B1 */
-     paddsw_r2r (mm6, mm1);		/* mm1 = R6 R4 R2 R0 */
-     paddsw_r2r (mm7, mm4);		/* mm4 = R7 R5 R3 R1 */
-     paddsw_r2r (mm6, mm2);		/* mm2 = G6 G4 G2 G0 */
-     paddsw_r2r (mm7, mm5);		/* mm5 = G7 G5 G3 G1 */
-     packuswb_r2r (mm0, mm0);		/* saturate to 0-255 */
-     packuswb_r2r (mm1, mm1);		/* saturate to 0-255 */
-     packuswb_r2r (mm2, mm2);		/* saturate to 0-255 */
-     packuswb_r2r (mm3, mm3);		/* saturate to 0-255 */
-     packuswb_r2r (mm4, mm4);		/* saturate to 0-255 */
-     packuswb_r2r (mm5, mm5);		/* saturate to 0-255 */
-     punpcklbw_r2r (mm3, mm0);		/* mm0 = B7 B6 B5 B4 B3 B2 B1 B0 */
-     punpcklbw_r2r (mm4, mm1);		/* mm1 = R7 R6 R5 R4 R3 R2 R1 R0 */
-     punpcklbw_r2r (mm5, mm2);		/* mm2 = G7 G6 G5 G4 G3 G2 G1 G0 */
- }
- 
- void mmx_unpack_16rgb (uint8_t * image, int lines, int stride)
- {
-     static mmx_t mmx_bluemask = {0xf8f8f8f8f8f8f8f8ll};
-     static mmx_t mmx_greenmask = {0xfcfcfcfcfcfcfcfcll};
-     static mmx_t mmx_redmask = {0xf8f8f8f8f8f8f8f8ll};
- 
-     /*
-      * convert RGB plane to RGB 16 bits
-      * mm0 -> B, mm1 -> R, mm2 -> G
-      * mm4 -> GB, mm5 -> AR pixel 4-7
-      * mm6 -> GB, mm7 -> AR pixel 0-3
-      */
- 
-     pand_m2r (mmx_bluemask, mm0);       // mm0 = b7b6b5b4b3______
-     pxor_r2r (mm4, mm4);                // mm4 = 0
- 
-     pand_m2r (mmx_greenmask, mm2);      // mm2 = g7g6g5g4g3g2____
-     psrlq_i2r (3, mm0);                 // mm0 = ______b7b6b5b4b3
- 
-     movq_r2r (mm2, mm7);                // mm7 = g7g6g5g4g3g2____
-     movq_r2r (mm0, mm5);                // mm5 = ______b7b6b5b4b3
- 
-     pand_m2r (mmx_redmask, mm1);        // mm1 = r7r6r5r4r3______
-     punpcklbw_r2r (mm4, mm2);
- 
-     punpcklbw_r2r (mm1, mm0);
- 
-     psllq_i2r (3, mm2);
- 
-     punpckhbw_r2r (mm4, mm7);
-     por_r2r (mm2, mm0);
- 
-     psllq_i2r (3, mm7);
- 
- 
-     // jetzt muss ich die an bestimmten Stellen verdoppeln.
-     movntq (mm0, *(image));
- 
-     punpckhbw_r2r (mm1, mm5);
-     por_r2r (mm7, mm5);
- 
-     movntq (mm5, *(image+8));
-     while(--lines) { // write the same in the line above
-       image -= stride;
-       movntq (mm0, *(image));
-       movntq (mm5, *(image+8));
-     }
- 
- }
- 
- void mmx_unpack_15rgb (uint8_t * image, int lines, int stride)
- {
-     static mmx_t mmx_bluemask = {0xf8f8f8f8f8f8f8f8ll};
-     static mmx_t mmx_greenmask = {0xf8f8f8f8f8f8f8f8ll};
-     static mmx_t mmx_redmask = {0xf8f8f8f8f8f8f8f8ll};
- 
-     /*
-      * convert RGB plane to RGB 16 bits
-      * mm0 -> B, mm1 -> R, mm2 -> G
-      * mm4 -> GB, mm5 -> AR pixel 4-7
-      * mm6 -> GB, mm7 -> AR pixel 0-3
-      */
- 
-     pand_m2r (mmx_bluemask, mm0);       // mm0 = b7b6b5b4b3______
-     pxor_r2r (mm4, mm4);                // mm4 = 0
- 
-     pand_m2r (mmx_greenmask, mm2);      // mm2 = g7g6g5g4g3g2____
-     psrlq_i2r (2, mm0);                 // mm0 = ______b7b6b5b4b3
- 
-     movq_r2r (mm2, mm7);                // mm7 = g7g6g5g4g3g2____
-     movq_r2r (mm0, mm5);                // mm5 = ______b7b6b5b4b3
- 
-     pand_m2r (mmx_redmask, mm1);        // mm1 = r7r6r5r4r3______
-     punpcklbw_r2r (mm4, mm2);
- 
-     punpcklbw_r2r (mm1, mm0);
- 
-     psllq_i2r (3, mm2);
- 
-     punpckhbw_r2r (mm4, mm7);
-     por_r2r (mm2, mm0);
- 
-     psllq_i2r (3, mm7);
- 
-     // jetzt muss ich die an bestimmten Stellen verdoppeln.
-     psrlq_i2r(1,mm0);//MW
-     movntq (mm0, *(image));
- 
-     punpckhbw_r2r (mm1, mm5);
-     por_r2r (mm7, mm5);
- 
-     psrlq_i2r(1,mm5); //MW
-     movntq (mm5, *(image+8));
-     while(--lines) { // write the same in the line above
-       image -= stride;
-       movntq (mm0, *(image));
-       movntq (mm5, *(image+8));
-     }
- 
- }
- 
- void yuv_to_rgb (uint8_t * image, uint8_t * py,
-                  uint8_t * pu, uint8_t * pv,
-                  int width, int height,
-                  int rgb_stride, int y_stride, int uv_stride,
-                  int dstW, int dstH,
-                  int depth, unsigned char * mask, int deintMethod)
- {
- /*
-     Do the YUV->RGB transformation and scale the picture upt to dstW x dstH
-     Do NOT touch the pixels that are masked by '*mask'
-     This algo works only in 16bit mode
- */
-     uint16_t  pix[8];
-     uint8_t   *IM, *Y, *Y1, *Y2, *U, *V;
-     uint8_t   *scaleY, *scaleU, *scaleV;
-     uint8_t   *sY, *sU, *sV;
-     uint8_t   *m;
-     int       oldY = -1, dstY, lines;
- 
- //    printf("[utils] Scaling %d x %d YUV image to %d x %d %d Bit image, Pixmask %d\n",width,height,dstW,dstH,depth, mask);
-   scaleY = (uint8_t *)malloc(dstW);
-   scaleU = (uint8_t *)malloc(dstW);
-   scaleV = (uint8_t *)malloc(dstW);
- 
-   for (int y = 0; y < height; y++) {
- 
-     dstY = (y * dstH) / height;       // scaling: where to draw the line
-     IM = image + dstY * rgb_stride ;
-     Y = py + y * y_stride;
- 
-     /* ------------------------------------------------------------------------
-      * prepare pointer for deinterlacing (set them allways, deintMethod may
-      * change any time in the middle of this loop, since it is not protected
-      * by a mutex.
-      * For deinterlacing with our internal method we need previous and next line
-      */
-     Y1 = Y2 = Y;
- 
-     Y1 -= (y > 0)          ? y_stride : 0;
-     Y2 += (y < (height-1)) ? y_stride : 0;
- 
-     U = pu + (y/2) * uv_stride;
-     V = pv + (y/2) * uv_stride;
- 
-     lines = dstY - oldY;
-     oldY = dstY;
-     if (!lines) continue;
-     m=mask;
-     sY = scaleY;
-     sU = scaleU;
-     sV = scaleV;
- #ifdef VERT_SCALING
-     // maybe i find a better algo to stretch the lines
-     for (int x = 0; x < dstW; x++) {
-         int srcpix = x * width / dstW;
- 
-       if (deintMethod == 2) {
-         // deinterlace with FB-intern method
-         scaleY[x] = (Y[srcpix] / 2) + (Y1[srcpix] /4) + (Y2[srcpix] / 4);
-       } else scaleY[x] = Y[srcpix];
- 
-       if ((x < dstW / 2) && (y % 2 == 0)) {
-         scaleU[x] = U[srcpix];
-         scaleV[x] = V[srcpix];
-       }
-     }
- #else
-     sY = Y;
-     sU = U;
-     sV = V;
-     dstW = width;
- #endif
-     for (int x = 0; x < dstW; x+=8) {
-       if (!m) { // no mask given
-         mmx_yuv2rgb (sY, sU, sV);
-         mmx_unpack (IM, lines, rgb_stride);
-       } else { // mask given
-         if (*m != 0xFF) { // not all bits masked
-           mmx_yuv2rgb (sY, sU, sV);
-           if (*m == 0) { // no bit is masked
-             mmx_unpack (IM, lines, rgb_stride);
-           } else { // at least one bit is masked
-             mmx_unpack ((uint8_t *)pix, lines, rgb_stride);
-             for (int i = 0; i < 8; i++) {
-               if (! (*m & (1 << i)) ) {
-                 for (int j = 0; j < lines; j++) {
-                   *(uint16_t *)(IM - j*rgb_stride) = pix[i];
-                 }
-               }
-               IM += 2;
-             }
-             IM -= 16;
-           }
-         }
-         m++;
-       }
-       sY += 8;
-       sU += 4;
-       sV += 4;
-       IM += 16;
-     }
-     if (mask) mask += lines * rgb_stride / 16;
-   }
-   free(scaleY);
-   free(scaleU);
-   free(scaleV);
- }
- #endif // USE_MMX
  
  inline uint8_t clip( int x) {
--- 378,381 ----

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** utils.h	10 May 2007 19:49:51 -0000	1.17
--- utils.h	10 May 2007 21:57:26 -0000	1.18
***************
*** 102,112 ****
                   );
  
- void yuv_to_rgb (uint8_t * image, uint8_t * py,
-                  uint8_t * pu, uint8_t * pv,
-                  int width, int height,
-                  int rgb_stride, int y_stride, int uv_stride,
-                  int dstW, int dstH,
-                  int depth, unsigned char * mask, int deintMethod);
- 
  typedef void (*yuv420_convert_fct)(uint8_t *dst1, uint8_t *dst2, 
                  uint8_t *py1, uint8_t *py2,uint8_t *pu, uint8_t *pv,
--- 102,105 ----
***************
*** 141,149 ****
  bool  CatchRemoteKey(const char *remoteName, uint64_t key, 
                  const int ToggleKey);
- 
- void mmx_unpack_16rgb (uint8_t * image, int lines, int stride);
- void mmx_unpack_15rgb (uint8_t * image, int lines, int stride);
- void mmx_unpack_24rgb (uint8_t * image, int lines, int stride);
- extern void (*mmx_unpack)(uint8_t * image, int lines, int stride);
  
  
--- 134,137 ----

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.81
retrieving revision 1.82
diff -C2 -d -r1.81 -r1.82
*** video-dfb.c	10 May 2007 19:54:44 -0000	1.81
--- video-dfb.c	10 May 2007 21:57:26 -0000	1.82
***************
*** 1204,1208 ****
   */
  void cDFBVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                               bool &IsYUV, uint8_t *&PixelMask)
  {
    Depth=Bpp;
--- 1204,1208 ----
   */
  void cDFBVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                               bool &IsYUV)
  {
    Depth=Bpp;
***************
*** 1210,1214 ****
    AlphaInversed=isVIAUnichrome;
    IsYUV=false;
-   PixelMask=NULL;
  }
  
--- 1210,1213 ----

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** video-dfb.h	10 May 2007 19:54:44 -0000	1.27
--- video-dfb.h	10 May 2007 21:57:26 -0000	1.28
***************
*** 77,81 ****
      virtual void OpenOSD();
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                             bool &IsYUV, uint8_t *&PixelMask);
      virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                   int &xPan, int &yPan);
--- 77,81 ----
      virtual void OpenOSD();
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                             bool &IsYUV);
      virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                   int &xPan, int &yPan);

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-fb.h	10 May 2007 19:54:44 -0000	1.11
--- video-fb.h	10 May 2007 21:57:26 -0000	1.12
***************
*** 30,34 ****
    virtual ~cFBVideoOut();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV, uint8_t *&pixelmask)
    { IsYUV=true;};
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
--- 30,34 ----
    virtual ~cFBVideoOut();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
! 		  bool &IsYUV)
    { IsYUV=true;};
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,

Index: video-shm.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** video-shm.c	10 May 2007 19:54:44 -0000	1.18
--- video-shm.c	10 May 2007 21:57:26 -0000	1.19
***************
*** 192,199 ****
  
  void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                 bool &IsYUV, uint8_t *&PixelMask) {
          if ( current_osdMode==OSDMODE_SOFTWARE ) {
                  IsYUV=true;
-                 PixelMask=NULL;
                  return;
          };
--- 192,198 ----
  
  void cShmVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                 bool &IsYUV) {
          if ( current_osdMode==OSDMODE_SOFTWARE ) {
                  IsYUV=true;
                  return;
          };
***************
*** 202,206 ****
          Depth=ctl->osd_depth;
          HasAlpha=false;
-         PixelMask=NULL;
          AlphaInversed=false;
  };       
--- 201,204 ----

Index: video-shm.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-shm.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-shm.h	10 May 2007 19:54:44 -0000	1.10
--- video-shm.h	10 May 2007 21:57:26 -0000	1.11
***************
*** 50,54 ****
  
          virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                     bool &IsYUV, uint8_t *&PixelMask);
  
          virtual void YUV(sPicBuffer* buf);
--- 50,54 ----
  
          virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                     bool &IsYUV);
  
          virtual void YUV(sPicBuffer* buf);

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** video-vidix.c	10 May 2007 19:54:44 -0000	1.26
--- video-vidix.c	10 May 2007 21:57:26 -0000	1.27
***************
*** 783,787 ****
   */
  void cVidixVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                               bool &IsYUV, uint8_t *&PixelMask)
  {
    Depth         = Bpp;
--- 783,787 ----
   */
  void cVidixVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                               bool &IsYUV)
  {
    Depth         = Bpp;
***************
*** 789,793 ****
    AlphaInversed = false;
    IsYUV         = (current_osdMode == OSDMODE_SOFTWARE);
-   PixelMask     = NULL;
  }
  
--- 789,792 ----

Index: video-vidix.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.h,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** video-vidix.h	10 May 2007 19:54:44 -0000	1.13
--- video-vidix.h	10 May 2007 21:57:26 -0000	1.14
***************
*** 53,58 ****
                            bool &HasAlpha,
                            bool &AlphaInversed,
! 		                      bool &IsYUV,
! 		                      uint8_t *&PixelMask);
    virtual void GetLockOsdSurface(uint8_t *&osd,
                                   int &stride,
--- 53,57 ----
                            bool &HasAlpha,
                            bool &AlphaInversed,
! 		                      bool &IsYUV);
    virtual void GetLockOsdSurface(uint8_t *&osd,
                                   int &stride,

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.70
retrieving revision 1.71
diff -C2 -d -r1.70 -r1.71
*** video-xv.c	10 May 2007 19:54:44 -0000	1.70
--- video-xv.c	10 May 2007 21:57:26 -0000	1.71
***************
*** 1662,1669 ****
   */
  void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                   bool &IsYUV, uint8_t *&PixelMask) {
          if (current_osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
-                 PixelMask=NULL;
                  return;
          };
--- 1662,1668 ----
   */
  void cXvVideoOut::GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                   bool &IsYUV) {
          if (current_osdMode==OSDMODE_SOFTWARE) {
                  IsYUV=true;
                  return;
          };
***************
*** 1672,1676 ****
          Depth=osd_image->bits_per_pixel;
          HasAlpha=false;
-         PixelMask=NULL;
  };
  
--- 1671,1674 ----

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.27
retrieving revision 1.28
diff -C2 -d -r1.27 -r1.28
*** video-xv.h	10 May 2007 19:54:44 -0000	1.27
--- video-xv.h	10 May 2007 21:57:26 -0000	1.28
***************
*** 184,188 ****
                                 int &xPan, int &yPan);
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                   bool &IsYUV, uint8_t *&PixelMask);
    virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
                    bool *&dirtyLines);
--- 184,188 ----
                                 int &xPan, int &yPan);
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                   bool &IsYUV);
    virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
                    bool *&dirtyLines);

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.53
retrieving revision 1.54
diff -C2 -d -r1.53 -r1.54
*** video.h	10 May 2007 19:54:44 -0000	1.53
--- video.h	10 May 2007 21:57:26 -0000	1.54
***************
*** 232,238 ****
  
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                     bool &IsYUV, uint8_t *&PixelMask)
!     { Depth=32; HasAlpha=true; AlphaInversed=false; IsYUV=false;
!             PixelMask=NULL;};
      // should be implemented by all video out method to set the OSD pixel mode
  
--- 232,237 ----
  
      virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
!                     bool &IsYUV)
!     { Depth=32; HasAlpha=true; AlphaInversed=false; IsYUV=false; };
      // should be implemented by all video out method to set the OSD pixel mode
  



From nobody at sheep.berlios.de  Fri May 11 00:05:11 2007
From: nobody at sheep.berlios.de (wachm)
Date: Fri, 11 May 2007 00:05:11 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.313, 1.314 VideoFilter.c,
	1.5, 1.6 VideoFilter.h, 1.2, 1.3 configure, 1.41, 1.42
Message-ID: <20070510220511.6F026EFF1A@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv28407

Modified Files:
	CHANGELOG VideoFilter.c VideoFilter.h configure 
Log Message:
- use libswscale if available.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.313
retrieving revision 1.314
diff -C2 -d -r1.313 -r1.314
*** CHANGELOG	10 May 2007 21:57:26 -0000	1.313
--- CHANGELOG	10 May 2007 22:03:03 -0000	1.314
***************
*** 1,4 ****
--- 1,5 ----
  Changelog
  2007-05-10:
+    - use libswscale if available.
     - remove left over code from the old video-fb.
     - remove pixel mask option from SoftOsd.[hc] and video*, which was only used

Index: VideoFilter.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.c,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** VideoFilter.c	10 May 2007 19:49:51 -0000	1.5
--- VideoFilter.c	10 May 2007 22:03:03 -0000	1.6
***************
*** 201,205 ****
  
  cImageConvert::cImageConvert(cVideoOut *vOut) 
!         : cVideoFilter(vOut), outBuf(NULL) {
  };
  
--- 201,210 ----
  
  cImageConvert::cImageConvert(cVideoOut *vOut) 
!         : cVideoFilter(vOut), outBuf(NULL)
! #ifdef USE_SWSCALE
!           , img_convert_ctx(NULL), ctx_width(0),
!           ctx_height(0), ctx_fmt(0)
! #endif
! {
  };
  
***************
*** 226,234 ****
                  dest->width = orig->width;
                  dest->height = orig->height;
-                 dest->pts=orig->pts;
                  dest->edge_width=dest->edge_height=0;
-                 dest->dtg_active_format=orig->dtg_active_format;
-                 dest->aspect_ratio=orig->aspect_ratio;
-                 dest->interlaced_frame=orig->interlaced_frame;
          };
          dest=outBuf;
--- 231,235 ----
***************
*** 239,243 ****
--- 240,266 ----
                  return;
          }
+ #ifdef USE_SWSCALE
+         if ( ctx_width != orig->width || ctx_height != orig->height
+                || ctx_fmt != orig->format ) {
+                 free(img_convert_ctx);
+                 img_convert_ctx=NULL;
+         };
  
+         if (!img_convert_ctx) {
+                 img_convert_ctx = sws_getContext(orig->width, orig->height,
+                                 PIX_FMT_YUV420P,
+                                 orig->width, orig->height,
+                                 orig->format,
+                                 SWS_BICUBIC, NULL, NULL, NULL);
+                 if (!img_convert_ctx) {
+                         fprintf(stderr,"[softdevice] could not get SWScaler context. No image converting!\n");
+                         dest=orig;
+                         return;
+                 };
+                 ctx_width=orig->width;
+                 ctx_height=orig->height;
+                 ctx_fmt=orig->format;
+         };
+ #endif
          int h_shift;
          int v_shift;
***************
*** 261,264 ****
--- 284,291 ----
          memcpy(avpic_dest.linesize,dest->stride,sizeof(avpic_dest.linesize));
  
+ #ifdef USE_SWSCALE
+        sws_scale(img_convert_ctx, avpic_src.data, avpic_src.linesize,
+                         0, orig->height, avpic_dest.data, avpic_dest.linesize);
+ #else
          if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
                                  &avpic_src, orig->format,
***************
*** 269,273 ****
                  return;
          }
!     CopyPicBufferContext(dest,orig);
  }
  
--- 296,301 ----
                  return;
          }
! #endif
!         CopyPicBufferContext(dest,orig);
  }
  

Index: VideoFilter.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/VideoFilter.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** VideoFilter.h	3 Apr 2007 19:06:17 -0000	1.2
--- VideoFilter.h	10 May 2007 22:03:03 -0000	1.3
***************
*** 60,65 ****
--- 60,74 ----
  };
  
+ #ifdef USE_SWSCALE
+ #include <swscale.h>
+ #endif
  class cImageConvert : public cVideoFilter {
          sPicBuffer *outBuf;
+ #ifdef USE_SWSCALE
+         struct SwsContext *img_convert_ctx;
+         int ctx_width;
+         int ctx_height;
+         int ctx_fmt;
+ #endif
  public:
          cImageConvert(cVideoOut *VideoOut);

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** configure	12 Apr 2007 08:01:25 -0000	1.41
--- configure	10 May 2007 22:03:03 -0000	1.42
***************
*** 25,28 ****
--- 25,29 ----
  use_pkgconfig="yes"
  ffmpeg="yes"
+ libswscale="no"
  ffmpeg_use_path="no"
  dfb="yes"
***************
*** 239,242 ****
--- 240,299 ----
  echo "Ok."
  
+ ####################################################################################
+ echo -n "Checking for ffmpeg/libswscale... "
+ echo  "Checking for ffmpeg/libswscale.------------------------------------" >> config.log
+ 
+ test_swscale()
+ {
+   swscale="yes";
+ cat > ${TMPC} << EOF
+ #define __STDC_CONSTANT_MACROS
+ #include <stdlib.h>
+ #include <avcodec.h>
+ #include <avformat.h>
+ #include <swscale.h>
+ int main(void) {
+ /*  if ( avcodec_build() != LIBAVCODEC_BUILD ) {
+      fprintf(stderr,"Fatal Error! Libavcodec library build(%d) doesn't match avcodec.h build(%d)!!!\n",avcodec_build(),LIBAVCODEC_BUILD);
+      fprintf(stderr,"Check your ffmpeg installation / the pathes in the Makefile!!!\n");
+      exit(-1);
+   };
+ */
+   avcodec_init();
+   avcodec_register_all();
+   struct SwsContext *img_convert_ctx = sws_getContext(120, 120,
+                                 PIX_FMT_YUV420P,
+                                 100, 100,
+                                 PIX_FMT_YUV420P,
+                                 SWS_BICUBIC, NULL, NULL, NULL);
+ 
+  return 0;
+ }
+ EOF
+   $cc $CFLAGS $ffmpeg_cflags $swscale_cflags -o $TMPE $TMPC $swscale_libs $ffmpeg_libs >> config.log 2>&1 || swscale="no"
+ };
+ 
+ swscale_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libswscale 2>> config.log` || libswscale="no"
+ swscale_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libswscale 2>> config.log`
+ 
+ #test if it works
+ test_swscale
+ 
+ if test "${swscale}" = "no" ; then
+   echo "pkg-config failed, try the default/parameter path." >> config.log
+   swscale_libs="-L${ffmpeg_path}/libswscale/ -lswscale -lz"
+   swscale_cflags="-I${ffmpeg_path}/libswscale/ "
+ 
+   test_swscale
+ fi
+ 
+ if test "${swscale}" = "yes" ; then
+ echo "Using libswscale."
+ else
+ echo "Not Found."
+ swscale_libs=""
+ swscale_cflags=""
+ fi
+ 
  ########################################################
  # check for ALSA
***************
*** 731,735 ****
  
  ###############################################################################
! # generating ffmpeg specific defines
  #
  if test "${libpostproc}" = "yes" ; then
--- 788,792 ----
  
  ###############################################################################
! # generating ffmpeg and libswscale specific defines
  #
  if test "${libpostproc}" = "yes" ; then
***************
*** 739,744 ****
  fi
  
! echo "FFMPEGLIBS = ${ffmpeg_libs}" >> $TMPM
! echo "FFMPEGCFLAGS = ${ffmpeg_cflags}" >> $TMPM
  
  ###############################################################################
--- 796,805 ----
  fi
  
! if test "${swscale}" = "yes"; then
!   echo "#define USE_SWSCALE" >> $TMPH
! fi
! 
! echo "FFMPEGLIBS = ${swscale_libs} ${ffmpeg_libs}" >> $TMPM
! echo "FFMPEGCFLAGS = ${swscale_cflags} ${ffmpeg_cflags}" >> $TMPM
  
  ###############################################################################



