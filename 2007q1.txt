From nobody at sheep.berlios.de  Mon Jan 15 20:36:32 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Jan 2007 20:36:32 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.281, 1.282 utils.c, 1.24,
	1.25 utils.h, 1.15, 1.16 PicBuffer.c, 1.17, 1.18
Message-ID: <20070115193632.3229FCFF16@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23990

Modified Files:
	CHANGELOG utils.c utils.h PicBuffer.c 
Log Message:
- introduce yuv420_to_rgb15() (mmx acceleration still missing).


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.281
retrieving revision 1.282
diff -C2 -d -r1.281 -r1.282
*** CHANGELOG	17 Dec 2006 22:50:10 -0000	1.281
--- CHANGELOG	15 Jan 2007 19:35:13 -0000	1.282
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2007-01-15:
+    - introduce yuv420_to_rgb15() (mmx acceleration still missing).
  2006-12-17:
     - Silence some warnings with gcc 4.1.1.

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** utils.c	17 Dec 2006 22:50:10 -0000	1.24
--- utils.c	15 Jan 2007 19:35:13 -0000	1.25
***************
*** 1123,1126 ****
--- 1123,1137 ----
  };
  
+ void yuv420_to_rgb15(uint8_t *dst1, uint8_t *dst2,
+                  uint8_t *py1, uint8_t *py2, uint8_t *pu, uint8_t *pv, 
+                  int pixel)
+ {
+   pixel/=2;
+   while (pixel) {
+     YUV420P_TO_RGB(RGB15);  
+     pixel--;
+   };
+ };
+ 
  void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
            uint8_t *alpha,uint16_t count) {

Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** utils.h	17 Dec 2006 22:39:52 -0000	1.15
--- utils.h	15 Jan 2007 19:35:13 -0000	1.16
***************
*** 129,132 ****
--- 129,136 ----
                   int pixel);
  
+ void yuv420_to_rgb15(uint8_t *dst1, uint8_t *dst2,
+                  uint8_t *py1, uint8_t *py2, uint8_t *pu, uint8_t *pv, 
+                  int pixel);
+ 
  void AlphaBlend(uint8_t *dest,uint8_t *P1,uint8_t *P2,
         uint8_t *alpha,uint16_t count);
***************
*** 179,183 ****
  #define WRITE_RGB15(dst,r,g,b) \
          do { \
!             ((uint8_t *)dst)[0]=(((b) >> 3)& 0x1F) | (((g) & 0x1F) << 3); \
              ((uint8_t *)dst)[1]=(((r) & 0xF8)>>1) | ((g) >> 6); \
          } while (0)
--- 183,187 ----
  #define WRITE_RGB15(dst,r,g,b) \
          do { \
!             ((uint8_t *)dst)[0]=(((b) >> 3)& 0x1F) | (((g) & 0x38) << 2); \
              ((uint8_t *)dst)[1]=(((r) & 0xF8)>>1) | ((g) >> 6); \
          } while (0)

Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** PicBuffer.c	14 Dec 2006 22:34:30 -0000	1.17
--- PicBuffer.c	15 Jan 2007 19:35:13 -0000	1.18
***************
*** 147,150 ****
--- 147,151 ----
                          return &yuv420_to_rgb24;
                  case PIX_FMT_RGB555:
+                         return &yuv420_to_rgb15;
                  case PIX_FMT_RGB565:
                          return &yuv420_to_rgb16;



From nobody at sheep.berlios.de  Mon Jan 15 20:38:31 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Jan 2007 20:38:31 +0100 (CET)
Subject: [Softdevice-cvs] softdevice ShmClient.c, 1.20, 1.21 CHANGELOG, 1.282,
	1.283
Message-ID: <20070115193831.AD9C8D4BFE@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24245

Modified Files:
	ShmClient.c CHANGELOG 
Log Message:
- properly start cShmRemote thread in ShmClient.


Index: ShmClient.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/ShmClient.c,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** ShmClient.c	26 Nov 2006 19:00:17 -0000	1.20
--- ShmClient.c	15 Jan 2007 19:37:08 -0000	1.21
***************
*** 33,37 ****
  };
  
! class cShmRemote : public cSoftRemote, cThread {
          protected:
                  bool running;
--- 33,37 ----
  };
  
! class cShmRemote : public cSoftRemote, public cThread {
          protected:
                  bool running;
***************
*** 223,226 ****
--- 223,227 ----
          // wakeup remote thread to unsuspend video/audio
          sem_sig_unlock(ctl->semid,KEY_SIG);
+         (dynamic_cast<cShmRemote*>(xvRemote))->Start();
  
          while (active) {

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.282
retrieving revision 1.283
diff -C2 -d -r1.282 -r1.283
*** CHANGELOG	15 Jan 2007 19:35:13 -0000	1.282
--- CHANGELOG	15 Jan 2007 19:37:08 -0000	1.283
***************
*** 2,5 ****
--- 2,6 ----
  2007-01-15:
     - introduce yuv420_to_rgb15() (mmx acceleration still missing).
+    - properly start cShmRemote thread in ShmClient.
  2006-12-17:
     - Silence some warnings with gcc 4.1.1.



From nobody at sheep.berlios.de  Mon Jan 15 21:26:57 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Jan 2007 21:26:57 +0100 (CET)
Subject: [Softdevice-cvs] softdevice xscreensaver.c, 1.6, 1.7 CHANGELOG,
	1.283, 1.284
Message-ID: <20070115202657.D08ADD2EF6@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30640

Modified Files:
	xscreensaver.c CHANGELOG 
Log Message:
- avoid "BadWindow" errors by using an errror handler. Also fix 
  "BadWindow" errors which occur after the xscreensaver has once been 
  active.



Index: xscreensaver.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/xscreensaver.c,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** xscreensaver.c	14 Dec 2006 22:36:32 -0000	1.6
--- xscreensaver.c	15 Jan 2007 20:25:39 -0000	1.7
***************
*** 84,87 ****
--- 84,90 ----
    this->disabled = disable;
  
+   if ( disable )
+           window = FindWindow();
+ 
  #ifdef LIBXDPMS_SUPPORT
    if ((DPMSQueryExtension(dpy, &dpms_dummy, &dpms_dummy)) && (DPMSCapable(dpy))) {
***************
*** 118,121 ****
--- 121,127 ----
        lastKeyEvent = current.tv_sec;
  
+       // set error handler
+       old_handler = XSetErrorHandler(BadWindow_ehandler);
+ 
        //dsyslog("[softdevice-xscreensaver]: faking left shift pushing\n");
        XKeyEvent keyEvent;
***************
*** 133,137 ****
        keyEvent.keycode = XKeysymToKeycode(this->dpy, XK_Shift_L);
  
!       if (!XSendEvent (dpy, window, True, KeyPressMask, (XEvent *)&keyEvent)) {
          esyslog("[softdevice-xscreensaver]: failed to send left shift key event\n");
          return;
--- 139,144 ----
        keyEvent.keycode = XKeysymToKeycode(this->dpy, XK_Shift_L);
  
!       if (!XSendEvent (dpy, RootWindowOfScreen( DefaultScreenOfDisplay( dpy )),
!                        True, KeyPressMask, (XEvent *)&keyEvent)) {
          esyslog("[softdevice-xscreensaver]: failed to send left shift key event\n");
          return;
***************
*** 141,149 ****
        keyEvent.type = KeyRelease;
  
!       if (!XSendEvent (dpy, window, True, KeyPressMask, (XEvent *)&keyEvent)) {
          esyslog("[softdevice-xscreensaver]: failed to send left shift released key event\n");
          return;
        }
        XSync (dpy, 0);
      }
    }
--- 148,161 ----
        keyEvent.type = KeyRelease;
  
!       if (!XSendEvent (dpy, RootWindowOfScreen( DefaultScreenOfDisplay( dpy )),
!                        True, KeyPressMask, (XEvent *)&keyEvent)) {
          esyslog("[softdevice-xscreensaver]: failed to send left shift released key event\n");
          return;
        }
        XSync (dpy, 0);
+ 
+       // restore default error handler
+       XSetErrorHandler(old_handler);
+       old_handler = 0;
      }
    }
***************
*** 159,162 ****
--- 171,177 ----
        //dsyslog("[softdevice-xscreensaver]: sending xscreensaver deactivation command DPMS\n");
  
+       // set error handler
+       old_handler = XSetErrorHandler(BadWindow_ehandler);
+ 
        XEvent event;
        event.xany.type = ClientMessage;
***************
*** 172,175 ****
--- 187,193 ----
        }
        XSync (dpy, 0);
+       
+       // restore error handler
+       XSetErrorHandler(old_handler);
      }
    }

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.283
retrieving revision 1.284
diff -C2 -d -r1.283 -r1.284
*** CHANGELOG	15 Jan 2007 19:37:08 -0000	1.283
--- CHANGELOG	15 Jan 2007 20:25:39 -0000	1.284
***************
*** 3,6 ****
--- 3,9 ----
     - introduce yuv420_to_rgb15() (mmx acceleration still missing).
     - properly start cShmRemote thread in ShmClient.
+    - avoid "BadWindow" errors by using an errror handler. Also fix 
+      "BadWindow" errors which occur after the xscreensaver has once been 
+      active.
  2006-12-17:
     - Silence some warnings with gcc 4.1.1.



From nobody at sheep.berlios.de  Mon Jan 15 21:31:36 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 15 Jan 2007 21:31:36 +0100 (CET)
Subject: [Softdevice-cvs] softdevice video.c, 1.71, 1.72 CHANGELOG, 1.284,
	1.285
Message-ID: <20070115203136.69E50D25D8@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31070

Modified Files:
	video.c CHANGELOG 
Log Message:
- fix vidWin for non zero VidX1 and VidY1.


Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.71
retrieving revision 1.72
diff -C2 -d -r1.71 -r1.72
*** video.c	3 Dec 2006 19:32:59 -0000	1.71
--- video.c	15 Jan 2007 20:30:08 -0000	1.72
***************
*** 444,448 ****
                                    pic->width, pic->height,
                                    vidX1, vidY1,
!                                   vidX2, vidY2,
                                    0,0,0,0);
            CopyPicBufferContext(scale_pic,pic);
--- 444,448 ----
                                    pic->width, pic->height,
                                    vidX1, vidY1,
!                                   vidX2-vidX1, vidY2-vidY1,
                                    0,0,0,0);
            CopyPicBufferContext(scale_pic,pic);

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.284
retrieving revision 1.285
diff -C2 -d -r1.284 -r1.285
*** CHANGELOG	15 Jan 2007 20:25:39 -0000	1.284
--- CHANGELOG	15 Jan 2007 20:30:08 -0000	1.285
***************
*** 6,9 ****
--- 6,10 ----
       "BadWindow" errors which occur after the xscreensaver has once been 
       active.
+    - fix vidWin for non zero VidX1 and VidY1.
  2006-12-17:
     - Silence some warnings with gcc 4.1.1.



From nobody at sheep.berlios.de  Sat Jan 20 14:38:00 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 20 Jan 2007 14:38:00 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.285, 1.286 video-dfb.c,
	1.75, 1.76
Message-ID: <20070120133800.6BE9BD7640@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv29581

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
Fixed video-dfb for VIA-unichrome with current DirectFB cvs. In directfbrc pixelformat=AiRGB must be specified.

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.285
retrieving revision 1.286
diff -C2 -d -r1.285 -r1.286
*** CHANGELOG	15 Jan 2007 20:30:08 -0000	1.285
--- CHANGELOG	20 Jan 2007 13:36:39 -0000	1.286
***************
*** 1,10 ****
  Changelog
  2007-01-15:
     - introduce yuv420_to_rgb15() (mmx acceleration still missing).
!    - properly start cShmRemote thread in ShmClient.
!    - avoid "BadWindow" errors by using an errror handler. Also fix 
!      "BadWindow" errors which occur after the xscreensaver has once been 
!      active.
!    - fix vidWin for non zero VidX1 and VidY1.
  2006-12-17:
     - Silence some warnings with gcc 4.1.1.
--- 1,13 ----
  Changelog
+ 2007-01-20:
+    - Fixed video-dfb for VIA-unichrome with current DirectFB cvs. In directfbrc
+      pixelformat=AiRGB must be specified.
  2007-01-15:
     - introduce yuv420_to_rgb15() (mmx acceleration still missing).
!    - properly start cShmRemote thread in ShmClient.
!    - avoid "BadWindow" errors by using an errror handler. Also fix
!      "BadWindow" errors which occur after the xscreensaver has once been
!      active.
!    - fix vidWin for non zero VidX1 and VidY1.
  2006-12-17:
     - Silence some warnings with gcc 4.1.1.

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.75
retrieving revision 1.76
diff -C2 -d -r1.75 -r1.76
*** video-dfb.c	17 Dec 2006 22:39:52 -0000	1.75
--- video-dfb.c	20 Jan 2007 13:36:39 -0000	1.76
***************
*** 423,427 ****
        Bpp = DFB_BITS_PER_PIXEL(fmt);
  
!       /* ------------------------------------------------------------------------
         * clear screen surface at startup
         */
--- 423,433 ----
        Bpp = DFB_BITS_PER_PIXEL(fmt);
  
!       /* ---------------------------------------------------------------------
!        * In case of of AiRGB we have to reset clearAlpha value for VIA
!        */
!       if (fmt == DSPF_AiRGB && isVIAUnichrome)
!         clearAlpha = 0;
! 
!       /* ---------------------------------------------------------------------
         * clear screen surface at startup
         */



From nobody at sheep.berlios.de  Sat Jan 27 10:52:21 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 27 Jan 2007 10:52:21 +0100 (CET)
Subject: [Softdevice-cvs] softdevice video-dfb.c,1.76,1.77
Message-ID: <20070127095221.D5D2DD6CBF@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27958

Modified Files:
	video-dfb.c 
Log Message:
video-dfb: - Limit VIA-unichrome name compare to 19 chars.
           - Detect a patched DirectFB version for VIA CN700 support,
             and set some parameters for video layer V3:
               pixelformat YUY2, NO hardware decoding support .



Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.76
retrieving revision 1.77
diff -C2 -d -r1.76 -r1.77
*** video-dfb.c	20 Jan 2007 13:36:39 -0000	1.76
--- video-dfb.c	27 Jan 2007 09:50:58 -0000	1.77
***************
*** 359,370 ****
       * check for VIA Unichrome presence
       */
!     if (!strcmp (videoLayerDescription.name, "VIA Unichrome Video"))
      {
        isVIAUnichrome = true;
        clearAlpha = 0xff;
  #ifdef HAVE_CLE266_MPEG_DECODER
!       if (setupStore->cle266HWdecode) {
            if (!SetupCle266Buffers(swidth, sheight)) {
!               fprintf(stderr, "Error allocating hardware buffers for CLE266 decoding: reverting to software decoding\n");
                setupStore->cle266HWdecode = false;
            } else {
--- 359,389 ----
       * check for VIA Unichrome presence
       */
!     if (!strncmp (videoLayerDescription.name, "VIA Unichrome Video", 19))
      {
        isVIAUnichrome = true;
        clearAlpha = 0xff;
+       if (!strcmp (videoLayerDescription.name, "VIA Unichrome Video 3")) {
+         /* -------------------------------------------------------------------
+          * DirectFB patched for CN700 support: restrict pixelformat to YUY2,
+          * and disable hardware decoding support.
+          * I420 == 0, YV12 == 1, YUY2 == 2
+          */
  #ifdef HAVE_CLE266_MPEG_DECODER
!         setupStore->cle266HWdecode = false;
!         fprintf(stderr,
!                 "[dfb] disabling hw-decode support for this layer\n");
! #endif
!         currentPixelFormat = setupStore->pixelFormat = 2;
!         setupStore->pixelFormatLocked = true;
!         setupStore->useStretchBlit = 0;
!         setupStore->stretchBlitLocked = true;
!         useStretchBlit = false;
!       }
! #ifdef HAVE_CLE266_MPEG_DECODER
!       else if (setupStore->cle266HWdecode) {
            if (!SetupCle266Buffers(swidth, sheight)) {
!               fprintf(stderr,
!                       "[dfb] Error allocating hardware buffers for "
!                       "CLE266 decoding: reverting to software decoding\n");
                setupStore->cle266HWdecode = false;
            } else {
***************
*** 424,430 ****
  
        /* ---------------------------------------------------------------------
!        * In case of of AiRGB we have to reset clearAlpha value for VIA
         */
!       if (fmt == DSPF_AiRGB && isVIAUnichrome)
          clearAlpha = 0;
  
--- 443,449 ----
  
        /* ---------------------------------------------------------------------
!        * In case of of AiRGB we have to reset clearAlpha value
         */
!       if (fmt == DSPF_AiRGB)
          clearAlpha = 0;
  
***************
*** 432,438 ****
         * clear screen surface at startup
         */
!       scrSurface->Clear(0,0,0,0);
        scrSurface->Flip();
!       scrSurface->Clear(0,0,0,0);
  
        osdDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 451,457 ----
         * clear screen surface at startup
         */
!       scrSurface->Clear(0,0,0,clearAlpha);
        scrSurface->Flip();
!       scrSurface->Clear(0,0,0,clearAlpha);
  
        osdDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |



From nobody at sheep.berlios.de  Sat Jan 27 13:48:09 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 27 Jan 2007 13:48:09 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.286,1.287
Message-ID: <20070127124809.E27AACEFA7@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15109

Modified Files:
	CHANGELOG 
Log Message:
doc. last change

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.286
retrieving revision 1.287
diff -C2 -d -r1.286 -r1.287
*** CHANGELOG	20 Jan 2007 13:36:39 -0000	1.286
--- CHANGELOG	27 Jan 2007 12:46:46 -0000	1.287
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2007-01-27:
+    - video-dfb: - Limit VIA-unichrome name compare to 19 chars.
+                 - Detect a patched DirectFB version for VIA CN700 support,
+                   and set some parameters for video layer V3:
+                     pixelformat YUY2, NO hardware decoding support .
  2007-01-20:
     - Fixed video-dfb for VIA-unichrome with current DirectFB cvs. In directfbrc



From nobody at sheep.berlios.de  Sun Jan 28 20:29:34 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 28 Jan 2007 20:29:34 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.287, 1.288 video.h, 1.49,
	1.50
Message-ID: <20070128192934.07D2DD9543@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7290

Modified Files:
	CHANGELOG video.h 
Log Message:
 - don't lock NULL pictures in cVideo::GetLockLastPic().


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.287
retrieving revision 1.288
diff -C2 -d -r1.287 -r1.288
*** CHANGELOG	27 Jan 2007 12:46:46 -0000	1.287
--- CHANGELOG	28 Jan 2007 19:28:11 -0000	1.288
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2007-01-28:
+    - don't lock NULL pictures in cVideo::GetLockLastPic().
  2007-01-27:
     - video-dfb: - Limit VIA-unichrome name compare to 19 chars.

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** video.h	3 Dec 2006 19:32:59 -0000	1.49
--- video.h	28 Jan 2007 19:28:11 -0000	1.50
***************
*** 157,161 ****
              oldPictureMutex.Lock();
              pic=oldPicture;
!             LockBuffer(oldPicture);
              oldPictureMutex.Unlock();
      };
--- 157,162 ----
              oldPictureMutex.Lock();
              pic=oldPicture;
!             if (oldPicture)
! 		LockBuffer(oldPicture);
              oldPictureMutex.Unlock();
      };



From nobody at sheep.berlios.de  Sun Jan 28 20:31:16 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 28 Jan 2007 20:31:16 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.288, 1.289 mpeg2decoder.c,
	1.70, 1.71
Message-ID: <20070128193116.D9F76BEC66@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7425

Modified Files:
	CHANGELOG mpeg2decoder.c 
Log Message:
- implement avcodec_decode_audio2() interface to libavcodec.
- set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.288
retrieving revision 1.289
diff -C2 -d -r1.288 -r1.289
*** CHANGELOG	28 Jan 2007 19:28:11 -0000	1.288
--- CHANGELOG	28 Jan 2007 19:29:53 -0000	1.289
***************
*** 2,5 ****
--- 2,7 ----
  2007-01-28:
     - don't lock NULL pictures in cVideo::GetLockLastPic().
+    - implement avcodec_decode_audio2() interface to libavcodec.
+    - set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.
  2007-01-27:
     - video-dfb: - Limit VIA-unichrome name compare to 19 chars.

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.70
retrieving revision 1.71
diff -C2 -d -r1.70 -r1.71
*** mpeg2decoder.c	7 Nov 2006 19:01:37 -0000	1.70
--- mpeg2decoder.c	28 Jan 2007 19:29:53 -0000	1.71
***************
*** 427,432 ****
--- 427,438 ----
    while ( size > 0 && active ) {
      BUFDEB("start decode audio. pkt size: %d \n",size);
+ #if LIBAVCODEC_VERSION_INT >= ((51<<16)+(29<<8)+0)
+     audio_size=AVCODEC_MAX_AUDIO_FRAME_SIZE;
+     len=avcodec_decode_audio2(context, (short *)audiosamples,
+                  &audio_size, data, size);
+ #else
      len=avcodec_decode_audio(context, (short *)audiosamples,
                   &audio_size, data, size);
+ #endif
      BUFDEB("end decode audio\n");
      if (len < 0) {
***************
*** 1122,1125 ****
--- 1128,1132 ----
         read_packet_RingBuffer,NULL,seek_RingBuffer);
     ic->pb.buf_end=NULL;
+    ic->pb.is_streamed=true;
     CMDDEB("init put byte finished\n");
  };



From nobody at sheep.berlios.de  Sun Jan 28 20:32:44 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 28 Jan 2007 20:32:44 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.289, 1.290 configure, 1.32,
	1.33
Message-ID: <20070128193244.9B853D99B5@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7611

Modified Files:
	CHANGELOG configure 
Log Message:
- add architecture "x86_64" to configure and report unsupported 
  architectures


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.289
retrieving revision 1.290
diff -C2 -d -r1.289 -r1.290
*** CHANGELOG	28 Jan 2007 19:29:53 -0000	1.289
--- CHANGELOG	28 Jan 2007 19:31:15 -0000	1.290
***************
*** 4,7 ****
--- 4,9 ----
     - implement avcodec_decode_audio2() interface to libavcodec.
     - set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.
+    - add architecture "x86_64" to configure and report unsupported 
+      architectures
  2007-01-27:
     - video-dfb: - Limit VIA-unichrome name compare to 19 chars.

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** configure	3 Dec 2006 20:38:18 -0000	1.32
--- configure	28 Jan 2007 19:31:15 -0000	1.33
***************
*** 115,119 ****
  cpu_arch=`uname -m`
  case "$cpu_arch" in
!   i[3-6]86*) 
          cpu_arch="i386"
          ;;
--- 115,119 ----
  cpu_arch=`uname -m`
  case "$cpu_arch" in
!   i[3-6]86*|x86_64) 
          cpu_arch="i386"
          ;;
***************
*** 124,128 ****
          with_altivec="yes"
          ;;
!   *) 
          cpu_arch="unknown"
          with_mmx="no" 
--- 124,129 ----
          with_altivec="yes"
          ;;
!   *)
! 	echo "'$cpu_arch' is unknown..." 
          cpu_arch="unknown"
          with_mmx="no" 



From nobody at sheep.berlios.de  Sun Jan 28 20:38:14 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 28 Jan 2007 20:38:14 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.290, 1.291 SoftOsd.c, 1.25,
	1.26 SoftOsd.h, 1.11, 1.12
Message-ID: <20070128193814.D4F10CE95D@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8012

Modified Files:
	CHANGELOG SoftOsd.c SoftOsd.h 
Log Message:
- add StealToBitmap() for OSD in grabbed image.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.290
retrieving revision 1.291
diff -C2 -d -r1.290 -r1.291
*** CHANGELOG	28 Jan 2007 19:31:15 -0000	1.290
--- CHANGELOG	28 Jan 2007 19:36:50 -0000	1.291
***************
*** 5,9 ****
     - set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.
     - add architecture "x86_64" to configure and report unsupported 
!      architectures
  2007-01-27:
     - video-dfb: - Limit VIA-unichrome name compare to 19 chars.
--- 5,10 ----
     - set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.
     - add architecture "x86_64" to configure and report unsupported 
!      architectures.
!    - add StealToBitmap() for OSD in grabbed image.
  2007-01-27:
     - video-dfb: - Limit VIA-unichrome name compare to 19 chars.

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** SoftOsd.c	3 Dec 2006 19:55:15 -0000	1.25
--- SoftOsd.c	28 Jan 2007 19:36:50 -0000	1.26
***************
*** 959,962 ****
--- 959,1068 ----
  };
  
+ #define SCALEH_IDX(x) ((scaleH_strtIdx+(x))%lines_count)
+ void cSoftOsd::StealToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
+                     uint8_t *PAlphaY,uint8_t *PAlphaUV,
+                     int Ystride, int UVstride,
+                     int dest_Width, int dest_Height) {
+         OSDDEB("StealToBitmap YUV no Vscale\n");
+ 
+         // upscaling is not supported for YUV modes
+         if (dest_Width>OSD_WIDTH)
+                 dest_Width=OSD_WIDTH;
+         if (dest_Height>OSD_HEIGHT)
+                 dest_Height=OSD_HEIGHT;
+ 
+         color *pixmap=(color*) OSD_Bitmap;
+         color tmp_pixmap[2*OSD_STRIDE];
+         uint8_t *pY;uint8_t *pU;uint8_t *pV;
+         uint8_t *pAlphaY; uint8_t *pAlphaUV;
+ 
+         //printf("Scale to %d,%d\n",dest_Width,dest_Height);
+         const int ScaleFactor=1<<6;
+         uint32_t new_pixel_height=(OSD_HEIGHT*ScaleFactor)/dest_Height;
+         int lines_count=(new_pixel_height/ScaleFactor*2+4);
+         color scaleH_pixmap[lines_count*OSD_STRIDE];
+         color *scaleH_Reference[lines_count];
+         int scaleH_lines[lines_count];
+         int scaleH_strtIdx=0;
+         memset(scaleH_lines,-1,sizeof(scaleH_lines));
+         memset(scaleH_Reference,0,sizeof(scaleH_Reference));
+         OSDDEB("new_pixel_height %d lines_count %d\n",
+                         new_pixel_height,lines_count);
+ 
+         for (int y=0; y<dest_Height; y+=2) {
+                 int start_row=new_pixel_height*y/ScaleFactor;
+                 int32_t start_pos=new_pixel_height*y%ScaleFactor-ScaleFactor;
+                 //int32_t start_pos=new_pixel_height*y-ScaleFactor*(start_row+1);
+ 
+                 scaleH_strtIdx=SCALEH_IDX(lines_count-2);
+                 for (int i=0; i<lines_count; i++) {
+                         scaleH_Reference[i]=&scaleH_pixmap[SCALEH_IDX(i)*OSD_STRIDE];
+                         if (scaleH_lines[SCALEH_IDX(i)]!=start_row+i){
+                                 //printf("Horiz scaling line %d\n",start_row+i);
+                                 ScaleDownHoriz_MMX((uint32_t*)scaleH_Reference[i],dest_Width,
+                                                 &pixmap[(start_row+i)*OSD_STRIDE],OSD_WIDTH-1);
+                                 scaleH_lines[SCALEH_IDX(i)]=start_row+i;
+                         }
+                 };
+                /*
+                    printf("strt_Idx %d scaleH_lines: ",scaleH_strtIdx);
+                    for (int i=0; i<lines_count; i++)
+                    printf("%d ",scaleH_lines[i]);
+                    printf("\n");fflush(stdout);
+                  */
+                 OSDDEB("start_pos %d start_row %d\n",start_pos,start_row);
+                 ScaleDownVert_MMX((uint32_t*)tmp_pixmap,0,
+                                 new_pixel_height,start_pos,
+                                 scaleH_Reference,dest_Width);
+                                 //scaleH_Reference,OSD_WIDTH-1);
+                 int new_start_row=new_pixel_height*(y+1)/ScaleFactor;
+                 int start_row_idx=new_start_row-start_row;
+                 start_pos=new_pixel_height*(y+1)%ScaleFactor-ScaleFactor;
+ 
+                 if (scaleH_lines[SCALEH_IDX(start_row_idx)]!=
+                                 new_start_row)
+                         printf("start_row mismatch new_start_row %d : %d\n",
+                                         new_start_row,
+                                         scaleH_lines[SCALEH_IDX(start_row_idx)]);
+ 
+                 OSDDEB("start_pos %d new_start_row %d\n",start_pos,new_start_row);
+                 ScaleDownVert_MMX((uint32_t*)&tmp_pixmap[OSD_STRIDE],0,
+                                 new_pixel_height,start_pos,
+                                 &scaleH_Reference[start_row_idx],
+                                 dest_Width);
+                                 //OSD_WIDTH-1);
+ 
+                 if (bitmap_Format != PF_AYUV) {
+                         if (bitmap_Format == PF_inverseAlpha_ARGB32) {
+                                 // this is a hack to convert the inverse alpha
+                                 // channel back to normal...
+                              ConvertPalette((tColor *)tmp_pixmap, (tColor *)tmp_pixmap,
+                                              dest_Width);    
+                              ConvertPalette((tColor *)&tmp_pixmap[OSD_STRIDE], 
+                                              (tColor *)&tmp_pixmap[OSD_STRIDE],
+                                              dest_Width);    
+                         };
+                         ARGB_to_AYUV((uint32_t*)tmp_pixmap,(color *)tmp_pixmap,
+                                 dest_Width);
+                         ARGB_to_AYUV((uint32_t*)&tmp_pixmap[OSD_STRIDE],
+                                 (color *)&tmp_pixmap[OSD_STRIDE],
+                                 dest_Width);
+                 };
+ 
+                 // convert and copy to video out OSD layer
+                 pY=PY+(y+yPan)*Ystride+xPan;
+                 pU=PU+((y+yPan)*UVstride+xPan)/2;
+                 pV=PV+((y+yPan)*UVstride+xPan)/2;
+                 pAlphaY=PAlphaY+(y+yPan)*Ystride+xPan;
+                 pAlphaUV=PAlphaUV+((y+yPan)*UVstride+xPan)/2;
+                 AYUV_to_AYUV420P(pY,pY+Ystride,pU,pV,
+                                 pAlphaY,pAlphaY+Ystride,pAlphaUV,
+                                 //              &pixmap[y*OSD_STRIDE],&pixmap[(y+1)*OSD_STRIDE],
+                                 //              dest_Width);
+                         tmp_pixmap,&tmp_pixmap[OSD_STRIDE],dest_Width);
+         };
+         OSDDEB("StealToBitmap YUV no Vscale end \n");
+ };
+ 
  void cSoftOsd::NoVScaleCopyToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
                      uint8_t *PAlphaY,uint8_t *PAlphaUV,
***************
*** 1020,1024 ****
  
          OSDDEB("CopyToBitmap YUV down %d,%d\n",dest_Width,dest_Height);
!         // upscaleing is not supported for YUV modes
          if (dest_Width>OSD_WIDTH)
                  dest_Width=OSD_WIDTH;
--- 1126,1130 ----
  
          OSDDEB("CopyToBitmap YUV down %d,%d\n",dest_Width,dest_Height);
!         // upscaling is not supported for YUV modes
          if (dest_Width>OSD_WIDTH)
                  dest_Width=OSD_WIDTH;

Index: SoftOsd.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.h,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** SoftOsd.h	16 Nov 2006 21:03:18 -0000	1.11
--- SoftOsd.h	28 Jan 2007 19:36:50 -0000	1.12
***************
*** 96,99 ****
--- 96,106 ----
      virtual void Flush(void);
  
+     // Create a copy of the osd layer for the Grab() method.
+     // Does *not* change anything in the osd!!
+     void StealToBitmap(uint8_t *PY,uint8_t *PU, uint8_t *PV,
+ 		    uint8_t *PAlphaY,uint8_t *PAlphaUV,
+                     int Ystride, int UVstride,
+                     int dest_Width, int dest_Height);
+ 
  protected:
      bool SetMode(int Depth, bool HasAlpha, bool AlphaInversed,



From nobody at sheep.berlios.de  Sun Jan 28 20:39:29 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 28 Jan 2007 20:39:29 +0100 (CET)
Subject: [Softdevice-cvs] softdevice softdevice.c, 1.76, 1.77 CHANGELOG,
	1.291, 1.292
Message-ID: <20070128193929.EF3B1CE95D@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv8057

Modified Files:
	softdevice.c CHANGELOG 
Log Message:
- add OSD with alpha blending to grabbed images.


Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.76
retrieving revision 1.77
diff -C2 -d -r1.76 -r1.77
*** softdevice.c	3 Dec 2006 20:38:18 -0000	1.76
--- softdevice.c	28 Jan 2007 19:38:06 -0000	1.77
***************
*** 103,112 ****
  private:
      cVideoOut *videoOut;
!     cOsd *osd;
  public:
      cSoftOsdProvider(cVideoOut *VideoOut);
      virtual cOsd *CreateOsd(int Left, int Top);
  };
  
  cSoftOsdProvider::cSoftOsdProvider(cVideoOut *VideoOut) : cOsdProvider()
  {
--- 103,115 ----
  private:
      cVideoOut *videoOut;
!     static cOsd *osd;
  public:
      cSoftOsdProvider(cVideoOut *VideoOut);
      virtual cOsd *CreateOsd(int Left, int Top);
+     static cOsd *GetOsd();
  };
  
+ cOsd *cSoftOsdProvider::osd=NULL;
+ 
  cSoftOsdProvider::cSoftOsdProvider(cVideoOut *VideoOut) : cOsdProvider()
  {
***************
*** 120,123 ****
--- 123,133 ----
  }
  
+ cOsd * cSoftOsdProvider::GetOsd()
+ {
+     if (cOsd::IsOpen())
+ 	return osd;
+     return NULL;
+ };
+ 
  /* ----------------------------------------------------------------------------
   */
***************
*** 591,594 ****
--- 601,605 ----
                  int SizeX, int SizeY)
  {
+   bool self_allocated_pic=false;
    Size=0;
    if (!videoOut)
***************
*** 597,602 ****
    sPicBuffer *orig_pic;
    videoOut->GetLockLastPic(orig_pic);
!   if (!orig_pic)
!     return NULL;
  
    if ( SizeX<0 || SizeY<0 ) {
--- 608,622 ----
    sPicBuffer *orig_pic;
    videoOut->GetLockLastPic(orig_pic);
! 
!   if (!orig_pic) {
!     // got no video picture, but maybe there is OSD, so allocate a 
!     // black picture as a background.
!     orig_pic=(sPicBuffer*) malloc(sizeof(sPicBuffer));
!     AllocatePicBuffer(orig_pic,PIX_FMT_YUV420P,SRC_HEIGHT,SRC_WIDTH);
!     orig_pic->width=SRC_WIDTH;
!     orig_pic->height=SRC_HEIGHT;
!     ClearPicBuffer(orig_pic);
!     self_allocated_pic=true;
!   };
  
    if ( SizeX<0 || SizeY<0 ) {
***************
*** 607,621 ****
    if (Quality<0)
      Quality=100;
! 
    sPicBuffer dst;
    AllocatePicBuffer(&dst,PIX_FMT_BGR24,SizeX,SizeY);
  
!   CopyScalePicBuf(&dst,orig_pic,
!       0,0,orig_pic->width,orig_pic->height,
!       0,0,SizeX,SizeY,
!       0,0,0,0);
    SizeX=dst.width;
    SizeY=dst.height;
!   videoOut->UnlockBuffer(orig_pic);
    orig_pic=NULL;
  
--- 627,674 ----
    if (Quality<0)
      Quality=100;
!  
    sPicBuffer dst;
    AllocatePicBuffer(&dst,PIX_FMT_BGR24,SizeX,SizeY);
  
!   cSoftOsd *Osd=dynamic_cast<cSoftOsd*>(cSoftOsdProvider::GetOsd());
!   if (!Osd && self_allocated_pic) {
!     // no osd and no picture... return null to avoid 
!     // "Empty JPEG image (DNL not supported)" error message from libjpeg
!     DeallocatePicBuffer(orig_pic);
!     free(orig_pic);
!     return NULL;
!   };
! 
!   if (Osd) {
!      uint8_t *OsdPy=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE+16);
!      uint8_t *OsdPu=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8);
!      uint8_t *OsdPv=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8);
!      uint8_t *OsdPAlphaY=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE+16);
!      uint8_t *OsdPAlphaUV=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8); 
!      Osd->StealToBitmap(OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV,
!                     OSD_STRIDE, OSD_STRIDE/2,
!                     SizeX, SizeY);
!      CopyScalePicBufAlphaBlend(&dst,orig_pic,
! 	   0,0,orig_pic->width,orig_pic->height,
! 	   0,0,SizeX,SizeY,
! 	   OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
!            OSD_STRIDE, 
! 	   0,0,0,0);
!      free(OsdPy); free(OsdPu); free(OsdPv); 
!      free(OsdPAlphaY); free(OsdPAlphaUV);
!   } else {
!      CopyScalePicBuf(&dst,orig_pic,
! 	   0,0,orig_pic->width,orig_pic->height,
! 	   0,0,SizeX,SizeY,
! 	   0,0,0,0);
!   };
    SizeX=dst.width;
    SizeY=dst.height;
!   if (!self_allocated_pic) 
!     videoOut->UnlockBuffer(orig_pic);
!   else {
!     DeallocatePicBuffer(orig_pic);
!     free(orig_pic);
!   };
    orig_pic=NULL;
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.291
retrieving revision 1.292
diff -C2 -d -r1.291 -r1.292
*** CHANGELOG	28 Jan 2007 19:36:50 -0000	1.291
--- CHANGELOG	28 Jan 2007 19:38:06 -0000	1.292
***************
*** 7,10 ****
--- 7,11 ----
       architectures.
     - add StealToBitmap() for OSD in grabbed image.
+    - add OSD with alpha blending to grabbed images.
  2007-01-27:
     - video-dfb: - Limit VIA-unichrome name compare to 19 chars.



From nobody at sheep.berlios.de  Sat Feb 10 00:48:16 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Feb 2007 00:48:16 +0100 (CET)
Subject: [Softdevice-cvs] softdevice setup-softlog-menu.c, NONE,
	1.1 setup-softlog-menu.h, NONE, 1.1 setup-softlog.c, NONE,
	1.1 setup-softlog.h, NONE, 1.1
Message-ID: <20070209234816.11AC4D986C@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1988

Added Files:
	setup-softlog-menu.c setup-softlog-menu.h setup-softlog.c 
	setup-softlog.h 
Log Message:
add configurable logging

--- NEW FILE: setup-softlog-menu.c ---
/*
 * See the README file for copyright information and how to reach the authors.
 *
 * $Id: setup-softlog-menu.c,v 1.1 2007/02/09 23:46:47 lucke Exp $
 */


#include "setup-softdevice-menu.h"
#include "setup-softlog-menu.h"

/* ---------------------------------------------------------------------------
 */
cMenuSetupSoftlog::cMenuSetupSoftlog(cPlugin *plugin, const char *name)
{
  if (plugin)
    SetPlugin(plugin);

  newLogFileName = strdup(setupStore.softlog->GetLogFileName());
  newLogPriorities = setupStore.softlog->GetLogPriorities();

#if VDRVERSNUM >= 10334
  Add(new cOsdItem(" ", osUnknown, false));
#else
  Add(new cOsdItem(" ", osUnknown));
#endif

  Add(new cMenuEditStrItem(tr("Logfile"), newLogFileName, 64, NULL));
}

/* ---------------------------------------------------------------------------
 */
cMenuSetupSoftlog::~cMenuSetupSoftlog()
{
  free(newLogFileName);
  newLogFileName = NULL;
}

/* ---------------------------------------------------------------------------
 */
eOSState cMenuSetupSoftlog::ProcessKey(eKeys Key)
{
    eOSState state = cOsdMenu::ProcessKey(Key);

  switch (state)
  {
    case osUnknown:
      switch (Key)
      {
        case kOk:
          Store();
          state = osBack;
          break;
        default:
          break;
      }
      break;
    case osBack:
      break;
    default:
      break;
  }
  return state;
}

/* ---------------------------------------------------------------------------
 */
void cMenuSetupSoftlog::Store(void)
{
  if (strcmp(newLogFileName, setupStore.softlog->GetLogFileName()))
    setupStore.softlog->SetLogFile(newLogFileName);
  SetupStore ("softlog-file",       setupStore.softlog->GetLogFileName());

  if (newLogPriorities != setupStore.softlog->GetLogPriorities())
    setupStore.softlog->SetLogPriorities(newLogPriorities);
  SetupStore ("softlog-priorities", setupStore.softlog->GetLogPriorities());

}

--- NEW FILE: setup-softlog-menu.h ---
/*
 * See the README file for copyright information and how to reach the authors.
 *
 * $Id: setup-softlog-menu.h,v 1.1 2007/02/09 23:46:47 lucke Exp $
 */

#ifndef __SETUP_SOFTLOG_MENU_H
#define __SETUP_SOFTLOG_MENU_H

#ifndef STAND_ALONE
#include <vdr/menu.h>
#include <vdr/plugin.h>
#include <vdr/i18n.h>
#else
#include "VdrReplacements.h"
#endif

#include "setup-softlog.h"

/* ---------------------------------------------------------------------------
 */
class cMenuSetupSoftlog : public cMenuSetupPage {
  private:
    char  *newLogFileName;
    int   newLogPriorities;

  protected:
    virtual eOSState ProcessKey(eKeys Key);
    virtual void Store(void);

  public:
    cMenuSetupSoftlog(cPlugin *plugin = NULL, const char *name = NULL);
    virtual ~cMenuSetupSoftlog();
};
#endif


--- NEW FILE: setup-softlog.c ---
/*
 * Configurable logging and traceing
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: setup-softlog.c,v 1.1 2007/02/09 23:46:47 lucke Exp $
 */

#include "setup-softlog.h"

#include <stdarg.h>
#include <stdlib.h>
#include <errno.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <sys/time.h>

#define MAXSYSLOGBUF 256

/* ---------------------------------------------------------------------------
 */
cSetupSoftlog::cSetupSoftlog()
{
  logFile = stderr;
  logFileName = strdup("stderr");
  appendPID = true;
  enabledPriorities = SOFT_LOG_ERROR | SOFT_LOG_INFO | SOFT_LOG_DEBUG;
  traceFlags = 0;
}

/* ---------------------------------------------------------------------------
 */
cSetupSoftlog::~cSetupSoftlog()
{
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::IsEnabled(int priority)
{
  return priority & enabledPriorities;
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::LogPriority(int priority)
{
  // no syslog loging for trace messages
  if (priority & SOFT_LOG_TRACE)
    return NO_LOG;

  if (IsEnabled(priority) & SOFT_LOG_ERROR)
    return LOG_ERR;
  if (IsEnabled(priority) & SOFT_LOG_INFO)
    return LOG_INFO;
  if (IsEnabled(priority) & SOFT_LOG_DEBUG)
    return LOG_DEBUG;

  // unknown logtype -> return invalid priority
  return NO_LOG;
}

/* ---------------------------------------------------------------------------
 */
void cSetupSoftlog::CloseLogFile()
{
  if (logFile && logFile != stderr && logFile != stdout)
    fclose(logFile);

  free(logFileName);
  logFileName = NULL;
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::SetLogPriorities(int newPriorities)
{
    int oldenabledPriorities = enabledPriorities;

  enabledPriorities = newPriorities;
  return oldenabledPriorities;
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::GetLogPriorities()
{
  return enabledPriorities;
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::SetTraceFlags(int newFlags)
{
    int oldTraceFlags = traceFlags;

  traceFlags = newFlags;
  return oldTraceFlags;
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::GetTraceFlags()
{
  return traceFlags;
}

/* ---------------------------------------------------------------------------
 */
int cSetupSoftlog::SetLogFile(const char *fileName)
{
  /* -------------------------------------------------------------------------
   * Don't close stderr. Handle fileName "stderr" special so that it is
   * possible to switch back from file logging to stderr.
   */
  CloseLogFile();
  if (!strcmp (fileName, "stderr")) {
    logFile = stderr;
  } else if (!strcmp (fileName, "stdout")) {
    logFile = stdout;
  } else {
      char realName [256];

    if (appendPID)
      snprintf (realName, sizeof(realName), "%s-%d", fileName, getpid());
    else
      snprintf (realName, sizeof(realName), "%s", fileName);

    if (!(logFile = fopen (realName, "w+"))) {
      syslog(LOG_ERR,
             "[softlog] could not open logfile (%s), using stderr",
             realName);
      fprintf(stderr,
              "[softlog] could not open logfile (%s), using stderr",
              realName);
      logFile = stderr;
      logFileName = strdup("stderr");
      return 0;
    }
  }

  logFileName = strdup(fileName);
  return 1;
}

/* ---------------------------------------------------------------------------
 */
char *cSetupSoftlog::GetLogFileName()
{
  return logFileName;
}

/* ---------------------------------------------------------------------------
 */
void cSetupSoftlog::DisableLog2File()
{
  CloseLogFile();
  logFile = NULL;
}

_syscall0(pid_t, gettid)

/* ---------------------------------------------------------------------------
 */
void cSetupSoftlog::Log(int currPriority, int traceFlags, char *format, ...)
{
    va_list argList;
    int     priority;
    char    fmt[MAXSYSLOGBUF];

  if (!IsEnabled(currPriority))
    return;

  va_start(argList, format);
  priority = LogPriority(currPriority);
  snprintf(fmt, sizeof(fmt), "[%d] %s", gettid(), format);

  if (priority != NO_LOG)
    vsyslog(priority, fmt, argList);

  if (logFile) {
      struct timeval now;
      struct tm *tmp;

    gettimeofday(&now, NULL);
    tmp = localtime(&now.tv_sec);
    snprintf(fmt, sizeof(fmt), "%02d:%02d:%02d.%04d [%d] %s",
             tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
             gettid(), format);
    vfprintf(logFile, fmt, argList);
    fflush(logFile);
  }

  va_end(argList);
}

/* ---------------------------------------------------------------------------
 */
bool cSetupSoftlog::Parse(const char *name, const char *value)
{
  if (!strcasecmp(name,"softlog-priorities"))
    SetLogPriorities(atoi(value));
  else if (!strcasecmp(name,"softlog-file"))
    SetLogFile(value);
  else
    return false;

  return true;
}

--- NEW FILE: setup-softlog.h ---
/*
 * Configurable logging and traceing
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: setup-softlog.h,v 1.1 2007/02/09 23:46:47 lucke Exp $
 */

#ifndef __SETUP_SOFTLOG_H
#define __SETUP_SOFTLOG_H

#include <stdio.h>
#include <string.h>
#include <syslog.h>

#ifndef STAND_ALONE
#include <vdr/plugin.h>
#else
#include "VdrReplacements.h"
#endif

#define SOFT_LOG_ERROR   1
#define SOFT_LOG_INFO    2
#define SOFT_LOG_DEBUG   4
#define SOFT_LOG_TRACE   8

#define NO_LOG          (LOG_EMERG - 1)

class cSetupSoftlog {
  private:
    char  *logFileName;
    int   enabledPriorities,
          traceFlags;
    bool  appendPID;
    FILE  *logFile;

    int   IsEnabled(int priority),
          LogPriority(int priority);
    void  CloseLogFile();

  public:
    cSetupSoftlog();
    virtual ~cSetupSoftlog();

    virtual void  Log(int currPriorities, int traceFlags, char *format, ...),
                  DisableLog2File();
    virtual int   SetLogPriorities(int newPriorities),
                  GetLogPriorities(),
                  SetTraceFlags(int newFlags),
                  GetTraceFlags(),
                  SetLogFile(const char *fileName);
    virtual char  *GetLogFileName();
    virtual bool  Parse(const char *name, const char *value);
};

#endif



From nobody at sheep.berlios.de  Sat Feb 10 00:56:52 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Feb 2007 00:56:52 +0100 (CET)
Subject: [Softdevice-cvs] softdevice softdevice.c,1.77,1.78
Message-ID: <20070209235652.C7380DB061@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16145

Modified Files:
	softdevice.c 
Log Message:
Pause the playback of recordings when suspended (by Marko M?kel?)

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.77
retrieving revision 1.78
diff -C2 -d -r1.77 -r1.78
*** softdevice.c	28 Jan 2007 19:38:06 -0000	1.77
--- softdevice.c	9 Feb 2007 23:55:22 -0000	1.78
***************
*** 526,529 ****
--- 526,535 ----
  {
    SOFTDEB("PlayAudio... %p length %d\n",Data,Length);
+ #if VDRVERSNUM >= 10342
+   if (setupStore.shouldSuspend && !Transferring()) {
+     usleep(10000); // avoid burning CPU
+     return 0;
+   }
+ #endif
    if (! packetMode)
      return decoder->Decode(Data, Length);
***************
*** 580,585 ****
  int cSoftDevice::PlayVideo(const uchar *Data, int Length)
  {
!    SOFTDEB("PlayVideo %x length %d\n",Data,Length);
!    if (! packetMode)
      return decoder->Decode(Data, Length);
  
--- 586,597 ----
  int cSoftDevice::PlayVideo(const uchar *Data, int Length)
  {
!   SOFTDEB("PlayVideo %x length %d\n",Data,Length);
! #if VDRVERSNUM >= 10342
!   if (setupStore.shouldSuspend && !Transferring()) {
!     usleep(10000); // avoid burning CPU
!     return 0;
!   }
! #endif
!   if (! packetMode)
      return decoder->Decode(Data, Length);
  
***************
*** 588,597 ****
       ic=(AVFormatContext *) Data;
       return -1;
!   };
    if ( packetMode && ic && Length == -2 ) {
       // Length = -2 : pass pointer to packet
       decoder->QueuePacket(ic,( AVPacket &) *Data,true);
       return -2;
!   };
    return 0;
  }
--- 600,609 ----
       ic=(AVFormatContext *) Data;
       return -1;
!   }
    if ( packetMode && ic && Length == -2 ) {
       // Length = -2 : pass pointer to packet
       decoder->QueuePacket(ic,( AVPacket &) *Data,true);
       return -2;
!   }
    return 0;
  }
***************
*** 610,614 ****
  
    if (!orig_pic) {
!     // got no video picture, but maybe there is OSD, so allocate a 
      // black picture as a background.
      orig_pic=(sPicBuffer*) malloc(sizeof(sPicBuffer));
--- 622,626 ----
  
    if (!orig_pic) {
!     // got no video picture, but maybe there is OSD, so allocate a
      // black picture as a background.
      orig_pic=(sPicBuffer*) malloc(sizeof(sPicBuffer));
***************
*** 627,631 ****
    if (Quality<0)
      Quality=100;
!  
    sPicBuffer dst;
    AllocatePicBuffer(&dst,PIX_FMT_BGR24,SizeX,SizeY);
--- 639,643 ----
    if (Quality<0)
      Quality=100;
! 
    sPicBuffer dst;
    AllocatePicBuffer(&dst,PIX_FMT_BGR24,SizeX,SizeY);
***************
*** 633,637 ****
    cSoftOsd *Osd=dynamic_cast<cSoftOsd*>(cSoftOsdProvider::GetOsd());
    if (!Osd && self_allocated_pic) {
!     // no osd and no picture... return null to avoid 
      // "Empty JPEG image (DNL not supported)" error message from libjpeg
      DeallocatePicBuffer(orig_pic);
--- 645,649 ----
    cSoftOsd *Osd=dynamic_cast<cSoftOsd*>(cSoftOsdProvider::GetOsd());
    if (!Osd && self_allocated_pic) {
!     // no osd and no picture... return null to avoid
      // "Empty JPEG image (DNL not supported)" error message from libjpeg
      DeallocatePicBuffer(orig_pic);
***************
*** 645,649 ****
       uint8_t *OsdPv=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8);
       uint8_t *OsdPAlphaY=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE+16);
!      uint8_t *OsdPAlphaUV=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8); 
       Osd->StealToBitmap(OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV,
                      OSD_STRIDE, OSD_STRIDE/2,
--- 657,661 ----
       uint8_t *OsdPv=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8);
       uint8_t *OsdPAlphaY=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE+16);
!      uint8_t *OsdPAlphaUV=(uint8_t*)malloc(OSD_HEIGHT*OSD_STRIDE/4+8);
       Osd->StealToBitmap(OsdPy,OsdPu,OsdPv,OsdPAlphaY,OsdPAlphaUV,
                      OSD_STRIDE, OSD_STRIDE/2,
***************
*** 653,659 ****
  	   0,0,SizeX,SizeY,
  	   OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
!            OSD_STRIDE, 
  	   0,0,0,0);
!      free(OsdPy); free(OsdPu); free(OsdPv); 
       free(OsdPAlphaY); free(OsdPAlphaUV);
    } else {
--- 665,671 ----
  	   0,0,SizeX,SizeY,
  	   OsdPy,OsdPv,OsdPu,OsdPAlphaY,OsdPAlphaUV,
!            OSD_STRIDE,
  	   0,0,0,0);
!      free(OsdPy); free(OsdPu); free(OsdPv);
       free(OsdPAlphaY); free(OsdPAlphaUV);
    } else {
***************
*** 665,669 ****
    SizeX=dst.width;
    SizeY=dst.height;
!   if (!self_allocated_pic) 
      videoOut->UnlockBuffer(orig_pic);
    else {
--- 677,681 ----
    SizeX=dst.width;
    SizeY=dst.height;
!   if (!self_allocated_pic)
      videoOut->UnlockBuffer(orig_pic);
    else {



From nobody at sheep.berlios.de  Sat Feb 10 01:03:43 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Feb 2007 01:03:43 +0100 (CET)
Subject: [Softdevice-cvs] softdevice setup-softdevice-menu.c, 1.8,
	1.9 setup-softdevice-menu.h, 1.1, 1.2 setup-softdevice.c, 1.48,
	1.49 setup-softdevice.h, 1.36, 1.37 Makefile, 1.35, 1.36
Message-ID: <20070210000343.42562DA6D3@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv25064

Modified Files:
	setup-softdevice-menu.c setup-softdevice-menu.h 
	setup-softdevice.c setup-softdevice.h Makefile 
Log Message:
activate configurable logging

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** setup-softdevice-menu.c	9 Sep 2006 10:35:37 -0000	1.8
--- setup-softdevice-menu.c	10 Feb 2007 00:02:14 -0000	1.9
***************
*** 9,12 ****
--- 9,13 ----
  //#include "video.h"
  #include "setup-softdevice-menu.h"
+ #include "setup-softlog-menu.h"
  
  /* ---------------------------------------------------------------------------
***************
*** 274,277 ****
--- 275,279 ----
    if (plugin)
      SetPlugin(plugin);
+   this->plugin = plugin;
  
    copyData = setupStore;
***************
*** 286,289 ****
--- 288,293 ----
    }
  
+   Add(new cOsdItem(tr("Logging")));
+ 
  #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
***************
*** 408,411 ****
--- 412,419 ----
            {
              return AddSubMenu (new cMenuSetupVideoParm(tr("Video out")));
+           }
+           else if (!strcmp(Get(Current())->Text(),tr("Logging")))
+           {
+             return AddSubMenu (new cMenuSetupSoftlog(plugin, tr("Logging")));
            }
            Store();

Index: setup-softdevice-menu.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** setup-softdevice-menu.h	23 Apr 2006 19:55:53 -0000	1.1
--- setup-softdevice-menu.h	10 Feb 2007 00:02:14 -0000	1.2
***************
*** 59,62 ****
--- 59,63 ----
    private:
      cSetupStore *data, copyData;
+     cPlugin     *plugin;
  
    protected:

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** setup-softdevice.c	3 Dec 2006 18:26:21 -0000	1.48
--- setup-softdevice.c	10 Feb 2007 00:02:14 -0000	1.49
***************
*** 75,89 ****
  /* ----------------------------------------------------------------------------
   */
- static inline int clamp (int min, int val, int max)
- {
-   if (val < min)
-     return min;
-   if (val > max)
-     return max;
-   return val;
- }
- 
- /* ----------------------------------------------------------------------------
-  */
  cSetupStore setupStore;
  
--- 75,78 ----
***************
*** 204,207 ****
--- 193,198 ----
    syncTimerNames[2] = "sig";
    syncTimerNames[3] = NULL;
+ 
+   softlog = new cSetupSoftlog();
  }
  
***************
*** 379,383 ****
      fprintf(stderr, "[setup-softdevice] vidSaturation: %d\n", vidSaturation);
    }  else
!     return false;
  
    return true;
--- 370,374 ----
      fprintf(stderr, "[setup-softdevice] vidSaturation: %d\n", vidSaturation);
    }  else
!     return softlog->Parse (Name, Value);
  
    return true;

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** setup-softdevice.h	3 Dec 2006 18:26:21 -0000	1.36
--- setup-softdevice.h	10 Feb 2007 00:02:14 -0000	1.37
***************
*** 19,22 ****
--- 19,24 ----
  #endif
  
+ #include "setup-softlog.h"
+ 
  #ifdef HAVE_CONFIG
  # include "config.h"
***************
*** 173,180 ****
--- 175,195 ----
      char  *voArgs;
      char  *aoArgs;
+ 
+     cSetupSoftlog *softlog;
  };
  
  #define OSDMODE_PSEUDO    0
  #define OSDMODE_SOFTWARE  1
+ 
+ /* ----------------------------------------------------------------------------
+  */
+ static inline int clamp (int min, int val, int max)
+ {
+   if (val < min)
+     return min;
+   if (val > max)
+     return max;
+   return val;
+ }
  
  extern cSetupStore setupStore;

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** Makefile	3 Dec 2006 20:38:18 -0000	1.35
--- Makefile	10 Feb 2007 00:02:14 -0000	1.36
***************
*** 227,231 ****
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS)
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o setup-softdevice-menu.o sync-timer.o SoftOsd.o PicBuffer.o VideoFilter.o
  ALL_OBJS = $(OBJS)
  
--- 227,235 ----
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS)
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o \
! 				audio.o video-dummy.o \
! 				setup-softdevice.o setup-softdevice-menu.o \
! 				setup-softlog.o setup-softlog-menu.o\
! 				sync-timer.o SoftOsd.o PicBuffer.o VideoFilter.o
  ALL_OBJS = $(OBJS)
  
***************
*** 238,242 ****
    OBJS += audio-oss.o
  endif
!   
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
--- 242,246 ----
    OBJS += audio-oss.o
  endif
! 
  ifdef DFB_SUPPORT
    ifdef USE_SUBPLUGINS
***************
*** 364,368 ****
  		      ../../../config.o ../../../plugin.o\
  		      ../../../sources.o
! SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o setup-softdevice_shm.o\
  		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
  		   ShmClient_shm.o PicBuffer_shm.o
--- 368,373 ----
  		      ../../../config.o ../../../plugin.o\
  		      ../../../sources.o
! SHM_CLIENT_OBJS  = video_shm.o video-xv_shm.o \
! 			 setup-softdevice_shm.o setup-softlog_shm.o \
  		   xscreensaver_shm.o utils_shm.o VdrReplacements_shm.o\
  		   ShmClient_shm.o PicBuffer_shm.o



From nobody at sheep.berlios.de  Sat Feb 10 01:07:14 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 10 Feb 2007 01:07:14 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.292, 1.293 audio-alsa.c,
	1.4, 1.5 audio-alsa.h, 1.2, 1.3
Message-ID: <20070210000714.03A14D7CDE@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv27795

Modified Files:
	CHANGELOG audio-alsa.c audio-alsa.h 
Log Message:
report Xrun audio duration

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.292
retrieving revision 1.293
diff -C2 -d -r1.292 -r1.293
*** CHANGELOG	28 Jan 2007 19:38:06 -0000	1.292
--- CHANGELOG	10 Feb 2007 00:05:45 -0000	1.293
***************
*** 1,8 ****
  Changelog
  2007-01-28:
     - don't lock NULL pictures in cVideo::GetLockLastPic().
     - implement avcodec_decode_audio2() interface to libavcodec.
     - set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.
!    - add architecture "x86_64" to configure and report unsupported 
       architectures.
     - add StealToBitmap() for OSD in grabbed image.
--- 1,12 ----
  Changelog
+ 2007-02-10:
+    - Pause the playback of recordings when suspended (by Marko M?kel?)
+    - add configurable logging
+    - report Xrun audio duration
  2007-01-28:
     - don't lock NULL pictures in cVideo::GetLockLastPic().
     - implement avcodec_decode_audio2() interface to libavcodec.
     - set ic->bp.is_streamed to true, to avoid calls to unimlemented seek method.
!    - add architecture "x86_64" to configure and report unsupported
       architectures.
     - add StealToBitmap() for OSD in grabbed image.

Index: audio-alsa.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-alsa.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** audio-alsa.c	7 Nov 2006 18:16:57 -0000	1.4
--- audio-alsa.c	10 Feb 2007 00:05:45 -0000	1.5
***************
*** 251,255 ****
  	}
  	if (snd_pcm_status_get_state(status) == SND_PCM_STATE_XRUN) {
! //		snd_pcm_status_get_trigger_tstamp(status, &tstamp);
  		if ((res = snd_pcm_prepare(handle))<0) {
        esyslog("[softdevice-audio]: Xrun prepare error: %s FATAL exiting",
--- 251,261 ----
  	}
  	if (snd_pcm_status_get_state(status) == SND_PCM_STATE_XRUN) {
!       struct timeval now, diff, tstamp;
!     gettimeofday(&now, 0);
!     snd_pcm_status_get_trigger_tstamp(status, &tstamp);
!     timersub(&now, &tstamp, &diff);
!     setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                              "[softdevice-audio]: Xrun (at least %.3f ms long)\n",
!                              diff.tv_sec * 1000 + diff.tv_usec / 1000.0);
  		if ((res = snd_pcm_prepare(handle))<0) {
        esyslog("[softdevice-audio]: Xrun prepare error: %s FATAL exiting",

Index: audio-alsa.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-alsa.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** audio-alsa.h	5 Nov 2006 22:05:59 -0000	1.2
--- audio-alsa.h	10 Feb 2007 00:05:45 -0000	1.3
***************
*** 11,14 ****
--- 11,17 ----
  #define ALSA_PCM_NEW_HW_PARAMS_API
  #define ALSA_PCM_NEW_SW_PARAMS_API
+ 
+ #include <sys/time.h>
+ 
  #include <alsa/asoundlib.h>
  #include <vdr/plugin.h>



From nobody at sheep.berlios.de  Sun Feb 11 11:33:06 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 11 Feb 2007 11:33:06 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.293,
	1.294 setup-softlog-menu.c, 1.1, 1.2 setup-softlog-menu.h, 1.1,
	1.2 setup-softlog.c, 1.1, 1.2 setup-softlog.h, 1.1, 1.2
Message-ID: <20070211103306.E6AF1D84F5@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2129

Modified Files:
	CHANGELOG setup-softlog-menu.c setup-softlog-menu.h 
	setup-softlog.c setup-softlog.h 
Log Message:
Some more options selectable via log menu.

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.293
retrieving revision 1.294
diff -C2 -d -r1.293 -r1.294
*** CHANGELOG	10 Feb 2007 00:05:45 -0000	1.293
--- CHANGELOG	11 Feb 2007 10:31:27 -0000	1.294
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2007-02-11:
+    - Some more options selectable via log menu.
  2007-02-10:
     - Pause the playback of recordings when suspended (by Marko M?kel?)

Index: setup-softlog-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog-menu.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** setup-softlog-menu.c	9 Feb 2007 23:46:47 -0000	1.1
--- setup-softlog-menu.c	11 Feb 2007 10:31:27 -0000	1.2
***************
*** 16,21 ****
      SetPlugin(plugin);
  
!   newLogFileName = strdup(setupStore.softlog->GetLogFileName());
    newLogPriorities = setupStore.softlog->GetLogPriorities();
  
  #if VDRVERSNUM >= 10334
--- 16,32 ----
      SetPlugin(plugin);
  
!   strncpy(newLogFileName, setupStore.softlog->GetLogFileName(), 256);
    newLogPriorities = setupStore.softlog->GetLogPriorities();
+   newAppendMode = setupStore.softlog->GetAppendMode();
+ 
+   Add(new cMenuEditBitItem(tr("Info Messages"),
+                            (uint *) &newLogPriorities,
+                            SOFT_LOG_INFO));
+   Add(new cMenuEditBitItem(tr("Debug Messages"),
+                            (uint *) &newLogPriorities,
+                            SOFT_LOG_DEBUG));
+   Add(new cMenuEditBitItem(tr("Trace Messages"),
+                            (uint *) &newLogPriorities,
+                            SOFT_LOG_TRACE));
  
  #if VDRVERSNUM >= 10334
***************
*** 25,29 ****
  #endif
  
!   Add(new cMenuEditStrItem(tr("Logfile"), newLogFileName, 64, NULL));
  }
  
--- 36,41 ----
  #endif
  
!   Add(new cMenuEditStrItem(tr("Logfile"), newLogFileName, 256, tr(FileNameChars)));
!   Add(new cMenuEditBoolItem(tr("Append PID"), &newAppendMode));
  }
  
***************
*** 32,37 ****
  cMenuSetupSoftlog::~cMenuSetupSoftlog()
  {
-   free(newLogFileName);
-   newLogFileName = NULL;
  }
  
--- 44,47 ----
***************
*** 70,73 ****
--- 80,86 ----
      setupStore.softlog->SetLogFile(newLogFileName);
    SetupStore ("softlog-file",       setupStore.softlog->GetLogFileName());
+ 
+   setupStore.softlog->SetAppendMode(newAppendMode);
+   SetupStore ("softlog-appendpid",  setupStore.softlog->GetAppendMode());
  
    if (newLogPriorities != setupStore.softlog->GetLogPriorities())

Index: setup-softlog-menu.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog-menu.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** setup-softlog-menu.h	9 Feb 2007 23:46:47 -0000	1.1
--- setup-softlog-menu.h	11 Feb 2007 10:31:27 -0000	1.2
***************
*** 22,27 ****
  class cMenuSetupSoftlog : public cMenuSetupPage {
    private:
!     char  *newLogFileName;
      int   newLogPriorities;
  
    protected:
--- 22,28 ----
  class cMenuSetupSoftlog : public cMenuSetupPage {
    private:
!     char  newLogFileName[256];
      int   newLogPriorities;
+     int   newAppendMode;
  
    protected:

Index: setup-softlog.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** setup-softlog.c	9 Feb 2007 23:46:47 -0000	1.1
--- setup-softlog.c	11 Feb 2007 10:31:27 -0000	1.2
***************
*** 79,83 ****
      int oldenabledPriorities = enabledPriorities;
  
!   enabledPriorities = newPriorities;
    return oldenabledPriorities;
  }
--- 79,86 ----
      int oldenabledPriorities = enabledPriorities;
  
!   /* -------------------------------------------------------------------------
!    * set new priority flags, but error messages are allways enabled
!    */
!   enabledPriorities = (newPriorities | SOFT_LOG_ERROR);
    return oldenabledPriorities;
  }
***************
*** 109,112 ****
--- 112,136 ----
  /* ---------------------------------------------------------------------------
   */
+ int cSetupSoftlog::SetAppendMode(int newMode)
+ {
+     int oldMode = appendPID;
+ 
+   if (newMode != appendPID) {
+     appendPID = newMode;
+     SetLogFile(logFileName);
+   }
+ 
+   return oldMode;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ int cSetupSoftlog::GetAppendMode()
+ {
+   return appendPID;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  int cSetupSoftlog::SetLogFile(const char *fileName)
  {
***************
*** 204,207 ****
--- 228,233 ----
    else if (!strcasecmp(name,"softlog-file"))
      SetLogFile(value);
+   else if (!strcasecmp(name,"softlog-appendpid"))
+     SetAppendMode(atoi(value));
    else
      return false;

Index: setup-softlog.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** setup-softlog.h	9 Feb 2007 23:46:47 -0000	1.1
--- setup-softlog.h	11 Feb 2007 10:31:27 -0000	1.2
***************
*** 49,52 ****
--- 49,54 ----
                    SetTraceFlags(int newFlags),
                    GetTraceFlags(),
+                   SetAppendMode(int newMode),
+                   GetAppendMode(),
                    SetLogFile(const char *fileName);
      virtual char  *GetLogFileName();



From nobody at sheep.berlios.de  Tue Feb 13 21:05:35 2007
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 13 Feb 2007 21:05:35 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.294, 1.295 setup-softlog.c,
	1.2, 1.3
Message-ID: <20070213200535.1E972DB25E@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22578

Modified Files:
	CHANGELOG setup-softlog.c 
Log Message:
fix gettid compile error on some systems

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.294
retrieving revision 1.295
diff -C2 -d -r1.294 -r1.295
*** CHANGELOG	11 Feb 2007 10:31:27 -0000	1.294
--- CHANGELOG	13 Feb 2007 20:03:59 -0000	1.295
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2007-02-13:
+    - fix gettid compile error on some systems.
  2007-02-11:
     - Some more options selectable via log menu.

Index: setup-softlog.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** setup-softlog.c	11 Feb 2007 10:31:27 -0000	1.2
--- setup-softlog.c	13 Feb 2007 20:03:59 -0000	1.3
***************
*** 184,189 ****
  }
  
- _syscall0(pid_t, gettid)
- 
  /* ---------------------------------------------------------------------------
   */
--- 184,187 ----
***************
*** 199,203 ****
    va_start(argList, format);
    priority = LogPriority(currPriority);
!   snprintf(fmt, sizeof(fmt), "[%d] %s", gettid(), format);
  
    if (priority != NO_LOG)
--- 197,201 ----
    va_start(argList, format);
    priority = LogPriority(currPriority);
!   snprintf(fmt, sizeof(fmt), "[%ld] %s", syscall(__NR_gettid), format);
  
    if (priority != NO_LOG)
***************
*** 210,216 ****
      gettimeofday(&now, NULL);
      tmp = localtime(&now.tv_sec);
!     snprintf(fmt, sizeof(fmt), "%02d:%02d:%02d.%04d [%d] %s",
               tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
!              gettid(), format);
      vfprintf(logFile, fmt, argList);
      fflush(logFile);
--- 208,214 ----
      gettimeofday(&now, NULL);
      tmp = localtime(&now.tv_sec);
!     snprintf(fmt, sizeof(fmt), "%02d:%02d:%02d.%04d [%ld] %s",
               tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
!              syscall(__NR_gettid), format);
      vfprintf(logFile, fmt, argList);
      fflush(logFile);



From nobody at sheep.berlios.de  Sat Feb 24 15:05:48 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 24 Feb 2007 15:05:48 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.295, 1.296 Makefile, 1.36,
	1.37 setup-softlog.c, 1.3, 1.4 setup-softlog.h, 1.2,
	1.3 video-vidix.c, 1.24, 1.25
Message-ID: <20070224140548.F2509D85C0@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21163

Modified Files:
	CHANGELOG Makefile setup-softlog.c setup-softlog.h 
	video-vidix.c 
Log Message:
Makefile: add --remove-destination , so that "make plugins" does not
disturb a running vdr.
softlog: added indicator for priority I(nfo), E(rror), D(ebug), T(race).
video-vidix: shifted prints via softlog.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.295
retrieving revision 1.296
diff -C2 -d -r1.295 -r1.296
*** CHANGELOG	13 Feb 2007 20:03:59 -0000	1.295
--- CHANGELOG	24 Feb 2007 14:04:14 -0000	1.296
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2007-02-24:
+    - Makefile: add --remove-destination , so that "make plugins" does not
+      disturb a running vdr.
+    - softlog: added indicator for priority I(nfo), E(rror), D(ebug), T(race).
+    - video-vidix: shifted prints via softlog.
  2007-02-13:
     - fix gettid compile error on some systems.

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** Makefile	10 Feb 2007 00:02:14 -0000	1.36
--- Makefile	24 Feb 2007 14:04:14 -0000	1.37
***************
*** 28,31 ****
--- 28,34 ----
  PLUGINLIBDIR = ./PLUGINS/lib
  
+ # for older file-utils, option -f had the same effect
+ CPOPTS = --remove-destination
+ 
  -include config.mak
  
***************
*** 324,328 ****
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  ifdef USE_SUBPLUGINS
--- 327,331 ----
  libvdr-$(PLUGIN).so: $(OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
! 	@cp $(CPOTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  ifdef USE_SUBPLUGINS
***************
*** 330,350 ****
  lib$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-shm.so: $(SHM_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
! 	@cp $@ $(LIBDIR)/$@.$(APIVERSION)
  
  endif
--- 333,353 ----
  lib$(PLUGIN)-dfb.so: $(DFB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
! 	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-fb.so: $(FB_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
! 	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-xv.so: $(XV_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
! 	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
! 	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  lib$(PLUGIN)-shm.so: $(SHM_OBJS)
  	$(CXX) $(CXXFLAGS) -shared $(SHM_OBJS) $(SHM_LIBS) -o $@
! 	@cp $(CPOPTS) $@ $(LIBDIR)/$@.$(APIVERSION)
  
  endif

Index: setup-softlog.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -C2 -d -r1.3 -r1.4
*** setup-softlog.c	13 Feb 2007 20:03:59 -0000	1.3
--- setup-softlog.c	24 Feb 2007 14:04:14 -0000	1.4
***************
*** 64,67 ****
--- 64,82 ----
  /* ---------------------------------------------------------------------------
   */
+ char cSetupSoftlog::Priority2Char(int priority)
+ {
+   if (priority & SOFT_LOG_TRACE)
+     return 'T';
+   if (priority & SOFT_LOG_ERROR)
+     return 'E';
+   if (priority & SOFT_LOG_INFO)
+     return 'I';
+   if (priority & SOFT_LOG_DEBUG)
+     return 'D';
+   return '?';
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cSetupSoftlog::CloseLogFile()
  {
***************
*** 208,213 ****
      gettimeofday(&now, NULL);
      tmp = localtime(&now.tv_sec);
!     snprintf(fmt, sizeof(fmt), "%02d:%02d:%02d.%04d [%ld] %s",
               tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
               syscall(__NR_gettid), format);
      vfprintf(logFile, fmt, argList);
--- 223,229 ----
      gettimeofday(&now, NULL);
      tmp = localtime(&now.tv_sec);
!     snprintf(fmt, sizeof(fmt), "%02d:%02d:%02d.%04d %c [%ld] %s",
               tmp->tm_hour, tmp->tm_min, tmp->tm_sec, (int) now.tv_usec/1000,
+              Priority2Char(currPriority),
               syscall(__NR_gettid), format);
      vfprintf(logFile, fmt, argList);

Index: setup-softlog.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.h,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** setup-softlog.h	11 Feb 2007 10:31:27 -0000	1.2
--- setup-softlog.h	24 Feb 2007 14:04:14 -0000	1.3
***************
*** 37,40 ****
--- 37,41 ----
      int   IsEnabled(int priority),
            LogPriority(int priority);
+     char  Priority2Char(int priority);
      void  CloseLogFile();
  

Index: video-vidix.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-vidix.c,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** video-vidix.c	11 Nov 2006 08:45:17 -0000	1.24
--- video-vidix.c	24 Feb 2007 14:04:14 -0000	1.25
***************
*** 36,40 ****
  
      if ((fbdev = open(fbName, O_RDWR)) == -1) {
!         esyslog("[cVidixVideoOut] Can't open framebuffer exiting\n");
          free(fbName);
          exit(1);
--- 36,41 ----
  
      if ((fbdev = open(fbName, O_RDWR)) == -1) {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                   "[cVidixVideoOut] Can't open framebuffer exiting\n");
          free(fbName);
          exit(1);
***************
*** 43,51 ****
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         esyslog("[cVidixVideoOut] Can't get VSCREENINFO exiting\n");
          exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         esyslog("[cVidixVideoOut] Can't get FSCREENINFO exiting\n");
          exit(1);
      }
--- 44,54 ----
  
      if (ioctl(fbdev, FBIOGET_VSCREENINFO, &fb_vinfo)) {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                   "[cVidixVideoOut] Can't get VSCREENINFO exiting\n");
          exit(1);
      }
      if (ioctl(fbdev, FBIOGET_FSCREENINFO, &fb_finfo)) {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                   "[cVidixVideoOut] Can't get FSCREENINFO exiting\n");
          exit(1);
      }
***************
*** 54,58 ****
  
         case FB_VISUAL_TRUECOLOR:
!            printf("cVidixVideoOut: Truecolor FB found\n");
             break;
  
--- 57,62 ----
  
         case FB_VISUAL_TRUECOLOR:
!            setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                      "[cVidixVideoOut] Truecolor FB found\n");
             break;
  
***************
*** 62,66 ****
             __u16 red[256], green[256], blue[256];
  
!            printf("cVidixVideoOut: DirectColor FB found\n");
  
             orig_cmaplen = 256;
--- 66,71 ----
             __u16 red[256], green[256], blue[256];
  
!            setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                      "[cVidixVideoOut] DirectColor FB found\n");
  
             orig_cmaplen = 256;
***************
*** 68,72 ****
  
             if ( orig_cmap == NULL ) {
!                esyslog("[cVidixVideoOut] Can't alloc memory for cmap exiting\n");
                 exit(1);
             }
--- 73,78 ----
  
             if ( orig_cmap == NULL ) {
!                setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                          "[cVidixVideoOut] Can't alloc memory for cmap exiting\n");
                 exit(1);
             }
***************
*** 79,83 ****
  
             if ( ioctl(fbdev, FBIOGETCMAP, &cmap)) {
!                printf("cVidixVideoOut: Can't get cmap\n");
             }
  
--- 85,90 ----
  
             if ( ioctl(fbdev, FBIOGETCMAP, &cmap)) {
!                setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                          "[cVidixVideoOut] Can't get cmap\n");
             }
  
***************
*** 94,98 ****
  
             if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                printf("cVidixVideoOut: Can't put cmap\n");
             }
  
--- 101,106 ----
  
             if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                          "[cVidixVideoOut] Can't put cmap\n");
             }
  
***************
*** 100,104 ****
  
         default:
!            printf("cVidixVideoOut: Unsupported FB. Don't know if it will work.\n");
      }
  
--- 108,113 ----
  
         default:
!            setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                      "[cVidixVideoOut] Unsupported FB. Don't know if it will work.\n");
      }
  
***************
*** 121,132 ****
      SetParValues(displayRatio, displayRatio);
  
!     printf("cVidixVideoOut: xres = %d yres= %d \n", fb_vinfo.xres, fb_vinfo.yres);
!     printf("cVidixVideoOut: line length = %d \n", fb_line_len);
!     printf("cVidixVideoOut: bpp = %d\n", fb_vinfo.bits_per_pixel);
  
      fb = (uint8_t *) mmap(0, fb_finfo.smem_len, PROT_READ | PROT_WRITE, MAP_SHARED, fbdev, 0);
  
      if ( fb == (uint8_t *) -1 ) {
!        esyslog("[cVidixVideoOut] Can't mmap framebuffer memory exiting\n");
         exit(1);
       }
--- 130,145 ----
      SetParValues(displayRatio, displayRatio);
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] xres = %d yres= %d \n", fb_vinfo.xres, fb_vinfo.yres);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] line length = %d \n", fb_line_len);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] bpp = %d\n", fb_vinfo.bits_per_pixel);
  
      fb = (uint8_t *) mmap(0, fb_finfo.smem_len, PROT_READ | PROT_WRITE, MAP_SHARED, fbdev, 0);
  
      if ( fb == (uint8_t *) -1 ) {
!        setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                  "[cVidixVideoOut] Can't mmap framebuffer memory exiting\n");
         exit(1);
       }
***************
*** 136,140 ****
      vidix_version = vdlGetVersion();
  
!     printf("cVidixVideoOut: vidix version: %i\n", vidix_version);
  
      vidix_handler = vdlOpen(VIDIX_DIR, NULL, TYPE_OUTPUT, 0);
--- 149,154 ----
      vidix_version = vdlGetVersion();
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] vidix version: %i\n", vidix_version);
  
      vidix_handler = vdlOpen(VIDIX_DIR, NULL, TYPE_OUTPUT, 0);
***************
*** 142,146 ****
      if( !vidix_handler )
      {
!        esyslog("[cVidixVideoOut] Couldn't find working VIDIX driver exiting\n");
         exit(1);
      }
--- 156,161 ----
      if( !vidix_handler )
      {
!        setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                  "[cVidixVideoOut] Couldn't find working VIDIX driver exiting\n");
         exit(1);
      }
***************
*** 148,156 ****
      if( (err = vdlGetCapability(vidix_handler,&vidix_cap)) != 0)
      {
!        esyslog("[cVidixVideoOut] Couldn't get capability: %s exiting\n",
!                strerror(err) );
         exit(1);
      }
!     printf("cVidixVideoOut: capabilities:  0x%0x\n", vidix_cap.flags );
  
      OSDpseudo_alpha = true;
--- 163,173 ----
      if( (err = vdlGetCapability(vidix_handler,&vidix_cap)) != 0)
      {
!        setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                  "[cVidixVideoOut] Couldn't get capability: %s exiting\n",
!                  strerror(err) );
         exit(1);
      }
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] capabilities:  0x%0x\n", vidix_cap.flags );
  
      OSDpseudo_alpha = true;
***************
*** 170,174 ****
        if (!MatchPixelFormat())
        {
!         esyslog("[cVidixVideoOut]: no matching pixel format found exiting\n");
          exit(1);
        }
--- 187,192 ----
        if (!MatchPixelFormat())
        {
!         setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                   "[cVidixVideoOut] no matching pixel format found exiting\n");
          exit(1);
        }
***************
*** 193,197 ****
      vidix_play.num_frames   = 2;
  
!     printf("cVidixVideoOut: fourcc.flags:  0x%0x\n",vidix_fourcc.flags);
      AllocLayer();
  
--- 211,216 ----
      vidix_play.num_frames   = 2;
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] fourcc.flags:  0x%0x\n",vidix_fourcc.flags);
      AllocLayer();
  
***************
*** 200,232 ****
       */
      vidix_video_eq_t tmpeq;
!     printf("cVidixVideoOut: capabilities  ");
  
      if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {
          vidix_curr_eq=tmpeq;
!         printf("EQ cap: %x: ", vidix_curr_eq.cap);
          if (vidix_curr_eq.cap & VEQ_CAP_BRIGHTNESS) {
!             printf("brightness (%d) ", vidix_curr_eq.brightness);
              setupStore->vidCaps |= CAP_BRIGHTNESS;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_CONTRAST) {
!             printf("contrast (%d) ", vidix_curr_eq.contrast);
              setupStore->vidCaps |= CAP_CONTRAST;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_SATURATION) {
!             printf("saturation (%d) ", vidix_curr_eq.saturation);
              setupStore->vidCaps |= CAP_SATURATION;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_HUE) {
!             printf("hue (%d) ", vidix_curr_eq.hue);
              setupStore->vidCaps |= CAP_HUE;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_RGB_INTENSITY) {
!             printf("RGB-intensity (%d, %d, %d) ",
!                    vidix_curr_eq.red_intensity,
!                    vidix_curr_eq.green_intensity,
!                    vidix_curr_eq.blue_intensity );
          }
      } else {
!        isyslog("[cVidixVideoOut] Couldn't get EQ capability\n");
      }
  
--- 219,264 ----
       */
      vidix_video_eq_t tmpeq;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] capabilities\n");
  
      if(!vdlPlaybackGetEq(vidix_handler, &tmpeq)) {
          vidix_curr_eq=tmpeq;
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                   "[cVidixVideoOut] EQ cap: %x:\n",
!                   vidix_curr_eq.cap);
          if (vidix_curr_eq.cap & VEQ_CAP_BRIGHTNESS) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                       "[cVidixVideoOut]  brightness (%d)\n",
!                       vidix_curr_eq.brightness);
              setupStore->vidCaps |= CAP_BRIGHTNESS;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_CONTRAST) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                       "[cVidixVideoOut]  contrast (%d)\n",
!                       vidix_curr_eq.contrast);
              setupStore->vidCaps |= CAP_CONTRAST;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_SATURATION) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                       "[cVidixVideoOut]  saturation (%d)\n",
!                       vidix_curr_eq.saturation);
              setupStore->vidCaps |= CAP_SATURATION;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_HUE) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                       "[cVidixVideoOut]  hue (%d)\n",
!                       vidix_curr_eq.hue);
              setupStore->vidCaps |= CAP_HUE;
          }
          if (vidix_curr_eq.cap & VEQ_CAP_RGB_INTENSITY) {
!             setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                       "[cVidixVideoOut]  RGB-intensity (%d, %d, %d)\n",
!                       vidix_curr_eq.red_intensity,
!                       vidix_curr_eq.green_intensity,
!                       vidix_curr_eq.blue_intensity );
          }
      } else {
!        setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                  "[cVidixVideoOut] Couldn't get EQ capability\n");
      }
  
***************
*** 238,249 ****
      if (!vdlPlaybackGetDeint(vidix_handler, &vidix_deint) &&
          !vdlPlaybackSetDeint(vidix_handler, &vidix_deint)) {
!         printf("HW-deinterlace (%x,%x)",
!                vidix_deint.flags,
!                vidix_deint.deinterlace_pattern);
  
          setupStore->vidCaps |= CAP_HWDEINTERLACE;
      }
- 
-     printf("\n");
  }
  
--- 270,280 ----
      if (!vdlPlaybackGetDeint(vidix_handler, &vidix_deint) &&
          !vdlPlaybackSetDeint(vidix_handler, &vidix_deint)) {
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                   "[cVidixVideoOut]  HW-deinterlace (%x,%x)\n",
!                   vidix_deint.flags,
!                   vidix_deint.deinterlace_pattern);
  
          setupStore->vidCaps |= CAP_HWDEINTERLACE;
      }
  }
  
***************
*** 283,294 ****
      cutBottom = setupStore->cropBottomLines;
  
!     printf("cVidixVideoOut: Video changed format to %dx%d\n", fwidth, fheight);
  
      if((Xres > fwidth || Yres > fheight) &&
         (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
      {
!       esyslog("[cVidixVideoOut] vidix driver can't "
!               "upscale image (%dx%d -> %dx%d) exiting\n",
!               fwidth, fheight, Xres, Yres);
        exit(1);
      }
--- 314,328 ----
      cutBottom = setupStore->cropBottomLines;
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] Video changed format to %dx%d\n",
!               fwidth, fheight);
  
      if((Xres > fwidth || Yres > fheight) &&
         (vidix_cap.flags & FLAG_UPSCALER) != FLAG_UPSCALER)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                 "[cVidixVideoOut] vidix driver can't "
!                 "upscale image (%dx%d -> %dx%d) exiting\n",
!                 fwidth, fheight, Xres, Yres);
        exit(1);
      }
***************
*** 297,303 ****
         (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
      {
!       esyslog("[cVidixVideoOut] vidix driver can't "
!               "downscale image (%dx%d -> %dx%d) exiting\n",
!               fwidth, fheight, Xres, Yres);
        exit(1);
      }
--- 331,338 ----
         (vidix_cap.flags & FLAG_DOWNSCALER) != FLAG_DOWNSCALER)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                 "[cVidixVideoOut] vidix driver can't "
!                 "downscale image (%dx%d -> %dx%d) exiting\n",
!                 fwidth, fheight, Xres, Yres);
        exit(1);
      }
***************
*** 317,321 ****
          if (!MatchPixelFormat())
          {
!           esyslog("[cVidixVideoOut]: no matching pixel format found exiting\n");
            exit(1);
          }
--- 352,358 ----
          if (!MatchPixelFormat())
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                     "[cVidixVideoOut]: no matching pixel "
!                     "format found exiting\n");
            exit(1);
          }
***************
*** 368,377 ****
        vidix_curr_eq.hue != vidix_video_eq.hue ) {
  
!       printf("cVidixVideoOut : set eq values\n");
        vidix_curr_eq = vidix_video_eq;
        if( (err = vdlPlaybackSetEq(vidix_handler, &vidix_curr_eq)) != 0) {
!           isyslog("[cVidixVideoOut] Couldn't set EQ capability: %s\n",
!                   strerror(err) );
!           printf("FAILED!!!\n");
        }
    }
--- 405,416 ----
        vidix_curr_eq.hue != vidix_video_eq.hue ) {
  
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[cVidixVideoOut] set eq values\n");
        vidix_curr_eq = vidix_video_eq;
        if( (err = vdlPlaybackSetEq(vidix_handler, &vidix_curr_eq)) != 0) {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                     "[cVidixVideoOut] Couldn't set EQ "
!                     "capability: %s (FAILED)\n",
!                     strerror(err) );
        }
    }
***************
*** 421,427 ****
        vdlPlaybackSetDeint(vidix_handler, &vidix_deint);
        vdlPlaybackGetDeint(vidix_handler, &vidix_deint);
!       printf("Deinterlacer: %x %x\n",
!              vidix_deint.flags,
!              vidix_deint.deinterlace_pattern);
    }
  }
--- 460,467 ----
        vdlPlaybackSetDeint(vidix_handler, &vidix_deint);
        vdlPlaybackGetDeint(vidix_handler, &vidix_deint);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[cVidixVideoOut] Deinterlacer: %x %x\n",
!                 vidix_deint.flags,
!                 vidix_deint.deinterlace_pattern);
    }
  }
***************
*** 440,445 ****
    if ((err = vdlPlaybackOff(vidix_handler)) != 0)
    {
!     esyslog("[cVidixVideoOut] Can't stop playback: %s exiting\n",
!             strerror(err));
      exit(1);
    }
--- 480,486 ----
    if ((err = vdlPlaybackOff(vidix_handler)) != 0)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[cVidixVideoOut] Can't stop playback: %s exiting\n",
!               strerror(err));
      exit(1);
    }
***************
*** 447,452 ****
    if ((err = vdlConfigPlayback(vidix_handler, &vidix_play)) != 0)
    {
!     esyslog("[cVidixVideoOut] Can't configure playback: %s exiting\n",
!             strerror(err));
      exit(1);
    }
--- 488,494 ----
    if ((err = vdlConfigPlayback(vidix_handler, &vidix_play)) != 0)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                "[cVidixVideoOut] Can't configure playback: %s exiting\n",
!                strerror(err));
      exit(1);
    }
***************
*** 454,459 ****
    if ((err = vdlPlaybackOn(vidix_handler)) != 0)
    {
!     esyslog("[cVidixVideoOut] Can't start playback: %s exiting\n",
!             strerror(err));
      exit(1);
    }
--- 496,502 ----
    if ((err = vdlPlaybackOn(vidix_handler)) != 0)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[cVidixVideoOut] Can't start playback: %s exiting\n",
!               strerror(err));
      exit(1);
    }
***************
*** 463,467 ****
      int res = 0;
  
!     printf("cVidixVideoOut: set colorkey ");
      vdlGetGrKeys(vidix_handler, &gr_key);
  
--- 506,511 ----
      int res = 0;
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] set colorkey\n");
      vdlGetGrKeys(vidix_handler, &gr_key);
  
***************
*** 479,491 ****
      gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
      res = vdlSetGrKeys(vidix_handler, &gr_key);
!     printf ("vdlSetGrKeys() = %d, ", res);
  
      if (res) {
        gr_key.ckey.op = CKEY_TRUE;
        res = vdlSetGrKeys(vidix_handler, &gr_key);
!       printf (" - %d", res);
        useVidixAlpha = false;
      }
-     printf ("\n");
    }
  
--- 523,536 ----
      gr_key.ckey.red = gr_key.ckey.green = gr_key.ckey.blue = 0;
      res = vdlSetGrKeys(vidix_handler, &gr_key);
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[cVidixVideoOut] vdlSetGrKeys() = %d\n", res);
  
      if (res) {
        gr_key.ckey.op = CKEY_TRUE;
        res = vdlSetGrKeys(vidix_handler, &gr_key);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[cVidixVideoOut] vdlSetGrKeys() = %d (noAlpha)\n", res);
        useVidixAlpha = false;
      }
    }
  
***************
*** 750,754 ****
   */
  void cVidixVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                      int &xPan, int &yPan) {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
--- 795,800 ----
   */
  void cVidixVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                      int &xPan, int &yPan)
! {
     switch (current_osdMode) {
        case OSDMODE_PSEUDO :
***************
*** 763,768 ****
                  yPan = syoff;
               break;
!     };
! };
  
  
--- 809,814 ----
                  yPan = syoff;
               break;
!     }
! }
  
  
***************
*** 800,808 ****
      int err;
  
!     printf("cVidixVideoOut : destructor\n");
  
      if(vidix_handler) {
          if((err = vdlPlaybackOff(vidix_handler)) != 0) {
!            printf("cVidixVideoOut : Can't stop playback: %s\n", strerror(err));
          }
          vdlClose(vidix_handler);
--- 846,857 ----
      int err;
  
!     setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!               "[cVidixVideoOut] destructor\n");
  
      if(vidix_handler) {
          if((err = vdlPlaybackOff(vidix_handler)) != 0) {
!            setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                      "[cVidixVideoOut] Can't stop playback: %s\n",
!                      strerror(err));
          }
          vdlClose(vidix_handler);
***************
*** 823,827 ****
  
                 if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                    printf("cVidixVideoOut : Can't put cmap\n");
                 }
  
--- 872,877 ----
  
                 if ( ioctl(fbdev, FBIOPUTCMAP, &cmap)) {
!                    setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                              "[cVidixVideoOut] Can't put cmap\n");
                 }
  



From nobody at sheep.berlios.de  Mon Feb 26 22:02:50 2007
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 26 Feb 2007 22:02:50 +0100 (CET)
Subject: [Softdevice-cvs] softdevice setup-softlog.c,1.4,1.5
Message-ID: <20070226210250.4639161C55@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24795

Modified Files:
	setup-softlog.c 
Log Message:
sanitycheck for zero length filenames and fix use filename member
when changeing append mode


Index: setup-softlog.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softlog.c,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** setup-softlog.c	24 Feb 2007 14:04:14 -0000	1.4
--- setup-softlog.c	26 Feb 2007 21:01:14 -0000	1.5
***************
*** 132,137 ****
  
    if (newMode != appendPID) {
      appendPID = newMode;
!     SetLogFile(logFileName);
    }
  
--- 132,140 ----
  
    if (newMode != appendPID) {
+       char *oldName = strdup (logFileName);
+ 
      appendPID = newMode;
!     SetLogFile(oldName);
!     free (oldName);
    }
  
***************
*** 151,154 ****
--- 154,165 ----
  {
    /* -------------------------------------------------------------------------
+    * Ignore zero length file names
+    */
+   if (!strlen (fileName)) {
+     Log (SOFT_LOG_ERROR, 0, "[softlog] ignoring zero length fileName\n");
+     return 0;
+   }
+ 
+   /* -------------------------------------------------------------------------
     * Don't close stderr. Handle fileName "stderr" special so that it is
     * possible to switch back from file logging to stderr.
***************
*** 168,179 ****
  
      if (!(logFile = fopen (realName, "w+"))) {
-       syslog(LOG_ERR,
-              "[softlog] could not open logfile (%s), using stderr",
-              realName);
-       fprintf(stderr,
-               "[softlog] could not open logfile (%s), using stderr",
-               realName);
        logFile = stderr;
        logFileName = strdup("stderr");
        return 0;
      }
--- 179,188 ----
  
      if (!(logFile = fopen (realName, "w+"))) {
        logFile = stderr;
        logFileName = strdup("stderr");
+ 
+       Log (SOFT_LOG_ERROR, 0,
+               "[softlog] X could not open logfile (%s) len %d %s, using stderr\n",
+               realName, strlen (fileName), fileName);
        return 0;
      }



From nobody at sheep.berlios.de  Mon Feb 26 22:06:12 2007
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 26 Feb 2007 22:06:12 +0100 (CET)
Subject: [Softdevice-cvs] softdevice video-dfb.c, 1.77, 1.78 video-dfb.h,
	1.24, 1.25
Message-ID: <20070226210612.D49C1D6364@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv24972

Modified Files:
	video-dfb.c video-dfb.h 
Log Message:
shifted most prints, via softlog now

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.77
retrieving revision 1.78
diff -C2 -d -r1.77 -r1.78
*** video-dfb.c	27 Jan 2007 09:50:58 -0000	1.77
--- video-dfb.c	26 Feb 2007 21:04:32 -0000	1.78
***************
*** 174,202 ****
  /* ---------------------------------------------------------------------------
   */
- static void reportSurfaceCapabilities (char *name, IDirectFBSurface *surf)
- {
-     DFBSurfaceCapabilities        scaps;
- 
-   scaps = surf->GetCapabilities();
-   fprintf(stderr,"[surface capabilities] %s: ", name);
- 
-   if (scaps == DSCAPS_NONE) fprintf(stderr,"none ");
-   if (scaps & DSCAPS_PRIMARY) fprintf(stderr,"primary ");
-   if (scaps & DSCAPS_SYSTEMONLY) fprintf(stderr,"systemonly ");
-   if (scaps & DSCAPS_VIDEOONLY) fprintf(stderr,"videoonly ");
-   if (scaps & DSCAPS_DOUBLE) fprintf(stderr,"double-buffered ");
-   if (scaps & DSCAPS_FLIPPING) fprintf(stderr,"flipping ");
-   if (scaps & DSCAPS_SUBSURFACE) fprintf(stderr,"subsurface ");
-   if (scaps & DSCAPS_INTERLACED) fprintf(stderr,"interlaced ");
-   if (scaps & DSCAPS_SEPARATED) fprintf(stderr,"separated ");
-   if (scaps & DSCAPS_STATIC_ALLOC) fprintf(stderr,"static-alloc ");
-   if (scaps & DSCAPS_TRIPLE) fprintf(stderr,"triple-buffered ");
- 
-   fprintf(stderr, "PixelFormat = 0x%08x ", surf->GetPixelFormat());
-   fprintf(stderr,"\n");
- }
- 
- /* ---------------------------------------------------------------------------
-  */
  // List Video Modes
  static DFBEnumerationResult EnumVideoModeCallback(int x, int y, int bpp, void *data)
--- 174,177 ----
***************
*** 208,263 ****
  /* ---------------------------------------------------------------------------
   */
- static void BESColorkeyState(IDirectFBDisplayLayer *layer, bool state)
- {
-   if (layer)
-   {
-       DFBDisplayLayerConfig       dlc;
-     dlc.flags = DLCONF_OPTIONS;
-     dlc.options = (state) ? DLOP_DST_COLORKEY : DLOP_NONE;
-     try
-     {
-       layer->SetConfiguration(dlc);
-       layer->SetDstColorKey(COLORKEY);
-     }
-     catch (DFBException *ex)
-     {
-       fprintf (stderr,"[dfb] BES-%s: action=%s, result=%s\n",
-                (state) ? "ON" : "OFF",
-                ex->GetAction(), ex->GetResult());
-       delete ex;
-     }
-   }
- }
- 
- /* ---------------------------------------------------------------------------
-  */
- static void ReportLayerInfo(IDirectFBDisplayLayer *layer, char *name)
- {
-       DFBDisplayLayerConfig layerConfiguration;
- 
-   if (!layer)
-   {
-     fprintf (stderr, "[dfb] no layer info. layer == NULL\n");
-     return;
-   }
- 
-   layer->GetConfiguration(&layerConfiguration);
-   {
-     fprintf(stderr,
-             "[dfb] (%s): flags, options, pixelformat: %08x, %08x %08x\n",
-             name,
-             layerConfiguration.flags,
-             layerConfiguration.options,
-             layerConfiguration.pixelformat);
-     fprintf(stderr,
-             "[dfb] (%s): width, height:               %d %d\n",
-             name,
-             layerConfiguration.width,
-             layerConfiguration.height);
-   }
- }
- 
- /* ---------------------------------------------------------------------------
-  */
  cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore)
                : cVideoOut(setupStore)
--- 183,186 ----
***************
*** 265,269 ****
      tLayerSelectItem              *layerInfo;
  
!   fprintf(stderr,"[dfb] init\n");
    /* --------------------------------------------------------------------------
     * default settings: source, destination and logical widht/height
--- 188,192 ----
      tLayerSelectItem              *layerInfo;
  
!   setupStore->softlog->Log(SOFT_LOG_INFO, 0, "[dfb] init\n");
    /* --------------------------------------------------------------------------
     * default settings: source, destination and logical widht/height
***************
*** 298,302 ****
      reportCardInfo (dfb);
  
!     fprintf(stderr,"[dfb] Supported video Modes are: ");
      dfb->EnumVideoModes(EnumVideoModeCallback, NULL);
      fprintf(stderr,"\n");
--- 221,226 ----
      reportCardInfo (dfb);
  
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[dfb] Supported video Modes are:\n");
      dfb->EnumVideoModes(EnumVideoModeCallback, NULL);
      fprintf(stderr,"\n");
***************
*** 306,314 ****
       */
      DFBWrapper=dfb;
!     fprintf(stderr,"[dfb] Enumerating display Layers\n");
  
      osdLayer=dfb->GetDisplayLayer(DLID_PRIMARY);
      if (!osdLayer) {
!       fprintf(stderr,"[dfb] no OSD layer exiting\n");
        exit(EXIT_FAILURE);
      }
--- 230,240 ----
       */
      DFBWrapper=dfb;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[dfb] Enumerating display Layers\n");
  
      osdLayer=dfb->GetDisplayLayer(DLID_PRIMARY);
      if (!osdLayer) {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                 "[dfb] no OSD layer exiting\n");
        exit(EXIT_FAILURE);
      }
***************
*** 316,320 ****
      if (!setupStore->useMGAtv)
      {
!       fprintf(stderr,"[dfb] Configuring CooperativeLevel for OSD\n");
        osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
      }
--- 242,247 ----
      if (!setupStore->useMGAtv)
      {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] Configuring CooperativeLevel for OSD\n");
        osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
      }
***************
*** 343,347 ****
      if (setupStore->useMGAtv && !videoLayer) {
        layerInfo = &layerList [CRTC2_LAYER_OLD];
!       fprintf(stderr, "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
        dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
        videoLayer = layerInfo->layer;
--- 270,275 ----
      if (setupStore->useMGAtv && !videoLayer) {
        layerInfo = &layerList [CRTC2_LAYER_OLD];
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name\n");
        dfb->EnumDisplayLayers(EnumCallBack, layerInfo);
        videoLayer = layerInfo->layer;
***************
*** 350,354 ****
      if (!videoLayer)
      {
!       fprintf(stderr,"[dfb]: could not find suitable videolayer\n");
        exit(EXIT_FAILURE);
      }
--- 278,283 ----
      if (!videoLayer)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                 "[dfb]: could not find suitable videolayer\n");
        exit(EXIT_FAILURE);
      }
***************
*** 371,376 ****
  #ifdef HAVE_CLE266_MPEG_DECODER
          setupStore->cle266HWdecode = false;
!         fprintf(stderr,
!                 "[dfb] disabling hw-decode support for this layer\n");
  #endif
          currentPixelFormat = setupStore->pixelFormat = 2;
--- 300,305 ----
  #ifdef HAVE_CLE266_MPEG_DECODER
          setupStore->cle266HWdecode = false;
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                   "[dfb] disabling hw-decode support for this layer\n");
  #endif
          currentPixelFormat = setupStore->pixelFormat = 2;
***************
*** 383,389 ****
        else if (setupStore->cle266HWdecode) {
            if (!SetupCle266Buffers(swidth, sheight)) {
!               fprintf(stderr,
!                       "[dfb] Error allocating hardware buffers for "
!                       "CLE266 decoding: reverting to software decoding\n");
                setupStore->cle266HWdecode = false;
            } else {
--- 312,318 ----
        else if (setupStore->cle266HWdecode) {
            if (!SetupCle266Buffers(swidth, sheight)) {
!               setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                         "[dfb] Error allocating hardware buffers for "
!                         "CLE266 decoding: reverting to software decoding\n");
                setupStore->cle266HWdecode = false;
            } else {
***************
*** 402,410 ****
      ReportLayerInfo(osdLayer, "osdLayer");
      if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL) {
!       fprintf(stderr, "[dfb] osdLayer has alpha channel\n");
        osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
        videoLayerLevel = -1;
      } else {
!       fprintf(stderr, "[dfb] osdLayer without !! alpha channel\n");
      }
  
--- 331,341 ----
      ReportLayerInfo(osdLayer, "osdLayer");
      if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL) {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] osdLayer has alpha channel\n");
        osdLayerConfiguration.options = DLOP_ALPHACHANNEL;
        videoLayerLevel = -1;
      } else {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] osdLayer without !! alpha channel\n");
      }
  
***************
*** 419,423 ****
      scrSurface = osdLayer->GetSurface();
  
!     reportSurfaceCapabilities ("scrSurface", scrSurface);
  
      if (scrSurface)
--- 350,354 ----
      scrSurface = osdLayer->GetSurface();
  
!     ReportSurfaceCapabilities (scrSurface, "scrSurface");
  
      if (scrSurface)
***************
*** 427,433 ****
  
        scrSurface->GetSize(&Xres,&Yres);
!       fprintf (stderr,
!                "[dfb] width = %d, height = %d\n",
!                Xres, Yres);
        lwidth  = dwidth  = Xres;
        lheight = dheight = Yres;
--- 358,364 ----
  
        scrSurface->GetSize(&Xres,&Yres);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] width = %d, height = %d\n",
!                 Xres, Yres);
        lwidth  = dwidth  = Xres;
        lheight = dheight = Yres;
***************
*** 437,443 ****
  
        fmt = scrSurface->GetPixelFormat();
!       fprintf (stderr,
!                "[dfb] got fmt = 0x%08x bpp = %d\n",
!                fmt, DFB_BITS_PER_PIXEL(fmt));
        Bpp = DFB_BITS_PER_PIXEL(fmt);
  
--- 368,374 ----
  
        fmt = scrSurface->GetPixelFormat();
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] got fmt = 0x%08x bpp = %d\n",
!                 fmt, DFB_BITS_PER_PIXEL(fmt));
        Bpp = DFB_BITS_PER_PIXEL(fmt);
  
***************
*** 493,502 ****
        osdSurface->Clear(0,0,0,clearAlpha); //clear and
  
!       fprintf(stderr,
!               "[dfb] Using this layer for OSD: (%s - [%dx%d])\n",
!               osdLayerDescription.name,
!               osdSurface->GetWidth(), osdSurface->GetHeight());
  
!       reportSurfaceCapabilities ("osdSurface", osdSurface);
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
--- 424,433 ----
        osdSurface->Clear(0,0,0,clearAlpha); //clear and
  
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] Using this layer for OSD: (%s - [%dx%d])\n",
!                 osdLayerDescription.name,
!                 osdSurface->GetWidth(), osdSurface->GetHeight());
  
!       ReportSurfaceCapabilities (osdSurface, "osdSurface");
  
        vidDsc.flags = (DFBSurfaceDescriptionFlags) (DSDESC_CAPS |
***************
*** 511,515 ****
        if (!setupStore->useMGAtv)
        {
!         fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
--- 442,447 ----
        if (!setupStore->useMGAtv)
        {
!         setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                   "[dfb] Configuring CooperativeLevel for Overlay\n");
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
***************
*** 532,542 ****
        }
  
!       reportSurfaceCapabilities ("videoSurface", videoSurface);
  
!       fprintf(stderr,
!               "[dfb] Using this layer for OSD:        %s\n"
!               "[dfb] Using this layer for Video out:  %s\n",
!               osdLayerDescription.name,
!               videoLayerDescription.name);
      }
  
--- 464,475 ----
        }
  
!       ReportSurfaceCapabilities (videoSurface, "videoSurface");
  
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] Using this layer for OSD:        %s\n",
!                 osdLayerDescription.name);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "[dfb] Using this layer for Video out:  %s\n",
!                 videoLayerDescription.name);
      }
  
***************
*** 548,553 ****
    catch (DFBException *ex)
    {
!     fprintf (stderr,"[dfb] init EXITING:action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
      delete ex;
      exit(EXIT_FAILURE);
--- 481,487 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] init EXITING:action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
      exit(EXIT_FAILURE);
***************
*** 557,560 ****
--- 491,574 ----
  /* ---------------------------------------------------------------------------
   */
+ void cDFBVideoOut::ReportSurfaceCapabilities (IDirectFBSurface *surf,
+                                               char *name)
+ {
+     DFBSurfaceCapabilities        scaps;
+ 
+   scaps = surf->GetCapabilities();
+   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
+             "[dfb] surface capabilities for (%s): "
+             "%s%s%s%s%s%s%s%s%s%s%sPixelFormat = 0x%08x\n",
+             name,
+             (scaps == DSCAPS_NONE) ? "none, ": "",
+             (scaps & DSCAPS_PRIMARY) ? "primary, ": "",
+             (scaps & DSCAPS_SYSTEMONLY) ? "systemonly, ": "",
+             (scaps & DSCAPS_VIDEOONLY) ? "videoonly, ": "",
+             (scaps & DSCAPS_DOUBLE) ? "double-buffered, ": "",
+             (scaps & DSCAPS_FLIPPING) ? "flipping, ": "",
+             (scaps & DSCAPS_SUBSURFACE) ? "subsurface, ": "",
+             (scaps & DSCAPS_INTERLACED) ? "interlaced, ": "",
+             (scaps & DSCAPS_SEPARATED) ? "separated, ": "",
+             (scaps & DSCAPS_STATIC_ALLOC) ? "static-alloc, ": "",
+             (scaps & DSCAPS_TRIPLE) ? "triple-buffered, ": "",
+             surf->GetPixelFormat());
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cDFBVideoOut::BESColorkeyState(IDirectFBDisplayLayer *layer, bool state)
+ {
+   if (layer)
+   {
+       DFBDisplayLayerConfig       dlc;
+     dlc.flags = DLCONF_OPTIONS;
+     dlc.options = (state) ? DLOP_DST_COLORKEY : DLOP_NONE;
+     try
+     {
+       layer->SetConfiguration(dlc);
+       layer->SetDstColorKey(COLORKEY);
+     }
+     catch (DFBException *ex)
+     {
+       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
+                 "[dfb] BES-%s: action=%s, result=%s\n",
+                 (state) ? "ON" : "OFF",
+                 ex->GetAction(), ex->GetResult());
+       delete ex;
+     }
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cDFBVideoOut::ReportLayerInfo(IDirectFBDisplayLayer *layer, char *name)
+ {
+       DFBDisplayLayerConfig layerConfiguration;
+ 
+   if (!layer)
+   {
+     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
+               "[dfb] no layer info. layer == NULL\n");
+     return;
+   }
+ 
+   layer->GetConfiguration(&layerConfiguration);
+   {
+     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
+             "[dfb] (%s): flags, options, pixelformat: %08x, %08x %08x\n",
+             name,
+             layerConfiguration.flags,
+             layerConfiguration.options,
+             layerConfiguration.pixelformat);
+     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
+             "[dfb] (%s): width, height:               %d %d\n",
+             name,
+             layerConfiguration.width,
+             layerConfiguration.height);
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cDFBVideoOut::EnableFieldParity(IDirectFBDisplayLayer *layer)
  {
***************
*** 567,571 ****
                  (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
    dlc.buffermode = DLBM_TRIPLE;
!   fprintf(stderr,"[dfb] Set DLBM_TRIPLE for layer [%s]\n", desc.name);
  
    dlc.pixelformat = DSPF_ARGB;
--- 581,586 ----
                  (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
    dlc.buffermode = DLBM_TRIPLE;
!   setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!             "[dfb] Set DLBM_TRIPLE for layer [%s]\n", desc.name);
  
    dlc.pixelformat = DSPF_ARGB;
***************
*** 575,588 ****
    {
      dlc.options = DLOP_FIELD_PARITY;
!     fprintf(stderr,
!             "[dfb] DLOP_FIELD_PARITY supported by layer [%s]\n",
!             desc.name);
    }
    else
    {
      dlc.options = DLOP_NONE;
!     fprintf(stderr,
!             "[dfb] DLOP_FIELD_PARITY not supported by layer [%s]\n",
!             desc.name);
    }
  
--- 590,603 ----
    {
      dlc.options = DLOP_FIELD_PARITY;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[dfb] DLOP_FIELD_PARITY supported by layer [%s]\n",
!               desc.name);
    }
    else
    {
      dlc.options = DLOP_NONE;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[dfb] DLOP_FIELD_PARITY not supported by layer [%s]\n",
!               desc.name);
    }
  
***************
*** 597,602 ****
    catch(DFBException *ex)
    {
!     fprintf (stderr,"[dfb] EnableFieldParity: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 612,618 ----
    catch(DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] EnableFieldParity: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 621,626 ****
      catch (DFBException *ex)
      {
!       fprintf (stderr,"[dfb] GetDisplayFrameTime: action=%s, result=%s\n",
!                ex->GetAction(), ex->GetResult());
        delete ex;
        tv1.tv_sec = tv2.tv_sec = tv1.tv_usec = tv2.tv_usec = 0;
--- 637,643 ----
      catch (DFBException *ex)
      {
!       setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                 "[dfb] GetDisplayFrameTime: action=%s, result=%s\n",
!                 ex->GetAction(), ex->GetResult());
        delete ex;
        tv1.tv_sec = tv2.tv_sec = tv1.tv_usec = tv2.tv_usec = 0;
***************
*** 628,632 ****
      t1 = (tv1.tv_sec & 1) * 1000000 + tv1.tv_usec;
      t2 = (tv2.tv_sec & 1) * 1000000 + tv2.tv_usec;
!     fprintf (stderr,"[dfb] Display frame time is %d microseconds\n", t2 - t1);
      displayTimeUS = t2 - t1;
    }
--- 645,650 ----
      t1 = (tv1.tv_sec & 1) * 1000000 + tv1.tv_usec;
      t2 = (tv2.tv_sec & 1) * 1000000 + tv2.tv_usec;
!     setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!               "[dfb] Display frame time is %d microseconds\n", t2 - t1);
      displayTimeUS = t2 - t1;
    }
***************
*** 711,717 ****
        cutRight  = setupStore->cropRightCols;
  
!       fprintf(stderr,
!               "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
!               fwidth,fheight,swidth,sheight);
        dlc.flags   = (DFBDisplayLayerConfigFlags)(DLCONF_WIDTH | DLCONF_HEIGHT | DLCONF_PIXELFORMAT | DLCONF_OPTIONS);
  
--- 729,735 ----
        cutRight  = setupStore->cropRightCols;
  
!       setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                 "[dfb] (re)configuring Videolayer to %d x %d (%dx%d)\n",
!                 fwidth,fheight,swidth,sheight);
        dlc.flags   = (DFBDisplayLayerConfigFlags)(DLCONF_WIDTH | DLCONF_HEIGHT | DLCONF_PIXELFORMAT | DLCONF_OPTIONS);
  
***************
*** 815,820 ****
            catch (DFBException *ex)
            {
!             fprintf (stderr,"[dfb] SetParams: action=%s, result=%s Failed: SetLevel()\n",
!                      ex->GetAction(), ex->GetResult());
              delete ex;
            }
--- 833,839 ----
            catch (DFBException *ex)
            {
!             setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                       "[dfb] SetParams: action=%s, result=%s Failed: SetLevel()\n",
!                       ex->GetAction(), ex->GetResult());
              delete ex;
            }
***************
*** 843,847 ****
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
!           fprintf(stderr, "[dfb] SetParams: Enabling DLOP_FIELD_PARITY\n");
          }
          /*
--- 862,867 ----
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
!           setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                     "[dfb] SetParams: Enabling DLOP_FIELD_PARITY\n");
          }
          /*
***************
*** 865,870 ****
              if (failed & DLCONF_BUFFERMODE)
              {
!               fprintf(stderr, "[dfb]: SetParms (): failed to set buffermode "
!                       "to triple, will try back video\n");
                dlc.buffermode = DLBM_UNKNOWN;
              }
--- 885,891 ----
              if (failed & DLCONF_BUFFERMODE)
              {
!               setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                         "[dfb]: SetParms (): failed to set buffermode "
!                         "to triple, will try back video\n");
                dlc.buffermode = DLBM_UNKNOWN;
              }
***************
*** 883,894 ****
              if (failed & DLCONF_BUFFERMODE)
              {
!               fprintf(stderr, "[dfb]: SetParams: failed to set buffermode "
                        "to back video, reverting to normal\n");
                dlc.buffermode = DLBM_FRONTONLY;
              } else {
!               fprintf(stderr,
!                       "[dfb]: Testconfiguration failed flags: %08x "
!                       "(disabling failed flags)\n",
!                       failed);
                dlc.flags = (DFBDisplayLayerConfigFlags) (dlc.flags & ~failed);
              }
--- 904,916 ----
              if (failed & DLCONF_BUFFERMODE)
              {
!               setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                       "[dfb]: SetParams: failed to set buffermode "
                        "to back video, reverting to normal\n");
                dlc.buffermode = DLBM_FRONTONLY;
              } else {
!               setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                         "[dfb]: Testconfiguration failed flags: %08x "
!                         "(disabling failed flags)\n",
!                         failed);
                dlc.flags = (DFBDisplayLayerConfigFlags) (dlc.flags & ~failed);
              }
***************
*** 909,914 ****
          catch (DFBException *ex)
          {
!           fprintf (stderr,"[dfb] SetParams: action=%s, result=%s\n",
!                    ex->GetAction(), ex->GetResult());
            delete ex;
          }
--- 931,937 ----
          catch (DFBException *ex)
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                     "[dfb] SetParams: action=%s, result=%s\n",
!                     ex->GetAction(), ex->GetResult());
            delete ex;
          }
***************
*** 929,936 ****
            catch (DFBException *ex)
            {
!             fprintf (stderr,
!                      "[dfb] SetParams() SetScreenLocation(): "
!                      "action=%s, result=%s\n",
!                      ex->GetAction(), ex->GetResult());
              delete ex;
            }
--- 952,959 ----
            catch (DFBException *ex)
            {
!             setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                       "[dfb] SetParams() SetScreenLocation(): "
!                       "action=%s, result=%s\n",
!                       ex->GetAction(), ex->GetResult());
              delete ex;
            }
***************
*** 938,942 ****
          else
          {
!           fprintf(stderr,"Can't configure ScreenLocation. Hope it is Fullscreen\n");
          }
  
--- 961,966 ----
          else
          {
!           setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                     "Can't configure ScreenLocation. Hope it is Fullscreen\n");
          }
  
***************
*** 955,960 ****
          catch (DFBException *ex)
          {
!           fprintf (stderr, "[dfb] SetParams (a) EXITING: action=%s, result=%s\n",
!                    ex->GetAction(), ex->GetResult());
            delete ex;
            exit(EXIT_FAILURE);
--- 979,985 ----
          catch (DFBException *ex)
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                     "[dfb] SetParams (a) EXITING: action=%s, result=%s\n",
!                     ex->GetAction(), ex->GetResult());
            delete ex;
            exit(EXIT_FAILURE);
***************
*** 963,967 ****
        else
        {
!         fprintf (stderr, "[dfb] creating new surface (stretchBlit)\n");
          try
          {
--- 988,993 ----
        else
        {
!         setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                   "[dfb] creating new surface (stretchBlit)\n");
          try
          {
***************
*** 1005,1022 ****
          catch (DFBException *ex)
          {
!           fprintf (stderr, "[dfb] SetParams (b) EXITING: action=%s, result=%s\n",
!                    ex->GetAction(), ex->GetResult());
            delete ex;
            exit(EXIT_FAILURE);
          }
        }
!       reportSurfaceCapabilities ("videoSurface", videoSurface);
  
!       fprintf(stderr,"[dfb] (re)configured 0x%08x\n",pixelformat);
      }
    }
    else
    {
!     fprintf(stderr,"No Videolayer available. Exiting...\n");
      exit(EXIT_FAILURE);
    }
--- 1031,1051 ----
          catch (DFBException *ex)
          {
!           setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                     "[dfb] SetParams (b) EXITING: action=%s, result=%s\n",
!                     ex->GetAction(), ex->GetResult());
            delete ex;
            exit(EXIT_FAILURE);
          }
        }
!       ReportSurfaceCapabilities (videoSurface, "videoSurface");
  
!       setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                 "[dfb] (re)configured 0x%08x\n",pixelformat);
      }
    }
    else
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "No Videolayer available. Exiting...\n");
      exit(EXIT_FAILURE);
    }
***************
*** 1048,1053 ****
    catch (DFBException *ex)
    {
!     fprintf (stderr,"[dfb] OpenOSD: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 1077,1083 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] OpenOSD: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 1070,1075 ****
    catch (DFBException *ex)
    {
!     fprintf (stderr,"[dfb] OSDStart: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 1100,1106 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] OSDStart: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 1104,1109 ****
    catch (DFBException *ex)
    {
!     fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
!         ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 1135,1141 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] Refresh: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 1152,1157 ****
    catch (DFBException *ex)
    {
!     fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
!         ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 1184,1190 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] Refresh: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 1225,1230 ****
    catch (DFBException *ex)
    {
!     fprintf (stderr,"[dfb] CloseOSD: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 1258,1264 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] CloseOSD: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 1433,1438 ****
    }
    catch (DFBException *ex) {
!     fprintf (stderr, "[dfb] YUV: action=%s, result=%s\n",
!              ex->GetAction(), ex->GetResult());
      delete ex;
    }
--- 1467,1473 ----
    }
    catch (DFBException *ex) {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "[dfb] YUV: action=%s, result=%s\n",
!               ex->GetAction(), ex->GetResult());
      delete ex;
    }
***************
*** 1449,1460 ****
    char *fbName = getFBName();
  
-   fprintf(stderr, "Initialising CLE266 decoder (%s): ", fbName);
    if (!CLE266MPEGInitialise(fbName)) {
!       fprintf(stderr, "failed!\n");
        free(fbName);
        return false;
    } else {
        free(fbName);
!       fprintf(stderr, "success!\n");
    }
  
--- 1484,1496 ----
    char *fbName = getFBName();
  
    if (!CLE266MPEGInitialise(fbName)) {
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "Initialising CLE266 decoder (%s): failed!\n", fbName);
        free(fbName);
        return false;
    } else {
        free(fbName);
!       setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!                 "Initialising CLE266 decoder (%s): success!\n", fbName);
    }
  
***************
*** 1470,1474 ****
  
  /* Create the 4 MPEG buffers for decoding */
!   fprintf(stderr, "CLE266: Creating buffers for decoder\n");
    for (int j=0; j < LAST_PICBUF; j++)
            mpegfb[j]=NULL;
--- 1506,1511 ----
  
  /* Create the 4 MPEG buffers for decoding */
!   setupStore->softlog->Log(SOFT_LOG_INFO, 0,
!             "CLE266: Creating buffers for decoder\n");
    for (int j=0; j < LAST_PICBUF; j++)
            mpegfb[j]=NULL;
***************
*** 1476,1480 ****
    try {
      for (i = 0; i < 4; i++) {
!       fprintf(stderr, "CLE266: Creating buffer number %i\n", i);
        mpegfb[i] = dfb->CreateSurface(dsc);
  
--- 1513,1518 ----
    try {
      for (i = 0; i < 4; i++) {
!       setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!                 "CLE266: Creating buffer number %i\n", i);
        mpegfb[i] = dfb->CreateSurface(dsc);
  
***************
*** 1485,1490 ****
        if ( PicBuffer[i].use_count>0 ||
             PicBuffer[i].max_width>0 || PicBuffer[i].max_height>0) {
!               esyslog("Fatal error setting up CLE266 buffers!");
!               fprintf(stderr,"Fatal error setting up CLE266 buffers!\n");
                exit(-1);
        };
--- 1523,1528 ----
        if ( PicBuffer[i].use_count>0 ||
             PicBuffer[i].max_width>0 || PicBuffer[i].max_height>0) {
!               setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!                         "Fatal error setting up CLE266 buffers!\n");
                exit(-1);
        };
***************
*** 1506,1510 ****
    catch (DFBException *ex)
    {
!     fprintf(stderr, "CLE266: Error creating buffer: action=%s, result=%s\n",
                    ex->GetAction(), ex->GetResult());
      delete ex;
--- 1544,1549 ----
    catch (DFBException *ex)
    {
!     setupStore->softlog->Log(SOFT_LOG_ERROR, 0,
!               "CLE266: Error creating buffer: action=%s, result=%s\n",
                    ex->GetAction(), ex->GetResult());
      delete ex;
***************
*** 1513,1517 ****
  
    /* Pass info to the decoder...*/
!   fprintf(stderr, "CLE266: passing mpegfb_stride\n");
    CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride >> 1 );
  
--- 1552,1557 ----
  
    /* Pass info to the decoder...*/
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!             "CLE266: passing mpegfb_stride\n");
    CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride >> 1 );
  
***************
*** 1519,1523 ****
    width  = (width  + 15) & ~15;
  
!   fprintf(stderr, "CLE266: passing buffers to decoder\n");
    for (i = 0; i < 4; i++) {
      y_offset = mpegfb_ofs[i];
--- 1559,1564 ----
    width  = (width  + 15) & ~15;
  
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
!             "CLE266: passing buffers to decoder\n");
    for (i = 0; i < 4; i++) {
      y_offset = mpegfb_ofs[i];
***************
*** 1534,1538 ****
  cDFBVideoOut::~cDFBVideoOut()
  {
!   fprintf(stderr,"Releasing DFB\n");
  
    setupStore->osdMode = prevOsdMode;
--- 1575,1579 ----
  cDFBVideoOut::~cDFBVideoOut()
  {
!   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0, "Releasing DFB\n");
  
    setupStore->osdMode = prevOsdMode;

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.24
retrieving revision 1.25
diff -C2 -d -r1.24 -r1.25
*** video-dfb.h	11 Nov 2006 08:45:17 -0000	1.24
--- video-dfb.h	26 Feb 2007 21:04:32 -0000	1.25
***************
*** 48,53 ****
      int   videoLayerLevel;
  
!     void SetParams();
!     void EnableFieldParity(IDirectFBDisplayLayer *layer);
  
  #ifdef HAVE_CLE266_MPEG_DECODER
--- 48,56 ----
      int   videoLayerLevel;
  
!     void  SetParams();
!     void  EnableFieldParity(IDirectFBDisplayLayer *layer),
!           ReportSurfaceCapabilities (IDirectFBSurface *surf,char *name),
!           BESColorkeyState(IDirectFBDisplayLayer *layer, bool state),
!           ReportLayerInfo(IDirectFBDisplayLayer *layer, char *name);
  
  #ifdef HAVE_CLE266_MPEG_DECODER



From nobody at sheep.berlios.de  Tue Feb 27 00:02:20 2007
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 27 Feb 2007 00:02:20 +0100 (CET)
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c, 1.71,
	1.72 mpeg2decoder.h, 1.38, 1.39 video.c, 1.72, 1.73 video.h,
	1.50, 1.51
Message-ID: <20070226230220.4F60CD7F1B@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1922

Modified Files:
	mpeg2decoder.c mpeg2decoder.h video.c video.h 
Log Message:
preparation for new changeable sync parameters.

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.71
retrieving revision 1.72
diff -C2 -d -r1.71 -r1.72
*** mpeg2decoder.c	28 Jan 2007 19:29:53 -0000	1.71
--- mpeg2decoder.c	26 Feb 2007 23:00:34 -0000	1.72
***************
*** 601,608 ****
    // init A-V syncing variables
    offset=0;
-   delay=0;
-   hurry_up=0;
    syncTimer = new cSyncTimer ((eSyncMode) setupStore.syncTimerMode);
    syncTimer->Reset();
  
    default_frametime = DEFAULT_FRAMETIME;
--- 601,607 ----
    // init A-V syncing variables
    offset=0;
    syncTimer = new cSyncTimer ((eSyncMode) setupStore.syncTimerMode);
    syncTimer->Reset();
+   videoOut->ResetDelay();
  
    default_frametime = DEFAULT_FRAMETIME;
***************
*** 634,638 ****
  
  uint64_t cVideoStreamDecoder::GetPTS() {
!   return pts - (delay + syncTimer->GetRelTime(false))/100;
  }
  
--- 633,639 ----
  
  uint64_t cVideoStreamDecoder::GetPTS() {
!   return pts;
! // Was pts of next frame reduced by time to display next frame.
! //  return pts - (delay + syncTimer->GetRelTime(false))/100;
  }
  
***************
*** 889,898 ****
            pts=pic->pts;
  
!   if (!hurry_up || frame % 2 ) {
!     MPGDEB("DrawVideo...delay : %d\n",delay);
!     videoOut->DrawVideo_420pl(syncTimer, &delay, pic);
!     MPGDEB("end DrawVideo\n");
!   } else
!     fprintf(stderr,"+");
    // we just displayed a frame, now it's the right time to
    // measure the A-V offset
--- 890,895 ----
            pts=pic->pts;
  
!   videoOut->DrawVideo_420pl(syncTimer, pic);
! 
    // we just displayed a frame, now it's the right time to
    // measure the A-V offset
***************
*** 902,941 ****
    cClock::AdjustVideoPTS(pts);
  
!   if ( aPTS )
!     offset = aPTS - pts ;
!   else offset = 0;
!   if ( abs(offset) > 100000)
!           offset=0;
! 
!   // this few lines does the whole syncing
!   int pts_corr;
! 
!   // calculate pts correction. Correct 1/10 of offset at a time
!   pts_corr = offset/10;
! 
!   //Max. correction is 2/10 frametime.
!   if (pts_corr > 2*frametime() / 10 )
!     pts_corr = 2*frametime() / 10;
!   else if (pts_corr < -2*frametime() / 10 )
!     pts_corr = -2*frametime() / 10;
! 
!   // calculate delay
!   delay += ( frametime() - pts_corr  ) * 100;
    // update video pts
    pts += frametime();
  
!   if (delay > 2*frametime()*100)
!     delay = 2*frametime()*100;
!   else if (delay < -frametime()*100)
!     delay = -frametime()*100;
! 
!   if (offset >  8*frametime())
!      hurry_up=1;
!   else if ( (offset < 2*frametime()) && (hurry_up > 0) )
!      hurry_up=0;
! 
! #if 1
!   int dispTime=syncTimer->GetRelTime();
!   delay-=dispTime;
    if (!(frame % 1) || context->hurry_up) {
      MPGDEB("Frame# %-5d A-V(ms) %-5d delay %d FrameT: %s, dispTime(ms): %1.2f\n",
--- 899,907 ----
    cClock::AdjustVideoPTS(pts);
  
!   videoOut->EvaluateDelay (aPTS, pts, frametime());
    // update video pts
    pts += frametime();
  
! #if 0
    if (!(frame % 1) || context->hurry_up) {
      MPGDEB("Frame# %-5d A-V(ms) %-5d delay %d FrameT: %s, dispTime(ms): %1.2f\n",
***************
*** 949,953 ****
  #endif
  
! #ifdef AV_STATS
    {
      const int Freq=10;
--- 915,920 ----
  #endif
  
! #if 0
! //#ifdef AV_STATS
    {
      const int Freq=10;

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** mpeg2decoder.h	17 Jun 2006 16:27:35 -0000	1.38
--- mpeg2decoder.h	26 Feb 2007 23:00:34 -0000	1.39
***************
*** 238,244 ****
  
      // A-V syncing stuff
-     int                hurry_up;
      int                offset;
-     int                delay;
      int                trickspeed;
      int                default_frametime;
--- 238,242 ----

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.72
retrieving revision 1.73
diff -C2 -d -r1.72 -r1.73
*** video.c	15 Jan 2007 20:30:08 -0000	1.72
--- video.c	26 Feb 2007 23:00:34 -0000	1.73
***************
*** 25,28 ****
--- 25,30 ----
  #endif
  
+ /* ---------------------------------------------------------------------------
+  */
  cVideoOut::cVideoOut(cSetupStore *setupStore)
  {
***************
*** 51,54 ****
--- 53,68 ----
    oldPicture = NULL;
  
+   hurryUp = 0;
+   delay   = 0;
+   repeatedFrames  = droppedFrames = frame = 0;
+   offsetInHold    = false;
+   dropStart       =  80;
+   dropEnd         =  20;
+   dropInterval    =   2;
+   offsetClampLow  =  -2;
+   offsetClampHigh =   2;
+   offsetUse       =   1;
+   useAverage4Drop =   false;
+ 
    for (int i = 0; i < SETUP_VIDEOASPECTNAMES_COUNT; ++i)
      parValues [i] = 1.0;
***************
*** 434,440 ****
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::DrawVideo_420pl(cSyncTimer *syncTimer, int *delay,
                                  sPicBuffer *pic)
  {
    sPicBuffer *scale_pic=NULL;
    if (scaleVid != 0) {
--- 448,462 ----
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::DrawVideo_420pl(cSyncTimer *syncTimer,
                                  sPicBuffer *pic)
  {
+   if (hurryUp && (frame % dropInterval) == 0) {
+     ++frame;
+     ++droppedFrames;
+     fprintf(stderr,"X");
+     delay -= dispTime = syncTimer->GetRelTime();
+     return;
+   }
+ 
    sPicBuffer *scale_pic=NULL;
    if (scaleVid != 0) {
***************
*** 452,456 ****
    };
  
!   Sync(syncTimer, delay);
    oldPictureMutex.Lock();
  
--- 474,481 ----
    };
  
!   if (delay > frametime * 100)
!     ++repeatedFrames;
! 
!   Sync(syncTimer, &delay);
    oldPictureMutex.Lock();
  
***************
*** 464,470 ****
--- 489,498 ----
  
    oldPictureMutex.Unlock();
+   delay -= dispTime = syncTimer->GetRelTime();
+ 
    ProcessEvents();
    if (scale_pic)
            ReleaseBuffer(scale_pic);
+   ++frame;
  }
  
***************
*** 488,491 ****
--- 516,626 ----
  /* ---------------------------------------------------------------------------
   */
+ void cVideoOut::EvaluateDelay(int aPTS, int pts, int frametime)
+ {
+     int   offset,
+           dropOffset,
+           pts_corr;
+ 
+   this->frametime = frametime;
+   offset = (aPTS) ? aPTS - pts : 0;
+ 
+   if (abs(offset) > 100000)
+     offset=0;
+ 
+   if (offsetCount >= AVRG_OFF_CNT) {
+     offsetSum -= offsetHistory[offsetIndex];
+     offsetCount--;
+   }
+ 
+   offsetHistory[offsetIndex] = offset;
+   offsetSum += offset;
+   offsetCount++;
+   offsetAverage = offsetSum / offsetCount;
+   offsetIndex++;
+   offsetIndex %= AVRG_OFF_CNT;
+ 
+   setupStore->softlog->Log(SOFT_LOG_TRACE, 0,
+                   "[VideoOut] A/V (%d - %d) off = %d avoff = %d\n",
+                   aPTS, pts, offset, offsetAverage);
+ 
+   if (0) {
+     // should be moved to contructor of video-dfb for TV-out
+ 
+     dropStart       =  25;
+     dropEnd         =  15;
+     dropInterval    =   8;
+     //offsetClampLow  = -10;
+     //offsetClampHigh =  10;
+     //offsetUse       =   4;
+     //offset = offsetAverage;
+     //useAverage4Drop = true;
+   }
+ 
+   dropOffset = (useAverage4Drop) ? offsetAverage : offset;
+ 
+   /* -------------------------------------------------------------------------
+    * this few lines does the whole syncing
+    * calculate pts correction. Correct offsetUse / 10 of offset at a time
+    */
+   pts_corr = (offsetUse * offset) / 10;
+ 
+   //Max. correction is limited to offsetClampLow|High / 10 frametime.
+   pts_corr = clamp ((offsetClampLow * frametime) / 10,
+                     pts_corr,
+                     (offsetClampHigh * frametime) / 10);
+ 
+   if (dropOffset > (dropStart * frametime) / 10)
+     hurryUp = 1;
+   else if ((dropOffset < (dropEnd * frametime) / 10) && (hurryUp > 0))
+     hurryUp = 0;
+ 
+   // calculate delay
+   delay += ( frametime - pts_corr  ) * 100;
+ 
+   delay = clamp (-frametime*100, delay, 2*frametime*100);
+ 
+   if (frame < 100) {
+     setupStore->softlog->Log(SOFT_LOG_TRACE, 0,
+                   "[VideoOut] %d %d %d \n",
+                   frame, offset, offsetAverage);
+   }
+ 
+   if (frame > 8  && frame < 200) {
+     if (!offsetInHold) {
+       if (abs(offset) < frametime) {
+         offsetInHold = true;
+         setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
+                   "[VideoOut] video now synced (%d - %d)\n",
+                   frame, offset);
+       }
+     }
+   }
+   if (frame && !(frame % 7500)) {
+     setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
+               "[VideoOut] sync info: repF = %d, drpF = %d, totF = %d\n",
+               repeatedFrames, droppedFrames, frame);
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cVideoOut::ResetDelay()
+ {
+   hurryUp = 0;
+   delay = 0;
+   offsetInHold = false;
+ 
+   offsetIndex = offsetCount = offsetAverage = offsetSum = 0;
+   memset (offsetHistory, 0, sizeof(offsetHistory));
+ 
+   setupStore->softlog->Log(SOFT_LOG_DEBUG, 0,
+             "[VideoOut] reset: sync info: repF = %d, drpF = %d, totF = %d\n",
+             repeatedFrames, droppedFrames, frame);
+ 
+   repeatedFrames = droppedFrames = frame = 0;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cVideoOut::ClearOSD()
  {
***************
*** 518,522 ****
  
  void cVideoOut::SetVidWin(int ScaleVid, int VidX1, int VidY1,
!                 int VidX2, int VidY2) 
  {
    OSDDEB("SetVidWin ScaleVid %d: %d,%d  %d,%d\n",
--- 653,657 ----
  
  void cVideoOut::SetVidWin(int ScaleVid, int VidX1, int VidY1,
!                 int VidX2, int VidY2)
  {
    OSDDEB("SetVidWin ScaleVid %d: %d,%d  %d,%d\n",

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.50
retrieving revision 1.51
diff -C2 -d -r1.50 -r1.51
*** video.h	28 Jan 2007 19:28:11 -0000	1.50
--- video.h	26 Feb 2007 23:00:34 -0000	1.51
***************
*** 35,38 ****
--- 35,40 ----
  #define SRC_WIDTH          736
  
+ #define AVRG_OFF_CNT        16
+ 
  #ifndef STAND_ALONE
  class cSoftRemote : public cRemote {
***************
*** 119,122 ****
--- 121,148 ----
      virtual bool IsSoftOSDMode();
  
+     /* -----------------------------------------------------------------------
+      */
+     int     frame,
+             droppedFrames,
+             repeatedFrames;
+     bool    offsetInHold;
+     int     hurryUp;
+     int     delay;
+     int     dispTime;
+     int     frametime;
+     int     offsetHistory[AVRG_OFF_CNT];
+     int     offsetIndex;
+     int     offsetCount;
+     int     offsetAverage;
+     int     offsetSum;
+     int     dropStart,
+             dropEnd,
+             dropInterval,
+             offsetClampHigh,
+             offsetClampLow,
+             offsetUse;
+     bool    useAverage4Drop;
+ 
+ 
  public:
      cVideoOut(cSetupStore *setupStore);
***************
*** 136,142 ****
      virtual void CheckAspectDimensions (sPicBuffer *pic);
      virtual void CheckArea(int w, int h);
!     virtual void DrawVideo_420pl(cSyncTimer *syncTimer, int *delay,
!                                   sPicBuffer *pic);
      virtual void DrawStill_420pl(sPicBuffer *buf);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format = 0,
--- 162,170 ----
      virtual void CheckAspectDimensions (sPicBuffer *pic);
      virtual void CheckArea(int w, int h);
!     virtual void DrawVideo_420pl(cSyncTimer *syncTimer,
!                                  sPicBuffer *pic);
      virtual void DrawStill_420pl(sPicBuffer *buf);
+     virtual void EvaluateDelay(int aPTS, int pts, int frametime);
+     virtual void ResetDelay(void);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
      virtual bool Reconfigure (int format = 0,
***************
*** 188,192 ****
  
      virtual void OpenOSD();
!     virtual void SetVidWin(int ScaleVid, int VidX1, int VidY1, 
                      int VidX2, int VidY2);
      virtual int GetOSDColorkey();
--- 216,220 ----
  
      virtual void OpenOSD();
!     virtual void SetVidWin(int ScaleVid, int VidX1, int VidY1,
                      int VidX2, int VidY2);
      virtual int GetOSDColorkey();



From nobody at sheep.berlios.de  Tue Feb 27 00:03:31 2007
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 27 Feb 2007 00:03:31 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.296,1.297
Message-ID: <20070226230331.C79906389E@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2275

Modified Files:
	CHANGELOG 
Log Message:
document recent changes.

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.296
retrieving revision 1.297
diff -C2 -d -r1.296 -r1.297
*** CHANGELOG	24 Feb 2007 14:04:14 -0000	1.296
--- CHANGELOG	26 Feb 2007 23:01:56 -0000	1.297
***************
*** 1,3 ****
--- 1,8 ----
  Changelog
+ 2007-02-26:
+    - softlog: sanitycheck for zero length filenames and fix use filename member
+               when changeing append mode.
+    - video-dfb: shifted most prints via softlog.
+    - video sync: preparation for new changeable sync parameters.
  2007-02-24:
     - Makefile: add --remove-destination , so that "make plugins" does not



From nobody at sheep.berlios.de  Sun Mar  4 18:47:17 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sun,  4 Mar 2007 18:47:17 +0100 (CET)
Subject: [Softdevice-cvs] softdevice CHANGELOG, 1.297, 1.298 configure, 1.33,
	1.34 setup-softdevice-menu.c, 1.9, 1.10 setup-softdevice.c,
	1.49, 1.50 setup-softdevice.h, 1.37, 1.38 video-dfb.c, 1.78,
	1.79 video-dfb.h, 1.25, 1.26
Message-ID: <20070304174717.4BE86DC25C@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20862

Modified Files:
	CHANGELOG configure setup-softdevice-menu.c setup-softdevice.c 
	setup-softdevice.h video-dfb.c video-dfb.h 
Log Message:
video-dfb: Make use of SetSourceRectangle() runtime selectable,
           changed *SetSourceLocation* to SetSourceRectangle.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.297
retrieving revision 1.298
diff -C2 -d -r1.297 -r1.298
*** CHANGELOG	26 Feb 2007 23:01:56 -0000	1.297
--- CHANGELOG	4 Mar 2007 17:45:37 -0000	1.298
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2007-03-04:
+    - video-dfb: Make use of SetSourceRectangle() runtime selectable,
+                 changed *SetSourceLocation* to SetSourceRectangle.
  2007-02-26:
     - softlog: sanitycheck for zero length filenames and fix use filename member

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** configure	28 Jan 2007 19:31:15 -0000	1.33
--- configure	4 Mar 2007 17:45:38 -0000	1.34
***************
*** 115,132 ****
  cpu_arch=`uname -m`
  case "$cpu_arch" in
!   i[3-6]86*|x86_64) 
          cpu_arch="i386"
          ;;
!   ppc|"Power Macintosh") 
          cpu_arch="PowerPC"
!         with_mmx="no" 
          with_mmx2="no"
          with_altivec="yes"
          ;;
    *)
! 	echo "'$cpu_arch' is unknown..." 
          cpu_arch="unknown"
!         with_mmx="no" 
!         with_mmx2="no"  
          ;;
  esac
--- 115,132 ----
  cpu_arch=`uname -m`
  case "$cpu_arch" in
!   i[3-6]86*|x86_64)
          cpu_arch="i386"
          ;;
!   ppc|"Power Macintosh")
          cpu_arch="PowerPC"
!         with_mmx="no"
          with_mmx2="no"
          with_altivec="yes"
          ;;
    *)
! 	echo "'$cpu_arch' is unknown..."
          cpu_arch="unknown"
!         with_mmx="no"
!         with_mmx2="no"
          ;;
  esac
***************
*** 366,370 ****
  dfb_opts="${dfb_cflags} ${dfb_libs}"
  dfb_device_desc="yes"
! dfb_sourcelocation="yes"
  dfb_dscaps_double="yes"
  dfb_dief_repeat="yes"
--- 366,370 ----
  dfb_opts="${dfb_cflags} ${dfb_libs}"
  dfb_device_desc="yes"
! dfb_sourcerectangle="yes"
  dfb_dscaps_double="yes"
  dfb_dief_repeat="yes"
***************
*** 389,393 ****
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_sourcelocation="no"
  
  cat > ${TMPC} << EOF
--- 389,393 ----
  }
  EOF
! $cc $CFLAGS $dfb_opts -o $TMPE $TMPC >> config.log 2>&1 || dfb_sourcerectangle="no"
  
  cat > ${TMPC} << EOF
***************
*** 484,488 ****
      echo "Not found, not supported by DirectFB or disabled by argument."
    fi
! else 
    cle266="no"
  fi
--- 484,488 ----
      echo "Not found, not supported by DirectFB or disabled by argument."
    fi
! else
    cle266="no"
  fi
***************
*** 615,622 ****
    echo "DFB_CFLAGS = ${dfb_cflags}" >> $TMPM
  
!   if test "${dfb_sourcelocation}" = "yes" ; then
!     echo "#define HAVE_SetSourceLocation          1" >> $TMPH
    else
!     echo "#define HAVE_SetSourceLocation          0" >> $TMPH
    fi
  
--- 615,622 ----
    echo "DFB_CFLAGS = ${dfb_cflags}" >> $TMPM
  
!   if test "${dfb_sourcerectangle}" = "yes" ; then
!     echo "#define HAVE_SetSourceRectangle         1" >> $TMPH
    else
!     echo "#define HAVE_SetSourceRectangle         0" >> $TMPH
    fi
  

Index: setup-softdevice-menu.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice-menu.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** setup-softdevice-menu.c	10 Feb 2007 00:02:14 -0000	1.9
--- setup-softdevice-menu.c	4 Mar 2007 17:45:38 -0000	1.10
***************
*** 378,386 ****
    }
  
!   if (data->outputMethod == VOUT_DFB &&
!       !data->stretchBlitLocked)
!   {
!     Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
!                               &data->useStretchBlit, tr("off"), tr("on")));
    }
  
--- 378,391 ----
    }
  
!   if (data->outputMethod == VOUT_DFB) {
!     if (!data->stretchBlitLocked)
!       Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
!                                 &data->useStretchBlit,
!                                 tr("off"), tr("on")));
! 
!     if (!data->setSourceRectangleLocked)
!       Add(new cMenuEditBoolItem(tr("Use SourceRectangle"),
!                                 &data->useSetSourceRectangle,
!                                 tr("off"), tr("on")));
    }
  
***************
*** 463,466 ****
--- 468,472 ----
    SetupStore ("PixelFormat",        setupStore.pixelFormat);
    SetupStore ("UseStretchBlit",     setupStore.useStretchBlit);
+   SetupStore ("UseSetSourceRectangle",     setupStore.useSetSourceRectangle);
    SetupStore ("Picture mirroring",  setupStore.mirror);
    SetupStore ("avOffset",           setupStore.avOffset);

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.49
retrieving revision 1.50
diff -C2 -d -r1.49 -r1.50
*** setup-softdevice.c	10 Feb 2007 00:02:14 -0000	1.49
--- setup-softdevice.c	4 Mar 2007 17:45:38 -0000	1.50
***************
*** 124,127 ****
--- 124,130 ----
    zoomCenterY         = 0;
  
+   useSetSourceRectangle = false;
+   setSourceRectangleLocked = false;
+ 
    strcpy (alsaDevice, "");
    strcpy (alsaAC3Device, "");
***************
*** 310,313 ****
--- 313,320 ----
      useStretchBlit = clamp (0, atoi(Value), 1);
      fprintf(stderr,"[softdevice] UseStretchBlitset to %s\n",
+             useStretchBlit ? "on" : "off");
+   } else if(!strcasecmp(Name, "UseSetSourceRectangle")) {
+     useSetSourceRectangle = clamp (0, atoi(Value), 1);
+     fprintf(stderr,"[softdevice] UseSetSourceRectangle to %s\n",
              useStretchBlit ? "on" : "off");
    } else if (!strcasecmp(Name, "SyncAllFrames")) {

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** setup-softdevice.h	10 Feb 2007 00:02:14 -0000	1.37
--- setup-softdevice.h	4 Mar 2007 17:45:38 -0000	1.38
***************
*** 171,174 ****
--- 171,176 ----
            vidDeinterlace,
            vidCaps;
+     int   useSetSourceRectangle,
+           setSourceRectangleLocked;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
      char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.78
retrieving revision 1.79
diff -C2 -d -r1.78 -r1.79
*** video-dfb.c	26 Feb 2007 21:04:32 -0000	1.78
--- video-dfb.c	4 Mar 2007 17:45:38 -0000	1.79
***************
*** 18,22 ****
  # include "config.h"
  #else
! # define HAVE_SetSourceLocation 0
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
  #   define HAVE_GraphicsDeviceDescription 0
--- 18,22 ----
  # include "config.h"
  #else
! # define HAVE_SetSourceRectangle 0
  # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
  #   define HAVE_GraphicsDeviceDescription 0
***************
*** 212,215 ****
--- 212,223 ----
      setupStore->tripleBuffering = 1;
  
+ #if HAVE_SetSourceRectangle
+   setupStore->setSourceRectangleLocked = false;
+   useSetSourceRectangle = setupStore->useSetSourceRectangle;
+ #else
+   useSetSourceRectangle = setupStore->useSetSourceRectangle = false;
+   setupStore->setSourceRectangleLocked = true;
+ #endif
+ 
    try
    {
***************
*** 721,725 ****
          cutLeft != setupStore->cropLeftCols ||
          cutRight != setupStore->cropRightCols ||
!         useStretchBlit != setupStore->useStretchBlit )
      {
  
--- 729,734 ----
          cutLeft != setupStore->cropLeftCols ||
          cutRight != setupStore->cropRightCols ||
!         useStretchBlit != setupStore->useStretchBlit ||
!         useSetSourceRectangle != setupStore->useSetSourceRectangle)
      {
  
***************
*** 735,738 ****
--- 744,749 ----
  
        useStretchBlit = false;
+       useSetSourceRectangle = setupStore->useSetSourceRectangle;
+ 
        /* ---------------------------------------------------------------------
         * if we are in video underlay mode (videoLayerLevel == -1), we have
***************
*** 760,786 ****
        }
  
! #if HAVE_SetSourceLocation
!       /* ----------------------------------------------------------------------
!        * this should be the settings if SetSourceRectangle is working for
!        * all drivers.
!        * SetSourceRectangle() moved, after layer is reconfigured
!        */
!       dlc.width   = fwidth;
!       dlc.height  = fheight;
! #else
!       /* ----------------------------------------------------------------------
!        * for now we have to do another trick
!        */
!       if (useStretchBlit)
!       {
          dlc.width   = fwidth;
          dlc.height  = fheight;
!       }
!       else
!       {
          dlc.width   = swidth;
          dlc.height  = sheight;
        }
! #endif
        dlc.flags = (DFBDisplayLayerConfigFlags)((int) dlc.flags |
                                                        DLCONF_OPTIONS);
--- 771,787 ----
        }
  
!       if (useSetSourceRectangle || useStretchBlit) {
!         /* --------------------------------------------------------------------
!          * this should be the settings if SetSourceRectangle is working for
!          * all drivers.
!          * SetSourceRectangle() moved, after layer is reconfigured
!          */
          dlc.width   = fwidth;
          dlc.height  = fheight;
!       } else {
          dlc.width   = swidth;
          dlc.height  = sheight;
        }
! 
        dlc.flags = (DFBDisplayLayerConfigFlags)((int) dlc.flags |
                                                        DLCONF_OPTIONS);
***************
*** 925,930 ****
          {
            videoLayer->SetConfiguration(dlc);
! #if HAVE_SetSourceLocation
!           videoLayer->SetSourceRectangle (sxoff, syoff, swidth, sheight);
  #endif
          }
--- 926,932 ----
          {
            videoLayer->SetConfiguration(dlc);
! #if HAVE_SetSourceRectangle
!           if (useSetSourceRectangle)
!             videoLayer->SetSourceRectangle (sxoff, syoff, swidth, sheight);
  #endif
          }
***************
*** 1343,1348 ****
  
      if (setupStore->cle266HWdecode && currentFB < 4 && currentFB >= 0) {
!       // we use an internal buffer and CLE266 HW decoding
!       videoSurface->Blit(mpegfb[currentFB], NULL, 0, 0);
      } else {
  #endif // HAVE_CLE266_MPEG_DECODER
--- 1345,1362 ----
  
      if (setupStore->cle266HWdecode && currentFB < 4 && currentFB >= 0) {
! 
!       if (useSetSourceRectangle) {
!         // we use an internal buffer and CLE266 HW decoding
!         videoSurface->Blit(mpegfb[currentFB], NULL, 0, 0);
!       } else {
!           DFBRectangle  sRect;
! 
!         sRect.x = sxoff + 2 * cutLeft;
!         sRect.y = syoff + 2 * cutTop;
!         sRect.w = swidth  - 2 * (cutLeft + cutRight);
!         sRect.h = sheight - 2 * (cutTop  + cutBottom);
!         videoSurface->Blit(mpegfb[currentFB], &sRect, cutLeft * 2, cutTop * 2);
!       }
! 
      } else {
  #endif // HAVE_CLE266_MPEG_DECODER
***************
*** 1351,1411 ****
        if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
        {
! #if HAVE_SetSourceLocation
!         Py += Ystride  * cutTop * 2 + cutLeft * 2;
!         Pv += UVstride * cutTop + cutLeft;
!         Pu += UVstride * cutTop + cutLeft;
  
!         dst += pitch * cutTop * 2;
  
!         for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!           fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
!           Py  += Ystride;
!           dst += pitch;
!         }
  
!         dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!           fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
!           Pu  += UVstride;
!           dst += pitch / 2;
!         }
  
!         dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!           fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
!           Pv  += UVstride;
!           dst += pitch / 2;
!         }
! #else
!         Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
!         Pv += (UVstride * syoff/2) + UVstride * cutTop;
!         Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!         dst += pitch * cutTop * 2;
  
!         for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!           fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
!           Py  += Ystride;
!           dst += pitch;
!         }
  
!         dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!           fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!           Pu  += UVstride;
!           dst += pitch / 2;
!         }
  
!         dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!         for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!           fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!           Pv  += UVstride;
!           dst += pitch / 2;
          }
- #endif
        } else if (pixelformat == DSPF_YUY2) {
  
--- 1365,1425 ----
        if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
        {
!         if (useSetSourceRectangle) {
!           Py += Ystride  * cutTop * 2 + cutLeft * 2;
!           Pv += UVstride * cutTop + cutLeft;
!           Pu += UVstride * cutTop + cutLeft;
  
!           dst += pitch * cutTop * 2;
  
!           for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!             fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
!             Py  += Ystride;
!             dst += pitch;
!           }
  
!           dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!           for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!             fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
!             Pu  += UVstride;
!             dst += pitch / 2;
!           }
  
!           dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!           for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!             fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
!             Pv  += UVstride;
!             dst += pitch / 2;
!           }
!         } else {
!           Py += (Ystride  * syoff)   + Ystride  * cutTop * 2;
!           Pv += (UVstride * syoff/2) + UVstride * cutTop;
!           Pu += (UVstride * syoff/2) + UVstride * cutTop;
  
!           dst += pitch * cutTop * 2;
  
!           for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!             fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
!             Py  += Ystride;
!             dst += pitch;
!           }
  
!           dst += pitch * cutBottom * 2 + pitch * cutTop / 2;
  
!           for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!             fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!             Pu  += UVstride;
!             dst += pitch / 2;
!           }
  
!           dst += pitch * cutBottom / 2 + pitch * cutTop / 2;
  
!           for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!             fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
!             Pv  += UVstride;
!             dst += pitch / 2;
!           }
          }
        } else if (pixelformat == DSPF_YUY2) {
  

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.25
retrieving revision 1.26
diff -C2 -d -r1.25 -r1.26
*** video-dfb.h	26 Feb 2007 21:04:32 -0000	1.25
--- video-dfb.h	4 Mar 2007 17:45:38 -0000	1.26
***************
*** 39,42 ****
--- 39,43 ----
      bool alphablend;
      bool useStretchBlit;
+     bool useSetSourceRectangle;
      bool osdClrBack;
      bool isVIAUnichrome;



From nobody at sheep.berlios.de  Mon Mar 12 21:01:42 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 21:01:42 +0100 (CET)
Subject: [Softdevice-cvs] softdevice configure, 1.34, 1.35 Makefile, 1.37,
	1.38
Message-ID: <20070312200142.2F5ACCE576@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30341

Modified Files:
	configure Makefile 
Log Message:
- compile fix for recent ffmpeg SVN



Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** configure	4 Mar 2007 17:45:38 -0000	1.34
--- configure	12 Mar 2007 20:00:00 -0000	1.35
***************
*** 162,165 ****
--- 162,166 ----
    ffmpeg="yes";
  cat > ${TMPC} << EOF
+ #define __STDC_CONSTANT_MACROS
  #include <stdlib.h>
  #include <avcodec.h>

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** Makefile	24 Feb 2007 14:04:14 -0000	1.37
--- Makefile	12 Mar 2007 20:00:00 -0000	1.38
***************
*** 200,204 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual $(ADD_CXXFLAGS)
  
  ### The directory environment:
--- 200,206 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual 
! CXXFLAGS += $(ADD_CXXFLAGS)
! DEFINES  += -D__STDC_CONSTANT_MACROS
  
  ### The directory environment:



From nobody at sheep.berlios.de  Mon Mar 12 21:07:25 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 21:07:25 +0100 (CET)
Subject: [Softdevice-cvs] softdevice PicBuffer.h, 1.6, 1.7 mpeg2decoder.h,
	1.39, 1.40
Message-ID: <20070312200725.8C80FDBEB8@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv30803

Modified Files:
	PicBuffer.h mpeg2decoder.h 
Log Message:
- include ffmpeg headers as 'extern "C"'


Index: PicBuffer.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** PicBuffer.h	26 Nov 2006 18:53:41 -0000	1.6
--- PicBuffer.h	12 Mar 2007 20:05:44 -0000	1.7
***************
*** 12,16 ****
--- 12,18 ----
  #define __PIC_BUFFER_H__
  
+ extern "C" {
  #include <avcodec.h>
+ }
  
  #ifndef STAND_ALONE

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.39
retrieving revision 1.40
diff -C2 -d -r1.39 -r1.40
*** mpeg2decoder.h	26 Feb 2007 23:00:34 -0000	1.39
--- mpeg2decoder.h	12 Mar 2007 20:05:44 -0000	1.40
***************
*** 14,19 ****
--- 14,21 ----
  
  #include <sys/time.h>
+ extern "C" {
  #include <avcodec.h>
  #include <avformat.h>
+ }
  
  #include <vdr/plugin.h>



From nobody at sheep.berlios.de  Mon Mar 12 21:12:35 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 21:12:35 +0100 (CET)
Subject: [Softdevice-cvs] softdevice audio-oss.c, 1.2, 1.3 audio-oss.h, 1.1,
	1.2 softdevice.c, 1.78, 1.79
Message-ID: <20070312201235.B3B93DB1A2@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31082

Modified Files:
	audio-oss.c audio-oss.h softdevice.c 
Log Message:
- enable and use as default the software mixer. The old behaviour (use the
  system's mixer) can be selected via -vo oss:mixer.


Index: audio-oss.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-oss.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -C2 -d -r1.2 -r1.3
*** audio-oss.c	14 Dec 2006 23:09:53 -0000	1.2
--- audio-oss.c	12 Mar 2007 20:10:54 -0000	1.3
***************
*** 18,24 ****
  #define MIXER_DEVICE "/dev/mixer"
  
! cOSSAudioOut::cOSSAudioOut(cSetupStore *setupStore)
  {
      struct stat file_info;
  
      if (-1 == stat(DSP_DEVICE, &file_info))
--- 18,25 ----
  #define MIXER_DEVICE "/dev/mixer"
  
! cOSSAudioOut::cOSSAudioOut(cSetupStore *SetupStore)
  {
      struct stat file_info;
+     setupStore=SetupStore;
  
      if (-1 == stat(DSP_DEVICE, &file_info))
***************
*** 42,48 ****
      paused=false;
      isyslog("[softdevice-audio-oss] Device open!");
- #ifdef NO_MIXER    
      scale_Factor = 0x7FFF;
- #endif
  }
  
--- 43,47 ----
***************
*** 61,67 ****
      ssize_t wsize;
  
! #ifdef NO_MIXER
!     Scale((int16_t*)Data, Length / 2, scale_Factor);
! #endif
      
      while (Length > done)
--- 60,65 ----
      ssize_t wsize;
  
!     if (!setupStore->useMixer) 
!             Scale((int16_t*)Data, Length / 2, scale_Factor);
      
      while (Length > done)
***************
*** 188,194 ****
  void cOSSAudioOut::SetVolume (int vol)
  {
! #ifdef NO_MIXER
!     scale_Factor = CalcScaleFactor(vol);
! #else
      struct stat file_info;
  
--- 186,194 ----
  void cOSSAudioOut::SetVolume (int vol)
  {
!     if (!setupStore->useMixer) {
!             scale_Factor = CalcScaleFactor(vol);
!             return;
!     };
! 
      struct stat file_info;
  
***************
*** 234,238 ****
  
      close (fdMixer);
- #endif
      return;
  }
--- 234,237 ----

Index: audio-oss.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-oss.h,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** audio-oss.h	3 Dec 2006 20:38:18 -0000	1.1
--- audio-oss.h	12 Mar 2007 20:10:54 -0000	1.2
***************
*** 19,25 ****
      int fdDSP;
      int fdMixer;
- #ifdef NO_MIXER
      int scale_Factor;
! #endif
  public:
      cOSSAudioOut(cSetupStore *setupStore);
--- 19,24 ----
      int fdDSP;
      int fdMixer;
      int scale_Factor;
!     cSetupStore *setupStore;
  public:
      cOSSAudioOut(cSetupStore *setupStore);

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.78
retrieving revision 1.79
diff -C2 -d -r1.78 -r1.79
*** softdevice.c	9 Feb 2007 23:55:22 -0000	1.78
--- softdevice.c	12 Mar 2007 20:10:54 -0000	1.79
***************
*** 844,848 ****
            char *vo_argv = argv[i];
  
- 	  printf("vo_argv: %s \n",vo_argv);
          if (!strncmp (vo_argv, "xv:", 3)) {
            vo_argv += 3;
--- 844,847 ----
***************
*** 1035,1038 ****
--- 1034,1042 ----
            setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_OSS;
+           if (!strncmp(ao_argv, "mixer", 5)) {
+                 printf("mixer argv: '%s' \n",ao_argv);
+               ao_argv += 5;
+               setupStore.useMixer = 1;
+           }
          } else if (!strncmp(ao_argv, "dummy:", 6)) {
            ao_argv += 6;



From nobody at sheep.berlios.de  Mon Mar 12 21:14:34 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 21:14:34 +0100 (CET)
Subject: [Softdevice-cvs] softdevice audio.h,1.12,1.13
Message-ID: <20070312201434.87F55DAEB9@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31403

Modified Files:
	audio.h 
Log Message:
- increase the stepsize of the software mixer.


Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** audio.h	10 Jul 2006 19:40:25 -0000	1.12
--- audio.h	12 Mar 2007 20:12:48 -0000	1.13
***************
*** 28,32 ****
  static inline int CalcScaleFactor(int vol) 
  { return (vol <= 0 ? 0 
!           : (int) (pow(10.0, -2.3+2.3*vol/256.0)*0x7FFF)); };
  
  /* ---------------------------------------------------------------------------
--- 28,32 ----
  static inline int CalcScaleFactor(int vol) 
  { return (vol <= 0 ? 0 
!           : (int) (pow(10.0, -2.5+2.5*vol/256.0)*0x7FFF)); };
  
  /* ---------------------------------------------------------------------------



From nobody at sheep.berlios.de  Mon Mar 12 21:28:44 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 21:28:44 +0100 (CET)
Subject: [Softdevice-cvs] softdevice audio.c,1.26,1.27 audio.h,1.13,1.14
Message-ID: <20070312202844.5D8C1DCB6D@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv32439

Modified Files:
	audio.c audio.h 
Log Message:
- don't scale audio if the max. volume is selected


Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.26
retrieving revision 1.27
diff -C2 -d -r1.26 -r1.27
*** audio.c	10 Jul 2006 19:40:25 -0000	1.26
--- audio.c	12 Mar 2007 20:27:03 -0000	1.27
***************
*** 29,32 ****
--- 29,35 ----
  void Scale(int16_t *Data, int size,int scale_Factor) 
  {
+   if (scale_Factor == 0x7FFF) // max. volume, don't change anything
+           return;
+ 
    while (size>0) {
      register int32_t tmp=(int32_t)(*Data) * scale_Factor;

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** audio.h	12 Mar 2007 20:12:48 -0000	1.13
--- audio.h	12 Mar 2007 20:27:03 -0000	1.14
***************
*** 28,32 ****
  static inline int CalcScaleFactor(int vol) 
  { return (vol <= 0 ? 0 
!           : (int) (pow(10.0, -2.5+2.5*vol/256.0)*0x7FFF)); };
  
  /* ---------------------------------------------------------------------------
--- 28,33 ----
  static inline int CalcScaleFactor(int vol) 
  { return (vol <= 0 ? 0 
!           : ( vol >=255 ? 0x7FFF : 
! 	                 (int) (pow(10.0, -2.5+2.5*vol/256.0)*0x7FFF))); };
  
  /* ---------------------------------------------------------------------------



From nobody at sheep.berlios.de  Mon Mar 12 21:45:07 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 21:45:07 +0100 (CET)
Subject: [Softdevice-cvs] softdevice PicBuffer.c, 1.18, 1.19 CHANGELOG, 1.298,
	1.299
Message-ID: <20070312204507.223FCDEB49@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1139

Modified Files:
	PicBuffer.c CHANGELOG 
Log Message:
- set edge_width/_height always to zero. Fixes picture shiftes with
  the ShmClient. This is not the optimal(/final) solution...
- update CHANGELOG



Index: PicBuffer.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/PicBuffer.c,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** PicBuffer.c	15 Jan 2007 19:35:13 -0000	1.18
--- PicBuffer.c	12 Mar 2007 20:43:26 -0000	1.19
***************
*** 563,567 ****
  
          if ( src->width+src->edge_width <= dst->max_width) {
!                 dst->edge_width = src->edge_width;
                  dst->width = src->width;
          } else {
--- 563,567 ----
  
          if ( src->width+src->edge_width <= dst->max_width) {
!                 dst->edge_width = 0; //src->edge_width;
                  dst->width = src->width;
          } else {
***************
*** 571,575 ****
  
          if ( src->height+src->edge_height <= dst->max_height) {
!                 dst->edge_height = src->edge_height;
                  dst->height = src->height;
          } else {
--- 571,575 ----
  
          if ( src->height+src->edge_height <= dst->max_height) {
!                 dst->edge_height = 0; //src->edge_height;
                  dst->height = src->height;
          } else {
***************
*** 1155,1159 ****
  
          if ( src->width+src->edge_width <= dst->max_width) {
!                 dst->edge_width = src->edge_width;
                  width = dst->width = src->width;
          } else {
--- 1155,1159 ----
  
          if ( src->width+src->edge_width <= dst->max_width) {
!                 dst->edge_width = 0; //src->edge_width;
                  width = dst->width = src->width;
          } else {
***************
*** 1163,1167 ****
  
          if ( src->height+src->edge_height <= dst->max_height) {
!                 dst->edge_height = src->edge_height;
                  dst->height = height = src->height;
          } else {
--- 1163,1167 ----
  
          if ( src->height+src->edge_height <= dst->max_height) {
!                 dst->edge_height = 0; //src->edge_height;
                  dst->height = height = src->height;
          } else {

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.298
retrieving revision 1.299
diff -C2 -d -r1.298 -r1.299
*** CHANGELOG	4 Mar 2007 17:45:37 -0000	1.298
--- CHANGELOG	12 Mar 2007 20:43:26 -0000	1.299
***************
*** 1,3 ****
--- 1,12 ----
  Changelog
+ 2007-03-12:
+    - compile fix for recent ffmpeg SVN
+    - include ffmpeg headers as 'extern "C"'
+    - enable and use as default the software mixer. The old behaviour (use the
+      system's mixer) can be selected via -vo oss:mixer.
+    - increase the stepsize of the software mixer.
+    - don't scale audio if the volume is at maximum.
+    - set edge_width/_height always to zero. Fixes picture shiftes with
+      the ShmClient. This is not the optimal(/final) solution...
  2007-03-04:
     - video-dfb: Make use of SetSourceRectangle() runtime selectable,



From nobody at sheep.berlios.de  Mon Mar 12 22:33:50 2007
From: nobody at sheep.berlios.de (wachm)
Date: Mon, 12 Mar 2007 22:33:50 +0100 (CET)
Subject: [Softdevice-cvs] softplay Makefile, 1.7, 1.8 Receiver.c, 1.1,
	1.2 SoftPlayer.c, 1.15, 1.16
Message-ID: <20070312213350.0CECDDAD00@mail.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv3922

Modified Files:
	Makefile Receiver.c SoftPlayer.c 
Log Message:
- compile fix for vdr-1.5.0 and recent ffmpeg SVN


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softplay/Makefile,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** Makefile	2 Nov 2006 19:01:08 -0000	1.7
--- Makefile	12 Mar 2007 21:32:03 -0000	1.8
***************
*** 21,25 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -Woverloaded-virtual -L$(LIBFFMPEG) -L$(LIBFFMPEG)/libavformat -L$(LIBFFMPEG)/libavcodec -L$(LIBFFMPEG)/libavutil 
  
  ### The directory environment:
--- 21,25 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -Woverloaded-virtual  
  
  ### The directory environment:
***************
*** 53,57 ****
  INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include -I$(LIBFFMPEG) -I$(LIBFFMPEG)/libavformat -I$(LIBFFMPEG)/libavcodec -I$(LIBFFMPEG)/libavutil 
  
! DEFINES += -D_GNU_SOURCE -DPLUGIN_NAME_I18N='"$(PLUGIN)"'
  
  
--- 53,57 ----
  INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include -I$(LIBFFMPEG) -I$(LIBFFMPEG)/libavformat -I$(LIBFFMPEG)/libavcodec -I$(LIBFFMPEG)/libavutil 
  
! DEFINES += -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -DPLUGIN_NAME_I18N='"$(PLUGIN)"'
  
  
***************
*** 60,64 ****
  OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o PlayListMenu.o i18n.o FileIndex.o Receiver.o Setup.o
  
! LIBS = -lavformat -lavcodec -lz
  
  ### recent ffmpegs require -lavutil: 
--- 60,64 ----
  OBJS = $(PLUGIN).o SoftPlayer.o PlayList.o PlayListMenu.o i18n.o FileIndex.o Receiver.o Setup.o
  
! LIBS = -L$(LIBFFMPEG) -L$(LIBFFMPEG)/libavformat -L$(LIBFFMPEG)/libavcodec -L$(LIBFFMPEG)/libavutil -lavformat -lavcodec -lz
  
  ### recent ffmpegs require -lavutil: 

Index: Receiver.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/Receiver.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** Receiver.c	12 Mar 2006 20:23:23 -0000	1.1
--- Receiver.c	12 Mar 2007 21:32:03 -0000	1.2
***************
*** 35,39 ****
--- 35,43 ----
  cSoftplayReceiver::cSoftplayReceiver(const cChannel *Channel, cDevice *Device,
                  PacketHandlesV100 &SoftHandles) 
+ #if VDRVERSNUM >= 10500
+         : cReceiver(Channel->GetChannelID(),1,Channel->Vpid()),startChannel(*Channel),
+ #else
          : cReceiver(Channel->Ca(),0,Channel->Vpid()),startChannel(*Channel),
+ #endif
            currChannel(*Channel) {
                  RECEIVER_DEB("cSoftplayReceiver");

Index: SoftPlayer.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/SoftPlayer.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** SoftPlayer.c	25 Jul 2006 20:03:33 -0000	1.15
--- SoftPlayer.c	12 Mar 2007 21:32:03 -0000	1.16
***************
*** 331,335 ****
--- 331,339 ----
                  Receiver=new cSoftplayReceiver(channel,
                                  cDevice::PrimaryDevice(),SoftHandles);
+ #if VDRVERSNUM >= 10500 
+                 cDevice *receiveDev=cDevice::GetDevice(channel,1,false);
+ #else
                  cDevice *receiveDev=cDevice::GetDevice(channel,1);
+ #endif
                  if (receiveDev)
                          receiveDev->AttachReceiver(Receiver);
***************
*** 517,521 ****
          Receiver=NULL;
                 
!         cDevice *receiveDev=cDevice::GetDevice(channel, 1);
  
          if (!receiveDev) {
--- 521,529 ----
          Receiver=NULL;
                 
! #if VDRVERSNUM >= 10500 
!         cDevice *receiveDev=cDevice::GetDevice(channel,1,false);
! #else
!         cDevice *receiveDev=cDevice::GetDevice(channel,1);
! #endif
  
          if (!receiveDev) {
***************
*** 523,527 ****
                  Skins.Message(mtError, tr("Channel not available!"));
                  channel = Channels.GetByNumber( currChannelNo );
!                 receiveDev=cDevice::GetDevice(channel, 1);
                  if (!receiveDev) {
                          printf("Jetzt bin ich angeschmiert\n");
--- 531,539 ----
                  Skins.Message(mtError, tr("Channel not available!"));
                  channel = Channels.GetByNumber( currChannelNo );
! #if VDRVERSNUM >= 10500 
!                 receiveDev=cDevice::GetDevice(channel,1,false);
! #else
!                 receiveDev=cDevice::GetDevice(channel,1);
! #endif
                  if (!receiveDev) {
                          printf("Jetzt bin ich angeschmiert\n");
***************
*** 831,836 ****
  		case k9: if (playList) {
  				 const char * nextFile=playList->NextFile();
  				 if ( nextFile 
!                                       && SoftplaySetup.ReturnToLiveTV() )
  					 SoftPlayer->PlayFile(nextFile);
                                   else {  // last file
--- 843,850 ----
  		case k9: if (playList) {
  				 const char * nextFile=playList->NextFile();
+                                  printf("nextfile %p ReturnToLiveTv() %d\n",
+                                                  nextFile,SoftplaySetup.ReturnToLiveTV());
  				 if ( nextFile 
!                                       || !SoftplaySetup.ReturnToLiveTV() )
  					 SoftPlayer->PlayFile(nextFile);
                                   else {  // last file
***************
*** 854,858 ****
  		case k6: if (playList) {
  				 const char * nextFile=playList->NextAlbumFile();
! 				 if (nextFile)
  					 SoftPlayer->PlayFile(nextFile);
                                   else {  // last file
--- 868,873 ----
  		case k6: if (playList) {
  				 const char * nextFile=playList->NextAlbumFile();
! 				 if ( nextFile
!                                       || !SoftplaySetup.ReturnToLiveTV() )
  					 SoftPlayer->PlayFile(nextFile);
                                   else {  // last file



From nobody at sheep.berlios.de  Sat Mar 17 09:51:07 2007
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 17 Mar 2007 09:51:07 +0100 (CET)
Subject: [Softdevice-cvs] softplay Makefile,1.8,1.9
Message-ID: <20070317085107.D4DC8DCB07@mail.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv357

Modified Files:
	Makefile 
Log Message:
fix compile for opensuse 10.2 x86-64

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softplay/Makefile,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** Makefile	12 Mar 2007 21:32:03 -0000	1.8
--- Makefile	17 Mar 2007 08:49:24 -0000	1.9
***************
*** 21,25 ****
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -Wall -Woverloaded-virtual  
  
  ### The directory environment:
--- 21,25 ----
  
  CXX      ?= g++
! CXXFLAGS ?= -g -O2 -fPIC -Wall -Woverloaded-virtual  
  
  ### The directory environment:



From nobody at sheep.berlios.de  Sun Mar 25 10:56:03 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 25 Mar 2007 10:56:03 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice mpeg2decoder.h, 1.40, 1.41 sync-timer.h,
	1.4, 1.5
Message-ID: <20070325085603.28972DD2E2@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16121

Modified Files:
	mpeg2decoder.h sync-timer.h 
Log Message:
- fix types in GetTime()


Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** mpeg2decoder.h	12 Mar 2007 20:05:44 -0000	1.40
--- mpeg2decoder.h	25 Mar 2007 08:54:12 -0000	1.41
***************
*** 72,78 ****
      {
        struct timeval tv;
!       struct timezone tz;
!       gettimeofday(&tv,&tz);
!       return tv.tv_sec*10000+tv.tv_usec/100;
      };
  
--- 72,77 ----
      {
        struct timeval tv;
!       gettimeofday(&tv,NULL);
!       return (int64_t)tv.tv_sec*10000+(int64_t)tv.tv_usec/100;
      };
  

Index: sync-timer.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/sync-timer.h,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** sync-timer.h	3 Oct 2006 19:50:43 -0000	1.4
--- sync-timer.h	25 Mar 2007 08:54:12 -0000	1.5
***************
*** 17,23 ****
        {
          struct timeval tv;
!         struct timezone tz;
!         gettimeofday(&tv,&tz);
!         return tv.tv_sec*1000000+tv.tv_usec;
        };
  
--- 17,22 ----
        {
          struct timeval tv;
!         gettimeofday(&tv,NULL);
!         return (int64_t)tv.tv_sec*1000000+(int64_t)tv.tv_usec;
        };
  



From nobody at sheep.berlios.de  Sun Mar 25 11:02:03 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 25 Mar 2007 11:02:03 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video.c, 1.73, 1.74 CHANGELOG, 1.299,
	1.300
Message-ID: <20070325090203.13D65D995D@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17703

Modified Files:
	video.c CHANGELOG 
Log Message:
- pts values are stored in uint64_t


Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.73
retrieving revision 1.74
diff -C2 -d -r1.73 -r1.74
*** video.c	26 Feb 2007 23:00:34 -0000	1.73
--- video.c	25 Mar 2007 09:00:11 -0000	1.74
***************
*** 516,520 ****
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::EvaluateDelay(int aPTS, int pts, int frametime)
  {
      int   offset,
--- 516,520 ----
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::EvaluateDelay(uint64_t aPTS, uint64_t pts, int frametime)
  {
      int   offset,

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.299
retrieving revision 1.300
diff -C2 -d -r1.299 -r1.300
*** CHANGELOG	12 Mar 2007 20:43:26 -0000	1.299
--- CHANGELOG	25 Mar 2007 09:00:11 -0000	1.300
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2007-03-25:
+    - fix types in GetTime().
+    - pts values are stored in uint64_t
  2007-03-12:
     - compile fix for recent ffmpeg SVN



From nobody at sheep.berlios.de  Sun Mar 25 11:07:42 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 25 Mar 2007 11:07:42 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video.h,1.51,1.52
Message-ID: <20070325090742.56AF4D1035@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18112

Modified Files:
	video.h 
Log Message:
- pts values are stored in uint64_t


Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.51
retrieving revision 1.52
diff -C2 -d -r1.51 -r1.52
*** video.h	26 Feb 2007 23:00:34 -0000	1.51
--- video.h	25 Mar 2007 09:05:56 -0000	1.52
***************
*** 165,169 ****
                                   sPicBuffer *pic);
      virtual void DrawStill_420pl(sPicBuffer *buf);
!     virtual void EvaluateDelay(int aPTS, int pts, int frametime);
      virtual void ResetDelay(void);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};
--- 165,169 ----
                                   sPicBuffer *pic);
      virtual void DrawStill_420pl(sPicBuffer *buf);
!     virtual void EvaluateDelay(uint64_t aPTS, uint64_t pts, int frametime);
      virtual void ResetDelay(void);
      virtual bool Initialize(void) {videoInitialized = true; return 1;};



From nobody at sheep.berlios.de  Sun Mar 25 11:10:09 2007
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 25 Mar 2007 11:10:09 +0200 (CEST)
Subject: [Softdevice-cvs] softdevice video-fb.c, 1.17, 1.18 video-fb.h, 1.9,
	1.10 CHANGELOG, 1.300, 1.301
Message-ID: <20070325091009.93B81DE8F3@mail.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv18227

Modified Files:
	video-fb.c video-fb.h CHANGELOG 
Log Message:
- almost complete rewrite of video-fb. Supported are now 15,16,24 and 32 bit
   depth framebuffers. The osd is rendered with software alpha blending,
   and it is even faster :-)



Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** video-fb.c	11 Nov 2006 08:45:17 -0000	1.17
--- video-fb.c	25 Mar 2007 09:08:22 -0000	1.18
***************
*** 46,51 ****
      fb_orig_vinfo = fb_vinfo;
  
!     switch (fb_finfo.visual) {
  
         case FB_VISUAL_TRUECOLOR:
             printf("[video-fb] Truecolor FB found\n");
--- 46,78 ----
      fb_orig_vinfo = fb_vinfo;
  
!     size = fb_finfo.smem_len;
!     line_len = fb_finfo.line_length;
!     if ((fb = (unsigned char *) mmap(0, size, PROT_READ | PROT_WRITE, MAP_SHARED, fbdev, 0)) == (unsigned char *) -1) {
!         printf("[video-fb] Can't mmap\n");
!         exit(1);
!     }
  
+     // set up picture buffer;
+     privBuf.pixel[0]=fb;
+     privBuf.stride[0]=line_len;
+     if (fb_vinfo.red.length==5 && fb_vinfo.green.length==5
+          && fb_vinfo.blue.length==5 ) 
+             Bpp=15;
+     else Bpp=fb_vinfo.bits_per_pixel;
+     switch (Bpp) {
+             case 32 : privBuf.format=PIX_FMT_RGBA32;
+                       break;
+             case 24 : privBuf.format=PIX_FMT_RGB24;
+                       break;
+             case 16 : 
+                       privBuf.format=PIX_FMT_RGB565;
+                       break;
+             default:
+                       privBuf.format=PIX_FMT_RGB555;
+     };
+     privBuf.max_width=dwidth=fb_vinfo.xres;
+     privBuf.max_height=dheight=fb_vinfo.yres;
+ 
+     switch (fb_finfo.visual) {
         case FB_VISUAL_TRUECOLOR:
             printf("[video-fb] Truecolor FB found\n");
***************
*** 59,63 ****
             printf("[video-fb] DirectColor FB found\n");
  
!            orig_cmaplen = 32;
             orig_cmap = (__u16 *) malloc ( 3 * orig_cmaplen * sizeof(*orig_cmap) );
  
--- 86,90 ----
             printf("[video-fb] DirectColor FB found\n");
  
!            orig_cmaplen = 1<<fb_vinfo.green.length;
             orig_cmap = (__u16 *) malloc ( 3 * orig_cmaplen * sizeof(*orig_cmap) );
  
***************
*** 82,86 ****
                 green[i] = (65535/(orig_cmaplen+1))*i;
                 blue[i] =  (65535/(orig_cmaplen+1))*i;
-                //(i<<8)|i;
             }
  
--- 109,112 ----
***************
*** 100,210 ****
  
         default:
!            printf("cFBVideoOut: Unsupported FB. Don't know if it will work.\n");
!     }
! 
! 
!     // currently we support only 16 bit FB's
! 
!     size = fb_finfo.smem_len;
!     line_len = fb_finfo.line_length;
!     if ((fb = (unsigned char *) mmap(0, size, PROT_READ | PROT_WRITE, MAP_SHARED, fbdev, 0)) == (unsigned char *) -1) {
!         printf("[video-fb] Can't mmap\n");
!         exit(1);
!     }
! 
!     Xres=fb_vinfo.xres;
!     Yres=fb_vinfo.yres;
!     Bpp = fb_vinfo.bits_per_pixel;
!     if (Bpp != 16 && Bpp != 15) {
!         printf ("[video-fb] In software-mode only 15/16 bit Framebuffer supported\n");
!         exit(1);
      }
  
-     // set rgb unpack method
-     mmx_unpack=mmx_unpack_16rgb;
-     if (fb_vinfo.red.length==5 && fb_vinfo.green.length==5
-          && fb_vinfo.blue.length==5 ) {
-       mmx_unpack=mmx_unpack_15rgb;
-       printf("[video-fb] Using mmx_unpack_15rgb\n");
-     };
- 
-     int OsdYres=Yres>OSD_FULL_HEIGHT?Yres:OSD_FULL_HEIGHT;
-     PixelMask = (unsigned char *)malloc(OsdYres*line_len / ((Bpp+7) / 8) / 8); // where the Video window should be transparent
- 
-     OSDpresent=false;
- 
      printf("[video-fb] init %d x %d (Size: %zu Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
      // clear screens
      printf("[video-fb] Clearing the FB\n");
-     unsigned char * fbinit;
-     fbinit=fb;
-     for (int i = 0; i <Yres*line_len; i++) {
-         *fbinit=0;
-         fbinit++;
-     }
-     screenPixelAspect = -1;
- }
  
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::Pause(void)
! {
! }
  
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::OpenOSD()
! {
!   cVideoOut::OpenOSD();
!   //OSDxOfs = X & ~7;
!   //OSDyOfs = Y & ~1;
  }
  
  /* ---------------------------------------------------------------------------
   */
- void cFBVideoOut::ClearOSD()
- {
-   cVideoOut::ClearOSD();
-   if (videoInitialized && PixelMask)
-     memset(PixelMask, 0, Xres * Yres/8);
- };
- 
- /* ---------------------------------------------------------------------------
-  */
  void cFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                                   int &xPan, int &yPan) {
!    switch (current_osdMode) {
!       case OSDMODE_PSEUDO :
!                 OsdWidth=Xres;
!                 OsdHeight=Yres;
!                 xPan = yPan = 0;
!              break;
!     }
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines)
! {
!   pthread_mutex_lock(&fb_mutex);
! 
!   osd = NULL;
!   stride = 0;
!   if (!videoInitialized)
!     return;
! 
!   osd=fb;
!   stride=line_len;
!   dirtyLines=NULL;
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! void cFBVideoOut::CommitUnlockOsdSurface()
! {
!   pthread_mutex_unlock(&fb_mutex);
!   cVideoOut::CommitUnlockOsdSurface();
! }
  
  /* ---------------------------------------------------------------------------
--- 126,150 ----
  
         default:
!            printf("cFBVideoOut: Unsupported FB(%d). Don't know if it will work.\n",fb_finfo.visual);
      }
  
      printf("[video-fb] init %d x %d (Size: %zu Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
      // clear screens
      printf("[video-fb] Clearing the FB\n");
  
!     ClearPicBuffer(&privBuf);
  
!     screenPixelAspect = -1;
  }
  
  /* ---------------------------------------------------------------------------
   */
  void cFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight,
!                 int &xPan, int &yPan) {
!   OsdWidth=swidth;
!   OsdHeight=sheight;
!   xPan = sxoff;
!   yPan = syoff;
! };
  
  /* ---------------------------------------------------------------------------
***************
*** 212,226 ****
  void cFBVideoOut::YUV(sPicBuffer *buf)
  {
-   uint8_t *Py=buf->pixel[0]
-                 +(buf->edge_height)*buf->stride[0]
-                 +buf->edge_width;
-   uint8_t *Pu=buf->pixel[1]+(buf->edge_height/2)*buf->stride[1]
-                 +buf->edge_width/2;
-   uint8_t *Pv=buf->pixel[2]+(buf->edge_height/2)*buf->stride[2]
-                 +buf->edge_width/2;
-   int Ystride=buf->stride[0];
-   int UVstride=buf->stride[1];
-   int Width=buf->width;
-   int Height=buf->height;
  
    if (!videoInitialized)
--- 152,155 ----
***************
*** 228,244 ****
  
    pthread_mutex_lock(&fb_mutex);
!   if (OSDpresent) {
!     yuv_to_rgb (fb, Py, Pu, Pv,
!                 Width, Height, line_len,
!                 Ystride,UVstride,
!                 Xres,Yres,
!                 Bpp, PixelMask, setupStore->deintMethod);
!   } else {
!     yuv_to_rgb (fb, Py, Pu, Pv,
!                 Width, Height, line_len,
!                 Ystride,UVstride,
!                 Xres,Yres,
!                 Bpp, NULL, setupStore->deintMethod);
    }
    pthread_mutex_unlock(&fb_mutex);
  }
--- 157,190 ----
  
    pthread_mutex_lock(&fb_mutex);
!   if (aspect_changed ||
!       cutTop != setupStore->cropTopLines ||
!       cutBottom != setupStore->cropBottomLines ||
!       cutLeft != setupStore->cropLeftCols ||
!       cutRight != setupStore->cropRightCols)
!   {
!     aspect_changed = 0;
!     cutTop = setupStore->cropTopLines;
!     cutBottom = setupStore->cropBottomLines;
!     cutLeft = setupStore->cropLeftCols;
!     cutRight = setupStore->cropRightCols;
!     ClearPicBuffer(&privBuf);
    }
+   if ( OSDpresent ) {
+     CopyScalePicBufAlphaBlend(&privBuf,buf,
+         sxoff, syoff,
+         swidth, sheight,
+         lxoff,  lyoff,
+         lwidth, lheight,
+         OsdPy,OsdPu,OsdPv,
+         OsdPAlphaY,OsdPAlphaUV,OSD_FULL_WIDTH,
+         cutTop,cutBottom,cutLeft,cutRight);
+   } else {
+     CopyScalePicBuf(&privBuf, buf,                   
+         sxoff, syoff,
+         swidth, sheight,
+         lxoff,  lyoff,    
+         lwidth, lheight,
+         cutTop,cutBottom,cutLeft,cutRight);
+   };
    pthread_mutex_unlock(&fb_mutex);
  }

Index: video-fb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-fb.h	11 Nov 2006 08:45:17 -0000	1.9
--- video-fb.h	25 Mar 2007 09:08:22 -0000	1.10
***************
*** 22,44 ****
    __u16 * orig_cmap;
  
-   uint8_t *PixelMask;
    size_t size;
    int line_len;
    unsigned char * fb;	// Framebuffer memory
  public:
    cFBVideoOut(cSetupStore *setupStore);
    virtual ~cFBVideoOut();
-   virtual void OpenOSD();
-   virtual void ClearOSD();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
  		  bool &IsYUV, uint8_t *&pixelmask)
!   { Depth=16;HasAlpha=false;IsYUV=false;pixelmask=PixelMask; };
!   virtual void GetLockOsdSurface(uint8_t *&osd, int &stride,
!                   bool *&dirtyLines);
!   virtual void CommitUnlockOsdSurface();
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                 int &xPan, int &yPan);
    virtual void YUV(sPicBuffer *Pic);
-   virtual void Pause(void);
  };
  
--- 22,38 ----
    __u16 * orig_cmap;
  
    size_t size;
    int line_len;
    unsigned char * fb;	// Framebuffer memory
+   sPicBuffer privBuf;
  public:
    cFBVideoOut(cSetupStore *setupStore);
    virtual ~cFBVideoOut();
    virtual void GetOSDMode(int &Depth, bool &HasAlpha, bool &AlphaInversed,
  		  bool &IsYUV, uint8_t *&pixelmask)
!   { IsYUV=true;};
    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight,
                                 int &xPan, int &yPan);
    virtual void YUV(sPicBuffer *Pic);
  };
  

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.300
retrieving revision 1.301
diff -C2 -d -r1.300 -r1.301
*** CHANGELOG	25 Mar 2007 09:00:11 -0000	1.300
--- CHANGELOG	25 Mar 2007 09:08:22 -0000	1.301
***************
*** 3,6 ****
--- 3,9 ----
     - fix types in GetTime().
     - pts values are stored in uint64_t
+    - almost complete rewrite of video-fb. Supported are now 15,16,24 and 32 bit
+      depth framebuffers. The osd is rendered with software alpha blending,
+      and it is even faster :-)
  2007-03-12:
     - compile fix for recent ffmpeg SVN



