From nobody at sheep.berlios.de  Mon Oct  3 18:04:58 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 3 Oct 2005 18:04:58 +0200
Subject: [Softdevice-cvs] softdevice configure,1.4,1.5
Message-ID: <200510031604.j93G4w907433@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4359

Modified Files:
	configure 
Log Message:
DFB: fix check of DIEF_REPEAT

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.4
retrieving revision 1.5
diff -C2 -d -r1.4 -r1.5
*** configure	17 Sep 2005 16:17:15 -0000	1.4
--- configure	3 Oct 2005 16:04:55 -0000	1.5
***************
*** 125,129 ****
  int main(void) {
      DFBInputEvent event;
!   event.flags |= DIEF_REPEAT;
    return 0;
  }
--- 125,129 ----
  int main(void) {
      DFBInputEvent event;
!   event.flags = DIEF_REPEAT;
    return 0;
  }
***************
*** 244,248 ****
    fi
  
!   if test "${dfb_dfb_dief_repeat}" = "yes" ; then
      echo "#define HAVE_DIEF_REPEAT                1" >> $TMPH
    else
--- 244,248 ----
    fi
  
!   if test "${dfb_dief_repeat}" = "yes" ; then
      echo "#define HAVE_DIEF_REPEAT                1" >> $TMPH
    else



From nobody at sheep.berlios.de  Mon Oct  3 20:57:14 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 3 Oct 2005 20:57:14 +0200
Subject: [Softdevice-cvs] softdevice Makefile,1.17,1.18
Message-ID: <200510031857.j93IvE915899@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17702

Modified Files:
	Makefile 
Log Message:
don't link vidix into core, when USE_SUBPLUGINS is specified

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.17
retrieving revision 1.18
diff -C2 -d -r1.17 -r1.18
*** Makefile	18 Sep 2005 15:17:44 -0000	1.17
--- Makefile	3 Oct 2005 18:57:11 -0000	1.18
***************
*** 256,260 ****
      LIBS        += -lvidix
    endif
-   LIBS        += $(VIDIX_LIBS)
    INCLUDES    += $(VIDIX_CFLAGS)
  endif
--- 256,259 ----



From nobody at sheep.berlios.de  Wed Oct  5 15:05:47 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 5 Oct 2005 15:05:47 +0200
Subject: [Softdevice-cvs] softdevice configure,1.5,1.6
Message-ID: <200510051305.j95D5l901436@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv17149

Modified Files:
	configure 
Log Message:
check for X11

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** configure	3 Oct 2005 16:04:55 -0000	1.5
--- configure	5 Oct 2005 13:05:42 -0000	1.6
***************
*** 153,156 ****
--- 153,173 ----
  
  #########################################################
+ # X11: check if X11 is present
+ #
+ if test "${xv}" = "yes" ; then
+   xv_libs="-L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv"
+   cat > ${TMPC} << EOF
+ #include <stdio.h>
+ #include <X11/Xlib.h>
+ int main(void) {
+     Display       *dpy;
+   dpy = XOpenDisplay(NULL);
+   return 0;
+ }
+ EOF
+ $cc $CFLAGS $xv_libs -o $TMPE $TMPC > /dev/null 2>&1 || xv="no"
+ fi
+ 
+ #########################################################
  broken_gcc_cpp="no"
  cat > ${TMPC} << EOF
***************
*** 270,274 ****
    echo "XV_SUPPORT       = 1" >> $TMPM
    echo "LIBXDPMS_SUPPORT = 1" >> $TMPM
!   echo "XV_LIBS          = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv"  >> $TMPM
    echo "#define XV_SUPPORT       1" >> $TMPH
    echo "#define LIBXDPMS_SUPPORT 1" >> $TMPH
--- 287,291 ----
    echo "XV_SUPPORT       = 1" >> $TMPM
    echo "LIBXDPMS_SUPPORT = 1" >> $TMPM
!   echo "XV_LIBS          = ${xv_libs}"  >> $TMPM
    echo "#define XV_SUPPORT       1" >> $TMPH
    echo "#define LIBXDPMS_SUPPORT 1" >> $TMPH



From nobody at sheep.berlios.de  Thu Oct  6 11:03:49 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 6 Oct 2005 11:03:49 +0200
Subject: [Softdevice-cvs] softdevice configure,1.6,1.7
Message-ID: <200510060903.j9693n905824@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9188

Modified Files:
	configure 
Log Message:
check for PKG_CONFIG_PATH set, report unset variables

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** configure	5 Oct 2005 13:05:42 -0000	1.6
--- configure	6 Oct 2005 09:03:47 -0000	1.7
***************
*** 12,16 ****
  TMPM="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.mak"
  
! PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig/
  
  dfb="yes"
--- 12,23 ----
  TMPM="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.mak"
  
! if test -z "$PKG_CONFIG_PATH" ; then
!   PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
! else
!   PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig
! fi
! 
! set -u
! : ${CFLAGS=""}
  
  dfb="yes"



From nobody at sheep.berlios.de  Thu Oct  6 23:16:50 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 6 Oct 2005 23:16:50 +0200
Subject: [Softdevice-cvs] softdevice audio-ac3pt.c,NONE,1.1 audio-ac3pt.h,NONE,1.1
Message-ID: <200510062116.j96LGo901142@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15312

Added Files:
	audio-ac3pt.c audio-ac3pt.h 
Log Message:
AC3 pass through

--- NEW FILE: audio-ac3pt.c ---
/*
 * audio-ac3pt.c: alsa AC3 pass through
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: audio-ac3pt.c,v 1.1 2005/10/06 21:16:47 lucke Exp $
 */

#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <math.h>

#include <sys/time.h>

#define ALSA_PCM_NEW_HW_PARAMS_API
#define ALSA_PCM_NEW_SW_PARAMS_API
#include <alsa/asoundlib.h>
#include "audio-ac3pt.h"

enum {SPDIF_CON, SPDIF_PRO} spdif_t;


#ifndef WORDS_BIGENDIAN
# define char2short(a,b)    ((((b) << 8) & 0xffff) ^ ((a) & 0xffff))
# define shorts(a)          (a)
#else
# define char2short(a,b)    ((((a) << 8) & 0xffff) ^ ((b) & 0xffff))
# define shorts(a)          char2short(((a) & 0xff),(((a) >> 8) & 0xff));
#endif

#define EINTR_RETRY(exp)                    \
    (__extension__ ({                       \
    int __result;                           \
    do __result = (int) (exp);              \
    while (__result < 0 && errno == EINTR); \
    __result; }))


unsigned int              rate = 48000;
unsigned int              iec958_aes3_con_fs_rate = IEC958_AES3_CON_FS_48000;
unsigned int              iec958_aes0_pro_fs_rate = IEC958_AES0_PRO_FS_48000;
static int                smin = 32;
unsigned int              frames  = 10;
static const char         head[4] = { 0x72, 0xf8, 0x1f, 0x4e };
static u_char             buf[BURST_SIZE];
static u_char             pbuf[BURST_SIZE];
static u_char             *sbuffer = &buf[10];
static unsigned int       sbuffer_size = 0;

#define AC3_BLOCK_SIZE 2048
static unsigned char      inbuf[2*AC3_BLOCK_SIZE];
typedef struct _source_t {
  unsigned char  *out, *end, *tail;
  size_t  framesize;
} source_t;

static source_t ac3 = {
  inbuf,                  // out
  inbuf + sizeof(inbuf),  // end
  inbuf,                  // tail
  AC3_BLOCK_SIZE,         // framesize
};

struct frmsize_s
{
  unsigned short bit_rate;
  unsigned short frm_size[3];
};

static const struct frmsize_s frmsizecod_tbl[64] =
{
  { 32  ,{64   ,69   ,96   } },
  { 32  ,{64   ,70   ,96   } },
  { 40  ,{80   ,87   ,120  } },
  { 40  ,{80   ,88   ,120  } },
  { 48  ,{96   ,104  ,144  } },
  { 48  ,{96   ,105  ,144  } },
  { 56  ,{112  ,121  ,168  } },
  { 56  ,{112  ,122  ,168  } },
  { 64  ,{128  ,139  ,192  } },
  { 64  ,{128  ,140  ,192  } },
  { 80  ,{160  ,174  ,240  } },
  { 80  ,{160  ,175  ,240  } },
  { 96  ,{192  ,208  ,288  } },
  { 96  ,{192  ,209  ,288  } },
  { 112 ,{224  ,243  ,336  } },
  { 112 ,{224  ,244  ,336  } },
  { 128 ,{256  ,278  ,384  } },
  { 128 ,{256  ,279  ,384  } },
  { 160 ,{320  ,348  ,480  } },
  { 160 ,{320  ,349  ,480  } },
  { 192 ,{384  ,417  ,576  } },
  { 192 ,{384  ,418  ,576  } },
  { 224 ,{448  ,487  ,672  } },
  { 224 ,{448  ,488  ,672  } },
  { 256 ,{512  ,557  ,768  } },
  { 256 ,{512  ,558  ,768  } },
  { 320 ,{640  ,696  ,960  } },
  { 320 ,{640  ,697  ,960  } },
  { 384 ,{768  ,835  ,1152 } },
  { 384 ,{768  ,836  ,1152 } },
  { 448 ,{896  ,975  ,1344 } },
  { 448 ,{896  ,976  ,1344 } },
  { 512 ,{1024 ,1114 ,1536 } },
  { 512 ,{1024 ,1115 ,1536 } },
  { 576 ,{1152 ,1253 ,1728 } },
  { 576 ,{1152 ,1254 ,1728 } },
  { 640 ,{1280 ,1393 ,1920 } },
  { 640 ,{1280 ,1394 ,1920 } }
};

static const unsigned int freqcod_tbl[4] =
{
  48000, 44100, 32000, 0
};

typedef struct syncinfo_s
{
  unsigned int    magic;
  unsigned short  syncword;         /* Sync word == 0x0B77 */
  /* uint_16   crc1; */             /* crc for the first 5/8 of the sync block */
  unsigned short  fscod;            /* Stream Sampling Rate (kHz)
                                        0 = 48,
                                        1 = 44.1,
                                        2 = 32,
                                        3 = reserved */
  unsigned short  frmsizecod;       /* Frame size code */
  unsigned short  frame_size;       /* Information not in the AC-3 bitstream, but derived */
                                    /* Frame size in 16 bit words */
  unsigned short  bit_rate;         /* Bit rate in kilobits */
  unsigned int    sampling_rate;    /* sampling rate in hertz */

} syncinfo_t;

static syncinfo_t syncinfo;


/* ----------------------------------------------------------------------------
 * Parse a syncinfo structure, minus the sync word
 */
void
parse_syncinfo(syncinfo_t *syncinfo, unsigned char *data)
{
  //
  // We need to read in the entire syncinfo struct (0x0b77 + 24 bits)
  // in order to determine how big the frame is
  //

  // Get the frequency and sampling code
  syncinfo->fscod  = (data[2] & 0xc0) >> 6;

  // Calculate the sampling rate
  syncinfo->sampling_rate = freqcod_tbl[syncinfo->fscod];
  if (syncinfo->fscod > 2) {
    syncinfo->frame_size = 0;
    syncinfo->bit_rate = 0;
    return;
  }

  // Get the frame size code
  syncinfo->frmsizecod = data[2] & 0x3f;

  // Calculate the frame size and bitrate
  syncinfo->frame_size =
        frmsizecod_tbl[syncinfo->frmsizecod].frm_size[syncinfo->fscod];
  syncinfo->bit_rate = frmsizecod_tbl[syncinfo->frmsizecod].bit_rate;
}

/* ----------------------------------------------------------------------------
 */
static bool
buffer_syncframe(syncinfo_t *syncinfo, source_t *ac3)
{
    unsigned short  syncword = syncinfo->syncword;
    unsigned int    payload_size;
    bool            play = false;

resync:
  //
  // Find an ac3 sync frame.
  //
  while(syncword != 0x0b77) {
    if (ac3->out >= ac3->tail)
      goto done;
    syncword = (syncword << 8) | *ac3->out++;
  }

  /* --------------------------------------------------------------------------
   * Need the next 3 bytes to decide how big the frame is
   */
  while(sbuffer_size < 3) {
    if (ac3->out >= ac3->tail)
      goto done;
    sbuffer[sbuffer_size++] = *ac3->out++;
  }

  /* --------------------------------------------------------------------------
   * Parse and check syncinfo
   */
  parse_syncinfo(syncinfo, sbuffer);
  if (!syncinfo->frame_size) {
    syncword = 0xffff;
    sbuffer_size = 0;
    fprintf(stderr, "ac3play: ** Invalid frame found - try to syncing **\n\r");
    if (ac3->out >= ac3->tail)
      goto done;
    else
      goto resync;
  }
  ac3->framesize = syncinfo->frame_size * 2;
  payload_size = (unsigned int)(ac3->framesize - 2);

  //
  // Maybe: Reinit spdif interface if sample rate is changed
  //
  if (syncinfo->sampling_rate != rate) {
    fprintf(stderr,
            "ac3play: Warning: sample rate of"
            " the current AC-3 stream (%d) does not\n\r",
            syncinfo->sampling_rate);
    fprintf(stderr, "	 fit the configured PCM rate (%d)!\n\r", rate);
  }

  while(sbuffer_size < payload_size) {
    if (ac3->out >= ac3->tail)
      goto done;
    sbuffer[sbuffer_size++] = *ac3->out++;
  }

  //
  // Check the crc over the entire frame
  //
#if 0
  if(!crc_check(sbuffer, payload_size))
  {
    syncword = 0xffff;
    sbuffer_size = 0;
    fprintf(stderr, "ac3play: ** CRC failed - try to syncing **\n\r");
    if (ac3->out >= ac3->tail)
      goto done;
    else
      goto resync;
  }
#endif
  //
  // If we reach this point, we found a valid AC3 frame to warp into PCM (IEC60958)
  //
  play = true;

  //
  // Reset the syncword for next time
  //
  syncword = 0xffff;
  sbuffer_size = 0;
done:
  syncinfo->syncword = syncword;
  return play;
}

/* ----------------------------------------------------------------------------
 */
cAlsaAC3pt::cAlsaAC3pt()
{
  ac3Status = NULL;
  buffer_size = 0;
}

/* ----------------------------------------------------------------------------
 */
cAlsaAC3pt::~cAlsaAC3pt()
{
  if (ac3Status)
    snd_pcm_status_free(ac3Status);
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::XunderrunAC3(snd_pcm_t *handle)
{
    snd_pcm_sframes_t res;

  if ((res = snd_pcm_status(handle, ac3Status))<0) {
    fprintf(stderr, "ac3play: ac3Status error: %s\n\r", snd_strerror(res));
    return;
  }
  if (snd_pcm_status_get_state(ac3Status) == SND_PCM_STATE_XRUN) {
      struct timeval now, diff, tstamp;
    gettimeofday(&now, 0);
    snd_pcm_status_get_trigger_tstamp(ac3Status, &tstamp);
    timersub(&now, &tstamp, &diff);
    fprintf(stderr, "ac3play: xunderrun!!! (at least %.3f ms long)\n\r",
            diff.tv_sec * 1000 + diff.tv_usec / 1000.0);
    if ((res = snd_pcm_prepare(handle))<0) {
      fprintf(stderr, "ac3play: xunderrun: prepare error: %s\n\r",
              snd_strerror(res));
      return;
    }
    return;/* ok, data should be accepted again */
  }
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::XsuspendAC3(snd_pcm_t *handle)
{
    snd_pcm_sframes_t res;

  if ((res = snd_pcm_status(handle, ac3Status))<0) {
    fprintf(stderr, "ac3play: ac3Status error: %s\n\r", snd_strerror(res));
    return;
  }
  if (snd_pcm_status_get_state(ac3Status) == SND_PCM_STATE_SUSPENDED) {
    fprintf(stderr, "ac3play: xsuspend!!! trying to resume\n\r");
    while ((res = snd_pcm_resume(handle)) == -EAGAIN)
      usleep(100000);
    if ((res = snd_pcm_prepare(handle))<0) {
      fprintf(stderr, "ac3play: xsuspend: prepare error: %s\n\r",
                      snd_strerror(res));
      return;
    }
    return;/* ok, data should be accepted again */
  }
}

/* ----------------------------------------------------------------------------
 */
int
cAlsaAC3pt::CheckDelayAC3(snd_pcm_t *handle)
{
    int grade = LOW;

  ac3Delay = 0;
  if (ac3First)    // Not running is LOW
    return grade;

  snd_pcm_delay(handle, &ac3Delay);
  if (ac3Delay < 4*PERIODSIZE)
    grade = LOW;
  else if (ac3Delay > (snd_pcm_sframes_t) (buffer_size - PERIODSIZE))
    grade = HIGH;
  else
    grade = OK;

  return grade;
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::ShiftAC3(void)
{
  // Ringbuffer arithmetics
  if (ac3.out >= ac3.tail) {
    // empty, reset buffer
    ac3.out   = inbuf;
    ac3.tail  = inbuf;
    return;
  }
  if (ac3.out > &inbuf[0]) {
    // buffer not empty, move contens
    off_t len = ac3.tail - ac3.out;
    ac3.out   = (unsigned char *) memmove(&inbuf[0], ac3.out, len);
    ac3.tail  = ac3.out + len;
  }
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::WriteBurstAC3(snd_pcm_t *handle, unsigned char *data, snd_pcm_sframes_t count)
{
    int grade;

  if ((grade = CheckDelayAC3(handle)) == HIGH)
    // High state, wait
    EINTR_RETRY(snd_pcm_wait(handle, -1));

  while(count > 0) {
    snd_pcm_sframes_t r = 0;
    if ((r = snd_pcm_writei (handle, (void *)data, count)) < 0) {
      switch(r) {
        case -EAGAIN:
        case -EBUSY:
          EINTR_RETRY(snd_pcm_wait(handle, -1));
        case -EINTR:
          continue;
        case -EPIPE:
          XunderrunAC3(handle);
          continue;
        case -ESTRPIPE:
          XsuspendAC3(handle);
          continue;
        default:
          fprintf(stderr, "ac3play: snd_pcm_writei returned error: %s\n\r",
                  snd_strerror(r));
          exit(1);
      }
    }

    if (r < count)
      EINTR_RETRY(snd_pcm_wait(handle, -1));

    count -= r;
    data += r * SAMPLE_CNT;
  }
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::WritePauseBurstAC3(snd_pcm_t *handle, int leadin)
{
    unsigned short int *sbuf = (unsigned short int *) pbuf;

  // Don't set or overwrite spdif header,
  // this is done in spdif_init only once
  switch (leadin) {
    default:
    case 0:
      sbuf[2] = char2short(0x00, 7<<5);// null frame, stream = 7
      sbuf[3] = shorts(0x0000);// No data therein
      break;
    case 1:
      sbuf[2] = char2short(0x03, 0x00);// Audio ES Channel empty, wait for DD Decoder or pause
      sbuf[3] = char2short(0x20, 0x00);// Trailing frame size is 0x0020 aka 32 bits payload
      break;
    case -1:
      sbuf[2] = char2short(0x03, 0x01);// User stop, skip or error
      sbuf[3] = char2short(0x00, 0x08);// Trailing frame size is zero
      break;
  }

  // SAMPLE_BUF is BURST_SIZE/4
  WriteBurstAC3(handle, pbuf, SAMPLE_BUF);
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::WriteFullBurstAC3(snd_pcm_t *handle)
{
    unsigned short int  *sbuf = (unsigned short int *)&buf[0];
    size_t              len = (syncinfo.frame_size * 2) - 2;

  if (ac3First) {
    // Send some trailing zeros to avoid misdetecting the
    // first frame as PCM (works for DTT2500 and VXAE07 at least)
    ac3First = false;
    WritePauseBurstAC3(handle, 0);
    WritePauseBurstAC3(handle, 0);
    WritePauseBurstAC3(handle, 1);
  }

  // Don't set or overwrite spdif header,
  // this is done in spdif_init only once

  sbuf[2] = char2short(0x01, buf[13]&7);		// AC3 data, bsmod: stream = 0
  sbuf[3] = shorts(syncinfo.frame_size * 16);	// Trailing AC3 frame size
  sbuf[4] = char2short(0x77, 0x0b);		// AC3 syncwork

#ifndef WORDS_BIGENDIAN
  // extract_ac3 seems to write swabbed data
  swab(&buf[10], &buf[10], len);
#endif
  // With padding zeros and do not overwrite IEC958 head
  memset(&buf[10] + len, 0, BURST_SIZE - 10 - len);

  // Write out the frames to S/P-DIF, SAMPLE_BUF is BURST_SIZE/4
  WriteBurstAC3(handle, (u_char *)buf, SAMPLE_BUF);
}

/* ----------------------------------------------------------------------------
 */
void
cAlsaAC3pt::SpdifBurstAC3 (snd_pcm_t **handle, unsigned char *Data, int length)
{
    int freeCount, nBytes, amount;

  while (length > 0)
  {
    amount = CheckDelayAC3(*handle);
    freeCount = ac3.end - ac3.tail;
    nBytes = (freeCount < length) ? freeCount : length;
    /* read */
    memcpy (ac3.tail, Data, nBytes);
    ac3.tail += nBytes;
    length -= nBytes;
    // so push out complete ac3 frames
    while (buffer_syncframe (&syncinfo, &ac3))
      WriteFullBurstAC3(*handle);
    ShiftAC3();
  }
}

/* ----------------------------------------------------------------------------
 */
unsigned int
cAlsaAC3pt::SpdifInitAC3(snd_pcm_t **handle, char *device, bool spdifPro)
{
    static snd_aes_iec958_t   spdif;
    unsigned int              rate = 48000;
    snd_pcm_info_t            *info;
    // Note that most alsa sound card drivers uses little endianess
    snd_pcm_format_t          format = SND_PCM_FORMAT_S16_LE;
    snd_pcm_access_t          access = SND_PCM_ACCESS_RW_INTERLEAVED;
    unsigned int              channels = 2;
    int                       err;//, c;

  if ((err = snd_pcm_open(handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0)
  {
    fprintf(stderr, "ac3play: sound open: %s\n\r", snd_strerror(err));
    return 1;
  }

  if (ac3Status)
    snd_pcm_status_free(ac3Status);

  snd_pcm_info_alloca(&info);

  if ((err = snd_pcm_info(*handle, info)) < 0) {
    fprintf(stderr, "ac3play: sound info: %s\n\r", snd_strerror(err));
    snd_pcm_close(*handle);
    return 1;
  }
  {
      snd_ctl_elem_value_t  *ctl;
      snd_ctl_t             *ctl_handle;
      char                  ctl_name[12];
      int                   ctl_card;

    spdif.status[0] = IEC958_AES0_NONAUDIO;
    if (spdifPro)
    {
      spdif.status[0] |= (IEC958_AES0_PROFESSIONAL |
                          IEC958_AES0_PRO_EMPHASIS_NONE |
                          iec958_aes0_pro_fs_rate);
      spdif.status[1]  = (IEC958_AES1_PRO_MODE_NOTID |
                          IEC958_AES1_PRO_USERBITS_NOTID);
      spdif.status[2]  = (IEC958_AES2_PRO_WORDLEN_NOTID);
      spdif.status[3]  =  0;
    }
    else
    {
      spdif.status[0] |= (IEC958_AES0_CON_EMPHASIS_NONE);
      spdif.status[1]  = (IEC958_AES1_CON_ORIGINAL |
                          IEC958_AES1_CON_PCM_CODER);
      spdif.status[2]  =  0;
      spdif.status[3]  = (iec958_aes3_con_fs_rate);
    }

    snd_ctl_elem_value_alloca(&ctl);
    snd_ctl_elem_value_set_interface(ctl, SND_CTL_ELEM_IFACE_PCM);
    snd_ctl_elem_value_set_device(ctl, snd_pcm_info_get_device(info));
    snd_ctl_elem_value_set_subdevice(ctl, snd_pcm_info_get_subdevice(info));
    snd_ctl_elem_value_set_name(ctl, SND_CTL_NAME_IEC958("", PLAYBACK,PCM_STREAM));
    snd_ctl_elem_value_set_iec958(ctl, &spdif);
    ctl_card = snd_pcm_info_get_card(info);
    if (ctl_card < 0) {
      fprintf(stderr, "ac3play: Unable to setup the IEC958 (S/PDIF) interface - PCM has no assigned card\n\r");
      goto __diga_end;
    }
    sprintf(ctl_name, "hw:%d", ctl_card);
    if ((err = snd_ctl_open(&ctl_handle, ctl_name, 0)) < 0) {
      fprintf(stderr, "ac3play: Unable to open the control interface '%s': %s\n\r", ctl_name, snd_strerror(err));
      goto __diga_end;
    }
    if ((err = snd_ctl_elem_write(ctl_handle, ctl)) < 0) {
      fprintf(stderr, "ac3play: Unable to update the IEC958 control: %s\n\r", snd_strerror(err));
      goto __diga_end;
    }
    snd_ctl_close(ctl_handle);
    __diga_end:
      ;
  }
  {
      snd_pcm_hw_params_t *params;
      snd_pcm_sw_params_t *swparams;
      // set period size
      snd_pcm_uframes_t bufferSize;
      // Number of digital audio frames in hw buffer
      snd_pcm_uframes_t periodSize = 0;

      //snd_pcm_uframes_t tmp;
      snd_pcm_sframes_t err;

    snd_pcm_hw_params_alloca(&params);
    snd_pcm_sw_params_alloca(&swparams);

    if ((err = snd_pcm_hw_params_any(*handle, params)) < 0) {
      fprintf(stderr, "ac3play: Broken configuration for this PCM: no configurations available\n\r");
      return 2;
    }
    if ((err = snd_pcm_hw_params_set_access(*handle, params, access)) < 0) {
      fprintf(stderr, "ac3play: Access type not available\n\r");
      return 2;
    }
    if ((err = snd_pcm_hw_params_set_format(*handle, params, format)) < 0) {
      fprintf(stderr, "ac3play: Sample format non available\n\r");
      return 2;
    }

    if ((err = snd_pcm_hw_params_set_channels(*handle, params, channels)) < 0) {
      fprintf(stderr, "ac3play: Channels count non avaible\n\r");
      return 2;
    }

    err = snd_pcm_hw_params_set_rate_near(*handle, params, &rate, 0);
    assert(err >= 0);
    smin = ((SAMPLE_BUF * 1000) / rate);

    // function returns less than 0 on error or greater than 0
    if ((err = snd_pcm_hw_params_set_period_size(*handle, params, PERIODSIZE, 0)) < 0) {
      fprintf(stderr, "ac3play: Period size not available: %s\n\r", snd_strerror(err));
      periodSize = 0;
      return 2;
    }
    // function returns less than 0 on error or greater than 0
    if ((err = snd_pcm_hw_params_set_periods(*handle, params, frames, 0)) < 0) {
    fprintf(stderr, "ac3play: Period count not available: %s\n\r", snd_strerror(err));
    return 2;
    }

    // function returns less than 0 on error or greater than 0
    if ((err = snd_pcm_hw_params_get_period_size(params, &periodSize, 0)) < 0) {
      fprintf(stderr, "ac3play: Buffer size not set: %s\n\r", snd_strerror(err));
      return 2;
    }
    if (PERIODSIZE != periodSize) {
      fprintf(stderr, "ac3play: Period size not set: %s\n\r", snd_strerror(err));
      return 2;
    }
    //period_size = err;

    // function returns less than 0 on error or greater than 0
    if ((err = snd_pcm_hw_params_get_buffer_size(params, &bufferSize)) < 0) {
      fprintf(stderr, "ac3play: Buffer size not set: %s\n\r", snd_strerror(err));
      return 2;
    }
    if (periodSize * frames != bufferSize) {
      fprintf(stderr, "ac3play: Buffer size not set: %s\n\r", snd_strerror(err));
      return 2;
    }
    buffer_size = err;

//    snd_output_stdio_attach(&log, stderr, 0);

    if ((err = snd_pcm_hw_params(*handle, params)) < 0) {
      fprintf(stderr, "ac3play: Cannot set buffer size\n\r");
//      snd_pcm_hw_params_dump(params, log);
      return 2;
    }

    if ((err = snd_pcm_sw_params_current(*handle, swparams)) < 0) {
      fprintf(stderr, "ac3play: Cannot get soft parameters: %s\n\r", snd_strerror(err));
      return 2;
    }

// Set start timings
#if 0
    if ((err = snd_pcm_sw_params_set_sleep_min(*handle, swparams, 0)) < 0)
      fprintf(stderr, "ac3play: Minimal sleep time not available: %s\n\r", snd_strerror(err));
#endif

    if ((err = snd_pcm_sw_params_set_avail_min(*handle, swparams, SAMPLE_BUF)) < 0)
      fprintf(stderr, "ac3play: Minimal period size not available: %s\n\r", snd_strerror(err));

    if ((err =  snd_pcm_sw_params_set_xfer_align(*handle, swparams, SAMPLE_BUF/6)) < 0)
      fprintf(stderr, "ac3play: Aligned period size not available: %s\n\r", snd_strerror(err));

    if ((err = snd_pcm_sw_params_set_start_threshold(*handle, swparams, 2*SAMPLE_BUF)) < 0)
      fprintf(stderr, "ac3play: Start threshold not available: %s\n\r", snd_strerror(err));

    if ((err = snd_pcm_sw_params(*handle, swparams)) < 0) {
      fprintf(stderr, "ac3play: Cannot set soft parameters: %s\n\r", snd_strerror(err));
//      snd_pcm_sw_params_dump(swparams, log);
      return 2;
    }
#ifdef DEBUG2
    snd_pcm_sw_params_dump(swparams, log);
    snd_pcm_dump(*handle, log);
#endif
  }
  memcpy(buf, head, sizeof(head));	// Initialize IEC958 head of the buffer
  memset(&buf[4], 0, BURST_SIZE - 4);	// and zero out the rest
  memcpy(pbuf, head, sizeof(head));	// Initialize IEC958 head of the pause buffer
  memset(&pbuf[4], 0, BURST_SIZE - 4);	// and zero out the rest

  // Status informations, hold over the full session.
  snd_pcm_status_malloc(&ac3Status);

  // On next play we've to initialize the HW
  ac3First = true;
  return 0;
}

--- NEW FILE: audio-ac3pt.h ---
/*
 * audio-ac3pt.h: A plugin for the Video Disk Recorder
 *
 * See the README file for copyright information and how to reach the author.
 *
 * $Id: audio-ac3pt.h,v 1.1 2005/10/06 21:16:47 lucke Exp $
 */
#ifndef AUDIO_AC3PT_H
#define AUDIO_AC3PT_H

enum _sync { LOW = -1, OK = 0, HIGH = 1};
// AC3 frames are translated into 4*(6*256) bytes (zero padded)
// embedded into PCM with 2 channels both with 2 bytes in on word,
// 256 frames in one block, 6 blocks in one sample
#define BURST_SIZE    6144
#define SAMPLE_CNT    4
#define SAMPLE_BUF    (BURST_SIZE/SAMPLE_CNT)
// Alsa Buffer and fragmentation
#define PERIODSIZE    SAMPLE_BUF

/* ---------------------------------------------------------------------------
 */
class cAlsaAC3pt {
private:
  snd_pcm_uframes_t burst_size,
                    buffer_size,
                    periods;
  snd_pcm_status_t  *ac3Status;
  snd_pcm_sframes_t ac3Delay;
  bool              ac3First;

  int           CheckDelayAC3(snd_pcm_t *handle);
  void          ShiftAC3(void),
                WriteFullBurstAC3(snd_pcm_t *handle),
                WriteBurstAC3(snd_pcm_t *handle,
                              unsigned char *data,
                              snd_pcm_sframes_t count),
                WritePauseBurstAC3(snd_pcm_t *handle, int leadin),
                XunderrunAC3(snd_pcm_t *handle),
                XsuspendAC3(snd_pcm_t *handle);

public:
  cAlsaAC3pt();
  ~cAlsaAC3pt();

  unsigned int  SpdifInitAC3(snd_pcm_t **handle,
                             char *device,
                             bool spdifPro);
  void          SpdifBurstAC3(snd_pcm_t **handle,
                              unsigned char *Data,
                              int Length);

};

#endif



From nobody at sheep.berlios.de  Thu Oct  6 23:28:13 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 6 Oct 2005 23:28:13 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.113,1.114 Makefile,1.18,1.19 audio.c,1.21,1.22 audio.h,1.8,1.9 mpeg2decoder.c,1.54,1.55 setup-softdevice.c,1.28,1.29 setup-softdevice.h,1.18,1.19 softdevice.c,1.42,1.43
Message-ID: <200510062128.j96LSD901357@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv16897

Modified Files:
	CHANGELOG Makefile audio.c audio.h mpeg2decoder.c 
	setup-softdevice.c setup-softdevice.h softdevice.c 
Log Message:
enable AC3 pass through code

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.113
retrieving revision 1.114
diff -C2 -d -r1.113 -r1.114
*** CHANGELOG	18 Sep 2005 15:17:44 -0000	1.113
--- CHANGELOG	6 Oct 2005 21:28:11 -0000	1.114
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-10-06:
+     - configure: check if X11 is present
+     - audio: AC3 pass through
  2005-09-18:
      - Makefile: compatibility for build without configure

Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** Makefile	3 Oct 2005 18:57:11 -0000	1.18
--- Makefile	6 Oct 2005 21:28:11 -0000	1.19
***************
*** 210,214 ****
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o video-dummy.o setup-softdevice.o sync-timer.o
  ALL_OBJS = $(OBJS)
  
--- 210,214 ----
  TARGETS = libvdr-$(PLUGIN).so
  LIBS = $(FFMPEGLIBS) -lasound
! OBJS = $(PLUGIN).o utils.o i18n.o video.o mpeg2decoder.o audio.o audio-ac3pt.o video-dummy.o setup-softdevice.o sync-timer.o
  ALL_OBJS = $(OBJS)
  

Index: audio.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.c,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** audio.c	16 Sep 2005 16:13:18 -0000	1.21
--- audio.c	6 Oct 2005 21:28:11 -0000	1.22
***************
*** 18,22 ****
  #include "utils.h"
  
- 
  #define PCM_FMT SND_PCM_FORMAT_S16_LE
  
--- 18,21 ----
***************
*** 27,31 ****
  #endif
  
- 
  cAudioOut::~cAudioOut() {
  }
--- 26,29 ----
***************
*** 38,43 ****
--- 36,50 ----
      dsyslog("[softdevice-audio] Opening alsa device %s",setupStore->alsaDevice);
      device = setupStore->alsaDevice;
+ 
+     if (strlen(setupStore->alsaAC3Device) == 0)
+       strcpy (setupStore->alsaAC3Device, "hw:0,1");
+     dsyslog("[softdevice-audio] Using alsa AC3 device %s",
+             setupStore->alsaAC3Device);
+     ac3Device = setupStore->alsaAC3Device;
+ 
      paused=false;
      ac3PassThrough = false;
+     ac3SpdifPro = false;
+ 
      if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0) {
        esyslog("[softdevice-audio] Playback open error: %s, %s FATAL exiting",
***************
*** 45,50 ****
        exit(1);
      }
!     currContext.channels=0;
!     currContext.samplerate=48000;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
  }
--- 52,57 ----
        exit(1);
      }
!     oldContext.channels = currContext.channels=0;
!     oldContext.samplerate = currContext.samplerate=48000;
      dsyslog("[softdevice-audio] Device opened! Ready to play");
  }
***************
*** 87,94 ****
  void cAlsaAudioOut::Write(uchar *Data, int Length)
  {
!     int err;
!     size_t size;
!     AUDIODEB("Write %p %d\n",Data,Length);
  
    if (ac3PassThrough)
    {
--- 94,103 ----
  void cAlsaAudioOut::Write(uchar *Data, int Length)
  {
!     int     err;
!     size_t  size;
  
+   AUDIODEB("Write %p %d\n",Data,Length);
+ 
+   handleMutex.Lock();
    if (ac3PassThrough)
    {
***************
*** 96,100 ****
      SetAC3PassThroughMode(ac3PassThrough);
    }
!   size = Length/(2*currContext.channels);
    while (size) {
      while (paused) usleep(1000); // block
--- 105,115 ----
      SetAC3PassThroughMode(ac3PassThrough);
    }
!   handleMutex.Unlock();
! 
!   if (!currContext.channels)
!     size = Length / (2 * 2);
!   else
!     size = Length/(2*currContext.channels);
! 
    while (size) {
      while (paused) usleep(1000); // block
***************
*** 125,129 ****
  
      if (err > 0 ) {
!       Data += err * 2 * currContext.channels;
        size -=err;
      };
--- 140,147 ----
  
      if (err > 0 ) {
!       if (!currContext.channels)
!         Data += err * 2 * 2;
!       else
!         Data += err * 2 * currContext.channels;
        size -=err;
      };
***************
*** 134,170 ****
  /* ----------------------------------------------------------------------------
   */
! void cAlsaAudioOut::SetAC3PassThroughMode(bool on)
  {
- #if 0
-     int err;
- 
-   if (handle)
-     snd_pcm_close(handle);
-   handle = NULL;
- 
    if (on)
    {
      oldContext = currContext;
-     if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0)
-     {
-       esyslog("[softdevice-audio] Playback open error: %s, %s FATAL exiting",
-               device, snd_strerror(err));
-       exit(1);
-     }
  
!   }
!   else
!   {
!     if ((err = snd_pcm_open(&handle, device, SND_PCM_STREAM_PLAYBACK, 0)) < 0)
      {
!       esyslog("[softdevice-audio] Playback open error: %s, %s FATAL exiting",
!               device, snd_strerror(err));
!       exit(1);
      }
! 
!     currContext.channels = 0;
!     SetParams(oldContext);
    }
! #endif
  }
  
--- 152,176 ----
  /* ----------------------------------------------------------------------------
   */
! bool
! cAlsaAudioOut::SetAC3PassThroughMode(bool on)
  {
    if (on)
    {
      oldContext = currContext;
  
!     if (handle)
!       snd_pcm_close(handle);
!     handle = NULL;
! 
!     // open S/P-DIF
!     if (ac3pt.SpdifInitAC3(&handle, ac3Device, ac3SpdifPro) == 0)
      {
!       currContext.channels = 0;
!       return true;
      }
!     currContext = oldContext;
!     esyslog("[softdevice-audio] AC3 open error:");
    }
!   return false;
  }
  
***************
*** 173,180 ****
  void cAlsaAudioOut::WriteAC3(uchar *Data, int Length)
  {
!     int err;
!     size_t size;
! 
! 
    if (!ac3PassThrough)
    {
--- 179,183 ----
  void cAlsaAudioOut::WriteAC3(uchar *Data, int Length)
  {
!   handleMutex.Lock();
    if (!ac3PassThrough)
    {
***************
*** 182,210 ****
      SetAC3PassThroughMode(ac3PassThrough);
    }
  
! #if 0
!   {
!       static int fd = -1;
! 
!     if (fd == -1) fd = open ("/tmp/xx.ac3", O_CREAT|O_WRONLY|O_TRUNC, 0700);
!     if (fd >= 0) write (fd, Data,Length);
!   }
! #endif
! 
!   if (!currContext.channels)
!     size = Length/(2*2);
!   else
!     size = Length/(2*currContext.channels);
!   while (size)
!   {
!     while (paused)
!       usleep(1000); // block
! 
!     err = size;
! 
!     size -= err;
!   }
  }
  
  void cAlsaAudioOut::Pause(void) {
      //    snd_pcm_pause(handle,1);
--- 185,195 ----
      SetAC3PassThroughMode(ac3PassThrough);
    }
+   handleMutex.Unlock();
  
!   ac3pt.SpdifBurstAC3 (&handle, Data, Length);
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  void cAlsaAudioOut::Pause(void) {
      //    snd_pcm_pause(handle,1);
***************
*** 213,216 ****
--- 198,203 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  void cAlsaAudioOut::Play(void) {
  //    snd_pcm_pause(handle,0);
***************
*** 218,221 ****
--- 205,210 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  int cAlsaAudioOut::GetDelay(void) {
      int               res = 0;
***************
*** 227,231 ****
            return 0;
    };
!   
    if ( snd_pcm_state(handle) != SND_PCM_STATE_RUNNING ) {
            handleMutex.Unlock();
--- 216,220 ----
            return 0;
    };
! 
    if ( snd_pcm_state(handle) != SND_PCM_STATE_RUNNING ) {
            handleMutex.Unlock();
***************
*** 243,247 ****
  }
  
! /* I/O error handler */
  void cAlsaAudioOut::Xrun(void)
  {
--- 232,238 ----
  }
  
! /* ----------------------------------------------------------------------------
!  * I/O error handler
!  */
  void cAlsaAudioOut::Xrun(void)
  {
***************
*** 270,273 ****
--- 261,266 ----
  }
  
+ /* ----------------------------------------------------------------------------
+  */
  int cAlsaAudioOut::SetParams(SampleContext &context)
  //int cAlsaAudioOut::SetParams(int channels, unsigned int samplerate)
***************
*** 351,356 ****
        exit(1);
      }
!     
      snd_pcm_uframes_t buffersize = 2 * 4608;
      err = snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffersize);
      if ( err < 0 ) {
--- 344,350 ----
        exit(1);
      }
! 
      snd_pcm_uframes_t buffersize = 2 * 4608;
+ 
      err = snd_pcm_hw_params_set_buffer_size_near(handle, params, &buffersize);
      if ( err < 0 ) {
***************
*** 376,381 ****
  
      currContext.buffer_size=bufferSize;
!     currContext.period_size=periodSize;  
!     
      snd_pcm_sw_params_current(handle, swparams);
      err = snd_pcm_sw_params_get_xfer_align(swparams, &xfer_align);
--- 370,375 ----
  
      currContext.buffer_size=bufferSize;
!     currContext.period_size=periodSize;
! 
      snd_pcm_sw_params_current(handle, swparams);
      err = snd_pcm_sw_params_get_xfer_align(swparams, &xfer_align);

Index: audio.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio.h,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** audio.h	1 May 2005 08:07:43 -0000	1.8
--- audio.h	6 Oct 2005 21:28:11 -0000	1.9
***************
*** 14,17 ****
--- 14,18 ----
  #include <vdr/plugin.h>
  #include "setup-softdevice.h"
+ #include "audio-ac3pt.h"
  
  struct SampleContext {
***************
*** 51,63 ****
  class cAlsaAudioOut : public cAudioOut  {
  private:
!   cMutex        handleMutex;
!   snd_pcm_t     *handle;
!   char          *device;
!   volatile bool paused;
!   bool          ac3PassThrough;
!   SampleContext oldContext;
  
!   void SetAC3PassThroughMode(bool on);
!   void Xrun(void);
  
  protected:
--- 52,67 ----
  class cAlsaAudioOut : public cAudioOut  {
  private:
!   cMutex            handleMutex;
!   snd_pcm_t         *handle;
!   char              *device,
!                     *ac3Device;
!   volatile bool     paused;
!   bool              ac3PassThrough,
!                     ac3SpdifPro;
!   SampleContext     oldContext;
!   cAlsaAC3pt        ac3pt;
  
!   bool  SetAC3PassThroughMode(bool on);
!   void  Xrun(void);
  
  protected:
***************
*** 65,78 ****
    cAlsaAudioOut(cSetupStore *setupStore);
    virtual ~cAlsaAudioOut();
!   virtual void Write(uchar *Data, int Length);
!   virtual void WriteAC3(uchar *Data, int Length);
    //virtual int SetParams(int channels, unsigned int samplerate);
!   virtual int SetParams(SampleContext &context);
!   virtual int GetDelay(void);
!   virtual void Pause(void);
!   virtual void Play(void);
!   virtual void SetVolume(int vol);
!   virtual void Suspend(void);
!   virtual bool Resume(void);
  };
  
--- 69,83 ----
    cAlsaAudioOut(cSetupStore *setupStore);
    virtual ~cAlsaAudioOut();
! 
!   virtual void  Write(uchar *Data, int Length);
!   virtual void  WriteAC3(uchar *Data, int Length);
    //virtual int SetParams(int channels, unsigned int samplerate);
!   virtual int   SetParams(SampleContext &context);
!   virtual int   GetDelay(void);
!   virtual void  Pause(void);
!   virtual void  Play(void);
!   virtual void  SetVolume(int vol);
!   virtual void  Suspend(void);
!   virtual bool  Resume(void);
  };
  

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.54
retrieving revision 1.55
diff -C2 -d -r1.54 -r1.55
*** mpeg2decoder.c	11 Sep 2005 09:22:30 -0000	1.54
--- mpeg2decoder.c	6 Oct 2005 21:28:11 -0000	1.55
***************
*** 354,360 ****
--- 354,389 ----
          break;
        case 1:
+       {
+           int       delta_pts;
+           uint64_t  PTS;
+ 
          // feed data for AC3 pass through to device
          audioOut->WriteAC3(data,size);
+ //
+ // TODO it's a hack for subsequent pts counting
+ //
+ #define AC3_PTS_TRACE 0
+ 
+         delta_pts = (size*10000*2/(48000*3));
+         pts += delta_pts;
+         if (pkt->pts != (int64_t) AV_NOPTS_VALUE)
+         {
+ #if AC3_PTS_TRACE
+           fprintf (stderr,
+                    "audio pts %lld pkt->PTS : %lld pts - valid PTS: %lld \n",
+                    pts,pkt->pts,(int) pts - pkt->pts );
+ #endif
+           pts = pkt->pts;
+           pkt->pts=AV_NOPTS_VALUE;
+         }
+         PTS = pts - audioOut->GetDelay() + setupStore.avOffset*10;
+ #if AC3_PTS_TRACE
+         fprintf (stderr, "audio pts offset %lld %d\n",
+                  cClock::GetTime()-PTS, delta_pts);
+ #endif
+         cClock::AdjustAudioPTS(PTS);
+ 
          return size;
+       }
        case 2:
          // get the AC3 -> 4CH stereo data
***************
*** 404,409 ****
      audioOut->SetParams(audioOutContext);
      audioOut->Write(audiosamples,audio_size);
!     // adjust PTS according to audio_size, sampel_rate and no. of channels  
!     pts += (audio_size*10000/(context->sample_rate*2*context->channels)); 
  
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
--- 433,441 ----
      audioOut->SetParams(audioOutContext);
      audioOut->Write(audiosamples,audio_size);
!     // adjust PTS according to audio_size, sampel_rate and no. of channels
!     if (!context->channels)
!       pts += (audio_size*10000/(context->sample_rate*2*2));
!     else
!       pts += (audio_size*10000/(context->sample_rate*2*context->channels));
  
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.28
retrieving revision 1.29
diff -C2 -d -r1.28 -r1.29
*** setup-softdevice.c	16 Aug 2005 09:22:18 -0000	1.28
--- setup-softdevice.c	6 Oct 2005 21:28:11 -0000	1.29
***************
*** 132,136 ****
  
    strcpy (alsaDevice, "");
!   strcpy (alsaSPDIFDevice, "hw:0,2");
    voArgs = aoArgs = NULL;
  
--- 132,136 ----
  
    strcpy (alsaDevice, "");
!   strcpy (alsaAC3Device, "");
    voArgs = aoArgs = NULL;
  
***************
*** 319,323 ****
      osdMode = clamp (0, osdMode, 1);
      fprintf(stderr,"[setup-softdevice] setting alpha blend mode to %s\n",
! 		    osdModeNames[osdMode]);
    } else if (!strcasecmp(Name, "Suspend")) {
      shouldSuspend = atoi (Value);
--- 319,323 ----
      osdMode = clamp (0, osdMode, 1);
      fprintf(stderr,"[setup-softdevice] setting alpha blend mode to %s\n",
!             osdModeNames[osdMode]);
    } else if (!strcasecmp(Name, "Suspend")) {
      shouldSuspend = atoi (Value);
***************
*** 328,332 ****
      fprintf(stderr, "[setup-softdevice] alsa ac3Mode set to: %d\n", ac3Mode);
      ac3Mode = clamp (0, ac3Mode, 3);
!   }  else  return false;
  
    return true;
--- 328,338 ----
      fprintf(stderr, "[setup-softdevice] alsa ac3Mode set to: %d\n", ac3Mode);
      ac3Mode = clamp (0, ac3Mode, 3);
!   } else if (!strcasecmp(Name, "AlsaAC3Device") && strlen(alsaAC3Device) == 0) {
!     strncpy(alsaAC3Device, Value, ALSA_DEVICE_NAME_LENGTH);
!     alsaAC3Device [ALSA_DEVICE_NAME_LENGTH-1] = 0;
!     fprintf(stderr, "[setup-softdevice] alsa AC3 device set to: %s\n",
!             alsaAC3Device);
!   }  else
!     return false;
  
    return true;
***************
*** 593,597 ****
    SetupStore ("avOffset",           setupStore.avOffset);
    SetupStore ("AlsaDevice",         setupStore.alsaDevice);
!   SetupStore ("AlsaSPDIFDevice",    setupStore.alsaSPDIFDevice);
    SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
    SetupStore ("Suspend",            setupStore.shouldSuspend);
--- 599,603 ----
    SetupStore ("avOffset",           setupStore.avOffset);
    SetupStore ("AlsaDevice",         setupStore.alsaDevice);
!   SetupStore ("AlsaAC3Device",      setupStore.alsaAC3Device);
    SetupStore ("PixelAspect",        setupStore.screenPixelAspect);
    SetupStore ("Suspend",            setupStore.shouldSuspend);

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.18
retrieving revision 1.19
diff -C2 -d -r1.18 -r1.19
*** setup-softdevice.h	22 Jul 2005 08:24:56 -0000	1.18
--- setup-softdevice.h	6 Oct 2005 21:28:11 -0000	1.19
***************
*** 56,60 ****
      int   bufferMode;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
!     char  alsaSPDIFDevice [ALSA_DEVICE_NAME_LENGTH];
      char  *voArgs;
      char  *aoArgs;
--- 56,60 ----
      int   bufferMode;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
!     char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];
      char  *voArgs;
      char  *aoArgs;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.42
retrieving revision 1.43
diff -C2 -d -r1.42 -r1.43
*** softdevice.c	18 Sep 2005 15:17:44 -0000	1.42
--- softdevice.c	6 Oct 2005 21:28:11 -0000	1.43
***************
*** 679,683 ****
    // Return a string that describes all known command line options.
    return
!   "  -ao alsa:devicename      alsa output device\n"
    "  -ao dummy:               dummy output device\n"
  #ifdef XV_SUPPORT
--- 679,684 ----
    // Return a string that describes all known command line options.
    return
!   "  -ao alsa:pcm=dev_name#   alsa output device for analog and PCM out\n"
!   "  -ao alsa:ac3=dev_name#   alsa output device for AC3 passthrough\n"
    "  -ao dummy:               dummy output device\n"
  #ifdef XV_SUPPORT
***************
*** 815,820 ****
            setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_ALSA;
!           fprintf(stderr, "[softdevice] using alsa device %s\n", ao_argv);
!           strncpy(setupStore.alsaDevice, ao_argv, ALSA_DEVICE_NAME_LENGTH);
          } else if (!strncmp(ao_argv, "dummy:", 6)) {
            ao_argv += 6;
--- 816,863 ----
            setupStore.aoArgs = ao_argv;
            aoutMethod = AOUT_ALSA;
!           while (strlen(ao_argv) > 1) {
!               char  *sep;
!               int   len;
! 
!             if (*ao_argv == ':' || *ao_argv == '#')
!               ++ao_argv;
! 
!             sep = ao_argv;
!             while (*sep && *sep != '#')
!               ++sep;
!             if (!*sep || *sep != '#')
!               sep = NULL;
! 
!             if (!strncmp(ao_argv, "pcm=", 4)) {
!               ao_argv += 4;
!               len = (sep) ? sep - ao_argv : 0;
!               len = (len > ALSA_DEVICE_NAME_LENGTH) ?
!                       ALSA_DEVICE_NAME_LENGTH : len;
!               if (len) {
!                 strncpy(setupStore.alsaDevice, ao_argv, len);
!                 setupStore.alsaDevice [len] = 0;
!                 fprintf (stderr, "[softdevice] using PCM alsa device %s\n",
!                          setupStore.alsaDevice);
!               }
!               ao_argv += len;
!             } else if (!strncmp(ao_argv, "ac3=", 4)) {
!               ao_argv += 4;
!               len = (sep) ? sep - ao_argv : 0;
!               len = (len > ALSA_DEVICE_NAME_LENGTH) ?
!                       ALSA_DEVICE_NAME_LENGTH : len;
!               if (len) {
!                 strncpy(setupStore.alsaAC3Device, ao_argv, len);
!                 setupStore.alsaAC3Device [len] = 0;
!                 fprintf (stderr, "[softdevice] using AC3 alsa device %s\n",
!                          setupStore.alsaAC3Device);
!               }
!               ao_argv += len;
!             } else {
!               fprintf(stderr, "[softdevice] using alsa device %s\n", ao_argv);
!               strncpy(setupStore.alsaDevice, ao_argv, ALSA_DEVICE_NAME_LENGTH);
!               ao_argv += strlen(ao_argv);
!             }
! 
!           }
          } else if (!strncmp(ao_argv, "dummy:", 6)) {
            ao_argv += 6;



From nobody at sheep.berlios.de  Fri Oct  7 11:09:37 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 7 Oct 2005 11:09:37 +0200
Subject: [Softdevice-cvs] softdevice video-dfb.h,1.10,1.11
Message-ID: <200510070909.j9799b921571@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4133

Modified Files:
	video-dfb.h 
Log Message:
vdr-1.2.x compatibility

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** video-dfb.h	4 Sep 2005 05:49:18 -0000	1.10
--- video-dfb.h	7 Oct 2005 09:09:33 -0000	1.11
***************
*** 52,58 ****
      void ShowOSD ();
      void GetDisplayFrameTime();
-     virtual void OpenOSD(int x, int y);
  
  #if VDRVERSNUM >= 10307
      virtual void Refresh(cBitmap *Bitmap);
      virtual void OSDStart();
--- 52,58 ----
      void ShowOSD ();
      void GetDisplayFrameTime();
  
  #if VDRVERSNUM >= 10307
+     virtual void OpenOSD(int x, int y);
      virtual void Refresh(cBitmap *Bitmap);
      virtual void OSDStart();



From nobody at sheep.berlios.de  Fri Oct  7 15:07:18 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 7 Oct 2005 15:07:18 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.31,1.32
Message-ID: <200510071307.j97D7I932280@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20476

Modified Files:
	video.c 
Log Message:
fix colored shadow bug

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** video.c	15 Sep 2005 19:08:22 -0000	1.31
--- video.c	7 Oct 2005 13:07:15 -0000	1.32
***************
*** 257,260 ****
--- 257,276 ----
  
    /* --------------------------------------------------------------------------
+    * adjust possible rounding errors. as we are in YV12 or similar mode,
+    * line offsets and coloumn offsets must be even.
+    */
+   if (syoff & 1) {
+     syoff--;
+     if ((fheight - sheight) > 1)
+       sheight += 2;
+   }
+ 
+   if (sxoff & 1) {
+     sxoff--;
+     if ((fwidth - swidth) > 1)
+       swidth += 2;
+   }
+ 
+   /* --------------------------------------------------------------------------
     * handle screen aspect support now
     */



From nobody at sheep.berlios.de  Fri Oct  7 15:37:55 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 7 Oct 2005 15:37:55 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.114,1.115 configure,1.7,1.8
Message-ID: <200510071337.j97Dbt900634@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23851

Modified Files:
	CHANGELOG configure 
Log Message:
fix VIDIX_DIR path

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.114
retrieving revision 1.115
diff -C2 -d -r1.114 -r1.115
*** CHANGELOG	6 Oct 2005 21:28:11 -0000	1.114
--- CHANGELOG	7 Oct 2005 13:37:53 -0000	1.115
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-10-07:
+     - dfb+vidix: fix colored shadow bug for some crop modes
+     - configure: fix VIDIX_DIR path
  2005-10-06:
      - configure: check if X11 is present

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.7
retrieving revision 1.8
diff -C2 -d -r1.7 -r1.8
*** configure	6 Oct 2005 09:03:47 -0000	1.7
--- configure	7 Oct 2005 13:37:53 -0000	1.8
***************
*** 284,288 ****
    echo "VIDIX_CFLAGS  = ${vidix_cflags}" >> $TMPM
    echo "#define VIDIX_SUPPORT 1" >> $TMPH
!   echo "#define VIDIX_DIR     \"${vidix_path}/lib/vidix\"" >> $TMPH
    echo "#define FBDEV         \"${fb_dev_name}\"" >> $TMPH
  fi
--- 284,288 ----
    echo "VIDIX_CFLAGS  = ${vidix_cflags}" >> $TMPM
    echo "#define VIDIX_SUPPORT 1" >> $TMPH
!   echo "#define VIDIX_DIR     \"${vidix_path}/lib/vidix/\"" >> $TMPH
    echo "#define FBDEV         \"${fb_dev_name}\"" >> $TMPH
  fi



From nobody at sheep.berlios.de  Sat Oct  8 14:37:19 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 8 Oct 2005 14:37:19 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.115,1.116 README,1.9,1.10 softdevice.c,1.43,1.44
Message-ID: <200510081237.j98CbJ911413@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv6935

Modified Files:
	CHANGELOG README softdevice.c 
Log Message:
softdevice-0.2.0

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.115
retrieving revision 1.116
diff -C2 -d -r1.115 -r1.116
*** CHANGELOG	7 Oct 2005 13:37:53 -0000	1.115
--- CHANGELOG	8 Oct 2005 12:37:16 -0000	1.116
***************
*** 1,3 ****
--- 1,4 ----
  Changelog
+ 2005-10-08: softdevice-0.2.0
  2005-10-07:
      - dfb+vidix: fix colored shadow bug for some crop modes

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** README	24 Jul 2005 20:16:38 -0000	1.9
--- README	8 Oct 2005 12:37:16 -0000	1.10
***************
*** 55,62 ****
  ./VDR/PLUGINS/src directory
  
! You _will_ have to modify the Makefile to your needs. Comment out all
! ouput methods that you don't plan to use ( put a "#"-sign in at the
! start of the line ). Adjust the path to libavcodec in the Makefile, 
! and disable all other features you don't want.
  
  If you don't plan to use Xv,set up a framebuffer on /dev/fb0
--- 55,68 ----
  ./VDR/PLUGINS/src directory
  
! By default you should "cd" to softdevice directory and run "./configure" .
! This will generate config.h and config.mak files, which will guide make.
! Available parameters of configure are listed by "./configure --help" .
! 
! To get rid of these generated files a "make dist-clean" should be done.
! 
! Without running configure, you'll have to modify the Makefile to your needs.
! Comment out all ouput methods that you don't plan to use
! ( put a "#"-sign in at the start of the line ). Adjust the path to libavcodec
! in the Makefile, and disable all other features you don't want.
  
  If you don't plan to use Xv,set up a framebuffer on /dev/fb0
***************
*** 85,88 ****
--- 91,108 ----
  
  
+ AC3 pass through:
+ -----------------
+ For using AC3 pass through, you have to specify the IEC958 device name of
+ your sound card. Which device to use, can be checked with ac3play.
+ For my system, ac3play works with: "ac3play -C -D 0,1 AC3_FILE_NAME"
+ 
+ So my vdr call with parameter list for softdevice looks like:
+ -P "softdevice -ao alsa:pcm=default#ac3=hw:0,1# -vo dfb:mgatv"
+ 
+ Notice the trailing '#' of the last alsa subparameter.
+ 
+ AC3 pass through is mainly based on the code of ac3play-0.5.2f, so
+ many thanks to the authors of that program.
+ 
  Problems/todo:
  --------------
***************
*** 94,97 ****
--- 114,118 ----
  - mpeg2dec
  - alsa
+ - ac3play-0.5.2f
  
  Many thanks to:

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.43
retrieving revision 1.44
diff -C2 -d -r1.43 -r1.44
*** softdevice.c	6 Oct 2005 21:28:11 -0000	1.43
--- softdevice.c	8 Oct 2005 12:37:16 -0000	1.44
***************
*** 73,77 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.1.3";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 73,77 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.2.0";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";



From nobody at sheep.berlios.de  Fri Oct 14 20:20:26 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 14 Oct 2005 20:20:26 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.32,1.33 CHANGELOG,1.116,1.117
Message-ID: <200510141820.j9EIKQw22225@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20172

Modified Files:
	video.c CHANGELOG 
Log Message:
reverted aspect ratio calculation change from 2005-01-12

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** video.c	7 Oct 2005 13:07:15 -0000	1.32
--- video.c	14 Oct 2005 18:20:23 -0000	1.33
***************
*** 327,334 ****
--- 327,342 ----
     * removed aspect ratio calculation based on picture->pan_scan->width
     * as this value seems to be wrong on some dvds.
+    * reverted this removal as effect from above it is not reproducable.
     */
    if (!context->sample_aspect_ratio.num)
    {
      new_asp = (float) (context->width) / (float) (context->height);
+   }
+   else if (picture->pan_scan->width)
+   {
+     new_asp = (float) (picture->pan_scan->width *
+                         context->sample_aspect_ratio.num) /
+                 (float) (picture->pan_scan->height *
+                           context->sample_aspect_ratio.den);
    }
    else

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.116
retrieving revision 1.117
diff -C2 -d -r1.116 -r1.117
*** CHANGELOG	8 Oct 2005 12:37:16 -0000	1.116
--- CHANGELOG	14 Oct 2005 18:20:23 -0000	1.117
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-10-14:
+     - reverted change from 2005-01-12 as effect it not reproducable and delivers
+       now wrong results for some streams.
  2005-10-08: softdevice-0.2.0
  2005-10-07:



From nobody at sheep.berlios.de  Tue Oct 25 21:35:31 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 25 Oct 2005 21:35:31 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.117,1.118 video-xv.c,1.32,1.33 video.c,1.33,1.34 video.h,1.22,1.23
Message-ID: <200510251935.j9PJZVw13543@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14141

Modified Files:
	CHANGELOG video-xv.c video.c video.h 
Log Message:
- video-xv: fix aspectratio recalculation upon ConfigureNotify events
  (shown in star_wreck_in_the_pirkinning)
- minor cleanup: moved static floats to member double (cVideoOut)


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.117
retrieving revision 1.118
diff -C2 -d -r1.117 -r1.118
*** CHANGELOG	14 Oct 2005 18:20:23 -0000	1.117
--- CHANGELOG	25 Oct 2005 19:35:25 -0000	1.118
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-10-25:
+     - video-xv: fix aspectratio recalculation upon ConfigureNotify events
+     - minor cleanup: moved static floats to member double (cVideoOut)
  2005-10-14:
      - reverted change from 2005-01-12 as effect it not reproducable and delivers

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** video-xv.c	16 Aug 2005 08:59:36 -0000	1.32
--- video-xv.c	25 Oct 2005 19:35:25 -0000	1.33
***************
*** 383,387 ****
  {
  
-     float           old_aspect;
      char            buffer [80];
      int             len,
--- 383,386 ----
***************
*** 423,434 ****
          dwidth = event.xconfigure.width;
          dheight = event.xconfigure.height;
!         /* --------------------------------------------------------------------
!          * set current picture format to unknown, so that .._check_format
!          * does some work.
!          */
!         old_aspect = (current_aspect == DV_FORMAT_WIDE) ?
!                       16.0 / 9.0 : 4.0 / 3.0;
!         current_aspect = -1;
!         CheckAspect (current_afd, old_aspect);
  
          if (toggleInProgress &&
--- 422,426 ----
          dwidth = event.xconfigure.width;
          dheight = event.xconfigure.height;
!         RecalculateAspect();
  
          if (toggleInProgress &&

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** video.c	14 Oct 2005 18:20:23 -0000	1.33
--- video.c	25 Oct 2005 19:35:25 -0000	1.34
***************
*** 26,29 ****
--- 26,31 ----
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
    Osd_changed = Osd_Bitmap_changed = 0;
+   aspect_F = -100.0;
+   aspect_I = -100;
    PixelMask=NULL;
    OsdRefreshCounter=0;
***************
*** 190,194 ****
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::CheckAspect(int new_afd, float new_asp)
  {
      int           new_aspect;
--- 192,196 ----
  /* ---------------------------------------------------------------------------
   */
! void cVideoOut::CheckAspect(int new_afd, double new_asp)
  {
      int           new_aspect;
***************
*** 306,314 ****
  /* ---------------------------------------------------------------------------
   */
  void cVideoOut::CheckAspectDimensions(AVFrame *picture,
                                          AVCodecContext *context)
  {
!     static volatile float new_asp, aspect_F = -100.0;
!     static int            aspect_I = -100;
  
    /* --------------------------------------------------------------------------
--- 308,323 ----
  /* ---------------------------------------------------------------------------
   */
+ void cVideoOut::RecalculateAspect(void)
+ {
+   current_aspect = -1;
+   CheckAspect (current_afd, aspect_F);
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cVideoOut::CheckAspectDimensions(AVFrame *picture,
                                          AVCodecContext *context)
  {
!     double new_asp;
  
    /* --------------------------------------------------------------------------
***************
*** 331,347 ****
    if (!context->sample_aspect_ratio.num)
    {
!     new_asp = (float) (context->width) / (float) (context->height);
    }
    else if (picture->pan_scan->width)
    {
!     new_asp = (float) (picture->pan_scan->width *
!                         context->sample_aspect_ratio.num) /
!                 (float) (picture->pan_scan->height *
!                           context->sample_aspect_ratio.den);
    }
    else
    {
!     new_asp = (float) (context->width * context->sample_aspect_ratio.num) /
!                (float) (context->height * context->sample_aspect_ratio.den);
    }
  #else
--- 340,356 ----
    if (!context->sample_aspect_ratio.num)
    {
!     new_asp = (double) (context->width) / (double) (context->height);
    }
    else if (picture->pan_scan->width)
    {
!     new_asp = (double) (picture->pan_scan->width *
!                          context->sample_aspect_ratio.num) /
!                 (double) (picture->pan_scan->height *
!                            context->sample_aspect_ratio.den);
    }
    else
    {
!     new_asp = (double) (context->width * context->sample_aspect_ratio.num) /
!                (double) (context->height * context->sample_aspect_ratio.den);
    }
  #else

Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** video.h	15 Sep 2005 19:08:22 -0000	1.22
--- video.h	25 Oct 2005 19:35:25 -0000	1.23
***************
*** 79,82 ****
--- 79,85 ----
  class cVideoOut: public cThread {
  private:
+     int     aspect_I;
+     double  aspect_F;
+ 
  protected:
      cMutex  osdMutex,
***************
*** 117,120 ****
--- 120,125 ----
      bool OSDdirty;
  
+     virtual void RecalculateAspect(void);
+ 
  public:
      cVideoOut(cSetupStore *setupStore);
***************
*** 129,133 ****
      virtual void Pause(void) {return;};
      virtual void SetParValues(double displayAspect, double displayRatio);
!     virtual void CheckAspect(int new_afd, float new_asp);
      virtual void CheckAspectDimensions (AVFrame *picture, AVCodecContext *context);
      virtual void CheckArea(int w, int h);
--- 134,138 ----
      virtual void Pause(void) {return;};
      virtual void SetParValues(double displayAspect, double displayRatio);
!     virtual void CheckAspect(int new_afd, double new_asp);
      virtual void CheckAspectDimensions (AVFrame *picture, AVCodecContext *context);
      virtual void CheckArea(int w, int h);



From nobody at sheep.berlios.de  Tue Oct 25 22:50:29 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 25 Oct 2005 22:50:29 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.34,1.35
Message-ID: <200510252050.j9PKoTw15506@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv7272

Modified Files:
	video.c 
Log Message:
fix for segfaults

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** video.c	25 Oct 2005 19:35:25 -0000	1.34
--- video.c	25 Oct 2005 20:50:25 -0000	1.35
***************
*** 342,346 ****
      new_asp = (double) (context->width) / (double) (context->height);
    }
!   else if (picture->pan_scan->width)
    {
      new_asp = (double) (picture->pan_scan->width *
--- 342,346 ----
      new_asp = (double) (context->width) / (double) (context->height);
    }
!   else if (picture->pan_scan && picture->pan_scan->width)
    {
      new_asp = (double) (picture->pan_scan->width *



From nobody at sheep.berlios.de  Thu Oct 27 07:29:51 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 27 Oct 2005 07:29:51 +0200
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.29,1.30
Message-ID: <200510270529.j9R5Tpw12246@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv21847

Modified Files:
	setup-softdevice.c 
Log Message:
fix cropmode handling via OSD

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.29
retrieving revision 1.30
diff -C2 -d -r1.29 -r1.30
*** setup-softdevice.c	6 Oct 2005 21:28:11 -0000	1.29
--- setup-softdevice.c	27 Oct 2005 05:29:39 -0000	1.30
***************
*** 20,25 ****
   * index to this array correspond to AFD values
   */
! #define SETUP_CROPMODES 5
! const char *crop_str[SETUP_CROPMODES];
  
  /* ---------------------------------------------------------------------------
--- 20,25 ----
   * index to this array correspond to AFD values
   */
! #define SETUP_CROPMODES 4
! const char *crop_str[SETUP_CROPMODES+1];
  
  /* ---------------------------------------------------------------------------
***************
*** 420,424 ****
    Add(new cMenuEditStraItem(tr("CropMode"),
                              &data->cropMode,
!                             (SETUP_CROPMODES-1),
                              crop_str));
  
--- 420,424 ----
    Add(new cMenuEditStraItem(tr("CropMode"),
                              &data->cropMode,
!                             SETUP_CROPMODES,
                              crop_str));
  



From nobody at sheep.berlios.de  Thu Oct 27 07:31:01 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 27 Oct 2005 07:31:01 +0200
Subject: [Softdevice-cvs] softdevice video.c,1.35,1.36
Message-ID: <200510270531.j9R5V1w12298@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22569

Modified Files:
	video.c 
Log Message:
set some vars for aspect calculation to reasonable defaults

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** video.c	25 Oct 2005 20:50:25 -0000	1.35
--- video.c	27 Oct 2005 05:30:52 -0000	1.36
***************
*** 26,31 ****
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
    Osd_changed = Osd_Bitmap_changed = 0;
!   aspect_F = -100.0;
!   aspect_I = -100;
    PixelMask=NULL;
    OsdRefreshCounter=0;
--- 26,32 ----
    OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
    Osd_changed = Osd_Bitmap_changed = 0;
!   aspect_F = 4.1 / 3.0;
!   aspect_I = 0;
!   current_aspect = -1;
    PixelMask=NULL;
    OsdRefreshCounter=0;



From nobody at sheep.berlios.de  Thu Oct 27 07:31:46 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 27 Oct 2005 07:31:46 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.118,1.119
Message-ID: <200510270531.j9R5Vkw12305@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22948

Modified Files:
	CHANGELOG 
Log Message:
update changelog

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.118
retrieving revision 1.119
diff -C2 -d -r1.118 -r1.119
*** CHANGELOG	25 Oct 2005 19:35:25 -0000	1.118
--- CHANGELOG	27 Oct 2005 05:31:44 -0000	1.119
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-10-26:
+     - fix cropmode handling via OSD
+     - set some vars for aspect calculation to reasonable defaults
  2005-10-25:
      - video-xv: fix aspectratio recalculation upon ConfigureNotify events



From nobody at sheep.berlios.de  Sat Oct 29 07:10:38 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Oct 2005 07:10:38 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.119,1.120 i18n.c,1.8,1.9
Message-ID: <200510290510.j9T5Acw12467@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1457

Modified Files:
	CHANGELOG i18n.c 
Log Message:
french translations (by Nicolas Huillard)

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.119
retrieving revision 1.120
diff -C2 -d -r1.119 -r1.120
*** CHANGELOG	27 Oct 2005 05:31:44 -0000	1.119
--- CHANGELOG	29 Oct 2005 05:10:31 -0000	1.120
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-10-29:
+     - french translations (by Nicolas Huillard)
  2005-10-26:
      - fix cropmode handling via OSD

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** i18n.c	10 Sep 2005 16:14:36 -0000	1.8
--- i18n.c	29 Oct 2005 05:10:32 -0000	1.9
***************
*** 16,20 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "N?ytt?laite",  //  9
--- 16,20 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Softdevice",   //  7
      "",             //  8 TODO
      "N?ytt?laite",  //  9
***************
*** 39,43 ****
      "",             //  5 TODO   
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Ohjelmistopohjainen n?ytt?laite",  //  9
--- 39,43 ----
      "",             //  5 TODO   
      "",             //  6 TODO
!     "Affichage vid?o sur carte graphique", //  7
      "",             //  8 TODO
      "Ohjelmistopohjainen n?ytt?laite",  //  9
***************
*** 62,66 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Xv-kuvasuhde k?ynnistett?ess?",   //  9
--- 62,66 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Aspect Xv au d?marrage", //  7
      "",             //  8 TODO
      "Xv-kuvasuhde k?ynnistett?ess?",   //  9
***************
*** 85,89 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Kuvan rajaustapa", //  9
--- 85,89 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "D?coupage de l'image au ratio", //  7
      "",             //  8 TODO
      "Kuvan rajaustapa", //  9
***************
*** 108,112 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Lomituksen poisto",    //  9
--- 108,112 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "D?sentrelacement", //  7
      "",             //  8 TODO
      "Lomituksen poisto",    //  9
***************
*** 131,135 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Pikseliformaatti", //  9
--- 131,135 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Format de pixel", //  7
      "",             //  8 TODO
      "Pikseliformaatti", //  9
***************
*** 154,158 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Kuvan peilaus",//  9
--- 154,158 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Mirroir horizontal", //  7
      "",             //  8 TODO
      "Kuvan peilaus",//  9
***************
*** 177,181 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "A/V-viive",    //  9
--- 177,181 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "D?lai A/V",    //  7
      "",             //  8 TODO
      "A/V-viive",    //  9
***************
*** 200,204 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "N?yt?n kuvasuhde",   //  9
--- 200,204 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Proportion de l'?cran", //  7
      "",             //  8 TODO
      "N?yt?n kuvasuhde",   //  9
***************
*** 223,227 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "N?yt?n ulostulo", //  9
--- 223,227 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Affichage",    //  7
      "",             //  8 TODO
      "N?yt?n ulostulo", //  9
***************
*** 246,250 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Kuvaruutun?yt?n l?pin?kyvyys", //  9
--- 246,250 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Fusion du menu avec la vid?o", //  7
      "",             //  8 TODO
      "Kuvaruutun?yt?n l?pin?kyvyys", //  9
***************
*** 269,273 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "p??ll?",       //  9
--- 269,273 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "oui",          //  7
      "",             //  8 TODO
      "p??ll?",       //  9
***************
*** 292,296 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "pois",         //  9
--- 292,296 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "non",          //  7
      "",             //  8 TODO
      "pois",         //  9
***************
*** 315,319 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "AC3-??net",    //  9
--- 315,319 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Sortie AC3",   //  7
      "",             //  8 TODO
      "AC3-??net",    //  9
***************
*** 338,342 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Puskurointitapa", //  9
--- 338,342 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "M?moire tampon", //  7
      "",             //  8 TODO
      "Puskurointitapa", //  9
***************
*** 361,365 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "N?pp?in kuvan rajaukselle", //  9
--- 361,365 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Bouton de changement d'aspect", //  7
      "",             //  8 TODO
      "N?pp?in kuvan rajaukselle", //  9
***************
*** 384,388 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Rajaa kuvaa ylh??lt?", //  9
--- 384,388 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Lignes ? enlever en haut", //  7
      "",             //  8 TODO
      "Rajaa kuvaa ylh??lt?", //  9
***************
*** 407,411 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Rajaa kuvaa alhaalta", //  9
--- 407,411 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Lignes ? enlever en bas", //  7
      "",             //  8 TODO
      "Rajaa kuvaa alhaalta", //  9
***************
*** 430,434 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Rajaa kuvaa vasemmalta", //  9
--- 430,434 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Colonnes ? enlever ? gauche", //  7
      "",             //  8 TODO
      "Rajaa kuvaa vasemmalta", //  9
***************
*** 453,457 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Rajaa kuvaa oikealta", //  9
--- 453,457 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Colonnes ? enlever ? droite", //  7
      "",             //  8 TODO
      "Rajaa kuvaa oikealta", //  9
***************
*** 476,480 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Kuvan j?lkik?sittely", //  9
--- 476,480 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Post-traitement", //  7
      "",             //  8 TODO
      "Kuvan j?lkik?sittely", //  9
***************
*** 499,503 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Kuvan j?lkik?sittelyn laatu", //  9
--- 499,503 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Qualit? du post-traitement", //  7
      "",             //  8 TODO
      "Kuvan j?lkik?sittelyn laatu", //  9
***************
*** 522,526 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "K?yt? StretchBlit-metodia", //  9
--- 522,526 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Utiliser StretchBlit", //  7
      "",             //  8 TODO
      "K?yt? StretchBlit-metodia", //  9
***************
*** 545,549 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "ei",           //  9
--- 545,549 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "aucun",        //  7
      "",             //  8 TODO
      "ei",           //  9
***************
*** 568,572 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "nopea",        //  9
--- 568,572 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "rapide",       //  7
      "",             //  8 TODO
      "nopea",        //  9
***************
*** 591,595 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "oletus",       //  9
--- 591,595 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "d?faut",       //  7
      "",             //  8 TODO
      "oletus",       //  9
***************
*** 614,618 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "toiminnassa",  //  9
--- 614,618 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "activ?",       //  7
      "",             //  8 TODO
      "toiminnassa",  //  9
***************
*** 637,641 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "pys?ytetty",   //  9
--- 637,641 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "suspendu",     //  7
      "",             //  8 TODO
      "pys?ytetty",   //  9
***************
*** 660,664 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "n?enn?inen",   //  9
--- 660,664 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "pseudo",       //  7
      "",             //  8 TODO
      "n?enn?inen",   //  9
***************
*** 683,687 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "ohjelmallinen",//  9
--- 683,687 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "logiciel",     //  7
      "",             //  8 TODO
      "ohjelmallinen",//  9
***************
*** 706,710 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "tallennus",    //  9
--- 706,710 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "limit?e",      //  7
      "",             //  8 TODO
      "tallennus",    //  9
***************
*** 729,733 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "nopea haku",   //  9
--- 729,733 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "pr?cision",    //  7
      "",             //  8 TODO
      "nopea haku",   //  9
***************
*** 752,756 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "HDTV",         //  9
--- 752,756 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "HDTV",         //  7
      "",             //  8 TODO
      "HDTV",         //  9
***************
*** 775,779 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "16:9 laaja",   //  9
--- 775,779 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "16:9 large",   //  7
      "",             //  8 TODO
      "16:9 laaja",   //  9
***************
*** 798,802 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "4:3 normaali", //  9
--- 798,802 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "4:3 normal",   //  7
      "",             //  8 TODO
      "4:3 normaali", //  9



From nobody at sheep.berlios.de  Sat Oct 29 10:30:32 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 29 Oct 2005 10:30:32 +0200
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.120,1.121 mpeg2decoder.c,1.55,1.56 mpeg2decoder.h,1.32,1.33 softdevice.c,1.44,1.45
Message-ID: <200510290830.j9T8UWw16572@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4439

Modified Files:
	CHANGELOG mpeg2decoder.c mpeg2decoder.h softdevice.c 
Log Message:
packet playback: assume we get complete frames via packet interface.
                 This fixes playing divx via softplay.


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.120
retrieving revision 1.121
diff -C2 -d -r1.120 -r1.121
*** CHANGELOG	29 Oct 2005 05:10:31 -0000	1.120
--- CHANGELOG	29 Oct 2005 08:30:27 -0000	1.121
***************
*** 2,5 ****
--- 2,7 ----
  2005-10-29:
      - french translations (by Nicolas Huillard)
+     - packet playback: assume we get complete frames via packet interface.
+                        This fixes playing divx via softplay.
  2005-10-26:
      - fix cropmode handling via OSD

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.55
retrieving revision 1.56
diff -C2 -d -r1.55 -r1.56
*** mpeg2decoder.c	6 Oct 2005 21:28:11 -0000	1.55
--- mpeg2decoder.c	29 Oct 2005 08:30:27 -0000	1.56
***************
*** 131,135 ****
  // --- cStreamDecoder ---------------------------------------------------------
  
! cStreamDecoder::cStreamDecoder(AVCodecContext *Context)
          : PacketQueue(packet_buf_size[setupStore.bufferMode])
  {
--- 131,135 ----
  // --- cStreamDecoder ---------------------------------------------------------
  
! cStreamDecoder::cStreamDecoder(AVCodecContext *Context, bool packetMode)
          : PacketQueue(packet_buf_size[setupStore.bufferMode])
  {
***************
*** 141,144 ****
--- 141,145 ----
    pts=0;
    frame=0;
+   this->packetMode = packetMode;
    initCodec();
    syncTimer=NULL;
***************
*** 271,278 ****
      return false;
    }
!   
!     /* we don't send complete frames */
!   if(codec->capabilities&CODEC_CAP_TRUNCATED)
!     context->flags|= CODEC_FLAG_TRUNCATED; 
    
    if ( (ret=avcodec_open(context, codec)) < 0)
--- 272,282 ----
      return false;
    }
! 
!   if (!packetMode)
!   {
!       /* we don't send complete frames */
!     if(codec->capabilities&CODEC_CAP_TRUNCATED)
!       context->flags|= CODEC_FLAG_TRUNCATED;
!   }
    
    if ( (ret=avcodec_open(context, codec)) < 0)
***************
*** 305,310 ****
  // --- AUDIO ------------------------------------------------------------------
  cAudioStreamDecoder::cAudioStreamDecoder(AVCodecContext *Context,
!                                          cAudioOut *AudioOut, int AudioMode)
!                                          : cStreamDecoder(Context)
  {
    audioOut=AudioOut;
--- 309,315 ----
  // --- AUDIO ------------------------------------------------------------------
  cAudioStreamDecoder::cAudioStreamDecoder(AVCodecContext *Context,
!                                          cAudioOut *AudioOut, int AudioMode,
!                                          bool packetMode)
!                                          : cStreamDecoder(Context, packetMode)
  {
    audioOut=AudioOut;
***************
*** 468,473 ****
  cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext *Context,
                                           cVideoOut *VideoOut, cClock *Clock,
!                                          int Trickspeed)
!                                          : cStreamDecoder(Context)
  {
    width = height = -1;
--- 473,479 ----
  cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext *Context,
                                           cVideoOut *VideoOut, cClock *Clock,
!                                          int Trickspeed,
!                                          bool packetMode)
!                                          : cStreamDecoder(Context, packetMode)
  {
    width = height = -1;
***************
*** 1252,1259 ****
  #if LIBAVFORMAT_BUILD > 4628
      aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode );
  #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode );
  #endif
    } else
--- 1258,1265 ----
  #if LIBAVFORMAT_BUILD > 4628
      aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode, packetMode );
  #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode, packetMode );
  #endif
    } else
***************
*** 1261,1269 ****
    if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
        ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO &&
!       VideoIdx!=pkt.stream_index) 
  #else
    if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
        ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO &&
!       VideoIdx!=pkt.stream_index) 
  #endif
    {
--- 1267,1275 ----
    if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
        ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO &&
!       VideoIdx!=pkt.stream_index)
  #else
    if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
        ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO &&
!       VideoIdx!=pkt.stream_index)
  #endif
    {
***************
*** 1278,1285 ****
  #if LIBAVFORMAT_BUILD > 4628
      vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed );
  #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed );
  #endif
    };
--- 1284,1291 ----
  #if LIBAVFORMAT_BUILD > 4628
      vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed, packetMode );
  #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed, packetMode );
  #endif
    };
***************
*** 1381,1387 ****
  };
  
! void cMpeg2Decoder::SetPlayMode(softPlayMode playMode)
  {
    curPlayMode=playMode;
    switch (curPlayMode) {
      case PmAudioVideo: 
--- 1387,1394 ----
  };
  
! void cMpeg2Decoder::SetPlayMode(softPlayMode playMode, bool packetMode)
  {
    curPlayMode=playMode;
+   this->packetMode=packetMode;
    switch (curPlayMode) {
      case PmAudioVideo: 

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** mpeg2decoder.h	10 Sep 2005 19:43:21 -0000	1.32
--- mpeg2decoder.h	29 Oct 2005 08:30:27 -0000	1.33
***************
*** 144,148 ****
  class cStreamDecoder : public cThread {
  private:
!     cPacketQueue PacketQueue;
  
  protected:
--- 144,149 ----
  class cStreamDecoder : public cThread {
  private:
!     cPacketQueue  PacketQueue;
!     bool          packetMode;
  
  protected:
***************
*** 176,180 ****
      virtual uint64_t  GetPTS()  {return pts;};
      
!     cStreamDecoder(AVCodecContext * Context);
      virtual ~cStreamDecoder();
  };
--- 177,181 ----
      virtual uint64_t  GetPTS()  {return pts;};
      
!     cStreamDecoder(AVCodecContext * Context, bool packetMode);
      virtual ~cStreamDecoder();
  };
***************
*** 199,203 ****
      virtual int DecodePacket(AVPacket *pkt);
      cAudioStreamDecoder(AVCodecContext *Context, cAudioOut *AudioOut,
!        int AudioChannel=0);
      ~cAudioStreamDecoder();
      inline void SetAudioMode(int AudioMode)
--- 200,204 ----
      virtual int DecodePacket(AVPacket *pkt);
      cAudioStreamDecoder(AVCodecContext *Context, cAudioOut *AudioOut,
!        int AudioChannel=0, bool packetMode = false);
      ~cAudioStreamDecoder();
      inline void SetAudioMode(int AudioMode)
***************
*** 255,259 ****
    public:
      cVideoStreamDecoder(AVCodecContext *Context, cVideoOut *VideoOut,
!        cClock *clock, int Trickspeed);
      ~cVideoStreamDecoder();
  
--- 256,260 ----
    public:
      cVideoStreamDecoder(AVCodecContext *Context, cVideoOut *VideoOut,
!        cClock *clock, int Trickspeed, bool packetMode);
      ~cVideoStreamDecoder();
  
***************
*** 304,308 ****
      };
  private:
!     softPlayMode curPlayMode;
  public:
      int read_packet(uint8_t *buf, int buf_size);
--- 305,310 ----
      };
  private:
!     softPlayMode  curPlayMode;
!     bool          packetMode;
  public:
      int read_packet(uint8_t *buf, int buf_size);
***************
*** 326,330 ****
      void TrickSpeed(int Speed);
     
!     void SetPlayMode(softPlayMode playMode);
      void PlayAudioVideo(bool playAudio,bool playVideo)
      { AudioIdx=playAudio?NO_STREAM:DONT_PLAY;
--- 328,332 ----
      void TrickSpeed(int Speed);
     
!     void SetPlayMode(softPlayMode playMode, bool packetMode);
      void PlayAudioVideo(bool playAudio,bool playVideo)
      { AudioIdx=playAudio?NO_STREAM:DONT_PLAY;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.44
retrieving revision 1.45
diff -C2 -d -r1.44 -r1.45
*** softdevice.c	8 Oct 2005 12:37:16 -0000	1.44
--- softdevice.c	29 Oct 2005 08:30:27 -0000	1.45
***************
*** 449,463 ****
        // FIXME - Implement audio or video only Playmode (is this really needed?)
        case pmAudioVideo:
!           decoder->SetPlayMode(cMpeg2Decoder::PmAudioVideo);
            decoder->Start();
            break;
        case pmAudioOnly:
        case pmAudioOnlyBlack:
!           decoder->SetPlayMode(cMpeg2Decoder::PmAudioOnly);
            decoder->Start();
            break;
  #if VDRVERSNUM > 10310
        case pmVideoOnly:
!           decoder->SetPlayMode(cMpeg2Decoder::PmVideoOnly);
            decoder->Start();
            break;
--- 449,463 ----
        // FIXME - Implement audio or video only Playmode (is this really needed?)
        case pmAudioVideo:
!           decoder->SetPlayMode(cMpeg2Decoder::PmAudioVideo,packetMode);
            decoder->Start();
            break;
        case pmAudioOnly:
        case pmAudioOnlyBlack:
!           decoder->SetPlayMode(cMpeg2Decoder::PmAudioOnly,packetMode);
            decoder->Start();
            break;
  #if VDRVERSNUM > 10310
        case pmVideoOnly:
!           decoder->SetPlayMode(cMpeg2Decoder::PmVideoOnly,packetMode);
            decoder->Start();
            break;



From nobody at sheep.berlios.de  Sun Oct 30 01:06:53 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 30 Oct 2005 01:06:53 +0200
Subject: [Softdevice-cvs] softdevice mpeg2decoder.c,1.56,1.57 CHANGELOG,1.121,1.122
Message-ID: <200510292306.j9TN6rw10588@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv15307

Modified Files:
	mpeg2decoder.c CHANGELOG 
Log Message:
DV read via dv1394 seems to have
context->coded_frame->coded_picture_number
always set to zero. Therefor lets do the following guess upon current
PTS value. Don't know if there are other codecs which deliver
codec_picture_number as zero.
Hopefully noone else will see '#' chars printed.


Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.56
retrieving revision 1.57
diff -C2 -d -r1.56 -r1.57
*** mpeg2decoder.c	29 Oct 2005 08:30:27 -0000	1.56
--- mpeg2decoder.c	29 Oct 2005 23:06:48 -0000	1.57
***************
*** 60,64 ****
        EnableGet.Signal();
    };
!   
    if (FirstPacket == Next(LastPacket) ) {
          BUFDEB("PacketQueue.EnablePut.Sleep start\n");
--- 60,64 ----
        EnableGet.Signal();
    };
! 
    if (FirstPacket == Next(LastPacket) ) {
          BUFDEB("PacketQueue.EnablePut.Sleep start\n");
***************
*** 66,70 ****
          BUFDEB("PacketQueue.EnablePut.Sleep stop\n");
    };
!   
    if (FirstPacket != Next(LastPacket) ) {
      queue[LastPacket]=Packet;
--- 66,70 ----
          BUFDEB("PacketQueue.EnablePut.Sleep stop\n");
    };
! 
    if (FirstPacket != Next(LastPacket) ) {
      queue[LastPacket]=Packet;
***************
*** 89,93 ****
         BUFDEB("PacketQueue.EnableGet.Sleep stop pid: %d \n",getpid());
    };
!   
    if ( FirstPacket != LastPacket )
      return &queue[FirstPacket];
--- 89,93 ----
         BUFDEB("PacketQueue.EnableGet.Sleep stop pid: %d \n",getpid());
    };
! 
    if ( FirstPacket != LastPacket )
      return &queue[FirstPacket];
***************
*** 158,162 ****
      avcodec_close(context);
    else fprintf(stderr,"Error not closing context %p, codec %p\n",context,codec);
!   
    PacketQueue.Clear();
  }
--- 158,162 ----
      avcodec_close(context);
    else fprintf(stderr,"Error not closing context %p, codec %p\n",context,codec);
! 
    PacketQueue.Clear();
  }
***************
*** 174,178 ****
      usleep(10000);
    };
!  
    while(active)
    {
--- 174,178 ----
      usleep(10000);
    };
! 
    while(active)
    {
***************
*** 279,283 ****
        context->flags|= CODEC_FLAG_TRUNCATED;
    }
!   
    if ( (ret=avcodec_open(context, codec)) < 0)
    {
--- 279,283 ----
        context->flags|= CODEC_FLAG_TRUNCATED;
    }
! 
    if ( (ret=avcodec_open(context, codec)) < 0)
    {
***************
*** 556,560 ****
      size-=len;
      data+=len;
!  
      // save coded picture number together with corresponding pts
      if (context->coded_frame  &&
--- 556,560 ----
      size-=len;
      data+=len;
! 
      // save coded picture number together with corresponding pts
      if (context->coded_frame  &&
***************
*** 563,567 ****
        pts_values[lastPTSidx].pts = lastPTS;
        pts_values[lastPTSidx].duration = lastDuration;
!       pts_values[lastPTSidx].coded_frame_no = 
          context->coded_frame->coded_picture_number;
        lastPTSidx = (lastPTSidx+1)%NO_PTS_VALUES;
--- 563,567 ----
        pts_values[lastPTSidx].pts = lastPTS;
        pts_values[lastPTSidx].duration = lastDuration;
!       pts_values[lastPTSidx].coded_frame_no =
          context->coded_frame->coded_picture_number;
        lastPTSidx = (lastPTSidx+1)%NO_PTS_VALUES;
***************
*** 572,581 ****
          lastPTSidx);
        lastPTS = AV_NOPTS_VALUE;
!     };
!     
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
           lastPTS=pkt->pts;
           lastDuration=pkt->duration;
!          
           if (lastDuration) {
  #if LIBAVCODEC_BUILD > 4753
--- 572,581 ----
          lastPTSidx);
        lastPTS = AV_NOPTS_VALUE;
!     }
! 
      if (pkt->pts != (int64_t) AV_NOPTS_VALUE) {
           lastPTS=pkt->pts;
           lastDuration=pkt->duration;
! 
           if (lastDuration) {
  #if LIBAVCODEC_BUILD > 4753
***************
*** 622,640 ****
      pix_fmt = context->pix_fmt;
  
- 
      // find decoded pictures pts value
      int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
      while ( picture->coded_picture_number !=
!                 pts_values[findPTS].coded_frame_no && 
!                 findPTS != lastPTSidx) 
           findPTS=(findPTS+1)%NO_PTS_VALUES;
!    
!      // found corresponding pts value
!      if (picture->coded_picture_number==pts_values[findPTS].coded_frame_no) {
!           MPGDEB("video pts: %lld, values.pkt : %lld pts - valid PTS: %lld pictno: %d idx: %d\n",
!           pts,pts_values[findPTS].pts,(int) pts - pts_values[findPTS].pts,
!           picture->coded_picture_number,findPTS);
!           pts = pts_values[findPTS].pts;
!      };
  
    if (!hurry_up || frame % 2 )
--- 622,653 ----
      pix_fmt = context->pix_fmt;
  
      // find decoded pictures pts value
      int findPTS=(lastPTSidx+1)%NO_PTS_VALUES;
      while ( picture->coded_picture_number !=
!                 pts_values[findPTS].coded_frame_no &&
!                 findPTS != lastPTSidx)
           findPTS=(findPTS+1)%NO_PTS_VALUES;
! 
!     // found corresponding pts value
!     if (picture->coded_picture_number==pts_values[findPTS].coded_frame_no) {
!       MPGDEB("video pts: %lld, values.pkt : %lld pts - valid PTS: %lld pictno: %d idx: %d\n",
!              pts,pts_values[findPTS].pts,(int) pts - pts_values[findPTS].pts,
!              picture->coded_picture_number,findPTS);
!       pts = pts_values[findPTS].pts;
!     }
! 
!     /* ------------------------------------------------------------------------
!      * DV read via dv1394 seems to have
!      * context->coded_frame->coded_picture_number
!      * always set to zero. Therefor lets do the following guess upon current
!      * PTS value. Don't know if there are other codecs which deliver
!      * codec_picture_number as zero.
!      * Hopefully noone else will see '#' chars printed.
!      */
!     if (!pts && lastPTS != (int64_t) AV_NOPTS_VALUE)
!     {
!        fprintf(stderr,"#");
!        pts = lastPTS;
!     }
  
    if (!hurry_up || frame % 2 )
***************
*** 667,673 ****
    // calculate delay
    delay += ( frametime() - pts_corr  ) * 100;
!   // update video pts 
    pts += frametime();
!  
    if (delay > 2*frametime()*100)
      delay = 2*frametime()*100;
--- 680,686 ----
    // calculate delay
    delay += ( frametime() - pts_corr  ) * 100;
!   // update video pts
    pts += frametime();
! 
    if (delay > 2*frametime()*100)
      delay = 2*frametime()*100;

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.121
retrieving revision 1.122
diff -C2 -d -r1.121 -r1.122
*** CHANGELOG	29 Oct 2005 08:30:27 -0000	1.121
--- CHANGELOG	29 Oct 2005 23:06:49 -0000	1.122
***************
*** 4,7 ****
--- 4,8 ----
      - packet playback: assume we get complete frames via packet interface.
                         This fixes playing divx via softplay.
+     - fix frame dropping with IEEE1394 read.                       
  2005-10-26:
      - fix cropmode handling via OSD



From nobody at sheep.berlios.de  Tue Nov  1 20:34:56 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 1 Nov 2005 20:34:56 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.9,1.10
Message-ID: <200511011934.jA1JYuw29120@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31051

Modified Files:
	i18n.c 
Log Message:
some german translations

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** i18n.c	29 Oct 2005 05:10:32 -0000	1.9
--- i18n.c	1 Nov 2005 19:34:53 -0000	1.10
***************
*** 33,38 ****
  #endif
    },
!   { "A software emulated MPEG2 device", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 33,38 ----
  #endif
    },
!   { "A software emulated MPEG2 device",   //  1
!     "Software-Ausgabeger?t",              //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 103,107 ****
    },
    { "Deinterlace Method",   //  1
!     "Deinterlace Method",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 103,107 ----
    },
    { "Deinterlace Method",   //  1
!     "Deinterlace Methode",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 126,130 ****
    },
    { "Pixel Format",   //  1
!     "Pixel Format",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 126,130 ----
    },
    { "Pixel Format",   //  1
!     "Pixelformat",   //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 333,337 ****
    },
    { "Buffer Mode",  //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 333,337 ----
    },
    { "Buffer Mode",  //  1
!     "Puffermodus",  //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 355,360 ****
  #endif
    },
!   { "CropModeToggleKey", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 355,360 ----
  #endif
    },
!   { "CropModeToggleKey",                  //  1
!     "Bildausschnitt-Taste",               //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 378,383 ****
  #endif
    },
!   { "Crop lines from top", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 378,383 ----
  #endif
    },
!   { "Crop lines from top",                //  1
!     "Zeilen von oben abschneiden",        //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 401,406 ****
  #endif
    },
!   { "Crop lines from bottom", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 401,406 ----
  #endif
    },
!   { "Crop lines from bottom",             //  1
!     "Zeilen von unten abschneiden",       //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 424,429 ****
  #endif
    },
!   { "Crop columns from left", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 424,429 ----
  #endif
    },
!   { "Crop columns from left",             //  1
!     "Spalten von links abschneiden",      //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 447,452 ****
  #endif
    },
!   { "Crop columns from right", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 447,452 ----
  #endif
    },
!   { "Crop columns from right",            //  1
!     "Spalten von rechts abschneiden",     //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 470,475 ****
  #endif
    },
!   { "Postprocessing Method", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 470,475 ----
  #endif
    },
!   { "Postprocessing Method",              //  1
!     "Bildnachbearbeitungsmethode",        //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 493,498 ****
  #endif
    },
!   { "Postprocessing Quality", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 493,498 ----
  #endif
    },
!   { "Postprocessing Quality",             //  1
!     "Nachbearbeitungs Qualit?t",          //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 516,521 ****
  #endif
    },
!   { "Use StretchBlit", //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 516,521 ----
  #endif
    },
!   { "Use StretchBlit",                    //  1
!     "StretchBlit verwenden",              //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 563,567 ****
    },
    { "fast",         //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 563,567 ----
    },
    { "fast",         //  1
!     "schnell",      //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 586,590 ****
    },
    { "default",      //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 586,590 ----
    },
    { "default",      //  1
!     "standart",     //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 609,613 ****
    },
    { "playing",      //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 609,613 ----
    },
    { "playing",      //  1
!     "aktiviert",    //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 632,636 ****
    },
    { "suspended",    //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 632,636 ----
    },
    { "suspended",    //  1
!     "deaktiviert",                        //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 655,659 ****
    },
    { "pseudo",       //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 655,659 ----
    },
    { "pseudo",       //  1
!     "pseudo",       //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 701,705 ****
    },
    { "save",         //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 701,705 ----
    },
    { "save",         //  1
!     "sicher",       //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 747,751 ****
    },
    { "HDTV",         //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 747,751 ----
    },
    { "HDTV",         //  1
!     "HDTV",         //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 769,774 ****
  #endif
    },
!   { "16:9 wide",    //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 769,774 ----
  #endif
    },
!   { "16:9 wide",                          //  1
!     "16:9 Breitbild",                     //  2
      "",             //  3 TODO
      "",             //  4 TODO
***************
*** 792,797 ****
  #endif
    },
!   { "4:3 normal",   //  1
!     "",             //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
--- 792,797 ----
  #endif
    },
!   { "4:3 normal",                         //  1
!     "4:3 Normalbild",                     //  2
      "",             //  3 TODO
      "",             //  4 TODO



From nobody at sheep.berlios.de  Tue Nov  1 21:50:26 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 1 Nov 2005 21:50:26 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.122,1.123 setup-softdevice.c,1.30,1.31 setup-softdevice.h,1.19,1.20 softdevice.c,1.45,1.46
Message-ID: <200511012050.jA1KoQw30970@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv14884

Modified Files:
	CHANGELOG setup-softdevice.c setup-softdevice.h softdevice.c 
Log Message:
hide main menu entry via OSD

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.122
retrieving revision 1.123
diff -C2 -d -r1.122 -r1.123
*** CHANGELOG	29 Oct 2005 23:06:49 -0000	1.122
--- CHANGELOG	1 Nov 2005 20:50:24 -0000	1.123
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-11-01:
+     - some some german translations (with help from Andre Neumann)
+     - hide main menu entry via OSD
  2005-10-29:
      - french translations (by Nicolas Huillard)

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.30
retrieving revision 1.31
diff -C2 -d -r1.30 -r1.31
*** setup-softdevice.c	27 Oct 2005 05:29:39 -0000	1.30
--- setup-softdevice.c	1 Nov 2005 20:50:24 -0000	1.31
***************
*** 125,128 ****
--- 125,130 ----
    useStretchBlit = 0;
    bufferMode    = 0;
+   mainMenu  = 1;
+ 
    /* --------------------------------------------------------------------------
     * these screen width/height values are operating in square pixel mode.
***************
*** 333,336 ****
--- 335,342 ----
      fprintf(stderr, "[setup-softdevice] alsa AC3 device set to: %s\n",
              alsaAC3Device);
+   } else if (!strcasecmp(Name, "mainMenu")) {
+     mainMenu = atoi (Value);
+     mainMenu = clamp (0, mainMenu, 1);
+     fprintf(stderr, "[setup-softdevice] mainMenu: %d\n", mainMenu);
    }  else
      return false;
***************
*** 539,542 ****
--- 545,551 ----
                              (SETUP_AC3MODENAMES-1),
                              ac3ModeNames));
+ 
+   Add(new cMenuEditBoolItem(tr("Main menu entry"),
+                             &data->mainMenu, tr("off"), tr("on")));
  }
  
***************
*** 547,550 ****
--- 556,589 ----
      eOSState state = cOsdMenu::ProcessKey(Key);
  
+ #if 0
+   switch (state)
+   {
+     case osUnknown:
+       switch (Key)
+       {
+         case kOk:
+           fprintf(stderr, "--> (%s) <--\n",Get(Current())->Text());
+           if (!strcmp(Get(Current())->Text(),tr("Cropping")))
+           {
+             fprintf(stderr, "## -> (%s) <- ##\n",Get(Current())->Text());
+           }
+           else
+           {
+             Store();
+             state = osBack;
+           }
+           break;
+         default:
+           break;
+       }
+       break;
+     case osBack:
+       setupStore = copyData;
+       fprintf (stderr, "[setup-softdevice] restoring setup state\n");
+       break;
+     default:
+       break;
+   }
+ #else
    if (state == osUnknown)
    {
***************
*** 564,567 ****
--- 603,607 ----
      fprintf (stderr, "[setup-softdevice] restoring setup state\n");
    }
+ #endif
    return state;
  }
***************
*** 604,607 ****
    SetupStore ("OSDalphablend",      setupStore.osdMode);
    SetupStore ("AC3Mode",            setupStore.ac3Mode);
!   SetupStore ("bufferMode",            setupStore.bufferMode);
  }
--- 644,648 ----
    SetupStore ("OSDalphablend",      setupStore.osdMode);
    SetupStore ("AC3Mode",            setupStore.ac3Mode);
!   SetupStore ("bufferMode",           setupStore.bufferMode);
!   SetupStore ("mainMenu",             setupStore.mainMenu);
  }

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.19
retrieving revision 1.20
diff -C2 -d -r1.19 -r1.20
*** setup-softdevice.h	6 Oct 2005 21:28:11 -0000	1.19
--- setup-softdevice.h	1 Nov 2005 20:50:24 -0000	1.20
***************
*** 55,58 ****
--- 55,59 ----
      int   ac3Mode;
      int   bufferMode;
+     int   mainMenu;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
      char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.45
retrieving revision 1.46
diff -C2 -d -r1.45 -r1.46
*** softdevice.c	29 Oct 2005 08:30:27 -0000	1.45
--- softdevice.c	1 Nov 2005 20:50:24 -0000	1.46
***************
*** 673,677 ****
  
  const char *cPluginSoftDevice::MainMenuEntry(void)
! { return tr(MAINMENUENTRY); }
  
  const char *cPluginSoftDevice::CommandLineHelp(void)
--- 673,681 ----
  
  const char *cPluginSoftDevice::MainMenuEntry(void)
! {
!   if (setupStore.mainMenu)
!     return tr(MAINMENUENTRY);
!   return NULL;
! }
  
  const char *cPluginSoftDevice::CommandLineHelp(void)



From nobody at sheep.berlios.de  Wed Nov  2 04:30:08 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 2 Nov 2005 04:30:08 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.123,1.124 setup-softdevice.c,1.31,1.32 setup-softdevice.h,1.20,1.21
Message-ID: <200511020330.jA23U8w10298@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4598

Modified Files:
	CHANGELOG setup-softdevice.c setup-softdevice.h 
Log Message:
restructured OSD setup

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.123
retrieving revision 1.124
diff -C2 -d -r1.123 -r1.124
*** CHANGELOG	1 Nov 2005 20:50:24 -0000	1.123
--- CHANGELOG	2 Nov 2005 03:30:05 -0000	1.124
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-11-02:
+     - restructured OSD setup
  2005-11-01:
      - some some german translations (with help from Andre Neumann)

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.31
retrieving revision 1.32
diff -C2 -d -r1.31 -r1.32
*** setup-softdevice.c	1 Nov 2005 20:50:24 -0000	1.31
--- setup-softdevice.c	2 Nov 2005 03:30:05 -0000	1.32
***************
*** 397,426 ****
  }
  
! /* --------------------------------------------------------------------------- */
! cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
  {
-   if (plugin)
-     SetPlugin(plugin);
- 
    copyData = setupStore;
    data = &setupStore;
  
-   if (data->outputMethod == VOUT_XV)
-   {
-     xv_startup_aspect[0] = tr("16:9 wide");
-     xv_startup_aspect[1] = tr("4:3 normal");
-     Add(new cMenuEditStraItem(tr("Xv startup aspect"),
-                              &data->xvAspect,
-                              (SETUP_XVSTARTUPASPECT-1),
-                              xv_startup_aspect));
- 
-     /* ------------------------------------------------------------------------
-      * don't offer that menu option as there is no immediate check
-      * if we have a still a operational system
-      */
-     //Add(new cMenuEditBoolItem(tr("Xv MaxArea"),
-     //                         &data->xvMaxArea, tr("no"), tr("yes")));
-   }
- 
    crop_str[0] = tr("none");
    Add(new cMenuEditStraItem(tr("CropMode"),
--- 397,407 ----
  }
  
! /* ---------------------------------------------------------------------------
!  */
! cMenuSetupCropping::cMenuSetupCropping(const char *name) : cOsdMenu(name, 33)
  {
    copyData = setupStore;
    data = &setupStore;
  
    crop_str[0] = tr("none");
    Add(new cMenuEditStraItem(tr("CropMode"),
***************
*** 459,462 ****
--- 440,479 ----
                               MAX_CROP_COLS));
    }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ eOSState cMenuSetupCropping::ProcessKey(eKeys Key)
+ {
+     eOSState state = cOsdMenu::ProcessKey(Key);
+ 
+   switch (state)
+   {
+     case osUnknown:
+       switch (Key)
+       {
+         case kOk:
+           state = osBack;
+           break;
+         default:
+           break;
+       }
+       break;
+     case osBack:
+       setupStore = copyData;
+       fprintf (stderr, "[setup-cropping] restoring setup state\n");
+       break;
+     default:
+       break;
+   }
+   return state;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ cMenuSetupPostproc::cMenuSetupPostproc(const char *name) : cOsdMenu(name, 33)
+ {
+   copyData = setupStore;
+   data = &setupStore;
  
    deint_str[0] = tr("none");
***************
*** 483,487 ****
                                deint_str));
    }
!   
  #ifdef PP_LIBAVCODEC
    pp_str[0] = tr("none");
--- 500,504 ----
                                deint_str));
    }
! 
  #ifdef PP_LIBAVCODEC
    pp_str[0] = tr("none");
***************
*** 494,523 ****
  #endif
  
!   bufferModes[0] = tr("save");
!   bufferModes[1] = tr("good seeking");
!   bufferModes[2] = tr("HDTV");
!   Add(new cMenuEditStraItem(tr("Buffer Mode"),
!                               &data->bufferMode,(SETUP_BUFFERMODES-1),bufferModes));
!   
!   if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
!   {
!     Add(new cMenuEditStraItem(tr("Pixel Format"),
!                               &data->pixelFormat,
!                               (SETUP_PIXFMT-1),
!                               pix_fmt));
!   }
  
!   if (data->outputMethod == VOUT_DFB)
    {
!     Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
!                               &data->useStretchBlit, tr("off"), tr("on")));
    }
  
!   Add(new cMenuEditBoolItem(tr("Picture mirroring"),
!                             &data->mirror, tr("off"), tr("on")));
  
!   Add(new cMenuEditIntItem(tr("A/V Delay"),
!                            &data->avOffset,
!                            MINAVOFFSET, MAXAVOFFSET));
  
    videoAspectNames[0] = tr("default");
--- 511,570 ----
  #endif
  
!   Add(new cMenuEditBoolItem(tr("Picture mirroring"),
!                             &data->mirror, tr("off"), tr("on")));
  
! }
! 
! /* ---------------------------------------------------------------------------
!  */
! eOSState cMenuSetupPostproc::ProcessKey(eKeys Key)
! {
!     eOSState state = cOsdMenu::ProcessKey(Key);
! 
!   switch (state)
    {
!     case osUnknown:
!       switch (Key)
!       {
!         case kOk:
!           state = osBack;
!           break;
!         default:
!           break;
!       }
!       break;
!     case osBack:
!       setupStore = copyData;
!       fprintf (stderr, "[setup-postproc] restoring setup state\n");
!       break;
!     default:
!       break;
    }
+   return state;
+ }
  
! /* ---------------------------------------------------------------------------
!  */
! cMenuSetupSoftdevice::cMenuSetupSoftdevice(cPlugin *plugin)
! {
!   if (plugin)
!     SetPlugin(plugin);
  
!   copyData = setupStore;
!   data = &setupStore;
! 
!   Add(new cOsdItem(tr("Cropping")));
!   Add(new cOsdItem(tr("Post processing")));
!   Add(new cOsdItem(tr(" "), osUnknown, false));
! 
!   if (data->outputMethod == VOUT_XV)
!   {
!     xv_startup_aspect[0] = tr("16:9 wide");
!     xv_startup_aspect[1] = tr("4:3 normal");
!     Add(new cMenuEditStraItem(tr("Xv startup aspect"),
!                              &data->xvAspect,
!                              (SETUP_XVSTARTUPASPECT-1),
!                              xv_startup_aspect));
!   }
  
    videoAspectNames[0] = tr("default");
***************
*** 527,530 ****
--- 574,592 ----
                              videoAspectNames));
  
+   osdModeNames[0] = tr("pseudo");
+   osdModeNames[1] = tr("software");
+   Add(new cMenuEditStraItem(tr("OSD alpha blending"),
+                             &data->osdMode,
+                             (SETUP_OSDMODES-1),
+                             osdModeNames));
+ 
+   Add(new cOsdItem(tr(" "), osUnknown, false));
+ 
+   bufferModes[0] = tr("save");
+   bufferModes[1] = tr("good seeking");
+   bufferModes[2] = tr("HDTV");
+   Add(new cMenuEditStraItem(tr("Buffer Mode"),
+                               &data->bufferMode,(SETUP_BUFFERMODES-1),bufferModes));
+ 
    suspendVideo[0] = tr("playing");
    suspendVideo[1] = tr("suspended");
***************
*** 534,543 ****
                              suspendVideo));
  
!   osdModeNames[0] = tr("pseudo");
!   osdModeNames[1] = tr("software");
!   Add(new cMenuEditStraItem(tr("OSD alpha blending"),
!                             &data->osdMode,
!                             (SETUP_OSDMODES-1),
!                             osdModeNames));
  
    Add(new cMenuEditStraItem(tr("AC3 Mode"),
--- 596,604 ----
                              suspendVideo));
  
!   Add(new cOsdItem(tr(" "), osUnknown, false));
! 
!   Add(new cMenuEditIntItem(tr("A/V Delay"),
!                            &data->avOffset,
!                            MINAVOFFSET, MAXAVOFFSET));
  
    Add(new cMenuEditStraItem(tr("AC3 Mode"),
***************
*** 546,549 ****
--- 607,626 ----
                              ac3ModeNames));
  
+   Add(new cOsdItem(tr(" "), osUnknown, false));
+ 
+   if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
+   {
+     Add(new cMenuEditStraItem(tr("Pixel Format"),
+                               &data->pixelFormat,
+                               (SETUP_PIXFMT-1),
+                               pix_fmt));
+   }
+ 
+   if (data->outputMethod == VOUT_DFB)
+   {
+     Add(new cMenuEditBoolItem(tr("Use StretchBlit"),
+                               &data->useStretchBlit, tr("off"), tr("on")));
+   }
+ 
    Add(new cMenuEditBoolItem(tr("Main menu entry"),
                              &data->mainMenu, tr("off"), tr("on")));
***************
*** 556,560 ****
      eOSState state = cOsdMenu::ProcessKey(Key);
  
- #if 0
    switch (state)
    {
--- 633,636 ----
***************
*** 563,576 ****
        {
          case kOk:
-           fprintf(stderr, "--> (%s) <--\n",Get(Current())->Text());
            if (!strcmp(Get(Current())->Text(),tr("Cropping")))
            {
!             fprintf(stderr, "## -> (%s) <- ##\n",Get(Current())->Text());
            }
!           else
            {
!             Store();
!             state = osBack;
            }
            break;
          default:
--- 639,652 ----
        {
          case kOk:
            if (!strcmp(Get(Current())->Text(),tr("Cropping")))
            {
!             return AddSubMenu (new cMenuSetupCropping(tr("Cropping")));
            }
!           else if (!strcmp(Get(Current())->Text(),tr("Post processing")))
            {
!             return AddSubMenu (new cMenuSetupPostproc(tr("Post processing")));
            }
+           Store();
+           state = osBack;
            break;
          default:
***************
*** 585,607 ****
        break;
    }
- #else
-   if (state == osUnknown)
-   {
-     switch (Key)
-     {
-       case kOk:
-         Store();
-         state = osBack;
-         break;
-       default:
-         break;
-     }
-   }
-   else if (state == osBack)
-   {
-     setupStore = copyData;
-     fprintf (stderr, "[setup-softdevice] restoring setup state\n");
-   }
- #endif
    return state;
  }
--- 661,664 ----

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.20
retrieving revision 1.21
diff -C2 -d -r1.20 -r1.21
*** setup-softdevice.h	1 Nov 2005 20:50:24 -0000	1.20
--- setup-softdevice.h	2 Nov 2005 03:30:05 -0000	1.21
***************
*** 67,76 ****
--- 67,106 ----
  /* ---------------------------------------------------------------------------
   */
+ class cMenuSetupCropping : public cOsdMenu
+ {
+   private:
+     cSetupStore *data, copyData;
+ 
+   protected:
+     virtual eOSState ProcessKey(eKeys Key);
+ 
+   public:
+     cMenuSetupCropping(const char *name);
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ class cMenuSetupPostproc : public cOsdMenu
+ {
+   private:
+     cSetupStore *data, copyData;
+ 
+   protected:
+     virtual eOSState ProcessKey(eKeys Key);
+ 
+   public:
+     cMenuSetupPostproc(const char *name);
+ };
+ 
+ /* ---------------------------------------------------------------------------
+  */
  class cMenuSetupSoftdevice : public cMenuSetupPage {
    private:
      cSetupStore *data, copyData;
+ 
    protected:
      virtual eOSState ProcessKey(eKeys Key);
      virtual void Store(void);
+ 
    public:
      cMenuSetupSoftdevice(cPlugin *plugin = NULL);



From nobody at sheep.berlios.de  Fri Nov  4 20:03:29 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 4 Nov 2005 20:03:29 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.10,1.11
Message-ID: <200511041903.jA4J3TN18945@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv31745

Modified Files:
	i18n.c 
Log Message:
more finnish translations by Rolf Ahrenberg

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** i18n.c	1 Nov 2005 19:34:53 -0000	1.10
--- i18n.c	4 Nov 2005 19:03:24 -0000	1.11
***************
*** 110,114 ****
      "D?sentrelacement", //  7
      "",             //  8 TODO
!     "Lomituksen poisto",    //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 110,114 ----
      "D?sentrelacement", //  7
      "",             //  8 TODO
!     "K?yt? lomituksen poistoa", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 478,482 ****
      "Post-traitement", //  7
      "",             //  8 TODO
!     "Kuvan j?lkik?sittely", //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 478,482 ----
      "Post-traitement", //  7
      "",             //  8 TODO
!     "K?yt? kuvan j?lkik?sittely?", //  9
      "",             // 10 TODO
      "",             // 11 TODO
***************
*** 801,804 ****
--- 801,873 ----
      "",             //  8 TODO
      "4:3 normaali", //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Hide main menu entry", //  1
+     "Hauptmen?eintrag verstecken", //  2
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "Piilota valinta p??valikosta", //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Cropping",     //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "Kuvan rajaus", //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Post processing",//  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO                                                              
+     "",             //  8 TODO
+     "Kuvan j?lkik?sittely", //  9
      "",             // 10 TODO
      "",             // 11 TODO



From nobody at sheep.berlios.de  Fri Nov  4 20:08:19 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 4 Nov 2005 20:08:19 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.124,1.125 mpeg2decoder.c,1.57,1.58 setup-softdevice.c,1.32,1.33 setup-softdevice.h,1.21,1.22
Message-ID: <200511041908.jA4J8JN19107@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1582

Modified Files:
	CHANGELOG mpeg2decoder.c setup-softdevice.c setup-softdevice.h 
Log Message:
sync timer mode selectable via OSD

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.124
retrieving revision 1.125
diff -C2 -d -r1.124 -r1.125
*** CHANGELOG	2 Nov 2005 03:30:05 -0000	1.124
--- CHANGELOG	4 Nov 2005 19:08:16 -0000	1.125
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-11-04:
+     - some more finish translations (by Rolf Ahrenberg)
+     - sync timer mode selectable via OSD
  2005-11-02:
      - restructured OSD setup

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.57
retrieving revision 1.58
diff -C2 -d -r1.57 -r1.58
*** mpeg2decoder.c	29 Oct 2005 23:06:48 -0000	1.57
--- mpeg2decoder.c	4 Nov 2005 19:08:16 -0000	1.58
***************
*** 498,502 ****
    delay=0;
    hurry_up=0;
!   syncTimer = new cSyncTimer (emRtcTimer);
    syncTimer->Reset();
  
--- 498,502 ----
    delay=0;
    hurry_up=0;
!   syncTimer = new cSyncTimer ((eSyncMode) setupStore.syncTimerMode);
    syncTimer->Reset();
  

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.32
retrieving revision 1.33
diff -C2 -d -r1.32 -r1.33
*** setup-softdevice.c	2 Nov 2005 03:30:05 -0000	1.32
--- setup-softdevice.c	4 Nov 2005 19:08:16 -0000	1.33
***************
*** 89,92 ****
--- 89,95 ----
  const char *userKeyUsage[SETUP_USERKEYS];
  
+ #define SETUP_SYNC_TIMER_NAMES  4
+ const char *syncTimerNames[SETUP_SYNC_TIMER_NAMES];
+ 
  /* ----------------------------------------------------------------------------
   */
***************
*** 126,129 ****
--- 129,133 ----
    bufferMode    = 0;
    mainMenu  = 1;
+   syncTimerMode = 1;
  
    /* --------------------------------------------------------------------------
***************
*** 196,199 ****
--- 200,208 ----
    ac3ModeNames[3] = "5.1 Analog (6CH)"; // no need to translate?
    ac3ModeNames[4] = NULL;
+ 
+   syncTimerNames[0] = "usleep";
+   syncTimerNames[1] = "rtc";
+   syncTimerNames[2] = "sig";
+   syncTimerNames[3] = NULL;
  }
  
***************
*** 339,342 ****
--- 348,356 ----
      mainMenu = clamp (0, mainMenu, 1);
      fprintf(stderr, "[setup-softdevice] mainMenu: %d\n", mainMenu);
+   } else if (!strcasecmp(Name, "syncTimerMode")) {
+     syncTimerMode = atoi (Value);
+     syncTimerMode = clamp (0, syncTimerMode, 2);
+     fprintf(stderr, "[setup-softdevice] syncTimerMode: %d\n",
+             syncTimerNames[syncTimerMode]);
    }  else
      return false;
***************
*** 418,421 ****
--- 432,437 ----
    if (data->outputMethod != VOUT_FB)
    {
+     Add(new cOsdItem(tr(" "), osUnknown, false));
+ 
      Add(new cMenuEditIntItem(tr("Crop lines from top"),
                               &data->cropTopLines,
***************
*** 607,610 ****
--- 623,631 ----
                              ac3ModeNames));
  
+   Add(new cMenuEditStraItem(tr("Sync Mode"),
+                             &data->syncTimerMode,
+                             (SETUP_SYNC_TIMER_NAMES-1),
+                             syncTimerNames));
+ 
    Add(new cOsdItem(tr(" "), osUnknown, false));
  
***************
*** 623,628 ****
    }
  
!   Add(new cMenuEditBoolItem(tr("Main menu entry"),
!                             &data->mainMenu, tr("off"), tr("on")));
  }
  
--- 644,649 ----
    }
  
!   Add(new cMenuEditBoolItem(tr("Hide main menu entry"),
!                             &data->mainMenu, tr("yes"), tr("no")));
  }
  
***************
*** 703,705 ****
--- 724,727 ----
    SetupStore ("bufferMode",           setupStore.bufferMode);
    SetupStore ("mainMenu",             setupStore.mainMenu);
+   SetupStore ("syncTimerMode",        setupStore.syncTimerMode);
  }

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.21
retrieving revision 1.22
diff -C2 -d -r1.21 -r1.22
*** setup-softdevice.h	2 Nov 2005 03:30:05 -0000	1.21
--- setup-softdevice.h	4 Nov 2005 19:08:16 -0000	1.22
***************
*** 56,59 ****
--- 56,60 ----
      int   bufferMode;
      int   mainMenu;
+     int   syncTimerMode;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
      char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];



From nobody at sheep.berlios.de  Fri Nov  4 21:52:53 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 4 Nov 2005 21:52:53 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.125,1.126 setup-softdevice.c,1.33,1.34
Message-ID: <200511042052.jA4KqrN21901@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv19318

Modified Files:
	CHANGELOG setup-softdevice.c 
Log Message:
sync timer as default + no translation of empty lines

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.125
retrieving revision 1.126
diff -C2 -d -r1.125 -r1.126
*** CHANGELOG	4 Nov 2005 19:08:16 -0000	1.125
--- CHANGELOG	4 Nov 2005 20:52:50 -0000	1.126
***************
*** 3,6 ****
--- 3,8 ----
      - some more finish translations (by Rolf Ahrenberg)
      - sync timer mode selectable via OSD
+     - removed translations of empty lines (by Rolf Ahrenberg)
+     - made sig timer the default one for new users
  2005-11-02:
      - restructured OSD setup

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** setup-softdevice.c	4 Nov 2005 19:08:16 -0000	1.33
--- setup-softdevice.c	4 Nov 2005 20:52:50 -0000	1.34
***************
*** 129,133 ****
    bufferMode    = 0;
    mainMenu  = 1;
!   syncTimerMode = 1;
  
    /* --------------------------------------------------------------------------
--- 129,133 ----
    bufferMode    = 0;
    mainMenu  = 1;
!   syncTimerMode = 2;
  
    /* --------------------------------------------------------------------------
***************
*** 432,436 ****
    if (data->outputMethod != VOUT_FB)
    {
!     Add(new cOsdItem(tr(" "), osUnknown, false));
  
      Add(new cMenuEditIntItem(tr("Crop lines from top"),
--- 432,436 ----
    if (data->outputMethod != VOUT_FB)
    {
!     Add(new cOsdItem(" ", osUnknown, false));
  
      Add(new cMenuEditIntItem(tr("Crop lines from top"),
***************
*** 572,576 ****
    Add(new cOsdItem(tr("Cropping")));
    Add(new cOsdItem(tr("Post processing")));
!   Add(new cOsdItem(tr(" "), osUnknown, false));
  
    if (data->outputMethod == VOUT_XV)
--- 572,576 ----
    Add(new cOsdItem(tr("Cropping")));
    Add(new cOsdItem(tr("Post processing")));
!   Add(new cOsdItem(" ", osUnknown, false));
  
    if (data->outputMethod == VOUT_XV)
***************
*** 597,601 ****
                              osdModeNames));
  
!   Add(new cOsdItem(tr(" "), osUnknown, false));
  
    bufferModes[0] = tr("save");
--- 597,601 ----
                              osdModeNames));
  
!   Add(new cOsdItem(" ", osUnknown, false));
  
    bufferModes[0] = tr("save");
***************
*** 612,616 ****
                              suspendVideo));
  
!   Add(new cOsdItem(tr(" "), osUnknown, false));
  
    Add(new cMenuEditIntItem(tr("A/V Delay"),
--- 612,616 ----
                              suspendVideo));
  
!   Add(new cOsdItem(" ", osUnknown, false));
  
    Add(new cMenuEditIntItem(tr("A/V Delay"),
***************
*** 628,632 ****
                              syncTimerNames));
  
!   Add(new cOsdItem(tr(" "), osUnknown, false));
  
    if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
--- 628,632 ----
                              syncTimerNames));
  
!   Add(new cOsdItem(" ", osUnknown, false));
  
    if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)



From nobody at sheep.berlios.de  Fri Nov  4 22:36:15 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 4 Nov 2005 22:36:15 +0100
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.34,1.35
Message-ID: <200511042136.jA4LaFN23276@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv22651

Modified Files:
	setup-softdevice.c 
Log Message:
fix setup message (%d -> %s)

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** setup-softdevice.c	4 Nov 2005 20:52:50 -0000	1.34
--- setup-softdevice.c	4 Nov 2005 21:36:12 -0000	1.35
***************
*** 351,355 ****
      syncTimerMode = atoi (Value);
      syncTimerMode = clamp (0, syncTimerMode, 2);
!     fprintf(stderr, "[setup-softdevice] syncTimerMode: %d\n",
              syncTimerNames[syncTimerMode]);
    }  else
--- 351,355 ----
      syncTimerMode = atoi (Value);
      syncTimerMode = clamp (0, syncTimerMode, 2);
!     fprintf(stderr, "[setup-softdevice] syncTimerMode: %s\n",
              syncTimerNames[syncTimerMode]);
    }  else



From nobody at sheep.berlios.de  Fri Nov  4 23:32:04 2005
From: nobody at sheep.berlios.de (lucke)
Date: Fri, 4 Nov 2005 23:32:04 +0100
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.35,1.36
Message-ID: <200511042232.jA4MW4N24990@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv26072

Modified Files:
	setup-softdevice.c 
Log Message:
compile fix for older vdr versions

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.35
retrieving revision 1.36
diff -C2 -d -r1.35 -r1.36
*** setup-softdevice.c	4 Nov 2005 21:36:12 -0000	1.35
--- setup-softdevice.c	4 Nov 2005 22:32:02 -0000	1.36
***************
*** 432,436 ****
--- 432,440 ----
    if (data->outputMethod != VOUT_FB)
    {
+ #if VDRVERSNUM >= 10334
      Add(new cOsdItem(" ", osUnknown, false));
+ #else
+     Add(new cOsdItem(" ", osUnknown));
+ #endif
  
      Add(new cMenuEditIntItem(tr("Crop lines from top"),
***************
*** 572,576 ****
--- 576,584 ----
    Add(new cOsdItem(tr("Cropping")));
    Add(new cOsdItem(tr("Post processing")));
+ #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
+ #else
+   Add(new cOsdItem(" ", osUnknown));
+ #endif
  
    if (data->outputMethod == VOUT_XV)
***************
*** 597,601 ****
--- 605,613 ----
                              osdModeNames));
  
+ #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
+ #else
+   Add(new cOsdItem(" ", osUnknown));
+ #endif
  
    bufferModes[0] = tr("save");
***************
*** 612,616 ****
--- 624,632 ----
                              suspendVideo));
  
+ #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
+ #else
+   Add(new cOsdItem(" ", osUnknown));
+ #endif
  
    Add(new cMenuEditIntItem(tr("A/V Delay"),
***************
*** 628,632 ****
--- 644,652 ----
                              syncTimerNames));
  
+ #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
+ #else
+   Add(new cOsdItem(" ", osUnknown));
+ #endif
  
    if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)



From nobody at sheep.berlios.de  Sun Nov  6 08:21:50 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 6 Nov 2005 08:21:50 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.11,1.12
Message-ID: <200511060721.jA67LoN17405@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv9059

Modified Files:
	i18n.c 
Log Message:
forgotten part (from Rolf)

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** i18n.c	4 Nov 2005 19:03:24 -0000	1.11
--- i18n.c	6 Nov 2005 07:21:45 -0000	1.12
***************
*** 884,887 ****
--- 884,910 ----
  #endif
    },
+   { "Sync Mode",//  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "A/V-synkronointitapa", //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
    { NULL }
    };



From nobody at sheep.berlios.de  Sun Nov  6 08:26:36 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 6 Nov 2005 08:26:36 +0100
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.36,1.37 setup-softdevice.h,1.22,1.23
Message-ID: <200511060726.jA67QaN17479@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12023

Modified Files:
	setup-softdevice.c setup-softdevice.h 
Log Message:
make some video attributes changeable via OSD

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** setup-softdevice.c	4 Nov 2005 22:32:02 -0000	1.36
--- setup-softdevice.c	6 Nov 2005 07:26:31 -0000	1.37
***************
*** 130,133 ****
--- 130,135 ----
    mainMenu  = 1;
    syncTimerMode = 2;
+   vidCaps = 0;
+   vidBrightness = vidHue = vidContrast = vidSaturation = VID_MAX_PARM_VALUE / 2;
  
    /* --------------------------------------------------------------------------
***************
*** 353,356 ****
--- 355,374 ----
      fprintf(stderr, "[setup-softdevice] syncTimerMode: %s\n",
              syncTimerNames[syncTimerMode]);
+   } else if (!strcasecmp(Name, "vidBrightness")) {
+     vidBrightness = atoi (Value);
+     vidBrightness = clamp (0, vidBrightness, 100);
+     fprintf(stderr, "[setup-softdevice] vidBrightness: %d\n", vidBrightness);
+   } else if (!strcasecmp(Name, "vidContrast")) {
+     vidContrast = atoi (Value);
+     vidContrast = clamp (0, vidContrast, 100);
+     fprintf(stderr, "[setup-softdevice] vidContrast: %d\n", vidContrast);
+   } else if (!strcasecmp(Name, "vidHue")) {
+     vidHue = atoi (Value);
+     vidHue = clamp (0, vidHue, 100);
+     fprintf(stderr, "[setup-softdevice] vidHue: %d\n", vidHue);
+   } else if (!strcasecmp(Name, "vidSaturation")) {
+     vidSaturation = atoi (Value);
+     vidSaturation = clamp (0, vidSaturation, 100);
+     fprintf(stderr, "[setup-softdevice] vidSaturation: %d\n", vidSaturation);
    }  else
      return false;
***************
*** 413,416 ****
--- 431,499 ----
  /* ---------------------------------------------------------------------------
   */
+ cMenuSetupVideoParm::cMenuSetupVideoParm(const char *name) : cOsdMenu(name, 33)
+ {
+   copyData = setupStore;
+   data = &setupStore;
+ 
+   if (data->vidCaps & CAP_BRIGHTNESS)
+   {
+     Add(new cMenuEditIntItem(tr("Brightness"),
+                              &data->vidBrightness,
+                              0,
+                              VID_MAX_PARM_VALUE));
+   }
+   if (data->vidCaps & CAP_CONTRAST)
+   {
+     Add(new cMenuEditIntItem(tr("Contrast"),
+                              &data->vidContrast,
+                              0,
+                              VID_MAX_PARM_VALUE));
+   }
+   if (data->vidCaps & CAP_HUE)
+   {
+     Add(new cMenuEditIntItem(tr("Hue"),
+                              &data->vidHue,
+                              0,
+                              VID_MAX_PARM_VALUE));
+   }
+   if (data->vidCaps & CAP_SATURATION)
+   {
+     Add(new cMenuEditIntItem(tr("Saturation"),
+                              &data->vidSaturation,
+                              0,
+                              VID_MAX_PARM_VALUE));
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ eOSState cMenuSetupVideoParm::ProcessKey(eKeys Key)
+ {
+     eOSState state = cOsdMenu::ProcessKey(Key);
+ 
+   switch (state)
+   {
+     case osUnknown:
+       switch (Key)
+       {
+         case kOk:
+           state = osBack;
+           break;
+         default:
+           break;
+       }
+       break;
+     case osBack:
+       setupStore = copyData;
+       fprintf (stderr, "[setup-videoparm] restoring setup state\n");
+       break;
+     default:
+       break;
+   }
+   return state;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  cMenuSetupCropping::cMenuSetupCropping(const char *name) : cOsdMenu(name, 33)
  {
***************
*** 576,579 ****
--- 659,668 ----
    Add(new cOsdItem(tr("Cropping")));
    Add(new cOsdItem(tr("Post processing")));
+ 
+   if (data->vidCaps)
+   {
+     Add(new cOsdItem(tr("Video out")));
+   }
+ 
  #if VDRVERSNUM >= 10334
    Add(new cOsdItem(" ", osUnknown, false));
***************
*** 688,691 ****
--- 777,784 ----
              return AddSubMenu (new cMenuSetupPostproc(tr("Post processing")));
            }
+           else if (!strcmp(Get(Current())->Text(),tr("Video out")))
+           {
+             return AddSubMenu (new cMenuSetupVideoParm(tr("Video out")));
+           }
            Store();
            state = osBack;
***************
*** 745,747 ****
--- 838,844 ----
    SetupStore ("mainMenu",             setupStore.mainMenu);
    SetupStore ("syncTimerMode",        setupStore.syncTimerMode);
+   SetupStore ("vidBrightness",        setupStore.vidBrightness);
+   SetupStore ("vidContrast",          setupStore.vidContrast);
+   SetupStore ("vidHue",               setupStore.vidHue);
+   SetupStore ("vidSaturation",        setupStore.vidSaturation);
  }

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.22
retrieving revision 1.23
diff -C2 -d -r1.22 -r1.23
*** setup-softdevice.h	4 Nov 2005 19:08:16 -0000	1.22
--- setup-softdevice.h	6 Nov 2005 07:26:31 -0000	1.23
***************
*** 18,21 ****
--- 18,28 ----
  #define ALSA_DEVICE_NAME_LENGTH  64
  
+ #define CAP_BRIGHTNESS  1
+ #define CAP_CONTRAST    2
+ #define CAP_HUE         4
+ #define CAP_SATURATION  8
+ 
+ #define VID_MAX_PARM_VALUE  100
+ 
  /* ---------------------------------------------------------------------------
   */
***************
*** 57,60 ****
--- 64,72 ----
      int   mainMenu;
      int   syncTimerMode;
+     int   vidBrightness,
+           vidContrast,
+           vidHue,
+           vidSaturation,
+           vidCaps;
      char  alsaDevice [ALSA_DEVICE_NAME_LENGTH];
      char  alsaAC3Device [ALSA_DEVICE_NAME_LENGTH];
***************
*** 65,68 ****
--- 77,94 ----
  #define OSDMODE_PSEUDO    0
  #define OSDMODE_SOFTWARE  1
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ class cMenuSetupVideoParm : public cOsdMenu
+ {
+   private:
+     cSetupStore *data, copyData;
+ 
+   protected:
+     virtual eOSState ProcessKey(eKeys Key);
+ 
+   public:
+     cMenuSetupVideoParm(const char *name);
+ };
  
  /* ---------------------------------------------------------------------------



From nobody at sheep.berlios.de  Sun Nov  6 08:29:21 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 6 Nov 2005 08:29:21 +0100
Subject: [Softdevice-cvs] softdevice video-xv.c,1.33,1.34 video-xv.h,1.9,1.10
Message-ID: <200511060729.jA67TLN17525@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13650

Modified Files:
	video-xv.c video-xv.h 
Log Message:
some attributes changeable via OSD

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** video-xv.c	25 Oct 2005 19:35:25 -0000	1.33
--- video-xv.c	6 Nov 2005 07:29:16 -0000	1.34
***************
*** 29,33 ****
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2005-07-20"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
--- 29,33 ----
  #include "setup-softdevice.h"
  
! #define PATCH_VERSION "2005-11-06"
  
  static pthread_mutex_t  xv_mutex = PTHREAD_MUTEX_INITIALIZER;
***************
*** 46,49 ****
--- 46,50 ----
    portAttributeAtoms = NULL;
    portAttributeCount = 0;
+   currBrightness = currContrast = currHue = currSaturation = 0;
  }
  
***************
*** 80,87 ****
  /* ---------------------------------------------------------------------------
   */
! void cXvPortAttributeStore::SetXInfo(Display *dpy, XvPortID port)
  {
    this->dpy = dpy;
    this->port = port;
  }
  
--- 81,91 ----
  /* ---------------------------------------------------------------------------
   */
! void cXvPortAttributeStore::SetXInfo(Display      *dpy,
!                                      XvPortID     port,
!                                      cSetupStore  *setupStore)
  {
    this->dpy = dpy;
    this->port = port;
+   this->setupStore = setupStore;
  }
  
***************
*** 107,110 ****
--- 111,138 ----
  /* ---------------------------------------------------------------------------
   */
+ void cXvPortAttributeStore::SetValuePercent(char *name, int value)
+ {
+   for (int i = 0; i < portAttributeCount; ++i)
+   {
+     if (!strcmp(name,portAttributes[i].name))
+     {
+       value = (int) ((double) portAttributes[i].min_value +
+                       ((double) portAttributes[i].max_value -
+                         (double) portAttributes[i].min_value) *
+                       (double) value / 100.0);
+       if (value <= portAttributes[i].max_value &&
+           value >= portAttributes[i].min_value)
+       {
+ fprintf(stderr, " - (%s) new val [%d]\n",name, value);
+         portAttributeCurrentValues[i] = value;
+         XvSetPortAttribute(dpy,port,portAttributeAtoms[i],portAttributeCurrentValues[i]);
+       }
+       return;
+     }
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cXvPortAttributeStore::SetColorkey(int value)
  {
***************
*** 174,177 ****
--- 202,214 ----
          portAttributeCurrentValues[i] = portAttributeSaveValues[i];
        }
+       if (!strcmp(portAttributes[i].name, "XV_BRIGHTNESS"))
+         setupStore->vidCaps |= CAP_BRIGHTNESS;
+       if (!strcmp(portAttributes[i].name, "XV_CONTRAST"))
+         setupStore->vidCaps |= CAP_CONTRAST;
+       if (!strcmp(portAttributes[i].name, "XV_HUE"))
+         setupStore->vidCaps |= CAP_HUE;
+       if (!strcmp(portAttributes[i].name, "XV_SATURATION"))
+         setupStore->vidCaps |= CAP_SATURATION;
+ 
        dsyslog("[XvVideoOut]:"
                "   %-25s %-4sXvGettable %-4sXvSettable "
***************
*** 193,196 ****
--- 230,281 ----
  /* ---------------------------------------------------------------------------
   */
+ bool cXvPortAttributeStore::HasAttribute(char *name)
+ {
+   for (int i = 0; i < portAttributeCount; ++i)
+   {
+     if (!strcmp(name,portAttributes[i].name))
+     {
+       return true;
+     }
+   }
+   return false;
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
+ void cXvPortAttributeStore::CheckVideoParmChange()
+ {
+     int changed = 0;
+ 
+   if (currBrightness != setupStore->vidBrightness)
+   {
+     changed++;
+     currBrightness = setupStore->vidBrightness;
+     SetValuePercent("XV_BRIGHTNESS", currBrightness);
+   }
+   if (currContrast != setupStore->vidContrast)
+   {
+     changed++;
+     currContrast = setupStore->vidContrast;
+     SetValuePercent("XV_CONTRAST", currContrast);
+   }
+   if (currHue != setupStore->vidHue)
+   {
+     changed++;
+     currHue = setupStore->vidHue;
+     SetValuePercent("XV_HUE", currHue);
+   }
+   if (currSaturation != setupStore->vidSaturation)
+   {
+     changed++;
+     currSaturation = setupStore->vidSaturation;
+     SetValuePercent("XV_SATURATION", currSaturation);
+   }
+   if (changed)
+     XSync(dpy, False);
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cXvPortAttributeStore::Restore()
  {
***************
*** 560,574 ****
    }
  
!   if (xv_initialized && map_count) {
!     XClearArea (dpy, win, 0, 0, 0, 0, True);
!     XvShmPutImage(dpy, port,
!                   win, gc,
!                   xv_image,
!                   sxoff, syoff,      /* sx, sy */
!                   swidth, sheight,   /* sw, sh */
!                   lxoff,  lyoff,     /* dx, dy */
!                   lwidth, lheight,   /* dw, dh */
!                   False);
!     XSync(dpy, False);
    }
  
--- 645,662 ----
    }
  
!   if (xv_initialized) {
!     if (map_count) {
!       XClearArea (dpy, win, 0, 0, 0, 0, True);
!       XvShmPutImage(dpy, port,
!                     win, gc,
!                     xv_image,
!                     sxoff, syoff,      /* sx, sy */
!                     swidth, sheight,   /* sw, sh */
!                     lxoff,  lyoff,     /* dx, dy */
!                     lwidth, lheight,   /* dw, dh */
!                     False);
!       XSync(dpy, False);
!     }
!     attributeStore.CheckVideoParmChange();
    }
  
***************
*** 965,969 ****
    }
  
!   attributeStore.SetXInfo(dpy,port);
    attributeStore.Save();
    attributeStore.SetColorkey(0x00000000);
--- 1053,1057 ----
    }
  
!   attributeStore.SetXInfo(dpy,port,setupStore);
    attributeStore.Save();
    attributeStore.SetColorkey(0x00000000);

Index: video-xv.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.h,v
retrieving revision 1.9
retrieving revision 1.10
diff -C2 -d -r1.9 -r1.10
*** video-xv.h	16 Aug 2005 08:59:36 -0000	1.9
--- video-xv.h	6 Nov 2005 07:29:16 -0000	1.10
***************
*** 69,72 ****
--- 69,77 ----
                  *portAttributeCurrentValues;
    Atom          *portAttributeAtoms;
+   cSetupStore   *setupStore;
+   int           currBrightness,
+                 currContrast,
+                 currHue,
+                 currSaturation;
  
    void Restore();
***************
*** 75,84 ****
    cXvPortAttributeStore();
    ~cXvPortAttributeStore();
!   void SetXInfo(Display *dpy, XvPortID port);
    void SetValue(char *name, int value);
    void SetColorkey(int value);
    void Increment(char *name);
    void Decrement(char *name);
    void Save();
  };
  
--- 80,92 ----
    cXvPortAttributeStore();
    ~cXvPortAttributeStore();
!   void SetXInfo(Display *dpy, XvPortID port, cSetupStore *setupStore);
    void SetValue(char *name, int value);
+   void SetValuePercent(char *name, int value);
    void SetColorkey(int value);
    void Increment(char *name);
    void Decrement(char *name);
    void Save();
+   bool HasAttribute(char *name);
+   void CheckVideoParmChange();
  };
  



From nobody at sheep.berlios.de  Sun Nov  6 18:56:09 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sun, 6 Nov 2005 18:56:09 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.126,1.127 README,1.10,1.11 setup-softdevice.c,1.37,1.38 setup-softdevice.h,1.23,1.24 softdevice.c,1.46,1.47 video-dfb.c,1.40,1.41 video-dfb.h,1.11,1.12
Message-ID: <200511061756.jA6Hu9N06010@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11484

Modified Files:
	CHANGELOG README setup-softdevice.c setup-softdevice.h 
	softdevice.c video-dfb.c video-dfb.h 
Log Message:
- video-xv: some of X11 atoms could be set via OSD too. So using hardcoded
  hotkeys for brightness, contrast, hue and saturation is obsolete and
  may be removed soon.
- video-dfb: (by Laurence Abbott) selecting field parity and triple buffering
  on via epia boards. That could be used for others too if primary head
  is connected to TV. Triple buffering is independently available as a
  separate option now.
    "-vo dfb:viatv"
    "-vo dfb:triple"


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.126
retrieving revision 1.127
diff -C2 -d -r1.126 -r1.127
*** CHANGELOG	4 Nov 2005 20:52:50 -0000	1.126
--- CHANGELOG	6 Nov 2005 17:56:06 -0000	1.127
***************
*** 1,5 ****
  Changelog
  2005-11-04:
!     - some more finish translations (by Rolf Ahrenberg)
      - sync timer mode selectable via OSD
      - removed translations of empty lines (by Rolf Ahrenberg)
--- 1,15 ----
  Changelog
+ 2005-11-06:
+     - video-xv: some of X11 atoms could be set via OSD too. So using hardcoded
+       hotkeys for brightness, contrast, hue and saturation is obsolete and
+       may be removed soon.
+     - video-dfb: (by Laurence Abbott) selecting field parity and triple buffering
+       on via epia boards. That could be used for others too if primary head
+       is connected to TV. Triple buffering is independently available as a
+       separate option now.
+         "-vo dfb:viatv"
+         "-vo dfb:triple"
  2005-11-04:
!     - some more finnish translations (by Rolf Ahrenberg)
      - sync timer mode selectable via OSD
      - removed translations of empty lines (by Rolf Ahrenberg)

Index: README
===================================================================
RCS file: /cvsroot/softdevice/softdevice/README,v
retrieving revision 1.10
retrieving revision 1.11
diff -C2 -d -r1.10 -r1.11
*** README	8 Oct 2005 12:37:16 -0000	1.10
--- README	6 Nov 2005 17:56:06 -0000	1.11
***************
*** 117,124 ****
--- 117,126 ----
  
  Many thanks to:
+ - Andre Neumann
  - Colin Paton
  - Herbert Attenberger
  - Holger Waechtler
  - Konrad Naumann
+ - Laurence Abbott
  - Luca Olivetti
  - Lucian Muresan

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.37
retrieving revision 1.38
diff -C2 -d -r1.37 -r1.38
*** setup-softdevice.c	6 Nov 2005 07:26:31 -0000	1.37
--- setup-softdevice.c	6 Nov 2005 17:56:06 -0000	1.38
***************
*** 126,131 ****
    ac3Mode       = 0;
    useMGAtv      = 0;
!   useStretchBlit = 0;
!   bufferMode    = 0;
    mainMenu  = 1;
    syncTimerMode = 2;
--- 126,133 ----
    ac3Mode       = 0;
    useMGAtv      = 0;
!   viaTv         = 0;
!   tripleBuffering = 0;
!   useStretchBlit  = 0;
!   bufferMode      = 0;
    mainMenu  = 1;
    syncTimerMode = 2;

Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.23
retrieving revision 1.24
diff -C2 -d -r1.23 -r1.24
*** setup-softdevice.h	6 Nov 2005 07:26:31 -0000	1.23
--- setup-softdevice.h	6 Nov 2005 17:56:06 -0000	1.24
***************
*** 57,60 ****
--- 57,62 ----
      int   screenPixelAspect;
      int   useMGAtv;
+     int   viaTv;
+     int   tripleBuffering;
      int   useStretchBlit;
      int   shouldSuspend;

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.46
retrieving revision 1.47
diff -C2 -d -r1.46 -r1.47
*** softdevice.c	1 Nov 2005 20:50:24 -0000	1.46
--- softdevice.c	6 Nov 2005 17:56:06 -0000	1.47
***************
*** 699,702 ****
--- 699,704 ----
    "  -vo dfb:                 enable output via directFB\n"
    "  -vo dfb:mgatv                   output via MATROX TV-out\n"
+   "  -vo dfb:viatv                   output via Unichrome TV-out\n"
+   "  -vo dfb:triple                  enables triple buffering on back end scaler\n"
  #endif
  #ifdef VIDIX_SUPPORT
***************
*** 789,792 ****
--- 791,801 ----
            if (!strncmp (vo_argv, "mgatv", 5))
              setupStore.useMGAtv = 1;
+           else if (!strncmp (vo_argv, "viatv", 5)) {
+             setupStore.viaTv = 1;
+             fprintf(stderr,"[softdevice] enabling field parity\n");
+           } else if (!strncmp (vo_argv, "triple", 6)) {
+             setupStore.tripleBuffering = 1;
+             fprintf(stderr,"[softdevice] enabling triple buffering\n");
+           }
  #else
            fprintf(stderr,"[softdevice] dfb support not compiled in\n");

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.40
retrieving revision 1.41
diff -C2 -d -r1.40 -r1.41
*** video-dfb.c	15 Sep 2005 18:23:05 -0000	1.40
--- video-dfb.c	6 Nov 2005 17:56:06 -0000	1.41
***************
*** 254,257 ****
--- 254,281 ----
  /* ---------------------------------------------------------------------------
   */
+ static void BESColorkeyState(IDirectFBDisplayLayer *layer, bool state)
+ {
+   if (layer)
+   {
+       DFBDisplayLayerConfig       dlc;
+     dlc.flags = DLCONF_OPTIONS;
+     dlc.options = (state) ? DLOP_DST_COLORKEY : DLOP_NONE;
+     try
+     {
+       layer->SetConfiguration(dlc);
+       layer->SetDstColorKey(COLORKEY);
+     }
+     catch (DFBException *ex)
+     {
+       fprintf (stderr,"[dfb] BES-%s: action=%s, result=%s\n",
+                (state) ? "ON" : "OFF",
+                ex->GetAction(), ex->GetResult());
+       delete ex;
+     }
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  cDFBVideoOut::cDFBVideoOut(cSetupStore *setupStore)
                : cVideoOut(setupStore)
***************
*** 275,278 ****
--- 299,306 ----
    clearBackCount = 2; // by default for double buffering;
    OSDpresent = false;
+   fieldParity = 0;    // 0 - top field first, 1 - bottom field first
+ 
+   if(setupStore->viaTv)
+     setupStore->tripleBuffering = 1;
  
    try
***************
*** 333,354 ****
      if (setupStore->useMGAtv)
      {
!       DFBDisplayLayerConfig   dlc;
! 
!       dlc.flags = (DFBDisplayLayerConfigFlags)
!                   (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
!       //dlc.buffermode = DLBM_BACKVIDEO;
!       dlc.buffermode = DLBM_TRIPLE;
!       clearBackCount = 3;             // 3 for triple, 2 for double buffering
!       dlc.pixelformat = DSPF_ARGB;
!       dlc.options = DLOP_FIELD_PARITY;
! 
!       osdLayer->SetCooperativeLevel(DLSCL_EXCLUSIVE);
!       osdLayer->SetOpacity(0xff);
!       osdLayer->SetConfiguration(dlc);
!       osdLayer->SetFieldParity(0);
        scrSurface = osdLayer->GetSurface();
      }
      else
      {
        scrSurface = dfb->CreateSurface (scrDsc);
      }
--- 361,374 ----
      if (setupStore->useMGAtv)
      {
!       EnableFieldParity(osdLayer);
        scrSurface = osdLayer->GetSurface();
      }
      else
      {
+       if (setupStore->viaTv)
+       {
+         EnableFieldParity(videoLayer);
+       }
+ 
        scrSurface = dfb->CreateSurface (scrDsc);
      }
***************
*** 480,483 ****
--- 500,506 ----
          videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
  
+         if (!setupStore->viaTv)
+           BESColorkeyState(videoLayer, true);
+ 
          fprintf(stderr,"[dfb] Configuring CooperativeLevel for OSD\n");
          osdLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
***************
*** 508,511 ****
--- 531,582 ----
  /* ---------------------------------------------------------------------------
   */
+ void cDFBVideoOut::EnableFieldParity(IDirectFBDisplayLayer *layer)
+ {
+     DFBDisplayLayerConfig         dlc;
+     DFBDisplayLayerDescription    desc;
+ 
+   desc = layer->GetDescription();
+ 
+   dlc.flags = (DFBDisplayLayerConfigFlags)
+                 (DLCONF_PIXELFORMAT | DLCONF_BUFFERMODE | DLCONF_OPTIONS);
+   dlc.buffermode = DLBM_TRIPLE;
+   fprintf(stderr,"[dfb] Set DLBM_TRIPLE for layer [%s]\n", desc.name);
+ 
+   dlc.pixelformat = DSPF_ARGB;
+   clearBackCount = 3;             // 3 for triple, 2 for double buffering
+ 
+   if (desc.caps & DLCAPS_FIELD_PARITY)
+   {
+     dlc.options = DLOP_FIELD_PARITY;
+     fprintf(stderr,
+             "[dfb] DLOP_FIELD_PARITY supported by layer [%s]\n",
+             desc.name);
+   }
+   else
+   {
+     dlc.options = DLOP_NONE;
+     fprintf(stderr,
+             "[dfb] DLOP_FIELD_PARITY not supported by layer [%s]\n",
+             desc.name);
+   }
+ 
+   try
+   {
+     layer->SetCooperativeLevel(DLSCL_EXCLUSIVE);
+     layer->SetOpacity(0xff);
+     layer->SetConfiguration(dlc);
+     if (desc.caps & DLCAPS_FIELD_PARITY)
+       layer->SetFieldParity(fieldParity);
+   }
+   catch(DFBException *ex)
+   {
+     fprintf (stderr,"[dfb] EnableFieldParity: action=%s, result=%s\n",
+              ex->GetAction(), ex->GetResult());
+     delete ex;
+   }
+ }
+ 
+ /* ---------------------------------------------------------------------------
+  */
  void cDFBVideoOut::GetDisplayFrameTime (void)
  {
***************
*** 725,731 ****
          }
  
!         if (setupStore->useMGAtv)
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
          try
          {
--- 796,804 ----
          }
  
!         if (setupStore->useMGAtv || setupStore->viaTv) {
            dlc.options = (DFBDisplayLayerOptions)((int)dlc.options|
                                                   DLOP_FIELD_PARITY);
+           fprintf(stderr, "[dfb] SetParams: Enabling DLOP_FIELD_PARITY\n");
+         }
          try
          {
***************
*** 747,766 ****
                        ((int) dlc.flags | DLCONF_BUFFERMODE);
  
!         //dlc.buffermode = DLBM_TRIPLE;
  
!         //videoLayer->TestConfiguration(dlc, &failed);
!         //if (failed & DLCONF_BUFFERMODE)
!         //{
!         //  fprintf(stderr, "[dfb]: SetParms (): failed to set buffermode "
!         //          "to triple mode, trying back video\n");
            dlc.buffermode = DLBM_BACKVIDEO;
!           videoLayer->TestConfiguration(dlc, &failed);
!           if (failed & DLCONF_BUFFERMODE)
            {
!             fprintf(stderr, "[dfb]: SetParams: failed to set buffermode "
!                     "to back video, reverting to normal\n");
!             dlc.buffermode = DLBM_FRONTONLY;
            }
!         //}
  
          /* --------------------------------------------------------------------
--- 820,861 ----
                        ((int) dlc.flags | DLCONF_BUFFERMODE);
  
!         dlc.buffermode = DLBM_UNKNOWN;
!         if (setupStore->tripleBuffering)
!         {
!           dlc.buffermode = DLBM_TRIPLE;
  
!           try
!           {
!             videoLayer->TestConfiguration(dlc, &failed);
!           }
!           catch (DFBException *ex)
!           {
!             if (failed & DLCONF_BUFFERMODE)
!             {
!               fprintf(stderr, "[dfb]: SetParms (): failed to set buffermode "
!                       "to triple, will try back video\n");
!               dlc.buffermode = DLBM_UNKNOWN;
!             }
!             delete ex;
!           }
!         }
!         if (dlc.buffermode == DLBM_UNKNOWN)
!         {
            dlc.buffermode = DLBM_BACKVIDEO;
!           try
            {
!             videoLayer->TestConfiguration(dlc, &failed);
            }
!           catch (DFBException *ex)
!           {
!             if (failed & DLCONF_BUFFERMODE)
!             {
!               fprintf(stderr, "[dfb]: SetParams: failed to set buffermode "
!                       "to back video, reverting to normal\n");
!               dlc.buffermode = DLBM_FRONTONLY;
!             }
!             delete ex;
!           }
!         }
  
          /* --------------------------------------------------------------------
***************
*** 1258,1262 ****
      else
      {
!       videoSurface->Flip(NULL, DSFLIP_ONSYNC);
      }
    }
--- 1353,1360 ----
      else
      {
!       if (setupStore->tripleBuffering)
!         videoSurface->Flip(/*NULL, DSFLIP_ONSYNC*/);
!       else
!         videoSurface->Flip(NULL, DSFLIP_ONSYNC);
      }
    }

Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.11
retrieving revision 1.12
diff -C2 -d -r1.11 -r1.12
*** video-dfb.h	7 Oct 2005 09:09:33 -0000	1.11
--- video-dfb.h	6 Nov 2005 17:56:06 -0000	1.12
***************
*** 41,47 ****
      int   clearAlpha;
      int   clearBackCount,
!           clearBackground;
  
      void SetParams();
  
    public:
--- 41,49 ----
      int   clearAlpha;
      int   clearBackCount,
!           clearBackground,
!           fieldParity;
  
      void SetParams();
+     void EnableFieldParity(IDirectFBDisplayLayer *layer);
  
    public:



From nobody at sheep.berlios.de  Mon Nov  7 21:57:01 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 7 Nov 2005 21:57:01 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.12,1.13
Message-ID: <200511072057.jA7Kv1N32432@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv1752

Modified Files:
	i18n.c 
Log Message:
finnish update by Rolf Ahrenberg

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.12
retrieving revision 1.13
diff -C2 -d -r1.12 -r1.13
*** i18n.c	6 Nov 2005 07:21:45 -0000	1.12
--- i18n.c	7 Nov 2005 20:56:59 -0000	1.13
***************
*** 907,910 ****
--- 907,1025 ----
  #endif
    },
+   { "Video out",    //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "Kuvasignaalin ulostulo", //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Brightness",   //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "Kirkkaus",     //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Contrast",     //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "Kontrasti",    //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Hue",          //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "V?ris?vy",     //  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
+   { "Saturation",   //  1
+     "",             //  2 TODO
+     "",             //  3 TODO
+     "",             //  4 TODO
+     "",             //  5 TODO
+     "",             //  6 TODO
+     "",             //  7 TODO
+     "",             //  8 TODO
+     "V?rikyll?isyys",//  9
+     "",             // 10 TODO
+     "",             // 11 TODO
+     "",             // 12 TODO
+     "",             // 13 TODO
+     "",             // 14 TODO
+     "",             // 15 TODO
+     "",             // 16 TODO
+ #if VDRVERSNUM >= 10316
+     "",             // 17 TODO
+     "",             // 18 TODO
+     "",             // 19 TODO
+     "",             // 20 TODO
+ #endif
+   },
    { NULL }
    };



From nobody at sheep.berlios.de  Mon Nov  7 21:59:38 2005
From: nobody at sheep.berlios.de (lucke)
Date: Mon, 7 Nov 2005 21:59:38 +0100
Subject: [Softdevice-cvs] softdevice video-xv.c,1.34,1.35
Message-ID: <200511072059.jA7KxcN32476@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv2057

Modified Files:
	video-xv.c 
Log Message:
removed debugging fprintf()

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** video-xv.c	6 Nov 2005 07:29:16 -0000	1.34
--- video-xv.c	7 Nov 2005 20:59:35 -0000	1.35
***************
*** 124,128 ****
            value >= portAttributes[i].min_value)
        {
- fprintf(stderr, " - (%s) new val [%d]\n",name, value);
          portAttributeCurrentValues[i] = value;
          XvSetPortAttribute(dpy,port,portAttributeAtoms[i],portAttributeCurrentValues[i]);
--- 124,127 ----



From nobody at sheep.berlios.de  Thu Nov 10 07:54:16 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 10 Nov 2005 07:54:16 +0100
Subject: [Softdevice-cvs] softdevice configure,1.8,1.9
Message-ID: <200511100654.jAA6sGN23308@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv11896

Modified Files:
	configure 
Log Message:
do not generate config.x files if ffmpeg has no *.pc files

Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** configure	7 Oct 2005 13:37:53 -0000	1.8
--- configure	10 Nov 2005 06:54:07 -0000	1.9
***************
*** 21,24 ****
--- 21,25 ----
  : ${CFLAGS=""}
  
+ ffmpeg="yes"
  dfb="yes"
  libpostproc="no"
***************
*** 69,73 ****
  pkg-config --libs libpostproc >/dev/null 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
! ffmpeg_libs=`pkg-config --libs $ffmpeg_l1`
  ffmpeg_cflags=`pkg-config --cflags $ffmpeg_l1`
  
--- 70,80 ----
  pkg-config --libs libpostproc >/dev/null 2>&1 && { ffmpeg_l1="$ffmpeg_l1 libpostproc";libpostproc="yes"; }
  
! ffmpeg_libs=`pkg-config --libs $ffmpeg_l1` || ffmpeg="no"
! 
! if test "${ffmpeg}" = "no" ; then
!   echo "A more recent (cvs) version of ffmpeg is required to run configure"
!   exit 8;
! fi
! 
  ffmpeg_cflags=`pkg-config --cflags $ffmpeg_l1`
  



From nobody at sheep.berlios.de  Thu Nov 10 07:55:37 2005
From: nobody at sheep.berlios.de (lucke)
Date: Thu, 10 Nov 2005 07:55:37 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.13,1.14
Message-ID: <200511100655.jAA6tbN23339@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12587

Modified Files:
	i18n.c 
Log Message:
english: change save -> safe

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.13
retrieving revision 1.14
diff -C2 -d -r1.13 -r1.14
*** i18n.c	7 Nov 2005 20:56:59 -0000	1.13
--- i18n.c	10 Nov 2005 06:55:35 -0000	1.14
***************
*** 700,704 ****
  #endif
    },
!   { "save",         //  1
      "sicher",       //  2
      "",             //  3 TODO
--- 700,704 ----
  #endif
    },
!   { "safe",         //  1
      "sicher",       //  2
      "",             //  3 TODO



From nobody at sheep.berlios.de  Sat Nov 12 08:57:49 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 12 Nov 2005 08:57:49 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.127,1.128 softdevice.c,1.47,1.48 softdevice.h,1.5,1.6 mpeg2decoder.c,1.58,1.59 mpeg2decoder.h,1.33,1.34
Message-ID: <200511120757.jAC7vnN06980@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv13820

Modified Files:
	CHANGELOG softdevice.c softdevice.h mpeg2decoder.c 
	mpeg2decoder.h 
Log Message:
- new packet mode: make some softdevice functions available to other
  plugins useing the new service interface



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.127
retrieving revision 1.128
diff -C2 -d -r1.127 -r1.128
*** CHANGELOG	6 Nov 2005 17:56:06 -0000	1.127
--- CHANGELOG	12 Nov 2005 07:57:41 -0000	1.128
***************
*** 1,3 ****
--- 1,6 ----
  Changelog
+ 2005-11-12:
+     - new packet mode: make some softdevice functions available to other
+       plugins like softplay useing the new service interface
  2005-11-06:
      - video-xv: some of X11 atoms could be set via OSD too. So using hardcoded

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.47
retrieving revision 1.48
diff -C2 -d -r1.47 -r1.48
*** softdevice.c	6 Nov 2005 17:56:06 -0000	1.47
--- softdevice.c	12 Nov 2005 07:57:41 -0000	1.48
***************
*** 468,472 ****
        default:
            printf("playmode not implemented... %d\n",PlayMode);
-           decoder->Stop();
            break;
      }
--- 468,471 ----
***************
*** 489,493 ****
        cDevice::Clear();
        decoder->Clear();
!     } else decoder->ClearPacketQueue();
  }
  void cSoftDevice::Play(void)
--- 488,492 ----
        cDevice::Clear();
        decoder->Clear();
!     } else decoder->ResetDecoder();
  }
  void cSoftDevice::Play(void)
***************
*** 530,534 ****
  bool cSoftDevice::Poll(cPoller &Poller, int TimeoutMs)
  {
!    //fprintf(stderr,"[softdevice] Poll TimeoutMs: %d ....\n",TimeoutMs);
  
    if ( decoder->BufferFill() > 90 ) {
--- 529,533 ----
  bool cSoftDevice::Poll(cPoller &Poller, int TimeoutMs)
  {
!   SOFTDEB("[softdevice] Poll TimeoutMs: %d ....\n",TimeoutMs);
  
    if ( decoder->BufferFill() > 90 ) {
***************
*** 586,590 ****
    if ( packetMode && ic && Length == -2 ) {
       // Length = -2 : pass pointer to packet
!      decoder->QueuePacket(ic,( AVPacket &) *Data);
       return -2;
    };
--- 585,589 ----
    if ( packetMode && ic && Length == -2 ) {
       // Length = -2 : pass pointer to packet
!      decoder->QueuePacket(ic,( AVPacket &) *Data,true);
       return -2;
    };
***************
*** 639,643 ****
    if ( packetMode && ic && Length == -2 ) {
       // Length = -2 : pass pointer to packet
!      decoder->QueuePacket(ic,( AVPacket &) *Data);
       return -2;
    };
--- 638,642 ----
    if ( packetMode && ic && Length == -2 ) {
       // Length = -2 : pass pointer to packet
!      decoder->QueuePacket(ic,( AVPacket &) *Data,true);
       return -2;
    };
***************
*** 897,900 ****
--- 896,952 ----
    return true;
  }
+ 
+ #if VDRVERSNUM >= 10330
+ static void QueuePacketFct(cDevice *Device, AVFormatContext *ic, AVPacket &pkt) {
+         cSoftDevice *device = dynamic_cast <cSoftDevice*>(Device);
+ 
+         if (device)
+                 device->QueuePacket(ic,pkt);
+         else printf("Device is not the softdevice!!\n");
+ };
+ 
+ static int BufferFillFct(cDevice *Device, int Stream, int value =-1) {
+         cSoftDevice *device = dynamic_cast <cSoftDevice*>(Device);
+ 
+         if (device)
+                 return device->BufferFill(Stream);
+         else printf("Device is not the softdevice!!\n");
+         return 0;
+ };
+ 
+ static int FreezeFct(cDevice *Device, int Stream, int value =-1) {
+         cSoftDevice *device = dynamic_cast <cSoftDevice*>(Device);
+ 
+         if (device)
+                 return device->Freeze(Stream,value);
+         else printf("Device is not the softdevice!!\n");
+         return 0;
+ };
+ 
+ static int ResetDecoderFct(cDevice *Device, int Stream, int value =-1) {
+         cSoftDevice *device = dynamic_cast <cSoftDevice*>(Device);
+ 
+         if (device)
+                 device->ResetDecoder(Stream);
+         else printf("Device is not the softdevice!!\n");
+         return 0;
+ };
+  
+ bool cPluginSoftDevice::Service(const char *Id, void *Data ) {
+         printf("Service '%s'\n",Id);
+         struct PacketHandlesV100 *Handles=(struct PacketHandlesV100 *) Data;
+         if ( strcmp(Id,GET_PACKET_HANDEL_IDV100) == 0 ) {
+                 if ( Data ) {
+                         Handles->QueuePacket=&QueuePacketFct;
+                         Handles->ResetDecoder = &ResetDecoderFct;
+                         Handles->BufferFill = &BufferFillFct;
+                         Handles->Freeze = &FreezeFct;
+                 };
+                 return true;
+         };
+         return false;
+ };
+ #endif
+ 
  
  bool cPluginSoftDevice::Start(void)

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.5
retrieving revision 1.6
diff -C2 -d -r1.5 -r1.6
*** softdevice.h	22 Jul 2005 08:24:56 -0000	1.5
--- softdevice.h	12 Nov 2005 07:57:41 -0000	1.6
***************
*** 19,22 ****
--- 19,41 ----
  #include "utils.h"
  
+ // ---- Service interface ----------------------------------------------------
+ 
+ 
+ typedef void (* fQueuePacket)(cDevice *Device, AVFormatContext *ic, AVPacket &pkt);
+ 
+ typedef int (* SoftdeviceHandle)(cDevice *Device,int Stream, int value=-1);
+ 
+ struct PacketHandlesV100{
+         fQueuePacket  QueuePacket;
+         SoftdeviceHandle ResetDecoder;
+         SoftdeviceHandle BufferFill;
+         SoftdeviceHandle Freeze;
+         // value = 0 Play, value = 1 Pause
+ };
+         
+ 
+ static const char *const GET_PACKET_HANDEL_IDV100="softdevice-GetPacketHandles-v1.0";
+ // 
+ 
  // --- cSoftDevice ------------------------------------------------------------
  class cPluginSoftDevice : public cPlugin {
***************
*** 40,43 ****
--- 59,65 ----
    virtual cMenuSetupPage *SetupMenu(void);
    virtual bool SetupParse(const char *Name, const char *Value);
+ #if VDRVERSNUM >= 10330
+   virtual bool Service(const char *Id, void *Data = NULL);
+ #endif
  };
  
***************
*** 62,69 ****
    ~cSoftDevice();
    
!   void QueuePacket(const AVFormatContext *ic, AVPacket &pkt) 
!   { if (decoder) decoder->QueuePacket(ic,pkt); };
!   void ClearPacketQueue() 
!   { if (decoder) decoder->ClearPacketQueue(); };
  
    void LoadSubPlugin(char *outMethodName, int reconfigureArg, char *pluginPath);
--- 84,95 ----
    ~cSoftDevice();
    
!   inline void QueuePacket(AVFormatContext *ic, AVPacket &pkt) 
!   { if (decoder) decoder->QueuePacket(ic,pkt,true); };
!   inline int ResetDecoder(int Stream) 
!   { if (decoder) decoder->ResetDecoder(Stream); return 0;};
!   inline int BufferFill(int Stream)
!   { if (decoder) return decoder->BufferFill(Stream); return 0;};
!   inline int Freeze(int Stream, int Value)
!   { if (decoder) decoder->Freeze(Stream,Value); return 0;};
  
    void LoadSubPlugin(char *outMethodName, int reconfigureArg, char *pluginPath);

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.58
retrieving revision 1.59
diff -C2 -d -r1.58 -r1.59
*** mpeg2decoder.c	4 Nov 2005 19:08:16 -0000	1.58
--- mpeg2decoder.c	12 Nov 2005 07:57:41 -0000	1.59
***************
*** 221,232 ****
  };
  
! void cStreamDecoder::Freeze(void)
  {
    //printf("freeze mode\n");
!   freezeMode=true;
  };
  
  void cStreamDecoder::Stop(void)
  {
    active=false;
    if (syncTimer)
--- 221,233 ----
  };
  
! void cStreamDecoder::Freeze(bool freeze)
  {
    //printf("freeze mode\n");
!   freezeMode=freeze;
  };
  
  void cStreamDecoder::Stop(void)
  {
+   CMDDEB("cStreamDecoder::Stop\n");
    active=false;
    if (syncTimer)
***************
*** 237,240 ****
--- 238,242 ----
    PacketQueue.EnablePutSignal();
    Cancel(3);
+   CMDDEB("cStreamDecoder::Stop finished\n");
  }
  
***************
*** 464,467 ****
--- 466,470 ----
  cAudioStreamDecoder::~cAudioStreamDecoder()
  {
+   CMDDEB("~cAudioStreamDecoder\n");
    cClock::AdjustAudioPTS(0);
    Cancel(3);
***************
*** 513,529 ****
  };
  
! void cVideoStreamDecoder::Freeze(void)
  {
!   cStreamDecoder::Freeze();
    videoOut->FreezeMode(freezeMode);
  };
  
- void cVideoStreamDecoder::Stop(void)
- {
-   active=false;
-   syncTimer->Signal(); // abort waiting for frame display
-   Cancel(3);
- }
- 
  uint64_t cVideoStreamDecoder::GetPTS() {
    return pts - (delay + syncTimer->TimePassed())/100;
--- 516,525 ----
  };
  
! void cVideoStreamDecoder::Freeze(bool freeze)
  {
!   cStreamDecoder::Freeze(freeze);
    videoOut->FreezeMode(freezeMode);
  };
  
  uint64_t cVideoStreamDecoder::GetPTS() {
    return pts - (delay + syncTimer->TimePassed())/100;
***************
*** 542,545 ****
--- 538,542 ----
        fprintf(stderr,"Invalid width (%d) or height (%d), most likely a broken stream\n",
            context->width,context->height);
+       resetCodec();
        return len;
      };
***************
*** 548,552 ****
          pkt->stream_index,data,size);
      len = avcodec_decode_video(context, picture, &got_picture,data, size);
!     BUFDEB("end decode video\n");
      if (len < 0) {
        printf("[mpegdecoder] Error while decoding video frame %d\n", frame);
--- 545,550 ----
          pkt->stream_index,data,size);
      len = avcodec_decode_video(context, picture, &got_picture,data, size);
!     BUFDEB("end decode video got_picture %d, data %p, size %d\n",
!         got_picture,data,size);
      if (len < 0) {
        printf("[mpegdecoder] Error while decoding video frame %d\n", frame);
***************
*** 651,657 ****
      }
  
!   if (!hurry_up || frame % 2 )
      videoOut->DrawVideo_420pl(syncTimer, &delay, picture,context);
!   else
      fprintf(stderr,"+");
    // we just displayed a frame, now it's the right time to
--- 649,657 ----
      }
  
!   if (!hurry_up || frame % 2 ) {
!     MPGDEB("DrawVideo...delay : %d\n",delay);
      videoOut->DrawVideo_420pl(syncTimer, &delay, picture,context);
!     MPGDEB("end DrawVideo\n");
!   } else
      fprintf(stderr,"+");
    // we just displayed a frame, now it's the right time to
***************
*** 665,668 ****
--- 665,670 ----
      offset = aPTS - pts ;
    else offset = 0;
+   if ( abs(offset) > 100000)
+           offset=0;
  
    // this few lines does the whole syncing
***************
*** 703,707 ****
        (picture->pict_type == FF_B_TYPE ? "B_t":"other"
        )))
!       ,(float)dispTime/1000 );
    }
  #endif
--- 705,709 ----
        (picture->pict_type == FF_B_TYPE ? "B_t":"other"
        )))
!       ,(float)dispTime/1000.0 );
    }
  #endif
***************
*** 726,731 ****
        printf("A-V: %02.2f+-%02.2f ms DispTime: %02.2f ms hurry_up: %d\n",
         offsetSum/(float)Freq,
!        sqrt(offsetSqSum/((float)Freq)-(offsetSum*offsetSum)/((float)Freq*Freq)),
!        DispTSum/(float)Freq/1000,hurry_up);
        offsetSum=offsetSqSum=DispTSum=DispTSqSum=0;
        StatCount=0;
--- 728,733 ----
        printf("A-V: %02.2f+-%02.2f ms DispTime: %02.2f ms hurry_up: %d\n",
         offsetSum/(float)Freq,
!        sqrt(offsetSqSum/((float)Freq)-(offsetSum*offsetSum)/((float)(Freq*Freq))),
!        DispTSum/(float)Freq/1000.0,hurry_up);
        offsetSum=offsetSqSum=DispTSum=DispTSqSum=0;
        StatCount=0;
***************
*** 1025,1028 ****
--- 1027,1031 ----
    videoOut->InvalidateOldPicture();
    delete(syncTimer);
+   syncTimer=NULL;
    free(picture);
    if (pic_buf_lavc)
***************
*** 1095,1107 ****
--- 1098,1117 ----
  cMpeg2Decoder::~cMpeg2Decoder()
  {
+   aoutMutex.Lock();
    if (aout)
      delete(aout);
    aout=0;
+   aoutMutex.Unlock();
+   
+   voutMutex.Lock();
    if (vout)
      delete(vout);
    vout=0;
+   voutMutex.Unlock();
  }
  
  int cMpeg2Decoder::read_packet(uint8_t *buf, int buf_size) {
+    if (!StreamBuffer)
+            return 0;
     BUFDEB("read_packet Del %d\n",LastSize);
      StreamBuffer->Del(LastSize);
***************
*** 1173,1176 ****
--- 1183,1187 ----
     init_put_byte(&ic->pb, NULL,dvb_buf_size[setupStore.bufferMode]/2, 0, this,
         read_packet_RingBuffer,NULL,seek_RingBuffer);
+    ic->pb.buf_end=NULL;
     CMDDEB("init put byte finished\n");
  };
***************
*** 1191,1197 ****
          while (freezeMode && ThreadActive)
            usleep(50000);
!       
!         //ret = av_read_frame(ic, &pkt);
          BUFDEB("av_read_frame start\n");
          ret = av_read_packet(ic, &pkt);
          if (ret < 0) {
--- 1202,1208 ----
          while (freezeMode && ThreadActive)
            usleep(50000);
!         
          BUFDEB("av_read_frame start\n");
+         //ret = av_read_frame(ic, &pkt);
          ret = av_read_packet(ic, &pkt);
          if (ret < 0) {
***************
*** 1201,1204 ****
--- 1212,1216 ----
              continue;
          }
+         //av_dup_packet(&pkt);
          PacketCount++;
          BUFDEB("got packet from av_read_frame!\n");
***************
*** 1207,1211 ****
            pkt.pts/=9;
  
!         QueuePacket(ic,pkt);
  
          if (nStreams!=ic->nb_streams ){
--- 1219,1223 ----
            pkt.pts/=9;
  
!         QueuePacket(ic,pkt,packetMode);
  
          if (nStreams!=ic->nb_streams ){
***************
*** 1229,1241 ****
  }
  
! void cMpeg2Decoder::ClearPacketQueue()
  {
!   if (aout)
!     aout->Clear();
!   if (vout)
!     vout->Clear();
  };
  
! void cMpeg2Decoder::QueuePacket(const AVFormatContext *ic, AVPacket &pkt)
  {
    BUFDEB("QueuePacket AudioIdx: %d VideoIdx %d pkt.stream_index: %d\n",
--- 1241,1275 ----
  }
  
! void cMpeg2Decoder::ResetDecoder(int Stream)
  {
!   CMDDEB("ResetDecoder %d\n",Stream);
!   
!   if (Stream & SOFTDEVICE_AUDIO_STREAM)  {
!     aoutMutex.Lock();
!     if (aout) {
!       CMDDEB("ResetDecoder resetting audio decoder\n");
!       aout->Stop();
!       delete aout;
!       aout=NULL;
!       AudioIdx=NO_STREAM;
!     };
!     aoutMutex.Unlock();
!   };
!     
!   if (Stream & SOFTDEVICE_VIDEO_STREAM)  {
!     voutMutex.Lock();
!     if (vout) {
!       CMDDEB("ResetDecoder resetting video decoder\n");
!       vout->Stop();
!       delete vout;
!       vout=NULL;
!       VideoIdx=NO_STREAM;
!     };
!     voutMutex.Unlock();
!   };
  };
  
! void cMpeg2Decoder::QueuePacket(const AVFormatContext *ic, AVPacket &pkt,
! 		bool PacketMode)
  {
    BUFDEB("QueuePacket AudioIdx: %d VideoIdx %d pkt.stream_index: %d\n",
***************
*** 1252,1267 ****
          return;
    }; 
!   // check if there are new streams
!   if (AudioIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
  #if LIBAVFORMAT_BUILD > 4628
!       ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_AUDIO &&
  #else
!       ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_AUDIO &&
! #endif
!       AudioIdx != pkt.stream_index) {
  
      CMDDEB("new Audio stream index.. old %d new %d\n",
        AudioIdx,pkt.stream_index);
      AudioIdx = pkt.stream_index;
      if (aout) {
        aout->Stop();
--- 1286,1312 ----
          return;
    }; 
!   int packet_type=CODEC_TYPE_UNKNOWN;
! 
  #if LIBAVFORMAT_BUILD > 4628
!   if ( ic->streams[pkt.stream_index] 
!                   && ic->streams[pkt.stream_index]->codec )
!           packet_type = ic->streams[pkt.stream_index]->codec->codec_type;
  #else
!   if ( ic->streams[pkt.stream_index] ) 
!           packet_type = ic->streams[pkt.stream_index]->codec.codec_type;
! #endif         
  
+   if ( packet_type == CODEC_TYPE_UNKNOWN ) {
+           BUFDEB("Unknown packet type! Return;\n");
+           return;
+   };
+   
+   // check if there are new streams
+   if ( AudioIdx != DONT_PLAY && packet_type == CODEC_TYPE_AUDIO
+        && AudioIdx != pkt.stream_index) {
      CMDDEB("new Audio stream index.. old %d new %d\n",
        AudioIdx,pkt.stream_index);
      AudioIdx = pkt.stream_index;
+     aoutMutex.Lock();
      if (aout) {
        aout->Stop();
***************
*** 1271,1293 ****
  #if LIBAVFORMAT_BUILD > 4628
      aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode, packetMode );
  #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode, packetMode );
  #endif
    } else
! #if LIBAVFORMAT_BUILD > 4628
!   if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
!       ic->streams[pkt.stream_index]->codec->codec_type == CODEC_TYPE_VIDEO &&
!       VideoIdx!=pkt.stream_index)
! #else
!   if (VideoIdx != DONT_PLAY && ic->streams[pkt.stream_index] &&
!       ic->streams[pkt.stream_index]->codec.codec_type == CODEC_TYPE_VIDEO &&
!       VideoIdx!=pkt.stream_index)
! #endif
!   {
      CMDDEB("new Video stream index.. old %d new %d\n",
        VideoIdx,pkt.stream_index);
      VideoIdx=pkt.stream_index;
      if (vout) {
        vout->Stop();
--- 1316,1332 ----
  #if LIBAVFORMAT_BUILD > 4628
      aout = new cAudioStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode, PacketMode );
  #else
      aout = new cAudioStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                  audioOut, audioMode, PacketMode );
  #endif
+     aoutMutex.Unlock();
    } else
!   if (VideoIdx != DONT_PLAY && packet_type == CODEC_TYPE_VIDEO 
!        && VideoIdx!=pkt.stream_index) {
      CMDDEB("new Video stream index.. old %d new %d\n",
        VideoIdx,pkt.stream_index);
      VideoIdx=pkt.stream_index;
+     voutMutex.Lock();
      if (vout) {
        vout->Stop();
***************
*** 1295,1309 ****
        vout = NULL;
      };
  #if LIBAVFORMAT_BUILD > 4628
      vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed, packetMode );
  #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed, packetMode );
  #endif
    };
    
    // write streams 
!   if ( pkt.stream_index == VideoIdx && vout ) {
      BUFDEB("QueuePacket video stream\n");
      while ( vout->PutPacket(pkt) == -1 && ThreadActive ) {
--- 1334,1350 ----
        vout = NULL;
      };
+     voutMutex.Unlock();
  #if LIBAVFORMAT_BUILD > 4628
      vout = new cVideoStreamDecoder(ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed, PacketMode );
  #else
      vout = new cVideoStreamDecoder(&ic->streams[pkt.stream_index]->codec,
!                    videoOut, &clock, Speed, PacketMode );
  #endif
    };
    
    // write streams 
!   voutMutex.Lock();
!   if ( packet_type == CODEC_TYPE_VIDEO && vout ) {
      BUFDEB("QueuePacket video stream\n");
      while ( vout->PutPacket(pkt) == -1 && ThreadActive ) {
***************
*** 1311,1315 ****
        //printf("Video Buffer full\n");
      };
!   } else if ( pkt.stream_index == AudioIdx && aout ) {
      BUFDEB("QueuePacket audio stream\n");
      while ( aout->PutPacket(pkt) == -1 && ThreadActive ) {
--- 1352,1360 ----
        //printf("Video Buffer full\n");
      };
!   } ;
!   voutMutex.Unlock();
!   
!   aoutMutex.Lock();
!   if ( packet_type == CODEC_TYPE_AUDIO && aout ) {
      BUFDEB("QueuePacket audio stream\n");
      while ( aout->PutPacket(pkt) == -1 && ThreadActive ) {
***************
*** 1317,1321 ****
        //printf("Audio Buffer full\n");
      };
!   } else {
      //printf("Unknown packet or vout or aout not init!!\n");
      av_free_packet(&pkt);
--- 1362,1369 ----
        //printf("Audio Buffer full\n");
      };
!   };
!   aoutMutex.Unlock();
!   
!   if ( packet_type != CODEC_TYPE_VIDEO && packet_type != CODEC_TYPE_AUDIO ) {
      //printf("Unknown packet or vout or aout not init!!\n");
      av_free_packet(&pkt);
***************
*** 1326,1330 ****
  void cMpeg2Decoder::Start(bool GetMutex)
  {
!   CMDDEB("Start IsSuspended %d \n",IsSuspended);
    if (IsSuspended)
      // don't start if we are suspended
--- 1374,1381 ----
  void cMpeg2Decoder::Start(bool GetMutex)
  {
!   CMDDEB("Mpeg2Decoder Start IsSuspended %d  GetMutex %d\n",IsSuspended,GetMutex);
!   if (running)
!           return;
! 
    if (IsSuspended)
      // don't start if we are suspended
***************
*** 1350,1353 ****
--- 1401,1405 ----
    if (GetMutex)
      mutex.Unlock();
+   CMDDEB("mpeg2Decoder Start finished");
  }
  
***************
*** 1391,1399 ****
    if (running) 
    {
      if (aout)
        aout->Play();
      if (vout)
        vout->Play();
! 
      cClock::SetFreezeMode(false);
    };
--- 1443,1456 ----
    if (running) 
    {
+     aoutMutex.Lock();
      if (aout)
        aout->Play();
+     aoutMutex.Unlock();
+     
+     voutMutex.Lock();
      if (vout)
        vout->Play();
!     voutMutex.Unlock();
!     
      cClock::SetFreezeMode(false);
    };
***************
*** 1422,1439 ****
  };
        
! void cMpeg2Decoder::Freeze(void)
  {
!   CMDDEB("Freeze\n");
!   freezeMode=true;
    // sleep a short while before putting the
    // audio and video stream decoders to sleep
    usleep(20000);
    if (running) 
!   { 
!     if (aout)
!       aout->Freeze();
!     if (vout)
!       vout->Freeze();
! 
      cClock::SetFreezeMode(true);
    };
--- 1479,1506 ----
  };
        
! void cMpeg2Decoder::Freeze(int Stream, bool freeze)
  {
!   CMDDEB("Freeze Streams %d freeze %d\n",Stream,freeze);
!   if (Stream & SOFTDEVICE_BOTH_STREAMS == SOFTDEVICE_BOTH_STREAMS )
!     freezeMode=freeze;
    // sleep a short while before putting the
    // audio and video stream decoders to sleep
    usleep(20000);
    if (running) 
!   {
!     if (Stream & SOFTDEVICE_AUDIO_STREAM) {
!       aoutMutex.Lock();
!       if (aout)
!         aout->Freeze(freeze);
!       aoutMutex.Unlock();
!     };
!     
!     if (Stream & SOFTDEVICE_VIDEO_STREAM) {
!       voutMutex.Lock();
!       if (vout)
!         vout->Freeze(freeze);
!       voutMutex.Unlock();
!     };
!     
      cClock::SetFreezeMode(true);
    };
***************
*** 1456,1465 ****
--- 1523,1538 ----
      EnableGetSignal.Signal();
      Cancel(4);
+     
      CMDDEB("stopping video\n"); 
+     voutMutex.Lock();
      if (vout) {
        vout->Stop();
        delete(vout);
      }
+     vout=NULL;
+     voutMutex.Unlock();
+ 
      CMDDEB("stopping audio\n");
+     aoutMutex.Lock();
      if (aout) {
        aout->Stop();
***************
*** 1467,1472 ****
      }
      aout=NULL;
!     vout=NULL;
      av_close_input_file(ic);
    }
    if (StreamBuffer) {
--- 1540,1547 ----
      }
      aout=NULL;
!     aoutMutex.Unlock();
! 
      av_close_input_file(ic);
+     ic=NULL;
    }
    if (StreamBuffer) {
***************
*** 1525,1530 ****
--- 1600,1608 ----
    // XXX hack to ingore audio junk sent by vdr in the
    if (trickSpeed!=1) {
+     aoutMutex.Lock();
      if (aout)
        aout->Clear();
+     aoutMutex.Unlock();
+     
      AudioIdx=DONT_PLAY;
    } else if (AudioIdx==DONT_PLAY)
***************
*** 1533,1547 ****
    if (running)
    {
      if (aout)
        aout->TrickSpeed(Speed);
      if (vout)
        vout->TrickSpeed(Speed);
    };
  }
  void cMpeg2Decoder::SetAudioMode(int AudioMode)  { 
    CMDDEB("SetAudioMode %d\n",AudioMode);
!   audioMode=AudioMode; 
    if (aout) 
!     aout->SetAudioMode(audioMode); 
  };
  
--- 1611,1632 ----
    if (running)
    {
+     aoutMutex.Lock();
      if (aout)
        aout->TrickSpeed(Speed);
+     aoutMutex.Unlock();
+ 
+     voutMutex.Lock();
      if (vout)
        vout->TrickSpeed(Speed);
+     voutMutex.Unlock();
    };
  }
  void cMpeg2Decoder::SetAudioMode(int AudioMode)  { 
    CMDDEB("SetAudioMode %d\n",AudioMode);
!   audioMode=AudioMode;
!   aoutMutex.Lock();
    if (aout) 
!     aout->SetAudioMode(audioMode);
!   aoutMutex.Unlock();
  };
  
***************
*** 1551,1579 ****
    if (running) {
      return clock.GetPTS()*9;
! 
      if (vout)
        return vout->GetPTS()*9;
      if (aout)
        return aout->GetPTS()*9;
    }
    return -1;
  };
  
! int cMpeg2Decoder::BufferFill() 
  {
    if (freezeMode)
      return 100;
!   int fill=0;
!   int fill2=0;
!   BUFDEB("buffer fill\n");
!   if (running && vout )
!     fill= vout->BufferFill();
!     BUFDEB("vout buffer fill: %d\n",fill);
!   if (running && aout )
!     if ( (fill2=aout->BufferFill()) >fill)
!        fill=fill2;
!     
!     BUFDEB("aout buffer fill: %d\n",fill2);
!   return fill;
  }
  
--- 1636,1674 ----
    if (running) {
      return clock.GetPTS()*9;
! /*
      if (vout)
        return vout->GetPTS()*9;
      if (aout)
        return aout->GetPTS()*9;
+       */
    }
    return -1;
  };
  
! int cMpeg2Decoder::BufferFill(int Stream) 
  {
    if (freezeMode)
      return 100;
!   
!   int video_Fill=0;
!   int audio_Fill=0;
! 
!   BUFDEB("BufferFill Stream %d vout %p aout %p\n",Stream,vout,aout);
!   if (Stream & SOFTDEVICE_VIDEO_STREAM) {
!     voutMutex.Lock();
!     if ( vout  )
!       video_Fill = vout->BufferFill();
!     voutMutex.Unlock();
!   };
! 
!   if ( Stream & SOFTDEVICE_AUDIO_STREAM )  {
!     aoutMutex.Lock();
!     if (aout)
!       audio_Fill = aout->BufferFill();
!     aoutMutex.Unlock();
!   };
!   
!   BUFDEB("audio_Fill: %d video_Fill: %d\n",audio_Fill,video_Fill);
!   return video_Fill>audio_Fill ? video_Fill : audio_Fill;
  }
  
***************
*** 1583,1586 ****
--- 1678,1682 ----
  {
    BUFDEB("Decode %x, Length %d\n",Data,Length);
+   
    if (running && !IsSuspended && setupStore.shouldSuspend)
       // still running and should suspend
***************
*** 1595,1598 ****
--- 1691,1697 ----
      return Length;
    };
+ 
+   if (!StreamBuffer)
+           return 0;
  
    if (freezeMode)

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.33
retrieving revision 1.34
diff -C2 -d -r1.33 -r1.34
*** mpeg2decoder.h	29 Oct 2005 08:30:27 -0000	1.33
--- mpeg2decoder.h	12 Nov 2005 07:57:42 -0000	1.34
***************
*** 16,20 ****
  
  #ifdef PP_LIBAVCODEC
!   #include <postproc/postprocess.h>
  #endif //PP_LIBAVCODEC
  
--- 16,20 ----
  
  #ifdef PP_LIBAVCODEC
!   #include <postprocess.h>
  #endif //PP_LIBAVCODEC
  
***************
*** 47,50 ****
--- 47,55 ----
  #define DONT_PLAY  -100
  
+ #define SOFTDEVICE_VIDEO_STREAM  1
+ #define SOFTDEVICE_AUDIO_STREAM  2
+ #define SOFTDEVICE_BOTH_STREAMS (SOFTDEVICE_VIDEO_STREAM | SOFTDEVICE_AUDIO_STREAM ) 
+ 
+ 
  class cAudioStreamDecoder; 
  class cVideoStreamDecoder; 
***************
*** 168,174 ****
  
      virtual void      Clear(void);
!     virtual void      Freeze(void);
      virtual void      Play(void);
!     virtual void      Stop();
      virtual void      TrickSpeed(int Speed) {return;};
      virtual int       BufferFill(void);
--- 173,179 ----
  
      virtual void      Clear(void);
!     virtual void      Freeze(bool freeze=true);
      virtual void      Play(void);
!     void      Stop();
      virtual void      TrickSpeed(int Speed) {return;};
      virtual int       BufferFill(void);
***************
*** 259,265 ****
      ~cVideoStreamDecoder();
  
!     virtual void      Freeze(void);
      virtual void      Play(void);
-     virtual void Stop();
      virtual int DecodePacket(AVPacket *pkt);
      virtual void TrickSpeed(int Speed);
--- 264,269 ----
      ~cVideoStreamDecoder();
  
!     virtual void      Freeze(bool freeze=true);
      virtual void      Play(void);
      virtual int DecodePacket(AVPacket *pkt);
      virtual void TrickSpeed(int Speed);
***************
*** 267,271 ****
  };
  
- 
  //--------------------------------cMpeg2Decoder -------------------------
  class cMpeg2Decoder: public cThread  {
--- 271,274 ----
***************
*** 273,276 ****
--- 276,281 ----
      cVideoStreamDecoder  *vout;
      cAudioStreamDecoder  *aout;
+     cMutex          voutMutex;
+     cMutex          aoutMutex;
      cAudioOut       *audioOut;
      cVideoOut       *videoOut;
***************
*** 315,325 ****
      ~cMpeg2Decoder();
  
!     void QueuePacket(const AVFormatContext *ic,AVPacket &pkt);
!     void ClearPacketQueue();
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);
      void Start(bool GetMutex=true);
      void Play(void);
!     void Freeze(void);
      void Stop(bool GetMutex=true);
      void Clear(void);
--- 320,331 ----
      ~cMpeg2Decoder();
  
!     void QueuePacket(const AVFormatContext *ic,AVPacket &pkt, 
! 		    bool PacketMode);
!     void ResetDecoder( int Stream = SOFTDEVICE_BOTH_STREAMS );
      int Decode(const uchar *Data, int Length);
      int StillPicture(uchar *Data, int Length);
      void Start(bool GetMutex=true);
      void Play(void);
!     void Freeze( int Stream = SOFTDEVICE_BOTH_STREAMS, bool freeze=true );
      void Stop(bool GetMutex=true);
      void Clear(void);
***************
*** 337,341 ****
      { return audioMode; };
      
!     int BufferFill(void);
      // in percent 
      
--- 343,347 ----
      { return audioMode; };
      
!     int BufferFill( int Stream = SOFTDEVICE_BOTH_STREAMS );
      // in percent 
      



From nobody at sheep.berlios.de  Sat Nov 12 09:07:28 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 12 Nov 2005 09:07:28 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.128,1.129 mpeg2decoder.c,1.59,1.60
Message-ID: <200511120807.jAC87SN07209@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv20452

Modified Files:
	CHANGELOG mpeg2decoder.c 
Log Message:
- speed up moving of cutmarks by a factor of about 100. I forgot to signal
  that new data is available in StillPicture() :-/
	  


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.128
retrieving revision 1.129
diff -C2 -d -r1.128 -r1.129
*** CHANGELOG	12 Nov 2005 07:57:41 -0000	1.128
--- CHANGELOG	12 Nov 2005 08:07:21 -0000	1.129
***************
*** 1,4 ****
--- 1,6 ----
  Changelog
  2005-11-12:
+     - speed up moving of cutmarks by a factor of about 100. I forgot to signal
+       that new data is available in StillPicture() :-/
      - new packet mode: make some softdevice functions available to other
        plugins like softplay useing the new service interface

Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.59
retrieving revision 1.60
diff -C2 -d -r1.59 -r1.60
*** mpeg2decoder.c	12 Nov 2005 07:57:41 -0000	1.59
--- mpeg2decoder.c	12 Nov 2005 08:07:21 -0000	1.60
***************
*** 1569,1577 ****
      uchar *data=Data;
      int Size=Length;
      while ( (P = StreamBuffer->Put(data, Size)) != Size ) {
        data+=P;
        Size-=P;
!       usleep( 10000 );
      }
    }
    CMDDEB("StillPicture end \n");
--- 1569,1584 ----
      uchar *data=Data;
      int Size=Length;
+     BUFDEB("StillPicture StreamBuffer Put %d\n",Size);
      while ( (P = StreamBuffer->Put(data, Size)) != Size ) {
+       BUFDEB("StillPicture StreamBuffer->Put only accepted %d bytes\n",P);
        data+=P;
        Size-=P;
!       BUFDEB("StillPicture EnableGet.Signal(), EnablePut.Sleep start\n");
!       EnableGetSignal.Signal();
!       EnablePutSignal.Sleep(50000);
!       BUFDEB("StillPicture EnablePut.Sleep end\n");
      }
+     BUFDEB("StillPicture EnableGetSignal.Signal() wrote %d bytes\n",Length);
+     EnableGetSignal.Signal();
    }
    CMDDEB("StillPicture end \n");



From nobody at sheep.berlios.de  Sat Nov 12 12:55:20 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sat, 12 Nov 2005 12:55:20 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.14,1.15
Message-ID: <200511121155.jACBtKN14514@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv5721

Modified Files:
	i18n.c 
Log Message:
- fix typo in german translation



Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.14
retrieving revision 1.15
diff -C2 -d -r1.14 -r1.15
*** i18n.c	10 Nov 2005 06:55:35 -0000	1.14
--- i18n.c	12 Nov 2005 11:55:15 -0000	1.15
***************
*** 586,590 ****
    },
    { "default",      //  1
!     "standart",     //  2
      "",             //  3 TODO
      "",             //  4 TODO
--- 586,590 ----
    },
    { "default",      //  1
!     "standard",     //  2
      "",             //  3 TODO
      "",             //  4 TODO



From nobody at sheep.berlios.de  Sat Nov 12 16:45:41 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 12 Nov 2005 16:45:41 +0100
Subject: [Softdevice-cvs] softdevice i18n.c,1.15,1.16
Message-ID: <200511121545.jACFjfN19761@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv3940

Modified Files:
	i18n.c 
Log Message:
finnish save -> safe (by Rolf Ahrenberg)

Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/i18n.c,v
retrieving revision 1.15
retrieving revision 1.16
diff -C2 -d -r1.15 -r1.16
*** i18n.c	12 Nov 2005 11:55:15 -0000	1.15
--- i18n.c	12 Nov 2005 15:45:39 -0000	1.16
***************
*** 708,712 ****
      "limit?e",      //  7
      "",             //  8 TODO
!     "tallennus",    //  9
      "",             // 10 TODO
      "",             // 11 TODO
--- 708,712 ----
      "limit?e",      //  7
      "",             //  8 TODO
!     "varma",        //  9
      "",             // 10 TODO
      "",             // 11 TODO



From nobody at sheep.berlios.de  Sat Nov 12 16:47:37 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 12 Nov 2005 16:47:37 +0100
Subject: [Softdevice-cvs] softdevice softdevice.h,1.6,1.7
Message-ID: <200511121547.jACFlbN19798@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4339

Modified Files:
	softdevice.h 
Log Message:
gcc 4.0.2 fix for Service() interface

Index: softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.h,v
retrieving revision 1.6
retrieving revision 1.7
diff -C2 -d -r1.6 -r1.7
*** softdevice.h	12 Nov 2005 07:57:41 -0000	1.6
--- softdevice.h	12 Nov 2005 15:47:34 -0000	1.7
***************
*** 24,28 ****
  typedef void (* fQueuePacket)(cDevice *Device, AVFormatContext *ic, AVPacket &pkt);
  
! typedef int (* SoftdeviceHandle)(cDevice *Device,int Stream, int value=-1);
  
  struct PacketHandlesV100{
--- 24,28 ----
  typedef void (* fQueuePacket)(cDevice *Device, AVFormatContext *ic, AVPacket &pkt);
  
! typedef int (* SoftdeviceHandle)(cDevice *Device,int Stream, int value);
  
  struct PacketHandlesV100{



From nobody at sheep.berlios.de  Sat Nov 12 16:49:36 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 12 Nov 2005 16:49:36 +0100
Subject: [Softdevice-cvs] softdevice mpeg2decoder.h,1.34,1.35
Message-ID: <200511121549.jACFnaN19869@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4570

Modified Files:
	mpeg2decoder.h 
Log Message:
compile fix without configure

Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.34
retrieving revision 1.35
diff -C2 -d -r1.34 -r1.35
*** mpeg2decoder.h	12 Nov 2005 07:57:42 -0000	1.34
--- mpeg2decoder.h	12 Nov 2005 15:49:33 -0000	1.35
***************
*** 16,20 ****
  
  #ifdef PP_LIBAVCODEC
!   #include <postprocess.h>
  #endif //PP_LIBAVCODEC
  
--- 16,20 ----
  
  #ifdef PP_LIBAVCODEC
!   #include <postproc/postprocess.h>
  #endif //PP_LIBAVCODEC
  



From nobody at sheep.berlios.de  Sat Nov 12 16:50:44 2005
From: nobody at sheep.berlios.de (lucke)
Date: Sat, 12 Nov 2005 16:50:44 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.129,1.130 softdevice.c,1.48,1.49
Message-ID: <200511121550.jACFoiN19904@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv4697

Modified Files:
	CHANGELOG softdevice.c 
Log Message:
softdevice-0.2.1

Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.129
retrieving revision 1.130
diff -C2 -d -r1.129 -r1.130
*** CHANGELOG	12 Nov 2005 08:07:21 -0000	1.129
--- CHANGELOG	12 Nov 2005 15:50:41 -0000	1.130
***************
*** 1,4 ****
  Changelog
! 2005-11-12:
      - speed up moving of cutmarks by a factor of about 100. I forgot to signal
        that new data is available in StillPicture() :-/
--- 1,4 ----
  Changelog
! 2005-11-12: softdevice-0.2.1
      - speed up moving of cutmarks by a factor of about 100. I forgot to signal
        that new data is available in StillPicture() :-/

Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.48
retrieving revision 1.49
diff -C2 -d -r1.48 -r1.49
*** softdevice.c	12 Nov 2005 07:57:41 -0000	1.48
--- softdevice.c	12 Nov 2005 15:50:41 -0000	1.49
***************
*** 73,77 ****
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.2.0";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";
--- 73,77 ----
  #include "mpeg2decoder.h"
  #include "utils.h"
! static const char *VERSION        = "0.2.1";
  static const char *DESCRIPTION    = "A software emulated MPEG2 device";
  static const char *MAINMENUENTRY  = "Softdevice";



From nobody at sheep.berlios.de  Sun Nov 13 12:47:11 2005
From: nobody at sheep.berlios.de (wachm)
Date: Sun, 13 Nov 2005 12:47:11 +0100
Subject: [Softdevice-cvs] softplay i18n.c,1.1,1.2
Message-ID: <200511131147.jADBlBN27132@bat.berlios.de>

Update of /cvsroot/softdevice/softplay
In directory sheep:/tmp/cvs-serv20192

Modified Files:
	i18n.c 
Log Message:
- add french translation by Nicolas Huillard



Index: i18n.c
===================================================================
RCS file: /cvsroot/softdevice/softplay/i18n.c,v
retrieving revision 1.1
retrieving revision 1.2
diff -C2 -d -r1.1 -r1.2
*** i18n.c	4 Aug 2005 15:20:40 -0000	1.1
--- i18n.c	13 Nov 2005 11:47:05 -0000	1.2
***************
*** 16,20 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Mediasoitin",  //  9 finnish
--- 16,20 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Lecteur de m?dia", //  7 french
      "",             //  8 TODO
      "Mediasoitin",  //  9 finnish
***************
*** 39,43 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Mediasoitin ohjelmistopohjaiselle n?ytt?laitteelle", //  9
--- 39,43 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Lecteur multim?dia utilisant Softdevice", //  7
      "",             //  8 TODO
      "Mediasoitin ohjelmistopohjaiselle n?ytt?laitteelle", //  9
***************
*** 62,66 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Tiedostot",    //  9
--- 62,66 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Fichiers",     //  7
      "",             //  8 TODO
      "Tiedostot",    //  9
***************
*** 85,89 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Toista",       //  9
--- 85,89 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Lire",         //  7
      "",             //  8 TODO
      "Toista",       //  9
***************
*** 108,112 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Toista tiedostot", //  9
--- 108,112 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Parcourir les fichiers", //  7
      "",             //  8 TODO
      "Toista tiedostot", //  9
***************
*** 126,135 ****
    },
    { "Toggle List",  //  1
!     "Liste",        //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Vaihda lista", //  9
--- 126,135 ----
    },
    { "Toggle List",  //  1
!     "+/- Liste",    //  2 TODO
      "",             //  3 TODO
      "",             //  4 TODO
      "",             //  5 TODO
      "",             //  6 TODO
!     "+/- liste",    //  7
      "",             //  8 TODO
      "Vaihda lista", //  9
***************
*** 154,158 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Toista lista", //  9
--- 154,158 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Jouer liste",  //  7
      "",             //  8 TODO
      "Toista lista", //  9
***************
*** 177,181 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Tiedostot: %s",//  9
--- 177,181 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Fichiers: %s", //  7
      "",             //  8 TODO
      "Tiedostot: %s",//  9
***************
*** 200,204 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "nykyinen soittolista", //  9
--- 200,204 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Liste de lecture courante", //  7
      "",             //  8 TODO
      "nykyinen soittolista", //  9
***************
*** 223,227 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Asetukset",    //  9
--- 223,227 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Options",      //  7
      "",             //  8 TODO
      "Asetukset",    //  9
***************
*** 246,250 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Satunnaissoitto", //  9
--- 246,250 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Lecture al?atoire", //  7
      "",             //  8 TODO
      "Satunnaissoitto", //  9
***************
*** 269,273 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Uudelleentoisto", //  9
--- 269,273 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "R?p?tition automatique", //  7
      "",             //  8 TODO
      "Uudelleentoisto", //  9
***************
*** 292,296 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "(Lis??)",      //  9
--- 292,296 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "(Ajouter)",    //  7
      "",             //  8 TODO
      "(Lis??)",      //  9
***************
*** 315,319 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "(Lis??)",      //  9
--- 315,319 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "(Ajouter)",    //  7
      "",             //  8 TODO
      "(Lis??)",      //  9
***************
*** 332,336 ****
  #endif
    },
!   { "Delete",       //  1
      "L?schen",      //  2 TODO
      "",             //  3 TODO
--- 332,336 ----
  #endif
    },
!   { "Delete",       //  1 NH20051027 : seems to be already translated in core VDR
      "L?schen",      //  2 TODO
      "",             //  3 TODO
***************
*** 338,342 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Poista",       //  9
--- 338,342 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Supprime",     //  7
      "",             //  8 TODO
      "Poista",       //  9
***************
*** 355,359 ****
  #endif
    },
!   { "Stop",         //  1
      "Stopp",        //  2 TODO
      "",             //  3 TODO
--- 355,359 ----
  #endif
    },
!   { "Stop",         //  1 NH20051027 : seems to be already translated in core VDR
      "Stopp",        //  2 TODO
      "",             //  3 TODO
***************
*** 361,365 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Pys?yt?",      //  9
--- 361,365 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Stop",         //  7
      "",             //  8 TODO
      "Pys?yt?",      //  9
***************
*** 384,388 ****
      "",             //  5 TODO
      "",             //  6 TODO
!     "",             //  7 TODO
      "",             //  8 TODO
      "Soittolista 1",//  9
--- 384,388 ----
      "",             //  5 TODO
      "",             //  6 TODO
!     "Liste de lecture 1", //  7
      "",             //  8 TODO
      "Soittolista 1",//  9



From nobody at sheep.berlios.de  Tue Nov 15 07:02:43 2005
From: nobody at sheep.berlios.de (lucke)
Date: Tue, 15 Nov 2005 07:02:43 +0100
Subject: [Softdevice-cvs] softdevice video.c,1.36,1.37
Message-ID: <200511150602.jAF62hN23478@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv971

Modified Files:
	video.c 
Log Message:
redefine new_asp as volatile

Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.36
retrieving revision 1.37
diff -C2 -d -r1.36 -r1.37
*** video.c	27 Oct 2005 05:30:52 -0000	1.36
--- video.c	15 Nov 2005 06:02:16 -0000	1.37
***************
*** 320,324 ****
                                          AVCodecContext *context)
  {
!     double new_asp;
  
    /* --------------------------------------------------------------------------
--- 320,324 ----
                                          AVCodecContext *context)
  {
!     volatile double new_asp;
  
    /* --------------------------------------------------------------------------



From nobody at sheep.berlios.de  Wed Nov 16 00:05:25 2005
From: nobody at sheep.berlios.de (lucke)
Date: Wed, 16 Nov 2005 00:05:25 +0100
Subject: [Softdevice-cvs] softdevice setup-softdevice.c,1.38,1.39
Message-ID: <200511152305.jAFN5PN31778@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv23909

Modified Files:
	setup-softdevice.c 
Log Message:
remaining s/save/safe/

Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.38
retrieving revision 1.39
diff -C2 -d -r1.38 -r1.39
*** setup-softdevice.c	6 Nov 2005 17:56:06 -0000	1.38
--- setup-softdevice.c	15 Nov 2005 23:05:23 -0000	1.39
***************
*** 156,160 ****
    pp_str[3] = NULL;
  
!   bufferModes[0] = tr("save");
    bufferModes[1] = tr("good seeking");
    bufferModes[2] = tr("HDTV");
--- 156,160 ----
    pp_str[3] = NULL;
  
!   bufferModes[0] = tr("safe");
    bufferModes[1] = tr("good seeking");
    bufferModes[2] = tr("HDTV");
***************
*** 702,706 ****
  #endif
  
!   bufferModes[0] = tr("save");
    bufferModes[1] = tr("good seeking");
    bufferModes[2] = tr("HDTV");
--- 702,706 ----
  #endif
  
!   bufferModes[0] = tr("safe");
    bufferModes[1] = tr("good seeking");
    bufferModes[2] = tr("HDTV");



From nobody at sheep.berlios.de  Wed Nov 30 19:26:36 2005
From: nobody at sheep.berlios.de (wachm)
Date: Wed, 30 Nov 2005 19:26:36 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.130,1.131 utils.c,1.8,1.9
Message-ID: <200511301826.jAUIQaN19329@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv10674

Modified Files:
	CHANGELOG utils.c 
Log Message:
- g++-2.95 complaints about "::" in inline asm and wants ": :" instead.



Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.130
retrieving revision 1.131
diff -C2 -d -r1.130 -r1.131
*** CHANGELOG	12 Nov 2005 15:50:41 -0000	1.130
--- CHANGELOG	30 Nov 2005 18:26:32 -0000	1.131
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-11-30:
+     - g++-2.95 complaints about "::" in inline asm and wants ": :" instead.
  2005-11-12: softdevice-0.2.1
      - speed up moving of cutmarks by a factor of about 100. I forgot to signal

Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.8
retrieving revision 1.9
diff -C2 -d -r1.8 -r1.9
*** utils.c	25 Aug 2005 18:39:45 -0000	1.8
--- utils.c	30 Nov 2005 18:26:33 -0000	1.9
***************
*** 489,493 ****
  		MOVNTQ" %%mm6, 48(%1)\n"
  		MOVNTQ" %%mm7, 56(%1)\n"
! 		:: "r" (from), "r" (to) : "memory");
  		from=((const unsigned char *)from)+64;
  		to=((unsigned char *)to)+64;
--- 489,493 ----
  		MOVNTQ" %%mm6, 48(%1)\n"
  		MOVNTQ" %%mm7, 56(%1)\n"
! 		: : "r" (from), "r" (to) : "memory");
  		from=((const unsigned char *)from)+64;
  		to=((unsigned char *)to)+64;
***************
*** 582,586 ****
  		MOVNTQ" %%mm6, 48(%1)\n"
  		MOVNTQ" %%mm7, 56(%1)\n"
! 		:: "r" (from), "r" (to) : "memory");
  		from=((const unsigned char *)from)+64;
  		to=((unsigned char *)to)+64;
--- 582,586 ----
  		MOVNTQ" %%mm6, 48(%1)\n"
  		MOVNTQ" %%mm7, 56(%1)\n"
! 		: : "r" (from), "r" (to) : "memory");
  		from=((const unsigned char *)from)+64;
  		to=((unsigned char *)to)+64;
***************
*** 590,598 ****
                  /* since movntq is weakly-ordered, a "sfence"
  		 * is needed to become ordered again. */
! 		__asm__ __volatile__ ("sfence":::"memory");
  #endif
  #ifdef USE_MMX
  		/* enables to use FPU */
! 		__asm__ __volatile__ (EMMS:::"memory");
  #endif
  	}
--- 590,598 ----
                  /* since movntq is weakly-ordered, a "sfence"
  		 * is needed to become ordered again. */
! 		__asm__ __volatile__ ("sfence" : : : "memory");
  #endif
  #ifdef USE_MMX
  		/* enables to use FPU */
! 		__asm__ __volatile__ (EMMS : : :"memory");
  #endif
  	}



From nobody at sheep.berlios.de  Thu Dec 15 21:12:41 2005
From: nobody at sheep.berlios.de (wachm)
Date: Thu, 15 Dec 2005 21:12:41 +0100
Subject: [Softdevice-cvs] softdevice CHANGELOG,1.131,1.132 video-dfb.c,1.41,1.42
Message-ID: <200512152012.jBFKCfs30715@bat.berlios.de>

Update of /cvsroot/softdevice/softdevice
In directory sheep:/tmp/cvs-serv12845

Modified Files:
	CHANGELOG video-dfb.c 
Log Message:
- use fast_memcpy in dfb out


Index: CHANGELOG
===================================================================
RCS file: /cvsroot/softdevice/softdevice/CHANGELOG,v
retrieving revision 1.131
retrieving revision 1.132
diff -C2 -d -r1.131 -r1.132
*** CHANGELOG	30 Nov 2005 18:26:32 -0000	1.131
--- CHANGELOG	15 Dec 2005 20:12:38 -0000	1.132
***************
*** 1,3 ****
--- 1,5 ----
  Changelog
+ 2005-12-15:
+     - use fast_memcpy in dfb out
  2005-11-30:
      - g++-2.95 complaints about "::" in inline asm and wants ": :" instead.

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.41
retrieving revision 1.42
diff -C2 -d -r1.41 -r1.42
*** video-dfb.c	6 Nov 2005 17:56:06 -0000	1.41
--- video-dfb.c	15 Dec 2005 20:12:38 -0000	1.42
***************
*** 1236,1240 ****
  
        for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!         memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
          Py  += Ystride;
          dst += pitch;
--- 1236,1240 ----
  
        for(hi=cutTop*2; hi < Height-cutBottom*2; hi++){
!         fast_memcpy(dst + cutLeft * 2, Py, Width - (cutLeft + cutRight) * 2);
          Py  += Ystride;
          dst += pitch;
***************
*** 1244,1248 ****
  
        for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!         memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
          Pu  += UVstride;
          dst += pitch / 2;
--- 1244,1248 ----
  
        for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!         fast_memcpy(dst + cutLeft, Pu, Width/2 - (cutLeft + cutRight));
          Pu  += UVstride;
          dst += pitch / 2;
***************
*** 1252,1256 ****
  
        for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!         memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
          Pv  += UVstride;
          dst += pitch / 2;
--- 1252,1256 ----
  
        for(hi=cutTop; hi < Height/2-cutBottom; hi++) {
!         fast_memcpy(dst + cutLeft, Pv, Width/2 - (cutLeft + cutRight));
          Pv  += UVstride;
          dst += pitch / 2;
***************
*** 1264,1268 ****
  
        for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!         memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
          Py  += Ystride;
          dst += pitch;
--- 1264,1268 ----
  
        for(hi=cutTop*2; hi < sheight-cutBottom*2; hi++){
!         fast_memcpy(dst+cutLeft*2, Py+sxoff+cutLeft*2, swidth-(cutLeft+cutRight)*2);
          Py  += Ystride;
          dst += pitch;
***************
*** 1272,1276 ****
  
        for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!         memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
          Pu  += UVstride;
          dst += pitch / 2;
--- 1272,1276 ----
  
        for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!         fast_memcpy(dst+cutLeft, Pu+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
          Pu  += UVstride;
          dst += pitch / 2;
***************
*** 1280,1284 ****
  
        for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!         memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
          Pv  += UVstride;
          dst += pitch / 2;
--- 1280,1284 ----
  
        for(hi=cutTop; hi < sheight/2-cutBottom; hi++) {
!         fast_memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
          Pv  += UVstride;
          dst += pitch / 2;



